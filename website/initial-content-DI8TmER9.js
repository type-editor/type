var t,e,n,i,s,r,o,a,l,c,h,d,u,p,f=t=>{throw TypeError(t)},m=(t,e,n)=>e.has(t)||f("Cannot "+n),g=(t,e,n)=>(m(t,e,"read from private field"),n?n.call(t):e.get(t)),y=(t,e,n)=>e.has(t)?f("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),b=(t,e,n,i)=>(m(t,e,"write to private field"),i?i.call(t,n):e.set(t,n),n),w=(t,e,n)=>(m(t,e,"access private method"),n);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const n of t)if("childList"===n.type)for(const t of n.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const v="undefined"!=typeof navigator&&navigator.userAgent?navigator:null,A="undefined"!=typeof document?document:null,x=v?.userAgent?v.userAgent:"",S=/Edge\/(\d+)/.exec(x),_=/MSIE \d/.exec(x),T=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(x),E=!!(_||T||S),C=_?0:T?+T[1]:S?+S[1]:0,M=!E&&/gecko\/(\d+)/i.test(x);M&&(/Firefox\/(\d+)/.exec(x)||[0,0])[1];const k=!E&&/Chrome\/(\d+)/.exec(x),D=!!k,I=k?+k[1]:0,N=!E&&v?.vendor?.includes("Apple Computer"),P=N&&(/Mobile\/\w+/.test(x)||v?.maxTouchPoints>2),O=P||v?.platform?.includes("Mac"),R=v?.platform?.includes("Win"),B=/Android \d/.test(x),F=A&&"webkitFontSmoothing"in A.documentElement.style,L={ie:E,ie_version:C,gecko:M,chrome:D,chrome_version:I,safari:N,ios:P,mac:O,windows:R,android:B,webkit:F,webkit_version:F?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0,dir:"rtl"===A?.dir?"rtl":"ltr"};var z,V=((z=V||{})[z.Backward=-1]="Backward",z[z.Forward=1]="Forward",z[z.Up=-1]="Up",z[z.Down=1]="Down",z);const H="Backspace";let $=class t{content;constructor(t){this.content=t}get type(){return"OrderedMap"}get size(){return this.content.length>>1}static from(e){if(e instanceof t)return e;if(t.isOrderedMap(e))return e;const n=[];if(e)for(const t in e)n.push(t,e[t]);return new t(n)}static isOrderedMap(t){return!(!t||"object"!=typeof t)&&"OrderedMap"===t.type}find(t){for(let e=0;e<this.content.length;e+=2)if(this.content[e]===t)return e;return-1}get(t){const e=this.find(t);return-1===e?void 0:this.content[e+1]}update(e,n,i){const s=i&&i!==e?this.remove(i):this,r=s.find(e),o=s.content.slice();return-1===r?o.push(i||e,n):(o[r+1]=n,i&&(o[r]=i)),new t(o)}remove(e){const n=this.find(e);if(-1===n)return this;const i=this.content.slice();return i.splice(n,2),new t(i)}addToStart(e,n){return new t([e,n,...this.remove(e).content])}addToEnd(e,n){const i=this.remove(e).content.slice();return i.push(e,n),new t(i)}addBefore(e,n,i){const s=this.remove(n),r=s.content.slice(),o=s.find(e);return r.splice(-1===o?r.length:o,0,n,i),new t(r)}forEach(t){for(let e=0;e<this.content.length;e+=2)t(this.content[e],this.content[e+1])}prepend(e){const n=t.from(e);return n.size?new t(n.content.concat(this.subtract(n).content)):this}append(e){const n=t.from(e);return n.size?new t(this.subtract(n).content.concat(n.content)):this}subtract(e){const n=t.from(e);if(!n.size)return this;const i=[];for(let t=0;t<this.content.length;t+=2)-1===n.find(this.content[t])&&i.push(this.content[t],this.content[t+1]);return new t(i)}toObject(){const t={};return this.forEach((e,n)=>{t[e]=n}),t}};function U(t){return null==t}function W(t){return"string"==typeof t&&("true"===t.toLowerCase()||"1"===t.toLowerCase())}function G(t){return!!U(t)||!1!==t}function j(t){return!G(t)}function K(t,e){return!U(t)&&!U(e)&&Object.prototype.hasOwnProperty.call(t,e)}let q=(t=21)=>{let e="",n=crypto.getRandomValues(new Uint8Array(t|=0));for(;t--;)e+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[t]];return e};var Y=(t=>(t[t.Node=1]="Node",t[t.TextNode=2]="TextNode",t[t.Fragment=3]="Fragment",t[t.Slice=4]="Slice",t[t.Mark=5]="Mark",t[t.ResolvedPos=6]="ResolvedPos",t))(Y||{});function X(t,e){return J(t,e,new Map)}function J(t,e,n){if(Object.is(t,e))return!0;if("object"!=typeof t||"object"!=typeof e||U(t)||U(e))return!1;if(n.has(t))return n.get(t).has(e);n.has(t)||n.set(t,new Set),n.get(t).add(e);const i=Array.isArray(t),s=Array.isArray(e);return i===s&&(i&&s?function(t,e,n){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!J(t[i],e[i],n))return!1;return!0}(t,e,n):function(t,e,n){const i=Object.keys(t);let s=0;for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&s++;if(i.length!==s)return!1;for(const r of i)if(!Object.prototype.hasOwnProperty.call(e,r)||!J(t[r],e[r],n))return!1;return!0}(t,e,n))}let Q=class t{static none=Object.freeze(new Array);_type;_attrs;constructor(t,e){this._type=t,this._attrs=e}get elementType(){return Y.Mark}get type(){return this._type}get attrs(){return this._attrs}static isMark(t){return!U(t)&&"object"==typeof t&&"elementType"in t&&t.elementType===Y.Mark}static fromJSON(t,e){if(!e)throw new RangeError("Invalid input for Mark.fromJSON: json parameter is required");const n=t.marks[e.type];if(!n)throw new RangeError(`There is no mark type "${e.type}" in this schema. Available mark types: ${Object.keys(t.marks).join(", ")}`);const i=n.create(e.attrs);return n.checkAttrs(i.attrs),i}static sameSet(t,e){if(t===e)return!0;if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!t[n].eq(e[n]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&0===e.length)return t.none;if(e instanceof t)return[e];const n=e.slice();return n.sort((t,e)=>t.type.rank-e.type.rank),n}addToSet(t){let e,n=!1;for(let i=0;i<t.length;i++){const s=t[i];if(this.eq(s))return t;if(this._type.excludes(s.type))e||(e=t.slice(0,i));else{if(s.type.excludes(this._type))return t;!n&&s.type.rank>this._type.rank&&(e||(e=t.slice(0,i)),e.push(this),n=!0),e&&e.push(s)}}return e||(e=t.slice()),n||e.push(this),e}removeFromSet(t){for(let e=0;e<t.length;e++)if(this.eq(t[e]))return[...t.slice(0,e),...t.slice(e+1)];return t}isInSet(t){return t.some(t=>this.eq(t))}eq(t){return this===t||!!t&&this._type===t.type&&this.compareAttrsForMarkup(t.attrs)}compareAttrsForMarkup(t){const e=this._attrs,n=this._type.attributeSpecs,i={},s={};for(const r in n)n[r].excludeFromMarkupComparison||(i[r]=e[r],s[r]=t[r]);return X(i,s)}toJSON(){const t={type:this._type.name};if(this._attrs&&Object.keys(this._attrs).length>0){const e={};let n=0;for(const t in this._attrs)null!==this._attrs[t]&&(n++,e[t]=this._attrs[t]);n&&(t.attrs=e)}return t}},Z=class t{static EMPTY_FRAGMENT;fragmentContent;fragmentSize;constructor(t,e){this.fragmentContent=t,this.fragmentSize=this.calculateSize(t,e)}static get empty(){return t.EMPTY_FRAGMENT||(t.EMPTY_FRAGMENT=new t([],0)),t.EMPTY_FRAGMENT}get elementType(){return Y.Fragment}get content(){return this.fragmentContent}get size(){return this.fragmentSize}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}static fromJSON(e,n){if(!n)return t.EMPTY_FRAGMENT;if(!Array.isArray(n))throw new RangeError("Invalid input for Fragment.fromJSON: expected array, got "+typeof n);return new t(n.map(e.nodeFromJSON))}static from(e){if(U(e))return t.empty;if(Array.isArray(e))return t.fromArray(e);if(t.isFragment(e))return e;if(t.isNode(e))return new t([e],e.nodeSize);throw new RangeError(`Cannot convert ${e.toString()} to a Fragment`+(t.isNode(e)&&e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}static isFragment(t){return!U(t)&&"object"==typeof t&&"elementType"in t&&t.elementType===Y.Fragment}static fromArray(e){if(!e.length)return t.empty;let n,i=0;for(let t=0;t<e.length;t++){const s=e[t];i+=s.nodeSize;const r=t>0?e[t-1]:null;if(r&&s.isText&&r.sameMarkup(s)){n||(n=e.slice(0,t));const i=s,r=n[n.length-1];n[n.length-1]=i.withText(r.text+i.text)}else n&&n.push(s)}return new t(n||e,i)}static isNode(t){return!U(t)&&"object"==typeof t&&"elementType"in t&&(t.elementType===Y.Node||t.elementType===Y.TextNode)}nodesBetween(t,e,n,i=0,s){for(let r=0,o=0;o<e&&r<this.content.length;r++){const a=this.content[r],l=o+a.nodeSize;if(l>t&&G(n(a,i+o,s||null,r))&&a.content.size){const s=o+1;a.nodesBetween(Math.max(0,t-s),Math.min(a.content.size,e-s),n,i+s)}o=l}}textBetween(t,e,n,i){let s="",r=!0;return this.nodesBetween(t,e,(o,a)=>{const l=this.getNodeText(o,t,e,a,i);this.shouldAddBlockSeparator(o,l,n)&&(r?r=!1:s+=n),s+=l},0),s}append(e){if(!e.size)return this;if(!this.size)return e;const n=this.lastChild,i=e.firstChild;return n&&i&&n.isText&&n.sameMarkup(i)?this.appendWithTextMerge(e):new t([...this.content,...e.content],this.size+e.size)}cut(e,n=this.size){if(0===e&&n===this.size)return this;const i=[];let s=0;if(n>e)for(let t=0,r=0;r<n&&t<this.content.length;t++){let o=this.content[t];const a=r+o.nodeSize;a>e&&((r<e||a>n)&&(o=this.cutChild(o,e,n,r)),i.push(o),s+=o.nodeSize),r=a}return new t(i,s)}cutByIndex(e,n){if(e===n)return t.EMPTY_FRAGMENT;if(0===e&&n===this.content.length)return this;const i=this.content.slice(e,n);let s=0;for(const t of i)s+=t.nodeSize;return new t(i,s)}replaceChild(e,n){const i=this.content[e];if(!i)throw new RangeError(`Index ${e} out of range for ${this.toString()}`);if(i===n)return this;const s=this.content.slice(),r=this.size+n.nodeSize-i.nodeSize;return s[e]=n,new t(s,r)}eq(t){if(this.content.length!==t.content.length)return!1;for(let e=0;e<this.content.length;e++)if(!this.content[e].eq(t.content[e]))return!1;return!0}child(t){const e=this.content[t];if(!e)throw new RangeError(`Index ${t} out of range for ${this.toString()}`);return e}maybeChild(t){return this.content[t]||null}forEach(t){for(let e=0,n=0;e<this.content.length;e++){const i=this.content[e];t(i,n,e),n+=i.nodeSize}}findDiffStart(t,e=0){return this.findDiffStartPosition(this,t,e)}findDiffEnd(t,e=-1,n=-1){const i=-1===e?this.size:e,s=-1===n?t.size:n;return this.findDiffEndPosition(this,t,i,s)}findIndex(t){if(0===t)return{index:0,offset:t};if(t===this.size)return{index:this.content.length,offset:t};if(t>this.size||t<0)throw new RangeError(`Position ${t} outside of fragment (${this.toString()})`);for(let e=0,n=0;;e++){const i=n+this.child(e).nodeSize;if(i>=t)return i===t?{index:e+1,offset:i}:{index:e,offset:n};n=i}}toString(){return`<${this.toStringInner()}>`}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(t=>t.toJSON()):null}addToStart(e){return new t([e,...this.content],this.size+e.nodeSize)}addToEnd(e){return new t([...this.content,e],this.size+e.nodeSize)}descendants(t){this.nodesBetween(0,this.size,t)}calculateSize(t,e){if(!U(e))return e;let n=0;for(const i of t)n+=i.nodeSize;return n}shouldAddBlockSeparator(t,e,n){return t.isBlock&&(t.isLeaf&&!!e||t.isTextblock)&&!!n}appendWithTextMerge(e){const n=this.content.slice(),i=this.content[this.content.length-1],s=e.content[0];n[n.length-1]=i.withText(i.text+s.text);for(let t=1;t<e.content.length;t++)n.push(e.content[t]);return new t(n,this.size+e.size)}cutChild(t,e,n,i){return t.isText?t.cut(Math.max(0,e-i),Math.min(t.text.length,n-i)):t.cut(Math.max(0,e-i-1),Math.min(t.content.size,n-i-1))}findDiffStartPosition(t,e,n){for(let i=0;;i++){if(i===t.childCount||i===e.childCount)return t.childCount===e.childCount?null:n;const s=t.child(i),r=e.child(i);if(s!==r){if(!s.sameMarkup(r))return n;if(s.isText&&s.text!==r.text){for(let t=0;t<s.text.length&&t<r.text.length&&s.text[t]===r.text[t];t++)n++;return n}if(s.content.size||r.content.size){const t=this.findDiffStartPosition(s.content,r.content,n+1);if(null!==t)return t}n+=s.nodeSize}else n+=s.nodeSize}}findDiffEndPosition(t,e,n,i){for(let s=t.childCount,r=e.childCount;;){if(0===s||0===r)return s===r?null:{selfPos:n,otherPos:i,a:n,b:i};const o=t.child(--s),a=e.child(--r),l=o.nodeSize;if(o!==a){if(!o.sameMarkup(a))return{selfPos:n,otherPos:i,a:n,b:i};if(o.isText&&o.text!==a.text){const t=Math.min(o.text.length,a.text.length);let e=0;for(;e<t&&o.text[o.text.length-e-1]===a.text[a.text.length-e-1];)e++,n--,i--;return{selfPos:n,otherPos:i,a:n,b:i}}if(o.content.size||a.content.size){const t=this.findDiffEndPosition(o.content,a.content,n-1,i-1);if(t)return t}n-=l,i-=l}else n-=l,i-=l}}getNodeText(t,e,n,i,s){return t.isText?t.text.slice(Math.max(e,i)-i,n-i):t.isLeaf?"function"==typeof s?s(t):s||(t.type.spec.leafText?t.type.spec.leafText(t):""):""}},tt=class t{static INSTANCE=null;sliceContent;sliceOpenStart;sliceOpenEnd;constructor(t,e,n){if(e<0||n<0)throw new RangeError(`Invalid open depths: openStart and openEnd must be non-negative (openStart=${e}, openEnd=${n})`);this.sliceContent=t,this.sliceOpenStart=e,this.sliceOpenEnd=n}get elementType(){return Y.Slice}static isSlice(t){return!U(t)&&"object"==typeof t&&"elementType"in t&&t.elementType===Y.Slice}static get empty(){return t.INSTANCE||(t.INSTANCE=new t(Z.empty,0,0)),t.INSTANCE}get content(){return this.sliceContent}get openStart(){return this.sliceOpenStart}get openEnd(){return this.sliceOpenEnd}get size(){return this.sliceContent.size-this.sliceOpenStart-this.sliceOpenEnd}static fromJSON(e,n){if(!n)return t.empty;const i=n.openStart??0,s=n.openEnd??0;if("number"!=typeof i||"number"!=typeof s)throw new RangeError(`Invalid input for Slice.fromJSON: openStart and openEnd must be numbers, got ${typeof i} and ${typeof s}`);return new t(Z.fromJSON(e,n.content),i,s)}static maxOpen(e,n=!0){const i=this.calculateMaxOpenDepth(e.firstChild,n),s=this.calculateMaxOpenDepth(e.lastChild,n);return new t(e,i,s)}static calculateMaxOpenDepth(t,e){let n=0,i=t;for(;i&&!i.isLeaf&&(e||!i.type.spec.isolating);)n++,i=i.firstChild;return n}insertAt(e,n){if(e<0)throw new RangeError(`Invalid position: must be non-negative (pos=${e})`);const i=this.insertInto(this.sliceContent,e+this.sliceOpenStart,n);return i?new t(i,this.sliceOpenStart,this.sliceOpenEnd):null}removeBetween(e,n){if(e<0||n<0)throw new RangeError(`Invalid range: positions must be non-negative (from=${e}, to=${n})`);if(e>n)throw new RangeError(`Invalid range: from position (${e}) cannot exceed to position (${n})`);const i=this.removeRange(this.sliceContent,e+this.sliceOpenStart,n+this.sliceOpenStart);return new t(i,this.sliceOpenStart,this.sliceOpenEnd)}eq(t){return this.sliceContent.eq(t.sliceContent)&&this.sliceOpenStart===t.openStart&&this.sliceOpenEnd===t.openEnd}toString(){return`${this.sliceContent.toString()}(${this.sliceOpenStart},${this.sliceOpenEnd})`}toJSON(){if(!this.sliceContent.size)return null;const t={content:this.sliceContent.toJSON()};return this.sliceOpenStart>0&&(t.openStart=this.sliceOpenStart),this.sliceOpenEnd>0&&(t.openEnd=this.sliceOpenEnd),t}removeRange(t,e,n){const{index:i,offset:s}=t.findIndex(e),{index:r,offset:o}=t.findIndex(n),a=t.maybeChild(i);if(s===e||a?.isText){const i=t.maybeChild(r);if(o!==n&&!i?.isText)throw new RangeError("Removing non-flat range");return t.cut(0,e).append(t.cut(n))}if(i!==r)throw new RangeError("Removing non-flat range");if(!a)throw new RangeError("Invalid range: child not found");const l=a.content,c=e-s-1,h=n-s-1,d=this.removeRange(l,c,h);return t.replaceChild(i,a.copy(d))}insertInto(t,e,n,i){const{index:s,offset:r}=t.findIndex(e),o=t.maybeChild(s);if(r===e||o?.isText)return i&&!i.canReplace(s,s,n)?null:t.cut(0,e).append(n).append(t.cut(e));if(!o)return null;const a=e-r-1,l=this.insertInto(o.content,a,n,o);return l?t.replaceChild(s,o.copy(l)):null}};const et={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},nt={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},it={ol:!0,ul:!0};var st=(t=>(t[t.OPT_PRESERVE_WS=1]="OPT_PRESERVE_WS",t[t.OPT_PRESERVE_WS_FULL=2]="OPT_PRESERVE_WS_FULL",t[t.OPT_OPEN_LEFT=4]="OPT_OPEN_LEFT",t))(st||{});let rt=class extends Error{};function ot(t,e,n){if(n.openStart>t.depth)throw new rt("Inserted content deeper than insertion position");if(t.depth-n.openStart!==e.depth-n.openEnd)throw new rt("Inconsistent open depths");return at(t,e,n,0)}function at(t,e,n,i){const s=t.index(i),r=t.node(i);if(s===e.index(i)&&i<t.depth-n.openStart){const o=at(t,e,n,i+1);return r.copy(r.content.replaceChild(s,o))}if(!n.content.size)return ut(r,ft(t,e,i));if(!n.openStart&&!n.openEnd&&t.depth===i&&e.depth===i){const i=t.parent,s=i.content;return ut(i,s.cut(0,t.parentOffset).append(n.content).append(s.cut(e.parentOffset)))}const{start:o,end:a}=function(t,e){const n=e.depth-t.openStart;let i=e.node(n).copy(t.content);for(let s=n-1;s>=0;s--)i=e.node(s).copy(Z.from(i));return{start:i.resolveNoCache(t.openStart+n),end:i.resolveNoCache(i.content.size-t.openEnd-n)}}(n,t);return ut(r,pt(t,o,a,e,i))}function lt(t,e){if(!e.type.compatibleContent(t.type))throw new rt(`Cannot join ${e.type.name} onto ${t.type.name} - incompatible content types`)}function ct(t,e,n){const i=t.node(n);return lt(i,e.node(n)),i}function ht(t,e){const n=e.length-1,i=e[n];n>=0&&t.isText&&i&&t.sameMarkup(i)?e[n]=t.withText(i.text+t.text):e.push(t)}function dt(t,e,n,i){const s=e||t;if(!s)return;const r=s.node(n);let o=0;const a=e?e.index(n):r.childCount;if(t)if(o=t.index(n),t.depth>n)o++;else if(t.textOffset){const e=t.nodeAfter;e&&ht(e,i),o++}for(let l=o;l<a;l++)ht(r.child(l),i);if(e?.depth===n&&e.textOffset){const t=e.nodeBefore;t&&ht(t,i)}}function ut(t,e){return t.type.checkContent(e),t.copy(e)}function pt(t,e,n,i,s){const r=t.depth>s&&ct(t,e,s+1),o=i.depth>s&&ct(n,i,s+1),a=new Array;return dt(null,t,s,a),r&&o&&e.index(s)===n.index(s)?(lt(r,o),ht(ut(r,pt(t,e,n,i,s+1)),a)):(r&&ht(ut(r,ft(t,e,s+1)),a),dt(e,n,s,a),o&&ht(ut(o,ft(n,i,s+1)),a)),dt(i,null,s,a),new Z(a)}function ft(t,e,n){const i=new Array;return dt(null,t,n,i),t.depth>n&&ht(ut(ct(t,e,n+1),ft(t,e,n+1)),i),dt(e,null,n,i),new Z(i)}let mt=class{fromPos;toPos;depthIndex;constructor(t,e,n){this.fromPos=t,this.toPos=e,this.depthIndex=n}get $from(){return this.fromPos}get $to(){return this.toPos}get depth(){return this.depthIndex}get start(){return this.fromPos.before(this.depthIndex+1)}get end(){return this.toPos.after(this.depthIndex+1)}get parent(){return this.fromPos.node(this.depthIndex)}get startIndex(){return this.fromPos.index(this.depthIndex)}get endIndex(){return this.toPos.indexAfter(this.depthIndex)}},gt=class t{static RESOLVE_CACHE=new WeakMap;static DEFAULT_RESOLVE_CACHE_SIZE=12;static PATH_ENTRY_SIZE=3;depthIndex;posIndex;path;parentPosOffset;constructor(e,n,i){this.posIndex=e,this.path=n,this.parentPosOffset=i,this.depthIndex=n.length/t.PATH_ENTRY_SIZE-1}get depth(){return this.depthIndex}get pos(){return this.posIndex}get parentOffset(){return this.parentPosOffset}get parent(){return this.node(this.depthIndex)}get doc(){return this.node(0)}get textOffset(){return this.posIndex-this.path[this.path.length-1]}get nodeAfter(){const t=this.parent,e=this.index(this.depthIndex);if(e===t.childCount)return null;const n=this.posIndex-this.path[this.path.length-1],i=t.child(e);return n?i.cut(n):i}get nodeBefore(){const t=this.index(this.depthIndex),e=this.posIndex-this.path[this.path.length-1];return e?this.parent.child(t).cut(0,e):0===t?null:this.parent.child(t-1)}static resolve(e,n){if(!(n>=0&&n<=e.content.size))throw new RangeError(`Position ${n} out of range (valid: 0-${e.content.size})`);const i=new Array;let s=0,r=n;for(let t=e;;){const{index:e,offset:n}=t.content.findIndex(r),o=r-n;if(i.push(t,e,s+n),!o)break;if(t=t.child(e),t.isText)break;r=o-1,s+=n+1}return new t(n,i,r)}static resolveCached(e,n){let i=t.RESOLVE_CACHE.get(e);i||(i=new yt(t.DEFAULT_RESOLVE_CACHE_SIZE),t.RESOLVE_CACHE.set(e,i));const s=i.get(n);if(s)return s;const r=t.resolve(e,n);return i.add(r),r}node(e){return this.path[this.resolveDepth(e)*t.PATH_ENTRY_SIZE]}index(e){return this.path[this.resolveDepth(e)*t.PATH_ENTRY_SIZE+1]}indexAfter(t){const e=(t=this.resolveDepth(t))!==this.depthIndex||this.textOffset?1:0;return this.index(t)+e}start(e){e=this.resolveDepth(e);const n=this.path[e*t.PATH_ENTRY_SIZE-1];return 0===e?0:n+1}end(t){return t=this.resolveDepth(t),this.start(t)+this.node(t).content.size}before(e){if(!(e=this.resolveDepth(e)))throw new RangeError("There is no position before the top-level node");return e===this.depthIndex+1?this.posIndex:this.path[e*t.PATH_ENTRY_SIZE-1]}after(e){if(!(e=this.resolveDepth(e)))throw new RangeError("There is no position after the top-level node");const n=this.path[e*t.PATH_ENTRY_SIZE-1],i=this.path[e*t.PATH_ENTRY_SIZE];return e===this.depthIndex+1?this.posIndex:n+i.nodeSize}posAtIndex(e,n){n=this.resolveDepth(n);const i=this.path[n*t.PATH_ENTRY_SIZE],s=this.path[n*t.PATH_ENTRY_SIZE-1];let r=0===n?0:s+1;for(let t=0;t<e;t++)r+=i.child(t).nodeSize;return r}marks(){const t=this.parent,e=this.index();if(0===t.content.size)return Q.none;if(this.textOffset)return t.child(e).marks;let n=t.maybeChild(e-1),i=t.maybeChild(e);n||(n=i,i=null);let s=n?.marks??Q.none;for(let r=0;r<s.length;r++)!j(s[r].type.spec.inclusive)||i&&s[r].isInSet(i.marks)||(s=s[r--].removeFromSet(s));return s}marksAcross(t){const e=this.parent.maybeChild(this.index());if(!e?.isInline)return null;let n=e.marks;const i=t.parent.maybeChild(t.index());for(let s=0;s<n.length;s++)!j(n[s].type.spec.inclusive)||i&&n[s].isInSet(i.marks)||(n=n[s--].removeFromSet(n));return n}sharedDepth(t){for(let e=this.depthIndex;e>0;e--)if(this.start(e)<=t&&this.end(e)>=t)return e;return 0}blockRange(t,e){const n=t??this;if(n.pos<this.posIndex)return n.blockRange(this);let i=this.depthIndex;for((this.parent.inlineContent||this.posIndex===n.pos)&&(i=this.depthIndex-1);i>=0;){if(n.pos<=this.end(i)&&(!e||e(this.node(i))))return new mt(this,n,i);i--}return null}sameParent(t){return this.posIndex-this.parentPosOffset===t.pos-t.parentOffset}max(t){return t.pos>this.posIndex?t:this}min(t){return t.pos<this.posIndex?t:this}toString(){let t="";for(let e=1;e<=this.depthIndex;e++)t+=`${t?"/":""}${this.node(e).type.name}_${this.index(e-1).toString()}`;return`${t}:${this.parentPosOffset.toString()}`}resolveDepth(t){if(U(t))return this.depthIndex;if(t<0){const e=this.depthIndex+t;if(e<0)throw new RangeError(`Resolved depth ${e} is negative (depth=${this.depthIndex}, offset=${t})`);return e}return t}},yt=class{elements;positionMap=new Map;size;_currentPos=0;constructor(t){this.size=t,this.elements=new Array(t)}get currentPos(){return this._currentPos}set currentPos(t){this._currentPos=t}get(t){return this.positionMap.get(t)}add(t){const e=this.elements[this.currentPos];e&&this.positionMap.delete(e.pos),this.elements[this.currentPos]=t,this.positionMap.set(t.pos,t),this.currentPos=(this.currentPos+1)%this.size}},bt=class t{_content;_attrs;_marks;nodeType;_tag={};_text;constructor(t,e,n,i,s){this._content=n||Z.empty,this._text=s,this.nodeType=t,this._attrs=e,this._marks=i||Q.none}get tag(){return this._tag}set tag(t){this._tag=t}get elementType(){return Y.Node}get content(){return this._content}get text(){return this._text??null}get type(){return this.nodeType}get attrs(){return this._attrs}get marks(){return this._marks}get children(){return this._content.content}get nodeSize(){return this.isLeaf?1:2+this._content.size}get childCount(){return this._content.childCount}get textContent(){return this.isLeaf&&this.nodeType.spec.leafText?this.nodeType.spec.leafText(this):this.textBetween(0,this._content.size,"")}get firstChild(){return this._content.firstChild}get lastChild(){return this._content.lastChild}get isBlock(){return this.nodeType.isBlock}get isTextblock(){return this.nodeType.isTextblock}get inlineContent(){return this.nodeType.inlineContent}get isInline(){return this.nodeType.isInline}get isText(){return this.nodeType.isText}get isLeaf(){return this.nodeType.isLeaf}get isAtom(){return this.nodeType.isAtom}static isNode(t){return!U(t)&&"object"==typeof t&&"elementType"in t&&t.elementType===Y.Node}static fromJSON(t,e){if(!e)throw new RangeError("Invalid input for Node.fromJSON: json parameter is required");if(Array.isArray(e))throw new RangeError("Invalid input for Node.fromJSON: type property is required");{if(!e.type)throw new RangeError("Invalid input for Node.fromJSON: type property is required");let n;if(e.marks){if(!Array.isArray(e.marks))throw new RangeError("Invalid mark data for Node.fromJSON: marks must be an array");n=e.marks.map(e=>t.markFromJSON(e))}if("text"===e.type){if("string"!=typeof e.text)throw new RangeError("Invalid text node in JSON: text property must be a string");return t.text(e.text,n)}const i=Z.fromJSON(t,e.content),s=t.nodeType(e.type).create(e.attrs,i,n);return s.type.checkAttrs(s.attrs),s}}child(t){return this._content.child(t)}maybeChild(t){return this._content.maybeChild(t)}forEach(t){this._content.forEach(t)}nodesBetween(t,e,n,i=0){this._content.nodesBetween(t,e,n,i,this)}descendants(t){this.nodesBetween(0,this._content.size,t)}textBetween(t,e,n,i){return this._content.textBetween(t,e,n,i)}eq(t){return this===t||this.sameMarkup(t)&&this._content.eq(t.content)}sameMarkup(t){return this.hasMarkup(t.type,t.attrs,t.marks)}hasMarkup(t,e,n){return this.nodeType===t&&this.compareAttrsForMarkup(t,e||t.defaultAttrs)&&Q.sameSet(this._marks,n||Q.none)}compareAttrsForMarkup(t,e){const n=this._attrs,i=t.attributeSpecs,s={},r={};for(const o in i)i[o].excludeFromMarkupComparison||(s[o]=n[o],r[o]=e[o]);return X(s,r)}copy(e=null){return e===this._content?this:new t(this.nodeType,this._attrs,e||Z.empty,this._marks)}mark(e){return e===this._marks?this:new t(this.nodeType,this._attrs,this._content,e)}cut(t,e=this._content.size){return 0===t&&e===this._content.size?this:this.copy(this._content.cut(t,e))}slice(t,e=this._content.size,n=!1){if(t===e)return tt.empty;const i=this.resolve(t),s=this.resolve(e),r=n?0:i.sharedDepth(e),o=i.start(r),a=i.node(r).content.cut(i.pos-o,s.pos-o);return new tt(a,i.depth-r,s.depth-r)}replace(t,e,n){return ot(this.resolve(t),this.resolve(e),n)}nodeAt(t){if(U(t))return null;for(let e=this;;){const{index:n,offset:i}=e._content.findIndex(t);if(e=e.maybeChild(n),!e)return null;if(i===t||e.isText)return e;t-=i+1}}childAfter(t){const{index:e,offset:n}=this._content.findIndex(t);return{node:this._content.maybeChild(e),index:e,offset:n}}childBefore(t){if(0===t)return{node:null,index:0,offset:0};const{index:e,offset:n}=this._content.findIndex(t);if(n<t)return{node:this._content.child(e),index:e,offset:n};const i=this._content.child(e-1);return{node:i,index:e-1,offset:n-i.nodeSize}}resolve(t){return gt.resolveCached(this,t)}resolveNoCache(t){return gt.resolve(this,t)}rangeHasMark(t,e,n){let i=!1;return e>t&&this.nodesBetween(t,e,t=>(n.isInSet(t.marks)&&(i=!0),!i)),i}toString(){if(this.nodeType.spec.toDebugString)return this.nodeType.spec.toDebugString(this);let t=this.nodeType.name;return this._content.size&&(t+=`(${this._content.toStringInner()})`),this.wrapMarks(this._marks,t)}contentMatchAt(t){const e=this.nodeType.contentMatch.matchFragment(this._content,0,t);if(!e)throw new Error("Called contentMatchAt on a node with invalid content");return e}canReplace(t,e,n=Z.empty,i=0,s=n.childCount){const r=this.contentMatchAt(t).matchFragment(n,i,s),o=r?.matchFragment(this._content,e);if(!o?.validEnd)return!1;for(let a=i;a<s;a++)if(!this.nodeType.allowsMarks(n.child(a).marks))return!1;return!0}canReplaceWith(t,e,n,i){if(i&&!this.nodeType.allowsMarks(i))return!1;const s=this.contentMatchAt(t).matchType(n),r=s?.matchFragment(this._content,e);return!!r&&r.validEnd}canAppend(t){return t.content.size?this.canReplace(this.childCount,this.childCount,t.content):this.nodeType.compatibleContent(t.type)}check(){this.nodeType.checkContent(this._content),this.nodeType.checkAttrs(this._attrs);let t=Q.none;for(const e of this._marks)e.type.checkAttrs(e.attrs),t=e.addToSet(t);if(!Q.sameSet(t,this._marks)){const t=this._marks.map(t=>t.type.name).join(", ");throw new RangeError(`Invalid collection of marks for node ${this.nodeType.name}: ${t}`)}this._content.forEach(t=>{t.check()})}toJSON(){const t={type:this.nodeType.name};if(this._attrs&&Object.keys(this._attrs).length>0){const e={};let n=0;for(const t in this._attrs)null!==this._attrs[t]&&(n++,e[t]=this._attrs[t]);this.nodeType.spec.topNode&&(e.preVersion=e.version??0,e.version=Date.now(),n++),n&&(t.attrs=e)}return this._content.size&&(t.content=this._content.toJSON()),this._marks.length&&(t.marks=this._marks.map(t=>t.toJSON())),t}wrapMarks(t,e){for(let n=t.length-1;n>=0;n--)e=`${t[n].type.name}(${e})`;return e}},wt=class t extends bt{constructor(t,e,n,i){if(super(t,e,Z.empty,i,n),!n)throw new RangeError("Empty text nodes are not allowed")}get elementType(){return Y.TextNode}get textContent(){return this._text}get nodeSize(){return this._text.length}static isNode(t){return!U(t)&&"object"==typeof t&&"elementType"in t&&(t.elementType===Y.Node||t.elementType===Y.TextNode)}static isTextNode(t){return!U(t)&&"object"==typeof t&&"elementType"in t&&t.elementType===Y.TextNode}toString(){return this.nodeType.spec.toDebugString?this.nodeType.spec.toDebugString(this):this.wrapMarks(this._marks,JSON.stringify(this._text))}textBetween(t,e){return this._text.slice(t,e)}mark(e){return e===this._marks?this:new t(this.nodeType,this._attrs,this._text,e)}withText(e){return e===this._text?this:new t(this.nodeType,this._attrs,e,this._marks)}cut(t=0,e){const n=this._text,i=e??n.length;return 0===t&&i===n.length?this:this.withText(n.slice(t,i))}eq(t){return this.sameMarkup(t)&&this._text===t.text}toJSON(){const t=super.toJSON();return t.text=this._text,t}},vt=class t{static REGEX_WHITESPACES_AT_END=/[ \t\r\n\f]+$/;nodeContent=new Array;nodeType;attrs;marks;isSolid;matchVar;optionsVar;constructor(t,e,n,i,s,r){this.matchVar=s||(r&st.OPT_OPEN_LEFT?null:t?.contentMatch??null),this.nodeType=t,this.attrs=e,this.marks=n,this.isSolid=i,this.optionsVar=r}get match(){return this.matchVar}set match(t){this.matchVar=t}get content(){return this.nodeContent}get type(){return this.nodeType}get solid(){return this.isSolid}get options(){return this.optionsVar}set options(t){this.optionsVar=t}findWrapping(t){if(!this.match){if(!this.nodeType)return new Array;const e=this.nodeType.contentMatch.fillBefore(Z.from(t));if(!e){const e=this.nodeType.contentMatch,n=e.findWrapping(t.type);return n?(this.match=e,n):null}this.match=this.nodeType.contentMatch.matchFragment(e)}return this.match.findWrapping(t.type)}finish(t){this.options&st.OPT_PRESERVE_WS||this.stripTrailingWhitespace();let e=Z.from(this.nodeContent);return!t&&this.match&&(e=e.append(this.match.fillBefore(Z.empty,!0))),this.nodeType?this.nodeType.create(this.attrs,e,this.marks):e}inlineContext(t){return this.nodeType?this.nodeType.inlineContent:this.nodeContent.length?this.nodeContent[0].isInline:t.parentNode&&!K(et,t.parentNode.nodeName.toLowerCase())}stripTrailingWhitespace(){const e=this.nodeContent[this.nodeContent.length-1];if(!e?.isText)return;const n=t.REGEX_WHITESPACES_AT_END.exec(e.text);if(!n)return;const i=e,s=n[0].length;if(e.text.length===s)this.nodeContent.pop();else{const t=i.text.slice(0,i.text.length-s);this.nodeContent[this.nodeContent.length-1]=i.withText(t)}}},At=class t{static REGEX_WHITESPACE=/[ \t\r\n\f]+/g;static REGEX_WHITESPACE_AT_START=/[^ \t\r\n\f]/;static REGEX_WHITESPACE_AT_END=/[ \t\r\n\f]$/;static REGEX_LINEBREAK=/\r?\n|\r/;static REGEX_LINEBREAK_ANY_TYPE=/[\r\n]/;static REGEX_LINEBREAKS=/\r?\n|\r/g;static REGEX_LINEBREAKS_WIN_CARRIAGE_RETURN=/\r\n?/g;parser;options;isOpen;find;nodes;open=0;needsBlock;localPreserveWS=!1;constructor(t,e,n){this.parser=t,this.options=e,this.isOpen=n;const i=e.topNode,s=this.whitespaceOptionsFor(null,e.preserveWhitespace,0)|(n?st.OPT_OPEN_LEFT:0),r=this.createTopContext(i,s,t,e,n);this.nodes=new Array(r),this.find=e.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}get currentPos(){this.closeExtra();let t=0;for(let e=this.open;e>=0;e--){const n=this.nodes[e].content;for(let e=n.length-1;e>=0;e--)t+=n[e].nodeSize;e&&t++}return t}addAll(t,e,n,i){let s=n||0,r=n?t.childNodes[n]:t.firstChild;const o=U(i)?null:t.childNodes[i];for(;r!=o;)this.findAtPoint(t,s),this.addDOM(r,e),r=r.nextSibling,s++;this.findAtPoint(t,s)}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(j(this.isOpen||this.options.topOpen))}matchesContext(t){if(t.includes("|"))return t.split(/\s*\|\s*/).some(this.matchesContext,this);const e=t.split("/"),n=this.options.context,i=!(this.isOpen||n&&n.parent.type!==this.nodes[0].type),s=this.calculateMinDepth(n,i);return this.matchContextParts(e,e.length-1,this.open,s,n,i)}createTopContext(t,e,n,i,s){return t?new vt(t.type,t.attrs,Q.none,!0,i.topMatch||t.type.contentMatch,e):new vt(s?null:n.schema.topNodeType,null,Q.none,!0,null,e)}calculateMinDepth(t,e){return-(t?t.depth+1:0)+(e?0:1)}matchContextParts(t,e,n,i,s,r){for(let o=e;o>=0;o--){const e=t[o];if(""===e){if(this.isEdgeWildcard(o,t.length))continue;return this.matchWildcardAtAnyDepth(t,o,n,i,s,r)}const a=this.getNodeTypeAtDepth(n,i,s,r);if(!this.nodeMatchesPart(a,e))return!1;n--}return!0}isEdgeWildcard(t,e){return t===e-1||0===t}matchWildcardAtAnyDepth(t,e,n,i,s,r){for(let o=n;o>=i;o--)if(this.matchContextParts(t,e-1,o,i,s,r))return!0;return!1}getNodeTypeAtDepth(t,e,n,i){return t>0||0===t&&i?this.nodes[t].type:n&&t>=e?n.node(t-e).type:null}nodeMatchesPart(t,e){return!!t&&(t.name===e||t.isInGroup(e))}addDOM(t,e){3===t.nodeType?this.addTextNode(t,e):1===t.nodeType&&this.addElement(t,e)}addTextNode(e,n){let i=e.nodeValue;const s=this.top,r=this.getPreserveWhitespaceMode(s),{schema:o}=this.parser;if("full"===r||s.inlineContext(e)||t.REGEX_WHITESPACE_AT_START.test(i)){if(i=this.normalizeTextContent(i,r,s,e,o,n),i){const t=!/\S/.test(i);this.insertNode(o.text(i),n,t)}this.findInText(e)}else this.findInside(e)}getPreserveWhitespaceMode(t){return t.options&st.OPT_PRESERVE_WS_FULL?"full":this.localPreserveWS||(t.options&st.OPT_PRESERVE_WS)>0}normalizeTextContent(e,n,i,s,r,o){return n?"full"===n?e.replace(t.REGEX_LINEBREAKS_WIN_CARRIAGE_RETURN,"\n"):this.shouldReplaceLinebreaks(e,r)?(this.insertTextWithLinebreaks(e,r,o),""):e.replace(t.REGEX_LINEBREAKS," "):this.collapseWhitespace(e,i,s)}collapseWhitespace(e,n,i){if(e=e.replace(t.REGEX_WHITESPACE," "),/^[ \t\r\n\f]/.test(e)&&this.open===this.nodes.length-1){const t=n.content[n.content.length-1],s=i.previousSibling;this.shouldStripLeadingWhitespace(t,s)&&(e=e.slice(1))}return e}shouldStripLeadingWhitespace(e,n){return!e||"BR"===n?.nodeName||e.isText&&t.REGEX_WHITESPACE_AT_END.test(e.text)}shouldReplaceLinebreaks(e,n){return Boolean(n.linebreakReplacement)&&t.REGEX_LINEBREAK_ANY_TYPE.test(e)&&null!==this.top.findWrapping(n.linebreakReplacement.create())}insertTextWithLinebreaks(e,n,i){const s=e.split(t.REGEX_LINEBREAK);for(let t=0;t<s.length;t++)if(t>0&&this.insertNode(n.linebreakReplacement.create(),i,!0),s[t]){const e=!/\S/.test(s[t]);this.insertNode(n.text(s[t]),i,e)}}addElement(t,e,n){this.shouldPreserveWhitespace(t)&&(this.localPreserveWS=!0);const i=t.nodeName.toLowerCase();this.shouldNormalizeList(i)&&this.normalizeList(t);const{rule:s,ruleID:r}=this.findParseRule(t,n);this.applyWithRule(s,t,e,i,this.top,r,this.localPreserveWS)}shouldPreserveWhitespace(t){return"PRE"===t.tagName||t.style?.whiteSpace?.includes("pre")}shouldNormalizeList(t){return K(it,t)&&this.parser.normalizeLists}findParseRule(t,e){const n=this.options.ruleFromNode?.(t);if(n)return{rule:n,ruleID:void 0};const i=this.parser.matchTag(t,this,e);return{rule:i,ruleID:i}}applyWithRule(t,e,n,i,s,r,o){(t?t.ignore:K(nt,i))?this.handleIgnoredElement(e,n):!t||t.skip||t.closeParent?this.handleTransparentElement(t,e,n,i,s,o):this.handleNormalElement(t,e,n,r),this.localPreserveWS=o}handleIgnoredElement(t,e){this.findInside(t),this.ignoreFallback(t,e)}handleTransparentElement(t,e,n,i,s,r){let o=e;t?.closeParent?this.open=Math.max(0,this.open-1):t&&"object"==typeof t.skip&&null!==t.skip&&"nodeType"in t.skip&&(o=t.skip);const{shouldSync:a,updatedTop:l}=this.handleBlockContext(i,s),c=this.needsBlock;if(!o.firstChild)return this.leafFallback(o,n),void(this.localPreserveWS=r);const h=t?.skip?n:this.readStyles(o,n);h&&this.addAll(o,h),a&&this.sync(l),this.needsBlock=c}handleBlockContext(t,e){let n=!1,i=e;return K(et,t)&&(e.content.length&&e.content[0].isInline&&this.open&&(this.open--,i=this.top),n=!0,i.type||(this.needsBlock=!0)),{shouldSync:n,updatedTop:i}}handleNormalElement(t,e,n,i){const s=this.readStyles(e,n);s&&this.addElementByRule(e,t,s,t.consuming?void 0:i)}leafFallback(t,e){"BR"===t.nodeName&&this.top.type?.inlineContent&&this.addTextNode(t.ownerDocument.createTextNode("\n"),e)}ignoreFallback(t,e){"BR"!==t.nodeName||this.top.type?.inlineContent||this.findPlace(this.parser.schema.text("-"),e,!0)}readStyles(t,e){const n=t.style;if(!n?.length)return e;let i=e;for(const s of this.parser.matchedStyles){const t=n.getPropertyValue(s);if(t){const e=this.applyStyleRules(s,t,i);if(U(e))return null;i=e}}return i}applyStyleRules(t,e,n){let i,s=n;for(;;){const n=this.parser.matchStyle(t,e,this,i);if(!n)break;if(n.ignore)return null;if(s=this.applyStyleRule(n,s),!j(n.consuming))break;i=n}return s}applyStyleRule(t,e){if(t.clearMark)return e.filter(e=>!t.clearMark(e));{const n=this.parser.schema.marks[t.mark].create(t.attrs);return e.concat(n)}}addElementByRule(t,e,n,i){let s,r,o=!1;if(e.node){const i=this.handleNodeRule(e,n,t);s=i.nodeType,o=i.shouldSync,r=i.marks}else r=this.handleMarkRule(e,n);const a=this.top;this.processElementContent(t,e,r,i,s),o&&this.sync(a)&&this.open--}handleNodeRule(t,e,n){const i=this.parser.schema.nodes[t.node];let s,r=!1;if(i.isLeaf){s=e;const r=i.create(t.attrs),o="BR"===n.nodeName;this.insertNode(r,e,o)||this.leafFallback(n,e)}else{const n=this.enter(i,t.attrs||null,e,t.preserveWhitespace);n?(r=!0,s=n):s=e}return{nodeType:i,shouldSync:r,marks:s}}handleMarkRule(t,e){const n=this.parser.schema.marks[t.mark];return e.concat(n.create(t.attrs))}processElementContent(t,e,n,i,s){s?.isLeaf?this.findInside(t):i?this.addElement(t,n,i):e.getContent?this.processGetContent(t,e,n):this.processRegularContent(t,e,n)}processGetContent(t,e,n){this.findInside(t),e.getContent(t,this.parser.schema).forEach(t=>{this.insertNode(t,n,!1)})}processRegularContent(t,e,n){const i=this.getContentElement(t,e);this.findAround(t,i,!0),this.addAll(i,n),this.findAround(t,i,!1)}getContentElement(t,e){return"string"==typeof e.contentElement?t.querySelector(e.contentElement):"function"==typeof e.contentElement?e.contentElement(t):e.contentElement?e.contentElement:t}findPlace(t,e,n){let i,s,r=0;for(let a=this.open;a>=0;a--){const e=this.nodes[a],o=e.findWrapping(t);if(o&&(!i||o.length+r<i.length)&&(i=o,s=e,!o.length))break;if(e.solid){if(n)break;r+=2}}if(!i)return null;this.sync(s);let o=e;for(const a of i)o=this.enterInner(a,null,o,!1);return o}insertNode(t,e,n){if(t.isInline&&this.needsBlock&&!this.top.type){const t=this.textblockFromContext();t&&(e=this.enterInner(t,null,e))}const i=this.findPlace(t,e,n);if(!i)return!1;this.closeExtra();const s=this.top;s.match&&(s.match=s.match.matchType(t.type));const r=this.filterAllowedMarks(i.concat(t.marks),s,t.type);return s.content.push(t.mark(r)),!0}filterAllowedMarks(t,e,n){let i=Q.none;for(const s of t)(e.type?e.type.allowsMarkType(s.type):this.markMayApply(s.type,n))&&(i=s.addToSet(i));return i}enter(t,e,n,i){let s=this.findPlace(t.create(e),n,!1);return s&&(s=this.enterInner(t,e,n,!0,i)),s}enterInner(t,e,n,i=!1,s){this.closeExtra();const r=this.top;r.match=r.match?.matchType(t);let o=this.whitespaceOptionsFor(t,s,r.options);r.options&st.OPT_OPEN_LEFT&&0===r.content.length&&(o|=st.OPT_OPEN_LEFT);let a=Q.none;const l=n.filter(e=>!(r.type?r.type.allowsMarkType(e.type):this.markMayApply(e.type,t))||(a=e.addToSet(a),!1));return this.nodes.push(new vt(t,e,a,i,null,o)),this.open++,l}closeExtra(t=!1){let e=this.nodes.length-1;if(e>this.open){for(;e>this.open;e--)this.nodes[e-1].content.push(this.nodes[e].finish(t));this.nodes.length=this.open+1}}sync(t){for(let e=this.open;e>=0;e--){if(this.nodes[e]===t)return this.open=e,!0;this.localPreserveWS&&(this.nodes[e].options|=st.OPT_PRESERVE_WS)}return!1}findAtPoint(t,e){if(this.find)for(const n of this.find)n.node===t&&n.offset===e&&(n.pos=this.currentPos)}findInside(t){if(this.find)for(const e of this.find)U(e.pos)&&1===t.nodeType&&t.contains(e.node)&&(e.pos=this.currentPos)}findAround(t,e,n){if(t!==e&&this.find)for(const i of this.find)U(i.pos)&&1===t.nodeType&&t.contains(i.node)&&e.compareDocumentPosition(i.node)&(n?2:4)&&(i.pos=this.currentPos)}findInText(t){if(this.find)for(const e of this.find)e.node===t&&(e.pos=this.currentPos-(t.nodeValue.length-e.offset))}textblockFromContext(){const t=this.options.context;if(t)for(let e=t.depth;e>=0;e--){const n=t.node(e).contentMatchAt(t.indexAfter(e)).defaultType;if(n?.isTextblock&&n?.defaultAttrs)return n}for(const e of Object.values(this.parser.schema.nodes))if(e.isTextblock&&e.defaultAttrs)return e}whitespaceOptionsFor(t,e,n){return U(e)?"pre"===t?.whitespace?st.OPT_PRESERVE_WS|st.OPT_PRESERVE_WS_FULL:n&~st.OPT_OPEN_LEFT:"full"===e?st.OPT_PRESERVE_WS|st.OPT_PRESERVE_WS_FULL:e?st.OPT_PRESERVE_WS:0}normalizeList(t){let e=null;for(let n=t.firstChild;n;){const t=n.nextSibling,i=1===n.nodeType?n.nodeName.toLowerCase():null;i&&K(it,i)&&e?e.appendChild(n):"li"===i?e=n:i&&(e=null),n=t}}markMayApply(t,e){const n=e.schema.nodes;for(const i of Object.values(n)){if(!i.allowsMarkType(t))continue;const n=new Set,s=t=>{n.add(t);for(let i=0;i<t.edgeCount;i++){const{type:r,next:o}=t.edge(i);if(r===e)return!0;if(!n.has(o)&&s(o))return!0}return!1};if(s(i.contentMatch))return!0}return!1}},xt=class{static createParseContext(t,e,n){return new At(t,e,n)}},St=class t{static REGEX_STYLE_PROP_NAME=/[^=]*/;static REGEX_LIST_TAG=/^(ul|ol)\b/;static DEFAULT_RULE_PRIORITY=50;static EQUALS_CHAR_CODE=61;tags;styles;_matchedStyles;isNormalizeLists;_schema;tagIndexMap;styleIndexMap;constructor(t,e){this._schema=t;const{tags:n,styles:i,matchedStyles:s}=this.initRules(e);this.tags=n,this.styles=i,this._matchedStyles=s,this.tagIndexMap=new Map(n.map((t,e)=>[t,e])),this.styleIndexMap=new Map(i.map((t,e)=>[t,e])),this.isNormalizeLists=this.checkListNormalization(t)}get matchedStyles(){return this._matchedStyles}get normalizeLists(){return this.isNormalizeLists}get schema(){return this._schema}static fromSchema(e){return e.cached.domParser??=new t(e,t.schemaRules(e)),e.cached.domParser}static schemaRules(e){const n=[],i=e=>{const i=e.priority??t.DEFAULT_RULE_PRIORITY;let s=0;for(;s<n.length&&!((n[s].priority??t.DEFAULT_RULE_PRIORITY)<i);s++);n.splice(s,0,e)};for(const s in e.marks){const n=e.marks[s].spec.parseDOM;n&&n.forEach(e=>{const n=t.copy(e);n.mark||n.ignore||n.clearMark||(n.mark=s),i(n)})}for(const s in e.nodes){const n=e.nodes[s].spec.parseDOM;n&&n.forEach(e=>{const n=t.copy(e);n.node||n.ignore||n.mark||(n.node=s),i(n)})}return n}static copy(t){const e={};for(const n in t)K(t,n)&&(e[n]=t[n]);return e}matchTag(t,e,n){const i=t;for(let s=n?(this.tagIndexMap.get(n)??-1)+1:0;s<this.tags.length;s++){const n=this.tags[s];if(this.isTagRuleApplicable(i,n,e)){if(n.getAttrs){const e=t,i=n.getAttrs(e);if(!1===i)continue;n.attrs=i||void 0}return n}}}matchStyle(t,e,n,i){for(let s=i?(this.styleIndexMap.get(i)??-1)+1:0;s<this.styles.length;s++){const i=this.styles[s];if(this.isStyleRuleApplicable(i,t,e,n)){if(i.getAttrs){const t=i.getAttrs(e);if(!1===t)continue;i.attrs=t||void 0}return i}}}parse(t,e={}){if(null===t)return;if("string"==typeof t){const e=document.createElement("div");e.innerHTML=t,t=document.createDocumentFragment().appendChild(e)}const n=xt.createParseContext(this,e,!1);return n.addAll(t,Q.none,e.from,e.to),n.finish()}parseSlice(t,e={}){const n=xt.createParseContext(this,e,!0);return n.addAll(t,Q.none,e.from,e.to),tt.maxOpen(n.finish())}isTagRuleApplicable(t,e,n){return!(!this.matches(t,e.tag)||!U(e.namespace)&&t.namespaceURI!==e.namespace||e.context&&!n.matchesContext(e.context))}isStyleRuleApplicable(e,n,i,s){const r=e.style;if(!r.startsWith(n))return!1;if(e.context&&!s.matchesContext(e.context))return!1;if(r.length>n.length){const e=r.charCodeAt(n.length)===t.EQUALS_CHAR_CODE,s=r.slice(n.length+1)===i;if(!e||!s)return!1}return!0}isTagRule(t){return!U(t.tag)}isStyleRule(t){return!U(t.style)}matches(t,e){if("matches"in t&&"function"==typeof t.matches)return t.matches(e);const n=t;return n.msMatchesSelector?n.msMatchesSelector(e):n.webkitMatchesSelector?n.webkitMatchesSelector(e):!!n.mozMatchesSelector&&n.mozMatchesSelector(e)}initRules(e){const n=[],i=[],s=new Set;return e.forEach(e=>{if(this.isTagRule(e))n.push(e);else if(this.isStyleRule(e)){const n=e,r=t.REGEX_STYLE_PROP_NAME.exec(n.style),o=r?.[0];o&&s.add(o),i.push(n)}}),{tags:n,styles:i,matchedStyles:Array.from(s)}}checkListNormalization(e){return!this.tags.some(n=>{if(!t.REGEX_LIST_TAG.test(n.tag)||!n.node)return!1;const i=e.nodes[n.node];return!!i&&Boolean(i.contentMatch.matchType(i))})}},_t=class t{static SUSPICIOUS_ATTRIBUTE_CACHE=new WeakMap;nodesVar;marksVar;constructor(t,e){this.nodesVar=t,this.marksVar=e}get nodes(){return this.nodesVar}get marks(){return this.marksVar}static renderSpec(e,n,i=null,s){return t.renderSpecInternal(e,n,i,s)}static fromSchema(e){return U(e.cached.domSerializer)&&(e.cached.domSerializer=new t(this.nodesFromSchema(e),this.marksFromSchema(e))),e.cached.domSerializer}static renderSpecInternal(e,n,i,s){if("string"==typeof n)return{dom:e.createTextNode(n)};if("object"==typeof n&&"nodeType"in n&&!U(n.nodeType))return{dom:n};if("object"==typeof n&&"dom"in n&&n.dom&&"nodeType"in n.dom)return n;if(!Array.isArray(n))throw new RangeError("Invalid structure passed to renderSpec");const r=n,o=r[0];if("string"!=typeof o)throw new RangeError("Invalid array passed to renderSpec: first element must be a tag name string");const a=o;if(s){const e=t.suspiciousAttributes(s);if(e?.includes(r))throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.")}let l=i,c=a;const h=a.indexOf(" ");h>0&&(l=a.slice(0,h),c=a.slice(h+1));const d=l?e.createElementNS(l,c):e.createElement(c);let u,p=1;if(r.length>1){const t=r[1];if(t&&"object"==typeof t&&!("nodeType"in t)&&!Array.isArray(t)){const e=t;p=2;for(const t in e){const n=e[t];if(U(n))continue;const i=t.indexOf(" ");if(i>0){const e=t.slice(0,i),s=t.slice(i+1);d.setAttributeNS(e,s,String(n))}else"style"===t&&"style"in d&&d.style?"string"==typeof n&&(d.style.cssText=n):d.setAttribute(t,String(n))}}}for(let f=p;f<r.length;f++){const n=r[f];if(0===n){if(f<r.length-1||f>p)throw new RangeError(`Content hole (0) must be the only child of its parent node. Found at position ${f} with ${r.length-p-1} total children.`);return{dom:d,contentDOM:d}}const{dom:i,contentDOM:o}=t.renderSpecInternal(e,n,l,s);if(d.appendChild(i),o){if(u)throw new RangeError("Multiple content holes are not allowed in a DOM spec");u=o}}return{dom:d,contentDOM:u}}static suspiciousAttributes(e){let n=t.SUSPICIOUS_ATTRIBUTE_CACHE.get(e);return void 0===n&&(n=t.suspiciousAttributesInner(e),t.SUSPICIOUS_ATTRIBUTE_CACHE.set(e,n)),n}static suspiciousAttributesInner(e){const n=[];return t.scan(e,n),n.length>0?n:null}static scan(e,n){if("object"==typeof e&&!U(e))if(Array.isArray(e))if("string"==typeof e[0])n.push(e);else for(const i of e)t.scan(i,n);else for(const i in e)t.scan(e[i],n)}static nodesFromSchema(e){const n=t.gatherToDOM(e.nodes);return n.text||(n.text=t=>t.text??""),n}static marksFromSchema(e){return t.gatherToDOM(e.marks)}static gatherToDOM(t){const e={};for(const n in t){const i=t[n].spec.toDOM;i&&(e[n]=i)}return e}serializeFragment(t,e={},n){n||(n=this.doc(e).createDocumentFragment());let i=n;const s=[];return t.forEach(t=>{if(s.length||t.marks.length){let n=0,r=0;for(;n<s.length&&r<t.marks.length;){const e=t.marks[r];if(this.marks[e.type.name]){if(!e.eq(s[n][0])||j(e.type.spec.spanning))break;n++,r++}else r++}for(;n<s.length;){const t=s.pop();t&&(i=t[1])}for(;r<t.marks.length;){const n=t.marks[r++],o=this.serializeMark(n,t.isInline,e);o&&(s.push([n,i]),i.appendChild(o.dom),i=o.contentDOM||o.dom)}}i.appendChild(this.serializeNodeInner(t,e))}),n}serializeNode(t,e={}){let n=this.serializeNodeInner(t,e);for(let i=t.marks.length-1;i>=0;i--){const s=this.serializeMark(t.marks[i],t.isInline,e);s&&(s.contentDOM?s.contentDOM.appendChild(n):s.dom&&s.dom.appendChild(n),n=s.dom)}return n}serializeNodeInner(e,n){const i=this.nodesVar[e.type.name];if(!i)throw new RangeError(`No serializer found for node type '${e.type.name}'`);const{dom:s,contentDOM:r}=t.renderSpecInternal(this.doc(n),i(e),null,e.attrs);if(r){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,n,r)}return s}serializeMark(e,n,i={}){const s=this.marks[e.type.name];return s?t.renderSpecInternal(this.doc(i),s(e,n),null,e.attrs):null}doc(t){return t.document||window.document}},Tt=class{hasDefaultValue;defaultValue;validateFunc;excludeFromMarkup;constructor(t,e,n){this.hasDefaultValue=K(n,"default"),this.defaultValue=n.default,this.validateFunc="string"==typeof n.validate?this.validateType(t,e,n.validate):n.validate,this.excludeFromMarkup=n.excludeFromMarkupComparison??!1}get isRequired(){return!this.hasDefaultValue}get default(){return this.defaultValue}get hasDefault(){return this.hasDefaultValue}get validate(){return this.validateFunc}get excludeFromMarkupComparison(){return this.excludeFromMarkup}validateType(t,e,n){const i=n.split("|");return n=>{const s=U(n)?"null":typeof n;if(!i.includes(s))throw new RangeError(`Expected value of type ${i.toString()} for attribute ${e} on type ${t}, got ${s}`)}}},Et=class{attrs;constructor(t,e){this.attrs=this.initAttrs(t,e)}checkAttributes(t,e){for(const n in t)if(!(n in this.attrs))throw new RangeError(`Unsupported attribute '${n}' for ${e}`);for(const n in this.attrs){const e=this.attrs[n];if(e.validate){const i=t[n];e.validate(i)}}}createDefaultAttrs(){const t=Object.create(null);for(const e in this.attrs){const n=this.attrs[e];if(!n.hasDefault)return null;t[e]=n.default}return t}computeAttributes(t){const e=Object.create(null);for(const n in this.attrs){let i=t?.[n];if(void 0===i){const t=this.attrs[n];if(!t.hasDefault)throw new RangeError(`No value supplied for attribute ${n}`);i=t.default}e[n]=i}return Ct.ELEMENTS_ID_ATTR_NAME in this.attrs&&null===e.id&&(e.id=q()),e}initAttrs(t,e){const n=Object.create(null);if(e)for(const i in e)n[i]=new Tt(t,i,e[i]);return n}},Ct=class t extends Et{static ELEMENTS_ID_ATTR_NAME="id";excludedTypes;instance;markTypeName;markTypeRank;markTypeSchema;markTypeSpec;constructor(t,e,n,i){super(t,i.attrs),this.markTypeName=t,this.markTypeRank=e,this.markTypeSchema=n,this.markTypeSpec=i,this.excludedTypes=[];const s=this.createDefaultAttrs();this.instance=s?new Q(this,s):null}get excluded(){return this.excludedTypes}set excluded(t){this.excludedTypes=t}get name(){return this.markTypeName}get schema(){return this.markTypeSchema}get spec(){return this.markTypeSpec}get rank(){return this.markTypeRank}get attributeSpecs(){return this.attrs}static compile(e,n){const i=Object.create(null);let s=0;return e.forEach((e,r)=>(i[e]=new t(e,s++,n,r),i[e])),i}create(t=null){return!t&&this.instance?this.instance:new Q(this,this.computeAttributes(t))}removeFromSet(t){let e=null;for(let n=0;n<t.length;n++)t[n].type===this?e||(e=[...t.slice(0,n)]):e&&e.push(t[n]);return e??t}isInSet(t){for(const e of t)if(e.type===this)return e}checkAttrs(t){this.checkAttributes(t,"mark")}excludes(t){return this.excludedTypes.includes(t)}},Mt=class{nextMatch=[];wrapCache=new Map;isValidEnd;constructor(t){this.isValidEnd=t}get next(){return this.nextMatch}get validEnd(){return this.isValidEnd}get inlineContent(){return this.nextMatch.length>0&&this.nextMatch[0].type.isInline}get defaultType(){for(const t of this.nextMatch){const{type:e}=t;if(!e.isText&&!e.hasRequiredAttrs())return e}return null}get edgeCount(){return this.nextMatch.length}matchType(t){for(const e of this.nextMatch)if(e.type===t)return e.next;return null}matchFragment(t,e=0,n=t.childCount){return this.matchFragmentInternal(t,e,n)}compatible(t){for(const e of this.nextMatch)for(const n of t.nextMatch)if(e.type===n.type)return!0;return!1}fillBefore(t,e=!1,n=0){const i=new Set([this]),s=(r,o)=>{const a=r.matchFragment(t,n);if(a&&(!e||a.validEnd))return Z.from(o.map(t=>t.createAndFill()));for(const t of r.nextMatch){const{type:e,next:n}=t,r=!e.isText&&!e.hasRequiredAttrs(),a=!i.has(n);if(r&&a){i.add(n);const t=s(n,o.concat(e));if(t)return t}}return null};return s(this,[])}findWrapping(t){const e=this.wrapCache.get(t);if(void 0!==e)return e;const n=this.computeWrapping(t);return this.wrapCache.set(t,n),n}edge(t){if(t<0||t>=this.nextMatch.length)throw new RangeError(`Edge index ${t} is out of bounds. Valid range: 0-${this.nextMatch.length-1}`);return this.nextMatch[t]}toString(){const t=[],e=new Set;this.scan(this,t,e);const n=new Map;return t.forEach((t,e)=>{n.set(t,e)}),t.map((t,e)=>{let i=`${e}${t.validEnd?"*":" "} `;for(let s=0;s<t.nextMatch.length;s++){const e=t.nextMatch[s],r=s>0?", ":"",o=n.get(e.next)??-1;i+=`${r}${e.type.name}->${o}`}return i}).join("\n")}matchFragmentInternal(t,e,n){let i=this;for(let s=e;s<n&&i;s++)i=i.matchType(t.child(s).type);return i}scan(t,e,n){e.push(t),n.add(t);for(const i of t.nextMatch)n.has(i.next)||this.scan(i.next,e,n)}computeWrapping(t){const e={},n=[{match:this,type:null,via:null}];for(;n.length>0;){const i=n.shift();if(!i)continue;const s=i.match;if(s.matchType(t)){const t=[];let e=i;for(;e?.type;)t.push(e.type),e=e.via;return t.reverse()}for(const t of s.nextMatch){const{type:s,next:r}=t;!s.isLeaf&&!s.hasRequiredAttrs()&&!e[s.name]&&(!i.type||r.validEnd)&&(n.push({match:s.contentMatch,type:s,via:i}),e[s.name]=!0)}}return null}},kt=class t{static _EMPTY_CONTENT_MATCH=null;static get EMPTY_CONTENT_MATCH(){return t._EMPTY_CONTENT_MATCH||(t._EMPTY_CONTENT_MATCH=new Mt(!0)),t._EMPTY_CONTENT_MATCH}},Dt=class t extends Et{static ELEMENTS_ID_ATTR_NAME="id";_contentMatch;isInlineContent=!1;_isBlock;_isText;_defaultAttrs;groups;_name;_schema;_spec;_markSet=null;constructor(t,e,n){super(t,n.attrs),this._name=t,this._schema=e,this._spec=n,this.groups=n.group?n.group.split(" "):[],this._defaultAttrs=this.createDefaultAttrs(),this._isBlock=!(n.inline||"text"===t),this._isText="text"===t}get name(){return this._name}get schema(){return this._schema}get spec(){return this._spec}get contentMatch(){return this._contentMatch}set contentMatch(t){this._contentMatch=t}get markSet(){return this._markSet}set markSet(t){this._markSet=t}get defaultAttrs(){return this._defaultAttrs}get attributeSpecs(){return this.attrs}get inlineContent(){return this.isInlineContent}set inlineContent(t){this.isInlineContent=t}get isInline(){return!this._isBlock}get isTextblock(){return this._isBlock&&this.isInlineContent}get isBlock(){return this._isBlock}get isText(){return this._isText}get isLeaf(){return this._contentMatch===kt.EMPTY_CONTENT_MATCH}get isAtom(){return this.isLeaf||!!this._spec.atom}get whitespace(){const t=this._spec.whitespace||(this._spec.code?"pre":"normal");return"pre"!==t&&"normal"!==t?"normal":t}static compile(e,n){const i=Object.create(null);e.forEach((e,s)=>(i[e]=new t(e,n,s),i[e]));const s=n.spec.topNode||"doc";if(!i[s])throw new RangeError(`Schema is missing its top node type ('${s}')`);if(!i.text)throw new RangeError("Every schema needs a 'text' type");if(i.text.attrs&&Object.getOwnPropertyNames(i.text.attrs).length>0)throw new RangeError("The text node type should not have attributes");return i}isInGroup(t){return this.groups.includes(t)}hasRequiredAttrs(){for(const t in this.attrs)if(this.attrs[t].isRequired)return!0;return!1}compatibleContent(t){return this===t||this._contentMatch.compatible(t.contentMatch)}create(t,e,n){if(this._isText)throw new Error("NodeType.create can't construct text nodes");return new bt(this,this.computeAttrs(t),Z.from(e),Q.setFrom(n))}createChecked(t=null,e,n){return e=Z.from(e),this.checkContent(e),new bt(this,this.computeAttrs(t),e,Q.setFrom(n))}createAndFill(t=null,e,n){if(t=this.computeAttrs(t),(e=Z.from(e)).size){const t=this._contentMatch.fillBefore(e);if(!t)return null;e=t.append(e)}const i=this._contentMatch.matchFragment(e),s=i?.fillBefore(Z.empty,!0);return s?new bt(this,t,e.append(s),Q.setFrom(n)):null}validContent(t){const e=this._contentMatch.matchFragment(t);if(!e?.validEnd)return!1;for(let n=0;n<t.childCount;n++)if(!this.allowsMarks(t.child(n).marks))return!1;return!0}checkContent(t){if(!this.validContent(t))throw new RangeError(`Invalid content for node ${this._name}: ${t.toString().slice(0,50)}`)}checkAttrs(t){this.checkAttributes(t,"node")}allowsMarkType(t){return U(this._markSet)||this._markSet.includes(t)}allowsMarks(t){if(U(this._markSet))return!0;for(const e of t)if(!this.allowsMarkType(e.type))return!1;return!0}allowedMarks(t){if(U(this._markSet))return t;let e;for(let n=0;n<t.length;n++)this.allowsMarkType(t[n].type)?e&&e.push(t[n]):e??=t.slice(0,n);return e?e.length?e:Q.none:t}computeAttrs(e){let n={};return n=!e&&this._defaultAttrs?{...this._defaultAttrs}:this.computeAttributes(e),t.ELEMENTS_ID_ATTR_NAME in this.attrs&&null===n.id&&(n.id=q()),n}},It=class{nfaList;contentMatch;constructor(t){this.nfaList=[[]],this.nfa(t),this.contentMatch=this.dfa()}get match(){return this.contentMatch}getCheckedMatch(t){return this.checkForDeadEnds(t),this.contentMatch}nfa(t){const e=this.compile(t,0),n=this.node();this.connect(e,n)}dfa(){const t=new Map,e=this.nullFrom(0);return this.explore(e,t)}connect(t,e){t.forEach(t=>{t.to=e})}compile(t,e){switch(t.type){case"choice":return 0===t.exprs.length?[this.edge(e)]:t.exprs.reduce((t,n)=>t.concat(this.compile(n,e)),[]);case"seq":{if(0===t.exprs.length)return[this.edge(e)];let n=e;for(let e=0;e<t.exprs.length;e++){const i=this.compile(t.exprs[e],n);if(e===t.exprs.length-1)return i;n=this.node(),this.connect(i,n)}return[]}case"star":{const n=this.node();return this.edge(e,n),this.connect(this.compile(t.expr,n),n),[this.edge(n)]}case"plus":{const n=this.node();return this.connect(this.compile(t.expr,e),n),this.connect(this.compile(t.expr,n),n),[this.edge(n)]}case"opt":return[this.edge(e)].concat(this.compile(t.expr,e));case"range":{let n=e;for(let e=0;e<t.min;e++){const e=this.node();this.connect(this.compile(t.expr,n),e),n=e}if(-1===t.max)this.connect(this.compile(t.expr,n),n);else for(let e=t.min;e<t.max;e++){const e=this.node();this.edge(n,e),this.connect(this.compile(t.expr,n),e),n=e}return[this.edge(n)]}case"name":return[this.edge(e,void 0,t.value)];default:throw new Error(`Unknown expression type: ${t.type}`)}}edge(t,e,n){const i={term:n,to:e};return this.nfaList[t].push(i),i}node(){return this.nfaList.push([])-1}explore(t,e){const n=new Map;for(const o of t)for(const{term:t,to:e}of this.nfaList[o]){if(!t||void 0===e)continue;let i=n.get(t);i||(i=new Set,n.set(t,i));for(const t of this.nullFrom(e))i.add(t)}const i=t.includes(this.nfaList.length-1),s=new Mt(i),r=t.join(",");e.set(r,s);for(const[o,a]of n){const t=Array.from(a).sort((t,e)=>e-t),n=t.join(","),i=e.get(n)||this.explore(t,e);s.next.push({type:o,next:i})}return s}nullFrom(t){const e=[],n=new Set;return this.scanEpsilonClosure(t,e,n),e.sort((t,e)=>e-t)}scanEpsilonClosure(t,e,n){const i=this.nfaList[t];if(1!==i.length||i[0].term||void 0===i[0].to){e.push(t),n.add(t);for(const{term:t,to:s}of i)t||void 0===s||n.has(s)||this.scanEpsilonClosure(s,e,n)}else this.scanEpsilonClosure(i[0].to,e,n)}checkForDeadEnds(t){const e=[this.match],n=new Set;for(const i of e){if(n.has(i))continue;n.add(i);let s=!i.validEnd;const r=[];for(const{type:t,next:o}of i.next)r.push(t.name),!s||t.isText||t.hasRequiredAttrs()||(s=!1),n.has(o)||e.push(o);s&&t.err(`Only non-generatable nodes (${r.join(", ")}) in a required position (see https://prosemirror.net/docs/guide/#generatable)`)}}},Nt=class{tokens;_nodeTypes;expression;isInline=null;position=0;constructor(t,e){this._nodeTypes=e,this.expression=t,this.tokens=t.split(/\s*(?=\b|\W|$)/),this.tokens.length>0&&""===this.tokens[this.tokens.length-1]&&this.tokens.pop(),this.tokens.length>0&&""===this.tokens[0]&&this.tokens.shift()}get inline(){return this.isInline}set inline(t){this.isInline=t}get pos(){return this.position}set pos(t){if(t<0)throw new RangeError(`Token position cannot be negative: ${t}`);this.position=t}get nodeTypes(){return this._nodeTypes}get next(){return this.tokens[this.position]}eat(t){return this.next===t&&(this.position++,!0)}err(t){throw new SyntaxError(`${t} (in content expression '${this.expression}')`)}},Pt=class t{static NON_DIGIT_REGEX=/\D/;static NON_WORD_REGEX=/\W/;static parse(e,n){return(new t).parse(e,n)}parse(t,e){const n=new Nt(t,e);if(U(n.next))return kt.EMPTY_CONTENT_MATCH;const i=this.parseExpr(n);return n.next&&n.err("Unexpected trailing text"),new It(i).getCheckedMatch(n)}parseExpr(t){const e=[];do{e.push(this.parseExprSeq(t))}while(t.eat("|"));return 1===e.length?e[0]:{type:"choice",exprs:e}}parseExprSeq(t){const e=[];for(;t.next&&")"!==t.next&&"|"!==t.next;)e.push(this.parseExprSubscript(t));return 1===e.length?e[0]:{type:"seq",exprs:e}}parseExprSubscript(t){let e=this.parseExprAtom(t);for(;;)if(t.eat("+"))e={type:"plus",expr:e};else if(t.eat("*"))e={type:"star",expr:e};else if(t.eat("?"))e={type:"opt",expr:e};else{if(!t.eat("{"))break;e=this.parseExprRange(t,e)}return e}parseNum(e){e.next||e.err("Expected number, got end of input");const n=e.next;t.NON_DIGIT_REGEX.test(n)&&e.err(`Expected number, got '${n}'`);const i=Number(n);return e.pos++,i}parseExprRange(t,e){const n=this.parseNum(t);let i=n;return t.eat(",")&&(i="}"!==t.next?this.parseNum(t):-1),n<0&&t.err(`Range minimum cannot be negative: ${n}`),-1!==i&&i<n&&t.err(`Range maximum (${i}) cannot be less than minimum (${n})`),t.eat("}")||t.err("Unclosed braced range"),{type:"range",min:n,max:i,expr:e}}resolveName(t,e){const n=t.nodeTypes,i=n[e];if(i)return[i];const s=[];for(const r in n){const t=n[r];t.isInGroup(e)&&s.push(t)}return 0===s.length&&t.err(`No node type or group '${e}' found`),s}parseExprAtom(e){if(e.eat("(")){const t=this.parseExpr(e);return e.eat(")")||e.err("Missing closing paren"),t}if(!t.NON_WORD_REGEX.test(e.next)){const t=e.next,n=this.resolveName(e,t);if(e.pos++,1===n.length){const t=n[0];return U(e.inline)?e.inline=t.isInline:e.inline!==t.isInline&&e.err("Mixing inline and block content"),{type:"name",value:t}}return{type:"choice",exprs:n.map(t=>(U(e.inline)?e.inline=t.isInline:e.inline!==t.isInline&&e.err("Mixing inline and block content"),{type:"name",value:t}))}}e.err(`Unexpected token '${e.next}'`)}};function Ot(t,e){const n=t.resolve(e),i=n.index();return function(t,e){return!(!t||!e)&&!t.isLeaf&&function(t,e){if(!e.content.size)return t.type.compatibleContent(e.type);const{linebreakReplacement:n}=t.type.schema;let i=t.contentMatchAt(t.childCount);for(let s=0;s<e.childCount;s++){const r=e.child(s),o=r.type===n?t.type.schema.nodes.text:r.type;if(i=i?.matchType(o),!i)return!1;if(!t.type.allowsMarks(r.marks))return!1}return i.validEnd}(t,e)}(n.nodeBefore,n.nodeAfter)&&n.parent.canReplace(i,i+1)}function Rt(t,e,n=1,i){const s=t.resolve(e),r=s.depth-n;return!!function(t,e,n){const i=t.parent,s=t.index(),r=n?.[n.length-1]||i;if(e<0)return!1;if(i.type.spec.isolating)return!1;if(!i.canReplace(s,i.childCount))return!1;const o=i.content.cutByIndex(s,i.childCount);return r.type.validContent(o)}(s,r,i)&&!!function(t,e,n,i){for(let s=t.depth-1,r=n-2;s>e;s--,r--)if(!Bt(t,s,r,i))return!1;return!0}(s,r,n,i)&&function(t,e,n){const i=t.indexAfter(e),s=n?.[0],r=s?s.type:t.node(e+1).type;return t.node(e).canReplaceWith(i,i,r)}(s,r,i)}function Bt(t,e,n,i){const s=t.node(e),r=t.index(e);if(s.type.spec.isolating)return!1;let o=s.content.cutByIndex(r,s.childCount);const a=i?.[n+1];return a&&(o=o.replaceChild(0,a.type.create(a.attrs))),!!s.canReplace(r+1,s.childCount)&&(i?.[n]||s).type.validContent(o)}var Ft=(t=>(t[t.BEFORE=1]="BEFORE",t[t.AFTER=2]="AFTER",t[t.ACROSS=4]="ACROSS",t[t.SIDE=8]="SIDE",t))(Ft||{});let Lt=class{_pos;_delInfo;_recover;constructor(t,e,n){this._pos=t,this._delInfo=e,this._recover=n}get pos(){return this._pos}get delInfo(){return this._delInfo}get recover(){return this._recover}get deleted(){return(this.delInfo&Ft.SIDE)>0}get deletedBefore(){return(this.delInfo&(Ft.BEFORE|Ft.ACROSS))>0}get deletedAfter(){return(this.delInfo&(Ft.AFTER|Ft.ACROSS))>0}get deletedAcross(){return(this.delInfo&Ft.ACROSS)>0}},zt=class t{static empty=new t([]);static LOWER16=65535;static FACTOR16=Math.pow(2,16);ranges;inverted;constructor(e,n=!1){if(e.length%3!=0)throw new RangeError(`Invalid ranges array: length must be multiple of 3, got ${e.length}`);if(this.ranges=e,this.inverted=n,!e.length&&t.empty)return t.empty}static offset(e){return 0===e?t.empty:new t(e<0?[0,-e,0]:[0,0,e])}recover(t){let e=0;const n=this.recoverIndex(t);if(3*n>=this.ranges.length)throw new RangeError(`Invalid recovery value: index ${n} out of bounds (map has ${this.ranges.length/3} ranges)`);if(!this.inverted)for(let i=0;i<n;i++)e+=this.ranges[3*i+2]-this.ranges[3*i+1];return this.ranges[3*n]+e+this.recoverOffset(t)}mapResult(t,e=1){return this._map(t,e,!1)}map(t,e=1){return this._map(t,e,!0)}touches(t,e){let n=0;const i=this.recoverIndex(e),s=this.inverted?2:1,r=this.inverted?1:2;for(let o=0;o<this.ranges.length;o+=3){const e=this.ranges[o]-(this.inverted?n:0);if(e>t)break;const a=this.ranges[o+s];if(t<=e+a&&o===3*i)return!0;n+=this.ranges[o+r]-a}return!1}forEach(t){const e=this.inverted?2:1,n=this.inverted?1:2;for(let i=0,s=0;i<this.ranges.length;i+=3){const r=this.ranges[i],o=r-(this.inverted?s:0),a=r+(this.inverted?0:s),l=this.ranges[i+e],c=this.ranges[i+n];t(o,o+l,a,a+c),s+=c-l}}invert(){return new t(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}_map(t,e,n){let i=0;const s=this.inverted?2:1,r=this.inverted?1:2;for(let o=0;o<this.ranges.length;o+=3){const a=this.ranges[o]-(this.inverted?i:0);if(a>t)break;const l=this.ranges[o+s],c=this.ranges[o+r],h=a+l;if(t<=h){let s;s=l?t===a?-1:t===h?1:e:e;const r=a+i+(s<0?0:c);if(n)return r;let d,u;return d=t===(e<0?a:h)?null:this.makeRecover(o/3,t-a),u=t===a?Ft.AFTER:t===h?Ft.BEFORE:Ft.ACROSS,(e<0?t!==a:t!==h)&&(u|=Ft.SIDE),new Lt(r,u,d)}i+=c-l}return n?t+i:new Lt(t+i,0,null)}makeRecover(e,n){return e+n*t.FACTOR16}recoverIndex(e){return e&t.LOWER16}recoverOffset(e){return(e-(e&t.LOWER16))/t.FACTOR16}},Vt=class t{static STEP_IMPLEMENTATIONS=new Map;static fromJSON(e,n){if(!e)throw new RangeError("Schema is required for Step.fromJSON");if(!n?.stepType||""===n.stepType)throw new RangeError("Invalid input for Step.fromJSON: stepType is required");const i=t.STEP_IMPLEMENTATIONS.get(n.stepType);if(!i)throw new RangeError(`No step type ${n.stepType} defined`);return i.fromJSON(e,n)}static registerStep(e,n){if(t.STEP_IMPLEMENTATIONS.has(e))throw new RangeError("Duplicate use of step JSON ID "+e);t.STEP_IMPLEMENTATIONS.set(e,n)}getMap(){return zt.empty}merge(t){return null}mapFragment(t,e,n){const i=[];for(let s=0;s<t.childCount;s++){let r=t.child(s);r.content.size&&(r=r.copy(this.mapFragment(r.content,e,r))),r.isInline&&(r=e(r,n,s)),i.push(r)}return Z.fromArray(i)}},Ht=class t{_doc;_failed;constructor(t,e){if(U(t)&&U(e)||!U(t)&&!U(e))throw new Error("StepResult must have either doc or failed message, but not both or neither");this._doc=t,this._failed=e}get doc(){return this._doc}get failed(){return this._failed}static ok(e){if(!e)throw new Error("StepResult.ok requires a valid document");return new t(e,null)}static fail(e){if(!e||"string"!=typeof e)throw new Error("StepResult.fail requires a non-empty error message");return new t(null,e)}static fromReplace(e,n,i,s){try{return t.ok(e.replace(n,i,s))}catch(r){if(r instanceof rt)return t.fail(r.message);throw r}}},$t=class extends Vt{contentBetween(t,e,n){const i=t.resolve(e);let s=n-e,r=i.depth;for(;s>0&&r>0&&i.indexAfter(r)===i.node(r).childCount;)r--,s--;if(s>0){let t=i.node(r).maybeChild(i.indexAfter(r));for(;s>0;){if(U(t)||t.isLeaf)return!0;t=t.firstChild,s--}}return!1}},Ut=class t extends $t{_from;_to;_slice;structure;constructor(t,e,n,i=!1){super(),this._from=t,this._to=e,this._slice=n,this.structure=i}get from(){return this._from}get to(){return this._to}get slice(){return this._slice}static fromJSON(e,n){if("number"!=typeof n.from||"number"!=typeof n.to)throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new t(n.from,n.to,tt.fromJSON(e,n.slice),W(n.structure))}apply(t){return this.structure&&this.contentBetween(t,this._from,this._to)?Ht.fail("Structure replace would overwrite content"):Ht.fromReplace(t,this._from,this._to,this._slice)}getMap(){return new zt([this._from,this._to-this._from,this._slice.size])}invert(e){return new t(this._from,this._from+this._slice.size,e.slice(this._from,this._to))}map(e){const n=e.mapResult(this._from,1),i=e.mapResult(this._to,-1);return n.deletedAcross&&i.deletedAcross?null:new t(n.pos,Math.max(n.pos,i.pos),this._slice,this.structure)}merge(e){if(!(e instanceof t)||e.structure||this.structure)return null;if(this._from+this._slice.size!==e._from||this._slice.openEnd||e.slice.openStart){if(e._to!==this._from||this._slice.openStart||e.slice.openEnd)return null;{let n;if(this._slice.size+e.slice.size===0)n=tt.empty;else{const t=e.slice.content.append(this._slice.content);n=new tt(t,e.slice.openStart,this._slice.openEnd)}return new t(e._from,this._to,n,this.structure)}}{let n;if(this._slice.size+e.slice.size===0)n=tt.empty;else{const t=this._slice.content.append(e.slice.content);n=new tt(t,this._slice.openStart,e.slice.openEnd)}const i=this._to+(e._to-e._from);return new t(this._from,i,n,this.structure)}}toJSON(){const t={stepType:"replace",from:this._from,to:this._to};return this._slice.size&&(t.slice=this._slice.toJSON()),this.structure&&(t.structure=!0),t}};Vt.registerStep("replace",Ut);let Wt=class t extends Vt{from;mark;constructor(t,e,n){super(),this._to=e,this.from=t,this.mark=n}_to;get to(){return this._to}set to(t){this._to=t}static fromJSON(e,n){if("number"!=typeof n.from||"number"!=typeof n.to)throw new RangeError("Invalid input for AddMarkStep.fromJSON");if(n.from<0||n.to<0)throw new RangeError("Positions in AddMarkStep.fromJSON must be non-negative");if(n.from>n.to)throw new RangeError("Invalid range in AddMarkStep.fromJSON: from cannot be greater than to");if(!n.mark)throw new RangeError("Mark is required in AddMarkStep.fromJSON");return new t(n.from,n.to,e.markFromJSON(n.mark))}apply(t){const e=t.slice(this.from,this._to),n=t.resolve(this.from),i=n.node(n.sharedDepth(this._to)),s=this.mapFragment(e.content,(t,e)=>t.isAtom&&e.type.allowsMarkType(this.mark.type)?this.mark.isInSet(t.marks)?t:t.mark(this.mark.addToSet(t.marks)):t,i),r=new tt(s,e.openStart,e.openEnd);return Ht.fromReplace(t,this.from,this._to,r)}invert(){return Kt.createRemoveMarkStep(this.from,this._to,this.mark)}map(e){const n=e.mapResult(this.from,1),i=e.mapResult(this._to,-1);return n.deleted&&i.deleted||n.pos>=i.pos?null:new t(n.pos,i.pos,this.mark)}merge(e){if(e instanceof t&&e.mark.eq(this.mark)&&this.from<=e.to&&this._to>=e.from){const n=Math.min(this.from,e.from),i=Math.max(this._to,e.to);return new t(n,i,this.mark)}return null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this._to}}};Vt.registerStep("addMark",Wt);let Gt=class t extends Vt{pos;mark;constructor(t,e){super(),this.pos=t,this.mark=e}static fromJSON(e,n){if("number"!=typeof n.pos)throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");if(n.pos<0)throw new RangeError("Position in AddNodeMarkStep.fromJSON must be non-negative");if(!n.mark)throw new RangeError("Mark is required in AddNodeMarkStep.fromJSON");return new t(n.pos,e.markFromJSON(n.mark))}apply(t){let e;try{e=t.nodeAt(this.pos)}catch(r){return Ht.fail("No node at mark step's position")}if(!e)return Ht.fail("No node at mark step's position");const n=e.type.create(e.attrs,null,this.mark.addToSet(e.marks)),i=Z.from(n),s=new tt(i,0,e.isLeaf?0:1);return Ht.fromReplace(t,this.pos,this.pos+1,s)}invert(e){const n=e.nodeAt(this.pos);if(!n)throw new RangeError(`No node at position ${this.pos} for AddNodeMarkStep.invert`);const i=this.mark.addToSet(n.marks);if(i.length===n.marks.length){for(const e of n.marks)if(!e.isInSet(i))return new t(this.pos,e);return this}return Kt.createRemoveNodeMarkStep(this.pos,this.mark)}map(e){const n=e.mapResult(this.pos,1);return n.deletedAfter?null:new t(n.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}};Vt.registerStep("addNodeMark",Gt);let jt=class t extends Vt{pos;mark;constructor(t,e){super(),this.pos=t,this.mark=e}static fromJSON(e,n){if("number"!=typeof n.pos)throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");if(n.pos<0)throw new RangeError("Position in RemoveNodeMarkStep.fromJSON must be non-negative");if(!n.mark)throw new RangeError("Mark is required in RemoveNodeMarkStep.fromJSON");return new t(n.pos,e.markFromJSON(n.mark))}apply(t){let e;try{e=t.nodeAt(this.pos)}catch(r){return Ht.fail("No node at mark step's position")}if(!e)return Ht.fail("No node at mark step's position");const n=e.type.create(e.attrs,null,this.mark.removeFromSet(e.marks)),i=Z.from(n),s=new tt(i,0,e.isLeaf?0:1);return Ht.fromReplace(t,this.pos,this.pos+1,s)}invert(t){if(!t.nodeAt(this.pos))throw new RangeError(`No node at position ${this.pos} for RemoveNodeMarkStep.invert`);return Kt.createAddNodeMarkStep(this.pos,this.mark)}map(e){const n=e.mapResult(this.pos,1);return n.deletedAfter?null:new t(n.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}};Vt.registerStep("removeNodeMark",jt);let Kt=class{static createAddMarkStep(t,e,n){return new Wt(t,e,n)}static createRemoveMarkStep(t,e,n){return new qt(t,e,n)}static createAddNodeMarkStep(t,e){return new Gt(t,e)}static createRemoveNodeMarkStep(t,e){return new jt(t,e)}},qt=class t extends Vt{_from;_to;constructor(t,e,n){super(),this._to=e,this._from=t,this._mark=n}get from(){return this._from}set from(t){this._from=t}get to(){return this._to}set to(t){this._to=t}_mark;get mark(){return this._mark}set mark(t){this._mark=t}static fromJSON(e,n){if("number"!=typeof n.from||"number"!=typeof n.to)throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");if(n.from<0||n.to<0)throw new RangeError("Positions in RemoveMarkStep.fromJSON must be non-negative");if(n.from>n.to)throw new RangeError("Invalid range in RemoveMarkStep.fromJSON: from cannot be greater than to");if(!n.mark)throw new RangeError("Mark is required in RemoveMarkStep.fromJSON");return new t(n.from,n.to,e.markFromJSON(n.mark))}apply(t){const e=t.slice(this._from,this._to),n=t.resolve(this._from),i=n.node(n.sharedDepth(this._to)),s=this.mapFragment(e.content,t=>t.mark(this._mark.removeFromSet(t.marks)),i),r=new tt(s,e.openStart,e.openEnd);return Ht.fromReplace(t,this._from,this._to,r)}invert(){return Kt.createAddMarkStep(this._from,this._to,this._mark)}map(e){const n=e.mapResult(this._from,1),i=e.mapResult(this._to,-1);return n.deleted&&i.deleted||n.pos>=i.pos?null:new t(n.pos,i.pos,this._mark)}merge(e){if(e instanceof t&&e.mark.eq(this._mark)&&this._from<=e.to&&this._to>=e._from){const n=Math.min(this._from,e._from),i=Math.max(this._to,e.to);return new t(n,i,this._mark)}return null}toJSON(){return{stepType:"removeMark",mark:this._mark.toJSON(),from:this._from,to:this._to}}};function Yt(t,e,n,i){const s=[];e.forEach((t,e)=>{if(t.isText){const i=/\r?\n|\r/g;let r;for(;null!==(r=i.exec(t.text));)s.push(n+1+e+r.index)}});for(let r=s.length-1;r>=0;r--){const n=t.mapping.slice(i).map(s[r]);t.replaceWith(n,n+1,e.type.schema.linebreakReplacement.create())}}function Xt(t,e,n,i){e.forEach((s,r)=>{if(s.type===s.type.schema.linebreakReplacement){const s=t.mapping.slice(i).map(n+1+r),o=e.type.schema.text("\n");t.replaceWith(s,s+1,o)}})}function Jt(t,e,n,i,s){for(const r of e.marks)s.allowsMarkType(r.type)||t.step(new qt(n,i,r))}function Qt(t,e){return t.isText&&"pre"!==e.whitespace}function Zt(t,e,n,i){if(!t.text)return;const s=Array.from(t.text.matchAll(/\r?\n|\r/g));if(0===s.length)return;const r=n.schema.text(" ",n.allowedMarks(t.marks)),o=new tt(Z.from(r),0,0);for(const a of s){if(void 0===a.index)continue;const t=e+a.index,n=t+a[0].length;i.push(new Ut(t,n,o))}}function te(t,e,n,i,s=!0){if(e<0)throw new RangeError(`Invalid position: ${e} cannot be negative`);const r=t.doc.nodeAt(e);if(!r)throw new RangeError(`No node at position ${e}`);let o=i||n.contentMatch;const a=[];let l=e+1;for(let c=0;c<r.childCount;c++){const e=r.child(c),i=l+e.nodeSize,h=o.matchType(e.type);h?(o=h,Jt(t,e,l,i,n),s&&Qt(e,n)&&Zt(e,l,n,a)):a.push(new Ut(l,i,tt.empty)),l=i}!function(t,e,n){if(!e.validEnd){const i=e.fillBefore(Z.empty,!0);t.replace(n,n,new tt(i,0,0))}}(t,o,l),function(t,e){for(let n=e.length-1;n>=0;n--)t.step(e[n])}(t,a)}Vt.registerStep("removeMark",qt);let ee=class t extends $t{from;to;gapFrom;gapTo;slice;insert;structure;constructor(t,e,n,i,s,r,o=!1){super(),this.from=t,this.to=e,this.gapFrom=n,this.gapTo=i,this.slice=s,this.insert=r,this.structure=o}static fromJSON(e,n){if("number"!=typeof n.from||"number"!=typeof n.to||"number"!=typeof n.gapFrom||"number"!=typeof n.gapTo||"number"!=typeof n.insert)throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");const i=tt.fromJSON(e,n.slice);return new t(n.from,n.to,n.gapFrom,n.gapTo,i,n.insert,W(n.structure))}apply(t){if(this.structure&&(this.contentBetween(t,this.from,this.gapFrom)||this.contentBetween(t,this.gapTo,this.to)))return Ht.fail("Structure gap-replace would overwrite content");const e=t.slice(this.gapFrom,this.gapTo);if(e.openStart||e.openEnd)return Ht.fail("Gap is not a flat range");const n=this.slice.insertAt(this.insert,e.content);return n?Ht.fromReplace(t,this.from,this.to,n):Ht.fail("Content does not fit in gap")}getMap(){return new zt([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){const n=this.gapTo-this.gapFrom;return new t(this.from,this.from+this.slice.size+n,this.from+this.insert,this.from+this.insert+n,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){const n=e.mapResult(this.from,1),i=e.mapResult(this.to,-1);let s,r;return s=this.from===this.gapFrom?n.pos:e.map(this.gapFrom,-1),r=this.to===this.gapTo?i.pos:e.map(this.gapTo,1),n.deletedAcross&&i.deletedAcross||s<n.pos||r>i.pos?null:new t(n.pos,i.pos,s,r,this.slice,this.insert,this.structure)}toJSON(){const t={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(t.slice=this.slice.toJSON()),this.structure&&(t.structure=!0),t}};function ne(t,e,n,i,s){let r=Z.empty,o=0,a=!1,l=i;for(let c=e;c>n;c--)("start"===s?a||t.index(c)>0:a||t.after(c+1)<t.end(c))?(a=!0,r=Z.from(t.node(c).copy(r)),o++):l+="start"===s?-1:1;return"start"===s?{fragment:r,openLevels:o,adjustedStart:l}:{fragment:r,openLevels:o,adjustedEnd:l}}Vt.registerStep("replaceAround",ee);let ie=class t{ownData;_mirror;_from;_to;_maps;constructor(t,e,n=0,i){this._maps=t?Array.from(t):[],this.ownData=!(t||e),this._mirror=e,this._from=n,this._to=U(i)?t?t.length:0:i}get maps(){return this._maps}get from(){return this._from}get to(){return this._to}slice(e=0,n=this.maps.length){return new t(this._maps,this._mirror,e,n)}appendMap(t,e){this.ownData||(this._maps=this._maps.slice(),this._mirror=this._mirror?.slice(),this.ownData=!0),this._to=this._maps.push(t),U(e)||this.setMirror(this._maps.length-1,e)}appendMapping(t){const e=this._maps.length;for(let n=0;n<t._maps.length;n++){const i=t.getMirror(n);this.appendMap(t._maps[n],!U(i)&&i<n?e+i:void 0)}}getMirror(t){if(this._mirror)for(let e=0;e<this._mirror.length;e++)if(this._mirror[e]===t)return this._mirror[e+(e%2?-1:1)]}setMirror(t,e){this._mirror||(this._mirror=[]),this._mirror.push(t,e)}invert(){const e=new t;return e.appendMappingInverted(this),e}map(t,e=1){if(this._mirror&&this._mirror.length>0)return this._map(t,e,!0);for(let n=this._from;n<this._to;n++)t=this._maps[n].map(t,e);return t}mapResult(t,e=1){return this._map(t,e,!1)}appendMappingInverted(t){const e=this._maps.length+t._maps.length;for(let n=t.maps.length-1;n>=0;n--){const i=t.getMirror(n);this.appendMap(t._maps[n].invert(),!U(i)&&i>n?e-i-1:void 0)}}_map(t,e,n){let i=0;for(let s=this._from;s<this._to;s++){const n=this._maps[s].mapResult(t,e);if(!U(n.recover)){const e=this.getMirror(s);if(!U(e)&&e>s&&e<this._to){s=e,t=this._maps[e].recover(n.recover);continue}}i|=n.delInfo,t=n.pos}return n?t:new Lt(t,i,null)}},se=class t extends Vt{pos;attr;value;constructor(t,e,n){super(),this.pos=t,this.attr=e,this.value=n}static fromJSON(e,n){if("number"!=typeof n.pos||"string"!=typeof n.attr)throw new RangeError("Invalid input for AttrStep.fromJSON");if(n.pos<0)throw new RangeError("Position in AttrStep.fromJSON must be non-negative");if(0===n.attr.length)throw new RangeError("Attribute name in AttrStep.fromJSON cannot be empty");return new t(n.pos,n.attr,n.value)}apply(t){const e=t.nodeAt(this.pos);if(!e)return Ht.fail("No node at attribute step's position");const n=Object.create(null);for(const r in e.attrs)n[r]=e.attrs[r];n[this.attr]=this.value;const i=e.type.create(n,null,e.marks),s=new tt(Z.from(i),0,e.isLeaf?0:1);return Ht.fromReplace(t,this.pos,this.pos+1,s)}getMap(){return zt.empty}invert(e){const n=e.nodeAt(this.pos);if(!n)throw new RangeError(`No node at position ${this.pos} for AttrStep.invert`);return new t(this.pos,this.attr,n.attrs[this.attr])}map(e){const n=e.mapResult(this.pos,1);return n.deletedAfter?null:new t(n.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}};Vt.registerStep("attr",se);let re=class t extends Vt{attr;value;constructor(t,e){super(),this.attr=t,this.value=e}static fromJSON(e,n){if("string"!=typeof n.attr)throw new RangeError("Invalid input for DocAttrStep.fromJSON");if(0===n.attr.length)throw new RangeError("Attribute name in DocAttrStep.fromJSON cannot be empty");return new t(n.attr,n.value)}apply(t){const e=Object.create(null);for(const i in t.attrs)e[i]=t.attrs[i];e[this.attr]=this.value;const n=t.type.create(e,t.content,t.marks);return Ht.ok(n)}getMap(){return zt.empty}invert(e){return new t(this.attr,e.attrs[this.attr])}map(t){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}};function oe(t,e,n,i){if(e>n)throw new RangeError(`Invalid range: from (${e}) cannot be greater than to (${n})`);if(e===n)return;const s=[];let r=0;t.doc.nodesBetween(e,n,(t,o)=>{if(!t.isInline)return;r++;const a=(l=t,function(t){return t instanceof Ct}(c=i)?function(t,e){const n=[];let i=t,s=e.isInSet(i);for(;s;)n.push(s),i=s.removeFromSet(i),s=e.isInSet(i);return n}(l.marks,c):Q.isMark(c)?c.isInSet(l.marks)?[c]:[]:Array.from(l.marks));var l,c;if(a.length>0){const i=Math.min(o+t.nodeSize,n);!function(t,e,n,i,s){for(const r of t){const t=ae(s,r,i);t?(t.to=n,t.step=i):s.push({style:r,from:e,to:n,step:i})}}(a,Math.max(o,e),i,r,s)}}),s.forEach(e=>{t.step(new qt(e.from,e.to,e.style))})}function ae(t,e,n){return t.find(t=>t.step===n-1&&e.eq(t.style))}function le(t,e){const n=[];for(let i=Math.min(t.depth,e.depth);i>=0&&!ce(t,e,i);i--)he(t,e,i)&&n.push(i);return n}function ce(t,e,n){return!!(t.start(n)<t.pos-(t.depth-n)||e.end(n)>e.pos+(e.depth-n))||t.node(n).type.spec.isolating||e.node(n).type.spec.isolating}function he(t,e,n){const i=t.start(n);return i===e.start(n)||n===t.depth&&n===e.depth&&t.parent.inlineContent&&e.parent.inlineContent&&n>0&&e.start(n-1)===i-1}function de(t,e,n){return!n.openStart&&!n.openEnd&&t.start()===e.start()&&t.parent.canReplace(t.index(),e.index(),n.content)}function ue(t,e,n,i,s){const r=n-t.start(s)===t.depth-s,o=i>t.end(s),a=e.end(s)-i!==e.depth-s,l=t.start(s-1)===e.start(s-1);return!!(r&&o&&a&&l)&&t.node(s-1).canReplace(t.index(s-1),e.index(s-1))}function pe(t,e,n){return n&&0===e||t.node(e).type.contentMatch.validEnd}function fe(t,e,n,i){if(0===n)return!1;const s=t.node(n-1),r=t.index(n-1),o=e.indexAfter(n-1);return i||s.canReplace(r,o)}function me(t,e,n,i,s,r,o,a,l){for(let c=0;c<a.length;c++){let h=a[(c+l)%a.length],d=!0;h<0&&(d=!1,h=-h);const u=e.node(h-1),p=e.index(h-1);if(u.canReplaceWith(p,p,r.type,r.marks)){const r=ye(s.content,0,s.openStart,o),a=new tt(r,o,s.openEnd),l=e.before(h),c=d?n.after(h):i;return t.replace(l,c,a)}}return null}function ge(t){return t.spec.defining||t.spec.definingForContent}function ye(t,e,n,i,s){if(e<n){const s=t.firstChild,r=ye(s.content,e+1,n,i,s),o=s.copy(r);return t.replaceChild(0,o)}if(e>i&&s){const e=s.contentMatchAt(0),n=e.fillBefore(t).append(t),i=e.matchFragment(n);return n.append(i.fillBefore(Z.empty,!0))}return t}function be(t,e,n){for(let i=t.depth-1;i>=0;i--){const s="start"===n?t.index(i):t.indexAfter(i),r=t.node(i);if(r.canReplaceWith(s,s,e))return"start"===n?t.before(i+1):t.after(i+1);if(!("start"===n?0===s:s===r.childCount))return null}return null}Vt.registerStep("docAttr",re);let we=class{frontier=[];$from;$to;placedContent=Z.empty;unplacedContent;constructor(t,e,n){this.$from=t,this.$to=e,this.unplacedContent=n;for(let i=0;i<=t.depth;i++){const e=t.node(i);this.frontier.push({type:e.type,match:e.contentMatchAt(t.indexAfter(i))})}for(let i=t.depth;i>0;i--)this.placedContent=Z.from(t.node(i).copy(this.placedContent))}get depth(){return this.frontier.length-1}fit(){for(;this.unplacedContent.size;){const t=this.findFittable();t?this.placeNodes(t):this.openMore()||this.dropNode()}const t=this.mustMoveInline(),e=this.placedContent.size-this.depth-this.$from.depth,n=this.$from,i=this.close(t<0?this.$to:n.doc.resolve(t));if(!i)return null;let s=this.placedContent,r=n.depth,o=i.depth;for(;r&&o&&1===s.childCount;)s=s.firstChild.content,r--,o--;const a=new tt(s,r,o);return t>-1?new ee(n.pos,t,this.$to.pos,this.$to.end(),a,e):a.size||n.pos!==this.$to.pos?new Ut(n.pos,i.pos,a):null}findFittable(){const t=this.findNonIsolatingDepth();return this.tryDirectMatching(t)||this.tryWrappedMatching()}findNonIsolatingDepth(){const t=this.unplacedContent.openStart;let e=this.unplacedContent.openEnd,n=this.unplacedContent.content;for(let i=0;i<t;i++){const t=n.firstChild;if(n.childCount>1&&(e=0),t.type.spec.isolating&&e<=i)return i;n=t.content}return t}tryDirectMatching(t){for(let e=t;e>=0;e--){const{fragment:t,parent:n}=this.getFragmentAtDepth(e),i=t.firstChild;for(let s=this.depth;s>=0;s--){const{type:t,match:r}=this.frontier[s],o=this.tryDirectFit(i,n,t,r,e,s);if(o)return o;if(n&&r.matchType(n.type))break}}}tryWrappedMatching(){for(let t=this.unplacedContent.openStart;t>=0;t--){const{fragment:e,parent:n}=this.getFragmentAtDepth(t),i=e.firstChild;if(i)for(let s=this.depth;s>=0;s--){const{match:e}=this.frontier[s],r=e.findWrapping(i.type);if(r)return{sliceDepth:t,frontierDepth:s,parent:n,wrap:r};if(n&&e.matchType(n.type))break}}}getFragmentAtDepth(t){if(t>0){const e=this.contentAt(this.unplacedContent.content,t-1).firstChild;return{fragment:e.content,parent:e}}return{fragment:this.unplacedContent.content,parent:null}}tryDirectFit(t,e,n,i,s,r){if(t&&i.matchType(t.type))return{sliceDepth:s,frontierDepth:r,parent:e,inject:null};if(t){const n=i.fillBefore(Z.from(t),!1);if(n)return{sliceDepth:s,frontierDepth:r,parent:e,inject:n}}return!t&&e&&n.compatibleContent(e.type)?{sliceDepth:s,frontierDepth:r,parent:e,inject:null}:void 0}openMore(){const{content:t,openStart:e,openEnd:n}=this.unplacedContent,i=this.contentAt(t,e);if(!i.childCount||i.firstChild.isLeaf)return!1;const s=Math.max(n,i.size+e>=t.size-n?e+1:0);return this.unplacedContent=new tt(t,e+1,s),!0}dropNode(){const{content:t,openStart:e,openEnd:n}=this.unplacedContent,i=this.contentAt(t,e);if(i.childCount<=1&&e>0){const s=t.size-e<=e+i.size,r=this.dropFromFragment(t,e-1,1);this.unplacedContent=new tt(r,e-1,s?e-1:n)}else{const i=this.dropFromFragment(t,e,1);this.unplacedContent=new tt(i,e,n)}}placeNodes({sliceDepth:t,frontierDepth:e,parent:n,inject:i,wrap:s}){this.prepareFrontier(e,s);const r=this.unplacedContent,o=n?n.content:r.content,a=r.openStart-t,{nodesToAdd:l,match:c,taken:h,openEndCount:d}=this.fitFragmentIntoFrontier(o,e,t,a,i),u=h===o.childCount,p=u?d:-1;this.updatePlacedContent(e,l,c),this.closeMatchingParentNode(u,p,n),this.addOpenEndNodes(o,p),this.updateUnplacedContent(r,t,h,u,p)}prepareFrontier(t,e){for(;this.depth>t;)this.closeFrontierNode();if(e)for(const n of e)this.openFrontierNode(n)}fitFragmentIntoFrontier(t,e,n,i,s){let r=0;const o=[];let{match:a}=this.frontier[e];const{type:l}=this.frontier[e];if(s){for(let t=0;t<s.childCount;t++)o.push(s.child(t));a=a.matchFragment(s)}const c=Math.max(-1,t.size+n-(this.unplacedContent.content.size-this.unplacedContent.openEnd));for(;r<t.childCount;){const e=t.child(r),n=a.matchType(e.type);if(!n)break;if(r++,this.shouldIncludeNode(r,i,e)){a=n;const s=1===r?i:0,h=r===t.childCount?c:-1,d=e.mark(l.allowedMarks(e.marks));o.push(this.closeNodeStart(d,s,h))}}return{nodesToAdd:o,match:a,taken:r,openEndCount:c}}closeNodeStart(t,e,n){if(e<=0)return t;let i=t.content;if(e>1){const t=i.firstChild,s=1===i.childCount?n-1:0,r=this.closeNodeStart(t,e-1,s);i=i.replaceChild(0,r)}if(i=t.type.contentMatch.fillBefore(i).append(i),n<=0){const e=t.type.contentMatch.matchFragment(i).fillBefore(Z.empty,!0);i=i.append(e)}return t.copy(i)}shouldIncludeNode(t,e,n){return t>1||0===e||n.content.size>0}updatePlacedContent(t,e,n){this.placedContent=this.addToFragment(this.placedContent,t,Z.from(e)),this.frontier[t].match=n}closeMatchingParentNode(t,e,n){t&&e<0&&n?.type===this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode()}addOpenEndNodes(t,e){let n=t;for(let i=0;i<e;i++){const t=n.lastChild;this.frontier.push({type:t.type,match:t.contentMatchAt(t.childCount)}),n=t.content}}updateUnplacedContent(t,e,n,i,s){if(i)if(0===e)this.unplacedContent=tt.empty;else{const n=s<0?t.openEnd:e-1;this.unplacedContent=new tt(this.dropFromFragment(t.content,e-1,1),e-1,n)}else this.unplacedContent=new tt(this.dropFromFragment(t.content,e,n),t.openStart,t.openEnd)}mustMoveInline(){return this.$to.parent.isTextblock&&this.canMoveInline()?this.findInlineMovePosition():-1}canMoveInline(){const t=this.frontier[this.depth];if(!t.type.isTextblock)return!1;if(!this.contentAfterFits(this.$to,this.$to.depth,t.type,t.match,!1))return!1;if(this.$to.depth===this.depth){const t=this.findCloseLevel(this.$to);if(t?.depth===this.depth)return!1}return!0}contentAfterFits(t,e,n,i,s){const r=t.node(e),o=s?t.indexAfter(e):t.index(e);if(o===r.childCount&&!n.compatibleContent(r.type))return null;const a=i.fillBefore(r.content,!0,o);return a&&!this.invalidMarks(n,r.content,o)?a:null}invalidMarks(t,e,n){for(let i=n;i<e.childCount;i++)if(!t.allowsMarks(e.child(i).marks))return!0;return!1}findInlineMovePosition(){let t=this.$to.depth,e=this.$to.after(t);for(;t>1&&e===this.$to.end(--t);)++e;return e}findCloseLevel(t){for(let e=Math.min(this.depth,t.depth);e>=0;e--){const{match:n,type:i}=this.frontier[e],s=e<t.depth&&t.end(e+1)===t.pos+(t.depth-(e+1)),r=this.contentAfterFits(t,e,i,n,s);if(r&&this.canCloseAtDepth(t,e))return{depth:e,fit:r,move:s?t.doc.resolve(t.after(e+1)):t}}}canCloseAtDepth(t,e){for(let n=e-1;n>=0;n--){const{match:e,type:i}=this.frontier[n],s=this.contentAfterFits(t,n,i,e,!0);if(!s||s.childCount)return!1}return!0}close(t){const e=this.findCloseLevel(t);if(!e)return null;for(;this.depth>e.depth;)this.closeFrontierNode();e.fit.childCount&&(this.placedContent=this.addToFragment(this.placedContent,e.depth,e.fit)),t=e.move;for(let n=e.depth+1;n<=t.depth;n++){const e=t.node(n),i=e.type.contentMatch.fillBefore(e.content,!0,t.index(n));this.openFrontierNode(e.type,e.attrs,i)}return t}openFrontierNode(t,e=null,n){const i=this.frontier[this.depth];i.match=i.match.matchType(t),this.placedContent=this.addToFragment(this.placedContent,this.depth,Z.from(t.create(e,n))),this.frontier.push({type:t,match:t.contentMatch})}closeFrontierNode(){const t=this.frontier.pop().match.fillBefore(Z.empty,!0);t.childCount&&(this.placedContent=this.addToFragment(this.placedContent,this.frontier.length,t))}contentAt(t,e){for(let n=0;n<e;n++){const i=t.firstChild;if(!i)throw new RangeError(`Cannot access depth ${e}, fragment only has depth ${n}`);t=i.content}return t}dropFromFragment(t,e,n){if(0===e)return t.cutByIndex(n,t.childCount);const i=this.dropFromFragment(t.firstChild.content,e-1,n),s=t.firstChild.copy(i);return t.replaceChild(0,s)}addToFragment(t,e,n){if(0===e)return t.append(n);const i=this.addToFragment(t.lastChild.content,e-1,n),s=t.lastChild.copy(i);return t.replaceChild(t.childCount-1,s)}};function ve(t,e,n=e,i=tt.empty){if(e===n&&!i.size)return null;const s=t.resolve(e),r=t.resolve(n);return de(s,r,i)?new Ut(e,n,i):new we(s,r,i).fit()}let Ae=class extends Error{constructor(t){super(t),this.name="TransformError"}},xe=class{_steps=[];_docs=[];_mapping=new ie;_doc;constructor(t){this._doc=t}get doc(){return this._doc}get steps(){return this._steps}get docs(){return this._docs}get mapping(){return this._mapping}get before(){return this._docs.length?this._docs[0]:this._doc}get docChanged(){return this._steps.length>0}step(t){const e=this.maybeStep(t);if(e.failed)throw new Ae(e.failed);return this}maybeStep(t){const e=t.apply(this._doc);return!e.failed&&e.doc&&this.addStep(t,e.doc),e}changedRange(){let t=1e9,e=-1e9;for(let n=0;n<this.mapping.maps.length;n++){const i=this.mapping.maps[n];n&&(t=i.map(t,1),e=i.map(e,-1)),i.forEach((n,i,s,r)=>{t=Math.min(t,s),e=Math.max(e,r)})}return 1e9===t?null:{from:t,to:e}}addStep(t,e){this._docs.push(this._doc),this._steps.push(t),this._mapping.appendMap(t.getMap()),this._doc=e}replace(t,e=t,n=tt.empty){const i=ve(this._doc,t,e,n);return i&&this.step(i),this}replaceWith(t,e,n){return this.replace(t,e,new tt(Z.from(n),0,0))}delete(t,e){return this.replace(t,e,tt.empty)}insert(t,e){return this.replaceWith(t,t,e)}replaceRange(t,e,n){return function(t,e,n,i){if(!i.size)return t.deleteRange(e,n);const s=t.doc.resolve(e),r=t.doc.resolve(n);if(de(s,r,i))return t.step(new Ut(e,n,i));const{targetDepths:o,preferredTarget:a}=function(t,e){const n=le(t,e);0===n[n.length-1]&&n.pop();let i=-(t.depth+1);n.unshift(i);for(let s=t.depth,r=t.pos-1;s>0;s--,r--){const e=t.node(s).type.spec;if(e.defining||e.definingAsContext||e.isolating)break;n.includes(s)?i=s:t.before(s)===r&&n.splice(1,0,-s)}return{targetDepths:n,preferredTarget:i}}(s,r),l=o.indexOf(a),c=function(t){const e=[];let n=t.content;for(let i=0;;i++){const s=n.firstChild;if(e.push(s),i===t.openStart)break;n=s.content}return e}(i);(function(t,e,n,i,s,r,o,a,l){for(let c=s.openStart;c>=0;c--){const h=(c+o+1)%(s.openStart+1),d=r[h];if(!d)continue;const u=me(t,e,n,i,s,d,h,a,l);if(u)return u}return null})(t,s,r,n,i,c,function(t,e,n,i){let s=t.openStart;for(let r=s-1;r>=0;r--){const t=e[r],o=ge(t.type);if(o&&!t.sameMarkup(n.node(Math.abs(i)-1)))s=r;else if(o||!t.type.isTextblock)break}return s}(i,c,s,a),o,l)||function(t,e,n,i,s,r,o){const a=t.steps.length;for(let l=o.length-1;l>=0&&(t.replace(i,s,r),!(t.steps.length>a));l--){const t=o[l];t<0||(i=e.before(t),s=n.after(t))}}(t,s,r,e,n,i,o)}(this,t,e,n),this}replaceRangeWith(t,e,n){return function(t,e,n,i){if(!i.isInline&&e===n&&t.doc.resolve(e).parent.content.size){const s=function(t,e,n){const i=t.resolve(e);return i.parent.canReplaceWith(i.index(),i.index(),n)?e:0===i.parentOffset?be(i,n,"start"):i.parentOffset===i.parent.content.size?be(i,n,"end"):null}(t.doc,e,i.type);null!==s&&(e=n=s)}t.replaceRange(e,n,new tt(Z.from(i),0,0))}(this,t,e,n),this}deleteRange(t,e){return function(t,e,n){const i=t.doc.resolve(e),s=t.doc.resolve(n),r=function(t,e,n,i){for(let s=0;s<i.length;s++){const r=i[s],o=s===i.length-1;if(pe(e,r,o))return t.delete(e.start(r),n.end(r));if(fe(e,n,r,o))return t.delete(e.before(r),n.after(r))}return null}(t,i,s,le(i,s));r||(function(t,e,n,i,s){for(let r=1;r<=e.depth&&r<=n.depth;r++)if(ue(e,n,i,s,r))return t.delete(e.before(r),s);return null}(t,i,s,e,n)||t.delete(e,n))}(this,t,e),this}lift(t,e){return function(t,e,n){const{$from:i,$to:s,depth:r}=e,o=i.before(r+1),a=s.after(r+1),{fragment:l,openLevels:c,adjustedStart:h}=ne(i,r,n,o,"start"),{fragment:d,openLevels:u,adjustedEnd:p}=ne(s,r,n,a,"end"),f=new tt(l.append(d),c,u);t.step(new ee(h,p,o,a,f,l.size-c,!0))}(this,t,e),this}join(t,e=1){return function(t,e,n){let i=null;const{linebreakReplacement:s}=t.doc.type.schema,r=t.doc.resolve(e-n),o=r.node().type;if(s&&o.inlineContent){const t="pre"===o.whitespace,e=!U(o.contentMatch.matchType(s));t&&!e?i=!1:!t&&e&&(i=!0)}const a=t.steps.length;if(!i){const i=t.doc.resolve(e+n);Xt(t,i.node(),i.before(),a)}o.inlineContent&&te(t,e+n-1,o,r.node().contentMatchAt(r.index()),U(i));const l=t.mapping.slice(a),c=l.map(e-n);if(t.step(new Ut(c,l.map(e+n,-1),tt.empty,!0)),i){const e=t.doc.resolve(c);Yt(t,e.node(),e.before(),t.steps.length)}}(this,t,e),this}wrap(t,e){return function(t,e,n){let i=Z.empty;for(let o=n.length-1;o>=0;o--){const t=n[o];if(i.size){const e=t.type.contentMatch.matchFragment(i);if(!e?.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}i=Z.from(t.type.create(t.attrs,i))}const s=e.start,r=e.end;t.step(new ee(s,r,s,r,new tt(i,0,0),n.length,!0))}(this,t,e),this}setBlockType(t,e=t,n,i=null){return function(t,e,n,i,s){if(!i.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");const r=[];let o=!1;t.doc.nodesBetween(e,n,(e,n)=>{let a;if(a="function"==typeof s?s(e):s,e.isTextblock&&!e.hasMarkup(i,a)&&function(t,e,n){const i=t.resolve(e),s=i.index();return i.parent.canReplaceWith(s,s+1,n)}(t.doc,n,i)){let t=null;if(i.schema.linebreakReplacement){const e="pre"===i.whitespace,n=!U(i.contentMatch.matchType(i.schema.linebreakReplacement));e&&!n?t=!1:!e&&n&&(t=!0)}const s=function(t,e){let n=!1;return t.forEach(t=>{for(const i of t.marks)if(!e.allowsMarkType(i.type))return n=!0,!1;if(n)return!1}),n}(e,i),l=!i.validContent(e.content),c="pre"!==i.whitespace&&function(t){let e=!1;return t.forEach(t=>t.isText&&t.text&&/[\r\n]/.test(t.text)?(e=!0,!1):!e&&void 0),e}(e),h=null!==t||s||l||c;return h&&(o=!0),r.push({pos:n,node:e,attrs:a,needsLinebreakConversion:t,needsComplexHandling:h}),!1}return!0}),0!==r.length&&(o?function(t,e,n){const i=t.steps.length;for(const s of e){const{pos:e,node:r,attrs:o,needsLinebreakConversion:a}=s;a||Xt(t,r,e,i),te(t,t.mapping.slice(i).map(e,1),n,void 0,U(a));const l=t.mapping.slice(i),c=l.map(e,1),h=l.map(e+r.nodeSize,1);t.step(new ee(c,h,c+1,h-1,new tt(Z.from(n.create(o,null,r.marks)),0,0),1,!0)),a&&Yt(t,r,e,i)}}(t,r,i):function(t,e,n){for(let i=e.length-1;i>=0;i--){const s=e[i],{pos:r,node:o,attrs:a}=s;t.step(new ee(r,r+o.nodeSize,r+1,r+o.nodeSize-1,new tt(Z.from(n.create(a,null,o.marks)),0,0),1,!0))}}(t,r,i))}(this,t,e,n,i),this}setNodeMarkup(t,e,n=null,i){return function(t,e,n,i,s){const r=t.doc.nodeAt(e);if(!r)throw new RangeError("No node at given position");const o=n||r.type,a=s||r.marks,l=o.create(i,null,a);if(r.isLeaf)t.replaceWith(e,e+r.nodeSize,l);else{if(!o.validContent(r.content))throw new RangeError(`Invalid content for node type ${o.name}`);t.step(new ee(e,e+r.nodeSize,e+1,e+r.nodeSize-1,new tt(Z.from(l),0,0),1,!0))}}(this,t,e,n,i),this}setNodeAttribute(t,e,n){return this.step(new se(t,e,n)),this}setDocAttribute(t,e){return this.step(new re(t,e)),this}addNodeMark(t,e){if(!this._doc.nodeAt(t))throw new RangeError(`No node at position ${t.toString()}`);return this.step(new Gt(t,e)),this}removeNodeMark(t,e){const n=this._doc.nodeAt(t);if(!n)throw new RangeError(`No node at position ${t.toString()}`);if(Q.isMark(e))e.isInSet(n.marks)&&this.step(new jt(t,e));else{let i=n.marks;const s=[];let r=e.isInSet(i);for(;r;)s.push(new jt(t,r)),i=r.removeFromSet(i),r=e.isInSet(i);for(let t=s.length-1;t>=0;t--)this.step(s[t])}return this}split(t,e=1,n){return function(t,e,n=1,i){const s=t.doc.resolve(e);let r=Z.empty,o=Z.empty;const a=s.depth,l=a-n;let c=n-1;for(let d=a;d>l;d--,c--){r=Z.from(s.node(d).copy(r));const t=i?.[c];o=Z.from(t?t.type.create(t.attrs,o):s.node(d).copy(o))}const h=new tt(r.append(o),n,n);t.step(new Ut(e,e,h,!0))}(this,t,e,n),this}addMark(t,e,n){return function(t,e,n,i){if(e>n)throw new RangeError(`Invalid range: from (${e}) cannot be greater than to (${n})`);if(e===n)return;const s=[],r=[];let o,a;t.doc.nodesBetween(e,n,(t,l,c)=>{if(!t.isInline)return;const h=t.marks;if(i.isInSet(h)||!c.type.allowsMarkType(i.type))return;const d=Math.max(l,e),u=Math.min(l+t.nodeSize,n),p=i.addToSet(h);o=function(t,e,n,i,s,r){let o=s;for(const a of t)a.isInSet(e)||(o?.to===n&&o.mark.eq(a)?o.to=i:(o=new qt(n,i,a),r.push(o)));return o}(h,p,d,u,o,s),a=function(t,e,n,i,s){if(i?.to===e)return i.to=n,i;{const i=new Wt(e,n,t);return s.push(i),i}}(i,d,u,a,r)}),s.forEach(e=>t.step(e)),r.forEach(e=>t.step(e))}(this,t,e,n),this}removeMark(t,e,n){return oe(this,t,e,n),this}clearIncompatible(t,e,n){return te(this,t,e,n),this}};function Se(t,e,n){const i=t.resolve(e);if(!n.content.size)return e;const s=function(t){let e=t.content;for(let n=0;n<t.openStart&&e.firstChild;n++)e=e.firstChild.content;return e}(n),r=0===n.openStart&&n.size>0?2:1;for(let o=1;o<=r;o++){const t=_e(i,s,1===o);if(null!==t)return t}return null}function _e(t,e,n){for(let i=t.depth;i>=0;i--){const s=Te(t,i),r=t.index(i)+(s>0?1:0),o=t.node(i);if(n?Ee(o,r,e):Ce(o,r,e))return Me(t,i,s)}return null}function Te(t,e){if(e===t.depth)return 0;const n=(t.start(e+1)+t.end(e+1))/2;return t.pos<=n?-1:1}function Ee(t,e,n){return t.canReplace(e,e,n)}function Ce(t,e,n){if(!n.firstChild)return!1;const i=t.contentMatchAt(e).findWrapping(n.firstChild.type);return null!==i&&t.canReplaceWith(e,e,i[0])}function Me(t,e,n){return 0===n?t.pos:n<0?t.before(e+1):t.after(e+1)}function ke(t,e,n=null,i=t){const s=function(t,e){const{parent:n,startIndex:i,endIndex:s}=t,r=n.contentMatchAt(i).findWrapping(e);if(!r)return null;const o=r.length?r[0]:e;return n.canReplaceWith(i,s,o)?r:null}(t,e);if(!s)return null;const r=function(t,e){const{parent:n,startIndex:i,endIndex:s}=t,r=n.child(i),o=e.contentMatch.findWrapping(r.type);if(!o)return null;let a=(o.length?o[o.length-1]:e).contentMatch;for(let l=i;a&&l<s;l++)a=a.matchType(n.child(l).type);return a?.validEnd?o:null}(i,e);return r?[...s.map(De),{type:e,attrs:n},...r.map(De)]:null}function De(t){return{type:t,attrs:null}}function Ie(t){const e=t.parent.content.cutByIndex(t.startIndex,t.endIndex);let n=!1,i=!1;for(let s=t.depth;s>=0;s--){const r=t.$from.node(s),o=t.$from.index(s)+(n?1:0),a=t.$to.indexAfter(s)-(i?1:0);if(s<t.depth&&r.canReplace(o,a,e))return s;if(0===s||r.type.spec.isolating||!Ne(r,o,a))break;o>0&&(n=!0),a<r.childCount&&(i=!0)}return null}function Ne(t,e,n){const i=0===e||t.canReplace(e,t.childCount),s=n===t.childCount||t.canReplace(0,n);return i&&s}var Pe=Object.defineProperty,Oe=(t,e,n)=>{return r=n,(s="symbol"!=typeof e?e+"":e)in(i=t)?Pe(i,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[s]=r;var i,s,r};let Re=(t=21)=>{let e="",n=crypto.getRandomValues(new Uint8Array(t|=0));for(;t--;)e+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[t]];return e},Be=class t{static KEYS=new Map;createKey(e){const n=(t.KEYS.get(e)??-1)+1;return t.KEYS.set(e,n),`${e}$${n}`}},Fe=class extends Be{pluginKey;pluginProps={};pluginSpec;constructor(t){super(),this.pluginSpec=t,t.props&&this.bindProps(t.props,this,this.pluginProps),this.pluginKey=t.key?t.key.key:this.createKey("plugin")}get props(){return this.pluginProps}get key(){return this.pluginKey}get spec(){return this.pluginSpec}getState(t){if(We.isEditorState(t))return t.getFieldPluginValue(this.pluginKey);const e=t;return e.fieldData?e.fieldData instanceof Map?e.fieldData.get(this.pluginKey):e.fieldData[this.pluginKey]:t}bindProps(t,e,n){for(const i in t){const s=t[i];n[i]=this.bindPropValue(i,s,e)}return n}bindPropValue(t,e,n){return"function"==typeof e?e.bind(n):"handleDOMEvents"===t&&this.isPlainObject(e)?this.bindProps(e,n,{}):e}isPlainObject(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}},Le=class{from;to;constructor(t,e){this.from=t,this.to=e}get $from(){return this.from}get $to(){return this.to}};var ze,Ve=((ze=Ve||{}).TEXT="text",ze.NODE="node",ze.ALL="all",ze.BASE="base",ze.CUSTOM="custom",ze);let He=class t{static JSON_DESERIALIZERS=new Map;static TextSelectionHandler;static NodeSelectionHandler;static AllSelectionHandler;static registerTextSelectionHandler(e){t.TextSelectionHandler=e}static registerNodeSelectionHandler(e){t.NodeSelectionHandler=e}static registerAllSelectionHandler(e){t.AllSelectionHandler=e}static jsonID(e,n){t.registerJsonDeserializerClass(e,n)}static registerJsonDeserializerClass(e,n){t.JSON_DESERIALIZERS.set(e,n)}selectionRanges;anchorPos;headPos;isVisible=!0;constructor(t,e,n){this.anchorPos=t,this.headPos=e,this.selectionRanges=n??[new Le(t.min(e),t.max(e))]}get type(){return Ve.BASE}get $cursor(){return null}get node(){return null}get ranges(){return this.selectionRanges}get $anchor(){return this.anchorPos}get $head(){return this.headPos}get anchor(){return this.anchorPos.pos}get head(){return this.headPos.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){if(0===this.selectionRanges.length)throw new Error("Selection has no ranges");return this.selectionRanges[0].$from}get $to(){if(0===this.selectionRanges.length)throw new Error("Selection has no ranges");return this.selectionRanges[0].$to}get empty(){return!this.selectionRanges.some(t=>t.$from.pos!==t.$to.pos)}get visible(){return this.isVisible}set visible(t){this.isVisible=t}static near(e,n=1){return this.findFrom(e,n)||this.findFrom(e,-n)||t.AllSelectionHandler(e.node(0))}static atStart(e){return t.findSelectionIn(e,e,0,0,1)||t.AllSelectionHandler(e)}static atEnd(e){return t.findSelectionIn(e,e,e.content.size,e.childCount,-1)||t.AllSelectionHandler(e)}static findFrom(e,n,i=!1){const s=t.findSelectionIn(e.node(0),e.parent,e.pos,e.index(),n,i);if(s)return s;for(let r=e.depth-1;r>=0;r--){const s=n<0?t.findSelectionIn(e.node(0),e.node(r),e.before(r+1),e.index(r),n,i):t.findSelectionIn(e.node(0),e.node(r),e.after(r+1),e.index(r)+1,n,i);if(s)return s}return null}static isNodeSelectable(t){return!t.isText&&!j(t.type.spec.selectable)}static fromJSON(e,n){if(!n?.type)throw new RangeError("Invalid input for Selection.fromJSON");const i=n.type,s=t.JSON_DESERIALIZERS.get(i);if(s)return s.fromJSON(e,n);throw new RangeError(`No selection type ${n.type} defined`)}static between(e,n,i){return t.textSelectionBetween(e,n,i)}static textSelectionBetween(e,n,i){const s=e.pos-n.pos;if(i&&!s||(i=s>=0?1:-1),!n.parent.inlineContent){const e=t.findFrom(n,i,!0)||t.findFrom(n,-i,!0);if(!e)return t.near(n,i);n=e.$head}if(!e.parent.inlineContent)if(0===s)e=n;else{const r=t.findFrom(e,-i,!0)||t.findFrom(e,i,!0);r?(e=r.$anchor).pos<n.pos!=s<0&&(e=n):e=n}return t.TextSelectionHandler(e,n)}static findSelectionIn(e,n,i,s,r,o=!1){return n.inlineContent?t.TextSelectionHandler(e,i):-1===r?this.scanBackward(e,n,i,s,r,o):this.scanForward(e,n,i,s,r,o)}static scanBackward(e,n,i,s,r,o){for(let a=s-1;a>=0;a--){const s=n.child(a);if(s.isAtom){if(!o&&t.isNodeSelectable(s))return t.NodeSelectionHandler(e,i-s.nodeSize)}else{const n=t.findSelectionIn(e,s,i-1,s.childCount,r,o);if(n)return n}i-=s.nodeSize}return null}static scanForward(e,n,i,s,r,o){for(let a=s;a<n.childCount;a++){const s=n.child(a);if(s.isAtom){if(!o&&t.isNodeSelectable(s))return t.NodeSelectionHandler(e,i)}else{const n=t.findSelectionIn(e,s,i+1,0,r,o);if(n)return n}i+=s.nodeSize}return null}isTextSelection(){return this.type===Ve.TEXT.valueOf()}isNodeSelection(){return this.type===Ve.NODE.valueOf()}isAllSelection(){return this.type===Ve.ALL.valueOf()}content(){return this.$from.doc.slice(this.from,this.to,!0)}eq(t){return!1}getBookmark(){return null}map(e,n){if(this.type===Ve.TEXT.valueOf()){const i=e.resolve(n.map(this.head));if(!i.parent.inlineContent)return t.near(i);const s=e.resolve(n.map(this.anchor));return t.TextSelectionHandler(s.parent.inlineContent?s:i,i)}if(this.type===Ve.NODE.valueOf()){const{deleted:i,pos:s}=n.mapResult(this.anchor),r=e.resolve(s);return i?t.near(r):t.NodeSelectionHandler(r)}return t.AllSelectionHandler(e)}replace(t,e=tt.empty){if(this.type===Ve.ALL.valueOf()&&e===tt.empty)return void this.replaceSelectionAll(t);const n=this.getInsertionBias(e);this.replaceRanges(t,e,n),this.type===Ve.TEXT.valueOf()&&e===tt.empty&&this.preserveMarksTextSelection(t)}getInsertionBias(t){let e=t.content.lastChild;if(!e)return 1;let n=null;for(let i=0;i<t.openEnd&&(n=e,e=e.lastChild,e);i++);return(e?e.isInline:n?.isTextblock)?-1:1}replaceRanges(t,e,n){const i=t.steps.length,s=this.ranges;for(let r=0;r<s.length;r++){const{$from:o,$to:a}=s[r],l=t.mapping.slice(i);t.replaceRange(l.map(o.pos),l.map(a.pos),r?tt.empty:e),0===r&&this.selectionToInsertionEnd(t,i,n)}}replaceWith(t,e){const n=t.steps.length,i=this.ranges;for(let s=0;s<i.length;s++){const{$from:r,$to:o}=i[s],a=t.mapping.slice(n),l=a.map(r.pos),c=a.map(o.pos);s?t.deleteRange(l,c):(t.replaceRangeWith(l,c,e),this.selectionToInsertionEnd(t,n,e.isInline?-1:1))}}toJSON(){return{type:this.type}}replaceSelectionAll(e){e.delete(0,e.doc.content.size);const n=t.atStart(e.doc);n.eq(e.selection)||e.setSelection(n)}preserveMarksTextSelection(t){const e=this.$from.marksAcross(this.$to);e?.length&&t.ensureMarks(e)}selectionToInsertionEnd(e,n,i){const s=e.steps.length-1;if(s<n)return;const r=e.steps[s];if(!(r instanceof Ut||r instanceof ee))return;let o;e.mapping.maps[s].forEach((t,e,n,i)=>{U(o)&&(o=i)}),e.setSelection(t.near(e.doc.resolve(o),i))}},$e=class extends xe{timestamp;curSelection;curSelectionFor=0;updated=0;meta=new Map;_storedMarks;constructor(t){super(t.doc),this.timestamp=Date.now(),this.curSelection=t.selection,this._storedMarks=t.storedMarks}get storedMarks(){return this._storedMarks}get time(){return this.timestamp}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this._doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}get selectionSet(){return(1&this.updated)>0}get storedMarksSet(){return(2&this.updated)>0}get isGeneric(){return 0===this.meta.size}get scrolledIntoView(){return(4&this.updated)>0}setSelection(t){if(t.$from.doc!==this._doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=t,this.curSelectionFor=this.steps.length,this.updated=-3&this.updated|1,this._storedMarks=null,this}getUpdated(){return this.updated}setUpdated(t){this.updated=t}ensureMarks(t){return Q.sameSet(this._storedMarks||this.selection.$from.marks(),t)||this.setStoredMarks(t),this}addStoredMark(t){const e=t.addToSet(this._storedMarks||this.selection.$from.marks());return this.ensureMarks(e)}removeStoredMark(t){const e=t.removeFromSet(this._storedMarks||this.selection.$from.marks());return this.ensureMarks(e)}addStep(t,e){super.addStep(t,e),this.updated=-3&this.updated,this._storedMarks=null}setTime(t){return this.timestamp=t,this}replaceSelection(t){return this.selection.replace(this,t),this}replaceSelectionWith(t,e=!0){const n=this.selection;if(e){let e;e=this._storedMarks?this._storedMarks:n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||Q.none,t=t.mark(e)}return n.replaceWith(this,t),this}deleteSelection(){return this.selection.replace(this),this}insertText(t,e,n){const i=this._doc.type.schema;if(U(e))return t?this.replaceSelectionWith(i.text(t),!0):this.deleteSelection();{if(n??=e,!t)return this.deleteRange(e,n);let s=this._storedMarks;if(!s){const t=this._doc.resolve(e);s=n===e?t.marks():t.marksAcross(this._doc.resolve(n))||Q.none}this.replaceRangeWith(e,n,i.text(t,s));const r=e+t.length;return!this.selection.empty&&this.selection.from<r&&this.selection.to<=r&&this.setSelection(He.near(this._doc.resolve(r))),this}}setMeta(t,e){return this.meta.set("string"==typeof t?t:t.key,e),this}getMeta(t){return this.meta.get("string"==typeof t?t:t.key)}scrollIntoView(){return this.updated|=4,this}setStoredMarks(t){return this._storedMarks=t,this.updated|=2,this}},Ue=class{fieldName;initFunc;applyFunc;constructor(t,e,n){if(this.fieldName=t,!e||"function"!=typeof e.init||"function"!=typeof e.apply)throw new TypeError(`StateField for "${t}" must provide "init" and "apply" functions`);const{initFunc:i,applyFunc:s}=this.initFieldDesc(e,n);this.initFunc=i,this.applyFunc=s}get name(){return this.fieldName}init(t,e){return this.initFunc(t,e)}apply(t,e,n,i){return this.applyFunc(t,e,n,i)}initFieldDesc(t,e){return e?{initFunc:t.init.bind(e),applyFunc:t.apply.bind(e)}:{initFunc:t.init,applyFunc:t.apply}}},We=class t{config;fieldData=new Map;_doc;_selection;_storedMarks;_scrollToSelection;constructor(t,e,n=!1){if(this.config=t,!e)throw new RangeError("EditorState constructor requires editorStateDto");if(e.fieldData&&e.fieldData.forEach((t,e)=>{this.fieldData.set(e,t)}),n){if(!e.transaction)throw new RangeError("EditorState constructor with UPDATE type requires transaction in editorStateDto");const t=e.transaction;this._doc=t.doc||e.doc,this._selection=t.selection||e.selection,this._storedMarks=this._selection.$cursor?t.storedMarks:e.storedMarks,this._scrollToSelection=t.scrolledIntoView?e.scrollToSelection+1:e.scrollToSelection,this.updateFields(e)}else this._doc=e.doc||this.config.schema.topNodeType.createAndFill({id:Re()}),this._selection=e.selection||He.atStart(this._doc),this._storedMarks=e.storedMarks??null,this._scrollToSelection=e.scrollToSelection??0,this.initializeFields()}get type(){return"EditorState"}get doc(){return this._doc}get selection(){return this._selection}get scrollToSelection(){return this._scrollToSelection}get storedMarks(){return this._storedMarks}get schema(){return this.config.schema}get plugins(){return this.config.plugins}get transaction(){return new $e(this)}get tr(){return this.transaction}static fromJSON(e,n,i){if(!n)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");const s=t.createConfig(e.schema,e.plugins),r=n.doc?bt.fromJSON(e.schema,n.doc):void 0,o={doc:r,selection:n.selection&&r?He.fromJSON(r,n.selection):void 0,storedMarks:n.storedMarks?n.storedMarks.map(e.schema.markFromJSON):void 0,scrollToSelection:n.scrollToSelection??0,fieldData:new Map},a=new t(s,o);if(i&&"object"==typeof i){const s={doc:o.doc,selection:o.selection,storedMarks:o.storedMarks,schema:e.schema};t.readFieldPluginValueFromJSON(i,n,a,s)}return a}static create(e){const n=e.doc?e.doc.type.schema:e.schema,i={doc:e.doc,selection:e.selection,storedMarks:e.storedMarks,scrollToSelection:0,fieldData:new Map},s=e.plugins;return new t(t.createConfig(n,s),i)}static createConfig(t,e){const n=new Array,i=[],s=new Map;return e&&e.forEach(t=>{i.push(t),s.set(t.key,t),t.spec.state&&n.push(new Ue(t.key,t.spec.state,t))}),{schema:t,fields:n,plugins:i,pluginsMap:s}}static isEditorState(t){return!(!t||"object"!=typeof t)&&"EditorState"===t.type}static readFieldPluginValueFromJSON(t,e,n,i){if(t&&"object"==typeof t)for(const s in t){const r=t[s],o=r.key;if(n.config.fields.find(t=>t.name===o)&&void 0!==e[s]){const t=e[s];let a;a=r.spec.state?.fromJSON?r.spec.state.fromJSON(i,t,n):"string"==typeof t?JSON.parse(t):t,n.fieldData.set(o,a)}}}getPlugin(t){return this.config.pluginsMap.get(t)}getFieldPluginValue(t){return this.fieldData.get(t)}apply(t){return this.applyTransaction(t).state}applyTransaction(t){if(!this.filterTransaction(t))return{state:this,transactions:[]};const e=[t];let n=this.applyInner(t);const i=new Map;for(;this.executePluginsAppendTransactions(e,n,i,t);)n=i.get(this.plugins.length-1)?.state||n;return i.size>0&&(n=i.get(this.plugins.length-1)?.state||n),{state:n,transactions:e}}reconfigure(e){const n={...this.cloneState(),fieldData:new Map};return new t(t.createConfig(this.schema,e.plugins),n)}toJSON(t,e=!1){if(e)return{doc:this._doc.toJSON()};{const e={doc:this._doc.toJSON(),selection:this._selection.toJSON()};if(e.storedMarks=this.storedMarks?.map(t=>t.toJSON()),t&&"object"==typeof t)for(const n in t){const i=t[n].key;if(this.fieldData.has(i)){const t=this.fieldData.get(i);e[n]="number"==typeof t?t:JSON.stringify(t)}}return e}}executePluginsAppendTransactions(t,e,n,i){let s=!1;for(let r=0;r<this.plugins.length;r++){const o=this.plugins[r];if(!o.spec.appendTransaction){n.set(r,{state:e,processedTransactions:t.length});continue}const a=n.get(r),l=a?.processedTransactions??0,c=a?.state??this,h=this.tryAppendPluginTransaction(o,t,l,c,e,r,i);h&&(t.push(h),e=e.applyInner(h),s=!0),n.set(r,{state:e,processedTransactions:t.length})}return s}tryAppendPluginTransaction(t,e,n,i,s,r,o){if(n>=e.length||!t.spec.appendTransaction)return null;const a=n>0?e.slice(n):e,l=t.spec.appendTransaction.call(t,a,i,s);return l&&s.filterTransaction(l,r)?(l.setMeta("appendedTransaction",o),l):null}filterTransaction(t,e=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!==e){const e=this.config.plugins[n];if(e.spec.filterTransaction&&!e.spec.filterTransaction.call(e,t,this))return!1}return!0}applyInner(e){if(!e.before.eq(this._doc))throw new RangeError("Applying a mismatched transaction");const n={...this.cloneState(),transaction:e,oldState:this};return new t(this.config,n,!0)}cloneState(){return{doc:this._doc,selection:this._selection,storedMarks:this._storedMarks,scrollToSelection:this._scrollToSelection,fieldData:new Map(this.fieldData)}}initializeFields(){if(!this.config.fields?.length)return;const t={...this.cloneState(),schema:this.config.schema};for(const e of this.config.fields){const n=e.init(t,this);this.setFieldValue(n,e.name)}}updateFields(t){if(this.config.fields?.length)for(const e of this.config.fields){const n=t.fieldData.get(e.name),i=e.apply(t.transaction,n,t.oldState||this,this);this.setFieldValue(i,e.name)}}setFieldValue(t,e){void 0!==t&&this.fieldData.set(e,t)}},Ge=class extends Be{pluginKey;constructor(t="key"){super(),this.pluginKey=this.createKey(t)}get key(){return this.pluginKey}get(t){if(We.isEditorState(t))return t.getPlugin(this.pluginKey);const e=t;return e.config&&e.config.pluginsMap instanceof Map?e.config.pluginsMap.get(this.pluginKey):void 0}getState(t){if(We.isEditorState(t))return t.getFieldPluginValue(this.pluginKey);const e=t;return e.fieldData?e.fieldData instanceof Map?e.fieldData.get(this.pluginKey):e.fieldData[this.pluginKey]:t}},je=class t{anchor;head;constructor(t,e){this.anchor=t,this.head=e}map(e){return new t(e.map(this.anchor),e.map(this.head))}resolve(t){return He.textSelectionBetween(t.resolve(this.anchor),t.resolve(this.head))}},Ke=class t{anchor;constructor(t){this.anchor=t}map(e){const{deleted:n,pos:i}=e.mapResult(this.anchor);return n?new je(i,i):new t(i)}resolve(t){const e=t.resolve(this.anchor),n=e.nodeAfter;return n&&He.isNodeSelectable(n)?Qe.createNodeSelection(e):He.near(e)}};const qe=class t extends He{selectedNode;constructor(t){const e=t.nodeAfter;if(!e)throw new RangeError("Cannot create NodeSelection: no node after the given position");const n=t.node(0);super(t,n.resolve(t.pos+e.nodeSize)),this.selectedNode=e,this.isVisible=!1}get type(){return Ve.NODE}get node(){return this.selectedNode}static fromJSON(e,n){if("number"!=typeof n.anchor)throw new RangeError("Invalid input for NodeSelection.fromJSON");return new t(e.resolve(n.anchor))}content(){return new tt(Z.from(this.selectedNode),0,0)}eq(e){return e instanceof t&&e.anchor===this.anchor}toJSON(){return{type:t.TYPE_NODE_SELECTION,anchor:this.anchor}}getBookmark(){return new Ke(this.anchor)}static create(e,n){return new t(void 0===n?e:e.resolve(n))}};He.registerNodeSelectionHandler((t,e)=>"number"==typeof e?qe.create(t,e):qe.create(t)),He.registerJsonDeserializerClass(Ve.NODE.valueOf(),qe),Oe(qe,"TYPE_NODE_SELECTION","node");let Ye=qe;const Xe=class t extends He{constructor(t,e=t){super(t,e),this.validateTextSelection(t),this.validateTextSelection(e)}get type(){return Ve.TEXT}get $cursor(){return this.anchorPos.pos===this.headPos.pos?this.headPos:null}static fromJSON(e,n){if("number"!=typeof n.anchor||"number"!=typeof n.head)throw new RangeError("Invalid input for TextSelection.fromJSON");return new t(e.resolve(n.anchor),e.resolve(n.head))}static from(t,e,n=e){const i=t.resolve(e);return new this(i,n===e?i:t.resolve(n))}validateTextSelection(t){t.parent.inlineContent}eq(e){return e instanceof t&&e.anchor===this.anchor&&e.head===this.head}getBookmark(){return new je(this.anchor,this.head)}toJSON(){return{type:t.TYPE_TEXT_SELECTION,anchor:this.anchor,head:this.head}}static create(e,n,i){if(wt.isNode(e)){const s=e,r="number"==typeof n?n:0,o=U(i)?r:i,a=s.resolve(r),l=s.resolve(o);return new t(a,l)}return new t(e,n??e)}};He.registerTextSelectionHandler((t,e,n)=>{if(wt.isNode(t)){const i=t,s="number"==typeof e?e:0,r=U(n)?s:n;return Xe.create(i,s,r)}{const n=t;return Xe.create(n,U(e)?n:e)}}),He.registerJsonDeserializerClass(Ve.TEXT.valueOf(),Xe),Oe(Xe,"TYPE_TEXT_SELECTION","text");let Je=Xe,Qe=class{static createAllSelection(t){return en.createAllSelection(t)}static createNodeSelection(t,e){return void 0!==e?Ye.create(t,e):Ye.create(t)}static createTextSelection(t,e,n){return"number"==typeof e?Je.create(t,e,n):Je.create(t,e)}},Ze=class{map(){return this}resolve(t){return Qe.createAllSelection(t)}};const tn=class t extends He{constructor(t){super(t.resolve(0),t.resolve(t.content.size))}get type(){return Ve.ALL}static fromJSON(e){return new t(e)}toJSON(){return{type:t.TYPE_ALL_SELECTION}}eq(e){return e instanceof t}getBookmark(){return new Ze}static createAllSelection(e){return new t(e)}};He.registerAllSelectionHandler(t=>new tn(t)),He.registerJsonDeserializerClass(Ve.ALL.valueOf(),tn),Oe(tn,"TYPE_ALL_SELECTION","all");let en=tn;function nn(t,e){const{$from:n}=t,i=function(t){const{$from:e,$to:n}=t;if(e.sameParent(n))return{position:e.depth>0?gt.resolve(e.doc,e.before()):gt.resolve(e.doc,0),node:e.parent};for(let i=Math.min(e.depth,n.depth);i>=0;i--){const t=e.node(i);if(t===n.node(i))return{position:i>0?gt.resolve(e.doc,e.before(i)):gt.resolve(e.doc,0),node:t}}return null}(t);if(i&&e(i.node))return i;for(let s=n.depth;s>0;s--){const t=n.node(s);if(e(t))return{position:gt.resolve(n.doc,n.before(s)),node:t}}return null}function sn(t,e,n){const i=nn(t.selection,t=>{if(t.type!==e)return!1;if(U(n))return!0;for(const e of Object.keys(n))if(String(t.attrs[e])!==String(n[e]))return!1;return!0});return!U(i)}const rn={doc:{topNode:!0,content:"block+",attrs:{id:{default:null,excludeFromMarkupComparison:!0},version:{default:null,excludeFromMarkupComparison:!0},preVersion:{default:null,excludeFromMarkupComparison:!0}},parseDOM:[{tag:"main[data-pmroot]",getAttrs:t=>({id:t.dataset.pmid,version:t.dataset.pmversion,preVersion:t.dataset.pmversion})}],toDOM:t=>["main",{"data-pmroot":"true","data-pmversion":t.attrs.version??null,"data-pmprevision":t.attrs.preVersion??null,"data-pmid":t.attrs.id},0]},paragraph:{attrs:{id:{default:null,excludeFromMarkupComparison:!0},align:{default:null,validate:t=>{if(t&&"left"!==t&&"right"!==t&&"justify"!==t&&"center"!==t)throw new Error("Unsupported value for text-align")}}},content:"inline*",group:"block",parseDOM:[{tag:"p",getAttrs:t=>({align:t.style.textAlign||null,id:t.dataset.pmid})}],toDOM:t=>["p",{style:t.attrs.align?`text-align:${t.attrs.align};`:null,"data-pmid":t.attrs.id},0]},blockquote:{attrs:{id:{default:null,excludeFromMarkupComparison:!0}},content:"block+",group:"block",defining:!0,parseDOM:[{tag:"blockquote",getAttrs:t=>({id:t.dataset.pmid})}],toDOM:t=>["blockquote",{"data-pmid":t.attrs.id},0]},horizontal_rule:{attrs:{id:{default:null,excludeFromMarkupComparison:!0}},group:"block",parseDOM:[{tag:"hr",getAttrs:t=>({id:t.dataset.pmid})}],toDOM:t=>["hr",{"data-pmid":t.attrs.id},0]},heading:{attrs:{id:{default:null,excludeFromMarkupComparison:!0},align:{default:null,validate:t=>{if(t&&"left"!==t&&"right"!==t&&"justify"!==t&&"center"!==t)throw new Error("Unsupported value for text-align")}},level:{default:1,validate:"number"}},content:"inline*",marks:"link",group:"block",defining:!0,parseDOM:[{tag:"h1",getAttrs:t=>({level:1,align:t.style.textAlign||null,id:t.dataset.pmid})},{tag:"h2",getAttrs:t=>({level:2,align:t.style.textAlign||null,id:t.dataset.pmid})},{tag:"h3",getAttrs:t=>({level:3,align:t.style.textAlign||null,id:t.dataset.pmid})},{tag:"h4",getAttrs:t=>({level:4,align:t.style.textAlign||null,id:t.dataset.pmid})},{tag:"h5",getAttrs:t=>({level:5,align:t.style.textAlign||null,id:t.dataset.pmid})},{tag:"h6",getAttrs:t=>({level:6,align:t.style.textAlign||null,id:t.dataset.pmid})}],toDOM:t=>[`h${t.attrs.level}`,{style:t.attrs.align?`text-align:${t.attrs.align};`:null,"data-pmid":t.attrs.id},0]},code_block:{attrs:{id:{default:null,excludeFromMarkupComparison:!0}},content:"text*",marks:"code",group:"block",code:!0,defining:!0,parseDOM:[{tag:"pre",preserveWhitespace:"full",getAttrs:t=>({id:t.dataset.pmid})}],toDOM:t=>["pre",{"data-pmid":t.attrs.id},0]},figure:{attrs:{id:{default:null,excludeFromMarkupComparison:!0},align:{default:null,validate:t=>{if(t&&"left"!==t&&"right"!==t&&"justify"!==t&&"center"!==t)throw new Error("Unsupported value for text-align")}}},content:"inline*",group:"block",parseDOM:[{tag:"figure",getAttrs:t=>({align:t.style.textAlign||null,id:t.dataset.pmid})}],toDOM:t=>["figure",{style:t.attrs.align?`text-align:${t.attrs.align};`:null,"data-pmid":t.attrs.id},0]}},on={text:{group:"inline"},image:{inline:!0,attrs:{src:{validate:"string"},alt:{default:null,validate:"string|null"},title:{default:null,validate:"string|null"},size:{default:null,validate:"string|number|null"},textaround:{default:!0,validate:"string|boolean"},caption:{default:null,validate:"string|null"},width:{default:null,validate:"string|null"},height:{default:null,validate:"string|null"},cssClass:{default:null,validate:"string|null"},id:{default:null,excludeFromMarkupComparison:!0}},group:"inline",draggable:!0,marks:"",parseDOM:[{tag:"img[src]",getAttrs:t=>({src:t.getAttribute("src"),title:t.getAttribute("title"),alt:t.getAttribute("alt"),width:t.getAttribute("width"),height:t.getAttribute("height"),cssClass:t.dataset.cssClass,size:t.dataset.pmsize,textaround:t.dataset.pmtextaround,caption:t.dataset.pmcaption,id:t.dataset.pmid})}],toDOM(t){const{src:e,alt:n,title:i,caption:s,size:r,id:o,textaround:a,width:l,height:c,cssClass:h}=t.attrs;return s?["div",{class:r&&a?`img${r}Float`:r?`img${r}`:null},["img",{src:e,alt:n,title:i,width:l,height:c,class:h,"data-pmsize":r,"data-pmid":o,"data-pmtextaround":a,"data-pmcaption":s}],["figcaption",s]]:["img",{src:e,alt:n,title:i,width:l,height:c,class:r&&a?`${h??""} img${r}Float`:r?`${h??""} img${r}`:h??null,"data-pmsize":r,"data-pmid":o,"data-pmtextaround":a,"data-pmcaption":s}]}},hard_break:{attrs:{id:{default:null,excludeFromMarkupComparison:!0}},inline:!0,group:"inline",selectable:!1,parseDOM:[{tag:"br",getAttrs:t=>({id:t.dataset.pmid})}],toDOM:t=>["br",{"data-pmid":t.attrs.id}]}};function an(t,e,n,i,s){let r=s,o=i-1;for(;o>n;)r-=e.child(o).nodeSize,t.delete(r-1,r+1),o--}function ln(t,e,n){const i=e?Z.empty:Z.from(t.copy(Z.empty)),s=n?Z.empty:Z.from(t.copy(Z.empty));return i.append(s)}function cn(t,e,n,i=null){let s=!1,r=e;const o=e.$from.doc;if(l=n,(a=e).depth>=2&&a.$from.node(a.depth-1).type.compatibleContent(l)&&0===a.startIndex){if(0===e.$from.index(e.depth-1))return!1;const t=o.resolve(e.start-2);r=new mt(t,t,e.depth),e.endIndex<e.parent.childCount&&(e=new mt(e.$from,o.resolve(e.$to.end(e.depth)),e.depth)),s=!0}var a,l;const c=ke(r,n,i,e);return!!c&&(t&&(e.endIndex-e.startIndex>=50&&!s?function(t,e,n,i,s){const r=e.parent,o=function(t){for(let e=t.length-1;e>=0;e--){const n=t[e];if("list_item"===n.type.name||n.type.spec.content?.includes("paragraph")||n.type.spec.content?.includes("block"))return n.type}return t[t.length-1].type}(n),a=[];for(let u=e.startIndex;u<e.endIndex;u++){const t=r.child(u),e=o.create(null,Z.from(t));a.push(e)}const l=Z.from(a),c=i.create(s,l);let h=Z.from(c);for(let u=n.length-1;u>=0;u--){const t=n[u];t.type!==i&&t.type!==o&&(h=Z.from(t.type.create(t.attrs,h)))}const d=new tt(h,0,0);t.replaceRange(e.start,e.end,d)}(t,e,c,n,i):function(t,e,n,i,s){const r=function(t){let e=Z.empty;for(let n=t.length-1;n>=0;n--)e=Z.from(t[n].type.create(t[n].attrs,e));return e}(n),o=i?2:0;t.step(new ee(e.start-o,e.end,e.start,e.end,new tt(r,0,0),n.length,!0));const a=function(t,e){let n=0;for(let i=0;i<t.length;i++)t[i].type===e&&(n=i+1);return n}(n,s),l=n.length-a;let c=e.start+n.length-o;const h=e.parent;for(let d=e.startIndex;d<e.endIndex;d++)d>e.startIndex&&Rt(t.doc,c,l)&&(t.split(c,l),c+=2*l),c+=h.child(d).nodeSize}(t,e,c,s,n)),!0)}function hn(t){return t.type.spec.content?.includes("list_item")??!1}function dn(t,e=null,n=!1){return(i,s)=>{const{$from:r,$to:o}=i.selection,a=function(t){const{$from:e,$to:n}=t.selection,i=nn(t.selection,hn);if(i)return i;if(0===e.depth&&0===e.pos&&n.pos===t.doc.content.size){const e=t.doc;if(e.childCount>0){let t=null,n=0,i=!0,s=0;for(let r=0;r<e.childCount;r++){const o=e.child(r);if(!hn(o)){i=!1;break}null===t?(t=o,n=s):o.type!==t.type&&(i=!1),s+=o.nodeSize}if(t&&i)return{position:gt.resolve(e,n),node:t}}}return null}(i),l=null!==a&&a.node.type===t;if(l&&!s)return!0;if(l&&a)return function(t,e,n){const i=n.node,s=n.position.pos;if(0===i.childCount)return!1;const r=t.doc,o=r.resolve(s+1),a=r.resolve(s+i.nodeSize-1),l=i.firstChild.type,c=o.blockRange(a,t=>t.childCount>0&&t.firstChild.type===l);return!!c&&(!e||(o.node(c.depth-1).type===l?function(t,e,n,i){const s=t.transaction,r=i.end,o=i.$to.end(i.depth);r<o&&(s.step(new ee(r-1,o,r,o,new tt(Z.from(n.create(null,i.parent.copy())),1,0),1,!0)),i=new mt(s.doc.resolve(i.$from.pos),s.doc.resolve(o),i.depth));const a=Ie(i);if(U(a))return!1;s.lift(i,a);const l=s.doc.resolve(s.mapping.map(r,-1)-1);return Ot(s.doc,l.pos)&&l.nodeBefore.type===l.nodeAfter.type&&s.join(l.pos),e(s.scrollIntoView()),!0}(t,e,l,c):function(t,e,n){const i=t.transaction,s=n.parent;if(n.endIndex-n.startIndex>=50)return function(t,e,n){const i=t.transaction,s=n.parent,r=0===n.startIndex,o=n.endIndex===s.childCount,a=t.doc.resolve(n.start),l=a.node(-1),c=a.index(-1),h=[];for(let g=n.startIndex;g<n.endIndex;g++)s.child(g).forEach(t=>{h.push(t)});const d=Z.from(h);if(!l.canReplace(c+(r?0:1),c+1,d.append(o?Z.empty:Z.from(s))))return function(t,e,n){const i=t.transaction,s=n.parent;an(i,s,n.startIndex,n.endIndex,n.end);const r=i.doc.resolve(n.start),o=r.nodeAfter;if(U(o))return!1;if(i.mapping.map(n.end)!==n.start+o.nodeSize)return!1;const a=0===n.startIndex,l=n.endIndex===s.childCount,c=r.node(-1),h=r.index(-1);if(!c.canReplace(h+(a?0:1),h+1,o.content.append(l?Z.empty:Z.from(s))))return!1;const d=r.pos,u=d+o.nodeSize,p=ln(s,a,l);return i.step(new ee(d-(a?1:0),u+(l?1:0),d+1,u-1,new tt(p,a?0:1,l?0:1),a?0:1)),e(i.scrollIntoView()),!0}(t,e,n);let u;u=r&&o?d:r?d.append(Z.from(s.copy(Z.empty))):o?Z.from(s.copy(Z.empty)).append(d):Z.from(s.copy(Z.empty)).append(d).append(Z.from(s.copy(Z.empty)));const p=n.start-1,f=n.end+1,m=new tt(u,r?0:1,o?0:1);return i.replace(p,f,m),e(i.scrollIntoView()),!0}(t,e,n);an(i,s,n.startIndex,n.endIndex,n.end);const r=i.doc.resolve(n.start),o=r.nodeAfter;if(U(o))return!1;if(i.mapping.map(n.end)!==n.start+o.nodeSize)return!1;const a=0===n.startIndex,l=n.endIndex===s.childCount,c=r.node(-1),h=r.index(-1);if(!c.canReplace(h+(a?0:1),h+1,o.content.append(l?Z.empty:Z.from(s))))return!1;const d=r.pos,u=d+o.nodeSize,p=ln(s,a,l);return i.step(new ee(d-(a?1:0),u+(l?1:0),d+1,u-1,new tt(p,a?0:1,l?0:1),a?0:1)),e(i.scrollIntoView()),!0}(t,e,c)))}(i,s,a);if(n)return!1;if(a){if(!s)return!0;const n=i.transaction,r=a.position.pos;return n.setNodeMarkup(r,t,e),s(n.scrollIntoView()),!0}const c=r.blockRange(o);if(!c)return!1;if(!s)return cn(null,c,t,e);const h=i.transaction;return!!cn(h,c,t,e)&&(s(h.scrollIntoView()),!0)}}const un=["em",0],pn=["strong",0],fn=["u",0],mn=["s",0],gn=["sub",0],yn=["sup",0],bn=["mark",0],wn=["code",0],vn={link:{attrs:{href:{validate:"string"},title:{default:null,validate:"string|null"},target:{default:"_blank",validate:"_blank|string|null"},rel:{default:"noopener noreferrer",validate:"string|null"},id:{default:null,excludeFromMarkupComparison:!0}},inclusive:!1,parseDOM:[{tag:"a[href]",getAttrs:t=>!t.getAttribute("download")&&{href:t.getAttribute("href"),title:t.getAttribute("title"),target:t.getAttribute("target"),id:t.dataset.pmid}}],toDOM(t){const{href:e,title:n,target:i,rel:s,id:r}=t.attrs;return["a",{href:e,title:n,target:i,rel:s,"data-pmid":r},0]}},file:{inline:!0,attrs:{href:{validate:"string"},previewImage:{default:null,validate:"string|null"},name:{default:null,validate:"string|null"},lastModified:{default:null,validate:"string|null"},size:{default:null,validate:"string|number|null"},type:{default:!0,validate:"boolean"},id:{default:null,excludeFromMarkupComparison:!0}},group:"inline",draggable:!0,parseDOM:[{tag:"a[download]",getAttrs:t=>({href:t.getAttribute("href"),previewImage:t.querySelector("img")?t.querySelector("img").getAttribute("src"):null,name:t.dataset.pmname,lastModified:t.dataset.pmlastModified,size:t.dataset.pmsize,type:t.dataset.pmtype,id:t.dataset.pmid})}],toDOM(t){const{href:e,name:n,lastModified:i,size:s,type:r,id:o}=t.attrs;return["a",{href:e,"data-pmname":n,"data-pmlastModified":i,"data-pmsize":s,"data-pmtype":r,"data-pmid":o,download:n},0]}},em:{parseDOM:[{tag:"i"},{tag:"em"},{style:"font-style=italic"},{style:"font-style=normal",clearMark:t=>"em"===t.type.name}],toDOM:()=>un},strong:{parseDOM:[{tag:"strong"},{tag:"b",getAttrs:t=>"normal"!==t.style.fontWeight&&null},{style:"font-weight=400",clearMark:t=>"strong"===t.type.name},{style:"font-weight",getAttrs:t=>/^(bold(er)?|[5-9]\d{2,})$/.test(t)&&null}],toDOM:()=>pn},underline:{parseDOM:[{tag:"u"},{style:"text-decoration=underline"},{style:"text-decoration=none",clearMark:t=>"u"===t.type.name}],toDOM:()=>fn},strikethrough:{parseDOM:[{tag:"s"},{tag:"del"},{tag:"strike"},{style:"text-decoration=line-through"},{style:"text-decoration=none",clearMark:t=>"s"===t.type.name}],toDOM:()=>mn},subscript:{parseDOM:[{tag:"sub"}],toDOM:()=>gn},superscript:{parseDOM:[{tag:"sup"}],toDOM:()=>yn},highlight:{parseDOM:[{tag:"mark"},{style:"background-color=transparent",clearMark:t=>"mark"===t.type.name},{style:"background-color=none",clearMark:t=>"mark"===t.type.name}],toDOM:()=>bn},code:{isCode:!0,parseDOM:[{tag:"code"}],toDOM:()=>wn}},An={attrs:{order:{default:1,validate:"number"},id:{default:null,excludeFromMarkupComparison:!0},align:{default:null,validate:t=>{if(t&&"left"!==t&&"right"!==t&&"justify"!==t&&"center"!==t)throw new Error("Unsupported value for text-align")}}},parseDOM:[{tag:"ol",getAttrs:t=>({align:t.style.textAlign||null,id:t.dataset.pmid,order:t.hasAttribute("start")?+t.getAttribute("start"):1})}],toDOM:t=>1===t.attrs.order?["ol",{"data-pmid":t.attrs.id},0]:["ol",{start:t.attrs.order,style:t.attrs.align?`text-align:${t.attrs.align};`:null,"data-pmid":t.attrs.id},0]},xn={attrs:{id:{default:null,excludeFromMarkupComparison:!0},align:{default:null,validate:t=>{if(t&&"left"!==t&&"right"!==t&&"justify"!==t&&"center"!==t)throw new Error("Unsupported value for text-align")}}},parseDOM:[{tag:"ul",getAttrs:t=>({align:t.style.textAlign||null,id:t.dataset.pmid})}],toDOM:t=>["ul",{style:t.attrs.align?`text-align:${t.attrs.align};`:null,"data-pmid":t.attrs.id},0]},Sn={attrs:{id:{default:null,excludeFromMarkupComparison:!0}},parseDOM:[{tag:"li",getAttrs:t=>({id:t.dataset.pmid})}],toDOM:t=>["li",{"data-pmid":t.attrs.id},0],defining:!0};function _n(t,e){return{...t,...e}}const Tn=new class{schemaSpec;schemaNodes;schemaMarks;_linebreakReplacement=null;_topNodeType;cachedValues=Object.create(null);nodeFromJSONFunc;markFromJSONFunc;constructor(t){const e={nodes:$.from(t.nodes),marks:$.from(t.marks||{})};for(const n in t)"nodes"!==n&&"marks"!==n&&(e[n]=t[n]);this.schemaSpec=e,this.schemaNodes=Dt.compile(this.schemaSpec.nodes,this),this.schemaMarks=Ct.compile(this.schemaSpec.marks,this),this.initializeNodeTypes(),this.initializeMarkExclusions(),this.nodeFromJSONFunc=t=>bt.fromJSON(this,t),this.markFromJSONFunc=t=>Q.fromJSON(this,t),this._topNodeType=this.schemaNodes[this.spec.topNode||"doc"],this.cachedValues.wrappings=Object.create(null)}get spec(){return this.schemaSpec}get nodes(){return this.schemaNodes}get marks(){return this.schemaMarks}get linebreakReplacement(){return this._linebreakReplacement}get topNodeType(){return this._topNodeType}get cached(){return this.cachedValues}get nodeFromJSON(){return this.nodeFromJSONFunc}get markFromJSON(){return this.markFromJSONFunc}node(t,e=null,n,i){if("string"==typeof t)t=this.nodeType(t);else{if(!(t instanceof Dt))throw new RangeError(`Invalid node type: ${t}`);if(t.schema!==this)throw new RangeError(`Node type from different schema used (${t.name})`)}return t.createChecked(e,n,i)}text(t,e){const n=this.schemaNodes.text;return new wt(n,n.defaultAttrs,t,Q.setFrom(e))}mark(t,e){if("string"==typeof t){const e=this.schemaMarks[t];if(!e)throw new RangeError(`Unknown mark type: ${t}`);t=e}return t.create(e)}nodeType(t){const e=this.schemaNodes[t];if(!e)throw new RangeError("Unknown node type: "+t);return e}initializeNodeTypes(){const t=new Map;for(const e in this.schemaNodes){if(e in this.schemaMarks)throw new RangeError(`${e} can not be both a node and a mark`);const n=this.schemaNodes[e],i=n.spec.content||"";if(n.contentMatch=t.get(i)??Pt.parse(i,this.schemaNodes),t.set(i,n.contentMatch),n.inlineContent=n.contentMatch.inlineContent,n.spec.linebreakReplacement){if(this._linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!n.isInline||!n.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this._linebreakReplacement=n}const s=n.spec.marks;n.markSet=null,"_"!==s&&(s?n.markSet=this.gatherMarks(s.split(" ")):""!==s&&n.inlineContent||(n.markSet=[]))}}initializeMarkExclusions(){for(const t in this.schemaMarks){const e=this.schemaMarks[t],n=e.spec.excludes;U(n)?e.excluded=[e]:e.excluded=""===n?[]:this.gatherMarks(n.split(" "))}}gatherMarks(t){const e=new Set;for(const n of t){const t=this.schemaMarks[n];if(t)e.add(t);else{const t="_"===n;let i=!1;for(const s in this.schemaMarks){const r=this.schemaMarks[s];if(t)e.add(r),i=!0;else{const t=r.spec.group?.split(" ");t?.includes(n)&&(e.add(r),i=!0)}}if(!i)throw new SyntaxError(`Unknown mark type: '${n}'`)}}return Array.from(e)}}({nodes:function(t,e,n){return t.append({ordered_list:_n(An,{content:"list_item+",group:n}),bullet_list:_n(xn,{content:"list_item+",group:n}),list_item:_n(Sn,{content:e})})}($.from({...rn,...on}),"paragraph block*","block"),marks:vn});function En(t){let e=0,n=t;for(;n.previousSibling;)n=n.previousSibling,e++;return e}function Cn(t){let e;for(let n=t;n&&(e=n.pmViewDesc,!e);n=n.parentNode);return!!e?.node&&e.node.isBlock&&(e.dom===t||e.contentDOM===t)}function Mn(t){return 3===t.nodeType?t.nodeValue?.length??0:t.childNodes.length}$.from({...rn,...on});const kn=/^(img|br|input|textarea|hr)$/i;function Dn(t,e,n,i){return t===n&&e===i||!!n&&(In(t,e,n,i,-1)||In(t,e,n,i,1))}function In(t,e,n,i,s){const r=s<0;for(;;){if(t===n&&e===i)return!0;if(e===(r?0:Mn(t))){const n=t.parentNode;if(1!==n?.nodeType||Cn(t)||kn.test(t.nodeName)||"false"===t.contentEditable)return!1;e=En(t)+(r?0:1),t=n}else{if(1!==t.nodeType)return!1;{const n=e+(r?-1:0),i=t.childNodes[n];if(!i)return!1;if(1===i.nodeType&&"false"===i.contentEditable){if(!i.pmViewDesc?.ignoreForSelection)return!1;e+=s}else t=i,e=r?Mn(t):0}}}}function Nn(t){const e=t.assignedSlot||t.parentNode;return 11===e?.nodeType?e.host:e}let Pn=null;function On(t,e,n){const i=Pn||(Pn=document.createRange()),s=t.nodeValue?.length??0;return i.setEnd(t,n??s),i.setStart(t,e||0),i}let Rn=class{_attributes=new Map;_nodeName;_class;_style;constructor(t){t&&(this._nodeName=t)}get nodeName(){return this._nodeName}set nodeName(t){this._nodeName=t}get class(){return this._class}set class(t){this._class=t}get style(){return this._style}set style(t){this._style=t}get attributes(){return this._attributes}setAttribute(t,e){this._attributes.set(t,e)}};function Bn(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!t[n].type.eq(e[n].type))return!1;return!0}let Fn=class{get nodeDOM(){return null}};var Ln=(t=>(t[t.VIEW=0]="VIEW",t[t.NODE=1]="NODE",t[t.MARK=2]="MARK",t[t.COMPOSITION=3]="COMPOSITION",t[t.TEXT=4]="TEXT",t[t.WIDGET=5]="WIDGET",t[t.CUSTOM=6]="CUSTOM",t[t.TRAILING_HACK=7]="TRAILING_HACK",t))(Ln||{}),zn=(t=>(t[t.NOT_DIRTY=0]="NOT_DIRTY",t[t.CHILD_DIRTY=1]="CHILD_DIRTY",t[t.CONTENT_DIRTY=2]="CONTENT_DIRTY",t[t.NODE_DIRTY=3]="NODE_DIRTY",t))(zn||{});let Vn=class extends Fn{_contentDOM;_dirty=zn.NOT_DIRTY;_node;_parent;_children;_dom;constructor(t,e,n,i){super(),this._parent=t,this._children=e,this._dom=n,this._contentDOM=i,n&&(n.pmViewDesc=this)}get dirty(){return this._dirty}set dirty(t){this._dirty=t}get node(){return this._node}get parent(){return this._parent}set parent(t){this._parent=t}get children(){return this._children}set children(t){this._children=t}get dom(){return this._dom}get contentDOM(){return this._contentDOM}get domAtom(){return!1}get ignoreForCoords(){return!1}get ignoreForSelection(){return!1}get contentLost(){return this._contentDOM&&this._contentDOM!==this._dom&&!this._dom.contains(this._contentDOM)}get posBefore(){return this._parent.posBeforeChild(this)}get posAtStart(){return this._parent?this._parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}get size(){let t=0;for(const e of this._children)t+=e.size;return t}get border(){return 0}get side(){return 0}getType(){return Ln.VIEW}matchesWidget(t){return!1}matchesMark(t){return!1}matchesNode(t,e,n){return!1}matchesHack(t){return!1}parseRule(){return null}stopEvent(t){return!1}destroy(){this._parent=void 0,this._dom?.pmViewDesc===this&&(this._dom.pmViewDesc=void 0);const t=this._children;this._children=[];for(const e of t)try{e.destroy()}catch(z){console?.error&&console.error("Error destroying child view desc:",z)}}posBeforeChild(t){for(let e=0,n=this.posAtStart;e<this._children.length;e++){const i=this._children[e];if(i===t)return n;n+=i.size}throw new Error("Child not found in parent")}localPosFromDOM(t,e,n){const i=1===t.nodeType?t:t.parentNode,s=this._contentDOM?.contains(i);return s?this.findPositionInContent(t,e,n):this.determinePositionFromHeuristics(t,e,n)}getDesc(t){const e=t.pmViewDesc;if(e)for(let n=e;n;n=n.parent)if(n===this)return e}posFromDOM(t,e,n){for(let i=t;i;i=i.parentNode){const s=this.getDesc(i);if(s)return s.localPosFromDOM(t,e,n)}return-1}descAt(t){let e=0;for(let n of this._children){const i=e+n.size;if(e===t&&i!==e){for(;!n.border&&n.children.length;)for(const t of n.children)if(t.size){n=t;break}return n}if(t<i)return n.descAt(t-e-n.border);e=i}}domFromPos(t,e){if(!this._contentDOM)return this.getDomForLeafNode(t);const n=this.findChildAtPosition(t);return this.isPositionInsideChild(n)?this.getDomFromChild(n,e):this.getDomAtBoundary(n.index,e)}parseRange(t,e,n=0){if(0===this._children.length)return this.getEmptyParseRange(t,e);const i=this.findParseRangeBounds(t,e,n);return{node:this._contentDOM,...i}}emptyChildAt(t){if(this.border||!this._contentDOM||!this._children.length)return!1;const e=this._children[t<0?0:this._children.length-1];return 0===e.size||e.emptyChildAt(t)}domAfterPos(t){const{node:e,offset:n}=this.domFromPos(t,0);if(1!==e.nodeType||n===e.childNodes.length)throw new RangeError(`No node after pos ${t}`);return e.childNodes[n]}setSelection(t,e,n,i=!1){this.tryDelegateToChild(t,e,n,i)||this.setSelectionInDOM(t,e,n,i)}ignoreMutation(t){return!this._contentDOM&&"selection"!==t.type}markDirty(t,e){let n=0;for(const i of this._children){const s=n+i.size;if(this.rangeOverlapsChild(t,e,n,s)&&this.tryMarkChildDirty(i,t,e,n,s))return;n=s}this._dirty=zn.CONTENT_DIRTY}isText(t){return!1}markParentsDirty(){let t=this._parent,e=1;for(;t;){const n=1===e?zn.CONTENT_DIRTY:zn.CHILD_DIRTY;t.dirty<n&&(t.dirty=n),t=t.parent,e++}}setDomNode(t){this._dom=t,this._dom.pmViewDesc=this}findPositionInContent(t,e,n){return n<0?this.findPositionBefore(t,e):this.findPositionAfter(t,e)}findPositionBefore(t,e){const n=this.findNodeBefore(t,e),i=this.findViewDescBefore(n);return i?this.posBeforeChild(i)+i.size:this.posAtStart}findNodeBefore(t,e){if(t===this._contentDOM)return t.childNodes[e-1];for(;t.parentNode!==this._contentDOM;)t=t.parentNode;return t.previousSibling}findViewDescBefore(t){let e=t;for(;e;){const t=e.pmViewDesc;if(t?.parent===this)return t;e=e.previousSibling}}findPositionAfter(t,e){const n=this.findNodeAfter(t,e),i=this.findViewDescAfter(n);return i?this.posBeforeChild(i):this.posAtEnd}findNodeAfter(t,e){if(t===this._contentDOM)return t.childNodes[e];for(;t.parentNode!==this._contentDOM;)t=t.parentNode;return t.nextSibling}findViewDescAfter(t){let e=t;for(;e;){const t=e.pmViewDesc;if(t?.parent===this)return t;e=e.nextSibling}}determinePositionFromHeuristics(t,e,n){let i;return t===this._dom&&this._contentDOM?i=e>En(this._contentDOM):this._contentDOM&&this._contentDOM!==this._dom&&this._dom.contains(this._contentDOM)?i=2&t.compareDocumentPosition(this._contentDOM):this._dom.firstChild&&(i=this.checkPositionAtBoundary(t,e)),i??n>0?this.posAtEnd:this.posAtStart}checkPositionAtBoundary(t,e){let n;if(0===e)for(let i=t;i;i=i.parentNode){if(i===this._dom){n=!1;break}if(i.previousSibling)break;if(!i.parentNode)break}if(void 0===n&&e===t.childNodes.length)for(let i=t;i;i=i.parentNode){if(i===this._dom){n=!0;break}if(i.nextSibling)break;if(!i.parentNode)break}return n}getDomForLeafNode(t){return{node:this._dom,offset:0,atom:t+1}}isPositionInsideChild(t){return t.offset>0}getDomFromChild(t,e){const n=this._children[t.index],i=t.offset-n.border;return n.domFromPos(i,e)}getDomAtBoundary(t,e){const n=this.skipZeroLengthWidgets(t);return e<=0?this.findDomPositionBefore(n,e):this.findDomPositionAfter(n)}findChildAtPosition(t){let e=0,n=0;for(let i=0;e<this._children.length;e++){const s=this._children[e],r=i+s.size;if(r>t||s?.getType()===Ln.TRAILING_HACK){n=t-i;break}i=r}return{index:e,offset:n}}skipZeroLengthWidgets(t){let e=t;for(;e>0;){const t=this._children[e-1];if(t.size||t?.getType()!==Ln.WIDGET||t.side<0)break;e--}return e}findDomPositionBefore(t,e){let n,i=t,s=!0;for(;n=i?this._children[i-1]:null,n&&n.dom.parentNode!==this._contentDOM;)i--,s=!1;return n&&e&&s&&!n.border&&!n.domAtom?n.domFromPos(n.size,e):{node:this._contentDOM,offset:n?En(n.dom)+1:0}}findDomPositionAfter(t){let e,n=t,i=!0;for(;n<this._children.length&&(e=this._children[n],e.dom.parentNode!==this._contentDOM);)n++,i=!1;return n>=this._children.length&&(e=null),e&&i&&!e.border&&!e.domAtom?e.domFromPos(0,1):{node:this._contentDOM,offset:e?En(e.dom):this._contentDOM.childNodes.length}}getEmptyParseRange(t,e){return{node:this._contentDOM,from:t,to:e,fromOffset:0,toOffset:this._contentDOM.childNodes.length}}findParseRangeBounds(t,e,n){let i=-1,s=-1,r=n;for(let o=0;;o++){const n=this._children[o],a=r+n.size;if(-1===i&&t<=a){const s=this.tryRecursiveParseRange(n,t,e,r,a);if(s)return s;({from:t,fromOffset:i}=this.findStartOffset(o,r))}if(i>-1&&(a>e||o===this._children.length-1)){({to:e,toOffset:s}=this.findEndOffset(o,a));break}r=a}return{from:t,to:e,fromOffset:i,toOffset:s}}tryRecursiveParseRange(t,e,n,i,s){const r=i+t.border;return e>=r&&n<=s-t.border&&t.node&&t.contentDOM&&this._contentDOM.contains(t.contentDOM)?t.parseRange(e,n,r):null}findStartOffset(t,e){let n=e,i=-1;for(let s=t;s>0;s--){const t=this._children[s-1];if(t.size&&t.dom.parentNode===this._contentDOM&&!t.emptyChildAt(1)){i=En(t.dom)+1;break}n-=t.size}return{from:n,fromOffset:-1===i?0:i}}findEndOffset(t,e){let n=e,i=-1;for(let s=t+1;s<this._children.length;s++){const t=this._children[s];if(t.size&&t.dom.parentNode===this._contentDOM&&!t.emptyChildAt(-1)){i=En(t.dom);break}n+=t.size}return{to:n,toOffset:-1===i?this._contentDOM.childNodes.length:i}}handleBRKludge(t,e,n){if(!L.gecko&&!L.safari||e!==n)return{brKludge:!1};const{node:i,offset:s}=t;if(3===i.nodeType){const t=s&&"\n"===i.nodeValue[s-1];if(t&&s===i.nodeValue.length){const e=this.findBRAfterTextNode(i);if(e)return{brKludge:t,anchorDOM:e,headDOM:e}}return{brKludge:t}}{const t=i.childNodes[s-1];return{brKludge:t&&("BR"===t.nodeName||"false"===t.contentEditable)}}}findBRAfterTextNode(t){for(let e=t;e;e=e.parentNode){const t=e.nextSibling;if(t){if("BR"===t.nodeName)return{node:t.parentNode,offset:En(t)+1};break}const n=e.pmViewDesc;if(n?.node?.isBlock)break}}tryDelegateToChild(t,e,n,i){const s=Math.min(t,e),r=Math.max(t,e);let o=0;for(const a of this._children){const l=o+a.size;if(s>o&&r<l){const s=t-o-a.border,r=e-o-a.border;return a.setSelection(s,r,n,i),!0}o=l}return!1}setSelectionInDOM(t,e,n,i){let s=this.domFromPos(t,t?-1:1),r=e===t?s:this.domFromPos(e,e?-1:1);const o=n.root.getSelection(),a=n.domSelectionRange(),l=this.handleBRKludge(s,t,e);l.anchorDOM&&(s=l.anchorDOM,r=l.headDOM),i=this.checkFirefoxUneditableQuirk(i,r,a),this.shouldUpdateSelection(i,l.brKludge,s,r,a)&&this.applyDOMSelection(o,s,r,t,e,l.brKludge)}checkFirefoxUneditableQuirk(t,e,n){if(!L.gecko||!n.focusNode)return t;if(n.focusNode===e.node||1!==n.focusNode.nodeType)return t;const i=n.focusNode.childNodes[n.focusOffset];return!(!i||"false"!==i.contentEditable)||t}shouldUpdateSelection(t,e,n,i,s){return!!(t||e&&L.safari)||!(Dn(n.node,n.offset,s.anchorNode,s.anchorOffset)&&Dn(i.node,i.offset,s.focusNode,s.focusOffset))}applyDOMSelection(t,e,n,i,s,r){this.tryExtendSelection(t,e,n,i,s,r)||this.applyRangeSelection(t,e,n,i,s)}tryExtendSelection(t,e,n,i,s,r){if(!t.extend&&i!==s||r&&L.gecko)return!1;t.collapse(e.node,e.offset);try{return i!==s&&t.extend(n.node,n.offset),!0}catch(o){return!1}}applyRangeSelection(t,e,n,i,s){if(i>s){const t=e;e=n,n=t}const r=document.createRange();r.setEnd(n.node,n.offset),r.setStart(e.node,e.offset),t.removeAllRanges(),t.addRange(r)}rangeOverlapsChild(t,e,n,i){return n===i?t<=i&&e>=n:t<i&&e>n}tryMarkChildDirty(t,e,n,i,s){const r=i+t.border,o=s-t.border;return e>=r&&n<=o?(this.markChildAndParent(t,e,n,i,s,r,o),!0):(this.markChildForRecreation(t),!1)}markChildAndParent(t,e,n,i,s,r,o){const a=e===i||n===s;this._dirty=a?zn.CONTENT_DIRTY:zn.CHILD_DIRTY;const l=e===r&&n===o,c=t.contentLost||t.dom.parentNode!==this._contentDOM;l&&c?t.dirty=zn.NODE_DIRTY:t.markDirty(e-r,n-r)}markChildForRecreation(t){const e=t.dom===t.contentDOM&&t.dom.parentNode===this._contentDOM&&!t.children.length;t.dirty=e?zn.CONTENT_DIRTY:zn.NODE_DIRTY}},Hn=class t extends Vn{_nodeDOM;_outerDeco=null;_innerDeco=null;constructor(t,e,n,i,s,r,o){super(t,[],s,r),this._node=e,this._outerDeco=n,this._innerDeco=i,this._nodeDOM=o}get outerDeco(){return this._outerDeco}get innerDeco(){return this._innerDeco}get nodeDOM(){return this._nodeDOM}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}get domAtom(){return this.node.isAtom}static applyOuterDeco(e,n,i){return t.patchOuterDeco(e,e,null,t.computeOuterDeco(n,i,1!==e.nodeType))}static computeOuterDeco(t,e,n){if(0===t.length)return[new Rn];const i=[new Rn];for(const s of t){const t=s.type.attrs;t&&this.processDecorationAttributes(t,e,n,i)}return i}static processDecorationAttributes(t,e,n,i){t.nodeName&&i.push(new Rn(t.nodeName));for(const[s,r]of Object.entries(t))U(r)||this.applyAttribute(s,r,e,n,i)}static applyAttribute(t,e,n,i,s){if(i&&1===s.length){const t=n.isInline?"span":"div";s.push(new Rn(t))}const r=s[s.length-1];switch(t){case"class":r.class=this.appendValue(r.class,e," ");break;case"style":r.style=this.appendValue(r.style,e,";");break;case"nodeName":break;default:r.setAttribute(t,e)}}static appendValue(t,e,n){return t?`${t}${n}${e}`:e}static patchOuterDeco(e,n,i,s){if(U(i)&&U(s)||U(s))return n;let r=n;for(let o=0;o<s.length;o++){const n=s[o],a=i?i[o]:null;if(o){let t;a?.nodeName===n.nodeName&&r!==e&&(t=r.parentNode)&&t.nodeName.toLowerCase()===n.nodeName||(t=document.createElement(n.nodeName),t.pmIsDeco=!0,t.appendChild(r)),r=t}t.patchAttributes(r,a,n)}return r}static patchAttributes(t,e,n){this.patchCustomAttributes(t,e,n),this.patchClasses(t,e,n),this.patchStyles(t,e,n)}static patchCustomAttributes(t,e,n){const i=new Set(["class","style","nodeName"]);e?.attributes.forEach((e,s)=>{i.has(s)||n?.attributes.has(s)||t.removeAttribute(s)}),n?.attributes.forEach((n,s)=>{i.has(s)||n===e?.attributes.get(s)||t.setAttribute(s,n)})}static patchClasses(t,e,n){if(e?.class===n?.class)return;const i=this.parseClassList(e?.class),s=this.parseClassList(n?.class);for(const r of i)s.has(r)||t.classList.remove(r);for(const r of s)i.has(r)||t.classList.add(r);0===t.classList.length&&t.removeAttribute("class")}static parseClassList(t){return t?new Set(t.split(" ").filter(Boolean)):new Set}static patchStyles(t,e,n){e?.style!==n?.style&&(e?.style&&this.removeStyleProperties(t,e.style),n?.style&&(t.style.cssText+=n.style))}static removeStyleProperties(t,e){const n=/\s*([\w\-\xa1-\uffff]+)\s*:(?:'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g;let i;for(;null!==(i=n.exec(e));){const e=i[1];t.style.removeProperty(e)}}getType(){return Ln.NODE}parseRule(){if(this.node.type.spec.reparseInView)return null;const t={node:this.node.type.name,attrs:this.node.attrs};if("pre"===this.node.type.whitespace&&(t.preserveWhitespace="full"),this._contentDOM)if(this.contentLost){for(let e=this._children.length-1;e>=0;e--){const n=this._children[e];if(this._dom.contains(n.dom.parentNode)){t.contentElement=n.dom.parentNode;break}}t.contentElement||(t.getContent=()=>Z.empty)}else t.contentElement=this._contentDOM;else t.getContent=()=>this.node.content;return t}matchesNode(t,e,n){return this._dirty===zn.NOT_DIRTY&&t.eq(this.node)&&Bn(e,this._outerDeco)&&n.eq(this._innerDeco)}updateInner(t,e,n){this.updateOuterDeco(e),this._node=t,this._innerDeco=n}updateOuterDeco(e){if(Bn(e,this._outerDeco))return;const n=1!==this._nodeDOM.nodeType,i=this._dom;this._dom=t.patchOuterDeco(this._dom,this._nodeDOM,t.computeOuterDeco(this._outerDeco,this.node,n),t.computeOuterDeco(e,this.node,n)),this._dom!==i&&(i.pmViewDesc=void 0,this._dom.pmViewDesc=this),this._outerDeco=e}selectNode(){1===this._nodeDOM.nodeType&&(this._nodeDOM.classList.add("ProseMirror-selectednode"),!this._contentDOM&&this.node.type.spec.draggable||(this._nodeDOM.draggable=!0))}deselectNode(){1===this._nodeDOM.nodeType&&(this._nodeDOM.classList.remove("ProseMirror-selectednode"),!this._contentDOM&&this.node.type.spec.draggable||this._nodeDOM.removeAttribute("draggable"))}},$n=class extends Hn{_spec;constructor(t,e,n,i,s,r,o,a){super(t,e,n,i,s,r,o),this._spec=a}get spec(){return this._spec}selectNode(){this._spec.selectNode?this._spec.selectNode():super.selectNode()}deselectNode(){this._spec.deselectNode?this._spec.deselectNode():super.deselectNode()}setSelection(t,e,n,i){this._spec.setSelection?this._spec.setSelection(t,e,n.root):super.setSelection(t,e,n,i)}destroy(){this._spec.destroy&&this._spec.destroy(),super.destroy()}stopEvent(t){return!!this._spec.stopEvent&&this._spec.stopEvent(t)}ignoreMutation(t){return this._spec.ignoreMutation?this._spec.ignoreMutation(t):super.ignoreMutation(t)}getType(){return Ln.CUSTOM}};function Un(t,e,n,i,s){const r=[];for(let o=0,a=0;o<t.length;o++){const l=t[o],c=a,h=a+=l.size;c>=n||h<=e?r.push(l):(c<e&&r.push(l.slice(0,e-c,i)),s&&(r.push(s),s=void 0),h>n&&r.push(l.slice(n-c,l.size,i)))}return r}let Wn=class extends Vn{textDOM;text;constructor(t,e,n,i){super(t,[],e,null),this.textDOM=n,this.text=i}get size(){return this.text.length}localPosFromDOM(t,e){return t!==this.textDOM?this.posAtStart+(e?this.size:0):this.posAtStart+e}domFromPos(t){return{node:this.textDOM,offset:t}}ignoreMutation(t){return"characterData"===t.type&&t.target.nodeValue===t.oldValue}getType(){return Ln.COMPOSITION}},Gn=class t extends Vn{mark;spec;constructor(t,e,n,i,s){super(t,[],n,i),this.mark=e,this.spec=s}static create(e,n,i,s){const r=s.nodeViews[n.type.name];let o;return r&&"function"==typeof r&&(o=r(n,s,i)),o?.dom||(o=_t.renderSpec(document,n.type.spec.toDOM(n,i),null)),new t(e,n,o.dom,o.contentDOM||o.dom,o)}parseRule(){return this._dirty&zn.NODE_DIRTY||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this._contentDOM}}matchesMark(t){return this._dirty!==zn.NODE_DIRTY&&this.mark.eq(t)}markDirty(t,e){if(super.markDirty(t,e),this._dirty!==zn.NOT_DIRTY){let t=this._parent;for(;!t.node;)t=t.parent;t.dirty<this._dirty&&(t.dirty=this._dirty),this._dirty=zn.NOT_DIRTY}}slice(e,n,i){const s=t.create(this._parent,this.mark,!0,i);let r=this._children;const o=this.size;n<o&&(r=Un(r,n,o,i)),e>0&&(r=Un(r,0,e,i));for(const t of r)t.parent=s;return s.children=r,s}ignoreMutation(t){return this.spec.ignoreMutation?this.spec.ignoreMutation(t):super.ignoreMutation(t)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}getType(){return Ln.MARK}},jn=class t extends Hn{_domAtom=!1;constructor(t,e,n,i,s,r){super(t,e,n,i,s,null,r)}get domAtom(){return this._domAtom}parseRule(){let t=this._nodeDOM.parentNode;for(;t&&t!==this._dom&&!t.pmIsDeco;)t=t.parentNode;return{skip:t||!0}}update(t,e,n,i){return!(this._dirty===zn.NODE_DIRTY||this._dirty!==zn.NOT_DIRTY&&!this.inParent()||!t.sameMarkup(this.node)||(this.updateOuterDeco(e),this._dirty===zn.NOT_DIRTY&&t.text===this.node.text||t.text===this._nodeDOM.nodeValue||(this._nodeDOM.nodeValue=t.text,i.trackWrites===this._nodeDOM&&i.clearTrackWrites()),this._node=t,this._dirty=zn.NOT_DIRTY,0))}inParent(){for(let t=this._nodeDOM;t;t=t.parentNode)if(t===this._parent.contentDOM)return!0;return!1}domFromPos(t){return{node:this._nodeDOM,offset:t}}localPosFromDOM(t,e,n){return t===this._nodeDOM?this.posAtStart+Math.min(e,this.node.text.length):super.localPosFromDOM(t,e,n)}ignoreMutation(t){return"characterData"!==t.type&&"selection"!==t.type}slice(e,n){const i=this.node.cut(e,n),s=document.createTextNode(i.text);return new t(this._parent,i,this._outerDeco,this._innerDeco,s,s)}markDirty(t,e){super.markDirty(t,e),this._dom===this._nodeDOM||0!==t&&e!==this._nodeDOM.nodeValue.length||(this._dirty=zn.NODE_DIRTY)}isText(t){return this.node.text===t}getType(){return Ln.TEXT}},Kn=class extends Vn{_domAtom=!0;get domAtom(){return this._domAtom}get ignoreForCoords(){return"IMG"===this._dom.nodeName}parseRule(){return{ignore:!0}}matchesHack(t){return this._dirty===zn.NOT_DIRTY&&this._dom.nodeName===t}getType(){return Ln.TRAILING_HACK}},qn=class extends Vn{_domAtom=!0;_widget;constructor(t,e,n,i){super(t,[],null,null),super.setDomNode(this.getDomNode(e,n,i)),this._widget=e}get widget(){return this._widget}get domAtom(){return this._domAtom}get ignoreForSelection(){return!!this._widget.type.spec.relaxedSide}get side(){return this._widget.type.side}matchesWidget(t){return this._dirty===zn.NOT_DIRTY&&t.type.eq(this._widget.type)}parseRule(){return{ignore:!0}}stopEvent(t){const e=this._widget.spec.stopEvent;return!!e&&e(t)}ignoreMutation(t){return"selection"!==t.type||this._widget.spec.ignoreSelection}destroy(){this._widget.type.destroy(this._dom),super.destroy()}getType(){return Ln.WIDGET}getDomNode(t,e,n){let i=t.type.toDOM;if("function"==typeof i&&(i=i(e,()=>n)),!t.type.spec.raw){if(1!==i.nodeType){const t=document.createElement("span");t.appendChild(i),i=t}i.contentEditable="false",i.classList.add("ProseMirror-widget")}return i}},Yn=class{static createNodeViewDesc(t,e,n,i,s,r){const o={},a=this.getCustomNodeViewSpec(e,s,r,n,i,o),{dom:l,contentDOM:c,nodeDOM:h}=this.createNodeDOM(e,a,n),d=this.instantiateNodeViewDesc(t,e,n,i,l,c,h,a);return o.desc=d,d}static createMarkViewDesc(t,e,n,i){const s=i.nodeViews[e.type.name];let r;return s&&"function"==typeof s&&(r=s(e,i,n)),r?.dom||(r=_t.renderSpec(document,e.type.spec.toDOM(e,n),null)),new Gn(t,e,r.dom,r.contentDOM||r.dom,r)}static createTrailingHackViewDesc(t,e,n,i){return new Kn(t,e,n,i)}static createWidgetViewDesc(t,e,n,i){return new qn(t,e,n,i)}static createCompositionViewDesc(t,e,n,i){return new Wn(t,e,n,i)}static getCustomNodeViewSpec(t,e,n,i,s,r){const o=e.nodeViews[t.type.name];if(o)return o(t,e,()=>r.desc?r.desc.parent?.posBeforeChild(r.desc)??n:n,i,s)}static createNodeDOM(t,e,n){let i,s=null;e?.dom?(i=e.dom,s=e.contentDOM??null):t.isText?i=this.createTextDOM(t):({dom:i,contentDOM:s}=this.createElementDOM(t)),this.applyNodeAttributes(i,t,s);const r=i;return i=Hn.applyOuterDeco(i,n,t),{dom:i,contentDOM:s,nodeDOM:r}}static createTextDOM(t){return document.createTextNode(t.text)}static createElementDOM(t){return _t.renderSpec(document,t.type.spec.toDOM(t),null)}static applyNodeAttributes(t,e,n){if(n||e.isText||"BR"===t.nodeName)return;const i=t;i.hasAttribute("contenteditable")||(i.contentEditable="false"),e.type.spec.draggable&&(i.draggable=!0)}static instantiateNodeViewDesc(t,e,n,i,s,r,o,a){return a?new $n(t,e,n,i,s,r,o,a):e.isText?new jn(t,e,n,i,s,o):new Hn(t,e,n,i,s,r,o)}},Xn=class{lock;view;preMatch;stack=[];index=0;top;_changed=!1;constructor(t,e,n){this.top=t,this.lock=e,this.view=n,this.preMatch=this.findPreMatch(t.node.content,t)}get changed(){return this._changed}destroyRemaining(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(t,e,n){const i=this.stack.length>>1,s=this.findKeepableMarks(t,i);this.popUnmatchedMarks(s,i),this.pushNewMarks(s,t,e,n)}findNodeMatch(t,e,n,i){let s=-1;const r=i>=this.preMatch.index?this.preMatch.matches[i-this.preMatch.index]:null;if(i>=this.preMatch.index&&r?.parent===this.top&&r.matchesNode(t,e,n))s=this.top.children.indexOf(r,this.index);else for(let o=this.index,a=Math.min(this.top.children.length,o+5);o<a;o++){const i=this.top.children[o];if(i.matchesNode(t,e,n)&&!this.preMatch.matched.has(i)){s=o;break}}return!(s<0||(this.destroyBetween(this.index,s),this.index++,0))}updateNodeAt(t,e,n,i){const s=this.top.children[i];return s.dirty===zn.NODE_DIRTY&&s.dom===s.contentDOM&&(s.dirty=zn.CONTENT_DIRTY),!!Jn.update(s,this.view,t,e,n)&&(this.destroyBetween(this.index,i),this.index++,!0)}findIndexWithChild(t){for(;;){const e=t.parentNode;if(!e)return-1;if(e===this.top.contentDOM){const e=t.pmViewDesc;if(e)for(let t=this.index;t<this.top.children.length;t++)if(this.top.children[t]===e)return t;return-1}t=e}}updateNextNode(t,e,n,i,s){for(let r=this.index;r<this.top.children.length;r++){const o=this.top.children[r];if(o?.getType()===Ln.NODE||o?.getType()===Ln.CUSTOM||o?.getType()===Ln.TEXT){const a=o,l=this.preMatch.matched.get(a);if(!U(l)&&l!==i)return!1;const c=a.dom;let h;const d=this.isLocked(c)&&!(t.isText&&a.node&&a.node.isText&&a.nodeDOM.nodeValue===t.text&&a.dirty!==zn.NODE_DIRTY&&Bn(e,a.outerDeco));if(!d&&Jn.update(a,this.view,t,e,n))return this.destroyBetween(this.index,r),a.dom!==c&&(this._changed=!0),this.index++,!0;if(!d&&(h=this.recreateWrapper(a,t,e,n,s)))return this.destroyBetween(this.index,r),this.top.children[this.index]=h,h.contentDOM&&(h.dirty=zn.CONTENT_DIRTY,Jn.updateChildren(h,this.view,s+1),h.dirty=zn.NOT_DIRTY),this._changed=!0,this.index++,!0;break}}return!1}addNode(t,e,n,i){const s=Yn.createNodeViewDesc(this.top,t,e,n,this.view,i);s.contentDOM&&Jn.updateChildren(s,this.view,i+1),this.top.children.splice(this.index++,0,s),this._changed=!0}placeWidget(t,e){const n=this.index<this.top.children.length?this.top.children[this.index]:null,i=n?.matchesWidget(t);let s=!1;if(i){const e=n;s=t===e.widget||!this.getWidgetParent(e)}if(s)this.index++;else{const n=Yn.createWidgetViewDesc(this.top,t,this.view,e);this.top.children.splice(this.index++,0,n),this._changed=!0}}addTextblockHacks(){let t=this.top.children[this.index-1],e=this.top;for(;t?.getType()===Ln.MARK;)e=t,t=e.children[e.children.length-1];if(!t){const t=document.createElement("br"),n=Yn.createTrailingHackViewDesc(e,[],t,null);e.children.push(n),this._changed=!0}}destroyBetween(t,e){if(t!==e){for(let n=t;n<e;n++)this.top.children[n].destroy();this.top.children.splice(t,e-t),this._changed=!0}}findKeepableMarks(t,e){const n=Math.min(e,t.length);let i=0;for(;i<n;){const n=this.doesMarkMatch(t[i],i,e),s=!j(t[i].type.spec.spanning);if(!n||!s)break;i++}return i}doesMarkMatch(t,e,n){return e===n-1?this.top.matchesMark(t):this.stack[e+1<<1].matchesMark(t)}popUnmatchedMarks(t,e){for(;t<e;)this.destroyRemaining(),this.top.dirty=zn.NOT_DIRTY,this.index=this.stack.pop(),this.top=this.stack.pop(),e--}pushNewMarks(t,e,n,i){let s=t;for(;s<e.length;){this.stack.push(this.top,this.index+1);const t=this.findReusableMarkDesc(e[s],i);t>=0?this.reuseMarkDesc(t):this.createNewMarkDesc(e[s],n),this.index=0,s++}}findReusableMarkDesc(t,e){let n=this.top.children.length;e<this.preMatch.index&&(n=Math.min(this.index+3,n));for(let i=this.index;i<n;i++){const e=this.top.children[i];if(e.matchesMark(t)&&!this.isLocked(e.dom))return i}return-1}reuseMarkDesc(t){t>this.index&&(this._changed=!0,this.destroyBetween(this.index,t)),this.top=this.top.children[this.index]}createNewMarkDesc(t,e){const n=Yn.createMarkViewDesc(this.top,t,e,this.view);this.top.children.splice(this.index,0,n),this.top=n,this._changed=!0}recreateWrapper(t,e,n,i,s){if(t.dirty||e.isAtom||!t.children.length||!t.node.content.eq(e.content)||!Bn(n,t.outerDeco)||!i.eq(t.innerDeco))return null;const r=Yn.createNodeViewDesc(this.top,e,n,i,this.view,s);if(r.contentDOM){r.children=t.children,t.children=[];for(const t of r.children)t.parent=r}return t.destroy(),r}getWidgetParent(t){const e=t.widget.type;return"function"==typeof e.toDOM?e.toDOM()?.parentNode:e.toDOM?.parentNode}isLocked(t){return this.lock&&(t===this.lock||1===t.nodeType&&t.contains(this.lock.parentNode))}findPreMatch(t,e){let n=e,i=n.children.length,s=t.childCount;const r=new Map,o=[];t:for(;s>0;){let a;for(;;)if(i){const t=n.children[i-1];if(t?.getType()!==Ln.MARK){a=t,i--;break}n=t,i=t.children.length}else{if(n===e)break t;i=n.parent.children.indexOf(n),n=n.parent}const l=a.node;if(l){if(l!==t.child(s-1))break;--s,r.set(a,s),o.push(a)}}return{index:s,matched:r,matches:o.reverse()}}},Jn=class t{viewDesc;view;constructor(t,e){this.viewDesc=t,this.view=e}static update(e,n,i,s,r){return new t(e,n).update(i,s,r)}static updateChildren(e,n,i){new t(e,n).updateChildren(i)}update(t,e,n){if(this.viewDesc.getType()===Ln.TEXT)return this.viewDesc.update(t,e,n,this.view);if(this.viewDesc.getType()===Ln.CUSTOM){const i=this.viewDesc;if(i.dirty===zn.NODE_DIRTY)return!1;if(i.spec.update&&(i.node.type===t.type||i.spec.multiType)){const s=i.spec.update(t,e,n);return s&&this.updateInner(t,e,n),s}if(!i.contentDOM&&!t.isLeaf)return!1}return!(this.viewDesc.dirty===zn.NODE_DIRTY||!t.sameMarkup(this.viewDesc.node)||(this.updateInner(t,e,n),0))}updateChildren(t){const e=this.viewDesc.node.inlineContent;let n=t;const i=this.view.composing?this.localCompositionInfo(t):null,s=i&&i.pos>-1?i:null,r=i&&i.pos<0,o=new Xn(this.viewDesc,s?.node,this.view);this.iterDeco(this.viewDesc.node,this.viewDesc.innerDeco,(t,i,s)=>{const r=t.spec;r.marks?o.syncToMarks(r.marks,e,i):t.type.side>=0&&!s&&o.syncToMarks(i===this.viewDesc.node.childCount?Q.none:this.viewDesc.node.child(i).marks,e,i),o.placeWidget(t,n)},(t,s,a,l)=>{let c;o.syncToMarks(t.marks,e,l),o.findNodeMatch(t,s,a,l)||r&&this.view.state.selection.from>n&&this.view.state.selection.to<n+t.nodeSize&&(c=o.findIndexWithChild(i.node))>-1&&o.updateNodeAt(t,s,a,c)||o.updateNextNode(t,s,a,l,n)||o.addNode(t,s,a,n),n+=t.nodeSize}),o.syncToMarks([],e,0),o.destroyRemaining(),this.viewDesc.node.isTextblock&&o.addTextblockHacks(),(o.changed||this.viewDesc.dirty===zn.CONTENT_DIRTY)&&(s&&this.protectLocalComposition(this.view,s),this.renderDescs(this.viewDesc.contentDOM,this.viewDesc.children,this.view),L.ios&&this.iosHacks(this.viewDesc.dom))}getDesc(t){const e=t.pmViewDesc;for(let n=e;n;n=n.parent)if(n===this.viewDesc)return e}localCompositionInfo(t){const{from:e,to:n}=this.view.state.selection;if(!this.view.state.selection.isTextSelection()||e<t||n>t+this.viewDesc.node.content.size)return null;const i=this.view.input.compositionNode;if(!i||!this.viewDesc.dom.contains(i.parentNode))return null;if(this.viewDesc.node.inlineContent){const s=i.nodeValue,r=this.findTextInFragment(this.viewDesc.node.content,s,e-t,n-t);return r<0?null:{node:i,pos:r,text:s}}return{node:i,pos:-1,text:""}}findTextInFragment(t,e,n,i){for(let s=0,r=0;s<t.childCount&&r<=i;){const o=t.child(s++),a=r;if(r+=o.nodeSize,!o.isText)continue;let l=o.text;for(;s<t.childCount;){const e=t.child(s++);if(r+=e.nodeSize,!e.isText)break;l+=e.text}if(r>=n){if(r>=i&&l.slice(i-e.length-a,i-a)===e)return i-e.length;const t=a<i?l.lastIndexOf(e,i-a-1):-1;if(t>=0&&t+e.length+a>=n)return a+t;if(n===i&&l.length>=i+e.length-a&&l.slice(i-a,i-a+e.length)===e)return i}}return-1}iterDeco(t,e,n,i){const s=e.locals(t);0!==s.length?this.iterDecoWithDecorations(t,e,s,n,i):this.iterDecoSimple(t,e,i)}iterDecoSimple(t,e,n){let i=0;for(let s=0;s<t.childCount;s++){const r=t.child(s);n(r,[],e.forChild(i,r),s),i+=r.nodeSize}}iterDecoWithDecorations(t,e,n,i,s){let r=0,o=0;const a=[];let l=null;for(let c=0;;){o=this.emitWidgetsAtPosition(n,r,o,c,l,i).newDecoIndex;const h=this.getNextChild(t,c,l);if(!h)break;({child:h.child,index:h.index}=h),h.isRest?l=null:c++,this.updateActiveDecorations(a,r),o=this.advanceToActiveDecorations(n,o,r,a);let d=r+h.child.nodeSize;if(h.child.isText){const t=this.splitTextNodeIfNeeded(h.child,r,d,n,o,a);h.child=t.child,d=t.end,l=t.restNode,t.wasSplit&&(h.index=-1)}else for(;o<n.length&&n[o].to<d;)o++;const u=this.getOuterDecorationsForChild(h.child,a);s(h.child,u,e.forChild(r,h.child),h.index),r=d}}emitWidgetsAtPosition(t,e,n,i,s,r){const o=[];for(;n<t.length&&t[n].to===e;){const e=t[n++];e.widget&&o.push(e)}if(0===o.length)return{newDecoIndex:n};o.length>1&&o.sort((t,e)=>t.type.side-e.type.side);for(const a of o)r(a,i,!!s);return{newDecoIndex:n}}getNextChild(t,e,n){return n?{child:n,index:-1,isRest:!0}:e<t.childCount?{child:t.child(e),index:e,isRest:!1}:null}updateActiveDecorations(t,e){for(let n=t.length-1;n>=0;n--)t[n].to<=e&&t.splice(n,1)}advanceToActiveDecorations(t,e,n,i){for(;e<t.length&&t[e].from<=n&&t[e].to>n;)i.push(t[e++]);return e}splitTextNodeIfNeeded(t,e,n,i,s,r){let o=n;s<i.length&&i[s].from<o&&(o=i[s].from);for(const a of r)a.to<o&&(o=a.to);return o<n?{child:t.cut(0,o-e),end:o,restNode:t.cut(o-e),wasSplit:!0}:{child:t,end:n,restNode:null,wasSplit:!1}}getOuterDecorationsForChild(t,e){return t.isInline&&!t.isLeaf?e.filter(t=>!t.inline):e.slice()}renderDescs(t,e,n){let i=t.firstChild,s=!1;for(const r of e){const e=r,o=e.dom;if(o.parentNode===t){for(;o!==i;)i=this.removeDOMNode(i),s=!0;i=i.nextSibling}else s=!0,t.insertBefore(o,i);if(e?.getType()===Ln.MARK){const s=i?i.previousSibling:t.lastChild;this.renderDescs(e.contentDOM,e.children,n),i=s?s.nextSibling:t.firstChild}}for(;i;)i=this.removeDOMNode(i),s=!0;s&&n.trackWrites===t&&n.clearTrackWrites()}removeDOMNode(t){const e=t.nextSibling;return t.parentNode.removeChild(t),e}iosHacks(t){if("UL"===t.nodeName||"OL"===t.nodeName){const e=t.style.cssText;t.style.cssText=e+"; list-style: square !important",window.getComputedStyle(t).listStyle,t.style.cssText=e}}protectLocalComposition(t,e){if(this.getDesc(e.node))return;let n=e.node;for(;n.parentNode!==this.viewDesc.contentDOM;n=n.parentNode){for(;n.previousSibling;)n.parentNode.removeChild(n.previousSibling);for(;n.nextSibling;)n.parentNode.removeChild(n.nextSibling);n.pmViewDesc&&(n.pmViewDesc=void 0)}const i=Yn.createCompositionViewDesc(this.viewDesc,n,e.node,e.text);t.input.compositionNodes.push(i),this.viewDesc.children=Un(this.viewDesc.children,e.pos,e.pos+e.text.length,t,i)}updateInner(t,e,n){if(this.viewDesc?.getType()===Ln.NODE||this.viewDesc?.getType()===Ln.CUSTOM||this.viewDesc?.getType()===Ln.TEXT){const i=this.viewDesc;i.updateInner(t,e,n),i.contentDOM&&this.updateChildren(i.posAtStart),i.dirty=zn.NOT_DIRTY}}};function Qn(t,e,n,i,s){Hn.applyOuterDeco(i,e,t);const r=new Hn(void 0,t,e,n,i,i,i);return r.contentDOM&&Jn.updateChildren(r,s,0),r}let Zn=class t{static nearestViewDesc(e,n){return t.nearestDesc(e,n,!1)}static nearestNodeViewDesc(e,n){return t.nearestDesc(e,n,!0)}static nearestDesc(t,e,n){let i=!0;for(let s=e;s;s=s.parentNode){const r=t.getDesc(s);let o;if(r&&(!n||r.node)){if(!i||!(o=r.nodeDOM)||(1===o.nodeType?o.contains(1===e.nodeType?e:e.parentNode):o===e))return r;i=!1}}}};function ti(t){const e=t.domSelectionRange();if(!e.anchorNode||!e.focusNode)return!1;try{const n=3===e.anchorNode.nodeType?e.anchorNode.parentNode:e.anchorNode,i=3===e.focusNode.nodeType?e.focusNode.parentNode:e.focusNode;return t.dom.contains(n)&&(t.editable||t.dom.contains(i))}catch(z){return!1}}function ei(t){return!(t.editable&&!t.hasFocus())&&ti(t)}function ni(t,e,n,i){return t.someProp("createSelectionBetween",i=>i(t,e,n))||He.textSelectionBetween(e,n,i)}function ii(t){return!(!t.focusNode||!t.anchorNode)&&Dn(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset)}function si(t,e=null){const n=t.domSelectionRange(),i=t.state.doc;if(!n.focusNode)return null;const s=t.docView.posFromDOM(n.focusNode,n.focusOffset,1);if(s<0)return null;const r=Zn.nearestViewDesc(t.docView,n.focusNode),o=0===r?.size,a=i.resolve(s);let l;ii(n)&&(l=function(t,e,n,i,s){if(!e)return;let r=e;for(;r&&!r.node;)r=r.parent;var o,a,l;if(r&&(o=r.node,a=r,l=t,o.isAtom&&He.isNodeSelectable(o)&&null!==a.parent&&(!o.isInline||!function(t,e,n){let i=0===e,s=e===Mn(t);for(;i||s;){if(t===n)return!0;const e=En(t);if(!(t=t.parentNode))return!1;i=i&&0===e,s=s&&e===Mn(t)}return!1}(l.focusNode,l.focusOffset,a.dom)))){const t=r.posBefore,e=n===t?i:s.resolve(t);return Qe.createNodeSelection(e)}}(n,r,s,a,i));const c=l?s:function(t,e,n){return e instanceof t.dom.ownerDocument.defaultView.Selection&&e.rangeCount>1?function(t,e,n){let i=n,s=n;for(let r=0;r<e.rangeCount;r++){const n=e.getRangeAt(r),o=t.docView.posFromDOM(n.startContainer,n.startOffset,1),a=t.docView.posFromDOM(n.endContainer,n.endOffset,-1);i=Math.min(i,o),s=Math.max(s,a)}return i<0||s<0?-1:s===t.state.selection.anchor?s:i}(t,e,n):t.docView.posFromDOM(e.anchorNode,e.anchorOffset,1)}(t,n,s);if(c<0)return null;const h=i.resolve(c);if(!l){l=ni(t,h,a,(d=t,u=a,p=o,"pointer"===e||d.state.selection.head<u.pos&&!p?1:-1))}var d,u,p;return l}function ri(t,e){if(e.isNodeSelection()){const n=t.docView.descAt(e.from);n!==t.lastSelectedViewDesc&&(oi(t),n&&n.selectNode(),t.lastSelectedViewDesc=n)}else oi(t)}function oi(t){t.lastSelectedViewDesc&&(t.lastSelectedViewDesc.parent&&t.lastSelectedViewDesc.deselectNode(),t.lastSelectedViewDesc=void 0)}function ai(t,e=!1){const n=t.state.selection;if(ri(t,n),li(t)){if(function(t,e){if(!L.chrome||e||!t.input.mouseDown?.allowDefault)return!1;const n=t.domSelectionRange(),i=t.domObserver.currentSelection;return n.anchorNode&&i.anchorNode&&Dn(n.anchorNode,n.anchorOffset,i.anchorNode,i.anchorOffset)}(t,e))return t.input.mouseDown.delayedSelectionSync=!0,void t.domObserver.setCurSelection();t.domObserver.disconnectSelection(),t.cursorWrapper?function(t){const e=t.domSelection();if(!e)return;const n=t.cursorWrapper.dom,i="IMG"===n.nodeName;if(i&&n.parentNode?e.collapse(n.parentNode,En(n)+1):e.collapse(n,0),L.ie&&L.ie_version<=11&&!i&&!t.state.selection.visible){const t=n;t.disabled=!0,t.disabled=!1}}(t):function(t,e,n){const{anchor:i,head:s}=e,r=(o=e,ci&&!o.isTextSelection()?function(t,e){const n={};return e.$from.parent.inlineContent||(n.from=hi(t,e.from)),e.empty||e.$to.parent.inlineContent||(n.to=hi(t,e.to)),Object.keys(n).length>0?n:null}(t,e):null);var o;t.docView.setSelection(i,s,t,n),r&&function(t){t.from&&ui(t.from),t.to&&ui(t.to)}(r),function(t,e){e.visible?t.dom.classList.remove("ProseMirror-hideselection"):(t.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&function(t){const e=t.dom.ownerDocument;e.removeEventListener("selectionchange",t.input.hideSelectionGuard);const n=t.domSelectionRange(),i=n.anchorNode,s=n.anchorOffset;t.input.hideSelectionGuard=()=>{const n=t.domSelectionRange();n.anchorNode===i&&n.anchorOffset===s||(e.removeEventListener("selectionchange",t.input.hideSelectionGuard),setTimeout(()=>{li(t)&&!t.state.selection.visible||t.dom.classList.remove("ProseMirror-hideselection")},20))},e.addEventListener("selectionchange",t.input.hideSelectionGuard)}(t))}(t,e)}(t,n,e),t.domObserver.setCurSelection(),t.domObserver.connectSelection()}}function li(t){return t.editable?t.hasFocus():ti(t)&&(document.activeElement?.contains(t.dom)??!1)}const ci=L.safari||L.chrome&&L.chrome_version<63;function hi(t,e){const{node:n,offset:i}=t.docView.domFromPos(e,0),s=i<n.childNodes.length?n.childNodes[i]:null,r=i>0?n.childNodes[i-1]:null,o=t=>null!==t&&1===t.nodeType&&"false"===t.contentEditable;if(L.safari&&o(s))return di(s);const a=!s||o(s),l=!r||o(r);if(a&&l){if(o(s))return di(s);if(o(r))return di(r)}}function di(t){return t.contentEditable="true",L.safari&&t.draggable&&(t.draggable=!1,t.wasDraggable=!0),t}function ui(t){t.contentEditable="false";const e=t;e.wasDraggable&&(t.draggable=!0,e.wasDraggable=void 0)}class pi{static EMPTY_DECORATION_WIDGET_OPTIONS={};compareObjs(t,e){if(t===e)return!0;for(const n in t)if(t[n]!==e[n])return!1;for(const n in e)if(!(n in t))return!1;return!0}}let fi=class{static createDecoration(t,e,n){return new bi(t,e,n)}},mi=class t extends pi{_spec;_attrs;constructor(e,n){super(),this._attrs=e,this._spec=n??t.EMPTY_DECORATION_WIDGET_OPTIONS}get attrs(){return this._attrs}get spec(){return this._spec}side=0;map(t,e,n,i){const s=t.map(e.from+i,this._spec.inclusiveStart?-1:1)-n,r=t.map(e.to+i,this._spec.inclusiveEnd?1:-1)-n;return s>=r?null:fi.createDecoration(s,r,this)}valid(t,e){return e.from<e.to}eq(e){return this===e||e instanceof t&&this.compareObjs(this._attrs,e.attrs)&&this.compareObjs(this._spec,e.spec)}static is(e){return e.type instanceof t}destroy(){}},gi=class t extends pi{_spec;_attrs;constructor(e,n){super(),this._attrs=e,this._spec=n??t.EMPTY_DECORATION_WIDGET_OPTIONS}get attrs(){return this._attrs}side=0;get spec(){return this._spec}map(t,e,n,i){const s=t.mapResult(e.from+i,1);if(s.deleted)return null;const r=t.mapResult(e.to+i,-1);return r.deleted||r.pos<=s.pos?null:fi.createDecoration(s.pos-n,r.pos-n,this)}valid(t,e){const{index:n,offset:i}=t.content.findIndex(e.from);if(i!==e.from)return!1;const s=t.maybeChild(n);return!U(s)&&!s.isText&&i+s.nodeSize===e.to}eq(e){return this===e||e instanceof t&&this.compareObjs(this._attrs,e.attrs)&&this.compareObjs(this._spec,e.spec)}destroy(){}},yi=class t extends pi{_spec;_side;_toDOM;constructor(e,n){super(),this._toDOM=e,this._spec=n??t.EMPTY_DECORATION_WIDGET_OPTIONS,this._side=this._spec.side??0}get toDOM(){return this._toDOM}get spec(){return this._spec}get side(){return this._side}map(t,e,n,i){const{pos:s,deleted:r}=t.mapResult(e.from+i,this._side<0?-1:1);return r?null:fi.createDecoration(s-n,s-n,this)}valid(){return!0}eq(e){return this===e||e instanceof t&&(!(!this._spec.key||this._spec.key!==e.spec.key)||this._toDOM===e.toDOM&&this.compareObjs(this._spec,e.spec))}destroy(t){this._spec.destroy&&this._spec.destroy(t)}},bi=class t{_from;_to;_type;constructor(t,e,n){this._from=t,this._to=e,this._type=n}get from(){return this._from}get to(){return this._to}get type(){return this._type}get spec(){return this._type.spec}get inline(){return this._type instanceof mi}get widget(){return this._type instanceof yi}static widget(e,n,i){return new t(e,e,new yi(n,i))}static inline(e,n,i,s){return new t(e,n,new mi(i,s))}static node(e,n,i,s){return new t(e,n,new gi(i,s))}copy(e,n){return new t(e,n,this.type)}eq(t,e=0){return this.type.eq(t.type)&&this._from+e===t.from&&this._to+e===t.to}map(t,e,n){return this.type.map(t,this,e,n)}},wi=class{static EMPTY_DECORATION_WIDGET_OPTIONS={};removeOverlap(t){let e=t;for(let n=0;n<e.length-1;n++){const i=e[n];if(i.from!==i.to)for(let s=n+1;s<e.length;s++){const r=e[s];if(r.from!==i.from){if(r.from<i.to){e===t&&(e=t.slice()),e[n]=i.copy(i.from,r.from),this.insertAhead(e,s,i.copy(r.from,i.to));break}break}r.to!==i.to&&(e===t&&(e=t.slice()),e[s]=r.copy(r.from,i.to),this.insertAhead(e,s+1,r.copy(i.to,r.to)))}}return e}insertAhead(t,e,n){let i=e;const s=(t,e)=>t.from-e.from||t.to-e.to;for(;i<t.length&&s(n,t[i])>0;)i++;t.splice(i,0,n)}static sortDecorations(t){return t.sort((t,e)=>t.from-e.from||t.to-e.to)}},vi=class t extends wi{static EMPTY_DECORATION_LIST=[];static EMPTY_DECORATIONSET_LIST=[];static CHILD_TOUCHED=-1;static CHILD_DELETED=-2;_local;_children;constructor(e,n){super(),this._local=e?.length?e:t.EMPTY_DECORATION_LIST,this._children=n?.length?n:t.EMPTY_DECORATIONSET_LIST}get local(){return this._local}get children(){return this._children}static create(e,n){return n.length?t.buildTree(n,e,0,t.EMPTY_DECORATION_WIDGET_OPTIONS):t.empty}find(t,e,n){const i=[];return this.findInner(U(t)?0:t,U(e)?1e9:e,i,0,n),i}findInner(t,e,n,i,s){for(const r of this._local)r.from<=e&&r.to>=t&&(!s||s(r.spec))&&n.push(r.copy(r.from+i,r.to+i));for(let r=0;r<this._children.length;r+=3)if(this._children[r]<e&&this._children[r+1]>t){const o=this._children[r]+1;this._children[r+2].findInner(t-o,e-o,n,i+o,s)}}map(e,n,i){return this===t.empty||0===e.maps.length?this:this.mapInner(e,n,0,0,i||t.EMPTY_DECORATION_WIDGET_OPTIONS)}mapInner(e,n,i,s,r){let o;for(const t of this._local){const a=t.map(e,i,s);a?.type.valid(n,a)?(o||(o=[]),o.push(a)):r.onRemove&&r.onRemove(t.spec)}return this._children.length?this.mapChildren(this._children,o||[],e,n,i,s,r):o?new t(t.sortDecorations(o),[]):t.empty}add(e,n){return n.length?this===t.empty?t.create(e,n):this.addInner(e,n,0):this}addInner(e,n,i){let s,r=0;e.forEach((e,o)=>{const a=o+i;let l;if(l=t.takeSpansForNode(n,e,a)){for(s||(s=this._children.slice());r<s.length&&s[r]<o;)r+=3;s[r]===o?s[r+2]=s[r+2].addInner(e,l,a+1):s.splice(r,0,o,o+e.nodeSize,t.buildTree(l,e,a+1,t.EMPTY_DECORATION_WIDGET_OPTIONS)),r+=3}});const o=t.moveSpans(r?t.withoutNulls(n):n,-i);for(let t=0;t<o.length;t++)o[t].type.valid(e,o[t])||o.splice(t--,1);if(o.length){const e=t.sortDecorations(this._local.concat(o));return new t(e,s||this._children)}return new t(this._local,s||this._children)}remove(e){return 0===e.length||this===t.empty?this:this.removeInner(e,0)}removeInner(e,n){let i=this._children,s=this._local;for(let r=0;r<i.length;r+=3){let s=null;const o=i[r]+n,a=i[r+1]+n;for(let t=0;t<e.length;t++){const n=e[t];n&&n.from>o&&n.to<a&&(e[t]=null,s||(s=[]),s.push(n))}if(!s)continue;i===this._children&&(i=this._children.slice());const l=i[r+2].removeInner(s,o+1);l!==t.empty?i[r+2]=l:(i.splice(r,3),r-=3)}if(s.length)for(const t of e)if(t)for(let e=0;e<s.length;e++)s[e].eq(t,n)&&(s===this._local&&(s=this._local.slice()),s.splice(e--,1));return i===this._children&&s===this._local?this:s.length||i.length?new t(s,i):t.empty}forChild(e,n){if(this===t.empty)return this;if(n.isLeaf)return t.empty;let i,s;for(let t=0;t<this._children.length;t+=3)if(this._children[t]>=e){this._children[t]===e&&(i=this._children[t+2]);break}const r=e+1,o=r+n.content.size;for(const t of this._local)if(t.from<o&&t.to>r&&t.type instanceof mi){const e=Math.max(r,t.from)-r,n=Math.min(o,t.to)-r;e<n&&(s||(s=[])).push(t.copy(e,n))}if(s){const e=t.sortDecorations(s),n=new t(e,[]);return i?new Ai([n,i]):n}return i||t.empty}eq(e){if(this===e)return!0;if(!(e instanceof t)||this._local.length!==e._local.length||this._children.length!==e._children.length)return!1;for(let t=0;t<this._local.length;t++)if(!this._local[t].eq(e.local[t]))return!1;for(let t=0;t<this._children.length;t+=3)if(this._children[t]!==e.children[t]||this._children[t+1]!==e.children[t+1]||!this._children[t+2].eq(e.children[t+2]))return!1;return!0}locals(t){return this.removeOverlap(this.localsInner(t))}localsInner(e){if(this===t.empty)return[];if(e.inlineContent||!this._local.some(t=>mi.is(t)))return this._local;const n=[];for(const t of this._local)t.type instanceof mi||n.push(t);return n}static empty=new t([],[]);forEachSet(t){t(this)}mapChildren(e,n,i,s,r,o,a){let l=e,c=!1,h=o;for(const u of i.maps){let n=0;u.forEach((i,s,r,o)=>{const a=o-r-(s-i);for(let d=0;d<l.length;d+=3){const r=l[d+1];if(r<0||i>r+h-n)continue;const o=l[d]+h-n;s>=o?(c||(l=e.slice(),c=!0),l[d+1]=i<=o?t.CHILD_DELETED:t.CHILD_TOUCHED):i>=h&&a&&(c||(l=e.slice(),c=!0),l[d]+=a,l[d+1]+=a)}n+=a}),h=u.map(h,-1)}let d=!1;for(let u=0;u<l.length;u+=3){const n=l[u+1];if(n>=0)continue;if(c||(l=e.slice(),c=!0),n===t.CHILD_DELETED){d=!0,l[u+1]=t.CHILD_TOUCHED;continue}const h=i.map(e[u]+o),p=h-r;if(p<0||p>=s.content.size){d=!0;continue}const f=i.map(e[u+1]+o,-1)-r,{index:m,offset:g}=s.content.findIndex(p),y=s.maybeChild(m);if(y&&g===p&&g+y.nodeSize===f){const n=l[u+2].mapInner(i,y,h+1,e[u]+o+1,a);n!==t.empty?(l[u]=p,l[u+1]=f,l[u+2]=n):(l[u+1]=t.CHILD_DELETED,d=!0)}else d=!0}if(d){const c=this.mapAndGatherRemainingDecorations(l,e,n,i,r,o,a),h=t.buildTree(c,s,0,a);n=h.local;for(let t=0;t<l.length;t+=3)l[t+1]<0&&(l.splice(t,3),t-=3);for(let t=0,e=0;t<h.children.length;t+=3){const n=h.children[t];for(;e<l.length&&l[e]<n;)e+=3;l.splice(e,0,h.children[t],h.children[t+1],h.children[t+2])}}return new t(t.sortDecorations(n),l)}static buildTree(e,n,i,s){const r=[];let o=!1;n.forEach((n,a)=>{const l=t.takeSpansForNode(e,n,a+i);if(l){o=!0;const e=this.buildTree(l,n,i+a+1,s);e!==t.empty&&r.push(a,a+n.nodeSize,e)}}),o&&(e=t.withoutNulls(e));const a=t.sortDecorations(t.moveSpans(e,-i));for(let t=0;t<a.length;t++)a[t].type.valid(n,a[t])||(s.onRemove&&s.onRemove(a[t].spec),a.splice(t--,1));return a.length||r.length?new t(a,r):t.empty}static moveSpans(t,e){if(!e||!t.length)return t;const n=[];for(const i of t)n.push(new bi(i.from+e,i.to+e,i.type));return n}gatherDecorationsFromSet(t,e,n,i,s,r){for(const o of t.local){const t=o.map(i,s,e);t?n.push(t):r.onRemove&&r.onRemove(o.spec)}for(let o=0;o<t.children.length;o+=3)this.gatherDecorationsFromSet(t.children[o+2],t.children[o]+e+1,n,i,s,r)}mapAndGatherRemainingDecorations(e,n,i,s,r,o,a){for(let l=0;l<e.length;l+=3)e[l+1]===t.CHILD_TOUCHED&&this.gatherDecorationsFromSet(e[l+2],n[l]+o+1,i,s,r,a);return i}static takeSpansForNode(t,e,n){if(e.isLeaf)return null;const i=n+e.nodeSize;let s=null;for(let r=0;r<t.length;r++){const e=t[r];e&&e.from>n&&e.to<i&&(s??=[],s.push(e),t[r]=null)}return s}static withoutNulls(t){const e=[];for(const n of t)null!==n&&e.push(n);return e}},Ai=class t extends wi{members;constructor(t){super(),this.members=t}map(e,n){const i=this.members.map(i=>i.map(e,n,t.EMPTY_DECORATION_WIDGET_OPTIONS));return t.from(i)}forChild(e,n){if(n.isLeaf)return vi.empty;let i=[];for(const s of this.members){const r=s.forChild(e,n);r!==vi.empty&&(r instanceof t?i=i.concat(r.members):i.push(r))}return t.from(i)}eq(e){if(!(e instanceof t)||e.members.length!==this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let n,i=!1;for(const t of this.members){const s=t.localsInner(e);if(s.length)if(n){i||(n=n.slice(),i=!0);for(const t of s)n.push(t)}else n=s}return n?(i&&t.sortDecorations(n),this.removeOverlap(n)):[]}static from(e){switch(e.length){case 0:return vi.empty;case 1:return e[0];default:{if(e.every(t=>t instanceof vi))return new t(e);const n=e.reduce((t,e)=>(e instanceof vi?t.push(e):t.push(...e.members),t),[]);return new t(n)}}}forEachSet(t){for(const e of this.members)e.forEachSet(t)}};function xi(t){const e=[];return t.someProp("decorations",n=>{const i=n(t.state);i&&i!==vi.empty&&e.push(i)}),t.cursorWrapper&&e.push(vi.create(t.state.doc,[t.cursorWrapper.deco])),Ai.from(e)}function Si(t,e){return new KeyboardEvent("keydown",{key:e,code:e,keyCode:t,bubbles:!0,cancelable:!0})}const _i=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|img|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function Ti(t){if(2!==t.length)return!1;const e=t.charCodeAt(0),n=t.charCodeAt(1);return e>=56320&&e<=57343&&n>=55296&&n<=56319}function Ei(t,e,n){let i=t.depth,s=e?t.end():t.pos;for(;i>0&&(e||t.indexAfter(i)===t.node(i).childCount);)i--,s++,e=!1;if(n){let e=t.node(i).maybeChild(t.indexAfter(i));for(;e&&!e.isLeaf;)e=e.firstChild,s++}return s}function Ci(t){const e=t.pmViewDesc;return e?e.parseRule():"BR"===t.nodeName&&t.parentNode?function(t){const e=t.parentNode;if(!e)return null;if(L.safari&&/^(ul|ol)$/i.test(e.nodeName)){const t=document.createElement("div");return t.appendChild(document.createElement("li")),{skipDiv:t}}return e.lastChild===t||L.safari&&/^(tr|table)$/i.test(e.nodeName)?{ignore:!0}:null}(t):"IMG"===t.nodeName&&t.getAttribute("mark-placeholder")?{ignore:!0}:null}function Mi(t,e,n){return Math.max(n.anchor,n.head)>e.content.size?null:ni(t,e.resolve(n.anchor),e.resolve(n.head))}function ki(t,e,n,i,s){const r=t.input.compositionPendingChanges||(t.composing?t.input.compositionID:0);if(t.input.compositionPendingChanges=0,e<0)return void function(t,e){const n=t.input.lastSelectionTime>Date.now()-50?t.input.lastSelectionOrigin:null,i=si(t,n);if(!i||t.state.selection.eq(i))return;if(s=t,L.chrome&&L.android&&"Enter"===s.input.lastKey&&Date.now()-100<s.input.lastKeyCodeTime&&s.someProp("handleKeyDown",t=>t(s,Si(13,"Enter"))))return;var s;const r=t.state.transaction.setSelection(i);"pointer"===n?r.setMeta("pointer",!0):"key"===n&&r.scrollIntoView(),e&&r.setMeta("composition",e),t.dispatch(r)}(t,r);const o=t.state.doc.resolve(e),a=o.sharedDepth(n),l=o.before(a+1),c=t.state.doc.resolve(n).after(a+1),h=t.state.selection,d=function(t,e,n){const i=t.docView.parseRange(e,n),s=i.node,r=i.fromOffset;let o=i.toOffset;const a=i.from,l=i.to,c=function(t){const e=t.domSelectionRange(),n=e.anchorNode;if(!n)return;const i=1===n.nodeType?n:n.parentNode;if(!i||!t.dom.contains(i))return;const s=[{node:n,offset:e.anchorOffset}];return ii(e)||s.push({node:e.focusNode,offset:e.focusOffset}),s}(t);o=function(t,e,n,i){if(!L.chrome||t.input.lastKey!==H)return i;const s=e.childNodes;for(let r=i;r>n;r--){const t=s[r-1],e=t.pmViewDesc;if("BR"===t.nodeName&&!e)return r;if(!e||e.size)break}return i}(t,s,r,o);const h=t.state.doc,d=t.someProp("domParser")||St.fromSchema(t.state.schema),u=h.resolve(a),p=d.parse(s,{topNode:u.parent,topMatch:u.parent.contentMatchAt(u.index()),topOpen:!0,from:r,to:o,preserveWhitespace:"pre"!==u.parent.type.whitespace||"full",findPositions:c,ruleFromNode:Ci,context:u}),f=function(t,e){if(U(t?.[0].pos))return null;const n=t[0].pos;return{anchor:n+e,head:(t[1]?.pos??n)+e}}(c,a);return{doc:p,sel:f,from:a,to:l}}(t,l,c),u=t.state.doc,p=u.slice(d.from,d.to),{preferredPos:f,preferredSide:m}=function(t){return t.input.lastKey===H&&Date.now()-100<t.input.lastKeyCodeTime?{preferredPos:t.state.selection.to,preferredSide:"end"}:{preferredPos:t.state.selection.from,preferredSide:"start"}}(t);t.input.lastKeyCode=null;let g=function(t,e,n,i,s){let r=t.findDiffStart(e,n);if(U(r))return null;const o=t.findDiffEnd(e,n+t.size,n+e.size);if("end"===s){const t=Math.max(0,r-Math.min(o.selfPos,o.otherPos));i-=o.selfPos+t-r}if(o.selfPos<r&&t.size<e.size){const t=i<=r&&i>=o.selfPos?r-i:0;r-=t,r&&r<e.size&&Ti(e.textBetween(r-1,r+1))&&(r+=t?1:-1),o.otherPos=r+(o.otherPos-o.selfPos),o.selfPos=r}else if(o.otherPos<r){const e=i<=r&&i>=o.otherPos?r-i:0;r-=e,r&&r<t.size&&Ti(t.textBetween(r-1,r+1))&&(r+=e?1:-1),o.selfPos=r+(o.selfPos-o.otherPos),o.otherPos=r}return{start:r,endA:o.selfPos,endB:o.otherPos}}(p.content,d.doc.content,d.from,f,m);if(g&&t.input.domChangeCount++,function(t,e,n){const i=L.ios&&t.input.lastIOSEnter>Date.now()-225||L.android,s=e.some(t=>1===t.nodeType&&!_i.test(t.nodeName)),r=!n||n.endA>=n.endB;return!!(i&&s&&r&&t.someProp("handleKeyDown",e=>e(t,Si(13,"Enter"))))}(t,s,g))return void(t.input.lastIOSEnter=0);if(!g){if(!function(t,e,n,i){return t&&e.isTextSelection()&&!e.empty&&e.$head.sameParent(e.$anchor)&&!n.composing&&!(i.sel&&i.sel.anchor!==i.sel.head)}(i,h,t,d)){if(d.sel){const e=Mi(t,t.state.doc,d.sel);if(e&&!e.eq(t.state.selection)){const n=t.state.transaction.setSelection(e);r&&n.setMeta("composition",r),t.dispatch(n)}}return}g={start:h.from,endA:h.to,endB:h.to}}(function(t,e){return t.state.selection.from<t.state.selection.to&&e.start===e.endB&&t.state.selection.isTextSelection()})(t,g)&&(function(t,e,n){return t.start>e.from&&t.start<=e.from+2&&e.from>=n}(g,t.state.selection,d.from)?g.start=t.state.selection.from:function(t,e,n){return t.endA<e.to&&t.endA>=e.to-2&&e.to<=n}(g,t.state.selection,d.to)&&(g.endB+=t.state.selection.to-g.endA,g.endA=t.state.selection.to)),function(t,e){return L.ie&&L.ie_version<=11&&t.endB===t.start+1&&t.endA===t.start&&t.start>e.from&&" "===e.doc.textBetween(t.start-e.from-1,t.start-e.from+1)}(g,d)&&(g.start--,g.endA--,g.endB--);const y=d.doc.resolveNoCache(g.start-d.from);let b=d.doc.resolveNoCache(g.endB-d.from);const w=u.resolve(g.start),v=y.sameParent(b)&&y.parent.inlineContent&&w.end()>=g.endA;if(function(t,e,n,i,s,r){const o=(l=t,c=s,h=r,L.ios&&l.input.lastIOSEnter>Date.now()-225&&(!c||h.some(t=>"DIV"===t.nodeName||"P"===t.nodeName))),a=!s&&n.pos<e.doc.content.size&&(!n.sameParent(i)||!n.parent.inlineContent)&&n.pos<i.pos&&!/\S/.test(e.doc.textBetween(n.pos,i.pos,"",""));var l,c,h;return!(!o&&!a||!t.someProp("handleKeyDown",e=>e(t,Si(13,"Enter"))))}(t,d,y,b,v,s))return t.input.lastIOSEnter=0,void t.domObserver.suppressSelectionUpdates();if(function(t,e,n,i,s){return!!(t.state.selection.anchor>n.start&&function(t,e,n,i,s){const r=n-e>s.pos-i.pos,o=Ei(i,!0,!1)>=s.pos;if(!r||!o)return!1;const a=t.resolve(e);if(!i.parent.isTextblock){const t=a.nodeAfter;return null!==t&&n===e+t.nodeSize}if(a.parentOffset!==a.parent.content.size||!a.parent.isTextblock)return!1;const l=t.resolve(Ei(a,!0,!0));return!!(l.parent.isTextblock&&l.pos<=n&&Ei(l,!0,!1)>=n)&&i.parent.content.cut(i.parentOffset).eq(l.parent.content)}(e,n.start,n.endA,i,s)&&t.someProp("handleKeyDown",e=>e(t,Si(8,"Backspace"))))}(t,u,g,y,b))return void(L.android&&L.chrome&&t.domObserver.suppressSelectionUpdates());L.chrome&&g.endB===g.start&&(t.input.lastChromeDelete=Date.now()),function(t,e,n,i,s){return L.android&&!n&&t.start()!==e.start()&&0===e.parentOffset&&t.depth===e.depth&&null!==i.sel&&i.sel.anchor===i.sel.head&&i.sel.head===s.endA}(y,b,v,d,g)&&(g.endB-=2,b=d.doc.resolveNoCache(g.endB-d.from),setTimeout(()=>{t.someProp("handleKeyDown",function(e){return e(t,Si(13,"Enter"))})},20));const A=g.start,x=g.endA;let S;if(v)if(y.pos===b.pos){L.ie&&L.ie_version<=11&&0===y.parentOffset&&(t.domObserver.suppressSelectionUpdates(),setTimeout(()=>{ai(t)},20));const e=Di(t,d,g,A,x,r,t.state.transaction.delete(A,x)),n=u.resolve(g.start).marksAcross(u.resolve(g.endA));n&&e.ensureMarks(n),t.dispatch(e)}else if(g.endA===g.endB&&(S=function(t,e){if(0===t.childCount||0===e.childCount)return null;const n=t.firstChild.marks,i=e.firstChild.marks;let s,r,o,a=n,l=i;for(const h of i)a=h.removeFromSet(a);for(const h of n)l=h.removeFromSet(l);if(1===a.length&&0===l.length)s=a[0],r="add",o=t=>t.mark(s.addToSet(t.marks));else{if(0!==a.length||1!==l.length)return null;s=l[0],r="remove",o=t=>t.mark(s.removeFromSet(t.marks))}const c=[];for(let h=0;h<e.childCount;h++)c.push(o(e.child(h)));return Z.from(c).eq(t)?{mark:s,type:r}:null}(y.parent.content.cut(y.parentOffset,b.parentOffset),w.parent.content.cut(w.parentOffset,g.endA-w.start())))){const e=Di(t,d,g,A,x,r,t.state.transaction);"add"===S.type?e.addMark(A,x,S.mark):e.removeMark(A,x,S.mark),t.dispatch(e)}else if(y.parent.child(y.index()).isText&&y.index()===b.index()-(b.textOffset?0:1)){const e=y.parent.textBetween(y.parentOffset,b.parentOffset),n=()=>Di(t,d,g,A,x,r,t.state.transaction.insertText(e,A,x));t.someProp("handleTextInput",i=>i(t,A,x,e,n))||t.dispatch(n())}else t.dispatch(Di(t,d,g,A,x,r));else t.dispatch(Di(t,d,g,A,x,r))}function Di(t,e,n,i,s,r,o){const a=e.doc.slice(n.start-e.from,n.endB-e.from),l=o||t.state.transaction.replace(i,s,a);if(e.sel){const r=Mi(t,l.doc,e.sel);r&&!function(t,e,n,i,s,r){const o=L.chrome&&t.composing&&e.empty&&(n.start!==n.endB||t.input.lastChromeDelete<Date.now()-100)&&(e.head===i||e.head===r.mapping.map(s)-1),a=L.ie&&e.empty&&e.head===i;return o||a}(t,r,n,i,s,l)&&l.setSelection(r)}return r&&l.setMeta("composition",r),l.scrollIntoView()}function Ii(t,e){const n=t.getClientRects();if(n.length){const t=n[e<0?0:n.length-1];if(Ni(t))return t}return Array.from(n).find(Ni)||t.getBoundingClientRect()}function Ni(t){return t.top<t.bottom||t.left<t.right}const Pi=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Oi(t,e,n){const{node:i,offset:s,atom:r}=t.docView.domFromPos(e,n<0?-1:1),o=L.webkit||L.gecko;if(3===i.nodeType){if(!o||!Pi.test(i.nodeValue)&&(n<0?s:s!==i.nodeValue.length)){let t=s,e=s,r=n<0?1:-1;return n<0&&!s?(e++,r=-1):n>=0&&s===i.nodeValue.length?(t--,r=1):n<0?t--:e++,Ri(Ii(On(i,t,e),r),r<0)}{let t=Ii(On(i,s,s),n);if(L.gecko&&s&&/\s/.test(i.nodeValue[s-1])&&s<i.nodeValue.length){const e=Ii(On(i,s-1,s-1),-1);if(e.top===t.top){const n=Ii(On(i,s,s+1),-1);if(n.top!==t.top)return Ri(n,n.left<e.left)}}return 0===t.top&&0===t.bottom&&s>0?(t=Ii(On(i,s-1,s),1),Ri(t,!1)):t}}if(!t.state.doc.resolve(e-(r||0)).parent.inlineContent){if(U(r)&&s&&(n<0||s===Mn(i))){const t=i.childNodes[s-1];if(1===t.nodeType)return Bi(t.getBoundingClientRect(),!1)}if(U(r)&&s<Mn(i)){const t=i.childNodes[s];if(1===t.nodeType)return Bi(t.getBoundingClientRect(),!0)}return Bi(i.getBoundingClientRect(),n>=0)}if(U(r)&&s&&(n<0||s===Mn(i))){const t=i.childNodes[s-1],e=3===t.nodeType?On(t,Mn(t)-(o?0:1)):1!==t.nodeType||"BR"===t.nodeName&&t.nextSibling?null:t;if(e){let n=Ii(e,1);if(0===n.top&&0===n.bottom&&3===t.nodeType){const e=t,i=Mn(e);if(i>1&&(n=Ii(On(e,i-1,i),1),(e.nodeValue||"").endsWith("\n"))){const t=n.bottom-n.top,i=Ii(On(e,0,1),-1);return{top:n.bottom,bottom:n.bottom+t,left:i.left,right:i.left}}}if(n.top===n.bottom&&1===t.nodeType){const e=t.getBoundingClientRect();e.top<e.bottom&&(n=e)}return Ri(n,!1)}}if(U(r)&&s<Mn(i)){let t=i.childNodes[s];for(;t?.pmViewDesc?.ignoreForCoords;)t=t.nextSibling;const e=t?3===t.nodeType?On(t,0,o?0:1):1===t.nodeType?t:null:null;if(e)return Ri(Ii(e,-1),!0)}return Ri(Ii(3===i.nodeType?On(i):i,-n),n>=0)}function Ri(t,e){if(0===t.width)return t;const n=e?t.left:t.right;return{top:t.top,bottom:t.bottom,left:n,right:n}}function Bi(t,e){if(0===t.height)return t;const n=e?t.top:t.bottom;return{top:n,bottom:n,left:t.left,right:t.right}}let Fi=null,Li=null,zi=!1;function Vi(t,e,n){return Fi===e&&Li===n?zi:(Fi=e,Li=n,zi="up"===n||"down"===n?function(t,e,n){const i=e.selection,s="up"===n?i.$from:i.$to;return function(e,i){const r=e.state,o=e.root.activeElement;r!==i&&e.updateState(i),o!==e.dom&&e.focus();try{return(()=>{let{node:e}=t.docView.domFromPos(s.pos,"up"===n?-1:1);for(;;){const n=Zn.nearestNodeViewDesc(t.docView,e);if(!n)break;if(n.node.isBlock){e=n.contentDOM||n.dom;break}e=n.dom.parentNode}const i=Oi(t,s.pos,1),r=i.top,o=i.bottom;for(let t=e.firstChild;t;t=t.nextSibling){let e;if(1===t.nodeType)e=t.getClientRects();else{if(3!==t.nodeType)continue;if(!t.nodeValue||0===t.nodeValue.length)continue;e=On(t,0,t.nodeValue.length).getClientRects()}const i=e.length;for(let t=0;t<i;t++){const i=e.item(t);if(i.bottom>i.top+1)if("up"===n){if(r-i.top>2*(i.bottom-r))return!1}else if(i.bottom-o>2*(o-i.top))return!1}}return!0})()}finally{r!==i&&e.updateState(r),o!==e.dom&&o&&o.focus()}}(t,e)}(t,e,n):function(t,e,n){const{$head:i}=e.selection;if(!i.parent.isTextblock)return!1;const s=i.parentOffset,r=!s,o=s===i.parent.content.size;if(!t.domSelection())return i.pos===i.start()||i.pos===i.end();return"rtl"===L.dir||"rtl"===t.dom.style.direction||"rtl"===globalThis.getComputedStyle(t.dom).direction?"right"===n||"backward"===n?r:o:"left"===n||"backward"===n?r:o}(t,e,n))}function Hi(t,e){for(const n of t){const{dom:t,top:i,left:s}=n;t.scrollTop!==i+e&&(t.scrollTop=i+e),t.scrollLeft!==s&&(t.scrollLeft=s)}}function $i(t){const e=[],n=t.ownerDocument;for(let i=t;i&&(e.push({dom:i,top:i.scrollTop||0,left:i.scrollLeft||0}),i!==n&&i!==n.documentElement);i=Nn(i));return e}let Ui=null;function Wi(t,e){return t.left>=e.left-1&&t.left<=e.right+1&&t.top>=e.top-1&&t.top<=e.bottom+1}const Gi=/^li$/i,ji=/^T(R|BODY|HEAD|FOOT)$/;function Ki(t,e){const n=t.dom.ownerDocument,i=function(t,e,n){const i=t;if(i.caretPositionFromPoint)try{const t=i.caretPositionFromPoint(e,n);if(t)return{node:t.offsetNode,offset:Math.min(Mn(t.offsetNode),t.offset)}}catch(s){}if(t.caretRangeFromPoint){const i=t.caretRangeFromPoint(e,n);if(i)return{node:i.startContainer,offset:Math.min(Mn(i.startContainer),i.startOffset)}}}(n,e.left,e.top);let s,r=i?i.node:void 0,o=i?i.offset:0,a=(t.root.elementFromPoint?t.root:n).elementFromPoint(e.left,e.top);if(!a||!t.dom.contains(1!==a.nodeType?a.parentNode:a)){const n=t.dom.getBoundingClientRect();if(!Wi(e,n))return null;if(a=qi(t.dom,e,n),!a)return null}if(L.safari)for(let c=a;r&&c;c=Nn(c))c.draggable&&(r=void 0);if(a=function(t,e){const n=t.parentNode;return n&&Gi.test(n.nodeName)&&e.left<t.getBoundingClientRect().left?n:t}(a,e),r){if(L.gecko&&1===r.nodeType&&(o=Math.min(o,r.childNodes.length),o<r.childNodes.length)){const t=r.childNodes[o];let n;"IMG"===t.nodeName&&(n=t.getBoundingClientRect()).right<=e.left&&n.bottom>e.top&&o++}let n;L.webkit&&o&&1===r.nodeType&&1===(n=r.childNodes[o-1]).nodeType&&"false"===n.contentEditable&&n.getBoundingClientRect().top>=e.top&&o--,r===t.dom&&o===r.childNodes.length-1&&1===r.lastChild?.nodeType&&e.top>r.lastChild.getBoundingClientRect().bottom?s=t.state.doc.content.size:0!==o&&1===r.nodeType&&"BR"===r.childNodes[o-1].nodeName||(s=function(t,e,n,i){let s=-1;for(let r=e,o=!1;r!==t.dom;){const e=Zn.nearestNodeViewDesc(t.docView,r);let n;if(!e)return null;if(1===e.dom.nodeType&&(e.node.isBlock&&e.parent||!e.contentDOM)&&((n=e.dom.getBoundingClientRect()).width||n.height)&&(e.node.isBlock&&e.parent&&!ji.test(e.dom.nodeName)&&(!o&&n.left>i.left||n.top>i.top?s=e.posBefore:(!o&&n.right<i.left||n.bottom<i.top)&&(s=e.posAfter),o=!0),!e.contentDOM&&s<0&&!e.node.isText))return(e.node.isBlock?i.top<(n.top+n.bottom)/2:i.left<(n.left+n.right)/2)?e.posBefore:e.posAfter;r=e.dom.parentNode}return s>-1?s:t.docView.posFromDOM(e,n,-1)}(t,r,o,e))}U(s)&&(s=function(t,e,n){const{node:i,offset:s}=Yi(e,n);let r=-1;if(1===i.nodeType&&!i.firstChild){const t=i.getBoundingClientRect();r=t.left!==t.right&&n.left>(t.left+t.right)/2?1:-1}return t.docView.posFromDOM(i,s,r)}(t,a,e));const l=Zn.nearestNodeViewDesc(t.docView,a);return{pos:s,inside:l?l.posAtStart-l.border:-1}}function qi(t,e,n){const i=t.childNodes.length;if(i&&n.top<n.bottom){const s=Math.max(0,Math.min(i-1,Math.floor(i*(e.top-n.top)/(n.bottom-n.top))-2));for(let n=s;;){const r=t.childNodes[n];if(1===r.nodeType){const t=r.getClientRects();for(let n=0;n<t.length;n++){const i=t.item(n);if(Wi(e,i))return qi(r,e,i)}}if((n=(n+1)%i)===s)break}}return t}function Yi(t,e){let n,i,s,r,o=2e8,a=0,l=e.top,c=e.top,h=t.firstChild;for(let d=0;h;h=h.nextSibling,d++){const t=Xi(h);if(t)for(let u=0;u<t.length;u++){const p=t.item(u);if(p.top<=l&&p.bottom>=c){l=Math.max(p.bottom,l),c=Math.min(p.top,c);const t=Ji(e,p);if(t<o){n=h,o=t,i=e,t&&3===n.nodeType&&(i={left:p.right<e.left?p.right:p.left,top:e.top}),1===h.nodeType&&t&&(a=d+(e.left>=(p.left+p.right)/2?1:0));continue}}else p.top>e.top&&!s&&p.left<=e.left&&p.right>=e.left&&(s=h,r={left:Math.max(p.left,Math.min(p.right,e.left)),top:p.top});!n&&(e.left>=p.right&&e.top>=p.top||e.left>=p.left&&e.top>=p.bottom)&&(a=d+1)}}return!n&&s&&(n=s,i=r,o=0),3===n?.nodeType?function(t,e){const n=t.nodeValue.length,i=document.createRange();let s;if(n>20){let r=0,o=n,a=0,l=1/0;for(;r<o;){const c=Math.floor((r+o)/2);i.setStart(t,c),i.setEnd(t,Math.min(c+1,n));const h=Ii(i,1);if(h.top===h.bottom&&c<n-1){r=c+1;continue}if(Wi(e,h)){s={node:t,offset:c+(e.left>=(h.left+h.right)/2?1:0)};break}const d=Math.abs(e.left-h.left);d<l&&(l=d,a=c),e.left<h.left?o=c:r=c+1}if(!s&&a<n){i.setStart(t,a),i.setEnd(t,a+1);const n=Ii(i,1);s={node:t,offset:a+(e.left>=(n.left+n.right)/2?1:0)}}}else for(let r=0;r<n;r++){i.setEnd(t,r+1),i.setStart(t,r);const n=Ii(i,1);if(n.top!==n.bottom&&Wi(e,n)){s={node:t,offset:r+(e.left>=(n.left+n.right)/2?1:0)};break}}return i.detach(),s||{node:t,offset:0}}(n,i):!n||o&&1===n.nodeType?{node:t,offset:a}:Yi(n,i)}function Xi(t){return 1===t.nodeType?t.getClientRects():3===t.nodeType?On(t).getClientRects():null}function Ji(t,e){return e.left>t.left?e.left-t.left:e.right<t.left?t.left-e.right:0}const Qi=/^(fixed|sticky)$/;function Zi(t,e,n){const i=t.someProp("scrollThreshold")||0,s=t.someProp("scrollMargin")||5,r=t.dom.ownerDocument;let o=e;for(let a=n||t.dom;a;){if(1!==a.nodeType){a=Nn(a);continue}const t=a,e=t===r.body,n=e?ts(r):es(t),{moveX:l,moveY:c}=ns(o,n,i,s);if(l||c)if(e)r.defaultView&&r.defaultView.scrollBy(l,c);else{const e=t.scrollLeft,n=t.scrollTop;c&&(t.scrollTop+=c),l&&(t.scrollLeft+=l),o=ss(o,t.scrollLeft-e,t.scrollTop-n)}const h=e?"fixed":getComputedStyle(t).position;if(Qi.test(h))break;a="absolute"===h?t.offsetParent:Nn(a)}}function ts(t){const e=t.defaultView?.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:t.documentElement?.clientWidth||0,top:0,bottom:t.documentElement?.clientHeight||0}}function es(t){const e=t.getBoundingClientRect(),n=t.offsetWidth?e.width/t.offsetWidth:1,i=t.offsetHeight?e.height/t.offsetHeight:1;return{left:e.left,right:e.left+t.clientWidth*n,top:e.top,bottom:e.top+t.clientHeight*i}}function ns(t,e,n,i){let s=0,r=0;return t.top<e.top+is(n,"top")?r=-(e.top-t.top+is(i,"top")):t.bottom>e.bottom-is(n,"bottom")&&(r=t.bottom-t.top>e.bottom-e.top?t.top+is(i,"top")-e.top:t.bottom-e.bottom+is(i,"bottom")),t.left<e.left+is(n,"left")?s=-(e.left-t.left+is(i,"left")):t.right>e.right-is(n,"right")&&(s=t.right-e.right+is(i,"right")),{moveX:s,moveY:r}}function is(t,e){return"number"==typeof t?t:t[e]}function ss(t,e,n){return{left:t.left-e,top:t.top-n,right:t.right-e,bottom:t.bottom-n}}function rs(t,e,n,i){if(U(e))return{found:!1,from:-1,to:-1};const s=function(t,e){const n=t.parent;if(!n.isTextblock)return null;const i=t.start(),s=t.parentOffset;let r=0,o=null,a=null,l=!1;for(let c=0;c<n.childCount;c++){const t=n.child(c),h=r,d=r+t.nodeSize;if(void 0!==e.isInSet(t.marks))o??=i+h,a=i+d,s>=h&&s<=d&&(l=!0);else{if(l&&null!==o&&null!==a)return{from:o,to:a};o=null,a=null,l=!1}r=d}return l&&null!==o&&null!==a?{from:o,to:a}:null}(e,n);if(s){const n=t.textBetween(s.from,s.to,"");return i&&!ls(n)?{found:!1,from:e.pos,to:e.pos}:{found:!0,from:s.from,to:s.to,char:n,fromMark:!0}}const r=t.textBetween(Math.max(0,e.pos-1),e.pos,"");if(r&&(i?ls(r):!cs(r)))return{found:!0,from:e.pos-1,to:e.pos,char:r};const o=t.textBetween(e.pos,Math.min(t.content.size,e.pos+1),"");return o&&(i?ls(o):!cs(o))?{found:!0,from:e.pos,to:e.pos+1,char:o}:{found:!1,from:e.pos,to:e.pos}}const os=/\s+$/,as=/^\d+$/;function ls(t){return as.test(t)}function cs(t){return os.test(t)}function hs(t,e=Tn.marks.link,n=Tn.nodes.file){return(i,s)=>{if(!e)return!1;const{selection:r,doc:o}=i;if(!r.isTextSelection())return!1;let{from:a,to:l}=r;const c=r.$cursor;if(c&&n){const e="Backspace"===t?c.nodeBefore:c.nodeAfter;if(e?.type===n){if(s){const n=i.transaction;"Backspace"===t?n.delete(c.pos-e.nodeSize,c.pos):n.delete(c.pos,c.pos+e.nodeSize),s(n)}return!0}}const h="Backspace"===t?-1:1;if(!e.isInSet(o.resolve(r.from+h).marks()))return!1;const d=rs(o,r.$cursor,e,!1);return!(!d.found||!d.fromMark)&&(a=d.from,l=d.to,s&&s(i.transaction.removeMark(a,l,e)),!0)}}function ds(t,e=Tn.nodes.code_block){return sn(t,e)}const us=/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b[-a-zA-Z0-9()@:%_+.~#?&/=]*$/i,ps=/(^|\s)https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b[-a-zA-Z0-9()@:%_+.~#?&/=]*$/i;function fs(t,e=Tn.marks.link,n=Tn.nodes.code_block){return(i,s)=>{if(!e)return!1;const{selection:r}=i;if(!r.isTextSelection())return!1;const{$from:o,from:a}=r;if(e.isInSet(o.marks())||o.marks().length>1)return!1;if(ds(i,n))return!1;const l=o.start(),c=function(t,e){if("Enter"===e)return us.test(t)?t:null;const n=ps.exec(t);return n?n[0].trim():null}(i.doc.textBetween(l,a,""),t);if(!c)return!1;const h="Enter"===t?l:a-c.length;if(s){const n=e.create({href:c,title:c,target:"_blank"}),r="Enter"===t?"\n":" ";s(i.transaction.addMark(h,a,n).insertText(r))}return"Enter"===t}}const ms=(t,e)=>!t.selection.empty&&(e&&e(t.transaction.deleteSelection().scrollIntoView()),!0);function gs(t,e){const{$cursor:n}=t.selection;return n&&(e?e.endOfTextblock("backward",t):0===n.parentOffset)?n:null}function ys(t){if(t.parent.type.spec.isolating)return null;for(let e=t.depth-1;e>=0;e--){if(t.index(e)>0)return t.doc.resolve(t.before(e+1));if(t.node(e).type.spec.isolating)break}return null}function bs(t){if(t.parent.type.spec.isolating)return null;for(let e=t.depth-1;e>=0;e--){const n=t.node(e);if(t.index(e)+1<n.childCount)return t.doc.resolve(t.after(e+1));if(n.type.spec.isolating)break}return null}function ws(t,e,n=!1){let i=t;for(;i;){if(i.isTextblock)return!0;if(n&&1!==i.childCount)return!1;i="start"===e?i.firstChild:i.lastChild}return!1}function vs(t,e,n,i){const s=e.nodeBefore,r=e.nodeAfter;if(!s||!r)return!1;const o=s.type.spec.isolating||r.type.spec.isolating;if(!o&&function(t,e,n){const i=e.nodeBefore,s=e.nodeAfter,r=e.index();if(!i||!s||!i.type.compatibleContent(s.type))return!1;if(0===i.content.size&&e.parent.canReplace(r-1,r)){if(n){const s=e.pos-i.nodeSize,r=e.pos;n(t.transaction.delete(s,r).scrollIntoView())}return!0}return!(!e.parent.canReplace(r,r+1)||!s.isTextblock&&!Ot(t.doc,e.pos)||(n&&n(t.transaction.join(e.pos).scrollIntoView()),0))}(t,e,n))return!0;const a=!o&&e.parent.canReplace(e.index(),e.index()+1);return!(!a||!function(t,e,n,i,s){const r=n.contentMatchAt(n.childCount),o=r?.findWrapping(i.type);if(!o||!r?.matchType(o[0]||i.type)?.validEnd)return!1;if(s){const r=e.pos+i.nodeSize;let a=Z.empty;for(let t=o.length-1;t>=0;t--)a=Z.from(o[t].create(null,a));a=Z.from(n.copy(a));const l=new ee(e.pos-1,r,e.pos,r,new tt(a,1,0),o.length,!0),c=t.transaction.step(l),h=c.doc.resolve(r+2*o.length);h.nodeAfter?.type===n.type&&Ot(c.doc,h.pos)&&c.join(h.pos),s(c.scrollIntoView())}return!0}(t,e,s,r,n))||!!function(t,e,n,i,s,r){if(n.type.spec.isolating||i>0&&s)return!1;const o=He.findFrom(e,1);if(!o)return!1;const a=o.$from.blockRange(o.$to),l=a&&Ie(a);return!(U(l)||l<e.depth||(r&&r(t.transaction.lift(a,l).scrollIntoView()),0))}(t,e,r,i,o,n)||!(!a||!function(t,e,n,i,s){if(!ws(i,"start",!0)||!ws(n,"end"))return!1;const r=[];let o=n;for(;o&&(r.push(o),!o.isTextblock);){const t=o.lastChild;if(!t)return!1;o=t}let a=i,l=1;for(;a&&!a.isTextblock;){const t=a.firstChild;if(!t)return!1;a=t,l++}const c=r[r.length-1];if(!c.canReplace(c.childCount,c.childCount,a.content))return!1;if(s){let n=Z.empty;for(let t=r.length-1;t>=0;t--)n=Z.from(r[t].copy(n));const o=new ee(e.pos-r.length,e.pos+i.nodeSize,e.pos+l,e.pos+i.nodeSize-l,new tt(n,r.length,0),0,!0);s(t.transaction.step(o).scrollIntoView())}return!0}(t,e,s,r,n))}function As(...t){return(e,n,i)=>{for(const s of t)if(s(e,n,i))return!0;return!1}}const xs=As(ms,(t,e,n)=>{const i=gs(t,n);if(!i)return!1;const s=i.parent;if(!s.isTextblock)return!1;const r=i.depth;if(r<2)return!1;if(0!==i.index(r-1))return!1;const o=i.index(r-2);if(0===o)return!1;const a=i.node(r-2),l=a.child(o-1),c=l.lastChild;if(!c?.isTextblock)return!1;if(!c.canReplace(c.childCount,c.childCount,s.content))return!1;if(!e)return!0;let h=i.start(r-2);for(let y=0;y<o-1;y++)h+=a.child(y).nodeSize;let d=h+1;for(let y=0;y<l.childCount-1;y++)d+=l.child(y).nodeSize;const u=d+1+c.content.size,p=i.start(r),f=t.schema.text(" "),m=t.transaction.replaceWith(u,p,f),g=u+1;return m.setSelection(Qe.createTextSelection(m.doc,g)),e(m.scrollIntoView()),!0},(t,e,n)=>{const i=gs(t,n);if(!i)return!1;const s=ys(i);if(!s)return function(t,e,n){const i=e.blockRange(),s=i&&Ie(i);return!U(s)&&(n&&n(t.transaction.lift(i,s).scrollIntoView()),!0)}(t,i,e);const r=s.nodeBefore;return!!r&&(!!vs(t,s,e,-1)||!!function(t,e,n,i,s){if(0!==e.parent.content.size)return!1;if(!ws(i,"end")&&!He.isNodeSelectable(i))return!1;for(let r=e.depth;;r--){const o=e.before(r),a=e.after(r),l=ve(t.doc,o,a,tt.empty);if(l&&l.slice.size<l.to-l.from){if(s){const e=t.transaction.step(l);if(ws(i,"end")){const t=e.mapping.map(n.pos,-1);e.setSelection(He.findFrom(e.doc.resolve(t),-1))}else e.setSelection(Qe.createNodeSelection(e.doc,n.pos-i.nodeSize));s(e.scrollIntoView())}return!0}if(1===r||e.node(r-1).childCount>1)break}return!1}(t,i,s,r,e)||function(t,e,n,i,s){if(!i.isAtom||n.depth!==e.depth-1)return!1;if(s){const e=n.pos-i.nodeSize,r=n.pos;s(t.transaction.delete(e,r).scrollIntoView())}return!0}(t,i,s,r,e))},(t,e,n)=>{const{$head:i,empty:s}=t.selection;if(!s)return!1;if(o=n,a=t,(r=i).parent.isTextblock&&!(o?o.endOfTextblock("backward",a):0===r.parentOffset))return!1;var r,o,a;const l=i.parent.isTextblock?ys(i):i,c=l?.nodeBefore;if(!c||!He.isNodeSelectable(c))return!1;if(e&&l){const n=l.pos-c.nodeSize;e(t.transaction.setSelection(Qe.createNodeSelection(t.doc,n)).scrollIntoView())}return!0});const Ss=As(ms,(t,e,n)=>{const i=function(t,e){const{$cursor:n}=t.selection;return n&&(e?e.endOfTextblock("forward",t):n.parentOffset>=n.parent.content.size)?n:null}(t,n);if(!i)return!1;const s=bs(i);if(!s)return!1;const r=s.nodeAfter;return!(!r||!vs(t,s,e,1)&&!function(t,e,n,i,s){if(0!==e.parent.content.size)return!1;if(!ws(i,"start")&&!He.isNodeSelectable(i))return!1;const r=ve(t.doc,e.before(),e.after(),tt.empty);if(!r||r.slice.size>=r.to-r.from)return!1;if(s){const e=t.transaction.step(r),o=e.mapping.map(n.pos);ws(i,"start")?e.setSelection(He.findFrom(e.doc.resolve(o),1)):e.setSelection(Qe.createNodeSelection(e.doc,o)),s(e.scrollIntoView())}return!0}(t,i,s,r,e)&&!function(t,e,n,i,s){if(!i.isAtom||n.depth!==e.depth-1)return!1;if(s){const e=n.pos,r=n.pos+i.nodeSize;s(t.transaction.delete(e,r).scrollIntoView())}return!0}(t,i,s,r,e))},(t,e,n)=>{const{$head:i,empty:s}=t.selection;if(!s)return!1;if(o=n,a=t,(r=i).parent.isTextblock&&!(o?o.endOfTextblock("forward",a):r.parentOffset>=r.parent.content.size))return!1;var r,o,a;const l=i.parent.isTextblock?bs(i):i,c=l?.nodeAfter;return!(!c||!He.isNodeSelectable(c)||(e&&l&&e(t.transaction.setSelection(Qe.createNodeSelection(t.doc,l.pos)).scrollIntoView()),0))}),_s=(t,e)=>{const{$head:n,$anchor:i}=t.selection;if(r=i,!(s=n).parent.type.spec.code||!s.sameParent(r))return!1;var s,r;const o=n.node(-1),a=n.indexAfter(-1),l=function(t){for(let e=0;e<t.edgeCount;e++){const{type:n}=t.edge(e);if(n.isTextblock&&!n.hasRequiredAttrs())return n}return null}(o.contentMatchAt(a));if(!l||!o.canReplaceWith(a,a,l))return!1;if(e){const i=n.after(),s=l.createAndFill(),r=t.transaction.replaceWith(i,i,s);r.setSelection(He.near(r.doc.resolve(i),1)),e(r.scrollIntoView())}return!0};function Ts(t){return(e,n)=>(n&&n(e.tr.replaceSelectionWith(t.create()).scrollIntoView()),!0)}const Es=(t,e)=>{const{$from:n,$to:i}=t.selection,s=n.blockRange(i),r=s&&Ie(s);return!U(r)&&(e&&e(t.transaction.lift(s,r).scrollIntoView()),!0)};function Cs(t,e){return t.dispatch(t.state.transaction.setSelection(e).scrollIntoView()),!0}function Ms(t,e){const{$anchor:n,$head:i}=t.selection,s=e>0?n.max(i):n.min(i);if(!s.parent.inlineContent)return He.findFrom(s,e);if(s.depth){const n=e>0?s.after():s.before(),i=t.doc.resolve(n);return He.findFrom(i,e)}return null}function ks(t,e,n){return Is(n,V.Backward,n.input)}function Ds(t,e,n){return Is(n,V.Forward,n.input)}function Is(t,e,n){const i=t.state,s=i.selection;if(s.isTextSelection())return function(t,e,n,i){if(i.shiftKey)return function(t,e,n){const{$head:i}=e;if(i.textOffset)return!1;const s=n===V.Backward?i.nodeBefore:i.nodeAfter;if(!s||s.isText||!s.isLeaf)return!1;const r=i.pos+s.nodeSize*(n===V.Backward?-1:1),o=t.state.doc.resolve(r);return Cs(t,Qe.createTextSelection(e.$anchor,o))}(t,e,n);if(!e.empty)return!1;if(t.endOfTextblock(n===V.Forward?"forward":"backward")){const e=Ms(t.state,n);return!!e?.isNodeSelection()&&Cs(t,e)}return(!L.mac||!i.metaKey)&&function(t,e,n){if(e.textOffset)return!1;const i=n===V.Backward?e.nodeBefore:e.nodeAfter;if(!i||i.isText)return!1;const s=n===V.Backward?e.pos-i.nodeSize:e.pos,r=t.docView.descAt(s);if(!(i.isAtom||r&&!r.contentDOM))return!1;if(He.isNodeSelectable(i)){const s=n===V.Backward?t.state.doc.resolve(e.pos-i.nodeSize):e;return Cs(t,Qe.createNodeSelection(s))}if(L.webkit){const e=n===V.Backward?s:s+i.nodeSize;return Cs(t,Qe.createTextSelection(t.state.doc.resolve(e)))}return!1}(t,e.$head,n)}(t,s,e,n);if(s.isNodeSelection()&&s.node.isInline){const n=e===V.Forward?s.$to:s.$from;return Cs(t,Qe.createTextSelection(n))}const r=Ms(i,e);return!!r&&Cs(t,r)}const Ns=Os(-1),Ps=Os(1);function Os(t){return(e,n)=>{const i=e.selection,s=t<0?i.$from:i.$to,r=function(t){let e=t.depth;for(;t.node(e).isInline;){if(0===e)return null;e--}return t.node(e).isTextblock?e:null}(s);if(U(r))return!1;if(n){const i=t<0?s.start(r):s.end(r),o=Qe.createTextSelection(e.doc,i);n(e.transaction.setSelection(o))}return!0}}function Rs(t,e,n){return Fs(n,V.Up,n.input)}function Bs(t,e,n){return Fs(n,V.Down,n.input)}function Fs(t,e,n){const i=t.state,s=i.selection;if(s.isTextSelection()&&!s.empty||n.shiftKey)return!1;if(L.mac&&n.metaKey)return!1;const{$from:r,$to:o}=s;if(!r.parent.inlineContent||t.endOfTextblock(e===V.Up?"up":"down")){const n=Ms(i,e);if(n?.isNodeSelection())return Cs(t,n)}if(!r.parent.inlineContent){const n=e===V.Up?r:o,i=s.isAllSelection()?He.near(n,e):He.findFrom(n,e);return!!i&&Cs(t,i)}return!1}function Ls(t,e,...n){return(i,s,r)=>{const{from:o,to:a}=i.selection;if(n&&n.length>0){const r=i.doc.resolve(o);let a=null;for(let e=0;e<=r.depth;e++){const i=r.node(e);if(n.includes(i.type)&&i.type.spec.attrs?.[t]){a=e;break}}if(null!==a){const n=r.node(a);if(n.attrs[t]===e)return!1;if(!s)return!0;const o=i.transaction,l=r.before(a);return o.setNodeMarkup(l,void 0,{...n.attrs,[t]:e},n.marks),s(o),!0}}let l=!1;if(i.doc.nodesBetween(o,a,n=>!(!n.isText&&n.type.spec.attrs?.[t]&&n.attrs[t]!==e&&(l=!0,1))),!l)return!1;if(!s)return!0;const c=i.transaction,h=zs(i.doc.content,t,e,o,a);if(h===i.doc.content)return!1;c.replace(0,i.doc.content.size,new tt(h,0,0));const d=Math.min(o,c.doc.content.size),u=Math.min(a,c.doc.content.size);try{c.setSelection(Je.create(c.doc,d,u))}catch(p){}return s(c),!0}}function zs(t,e,n,i,s){let r=!1;const o=[];let a=0;for(let l=0;l<t.childCount;l++){const c=t.child(l),h=a+c.nodeSize;if(h>i&&a<s){const t=a+1,l=Vs(c,e,n,Math.max(0,i-t),Math.max(0,Math.min(c.content.size,s-t)));l!==c&&(r=!0),o.push(l)}else o.push(c);a=h}return r?Z.from(o):t}function Vs(t,e,n,i,s){const r=!t.isText&&t.type.spec.attrs?.[e]&&t.attrs[e]!==n;let o=t.content;if(t.content.size>0&&s>0&&(o=zs(t.content,e,n,i,s)),!r&&o===t.content)return t;if(r){const i={...t.attrs,[e]:n};return t.type.create(i,o,t.marks)}return t.copy(o)}function Hs(t,e=null){return(n,i)=>{if(!i)return function(t,e,n){for(const i of t.selection.ranges){const{$from:{pos:s},$to:{pos:r}}=i;let o=!1;if(t.doc.nodesBetween(s,r,(i,s)=>!(o||Us(i,e,n,t,s)&&(o=!0,1))),o)return!0}return!1}(n,t,e);const s=function(t,e,n){let i=0,s=!1,r=!1,o=!1;for(const a of t.selection.ranges){if(o)break;const{$from:{pos:l},$to:{pos:c}}=a;t.doc.nodesBetween(l,c,(a,l)=>!(o||Us(a,e,n,t,l)&&(s=!0,i++,i<=10&&!r&&Ws(a,e)&&(r=!0),i>=50&&!r)&&(o=!0,1)))}return{hasConvertible:s,count:i,needsComplexHandling:r}}(n,t,e);if(!s.hasConvertible)return!1;const{from:r,to:o}=n.selection,a=n.transaction;if(s.count>=50&&!s.needsComplexHandling)!function(t,e,n,i,s,r){const o=new Map;if(t.doc.nodesBetween(s,r,(e,s)=>!(e.isTextblock&&!e.hasMarkup(n,i)&&Us(e,n,i,t,s)&&(o.set(s,{attrs:i,marks:e.marks}),1))),0===o.size)return!1;const a=$s(t.doc.content,n,o,0);if(a!==t.doc.content){e.replace(0,t.doc.content.size,new tt(a,0,0));const n=Math.min(s,e.doc.content.size),i=Math.min(r,e.doc.content.size);try{e.setSelection(Je.create(e.doc,n,i))}catch(l){}}}(n,a,t,e,r,o);else for(const l of n.selection.ranges)a.setBlockType(l.$from.pos,l.$to.pos,t,e);return i(a.scrollIntoView()),console.log(a.getUpdated()),a.getUpdated()>0}}function $s(t,e,n,i){let s=!1;const r=[];let o=i;for(let a=0;a<t.childCount;a++){const i=t.child(a),l=o,c=n.get(l);if(c){const t=e.create(c.attrs,i.content,c.marks);r.push(t),s=!0}else if(i.content.size>0&&!i.isTextblock){const t=$s(i.content,e,n,o+1);t!==i.content?(r.push(i.copy(t)),s=!0):r.push(i)}else r.push(i);o+=i.nodeSize}return s?Z.from(r):t}function Us(t,e,n,i,s){if(!t.isTextblock)return!1;if(t.hasMarkup(e,n))return!1;if(t.type===e)return!0;const r=i.doc.resolve(s),o=r.index();return r.parent.canReplaceWith(o,o+1,e)}function Ws(t,e){let n=!1;if(t.forEach(t=>{for(const i of t.marks)e.allowsMarkType(i.type)||(n=!0)}),n)return!0;if(!e.validContent(t.content))return!0;if("pre"!==e.whitespace){let e=!1;if(t.forEach(t=>{t.isText&&t.text&&/[\r\n]/.test(t.text)&&(e=!0)}),e)return!0}return!1}function Gs(t,e,n){const i=n.domSelectionRange();if(!i)return!1;let s,r,o=i.focusNode,a=i.focusOffset;if(!o)return!1;let l=!1;for(L.gecko&&1===o.nodeType&&a<Ks(o)&&qs(o.childNodes[a],V.Backward)&&(l=!0);;)if(a>0){if(1!==o.nodeType)break;const t=o.childNodes[a-1];if(qs(t,V.Backward))s=o,r=--a;else{if(3!==t.nodeType)break;o=t,a=o.nodeValue?.length??0}}else{if(Ys(o))break;{const t=Xs(o,n);if(!t)break;t.moveTarget&&(s=t.moveTarget.node,r=t.moveTarget.offset),o=t.node,a=t.offset}}return l?(Js(n,o,a),!0):!!s&&(Js(n,s,r),!0)}function js(t,e,n){const i=n.domSelectionRange();if(!i)return!1;let s=i.focusNode,r=i.focusOffset;if(!s)return!1;let o,a,l=Ks(s);for(;;)if(r<l){if(1!==s.nodeType)break;if(!qs(s.childNodes[r],V.Forward))break;o=s,a=++r}else{if(Ys(s))break;{const t=Qs(s,n);if(!t)break;t.moveTarget&&(o=t.moveTarget.node,a=t.moveTarget.offset),s=t.node,r=t.offset,l=t.len}}return!!o&&(Js(n,o,a),!0)}function Ks(t){return 3===t.nodeType?t.nodeValue?.length??0:t.childNodes.length}function qs(t,e){const n=t.pmViewDesc;return!(0!==n?.size||!n||e!==V.Backward&&U(t.nextSibling)&&"BR"===t.nodeName)}function Ys(t){const e=t.pmViewDesc;return e?.node?.isBlock??!1}function Xs(t,e){let n,i=t.previousSibling;for(;i&&qs(i,V.Backward);)n={node:t.parentNode,offset:En(i)},i=i.previousSibling;if(!i){const i=t.parentNode;return i===e.dom?null:{node:i,offset:0,moveTarget:n}}return{node:i,offset:Ks(i),moveTarget:n}}function Js(t,e,n){if(3!==e.nodeType){const t=function(t,e){for(;e===t?.childNodes.length&&!Cn(t);)e=En(t)+1,t=t.parentNode;for(;t&&e<t.childNodes.length;){const n=t.childNodes[e];if(3===n.nodeType)return n;if(1===n.nodeType&&"false"===n.contentEditable)break;t=n,e=0}}(e,n);if(t)e=t,n=0;else{const t=function(t,e){for(;t&&!e&&!Cn(t);)e=En(t),t=t.parentNode;for(;t&&e;){const n=t.childNodes[e-1];if(3===n.nodeType)return n;if(1===n.nodeType&&"false"===n.contentEditable)break;e=(t=n).childNodes.length}}(e,n);t&&(e=t,n=t.nodeValue?.length??0)}}const i=t.domSelection();if(!i)return;if(ii(i)){const t=document.createRange();t.setEnd(e,n),t.setStart(e,n),i.removeAllRanges(),i.addRange(t)}else i.extend&&i.extend(e,n);t.domObserver.setCurSelection();const{state:s}=t;setTimeout(()=>{t.state===s&&ai(t)},50)}function Qs(t,e){let n,i=t.nextSibling;for(;i&&qs(i,V.Forward);)n={node:i.parentNode,offset:En(i)+1},i=i.nextSibling;if(!i){const i=t.parentNode;return i===e.dom?null:{node:i,offset:0,len:0,moveTarget:n}}return{node:i,offset:0,len:Ks(i),moveTarget:n}}const Zs=(t,e)=>{const{$from:n,$to:i}=t.selection;if(t.selection.isNodeSelection()&&t.selection.node.isBlock)return!(!n.parentOffset||!Rt(t.doc,n.pos)||(e&&e(t.transaction.split(n.pos).scrollIntoView()),0));const s=function(t){if(0===t.depth)return null;const e=[];let n,i,s=!1,r=!1;for(let o=t.depth;o>=1;o--){if(t.node(o).isBlock){if(s=t.end(o)===t.pos+(t.depth-o),r=t.start(o)===t.pos-(t.depth-o),o<1)return null;const a=t.node(o-1),l=t.indexAfter(o-1);i=tr(a.contentMatchAt(l));const c=s&&i?{type:i}:null;e.push(c),n=o;break}if(1===o)return null;e.push(null)}return e.reverse(),void 0===n?null:{types:e,depth:n,defaultNodeType:i,atEnd:s,atStart:r}}(n);if(!s)return!1;const r=t.transaction;(t.selection.isTextSelection()||t.selection.isAllSelection())&&r.deleteSelection();const o=r.mapping.map(n.pos);return!!function(t,e,n,i){let s=Rt(t.doc,e,n.length,n);return!s&&i&&(n[0]={type:i},s=Rt(t.doc,e,n.length,n)),!!s&&(t.split(e,n.length,n),!0)}(r,o,s.types,s.defaultNodeType)&&(function(t,e,n){const{depth:i,defaultNodeType:s,atEnd:r,atStart:o}=n;if(r||!o||!s)return;if(e.node(i).type===s)return;const a=t.mapping.map(e.before(i)),l=t.doc.resolve(a),c=e.node(i-1),h=l.index();c.canReplaceWith(h,h+1,s)&&t.setNodeMarkup(a,s)}(r,n,s),e&&e(r.scrollIntoView()),!0)};function tr(t){for(let e=0;e<t.edgeCount;e++){const{type:n}=t.edge(e);if(n.isTextblock&&!n.hasRequiredAttrs())return n}return null}function er(t,e){const n=t.state,i=n.selection;if(!i.isTextSelection())return!0;const{$head:s,$anchor:r,empty:o}=i;if(!s.sameParent(r))return!0;if(!o)return!1;if(t.endOfTextblock(e===V.Forward?"forward":"backward"))return!0;const a=!s.textOffset&&(e===V.Backward?s.nodeBefore:s.nodeAfter);if(a&&!a.isText){const i=n.transaction;return e===V.Backward?i.delete(s.pos-a.nodeSize,s.pos):i.delete(s.pos,s.pos+a.nodeSize),t.dispatch(i),!0}return!1}function nr(t,e,n=null,i=!0){return(s,r)=>i&&sn(s,t)?Hs(e,n)(s,r):Hs(t,n)(s,r)}function ir(t,e=null,n=dr){const i=n.removeWhenPresent??!0,s=n.enterInlineAtoms??!0,r=!n?.includeWhitespace,o=n.onlyNumbers??!1,a=n.extendEmptySelection??!1;return(n,l)=>{const{empty:c,$cursor:h,$from:d,ranges:u}=n.selection;if(c&&!h||!function(t,e,n,i){for(const s of e){const{$from:e,$to:r}=s;let o=!1;if(0===e.depth&&(o=t.inlineContent&&t.type.allowsMarkType(n)),t.nodesBetween(e.pos,r.pos,(t,s)=>!(o||!i&&t.isAtom&&t.isInline&&s>=e.pos&&s+t.nodeSize<=r.pos||(o=t.inlineContent&&t.type.allowsMarkType(n),o))),o)return!0}return!1}(n.doc,u,t,s))return!1;if(!d.parent.type.spec.content.includes("inline"))return!1;if(o&&!c){if(p=(f=n.doc,m=d.pos,g=n.selection.$to.pos,f.textBetween(m,g,"","")),!ar.test(p))return!1}var p,f,m,g;let y=!1;if(h){if(a){const i=rs(n.doc,h,t,o);if(i.found&&i.char&&n.doc.resolve(i.from).parent.type.allowsMarkType(t)){const s=n.transaction;if(n.doc.rangeHasMark(i.from,i.to,t)){const e=function(t,e,n,i){const s=t.textBetween(n,i,"","");if(e===i){const t=lr.exec(s);if(t&&t[0].length<s.length)return{found:!0,from:i-t[0].length,to:i}}if(e===n){const t=cr.exec(s);if(t&&t[0].length<s.length)return{found:!0,from:n,to:n+t[0].length}}return{found:!1,from:-1,to:-1}}(n.doc,h.pos,i.from,i.to);e.found?s.removeMark(e.from,e.to,t):s.removeMark(i.from,i.to,t)}else s.addMark(i.from,i.to,t.create(e));return l&&l(s.scrollIntoView()),!0}return!1}const i=n.storedMarks||h.marks();t.isInSet(i)?l&&l(n.transaction.removeStoredMark(t)):l&&l(n.transaction.addStoredMark(t.create(e))),y=!0}else{const o=n.transaction,a=s?u:function(t){const e=[];for(const n of t){let t=n.$from;const i=n.$to;t.doc.nodesBetween(t.pos,i.pos,(n,s)=>{if(n.isAtom&&n.content.size>0&&n.isInline&&s>=t.pos&&s+n.nodeSize<=i.pos){const r=s+1,o=s+1+n.content.size,a=t.doc.content.size;return r>t.pos&&r<=a&&e.push(new Le(t,t.doc.resolve(r))),o<=i.pos&&o<=a&&(t=t.doc.resolve(o)),!1}}),t.pos<i.pos&&e.push(new Le(t,i))}return e}(u),c=(b=n,w=a,v=t,i?!w.some(t=>b.doc.rangeHasMark(t.$from.pos,t.$to.pos,v)):!w.every(t=>{let e=!0;return b.doc.nodesBetween(t.$from.pos,t.$to.pos,(n,i,s)=>{if(!e)return!1;const r=Math.max(0,t.$from.pos-i),o=Math.min(n.nodeSize,t.$to.pos-i),a=n.isText?n.textBetween(r,o):"",l=n.isText&&""===a.trim(),c=!v.isInSet(n.marks)&&!!s&&s.type.allowsMarkType(v)&&!l;return e=!c,e}),e}));for(const n of a){if(c){if(!sr(n.$from,t))continue;const{from:i,to:s}=pr(n.$from,n.$to,r);o.addMark(i,s,t.create(e))}else o.removeMark(n.$from.pos,n.$to.pos,t);if(y=!0,!l)return!0}l&&l(o.scrollIntoView())}var b,w,v;return y}}function sr(t,e){const n=t.nodeAfter;return n&&!n.isText&&n.isAtom&&n.isInline?n.type.allowsMarkType(e):t.parent.type.allowsMarkType(e)}const rr=/^\s*/,or=/\s*$/,ar=/^\d+$/,lr=/\s+$/,cr=/^\s+/;function hr(t,e,n){if(!e||!n?.isText||!n.text)return 0;const i=(t?rr:or).exec(n.text);return i?i[0].length:0}const dr={removeWhenPresent:!0,enterInlineAtoms:!0,includeWhitespace:!1,extendEmptySelection:!0},ur={...dr,onlyNumbers:!0};function pr(t,e,n){let i=t.pos,s=e.pos;if(!n)return{from:i,to:s};const r=t.nodeAfter,o=e.nodeBefore,a=hr(!0,n,r),l=hr(!1,n,o);return i+a<s&&(i+=a,s-=l),{from:i,to:s}}function fr(t,e=null,n=!0){return(i,s)=>{if(n&&sn(i,t))return Es(i,s);const{$from:r,$to:o}=i.selection,a=r.blockRange(o),l=a&&ke(a,t,e);return!!l&&(s&&s(i.transaction.wrap(a,l).scrollIntoView()),!0)}}function mr(t){return(e,n,i)=>{const s=i.dom.style.zoom||1;return"reset"===t?(i.dom.style.zoom="1",!0):"out"===t?(i.dom.style.zoom=String(Math.max(Number(s)-.1,.1)),!0):(i.dom.style.zoom=String(Math.min(Number(s)+.1,2)),!0)}}let gr=null;function yr(){return gr||(gr=document.implementation.createHTMLDocument("title"))}const br={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};function wr(t,e){t.someProp("transformCopied",n=>{e=n(e,t)});const n=[];let{content:i,openStart:s,openEnd:r}=e;for(;s>1&&r>1&&1===i.childCount&&1===i.firstChild.childCount;){s--,r--;const t=i.firstChild,e=t.attrs!==t.type.defaultAttrs?t.attrs:null;n.push(t.type.name,e),i=t.content}const o=t.someProp("clipboardSerializer")||_t.fromSchema(t.state.schema),a=yr(),l=a.createElement("div");l.appendChild(o.serializeFragment(i,{document:a}));const c=function(t,e){let n=t.firstChild,i=0;for(;1===n?.nodeType;){const s=n.nodeName.toLowerCase(),r=br[s];if(!r)break;for(let n=r.length-1;n>=0;n--){const s=e.createElement(r[n]);for(;t.firstChild;)s.appendChild(t.firstChild);t.appendChild(s),i++}n=t.firstChild}return i}(l,a),h=l.firstChild;if(1===h?.nodeType){const t=`${s} ${r}${c>0?` -${c}`:""} ${JSON.stringify(n)}`;h.setAttribute("data-pm-slice",t)}return{dom:l,text:t.someProp("clipboardTextSerializer",n=>n(e,t))||e.content.textBetween(0,e.content.size,"\n\n"),slice:e}}function vr(t,e,n){if(e<t.openStart){const n=Ar(t.content,-1,e,t.openStart,0,t.openEnd);t=new tt(n,e,t.openEnd)}if(n<t.openEnd){const e=Ar(t.content,1,n,t.openEnd,0,0);t=new tt(e,t.openStart,n)}return t}function Ar(t,e,n,i,s,r){const o=e<0?t.firstChild:t.lastChild;if(!o)return t;let a=o.content;return t.childCount>1&&(r=0),s<i-1&&(a=Ar(a,e,n,i,s+1,r)),s>=n&&(a=e<0?o.contentMatchAt(0).fillBefore(a,r<=s).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(Z.empty,!0))),t.replaceChild(e<0?0:t.childCount-1,o.copy(a))}const xr=/(?:\r\n?|\n)+/,Sr=/(^|\s)https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b[-a-zA-Z0-9()@:%_+.~#?&/=]*/gi;function _r(t,e,n=0){for(let i=e.length-1;i>=n;i--)t=e[i].create(null,Z.from(t));return t}function Tr(t,e,n,i){return t.length>0&&e.length>0&&t[0]===e[0]}function Er(t,e,n,i,s){if(s<t.length&&s<e.length&&t[s]===e[s]){const r=i.lastChild;if(r){const o=Er(t,e,n,r,s+1);if(o)return i.copy(i.content.replaceChild(i.childCount-1,o))}const o=i.contentMatchAt(i.childCount),a=s===t.length-1?n.type:t[s+1];if(o.matchType(a)){const e=i.content.append(Z.from(_r(n,t,s+1)));return i.copy(e)}}}function Cr(t,e){if(0===e)return t;const n=t.lastChild;if(!n)return t;const i=Cr(n,e-1),s=t.content.replaceChild(t.childCount-1,i),r=t.contentMatchAt(t.childCount).fillBefore(Z.empty,!0);return t.copy(s.append(r))}const Mr=/<([a-z][^>\s]+)/i,kr=/^(\s*<meta [^>]*>)*/;let Dr=null;const Ir=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Nr(t,e,n,i,s){const r=s.parent.type.spec.code;let o,a;if(!n&&!e)return null;const l=Boolean(e)&&(i||r||!n);if(l){if(console.log("Parsing clipboard as plain text"),t.someProp("transformPastedText",n=>{e=n(e,r||i,t)}),r)return a=function(t,e){const n=e.replace(/\r\n?/g,"\n");return new tt(Z.from(t.state.schema.text(n)),0,0)}(t,e),t.someProp("transformPasted",e=>{a=e(a,t,!0)}),a;const n=t.someProp("clipboardTextParser",n=>n(e,s,i,t));n?a=n:o=function(t,e){const n=document.createElement("div");return e.split(xr).forEach(t=>{const e=n.appendChild(document.createElement("p"));t&&(e.innerHTML=t.replace(Sr,t=>{const e=t.trim();return`${t.startsWith(" ")?" ":""}<a href="${e}">${e}</a>`}))}),n}(0,e)}else console.log("Parsing clipboard as HTML"),t.someProp("transformPastedHTML",e=>{n=e(n,t)}),n&&(o=function(t){const e=kr.exec(t);e&&(t=t.slice(e[0].length));let n=yr().createElement("div");const i=Mr.exec(t);let s;if(i){const t=i[1].toLowerCase();s=br[t]}if(s&&(t=s.map(t=>"<"+t+">").join("")+t+s.map(t=>"</"+t+">").reverse().join("")),n.innerHTML=function(t){const e=window.trustedTypes;return e?(Dr??=e.defaultPolicy??e.createPolicy("ProseMirrorClipboard",{createHTML:t=>t}),Dr.createHTML(t)):t}(t),s)for(const r of s)n=n.querySelector(r)||n;return n}(n),L.webkit&&function(t){const e=L.chrome?"span:not([class]):not([style])":"span.Apple-converted-space",n=t.querySelectorAll(e);for(const i of Array.from(n))1===i.childNodes.length&&""===i.textContent&&i.parentNode&&i.parentNode.replaceChild(t.ownerDocument.createTextNode(" "),i)}(o));const c=o?.querySelector("[data-pm-slice]"),h=c&&/^([0-9]+) ([0-9]+)(?: -([0-9]+))? (.*)/.exec(c.getAttribute("data-pm-slice")||"")||null;if(h?.[3]&&(o=function(t,e){let n=e;for(;n>0&&t?.firstChild;){let e=t.firstChild;for(;e&&1!==e.nodeType;)e=e.nextSibling;if(!e)break;t=e,n--}return t}(o,Number(h[3]))),!a){if(!o)return null;const e=t.someProp("clipboardParser")||t.someProp("domParser")||St.fromSchema(t.state.schema);a=e.parseSlice(o,{preserveWhitespace:Boolean(l||h),context:s,ruleFromNode:t=>t instanceof Element&&"BR"===t.nodeName&&!t.nextSibling&&t.parentNode instanceof Element&&!Ir.test(t.parentNode.nodeName)?{ignore:!0}:null})}if(h)a=function(t,e){if(!t.size)return t;const n=t.content.firstChild.type.schema;let i;try{i=JSON.parse(e)}catch(a){return t}let{content:s,openStart:r,openEnd:o}=t;for(let l=i.length-2;l>=0;l-=2){if(l+1>=i.length)continue;const t=i[l],e=i[l+1],a=n.nodes[t];if(!a||a.hasRequiredAttrs())break;s=Z.from(a.create(e,s)),r++,o++}return new tt(s,r,o)}(vr(a,Number(h[1]),Number(h[2])),h[4]);else if(a=tt.maxOpen(function(t,e){if(t.childCount<2)return t;for(let n=e.depth;n>=0;n--){let i,s=e.node(n).contentMatchAt(e.index(n)),r=[];if(t.forEach(t=>{if(!r)return;const e=s.findWrapping(t.type);if(!e)return void(r=null);if(r.length>0&&i&&Tr(e,i,0,r[r.length-1])){const n=Er(e,i,t,r[r.length-1],0);if(n)return r[r.length-1]=n,void(s=s.matchType(r[r.length-1].type))}r.length>0&&(r[r.length-1]=Cr(r[r.length-1],i?i.length:0));const n=_r(t,e);r.push(n),s=s.matchType(n.type),i=e}),r)return Z.from(r)}return t}(a.content,s),!0),a.openStart>0||a.openEnd>0){let t=0,e=0,n=a.content.firstChild;for(;n&&t<a.openStart&&!n.type.spec.isolating;)t++,n=n.firstChild;let i=a.content.lastChild;for(;i&&e<a.openEnd&&!i.type.spec.isolating;)e++,i=i.lastChild;a=vr(a,t,e)}return t.someProp("transformPasted",e=>{a=e(a,t,l)}),a}function Pr(t,e,n,i,s){const r=Nr(t,e,n,i,t.state.selection.$from);if(t.someProp("handlePaste",e=>e(t,s,r||tt.empty)))return!0;if(!r)return!1;const o=0===(a=r).openStart&&0===a.openEnd&&1===a.content.childCount?a.content.firstChild:null;var a;if(o){const{id:e,...n}=o.attrs,s=o.type.spec.attrs.id?o.type.create({...n,id:null},o.content,o.marks):o,r=t.state.transaction.replaceSelectionWith(s,i);return t.dispatch(r.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}{const e=function(t){const e=t.content.content.map(t=>{if(t.type.spec.attrs.id&&t.attrs?.id){const{id:e,...n}=t.attrs;return t.type.create({...n,id:null},t.content,t.marks)}return t});return new tt(Z.from(e),t.openStart,t.openEnd)}(r),n=t.state.transaction.replaceSelection(e);return t.dispatch(n.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}}let Or=class{_slice;_move;_nodeSelection;constructor(t,e,n){if(n&&!n.isNodeSelection())throw new Error("nodeSelection must be of type NodeSelection");this._slice=t,this._move=e,this._nodeSelection=n}get slice(){return this._slice}get move(){return this._move}get nodeSelection(){return this._nodeSelection}};function Rr(t){for(t.composing&&(t.input.composing=!1,t.input.compositionEndedAt=new Event("event",{bubbles:!0,cancelable:!0}).timeStamp);t.input.compositionNodes.length>0;)t.input.compositionNodes.pop().markParentsDirty()}const Br="Shift",Fr="Insert",Lr="Enter",zr="ArrowLeft",Vr="ArrowRight";function Hr(t,e){return new KeyboardEvent("keydown",{key:e,code:e,keyCode:t,bubbles:!0,cancelable:!0})}function $r(t,e){if(L.chrome&&L.android&&"deleteContentBackward"===e.inputType){t.domObserver.flushSoon();const{domChangeCount:e}=t.input;setTimeout(()=>{if(t.input.domChangeCount!==e)return!1;if(t.dom.blur(),t.focus(),t.someProp("handleKeyDown",e=>e(t,Hr(8,"Backspace"))))return!0;const{$cursor:n}=t.state.selection;n&&n.pos>0&&t.dispatch(t.state.transaction.delete(n.pos-1,n.pos).scrollIntoView())},50)}return!1}const Ur=-2e8;function Wr(t,e=!1){if(!(L.android&&t.domObserver.flushingSoon>=0)){if(t.domObserver.forceFlush(),Rr(t),e||t.docView?.dirty){const n=si(t),i=t.state.selection;return n&&!n.eq(i)?t.dispatch(t.state.transaction.setSelection(n)):!t.markCursor&&!e||i.$from.node(i.$from.sharedDepth(i.to)).inlineContent?t.updateState(t.state):t.dispatch(t.state.transaction.deleteSelection()),!0}return!1}}function Gr(t){return Wr(t)}function jr(t){return Gr(t),!1}const Kr=L.ie&&L.ie_version<15||L.ios&&L.webkit_version<604;function qr(t,e){const n=t.state.selection,i="cut"===e.type;if(n.empty)return;const s=Kr?null:e.clipboardData,r=n.content(),{dom:o,text:a}=wr(t,r);s?(e.preventDefault(),s.clearData(),s.setData("text/html",o.innerHTML),s.setData("text/plain",a)):function(t,e){if(!t.dom.parentNode)return;const n=t.dom.parentNode.appendChild(document.createElement("div"));n.appendChild(e),n.style.cssText="position: fixed; left: -10000px; top: 10px";const i=getSelection(),s=document.createRange();s.selectNodeContents(e),t.dom.blur(),i.removeAllRanges(),i.addRange(s),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n),t.focus()},50)}(t,o),i&&t.dispatch(t.state.transaction.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))}function Yr(t){const e=t.getData("text/plain")||t.getData("Text");if(e)return e;const n=t.getData("text/uri-list");return n?n.replace(/\r?\n/g," "):""}function Xr(t,e){if(t.composing&&!L.android)return!1;const n=Kr?null:e.clipboardData,i=t.input.shiftKey&&t.input.lastKey!==Fr;return n&&Pr(t,Yr(n),n.getData("text/html"),i,e)?(e.preventDefault(),!0):(function(t,e){if(!t.dom.parentNode)return;const n=t.input.shiftKey||t.state.selection.$from.parent.type.spec.code,i=t.dom.parentNode.appendChild(document.createElement(n?"textarea":"div"));n||(i.contentEditable="true"),i.style.cssText="position: fixed; left: -10000px; top: 10px",i.focus();const s=t.input.shiftKey&&t.input.lastKey!==Fr;setTimeout(()=>{t.focus(),i.parentNode&&i.parentNode.removeChild(i),n?Pr(t,i.value,null,s,e):Pr(t,i.textContent,i.innerHTML,s,e)},50)}(t,e),!1)}function Jr(t){const e=t.dragging;return window.setTimeout(()=>{t.dragging===e&&(t.dragging=null)},50),!1}function Qr(t,e){return e.preventDefault(),!0}function Zr(t,e){return t.someProp("dragCopies",t=>!t(e))??!(L.mac?e.altKey:e.ctrlKey)}const to=new Image(30,31);function eo(t,e){const n=t.input.mouseDown;if(n&&n.done(),!e.dataTransfer)return!1;const i=t.state.selection,s=i.empty?null:t.posAtCoords({left:e.clientX,top:e.clientY});let r;if(s&&s.pos>=i.from&&s.pos<=(i.isNodeSelection()?i.to-1:i.to));else if(n?.mightDrag)r=Qe.createNodeSelection(t.state.doc,n.mightDrag.pos);else if(e.target&&1===e.target.nodeType){const n=Zn.nearestNodeViewDesc(t.docView,e.target);n&&n.node.type.spec.draggable&&n!==t.docView&&(r=Qe.createNodeSelection(t.state.doc,n.posBefore))}const o=(r||t.state.selection).content(),{dom:a,text:l,slice:c}=wr(t,o);return(!e.dataTransfer.files.length||!L.chrome||L.chrome_version>120)&&e.dataTransfer.clearData(),e.dataTransfer.setData(Kr?"Text":"text/html",a.innerHTML),e.dataTransfer.effectAllowed="copyMove",e.dataTransfer.setDragImage(to,0,0),Kr||e.dataTransfer.setData("text/plain",l),t.dragging=new Or(c,Zr(t,e),r),!1}function no(t,e){try{!function(t,e,n){if(!e.dataTransfer)return!1;const i=t.posAtCoords({left:e.clientX,top:e.clientY});if(!i)return!1;const s=t.state.doc.resolve(i.pos);let r=n?.slice;r?t.someProp("transformPasted",e=>{r=e(r,t,!1)}):r=Nr(t,Yr(e.dataTransfer),Kr?null:e.dataTransfer.getData("text/html"),!1,s);const o=new Map,a=n&&Zr(t,e);if(t.someProp("handleDrop",n=>n(t,e,r||tt.empty,a,o)))return e.preventDefault(),!0;if(!r)return!1;e.preventDefault();let l=r?Se(t.state.doc,s.pos,r):s.pos;l??=s.pos;const c=t.state.transaction;if(a){const{nodeSelection:t}=n;t?t.replace(c):c.deleteSelection()}const h=c.mapping.map(l),d=0===r.openStart&&0===r.openEnd&&1===r.content.childCount,u=c.doc;if(d?c.replaceRangeWith(h,h,r.content.firstChild):c.replaceRange(h,h,r),c.doc.eq(u))return!0;const p=c.doc.resolve(h);if(d&&He.isNodeSelectable(r.content.firstChild)&&p.nodeAfter?.sameMarkup(r.content.firstChild))c.setSelection(Qe.createNodeSelection(p));else{let e=c.mapping.map(l);c.mapping.maps[c.mapping.maps.length-1].forEach((t,n,i,s)=>e=s),c.setSelection(ni(t,p,c.doc.resolve(e)))}t.someProp("handleDropFinished",n=>n(t,e,r||tt.empty,a,h,c,o)),t.focus(),t.dispatch(c.setMeta("uiEvent","drop"))}(t,e,t.dragging)}finally{t.dragging=null}return!1}function io(t,e){return t.focused&&(t.domObserver.stop(),t.dom.classList.remove("ProseMirror-focused"),t.domObserver.start(),e.relatedTarget&&t.dom.contains(e.relatedTarget)&&t.domObserver.currentSelection.clear(),t.focused=!1),!1}function so(t){return t.input.lastFocus=Date.now(),t.focused||(t.domObserver.stop(),t.dom.classList.add("ProseMirror-focused"),t.domObserver.start(),t.focused=!0,setTimeout(()=>{t.docView&&t.hasFocus()&&!t.domObserver.currentSelection.eq(t.domSelectionRange())&&ai(t)},20)),!1}function ro(t,e){clearTimeout(t.input.composingTimeout),e>-1&&(t.input.composingTimeout=window.setTimeout(()=>{Wr(t)},e))}function oo(t,e){return t.composing&&(t.input.composing=!1,t.input.compositionEndedAt=e.timeStamp,t.input.compositionPendingChanges=t.domObserver.pendingRecords().length?t.input.compositionID:0,t.input.compositionNode=null,t.input.compositionPendingChanges&&Promise.resolve().then(()=>{t.domObserver.flush()}),t.input.compositionID++,ro(t,20)),!1}to.src="data:image/jpeg;base64,/9j/4QDKRXhpZgAATU0AKgAAAAgABgESAAMAAAABAAEAAAEaAAUAAAABAAAAVgEbAAUAAAABAAAAXgEoAAMAAAABAAIAAAITAAMAAAABAAEAAIdpAAQAAAABAAAAZgAAAAAAAABIAAAAAQAAAEgAAAABAAeQAAAHAAAABDAyMjGRAQAHAAAABAECAwCgAAAHAAAABDAxMDCgAQADAAAAAQABAACgAgAEAAAAAQAAADygAwAEAAAAAQAAADCkBgADAAAAAQAAAAAAAAAAAAD/2wCEAAEBAQEBAQIBAQIDAgICAwQDAwMDBAUEBAQEBAUGBQUFBQUFBgYGBgYGBgYHBwcHBwcICAgICAkJCQkJCQkJCQkBAQEBAgICBAICBAkGBQYJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCf/dAAQABP/AABEIADAAPAMBIgACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AP6y9A8OLr8lzulMXkkdBnrn6elbX/CEab/0EV/8c/8AiqseA1JTUvoP/Zq8xih81lijXLNhQPc8CgD0b/hCNO/6CK/+Of8AxVL/AMIRpv8A0Ek/8d/+KrQg+Glv9lxc3BE2OdqjaD6Y6n9K801LTZNLvpNPuQN8RxkdCOxH4UAd1/whGnf9BFf/ABz/AOKo/wCEI03/AKCK/wDjn/xVecbE9BRsT0FAHpcfgK0lz5N9v2/3Qp/ka4qxB8tsf3v6Cuz+HC/6RehR/wAs1/ma5HT/APVN/vf0FAH/0P68fAXTU/oP/Zq8yt5nt5Y7iP70ZDD8Oa9N8BdNT+g/9mry0dBQB7pB4+0CS18+d2jfHMe0k59scGvIdb1M6xqkuoldgcjavooGBWVVyy0++1F/LsIXlP8Asjj8+lAGnomg3GtQXckHW3j3KPVv7v5A1z9e/wDhDRptF0nyrpQs0jF3A5x2A/AV5N4u04aZr00SDCSfvE9MN2/A0AdL8Nv+Pi9/65p/M1x2n/6pv97+grsfht/x8Xv/AFzT+ZrjtP8A9U3+9/QUAf/R/rt8BsQmpfQf+zV5eGXA5FddoHiJdAkud0Jl80jocYxn2962h4305SCNOUY/3P8A4mgC54T8HrtXUtYjzn7kTfzYfyFenx7YkEcahVHQAYH5CvMP+Fjp/wA+h/77H+FH/Cx0/wCfQ/8AfY/woA9S3mvP/Hujz6hax6hapue3yGA67D/hWb/wsdP+fQ/99j/Cj/hY6f8APof++x/hQBV+HDYuL3b/AM81/ma5HT/9U3+9/QV2CePbSLPlWOzd12lR/Ja4qxJ8tsf3v6CgD//Z";const ao=L.android?5e3:-1;function lo(t){if(!t.composing){t.domObserver.flush();const{state:e}=t,n=e.selection.$to,i=e.selection.isTextSelection()&&(e.storedMarks||!n.textOffset&&n.parentOffset&&n.nodeBefore.marks.some(t=>j(t.type.spec.inclusive))||L.chrome&&L.windows&&function(t){const{focusNode:e,focusOffset:n}=t.domSelectionRange();if(1!==e?.nodeType||n>=e.childNodes.length)return!1;const i=e.childNodes[n];return 1===i.nodeType&&"false"===i.contentEditable}(t));if(i)t.markCursor=t.state.storedMarks||n.marks(),Wr(t,!0),t.markCursor=null;else if(Wr(t,!e.selection.empty),L.gecko&&e.selection.empty&&n.parentOffset&&!n.textOffset&&n.nodeBefore.marks.length){const e=t.domSelectionRange();!function(t,e){let n=e.focusNode;for(let i=e.focusOffset;0!==i&&1!==n?.nodeType;){const e=i<0?n.lastChild:n.childNodes[i-1];if(!e)break;if(3===e.nodeType){const n=t.domSelection();n&&n.collapse(e,e.nodeValue.length);break}n=e,i=-1}}(t,e)}t.input.composing=!0}return ro(t,ao),!1}function co(t,e){t.input.lastSelectionOrigin=e,t.input.lastSelectionTime=Date.now()}function ho(t,e,n){t.domObserver.stop(),e.contentEditable=n,t.domObserver.start()}function uo(t,e){const n=t.state.doc.resolve(e);if(!L.chrome&&!L.windows&&n.parent.inlineContent){const i=t.coordsAtPos(e),s=1;if(e>n.start()){const n=t.coordsAtPos(e-1),r=(n.top+n.bottom)/2;if(r>i.top&&r<i.bottom&&Math.abs(n.left-i.left)>s)return n.left<i.left?"ltr":"rtl"}if(e<n.end()){const n=t.coordsAtPos(e+1),r=(n.top+n.bottom)/2;if(r>i.top&&r<i.bottom&&Math.abs(n.left-i.left)>s)return n.left>i.left?"ltr":"rtl"}}return"rtl"===getComputedStyle(t.dom).direction?"rtl":"ltr"}function po(t,e){return!!t.composing||!!(L.safari&&Math.abs(e.timeStamp-t.input.compositionEndedAt)<500)&&(t.input.compositionEndedAt=Ur,!0)}function fo(t,e){if(function(t,e){e.ctlKey="Control"===t.key||t.ctrlKey,e.metaKey="Meta"===t.key||t.metaKey,e.altKey="Alt"===t.key||t.altKey,e.shiftKey=t.key===Br||t.shiftKey}(e,t.input),po(t,e))return!1;if(t.input.lastKeyCode=e.keyCode,t.input.lastKey=e.key,t.input.lastKeyCodeTime=Date.now(),L.android&&L.chrome&&e.key===Lr)return!1;if(e.isComposing&&229===e.keyCode||t.domObserver.forceFlush(),!L.ios||e.key!==Lr||e.ctrlKey||e.altKey||e.metaKey){if(t.someProp("handleKeyDown",n=>n(t,e)))return e.preventDefault(),!0;if(function(t,e){const n=e.key;t.state;if(function(t,e,n){return"Backspace"===t||L.mac&&"h"===t&&n.ctlKey}(n,0,t.input))return function(t,e,n){return er(n,V.Backward)}(0,0,t)||Gs(t.state,0,t);if(function(t,e,n){return"Delete"===t&&!e.shiftKey||L.mac&&"d"===t&&n.ctlKey}(n,e,t.input))return function(t,e,n){return er(n,V.Forward)}(0,0,t)||js(0,0,t);if(n===Lr||"Escape"===n)return!1;const i=t.state.selection.from;let s;return!function(t,e){return t===zr||L.mac&&"b"===t&&e.ctlKey}(n,t.input)?function(t,e){return t===Vr||L.mac&&"f"===t&&e.ctlKey}(n,t.input)&&(s=n===Vr?"ltr"===uo(t,i)?V.Forward:V.Backward:V.Forward):s=n===zr?"ltr"===uo(t,i)?V.Backward:V.Forward:V.Backward,s===V.Backward?ks(0,0,t)||Gs(0,0,t):s===V.Forward?Ds(0,0,t)||js(0,0,t):function(t,e){return"ArrowUp"===t||L.mac&&"p"===t&&e.ctlKey}(n,t.input)?Rs(0,0,t)||Gs(0,0,t):function(t,e){return"ArrowDown"===t||L.mac&&"n"===t&&e.ctlKey}(n,t.input)?function(t){if(!L.safari||t.state.selection.$head.parentOffset>0)return!1;const e=t.domSelectionRange();if(!e)return!1;const{focusNode:n,focusOffset:i}=e,s=n?.firstChild;if(1===n?.nodeType&&0===i&&1===s?.nodeType&&"false"===s.contentEditable){const e=s,n=20;ho(t,e,"true"),setTimeout(()=>{ho(t,e,"false")},n)}return!1}(t)||Bs(0,0,t)||js(0,0,t):function(t,e){return(L.mac?e.metaKey:e.ctlKey)&&["b","i","y","z"].includes(t.toLowerCase())}(n,t.input)}(t,e))return e.preventDefault(),!0;co(t,"key")}else{const e=Date.now();t.input.lastIOSEnter=e,t.input.lastIOSEnterFallbackTimeout=window.setTimeout(()=>{t.input.lastIOSEnter===e&&(t.someProp("handleKeyDown",e=>e(t,Hr(13,"Enter"))),t.input.lastIOSEnter=0)},200)}return!1}function mo(t,e){if(po(t,e)||!e.charCode||e.ctrlKey&&!e.altKey||L.mac&&e.metaKey)return!1;if(t.someProp("handleKeyPress",n=>n(t,e)))return e.preventDefault(),!0;const n=t.state.selection;if(!n.isTextSelection()||!n.$from.sameParent(n.$to)){const i=String.fromCharCode(e.charCode),s=()=>t.state.transaction.insertText(i).scrollIntoView();return/[\r\n]/.test(i)||t.someProp("handleTextInput",e=>e(t,n.$from.pos,n.$to.pos,i,s))||t.dispatch(s()),e.preventDefault(),!0}return!1}function go(t,e){return e.key===Br&&(t.input.shiftKey=!1),!1}let yo=class t{static GECKO_DRAGGABLE_DELAY=20;static MOUSE_MOVE_THRESHOLD=4;startDoc;selectNode;_mightDrag=null;target;view;pos;event;flushed;upHandler;moveHandler;_allowDefault;_delayedSelectionSync=!1;constructor(e,n,i,s){let r,o;if(this.view=e,this.pos=n,this.event=i,this.startDoc=e.state.doc,this.selectNode=L.mac?i.metaKey:i.ctrlKey,this._allowDefault=i.shiftKey,n.inside>-1)r=e.state.doc.nodeAt(n.inside),o=n.inside;else{const t=e.state.doc.resolve(n.pos);r=t.parent,o=t.depth?t.before():0}const a=s?null:i.target,l=a?Zn.nearestNodeViewDesc(e.docView,a):null;this.target=1===l?.nodeDOM.nodeType?l.nodeDOM:null;const{selection:c}=e.state,h=0===i.button&&r.type.spec.draggable&&r.type.spec.selectable,d=c.isNodeSelection()&&c.from<=o&&c.to>o;(h||d)&&(this._mightDrag={node:r,pos:o,addAttr:this.target&&!this.target.draggable,setUneditable:this.target&&L.gecko&&!this.target.hasAttribute("contentEditable")}),this.target&&this._mightDrag&&(this._mightDrag.addAttr||this._mightDrag.setUneditable)&&(this.view.domObserver.stop(),this._mightDrag.addAttr&&(this.target.draggable=!0),this._mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown===this&&this.target.setAttribute("contentEditable","false")},t.GECKO_DRAGGABLE_DELAY),this.view.domObserver.start()),this.upHandler=this.up.bind(this),this.moveHandler=this.move.bind(this),e.root.addEventListener("mouseup",this.upHandler),e.root.addEventListener("mousemove",this.moveHandler),this.setSelectionOrigin(e,"pointer")}get allowDefault(){return this._allowDefault}set delayedSelectionSync(t){this._delayedSelectionSync=t}get mightDrag(){return this._mightDrag}static updateSelection(t,e,n){if(t.focused||t.focus(),t.state.selection.eq(e))return;const i=t.state.transaction.setSelection(e);"pointer"===n&&i.setMeta("pointer",!0),t.dispatch(i)}static runHandlerOnContext(t,e,n,i,s){if(-1===i)return!1;const r=t.state.doc.resolve(i);for(let o=r.depth+1;o>0;o--)if(t.someProp(e,e=>o>r.depth?e(t,n,r.nodeAfter,r.before(o),s,!0):e(t,n,r.node(o),r.before(o),s,!1)))return!0;return!1}done(){this.view.root.removeEventListener("mouseup",this.upHandler),this.view.root.removeEventListener("mousemove",this.moveHandler),this._mightDrag&&this.target&&(this.view.domObserver.stop(),this._mightDrag.addAttr&&this.target.removeAttribute("draggable"),this._mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this._delayedSelectionSync&&setTimeout(()=>{ai(this.view)}),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let n=this.pos;this.view.state.doc!==this.startDoc&&(n=this.view.posAtCoords({left:e.clientX,top:e.clientY})),this.updateAllowDefault(e),!this._allowDefault&&n?this.handleSingleClick(this.view,n.pos,n.inside,e,this.selectNode)?e.preventDefault():0===e.button&&(this.flushed||L.safari&&this._mightDrag&&!this._mightDrag.node.isAtom||L.chrome&&!this.view.state.selection.visible&&Math.min(Math.abs(n.pos-this.view.state.selection.from),Math.abs(n.pos-this.view.state.selection.to))<=2)?(t.updateSelection(this.view,He.near(this.view.state.doc.resolve(n.pos)),"pointer"),e.preventDefault()):this.setSelectionOrigin(this.view,"pointer"):this.setSelectionOrigin(this.view,"pointer")}move(t){this.updateAllowDefault(t),this.setSelectionOrigin(this.view,"pointer"),0===t.buttons&&this.done()}updateAllowDefault(e){!this._allowDefault&&(Math.abs(this.event.x-e.clientX)>t.MOUSE_MOVE_THRESHOLD||Math.abs(this.event.y-e.clientY)>t.MOUSE_MOVE_THRESHOLD)&&(this._allowDefault=!0)}handleSingleClick(e,n,i,s,r){return!!t.runHandlerOnContext(e,"handleClickOn",n,i,s)||(e.someProp("handleClick",t=>t(e,n,s)),r?this.selectClickedNode(e,i):this.selectClickedLeaf(e,i))}selectClickedNode(e,n){if(-1===n)return!1;const i=e.state.selection;let s,r;i.isNodeSelection()&&(s=i.node);const o=e.state.doc.resolve(n);for(let t=o.depth+1;t>0;t--){const e=t>o.depth?o.nodeAfter:o.node(t);if(He.isNodeSelectable(e)){r=s&&i.$from.depth>0&&t>=i.$from.depth&&o.before(i.$from.depth+1)===i.$from.pos?o.before(i.$from.depth):o.before(t);break}}return null!==r&&(t.updateSelection(e,Qe.createNodeSelection(e.state.doc,r),"pointer"),!0)}selectClickedLeaf(e,n){if(-1===n)return!1;const i=e.state.doc.resolve(n),s=i.nodeAfter;return!!(s&&s.isAtom&&He.isNodeSelectable(s))&&(t.updateSelection(e,Qe.createNodeSelection(i),"pointer"),!0)}setSelectionOrigin(t,e){t.input.lastSelectionOrigin=e,t.input.lastSelectionTime=Date.now()}};function bo(t,e){t.input.shiftKey=e.shiftKey;const n=Gr(t),i=Date.now();let s="singleClick";i-t.input.lastClick.time<500&&function(t,e){const n=e.x-t.clientX,i=e.y-t.clientY;return n*n+i*i<100}(e,t.input.lastClick)&&!(L.mac?e.metaKey:e.ctrlKey)&&t.input.lastClick.button===e.button&&("singleClick"===t.input.lastClick.type?s="doubleClick":"doubleClick"===t.input.lastClick.type&&(s="tripleClick")),t.input.lastClick={time:i,x:e.clientX,y:e.clientY,type:s,button:e.button};const r=t.posAtCoords({left:e.clientX,top:e.clientY});if(!r)return!1;if("singleClick"===s)t.input.mouseDown&&t.input.mouseDown.done(),t.input.mouseDown=new yo(t,r,e,n);else if("doubleClick"===s){if(function(t,e,n,i){return!!yo.runHandlerOnContext(t,"handleDoubleClickOn",e,n,i)||t.someProp("handleDoubleClick",n=>n(t,e,i))}(t,r.pos,r.inside,e))return e.preventDefault(),!0}else if("tripleClick"===s){if(function(t,e,n,i){return!!yo.runHandlerOnContext(t,"handleTripleClickOn",e,n,i)||(!!t.someProp("handleTripleClick",n=>n(t,e,i))||function(t,e,n){if(0!==n.button)return!1;const i=t.state.doc;if(-1===e)return!!i.inlineContent&&(yo.updateSelection(t,Qe.createTextSelection(i,0,i.content.size),"pointer"),!0);const s=i.resolve(e);for(let r=s.depth+1;r>0;r--){const e=r>s.depth?s.nodeAfter:s.node(r),n=s.before(r);if(e.inlineContent)yo.updateSelection(t,Qe.createTextSelection(i,n+1,n+1+e.content.size),"pointer");else{if(!He.isNodeSelectable(e))continue;yo.updateSelection(t,Qe.createNodeSelection(i,n),"pointer")}return!0}return!1}(t,n,i))}(t,r.pos,r.inside,e))return e.preventDefault(),!0}else co(t,"pointer");return!1}function wo(t,e){return t.input.lastTouch=Date.now(),co(t,"pointer"),!1}function vo(t,e){return t.input.lastTouch=Date.now(),Gr(t),co(t,"pointer"),!1}class Ao{static INPUT_HANDLER=new Map([["copy",qr],["mousedown",bo],["touchstart",vo],["touchmove",wo],["contextmenu",jr],["beforeinput",$r],["focus",so],["blur",io],["dragstart",eo],["dragend",Jr]]);static INPUT_EDIT_HANDLER=new Map([["keydown",fo],["keypress",mo],["keyup",go],["cut",qr],["paste",Xr],["compositionstart",lo],["compositionupdate",lo],["compositionend",oo],["dragover",Qr],["dragenter",Qr],["drop",no]]);static ALL_INPUT_HANDLER=new Map([...Ao.INPUT_HANDLER,...Ao.INPUT_EDIT_HANDLER]);static PASSIVE_HANDLER_TOUCHSTART="touchstart";static PASSIVE_HANDLER_TOUCHMOVE="touchmove";view;eventHandlers={};shiftKey=!1;ctlKey=!1;altKey=!1;metaKey=!1;mouseDown=null;lastKeyCode=null;lastKey=null;lastKeyCodeTime=0;lastClick={time:0,x:0,y:0,type:"",button:0};lastSelectionOrigin=null;lastSelectionTime=0;lastIOSEnter=0;lastIOSEnterFallbackTimeout=-1;lastFocus=0;lastTouch=0;lastChromeDelete=0;composing=!1;compositionNode=null;composingTimeout=-1;compositionNodes=[];compositionEndedAt=Ur;compositionID=1;compositionPendingChanges=0;domChangeCount=0;hideSelectionGuard=null;lastEventType=null;constructor(t){this.view=t}initInput(){Ao.ALL_INPUT_HANDLER.forEach((t,e)=>{const n=e=>(this.lastEventType=e.type,!(!this.eventBelongsToView(e)||this.runCustomHandler(e)||!this.view.editable&&Ao.INPUT_EDIT_HANDLER.has(e.type)||!t(this.view,e))),i=e===Ao.PASSIVE_HANDLER_TOUCHSTART||e===Ao.PASSIVE_HANDLER_TOUCHMOVE?{passive:!0}:void 0;this.eventHandlers[e]=n,this.view.dom.addEventListener(e,n,i)}),L.safari&&this.view.dom.addEventListener("input",()=>null),this.ensureListeners()}destroyInput(){this.view.domObserver.stop();for(const t in this.eventHandlers)this.view.dom.removeEventListener(t,this.eventHandlers[t]);clearTimeout(this.composingTimeout),clearTimeout(this.lastIOSEnterFallbackTimeout)}ensureListeners(){this.view.someProp("handleDOMEvents",t=>{for(const e in t)if(!this.eventHandlers[e]){const t=t=>this.runCustomHandler(t);this.eventHandlers[e]=t,this.view.dom.addEventListener(e,t)}})}dispatchEvent(t){this.runCustomHandler(t)||!Ao.ALL_INPUT_HANDLER.has(t.type)||!this.view.editable&&Ao.INPUT_EDIT_HANDLER.has(t.type)||Ao.ALL_INPUT_HANDLER.get(t.type)(this.view,t)}runCustomHandler(t){return this.view.someProp("handleDOMEvents",e=>{const n=e[t.type];return!!n&&(!!n(this.view,t)||t.defaultPrevented)})}eventBelongsToView(t){if(!t.bubbles)return!0;if(t.defaultPrevented)return!1;let e=t.target;for(;e!==this.view.dom;){if(!e||11===e.nodeType||e.pmViewDesc?.stopEvent(t))return!1;e=e.parentNode}return!0}}function xo(t,e){let n=e.startContainer,i=e.startOffset,s=e.endContainer,r=e.endOffset;const o=t.domAtPos(t.state.selection.anchor);return Dn(o.node,o.offset,s,r)&&([n,i,s,r]=[s,r,n,i]),{anchorNode:n,anchorOffset:i,focusNode:s,focusOffset:r}}let So=class t{_dom;mounted;inputState;_domObserver;_frozenProps=null;directPlugins;isPluginsUpdateNeeded=!1;pluginViews=[];editorState;_props;_root=null;_focused=!1;_markCursor=null;_cursorWrapper=null;_nodeViews;_docView;_lastSelectedViewDesc=void 0;_trackWrites=null;_dragging=null;constructor(t,e){this.inputState=new Ao(this),this._props=e,this.editorState=e.state,this.directPlugins=this.directPlugins?Array.from(this.directPlugins).concat(e.plugins||[]):[],this.isPluginsUpdateNeeded=this.directPlugins.length>0,this.directPlugins.forEach(this.checkStateComponent()),this.dispatch=this.dispatch.bind(this),this._dom=this.createEditorDOM(t),this.mounted=this.mountEditorDOM(t),this.updateCursorWrapper(),this._nodeViews=this.buildNodeViews(),this._domObserver=new To(this,(t,e,n,i)=>{ki(this,t,e,n,i)}),this._docView=Qn(this.editorState.doc,this.computeDocDeco(),xi(this),this._dom,this),this._domObserver.start(),this.inputState.initInput(),this.updatePluginViews()}static fromJSON(e,n,i,s,r,o){const a=We.fromJSON({schema:n,plugins:s},i);return new t(e,{state:a,nodeViews:r,markViews:o})}static fromHTML(e,n,i,s,r,o){const a="string"==typeof i?document.createElement("div"):i;"string"==typeof a&&(a.innerHTML=i);const l=a.querySelector("main[data-pmroot]"),c=l?{id:l.dataset.pmid,version:l.dataset.pmversion,preVersion:l.dataset.pmprevision}:null,h=c?n.topNodeType.create(c):null,d=St.fromSchema(n).parse(i,{topNode:h}),u=We.create({doc:d,plugins:s});return new t(e,{state:u,nodeViews:r,markViews:o})}get props(){if(!this._frozenProps||this._props.state!==this.editorState){const t={...this._props,state:this.editorState};this._frozenProps=Object.freeze(t)}return this._frozenProps}get root(){if(this._root)return this._root;let t=this._dom.parentNode;for(;t;){if(9===t.nodeType||11===t.nodeType&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t,this._root;t=t.parentNode}return this._root=document,this._root}get focused(){return this._focused}set focused(t){this._focused=t}get markCursor(){return this._markCursor}set markCursor(t){this._markCursor=t}get cursorWrapper(){return this._cursorWrapper}get nodeViews(){return this._nodeViews}get docView(){return this._docView}get lastSelectedViewDesc(){return this._lastSelectedViewDesc||null}set lastSelectedViewDesc(t){this._lastSelectedViewDesc=t||null}get trackWrites(){return this._trackWrites}get dragging(){return this._dragging}set dragging(t){this._dragging=t}get dom(){return this._dom}get editable(){return this.getEditableStatus()}get input(){return this.inputState}get domObserver(){return this._domObserver}get state(){return this.editorState}get composing(){return this.inputState.composing}get isDestroyed(){return U(this._docView)}toJSON(t){return JSON.stringify(this.state.toJSON(t,!0))}toHtml(){if(this.editorState.doc.type.spec.toDOM){const t=this.editorState.doc;return _t.fromSchema(this.state.schema).serializeNode(t).outerHTML}{const t=this.editorState.doc,e=_t.fromSchema(this.state.schema).serializeFragment(t.content),n=document.createElement("div");return n.appendChild(e),n.innerHTML}}addPlugin(t){this.directPlugins=Array.from(this.directPlugins).concat([t]),this.state&&(this.checkStateComponent()(t),t.spec.view&&this.pluginViews.push(t.spec.view(this)))}clearTrackWrites(){this._trackWrites=null}update(t){t.handleDOMEvents!==this._props.handleDOMEvents&&this.inputState.ensureListeners();const e=this._props;this._props=t,this._frozenProps=null,t.plugins&&this.directPlugins!==t.plugins&&(t.plugins.forEach(this.checkStateComponent()),this.directPlugins=t.plugins,this.isPluginsUpdateNeeded=!0),this.updateStateInner(t.state,e)}setProps(t){const e={...this._props,state:this.editorState,...t};this.update(e)}updateState(t){this.updateStateInner(t,this._props)}scrollToSelection(){const t=this.domSelectionRange().focusNode;if(t&&this._dom.contains(1===t.nodeType?t:t.parentNode)&&!this.someProp("handleScrollToSelection",t=>t(this)))if(this.editorState.selection.isNodeSelection()){const e=this._docView.domAfterPos(this.editorState.selection.from);1===e.nodeType&&Zi(this,e.getBoundingClientRect(),t)}else Zi(this,this.coordsAtPos(this.editorState.selection.head,1),t)}someProp(t,e){const n=this._props?.[t];if(!U(n)){const t=e?e(n):n;if(t)return t}for(const s of this.directPlugins){const n=s.props[t];if(!U(n)){const t=e?e(n):n;if(t)return t}}const i=this.editorState.plugins;if(i)for(const s of i){const n=s.props[t];if(!U(n)){const t=e?e(n):n;if(t)return t}}}hasFocus(){const t=this.root.activeElement;return L.ie?t===this._dom||!(!t||!this._dom.contains(t))&&this.hasNoNonEditableAncestor(t):t===this._dom}focus(){this._domObserver.stop(),this.editable&&function(t){if(K(t,"setActive"))return t.setActive();if(Ui)return void t.focus(Ui);const e=$i(t);t.focus(U(Ui)?{get preventScroll(){return Ui={preventScroll:!0},!0}}:void 0),Ui||(Ui=!1,Hi(e,0))}(this._dom),ai(this),this._domObserver.start()}updateRoot(){this._root=null}posAtCoords(t){return Ki(this,t)}coordsAtPos(t,e=1){return Oi(this,t,e)}domAtPos(t,e=0){return this._docView.domFromPos(t,e)}nodeDOM(t){const e=this._docView.descAt(t);return e?e.nodeDOM:null}posAtDOM(t,e,n=-1){const i=this._docView.posFromDOM(t,e,n);if(U(i))throw new RangeError("DOM position not inside the editor");return i}endOfTextblock(t,e){return Vi(this,e||this.editorState,t)}pasteHTML(t,e){return Pr(this,"",t,!1,e||new ClipboardEvent("paste"))}pasteText(t,e){return Pr(this,t,null,!0,e||new ClipboardEvent("paste"))}serializeForClipboard(t){return wr(this,t)}destroy(){this._docView&&(this._domObserver.stop(),this.inputState.destroyInput(),this.destroyPluginViews(),this.mounted?(Jn.update(this._docView,this,this.editorState.doc,[],xi(this)),this._dom.textContent=""):this._dom.parentNode&&this._dom.parentNode.removeChild(this._dom),this._docView.destroy(),this._docView=null,Pn=null)}dispatchEvent(t){this.inputState.dispatchEvent(t)}domSelectionRange(){const t=this.domSelection();return t?L.safari&&11===this.root.nodeType&&function(t){let e=t.activeElement;for(;e?.shadowRoot;)e=e.shadowRoot.activeElement;return e}(this._dom.ownerDocument)===this._dom&&function(t,e){if("getComposedRanges"in Selection.prototype){const n=e.getComposedRanges({shadowRoots:[t.root]});if(n&&n.length>0){const e=n[0];if(e)return xo(t,e)}}let n;function i(t){t.preventDefault(),t.stopImmediatePropagation(),n=t.getTargetRanges()[0]}return t.dom.addEventListener("beforeinput",i,!0),document.execCommand("indent"),t.dom.removeEventListener("beforeinput",i,!0),n?xo(t,n):null}(this,t)||t:{focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0}}domSelection(){return this.root.getSelection()}dispatch(t){const e=this._props.dispatchTransaction;e?e.call(this,t):this.updateState(this.editorState.apply(t))}updateStateInner(t,e){const n=this.editorState;let i=!1,s=!1;t.storedMarks&&this.composing&&(Rr(this),s=!0),this.editorState=t;const r=this.hasPluginsChanged(n,t,e);if(r||this._props.plugins!==e.plugins||this._props.nodeViews!==e.nodeViews){const t=this.buildNodeViews();this.changedNodeViews(t,this._nodeViews)&&(this._nodeViews=t,i=!0)}(r||e.handleDOMEvents!==this._props.handleDOMEvents)&&this.inputState.ensureListeners(),this.updateCursorWrapper();const o=xi(this),a=this.computeDocDeco(),l=this.determineScrollBehavior(n,t),c=i||!this._docView.matchesNode(t.doc,a,o);!c&&t.selection.eq(n.selection)||(s=!0);const h="preserve"===l&&s&&U(this._dom.style.overflowAnchor)?function(t){const e=t.dom.getBoundingClientRect(),{refDOM:n,refTop:i}=function(t,e){const n=Math.max(0,e.top),i=(e.left+e.right)/2;for(let s=n+1;s<Math.min(innerHeight,e.bottom);s+=5){const e=t.root.elementFromPoint(i,s);if(!e||e===t.dom||!t.dom.contains(e))continue;const r=e.getBoundingClientRect();if(r.top>=n-20)return{refDOM:e,refTop:r.top}}return{refDOM:void 0,refTop:void 0}}(t,e);return{refDOM:n,refTop:i,stack:$i(t.dom)}}(this):null;s&&this.updateSelectionAndDOM(n,t,c,i,a,o),this.updatePluginViews(n),this._dragging?.nodeSelection&&!n.doc.eq(t.doc)&&this.updateDraggedNode(this._dragging,n),this.applyScrollBehavior(l,h)}hasPluginsChanged(t,e,n){return t.plugins!==e.plugins||this._props.plugins!==n.plugins}determineScrollBehavior(t,e){return t.plugins===e.plugins||t.doc.eq(e.doc)?e.scrollToSelection>t.scrollToSelection?"to selection":"preserve":"reset"}updateSelectionAndDOM(t,e,n,i,s,r){this._domObserver.stop();let o=this.needsForceSelectionUpdate(t,e,n);if(n){let t=null;if(L.chrome){const e=this.domSelectionRange();t=this._trackWrites=e.focusNode}this.composing&&(this.inputState.compositionNode=function(t){const e=t.domSelectionRange();if(!e.focusNode)return null;const n=function(t,e){for(;;){if(3===t.nodeType&&e)return t;if(1===t.nodeType&&e>0){if("false"===t.contentEditable)return null;e=Mn(t=t.childNodes[e-1])}else{if(!t.parentNode||Cn(t))return null;e=En(t),t=t.parentNode}}}(e.focusNode,e.focusOffset),i=function(t,e){for(;;){if(3===t.nodeType&&e<(t.nodeValue?.length??0))return t;if(1===t.nodeType&&e<t.childNodes.length){if("false"===t.contentEditable)return null;t=t.childNodes[e],e=0}else{if(!t.parentNode||Cn(t))return null;e=En(t)+1,t=t.parentNode}}}(e.focusNode,e.focusOffset);if(n&&i&&n!==i){const e=i.pmViewDesc,s=t.domObserver.lastChangedTextNode;if(n===s||i===s)return s;if(!e?.isText(i.nodeValue))return i;if(t.input.compositionNode===i){const t=n.pmViewDesc;if(t?.isText(n.nodeValue))return i}}return n||i}(this)),!i&&Jn.update(this._docView,this,e.doc,s,r)||(this._docView.updateOuterDeco(s),this._docView.destroy(),this._docView=Qn(e.doc,s,r,this._dom,this)),!t||this.trackWrites&&this.dom.contains(this.trackWrites)||(o=!0)}this.shouldUpdateSelection(o)?ai(this,o):(ri(this,e.selection),this._domObserver.setCurSelection()),this._domObserver.start()}needsForceSelectionUpdate(t,e,n){return n&&(L.ie||L.chrome)&&!this.composing&&!t.selection.empty&&!e.selection.empty&&this.selectionContextChanged(t.selection,e.selection)}shouldUpdateSelection(t){return t||!(this.inputState.mouseDown&&this._domObserver.currentSelection.eq(this.domSelectionRange())&&function(t){const e=t.docView.domFromPos(t.state.selection.anchor,0),n=t.domSelectionRange();return Dn(e.node,e.offset,n.anchorNode,n.anchorOffset)}(this))}applyScrollBehavior(t,e){"reset"===t?this._dom.scrollTop=0:"to selection"===t?this.scrollToSelection():e&&function({refDOM:t,refTop:e,stack:n}){let i=0;t?.isConnected&&(i=t.getBoundingClientRect().top),Hi(n,t&&void 0!==e&&i!==e?i-e:0)}(e)}destroyPluginViews(){for(;this.pluginViews.length>0;){const t=this.pluginViews.pop();t?.destroy&&t.destroy()}}updatePluginViews(t){!t||this.isPluginsUpdateNeeded||t.plugins!==this.editorState.plugins?(this.isPluginsUpdateNeeded=!1,this.destroyPluginViews(),this.createPluginViews()):this.updateExistingPluginViews(t)}createPluginViews(){for(const t of this.directPlugins)t.spec.view&&this.pluginViews.push(t.spec.view(this));for(const t of this.editorState.plugins)t.spec.view&&this.pluginViews.push(t.spec.view(this))}updateExistingPluginViews(t){for(const e of this.pluginViews)e.update&&e.update(this,t)}updateDraggedNode(t,e){const n=t.nodeSelection;let i=-1;if(this.editorState.doc.nodeAt(n.from)===n.node)i=n.from;else{const t=this.editorState.doc.content.size-e.doc.content.size,s=n.from+t;s>=0&&s<=this.editorState.doc.content.size&&this.editorState.doc.nodeAt(s)===n.node&&(i=s)}this._dragging=new Or(t.slice,t.move,i>=0?Qe.createNodeSelection(this.editorState.doc,i):void 0)}hasNoNonEditableAncestor(t){let e=t;for(;e&&e!==this._dom&&this._dom.contains(e);){if("false"===e.contentEditable)return!1;e=e.parentElement}return!0}createEditorDOM(t){return t&&"object"==typeof t&&"mount"in t?t.mount:document.createElement("div")}mountEditorDOM(t){if(!t)return!1;if("function"==typeof t)return t(this._dom),!1;if("object"==typeof t){if("mount"in t)return!0;if("appendChild"in t&&t.appendChild)return t.appendChild(this._dom),!1}return!1}checkStateComponent(){return t=>{if(t.spec.state||t.spec.filterTransaction||t.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}}changedNodeViews(t,e){for(const n in t)if(t[n]!==e[n])return!0;for(const n in e)if(!(n in t))return!0;return!1}buildNodeViews(){const t={},e=e=>{for(const n in e)K(t,n)||(t[n]=e[n])};return this.someProp("nodeViews",e),this.someProp("markViews",e),t}selectionContextChanged(t,e){const n=Math.min(t.$anchor.sharedDepth(t.head),e.$anchor.sharedDepth(e.head));return t.$anchor.start(n)!==e.$anchor.start(n)}getEditableStatus(){return!this.someProp("editable",t=>!t(this.editorState))}updateCursorWrapper(){if(this._markCursor){const t=document.createElement("img");t.className="ProseMirror-separator",t.setAttribute("mark-placeholder","true"),t.setAttribute("alt",""),this._cursorWrapper={dom:t,deco:bi.widget(this.editorState.selection.from,t,{raw:!0,marks:this._markCursor})}}else this._cursorWrapper=null}computeDocDeco(){const t=this.editable?{class:"ProseMirror",spellcheck:String(!1),translate:"no",contenteditable:String(!0)}:{class:"ProseMirror"};return this.someProp("attributes",e=>{let n=e;"function"==typeof n&&(n=n(this.editorState)),n&&this.mergeAttributes(t,n)}),t.translate||(t.translate="no"),[bi.node(0,this.editorState.doc.content.size,t)]}mergeAttributes(t,e){for(const n in e)"class"===n?t.class+=" "+e[n]:"style"===n?t.style=(t.style?t.style+";":"")+e[n]:t[n]||"contenteditable"===n||"nodeName"===n||(t[n]=e[n])}},_o=class{_focusOffset=0;_anchorOffset=0;_anchorNode=null;_focusNode=null;get anchorNode(){return this._anchorNode}get anchorOffset(){return this._anchorOffset}get focusNode(){return this._focusNode}set(t){this._anchorNode=t.anchorNode,this._anchorOffset=t.anchorOffset,this._focusNode=t.focusNode,this._focusOffset=t.focusOffset}clear(){this._anchorNode=null,this._focusNode=null,this._anchorOffset=0,this._focusOffset=0}eq(t){return t.anchorNode===this._anchorNode&&t.anchorOffset===this._anchorOffset&&t.focusNode===this._focusNode&&t.focusOffset===this._focusOffset}},To=class{observer=null;_currentSelection=new _o;onCharData=null;view;handleDOMChange;queue=[];_stopFlushTimeout=-1;suppressingSelectionUpdates=!1;suppressionTimeout=-1;_flushingSoon=-1;_lastChangedTextNode=null;cssChecked=new WeakMap;cssCheckWarned=!1;isGeckoHackNodeRequired=!1;constructor(t,e){this.view=t,this.handleDOMChange=e,this.observer=this.createMutationObserver(),L.ie&&L.ie_version<=11&&(this.onCharData=this.createCharDataHandler()),this.onSelectionChange=this.onSelectionChange.bind(this)}get flushingSoon(){return this._flushingSoon}get lastChangedTextNode(){return this._lastChangedTextNode}get currentSelection(){return this._currentSelection}get requiresGeckoHackNode(){return this.isGeckoHackNodeRequired}flushSoon(){this._flushingSoon<0&&(this._flushingSoon=window.setTimeout(()=>{this._flushingSoon=-1,this.flush()},20))}forceFlush(){this._flushingSoon>-1&&(window.clearTimeout(this._flushingSoon),this._flushingSoon=-1,this.flush())}start(){this._stopFlushTimeout>-1&&(window.clearTimeout(this._stopFlushTimeout),this._stopFlushTimeout=-1);this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,{childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0})),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this._stopFlushTimeout>-1&&(window.clearTimeout(this._stopFlushTimeout),this._stopFlushTimeout=-1),this.observer){const t=this.observer.takeRecords();t.length&&(this.queue.push(...t),this._stopFlushTimeout=window.setTimeout(()=>{this._stopFlushTimeout=-1,this.flush()},20)),this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection(),this.suppressionTimeout>-1&&(window.clearTimeout(this.suppressionTimeout),this.suppressionTimeout=-1,this.suppressingSelectionUpdates=!1)}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressionTimeout>-1&&window.clearTimeout(this.suppressionTimeout),this.suppressingSelectionUpdates=!0,this.suppressionTimeout=window.setTimeout(()=>{this.suppressingSelectionUpdates=!1,this.suppressionTimeout=-1},50)}setCurSelection(){this._currentSelection.set(this.view.domSelectionRange())}pendingRecords(){if(this.observer){const t=this.observer.takeRecords();this.queue.push(...t)}return this.queue}flush(){const{view:t}=this;if(!t.docView||this._flushingSoon>-1)return;const e=this.pendingRecords();e.length&&(this.queue=[]);const n=t.domSelectionRange(),i=this.hasNewSelection(n),{from:s,to:r,typeOver:o,addedNodes:a}=this.processMutations(e);this.applyBrowserSpecificWorkarounds(a),this.shouldRestoreSelectionAfterFocus(s,i,n)?this.restoreSelectionAfterFocus(n):(s>-1||i)&&this.applyChanges(s,r,o,a,i,n)}createMutationObserver(){return window.MutationObserver?new window.MutationObserver(t=>{this.queue.push(...t),this.shouldFlushSoonForIE11(t)?this.flushSoon():this.flush()}):null}shouldFlushSoonForIE11(t){return!(!L.ie||L.ie_version>11)&&t.some(t=>!("childList"!==t.type||!t.removedNodes.length)||!("characterData"!==t.type||!t.oldValue)&&t.oldValue.length>(t.target.nodeValue?.length??0))}createCharDataHandler(){return t=>{this.queue.push({target:t.target,type:"characterData",oldValue:t.prevValue}),this.flushSoon()}}onSelectionChange(){ei(this.view)&&(this.suppressingSelectionUpdates?ai(this.view):this.shouldDelayForIE11Selection()?this.flushSoon():this.flush())}shouldDelayForIE11Selection(){if(!L.ie||L.ie_version>11||this.view.state.selection.empty)return!1;const t=this.view.domSelectionRange();return t.focusNode&&Dn(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset)}ignoreSelectionChange(t){if(!t.focusNode)return!0;const e=this.findCommonAncestor(t);if(!e)return!1;const n=Zn.nearestViewDesc(this.view.docView,e),i=3===e.nodeType?e.parentNode:e;if(!i)return!1;const s=n?.ignoreMutation({type:"selection",target:i});return!!s&&(this.setCurSelection(),!0)}findCommonAncestor(t){if(t.anchorNode===t.focusNode)return t.anchorNode;const e=new Set;for(let n=t.focusNode;n;n=Nn(n))e.add(n);for(let n=t.anchorNode;n;n=Nn(n))if(e.has(n))return n}hasNewSelection(t){return!this.suppressingSelectionUpdates&&!this._currentSelection.eq(t)&&ei(this.view)&&!this.ignoreSelectionChange(t)}processMutations(t){let e=-1,n=-1,i=!1;const s=[];if(this.view.editable)for(const r of t){const t=this.registerMutation(r,s);t&&(e=e<0?t.from:Math.min(t.from,e),n=n<0?t.to:Math.max(t.to,n),t.typeOver&&(i=!0))}return{from:e,to:n,typeOver:i,addedNodes:s}}applyBrowserSpecificWorkarounds(t){L.gecko&&t.length?this.handleGeckoBRWorkaround(t):(L.chrome||L.safari)&&this.shouldRemoveBogusBRNodes(t)&&this.removeBogusBRNodes(t)}handleGeckoBRWorkaround(t){const e=t.filter(t=>"BR"===t.nodeName);if(2===e.length){const[t,n]=e;t.parentNode?.parentNode===n.parentNode?n.remove():t.remove()}else this.removeUnwantedBRsInListItems(e)}removeUnwantedBRsInListItems(t){const{focusNode:e}=this._currentSelection;for(const n of t){const t=n.parentNode;"LI"!==t?.nodeName||e&&this.blockParent(this.view,e)===t||n.remove()}}shouldRemoveBogusBRNodes(t){return t.some(t=>"BR"===t.nodeName)&&("Backspace"===this.view.input.lastKey||"Delete"===this.view.input.lastKey)}removeBogusBRNodes(t){for(const e of t)if("BR"===e.nodeName&&e.parentNode){const t=e.nextSibling;1===t?.nodeType&&"false"===t.contentEditable&&e.parentNode.removeChild(e)}}shouldRestoreSelectionAfterFocus(t,e,n){if(t>=0||!e)return!1;const{view:i}=this,s=i.input.lastFocus>Date.now()-200,r=Math.max(i.input.lastTouch,i.input.lastClick.time)<Date.now()-300;if(!s||!r||!ii(n))return!1;const o=si(i);return o?.eq(He.near(i.state.doc.resolve(0),1))??!1}restoreSelectionAfterFocus(t){this.view.input.lastFocus=0,ai(this.view),this._currentSelection.set(t),this.view.scrollToSelection()}applyChanges(t,e,n,i,s,r){const{view:o}=this;t>-1&&(o.docView.markDirty(t,e),this.checkCSS(o)),this.handleDOMChange(t,e,n,i),o.docView?.dirty?o.updateState(o.state):this._currentSelection.eq(r)||ai(o),this._currentSelection.set(r)}registerMutation(t,e){if(this.shouldIgnoreMutation(t,e))return null;const n=Zn.nearestViewDesc(this.view.docView,t.target);if(!n||n.ignoreMutation(t))return null;switch(t.type){case"childList":return this.handleChildListMutation(t,n,e);case"attributes":return this.handleAttributeMutation(n);case"characterData":return this.handleCharacterDataMutation(t,n);default:return null}}shouldIgnoreMutation(t,e){if(e.includes(t.target))return!0;const n=Zn.nearestViewDesc(this.view.docView,t.target);return"attributes"===t.type&&(n===this.view.docView||"contenteditable"===t.attributeName||this.isSpuriousStyleMutation(t))}isSpuriousStyleMutation(t){return"style"===t.attributeName&&!t.oldValue&&!t.target.getAttribute("style")}handleChildListMutation(t,e,n){if(this.trackAddedNodes(t,n),this.isContentDOMMutation(t,e))return{from:e.posBefore,to:e.posAfter};const{prev:i,next:s}=this.getSiblingNodes(t);return{from:this.computeFromPosition(t,e,i),to:this.computeToPosition(t,e,s)}}trackAddedNodes(t,e){for(let n=0;n<t.addedNodes.length;n++){const i=t.addedNodes.item(n);e.push(i),3===i.nodeType&&(this._lastChangedTextNode=i)}}isContentDOMMutation(t,e){return e.contentDOM&&e.contentDOM!==e.dom&&!e.contentDOM.contains(t.target)}getSiblingNodes(t){let e=t.previousSibling,n=t.nextSibling;if(L.ie&&L.ie_version<=11&&t.addedNodes.length)for(let i=0;i<t.addedNodes.length;i++){const{previousSibling:s,nextSibling:r}=t.addedNodes.item(i);(!s||Array.prototype.indexOf.call(t.addedNodes,s)<0)&&(e=s),(!r||Array.prototype.indexOf.call(t.addedNodes,r)<0)&&(n=r)}return{prev:e,next:n}}computeFromPosition(t,e,n){const i=n?.parentNode===t.target?En(n)+1:0;return e.localPosFromDOM(t.target,i,-1)}computeToPosition(t,e,n){const i=n?.parentNode===t.target?En(n):t.target.childNodes.length;return e.localPosFromDOM(t.target,i,1)}handleAttributeMutation(t){return{from:t.posAtStart-t.border,to:t.posAtEnd+t.border}}handleCharacterDataMutation(t,e){return this._lastChangedTextNode=t.target,{from:e.posAtStart,to:e.posAtEnd,typeOver:t.target.nodeValue===t.oldValue}}blockParent(t,e){for(let n=e.parentNode;n&&n!==t.dom;n=n.parentNode){const e=Zn.nearestNodeViewDesc(t.docView,n);if(e?.node.isBlock)return n}return null}checkCSS(t){if(this.cssChecked.has(t))return;this.cssChecked.set(t,null);const e=getComputedStyle(t.dom).whiteSpace;["normal","nowrap","pre-line"].includes(e)&&(this.isGeckoHackNodeRequired=L.gecko,this.cssCheckWarned||(this.cssCheckWarned=!0))}};class Eo{constructor(t,e){this.editorView=t,this.width=e.width??1,this.color=!1===e.color?void 0:e.color||"black",this.class=e.class,this.handlers=this.registerEventHandlers()}width;color;class;handlers;cursorPos=null;element=null;timeout=-1;lastDragoverTime=0;dragoverThrottle=16;destroy(){this.clearScheduledRemoval(),this.handlers.forEach(({name:t,handler:e})=>{this.editorView.dom.removeEventListener(t,e)}),this.removeCursorElement()}update(t,e){U(this.cursorPos)||e.doc!==t.state.doc&&(this.cursorPos>t.state.doc.content.size?this.setCursor(null):this.updateOverlay())}registerEventHandlers(){return["dragover","dragend","drop","dragleave"].map(t=>{const e=e=>{this.handleEvent(t,e)};return this.editorView.dom.addEventListener(t,e),{name:t,handler:e}})}setCursor(t){t!==this.cursorPos&&(this.cursorPos=t,U(t)?this.removeCursorElement():this.updateOverlay())}removeCursorElement(){this.element?.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}clearScheduledRemoval(){-1!==this.timeout&&(clearTimeout(this.timeout),this.timeout=-1)}updateOverlay(){if(U(this.cursorPos))return;const t=this.editorView.state.doc.content.size;if(this.cursorPos<0||this.cursorPos>t)return void this.removeCursorElement();let e;try{e=this.editorView.state.doc.resolve(this.cursorPos)}catch(qo){return void this.removeCursorElement()}const n=!e.parent.inlineContent,i=this.calculateCursorRect(e,n);this.ensureCursorElement(n),this.positionCursorElement(i)}calculateCursorRect(t,e){const n=this.editorView.dom,i=n.getBoundingClientRect(),s=n.offsetWidth>0?i.width/n.offsetWidth:1,r=n.offsetHeight>0?i.height/n.offsetHeight:1;if(e){const e=this.calculateBlockCursorRect(t,r);if(e)return e}return this.calculateInlineCursorRect(s)}calculateBlockCursorRect(t,e){if(U(this.cursorPos))return;const n=t.nodeBefore,i=t.nodeAfter;if(!n&&!i)return;const s=this.cursorPos-(n?n.nodeSize:0),r=this.editorView.nodeDOM(s);if(!r)return;const o=r.getBoundingClientRect();let a=n?o.bottom:o.top;if(n&&i){const t=this.editorView.nodeDOM(this.cursorPos);t&&(a=(a+t.getBoundingClientRect().top)/2)}const l=this.width/2*e;return{left:o.left,right:o.right,top:a-l,bottom:a+l}}calculateInlineCursorRect(t){if(U(this.cursorPos))throw new Error("Cannot calculate inline cursor rect without a cursor position");const e=this.editorView.coordsAtPos(this.cursorPos),n=this.width/2*t;return{left:e.left-n,right:e.left+n,top:e.top,bottom:e.bottom}}ensureCursorElement(t){const e=this.editorView.dom.offsetParent||document.body;this.element||(this.element=this.createCursorElement(e)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t)}createCursorElement(t){const e=t.appendChild(document.createElement("div"));return this.class&&(e.className=this.class),e.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(e.style.backgroundColor=this.color),e}positionCursorElement(t){if(!this.element)return;const e=this.editorView.dom,n=e.getBoundingClientRect(),i=e.offsetWidth>0?n.width/e.offsetWidth:1,s=e.offsetHeight>0?n.height/e.offsetHeight:1,{left:r,top:o}=this.getParentOffset();this.element.style.left=(t.left-r)/i+"px",this.element.style.top=(t.top-o)/s+"px",this.element.style.width=(t.right-t.left)/i+"px",this.element.style.height=(t.bottom-t.top)/s+"px"}getParentOffset(){const t=this.editorView.dom.offsetParent;if(!t||t===document.body&&"static"===getComputedStyle(t).position)return{left:-pageXOffset,top:-pageYOffset};const e=t.getBoundingClientRect(),n=t.offsetWidth>0?e.width/t.offsetWidth:1,i=t.offsetHeight>0?e.height/t.offsetHeight:1;return{left:e.left-t.scrollLeft*n,top:e.top-t.scrollTop*i}}scheduleRemoval(t){this.clearScheduledRemoval(),this.timeout=window.setTimeout(()=>{this.setCursor(null)},t)}dragover(t){if(!this.editorView.editable)return;const e=Date.now();if(e-this.lastDragoverTime<this.dragoverThrottle)return void this.scheduleRemoval(5e3);this.lastDragoverTime=e;const n=this.editorView.posAtCoords({left:t.clientX,top:t.clientY});if(!n)return;if(this.isDropCursorDisabled(n,t))return;const i=this.calculateDropPosition(n);this.setCursor(i),this.scheduleRemoval(5e3)}isDropCursorDisabled(t,e){if(t.inside<0)return!1;const n=this.editorView.state.doc.nodeAt(t.inside);if(!n)return!1;const i=n.type.spec.disableDropCursor;return"function"==typeof i?i(this.editorView,t,e):!U(i)&&i}calculateDropPosition(t){let e=t.pos;const n=this.editorView.dragging?.slice;if(n){const t=Se(this.editorView.state.doc,e,n);null!==t&&(e=t)}return e}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(t){const e=t.relatedTarget;e instanceof Node&&!this.editorView.dom.contains(e)&&this.setCursor(null)}handleEvent(t,e){switch(t){case"dragover":this.dragover(e);break;case"dragend":this.dragend();break;case"drop":this.drop();break;case"dragleave":this.dragleave(e)}}}let Co=!1,Mo=null;function ko(t){const e=t.plugins;if(Mo!==e){Co=!1,Mo=e;for(const t of e)if(t.spec.historyPreserveItems){Co=!0;break}}return Co}const Do=new Ge("history"),Io=new Ge("closeHistory");class No{static GOOD_LEAF_SIZE=200;append(t){const e=t.length;if(!e)return this;const n=this.from(t);if(!this.length)return n;if(e<No.GOOD_LEAF_SIZE){const t=this.leafAppend(n);if(t)return t}if(this.length<No.GOOD_LEAF_SIZE){const t=n.leafPrepend(this);if(t)return t}return this.appendInner(n)}prepend(t){return t.length?this.from(t).append(this):this}appendInner(t){return new Oo(this,t)}slice(t=0,e=this.length){return t>=e?this.getEmptySequence():this.sliceInner(Math.max(0,t),Math.min(this.length,e))}get(t){if(!(t<0||t>=this.length))return this.getInner(t)}forEach(t,e=0,n=this.length){e<=n?this.forEachInner(t,e,n,0):this.forEachInvertedInner(t,e,n,0)}map(t,e=0,n=this.length){const i=[];return this.forEach((e,n)=>{i.push(t(e,n))},e,n),i}}class Po extends No{static EMPTY=new Po([]);depth=0;values=[];constructor(t){super(),this.values=t}get length(){return this.values.length}flatten(){return this.values}forEachInner(t,e,n,i){for(let s=e;s<n;s++)if(j(t(this.values[s],i+s)))return!1}forEachInvertedInner(t,e,n,i){for(let s=e-1;s>=n;s--)if(j(t(this.values[s],i+s)))return!1}leafAppend(t){if(this.length+t.length<=No.GOOD_LEAF_SIZE)return new Po(this.values.concat(t.flatten()))}leafPrepend(t){if(this.length+t.length<=No.GOOD_LEAF_SIZE)return new Po(t.flatten().concat(this.values))}sliceInner(t,e){return 0===t&&e===this.length?this:new Po(this.values.slice(t,e))}getInner(t){return this.values[t]}getEmptySequence(){return Po.EMPTY}from(t){return t instanceof No?t:t?.length?new Po(t):Po.EMPTY}}let Oo=class t extends No{depth;len;left;right;constructor(t,e){super(),this.left=t,this.right=e,this.len=t.length+e.length,this.depth=Math.max(t.depth,e.depth)+1}get length(){return this.len}flatten(){return this.left.flatten().concat(this.right.flatten())}forEachInner(t,e,n,i){const s=this.left.length;return!(e<s&&j(this.left.forEachInner(t,e,Math.min(n,s),i)))&&!(n>s&&j(this.right.forEachInner(t,Math.max(e-s,0),Math.min(this.length,n)-s,i+s)))&&void 0}forEachInvertedInner(t,e,n,i){const s=this.left.length;return!(e>s&&j(this.right.forEachInvertedInner(t,e-s,Math.max(n,s)-s,i+s)))&&!(n<s&&j(this.left.forEachInvertedInner(t,Math.min(e,s),n,i)))&&void 0}leafAppend(e){const n=this.right.leafAppend(e);if(n)return new t(this.left,n)}leafPrepend(e){const n=this.left.leafPrepend(e);if(n)return new t(n,this.right)}appendInner(e){return this.left.depth>=Math.max(this.right.depth,e.depth)+1?new t(this.left,new t(this.right,e)):new t(this,e)}getInner(t){const e=t<this.left.length?this.left.get(t):this.right.get(t-this.left.length);if(void 0===e)throw new Error(`Index ${t} out of bounds in rope of length ${this.length}`);return e}sliceInner(t,e){if(0===t&&e===this.length)return this;const n=this.left.length;return e<=n?this.left.slice(t,e):t>=n?this.right.slice(t-n,e-n):this.left.slice(t,n).append(this.right.slice(0,e-n))}getEmptySequence(){return Po.EMPTY}from(t){return t instanceof No?t:t?.length?new Po(t):Po.EMPTY}};const Ro=new Po([]);let Bo=class t{_map;_step;_selection;_mirrorOffset;constructor(t,e,n,i){this._map=t,this._step=e,this._selection=n,this._mirrorOffset=i}get map(){return this._map}get step(){return this._step}get selection(){return this._selection}get mirrorOffset(){return this._mirrorOffset}merge(e){if(this._step&&e._step&&!e._selection){const n=e._step.merge(this._step);if(n)return new t(n.getMap().invert(),n,this._selection)}}};class Fo{static empty=new Fo(Ro,0);static MAX_EMPTY_ITEMS=500;static DEPTH_OVERFLOW=20;items;_eventCount;constructor(t,e){this.items=t,this._eventCount=e||0}get eventCount(){return this._eventCount}popEvent(t,e){if(0===this._eventCount)return null;const n=this.findEventEnd();let i,s;e&&(i=this.remapping(n,this.items.length),s=i.maps.length);const r=t.transaction;let o,a;const l=[],c=[];return this.items.forEach((t,e)=>{if(!t.step){const r=this.handleMapOnlyItem(t,n,e,c,i,s);return i=r.remap,void(s=r.mapFrom)}if(i){const e=this.handleItemWithRemapping(t,r,i,s,c,l);i=e.remap,s=e.mapFrom}else r.maybeStep(t.step);if(t.selection){o=i?t.selection.map(i.slice(s)):t.selection;const e=c.length>0?[...c].reverse().concat(l):l;return a=new Fo(this.items.slice(0,n).append(e),this._eventCount-1),!1}},this.items.length,0),a&&o?{remaining:a,transform:r,selection:o}:null}addTransform(t,e,n,i){const s=[];let r=this._eventCount,o=this.items,a=this.getLastItemForMerging(i,o);for(let c=0;c<t.steps.length;c++){const n=t.steps[c].invert(t.docs[c]);let l=new Bo(t.mapping.maps[c],n,e);const h=a?.merge(l);h&&(l=h,c>0?s.pop():o=o.slice(0,o.length-1)),s.push(l),e&&(r++,e=void 0),i||(a=l)}const l=r-n.depth;return l>Fo.DEPTH_OVERFLOW&&(o=this.cutOffEvents(o,l),r-=l),new Fo(o.append(s),r)}addMaps(t){if(0===this._eventCount)return this;const e=this.items.append(t.map(t=>new Bo(t)));return new Fo(e,this._eventCount)}rebased(t,e){if(!this._eventCount)return this;const n=[],i=Math.max(0,this.items.length-e),s=t.mapping;let r=t.steps.length,o=this._eventCount;this.items.forEach(t=>{t.selection&&o--},i);let a=e;this.items.forEach(e=>{const i=s.getMirror(--a);if(U(i))return;r=Math.min(r,i);const l=s.maps[i];if(e.step){const r=t.steps[i].invert(t.docs[i]),c=e.selection?.map(s.slice(a+1,i));c&&o++,n.push(new Bo(l,r,c))}else n.push(new Bo(l))},i);const l=[];for(let d=e;d<r;d++)l.push(new Bo(s.maps[d]));const c=this.items.slice(0,i).append(l).append(n);let h=new Fo(c,o);return h.emptyItemCount()>Fo.MAX_EMPTY_ITEMS&&(h=h.compress(this.items.length-n.length)),h}findEventEnd(){let t=this.items.length;for(;t>0;){if(this.items.get(t-1).selection){t--;break}t--}return t}handleMapOnlyItem(t,e,n,i,s,r){let o=s,a=r;return o||(o=this.remapping(e,n+1),a=o.maps.length),i.push(t),{remap:o,mapFrom:a-1}}handleItemWithRemapping(t,e,n,i,s,r){if(void 0===i)throw new Error("Invalid state: mapFrom must be defined when remapping is active");s.push(new Bo(t.map));const o=t.step?t.step.map(n.slice(i)):void 0;let a;if(o&&e.maybeStep(o).doc){const t=e.mapping.maps;a=t[t.length-1],r.push(new Bo(a,void 0,void 0,r.length+s.length))}const l=i-1;return a&&n.appendMap(a,l),{remap:n,mapFrom:l}}getLastItemForMerging(t,e){return!t&&e.length>0?e.get(e.length-1):null}compress(t=this.items.length){const e=this.remapping(0,t);let n=e.maps.length;const i=[];let s=0;return this.items.forEach((r,o)=>{if(o>=t)i.push(r),r.selection&&s++;else if(r.step){const t=r.step.map(e.slice(n)),o=t?.getMap();if(n--,o&&e.appendMap(o,n),t){const a=r.selection?.map(e.slice(n));a&&s++;const l=new Bo(o.invert(),t,a);if(i.length>0){const t=i.length-1,e=i[t].merge(l);e?i[t]=e:i.push(l)}else i.push(l)}}else r.map&&n--},this.items.length,0),new Fo((r=i.reverse())instanceof No?r:r?.length?new Po(r):Po.EMPTY,s);var r}emptyItemCount(){let t=0;return this.items.forEach(e=>{e.step||t++}),t}remapping(t,e){const n=new ie;return this.items.forEach((e,i)=>{const s=null!==e.mirrorOffset&&i-e.mirrorOffset>=t?n.maps.length-e.mirrorOffset:void 0;n.appendMap(e.map,s)},t,e),n}cutOffEvents(t,e){let n,i=e;return t.forEach((t,e)=>{if(t.selection){if(0===i)return n=e,!1;i--}}),void 0!==n?t.slice(n):t.slice(t.length)}}let Lo=class t{_done;_undone;_prevRanges;_prevTime;_prevComposition;constructor(t,e,n,i,s){this._done=t,this._undone=e,this._prevRanges=n,this._prevTime=i,this._prevComposition=s}get done(){return this._done}set done(t){this._done=t}get undone(){return this._undone}get prevRanges(){return this._prevRanges}get prevTime(){return this._prevTime}get prevComposition(){return this._prevComposition}static createEmpty(){return new t(Fo.empty,Fo.empty,null,0,-1)}static createClosed(e,n){return new t(e,n,null,0,-1)}};function zo(t,e){return(n,i)=>{const s=Do.getState(n);if(!s)return!1;if(0===(t?s.undone:s.done).eventCount)return!1;if(i){const r=function(t,e,n){const i=function(t){const e=Do.get(t);return e?e.spec.config:null}(e);if(!i)return null;const s=ko(e),r=(o=t,a=e,l=s,n?o.undone.popEvent(a,l):o.done.popEvent(a,l));var o,a,l;if(!r)return null;const c=r.selection.resolve(r.transform.doc),h=function(t,e,n,i,s,r){const o=n.selection.getBookmark();if(i){const n=t.done.addTransform(e.transform,o,s,r);return new Lo(n,e.remaining,null,0,-1)}{const n=t.undone.addTransform(e.transform,o,s,r);return new Lo(e.remaining,n,null,0,-1)}}(t,r,e,n,i,s);return r.transform.setSelection(c).setMeta(Do,{redo:n,historyState:h})}(s,n,t);r&&i(e?r.scrollIntoView():r)}return!0}}const Vo=zo(!0,!0),Ho=zo(!1,!0);function $o(t,e){if(!t||0===t.length)return null;const n=[];for(let i=0;i<t.length&&!(i+1>=t.length);i+=2){const s=e.map(t[i],1),r=e.map(t[i+1],-1);s<=r&&n.push(s,r)}return n.length>0?n:null}function Uo(t){const e=[];for(let n=t.length-1;n>=0&&0===e.length;n--)t[n].forEach((t,n,i,s)=>{e.push(i,s)});return e}for(var Wo={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},Go={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},jo="undefined"!=typeof navigator&&/Mac/.test(navigator.platform),Ko="undefined"!=typeof navigator&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent),qo=0;qo<10;qo++)Wo[48+qo]=Wo[96+qo]=String(qo);for(qo=1;qo<=24;qo++)Wo[qo+111]="F"+qo;for(qo=65;qo<=90;qo++)Wo[qo]=String.fromCharCode(qo+32),Go[qo]=String.fromCharCode(qo);for(var Yo in Wo)Go.hasOwnProperty(Yo)||(Go[Yo]=Wo[Yo]);const Xo={Space:fs("Space"),"Meta-b":ir(Tn.marks.strong),"Meta-i":ir(Tn.marks.em),"Meta-u":ir(Tn.marks.underline),"Meta-s":ir(Tn.marks.strikethrough),"Meta-h":ir(Tn.marks.highlight),"Meta-,":ir(Tn.marks.subscript),"Meta-.":ir(Tn.marks.superscript),"Meta-Shift-l":Hs(Tn.nodes.paragraph,{textAlign:"left"}),"Meta-shift-e":Hs(Tn.nodes.paragraph,{textAlign:"center"}),"Meta-shift-r":Hs(Tn.nodes.paragraph,{textAlign:"right"}),"Meta-Shift-j":Hs(Tn.nodes.paragraph,{textAlign:"justify"}),"Meta-Alt-0":function(t,e){let n=0;const i=t.transaction,{from:s,to:r}=i.selection;return["strong","em","underline","link"].forEach(e=>{t.schema.marks[e]&&(i.removeMark(s,r,t.schema.marks[e]),n++)}),n&&e&&e(i),n>0},"Meta-Alt-1":Hs(Tn.nodes.heading,{level:1}),"Meta-Alt-2":Hs(Tn.nodes.heading,{level:2}),"Meta-Alt-3":Hs(Tn.nodes.heading,{level:3}),"Meta-Alt-4":Hs(Tn.nodes.heading,{level:4}),"Meta-Alt-5":Hs(Tn.nodes.heading,{level:5}),"Meta-Alt-6":Hs(Tn.nodes.heading,{level:6}),"Meta-Shift-7":dn(Tn.nodes.ordered_list),"Meta-Shift-8":dn(Tn.nodes.bullet_list),"Meta-Shift-b":function(t,e=null){return(n,i)=>{const{$from:s,$to:r}=n.selection,o=s.blockRange(r),a=o&&ke(o,t,e);return!!a&&(i&&i(n.transaction.wrap(o,a).scrollIntoView()),!0)}}(Tn.nodes.blockquote),"Meta-e":ir(Tn.marks.code),"Meta-Alt-c":Hs(Tn.nodes.code_block),"Meta-z":Ho,"Shift-Meta-z":Vo,Enter:As(fs("Enter"),function(t){return(e,n)=>{const{$from:i,$to:s,node:r}=e.selection;if(!function(t,e,n,i){if(n?.isBlock||t.depth<2||!t.sameParent(e))return!1;return t.node(-1).type===i}(i,s,r,t))return!1;if(a=t,0===(o=i).parent.content.size&&o.node(-1).childCount===o.indexAfter(-1)&&o.depth>=3&&o.node(-3).type===a&&o.index(-2)===o.node(-2).childCount-1)return n&&function(t,e,n,i){let s=Z.empty;const r=(o=n).index(-1)?1:o.index(-2)?2:3;var o;for(let d=n.depth-r;d>=n.depth-3;d--)s=Z.from(n.node(d).copy(s));const a=function(t){return t.indexAfter(-1)<t.node(-2).childCount?1:t.indexAfter(-2)<t.node(-3).childCount?2:3}(n);s=s.append(Z.from(i.createAndFill()));const l=n.before(n.depth-(r-1)),c=t.transaction.replace(l,n.after(-a),new tt(s,4-r,0)),h=function(t,e){let n=-1;return t.doc.nodesBetween(e,t.doc.content.size,(t,e)=>!(n>-1||(t.isTextblock&&0===t.content.size&&(n=e+1),0))),n}(c,l);h>-1&&c.setSelection(He.near(c.doc.resolve(h))),e(c.scrollIntoView())}(e,n,i,t),!0;var o,a;if(function(t){return 0===t.parent.content.size&&t.node(-1).childCount===t.indexAfter(-1)}(i))return!1;const l=e.transaction.delete(i.pos,s.pos),c=void 0;return!!Rt(l.doc,i.pos,2,c)&&(n&&n(l.split(i.pos,2,c).scrollIntoView()),!0)}}(Tn.nodes.list_item),(t,e)=>{const{$head:n,$anchor:i}=t.selection;return!(!n.parent.type.spec.code||!n.sameParent(i)||(e&&e(t.transaction.insertText("\n").scrollIntoView()),0))},(t,e)=>{const n=t.selection,{$from:i,$to:s}=n;if(n.isAllSelection()||i.parent.inlineContent||s.parent.inlineContent)return!1;const r=function(t){for(let e=0;e<t.edgeCount;e++){const{type:n}=t.edge(e);if(n.isTextblock&&!n.hasRequiredAttrs())return n}return null}(s.parent.contentMatchAt(s.indexAfter()));if(!r?.isTextblock)return!1;if(e){const n=(a=s,!(o=i).parentOffset&&a.index()<a.parent.childCount?o.pos:a.pos),l=r.createAndFill(),c=t.transaction.insert(n,l),h=n+1;c.setSelection(Je.create(c.doc,h)),e(c.scrollIntoView())}var o,a;return!0},(t,e)=>{const{$cursor:n}=t.selection;if(!n||n.parent.content.size>0)return!1;if((i=n).depth>1&&i.after()!==i.end(-1)){const i=n.before();if(Rt(t.doc,i))return e&&e(t.transaction.split(i).scrollIntoView()),!0}var i;const s=n.blockRange(),r=s&&Ie(s);return!U(r)&&(e&&e(t.transaction.lift(s,r).scrollIntoView()),!0)},Zs),"Mod-Enter":As(_s,Ts(Tn.nodes.hard_break)),"Shift-Enter":As(_s,Ts(Tn.nodes.hard_break)),Backspace:As(hs("Backspace"),xs),"Mod-Backspace":xs,"Shift-Backspace":xs,Delete:As(hs("Delete"),Ss),"Mod-Delete":Ss,"Mod-a":(t,e)=>(e&&e(t.transaction.setSelection(Qe.createAllSelection(t.doc))),!0),Tab:function(t){return(e,n)=>{const{$from:i,$to:s}=e.selection,r=i.blockRange(s,e=>e.childCount>0&&e.firstChild.type===t);if(!r)return!1;const o=r.startIndex;if(0===o)return!1;const a=r.parent,l=a.child(o-1);if(l.type!==t)return!1;if(n){const i=l.lastChild?.type===a.type,s=Z.from(i?t.create():null),o=new tt(Z.from(t.create(null,Z.from(a.type.create(null,s)))),i?3:1,0),c=r.start,h=r.end;n(e.transaction.step(new ee(c-(i?3:1),h,c,h,o,1,!0)).scrollIntoView())}return!0}}(Tn.nodes.list_item),"Shift-Tab":function(t){return(e,n)=>{const{$from:i,$to:s}=e.selection,r=i.blockRange(s,e=>e.childCount>0&&e.firstChild.type===t);return!!r&&(!n||(i.node(r.depth-1).type===t?function(t,e,n,i){const s=t.transaction,r=i.end,o=i.$to.end(i.depth);r<o&&(s.step(new ee(r-1,o,r,o,new tt(Z.from(n.create(null,i.parent.copy())),1,0),1,!0)),i=new mt(s.doc.resolve(i.$from.pos),s.doc.resolve(o),i.depth));const a=Ie(i);if(U(a))return!1;s.lift(i,a);const l=s.doc.resolve(s.mapping.map(r,-1)-1);return Ot(s.doc,l.pos)&&l.nodeBefore.type===l.nodeAfter.type&&s.join(l.pos),e(s.scrollIntoView()),!0}(e,n,t,r):function(t,e,n){const i=t.transaction,s=n.parent;!function(t,e,n,i,s){let r=s,o=i-1;for(;o>n;)r-=e.child(o).nodeSize,t.delete(r-1,r+1),o--}(i,s,n.startIndex,n.endIndex,n.end);const r=i.doc.resolve(n.start),o=r.nodeAfter;if(i.mapping.map(n.end)!==n.start+r.nodeAfter.nodeSize)return!1;const a=0===n.startIndex,l=n.endIndex===s.childCount,c=r.node(-1),h=r.index(-1);if(!c.canReplace(h+(a?0:1),h+1,o.content.append(l?Z.empty:Z.from(s))))return!1;const d=r.pos,u=d+o.nodeSize,p=function(t,e,n){const i=e?Z.empty:Z.from(t.copy(Z.empty)),s=n?Z.empty:Z.from(t.copy(Z.empty));return i.append(s)}(s,a,l);return i.step(new ee(d-(a?1:0),u+(l?1:0),d+1,u-1,new tt(p,a?0:1,l?0:1),a?0:1)),e(i.scrollIntoView()),!0}(e,n,r)))}}(Tn.nodes.list_item),ArrowLeft:ks,ArrowRight:Ds,ArrowUp:Rs,ArrowDown:As(Bs,js),"Mod-+":function(t,e,n){return mr("in")(t,e,n)},"Mod--":function(t,e,n){return mr("out")(t,e,n)},"Mod-0":function(t,e,n){return mr("reset")(t,e,n)}},Jo={"Ctrl-h":Xo.Backspace,"Alt-Backspace":Xo["Mod-Backspace"],"Ctrl-d":Xo.Delete,"Ctrl-Alt-Backspace":Xo["Mod-Delete"],"Alt-Delete":Xo["Mod-Delete"],"Alt-d":Xo["Mod-Delete"],"Ctrl-a":Ns,"Ctrl-e":Ps,...Xo},Qo=L.mac?Jo:Xo;function Zo(t){const e=function(t){const e={};for(const n in t){if(!K(t,n))continue;const i=na(n);if(K(e,i))throw new Error(`Multiple bindings for key ${i} in a single keymap`);e[i]=t[n]}return e}(t);return function(t,n){const i=(r=n,"Esc"==(o=!(jo&&r.metaKey&&r.shiftKey&&!r.ctrlKey&&!r.altKey||Ko&&r.shiftKey&&r.key&&1==r.key.length||"Unidentified"==r.key)&&r.key||(r.shiftKey?Go:Wo)[r.keyCode]||r.key||"Unidentified")&&(o="Escape"),"Del"==o&&(o="Delete"),"Left"==o&&(o="ArrowLeft"),"Up"==o&&(o="ArrowUp"),"Right"==o&&(o="ArrowRight"),"Down"==o&&(o="ArrowDown"),o),s=e=>!!e&&e(t.state,t.dispatch,t);var r,o,a,l;if(s(e[ia(i,n)]))return!0;if(1!==(a=i).length||" "===a)return!1;if(n.shiftKey&&s(e[ia(i,n,!1)]))return!0;if(((l=n).altKey||l.metaKey||l.ctrlKey)&&!function(t){return L.windows&&t.ctrlKey&&t.altKey}(n)){const t=Wo[n.keyCode];if(t&&t!==i&&s(e[ia(t,n)]))return!0}return!1}}const ta={meta:/^(cmd|meta|m)$/i,alt:/^a(lt)?$/i,ctrl:/^(c|ctrl|control)$/i,shift:/^s(hift)?$/i,mod:/^mod$/i};function ea(t,e){if(ta.meta.test(t))e.meta=!0;else if(ta.alt.test(t))e.alt=!0;else if(ta.ctrl.test(t))e.ctrl=!0;else if(ta.shift.test(t))e.shift=!0;else{if(!ta.mod.test(t))throw new Error(`Unrecognized modifier name: ${t}`);L.mac?e.meta=!0:e.ctrl=!0}}function na(t){const e=t.split(/-(?!$)/),n=e.length-1;let i=e[n];"Space"===i&&(i=" ");const s={alt:!1,ctrl:!1,shift:!1,meta:!1};for(let r=0;r<n;r++)ea(e[r],s);return function(t,e){let n=t;return e.shift&&(n=`Shift-${n}`),e.meta&&(n=`Meta-${n}`),e.ctrl&&(n=`Ctrl-${n}`),e.alt&&(n=`Alt-${n}`),n}(i,s)}function ia(t,e,n=!0){let i=t;return n&&e.shiftKey&&(i=`Shift-${i}`),e.metaKey&&(i=`Meta-${i}`),e.ctrlKey&&(i=`Ctrl-${i}`),e.altKey&&(i=`Alt-${i}`),i}class sa extends He{static TYPE_GAP_CURSOR="gapcursor";constructor(t){super(t,t),super.visible=!1}get type(){return sa.TYPE_GAP_CURSOR}static fromJSON(t,e){if("number"!=typeof e.pos)throw new RangeError("Invalid input for GapCursor.fromJSON");return new sa(t.resolve(e.pos))}static valid(t){const e=t.parent;if(e.isTextblock||!sa.closedBefore(t)||!sa.closedAfter(t))return!1;const n=e.type.spec.allowGapCursor;if(!U(n))return W(n);const i=e.contentMatchAt(t.index()).defaultType;return i?.isTextblock??!1}static findGapCursorFrom(t,e,n=!1){const i=e>0?1:-1;let s=t,r=n;for(;;){if(!r&&this.valid(s))return s;const t=this.searchForGapPosition(s,i);if(t.found)return t.position;if(!t.shouldContinue||!t.nextSearchPos)return null;s=t.nextSearchPos,r=!1}}static searchForGapPosition(t,e){const n=1===e,i=this.findSiblingNode(t,n);if(U(i))return{found:!1,position:null,shouldContinue:!1};const s=this.checkPositionsWhileScanningUp(t,n);if(null!==s)return{found:!0,position:s,shouldContinue:!1};const r=this.calculateSiblingBoundaryPosition(t,n),o=this.scanDownIntoNode(i,r,t.doc,n);return null!==o.validPosition?{found:!0,position:o.validPosition,shouldContinue:!1}:{found:!1,position:null,shouldContinue:o.shouldSkipAtom,nextSearchPos:o.nextPosition}}static findSiblingNode(t,e){for(let n=t.depth;n>=0;n--){const i=t.node(n);if(e?t.indexAfter(n)<i.childCount:t.index(n)>0){const s=e?t.indexAfter(n):t.index(n)-1;return i.child(s)}if(0===n)return null}return null}static calculateSiblingBoundaryPosition(t,e){let n=t.pos;const i=e?1:-1;for(let s=t.depth;s>=0;s--){const r=t.node(s);if(e?t.indexAfter(s)<r.childCount:t.index(s)>0)break;n+=i}return n}static checkPositionsWhileScanningUp(t,e){let n=t.pos;const i=e?1:-1;for(let s=t.depth;s>=0;s--){const r=t.node(s);if(e?t.indexAfter(s)<r.childCount:t.index(s)>0)return null;if(0===s)return null;n+=i;const o=t.doc.resolve(n);if(this.valid(o))return o}return null}static scanDownIntoNode(t,e,n,i){let s=t,r=e;const o=i?1:-1;for(;;){const t=i?s.firstChild:s.lastChild;if(!t){if(this.isNonSelectableAtom(s)){const t=r+s.nodeSize*o;if(t>=0&&t<=n.content.size)return{validPosition:null,shouldSkipAtom:!0,nextPosition:n.resolve(t)}}break}s=t,r+=o;const e=n.resolve(r);if(this.valid(e))return{validPosition:e,shouldSkipAtom:!1}}return{validPosition:null,shouldSkipAtom:!1}}static isNonSelectableAtom(t){return t.isAtom&&!t.isText&&!He.isNodeSelectable(t)}static closedBefore(t){return this.checkClosedSide(t,!1)}static closedAfter(t){return this.checkClosedSide(t,!0)}static checkClosedSide(t,e){for(let n=t.depth;n>=0;n--){const i=t.node(n),s=e?t.indexAfter(n):t.index(n);if(e?s===i.childCount:0===s){if(i.type.spec.isolating)return!0;continue}const r=e?i.child(s):i.child(s-1);if(r.inlineContent)return!1;if(this.isNodeClosedOnSide(r,e))return!0}return!0}static isNodeClosedOnSide(t,e){let n=t;for(;n;){if(0===n.childCount&&!n.inlineContent||this.needsGap(n.type))return!0;if(n.inlineContent)return!1;const t=e?n.firstChild:n.lastChild;if(!t)break;n=t}return!1}static needsGap(t){return t.isAtom||t.spec.isolating||W(t.spec.createGapCursor)}map(t,e){const n=t.resolve(e.map(this.head));return sa.valid(n)?new sa(n):He.near(n)}content(){return tt.empty}eq(t){return t instanceof sa&&t.head===this.head}toJSON(){return{type:"gapcursor",pos:this.head}}getBookmark(){return new ra(this.anchor)}replace(){}replaceWith(){}}class ra{pos;constructor(t){this.pos=t}map(t){return new ra(t.map(this.pos))}resolve(t){const e=t.resolve(this.pos);return sa.valid(e)?new sa(e):He.near(e)}}const oa=Zo({ArrowLeft:aa("horiz",-1),ArrowRight:aa("horiz",1),ArrowUp:aa("vert",-1),ArrowDown:aa("vert",1)});function aa(t,e){const n="vert"===t?e>0?"down":"up":e>0?"right":"left";return function(t,i,s){const r=t.selection;let o=e>0?r.$to:r.$from,a=r.empty;if(r.isTextSelection()){if(!s.endOfTextblock(n)||0===o.depth)return!1;a=!1,o=t.doc.resolve(e>0?o.after():o.before())}const l=sa.findGapCursorFrom(o,e,a);return!!l&&(i&&i(t.transaction.setSelection(new sa(l))),!0)}}function la(t,e,n){if(!t?.editable)return!1;const i=t.state.doc.resolve(e);if(!sa.valid(i))return!1;const s=t.posAtCoords({left:n.clientX,top:n.clientY});if(s&&s.inside>-1){const e=t.state.doc.nodeAt(s.inside);if(e&&He.isNodeSelectable(e))return!1}return t.dispatch(t.state.transaction.setSelection(new sa(i))),!0}function ca(t,e){if("insertCompositionText"!==e.inputType||!(t.state.selection instanceof sa))return!1;const{$from:n}=t.state.selection,i=t.state.schema.nodes.text;if(!i)return!1;const s=n.parent.contentMatchAt(n.index()).findWrapping(i);if(!s)return!1;let r=Z.empty;for(let a=s.length-1;a>=0;a--)r=Z.from(s[a].createAndFill(null,r));const o=t.state.transaction.replace(n.pos,n.pos,new tt(r,0,0));return o.setSelection(He.near(o.doc.resolve(n.pos+1))),t.dispatch(o),!1}let ha=null;function da(t){return t.selection instanceof sa?(ha||(ha=document.createElement("div"),ha.className="ProseMirror-gapcursor"),vi.create(t.doc,[bi.widget(t.selection.head,ha,{key:"gapcursor"})])):null}const ua=!("object"!=typeof process||process+""!="[object process]"||process.versions.nw||process.versions.electron&&process.type&&"browser"!==process.type),pa=[.001,0,0,.001,0,0],fa=1.35,ma=1,ga=2,ya=4,ba=16,wa=32,va=64,Aa=128,xa=256,Sa={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3},_a="pdfjs_internal_editor_",Ta={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15,POPUP:16,SIGNATURE:101,COMMENT:102},Ea={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_THICKNESS:32,HIGHLIGHT_FREE:33,HIGHLIGHT_SHOW_ALL:34,DRAW_STEP:41},Ca=1,Ma=2,ka=0,Da=1,Ia=2,Na=3,Pa=3,Oa=4,Ra={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3},Ba={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26},Fa=1,La=2,za=3,Va=4,Ha=5,$a={ERRORS:0,WARNINGS:1,INFOS:5},Ua={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93,rawFillPath:94},Wa=0,Ga=1,ja=2,Ka=3,qa=4;let Ya=$a.WARNINGS;function Xa(){return Ya}function Ja(t){Ya>=$a.INFOS&&console.info(`Info: ${t}`)}function Qa(t){Ya>=$a.WARNINGS&&console.warn(`Warning: ${t}`)}function Za(t){throw new Error(t)}function tl(t,e){t||Za(e)}function el(t,e=null,n=null){if(!t)return null;if(n&&"string"==typeof t){if(n.addDefaultProtocol&&t.startsWith("www.")){const e=t.match(/\./g);e?.length>=2&&(t=`http://${t}`)}if(n.tryConvertEncoding)try{t=decodeURIComponent(escape(t))}catch{}}const i=e?URL.parse(t,e):URL.parse(t);return function(t){switch(t?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return!0;default:return!1}}(i)?i:null}function nl(t,e,n=!1){const i=URL.parse(t);return i?(i.hash=e,i.href):n&&el(t,"http://example.com")?t.split("#",1)[0]+""+(e?`#${e}`:""):""}function il(t,e,n,i=!1){return Object.defineProperty(t,e,{value:n,enumerable:!i,configurable:!0,writable:!1}),n}const sl=function(){function t(t,e){this.message=t,this.name=e}return t.prototype=new Error,t.constructor=t,t}();class rl extends sl{constructor(t,e){super(t,"PasswordException"),this.code=e}}class ol extends sl{constructor(t,e){super(t,"UnknownErrorException"),this.details=e}}class al extends sl{constructor(t){super(t,"InvalidPDFException")}}class ll extends sl{constructor(t,e,n){super(t,"ResponseException"),this.status=e,this.missing=n}}class cl extends sl{constructor(t){super(t,"FormatError")}}class hl extends sl{constructor(t){super(t,"AbortException")}}function dl(t){"string"!=typeof t&&Za("Invalid argument for stringToBytes");const e=t.length,n=new Uint8Array(e);for(let i=0;i<e;++i)n[i]=255&t.charCodeAt(i);return n}class ul{static get isLittleEndian(){return il(this,"isLittleEndian",function(){const t=new Uint8Array(4);return t[0]=1,1===new Uint32Array(t.buffer,0,1)[0]}())}static get isEvalSupported(){return il(this,"isEvalSupported",function(){try{return new Function(""),!0}catch{return!1}}())}static get isOffscreenCanvasSupported(){return il(this,"isOffscreenCanvasSupported","undefined"!=typeof OffscreenCanvas)}static get isImageDecoderSupported(){return il(this,"isImageDecoderSupported","undefined"!=typeof ImageDecoder)}static get isFloat16ArraySupported(){return il(this,"isFloat16ArraySupported","undefined"!=typeof Float16Array)}static get isSanitizerSupported(){return il(this,"isSanitizerSupported","undefined"!=typeof Sanitizer)}static get platform(){const{platform:t,userAgent:e}=navigator;return il(this,"platform",{isAndroid:e.includes("Android"),isLinux:t.includes("Linux"),isMac:t.includes("Mac"),isWindows:t.includes("Win"),isFirefox:e.includes("Firefox")})}static get isCSSRoundSupported(){return il(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}const pl=Array.from(Array(256).keys(),t=>t.toString(16).padStart(2,"0"));class fl{static makeHexColor(t,e,n){return`#${pl[t]}${pl[e]}${pl[n]}`}static domMatrixToTransform(t){return[t.a,t.b,t.c,t.d,t.e,t.f]}static scaleMinMax(t,e){let n;t[0]?(t[0]<0&&(n=e[0],e[0]=e[2],e[2]=n),e[0]*=t[0],e[2]*=t[0],t[3]<0&&(n=e[1],e[1]=e[3],e[3]=n),e[1]*=t[3],e[3]*=t[3]):(n=e[0],e[0]=e[1],e[1]=n,n=e[2],e[2]=e[3],e[3]=n,t[1]<0&&(n=e[1],e[1]=e[3],e[3]=n),e[1]*=t[1],e[3]*=t[1],t[2]<0&&(n=e[0],e[0]=e[2],e[2]=n),e[0]*=t[2],e[2]*=t[2]),e[0]+=t[4],e[1]+=t[5],e[2]+=t[4],e[3]+=t[5]}static transform(t,e){return[t[0]*e[0]+t[2]*e[1],t[1]*e[0]+t[3]*e[1],t[0]*e[2]+t[2]*e[3],t[1]*e[2]+t[3]*e[3],t[0]*e[4]+t[2]*e[5]+t[4],t[1]*e[4]+t[3]*e[5]+t[5]]}static multiplyByDOMMatrix(t,e){return[t[0]*e.a+t[2]*e.b,t[1]*e.a+t[3]*e.b,t[0]*e.c+t[2]*e.d,t[1]*e.c+t[3]*e.d,t[0]*e.e+t[2]*e.f+t[4],t[1]*e.e+t[3]*e.f+t[5]]}static applyTransform(t,e,n=0){const i=t[n],s=t[n+1];t[n]=i*e[0]+s*e[2]+e[4],t[n+1]=i*e[1]+s*e[3]+e[5]}static applyTransformToBezier(t,e,n=0){const i=e[0],s=e[1],r=e[2],o=e[3],a=e[4],l=e[5];for(let c=0;c<6;c+=2){const e=t[n+c],h=t[n+c+1];t[n+c]=e*i+h*r+a,t[n+c+1]=e*s+h*o+l}}static applyInverseTransform(t,e){const n=t[0],i=t[1],s=e[0]*e[3]-e[1]*e[2];t[0]=(n*e[3]-i*e[2]+e[2]*e[5]-e[4]*e[3])/s,t[1]=(-n*e[1]+i*e[0]+e[4]*e[1]-e[5]*e[0])/s}static axialAlignedBoundingBox(t,e,n){const i=e[0],s=e[1],r=e[2],o=e[3],a=e[4],l=e[5],c=t[0],h=t[1],d=t[2],u=t[3];let p=i*c+a,f=p,m=i*d+a,g=m,y=o*h+l,b=y,w=o*u+l,v=w;if(0!==s||0!==r){const t=s*c,e=s*d,n=r*h,i=r*u;p+=n,g+=n,m+=i,f+=i,y+=t,v+=t,w+=e,b+=e}n[0]=Math.min(n[0],p,m,f,g),n[1]=Math.min(n[1],y,w,b,v),n[2]=Math.max(n[2],p,m,f,g),n[3]=Math.max(n[3],y,w,b,v)}static inverseTransform(t){const e=t[0]*t[3]-t[1]*t[2];return[t[3]/e,-t[1]/e,-t[2]/e,t[0]/e,(t[2]*t[5]-t[4]*t[3])/e,(t[4]*t[1]-t[5]*t[0])/e]}static singularValueDecompose2dScale(t,e){const n=t[0],i=t[1],s=t[2],r=t[3],o=n**2+i**2,a=n*s+i*r,l=s**2+r**2,c=(o+l)/2,h=Math.sqrt(c**2-(o*l-a**2));e[0]=Math.sqrt(c+h||1),e[1]=Math.sqrt(c-h||1)}static normalizeRect(t){const e=t.slice(0);return t[0]>t[2]&&(e[0]=t[2],e[2]=t[0]),t[1]>t[3]&&(e[1]=t[3],e[3]=t[1]),e}static intersect(t,e){const n=Math.max(Math.min(t[0],t[2]),Math.min(e[0],e[2])),i=Math.min(Math.max(t[0],t[2]),Math.max(e[0],e[2]));if(n>i)return null;const s=Math.max(Math.min(t[1],t[3]),Math.min(e[1],e[3])),r=Math.min(Math.max(t[1],t[3]),Math.max(e[1],e[3]));return s>r?null:[n,s,i,r]}static pointBoundingBox(t,e,n){n[0]=Math.min(n[0],t),n[1]=Math.min(n[1],e),n[2]=Math.max(n[2],t),n[3]=Math.max(n[3],e)}static rectBoundingBox(t,e,n,i,s){s[0]=Math.min(s[0],t,n),s[1]=Math.min(s[1],e,i),s[2]=Math.max(s[2],t,n),s[3]=Math.max(s[3],e,i)}static#t(t,e,n,i,s,r,o,a,l,c){if(l<=0||l>=1)return;const h=1-l,d=l*l,u=d*l,p=h*(h*(h*t+3*l*e)+3*d*n)+u*i,f=h*(h*(h*s+3*l*r)+3*d*o)+u*a;c[0]=Math.min(c[0],p),c[1]=Math.min(c[1],f),c[2]=Math.max(c[2],p),c[3]=Math.max(c[3],f)}static#e(t,e,n,i,s,r,o,a,l,c,h,d){if(Math.abs(l)<1e-12)return void(Math.abs(c)>=1e-12&&this.#t(t,e,n,i,s,r,o,a,-h/c,d));const u=c**2-4*h*l;if(u<0)return;const p=Math.sqrt(u),f=2*l;this.#t(t,e,n,i,s,r,o,a,(-c+p)/f,d),this.#t(t,e,n,i,s,r,o,a,(-c-p)/f,d)}static bezierBoundingBox(t,e,n,i,s,r,o,a,l){l[0]=Math.min(l[0],t,o),l[1]=Math.min(l[1],e,a),l[2]=Math.max(l[2],t,o),l[3]=Math.max(l[3],e,a),this.#e(t,n,s,o,e,i,r,a,3*(3*(n-s)-t+o),6*(t-2*n+s),3*(n-t),l),this.#e(t,n,s,o,e,i,r,a,3*(3*(i-r)-e+a),6*(e-2*i+r),3*(i-e),l)}}let ml=null,gl=null;function yl(){if("function"==typeof crypto.randomUUID)return crypto.randomUUID();const t=new Uint8Array(32);return crypto.getRandomValues(t),function(t){"object"==typeof t&&void 0!==t?.length||Za("Invalid argument for bytesToString");const e=t.length,n=8192;if(e<n)return String.fromCharCode.apply(null,t);const i=[];for(let s=0;s<e;s+=n){const r=Math.min(s+n,e),o=t.subarray(s,r);i.push(String.fromCharCode.apply(null,o))}return i.join("")}(t)}const bl="pdfjs_internal_id_";function wl(t,e,n){return Math.min(Math.max(t,e),n)}"function"!=typeof Math.sumPrecise&&(Math.sumPrecise=function(t){return t.reduce((t,e)=>t+e,0)});class vl{static textContent(t){const e=[],n={items:e,styles:Object.create(null)};return function t(n){if(!n)return;let i=null;const s=n.name;if("#text"===s)i=n.value;else{if(!vl.shouldBuildText(s))return;n?.attributes?.textContent?i=n.attributes.textContent:n.value&&(i=n.value)}if(null!==i&&e.push({str:i}),n.children)for(const e of n.children)t(e)}(t),n}static shouldBuildText(t){return!("textarea"===t||"input"===t||"option"===t||"select"===t)}}class Al{static setupStorage(t,e,n,i,s){const r=i.getValue(e,{value:null});switch(n.name){case"textarea":if(null!==r.value&&(t.textContent=r.value),"print"===s)break;t.addEventListener("input",t=>{i.setValue(e,{value:t.target.value})});break;case"input":if("radio"===n.attributes.type||"checkbox"===n.attributes.type){if(r.value===n.attributes.xfaOn?t.setAttribute("checked",!0):r.value===n.attributes.xfaOff&&t.removeAttribute("checked"),"print"===s)break;t.addEventListener("change",t=>{i.setValue(e,{value:t.target.checked?t.target.getAttribute("xfaOn"):t.target.getAttribute("xfaOff")})})}else{if(null!==r.value&&t.setAttribute("value",r.value),"print"===s)break;t.addEventListener("input",t=>{i.setValue(e,{value:t.target.value})})}break;case"select":if(null!==r.value){t.setAttribute("value",r.value);for(const t of n.children)t.attributes.value===r.value?t.attributes.selected=!0:t.attributes.hasOwnProperty("selected")&&delete t.attributes.selected}t.addEventListener("input",t=>{const n=t.target.options,s=-1===n.selectedIndex?"":n[n.selectedIndex].value;i.setValue(e,{value:s})})}}static setAttributes({html:t,element:e,storage:n=null,intent:i,linkService:s}){const{attributes:r}=e,o=t instanceof HTMLAnchorElement;"radio"===r.type&&(r.name=`${r.name}-${i}`);for(const[a,l]of Object.entries(r))if(null!=l)switch(a){case"class":l.length&&t.setAttribute(a,l.join(" "));break;case"dataId":break;case"id":t.setAttribute("data-element-id",l);break;case"style":Object.assign(t.style,l);break;case"textContent":t.textContent=l;break;default:(!o||"href"!==a&&"newWindow"!==a)&&t.setAttribute(a,l)}o&&s.addLinkAttributes(t,r.href,r.newWindow),n&&r.dataId&&this.setupStorage(t,r.dataId,e,n)}static render(t){const e=t.annotationStorage,n=t.linkService,i=t.xfaHtml,s=t.intent||"display",r=document.createElement(i.name);i.attributes&&this.setAttributes({html:r,element:i,intent:s,linkService:n});const o="richText"!==s,a=t.div;if(a.append(r),t.viewport){const e=`matrix(${t.viewport.transform.join(",")})`;a.style.transform=e}o&&a.setAttribute("class","xfaLayer xfaFont");const l=[];if(0===i.children.length){if(i.value){const t=document.createTextNode(i.value);r.append(t),o&&vl.shouldBuildText(i.name)&&l.push(t)}return{textDivs:l}}const c=[[i,-1,r]];for(;c.length>0;){const[t,i,r]=c.at(-1);if(i+1===t.children.length){c.pop();continue}const a=t.children[++c.at(-1)[1]];if(null===a)continue;const{name:h}=a;if("#text"===h){const t=document.createTextNode(a.value);l.push(t),r.append(t);continue}const d=a?.attributes?.xmlns?document.createElementNS(a.attributes.xmlns,h):document.createElement(h);if(r.append(d),a.attributes&&this.setAttributes({html:d,element:a,storage:e,intent:s,linkService:n}),a.children?.length>0)c.push([a,-1,d]);else if(a.value){const t=document.createTextNode(a.value);o&&vl.shouldBuildText(h)&&l.push(t),d.append(t)}}for(const h of a.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea"))h.setAttribute("readOnly",!0);return{textDivs:l}}static update(t){const e=`matrix(${t.viewport.transform.join(",")})`;t.div.style.transform=e,t.div.hidden=!1}}const xl="http://www.w3.org/2000/svg";class Sl{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF}async function _l(t,e="text"){if(Dl(t,document.baseURI)){const n=await fetch(t);if(!n.ok)throw new Error(n.statusText);switch(e){case"arraybuffer":return n.arrayBuffer();case"blob":return n.blob();case"json":return n.json()}return n.text()}return new Promise((n,i)=>{const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType=e,s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE)if(200!==s.status&&0!==s.status)i(new Error(s.statusText));else{switch(e){case"arraybuffer":case"blob":case"json":return void n(s.response)}n(s.responseText)}},s.send(null)})}class Tl{constructor({viewBox:t,userUnit:e,scale:n,rotation:i,offsetX:s=0,offsetY:r=0,dontFlip:o=!1}){this.viewBox=t,this.userUnit=e,this.scale=n,this.rotation=i,this.offsetX=s,this.offsetY=r,n*=e;const a=(t[2]+t[0])/2,l=(t[3]+t[1])/2;let c,h,d,u,p,f,m,g;switch((i%=360)<0&&(i+=360),i){case 180:c=-1,h=0,d=0,u=1;break;case 90:c=0,h=1,d=1,u=0;break;case 270:c=0,h=-1,d=-1,u=0;break;case 0:c=1,h=0,d=0,u=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}o&&(d=-d,u=-u),0===c?(p=Math.abs(l-t[1])*n+s,f=Math.abs(a-t[0])*n+r,m=(t[3]-t[1])*n,g=(t[2]-t[0])*n):(p=Math.abs(a-t[0])*n+s,f=Math.abs(l-t[1])*n+r,m=(t[2]-t[0])*n,g=(t[3]-t[1])*n),this.transform=[c*n,h*n,d*n,u*n,p-c*n*a-d*n*l,f-h*n*a-u*n*l],this.width=m,this.height=g}get rawDims(){const t=this.viewBox;return il(this,"rawDims",{pageWidth:t[2]-t[0],pageHeight:t[3]-t[1],pageX:t[0],pageY:t[1]})}clone({scale:t=this.scale,rotation:e=this.rotation,offsetX:n=this.offsetX,offsetY:i=this.offsetY,dontFlip:s=!1}={}){return new Tl({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale:t,rotation:e,offsetX:n,offsetY:i,dontFlip:s})}convertToViewportPoint(t,e){const n=[t,e];return fl.applyTransform(n,this.transform),n}convertToViewportRectangle(t){const e=[t[0],t[1]];fl.applyTransform(e,this.transform);const n=[t[2],t[3]];return fl.applyTransform(n,this.transform),[e[0],e[1],n[0],n[1]]}convertToPdfPoint(t,e){const n=[t,e];return fl.applyInverseTransform(n,this.transform),n}}class El extends sl{constructor(t,e=0){super(t,"RenderingCancelledException"),this.extraDelay=e}}function Cl(t){const e=t.length;let n=0;for(;n<e&&""===t[n].trim();)n++;return"data:"===t.substring(n,n+5).toLowerCase()}function Ml(t){return"string"==typeof t&&/\.pdf$/i.test(t)}class kl{started=Object.create(null);times=[];time(t){t in this.started&&Qa(`Timer is already running for ${t}`),this.started[t]=Date.now()}timeEnd(t){t in this.started||Qa(`Timer has not been started for ${t}`),this.times.push({name:t,start:this.started[t],end:Date.now()}),delete this.started[t]}toString(){const t=[];let e=0;for(const{name:n}of this.times)e=Math.max(n.length,e);for(const{name:n,start:i,end:s}of this.times)t.push(`${n.padEnd(e)} ${s-i}ms\n`);return t.join("")}}function Dl(t,e){const n=e?URL.parse(t,e):URL.parse(t);return"http:"===n?.protocol||"https:"===n?.protocol}function Il(t){t.preventDefault()}function Nl(t){t.preventDefault(),t.stopPropagation()}class Pl{static#n;static toDateObject(t){if(t instanceof Date)return t;if(!t||"string"!=typeof t)return null;this.#n||=new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?");const e=this.#n.exec(t);if(!e)return null;const n=parseInt(e[1],10);let i=parseInt(e[2],10);i=i>=1&&i<=12?i-1:0;let s=parseInt(e[3],10);s=s>=1&&s<=31?s:1;let r=parseInt(e[4],10);r=r>=0&&r<=23?r:0;let o=parseInt(e[5],10);o=o>=0&&o<=59?o:0;let a=parseInt(e[6],10);a=a>=0&&a<=59?a:0;const l=e[7]||"Z";let c=parseInt(e[8],10);c=c>=0&&c<=23?c:0;let h=parseInt(e[9],10)||0;return h=h>=0&&h<=59?h:0,"-"===l?(r+=c,o+=h):"+"===l&&(r-=c,o-=h),new Date(Date.UTC(n,i,s,r,o,a))}}function Ol(t){if(t.startsWith("#")){const e=parseInt(t.slice(1),16);return[(16711680&e)>>16,(65280&e)>>8,255&e]}return t.startsWith("rgb(")?t.slice(4,-1).split(",").map(t=>parseInt(t)):t.startsWith("rgba(")?t.slice(5,-1).split(",").map(t=>parseInt(t)).slice(0,3):(Qa(`Not a valid color format: "${t}"`),[0,0,0])}function Rl(t){const{a:e,b:n,c:i,d:s,e:r,f:o}=t.getTransform();return[e,n,i,s,r,o]}function Bl(t){const{a:e,b:n,c:i,d:s,e:r,f:o}=t.getTransform().invertSelf();return[e,n,i,s,r,o]}function Fl(t,e,n=!1,i=!0){if(e instanceof Tl){const{pageWidth:i,pageHeight:s}=e.rawDims,{style:r}=t,o=ul.isCSSRoundSupported,a=`var(--total-scale-factor) * ${i}px`,l=`var(--total-scale-factor) * ${s}px`,c=o?`round(down, ${a}, var(--scale-round-x))`:`calc(${a})`,h=o?`round(down, ${l}, var(--scale-round-y))`:`calc(${l})`;n&&e.rotation%180!=0?(r.width=h,r.height=c):(r.width=c,r.height=h)}i&&t.setAttribute("data-main-rotation",e.rotation)}class Ll{constructor(){const{pixelRatio:t}=Ll;this.sx=t,this.sy=t}get scaled(){return 1!==this.sx||1!==this.sy}get symmetric(){return this.sx===this.sy}limitCanvas(t,e,n,i,s=-1){let r=1/0,o=1/0,a=1/0;(n=Ll.capPixels(n,s))>0&&(r=Math.sqrt(n/(t*e))),-1!==i&&(o=i/t,a=i/e);const l=Math.min(r,o,a);return(this.sx>l||this.sy>l)&&(this.sx=l,this.sy=l,!0)}static get pixelRatio(){return globalThis.devicePixelRatio||1}static capPixels(t,e){if(e>=0){const n=Math.ceil(window.screen.availWidth*window.screen.availHeight*this.pixelRatio**2*(1+e/100));return t>0?Math.min(t,n):n}return t}}const zl=["image/apng","image/avif","image/bmp","image/gif","image/jpeg","image/png","image/svg+xml","image/webp","image/x-icon"];class Vl{static get isDarkMode(){return il(this,"isDarkMode",!!window?.matchMedia?.("(prefers-color-scheme: dark)").matches)}}function Hl(t,e){const n=t[0]/255,i=t[1]/255,s=t[2]/255,r=Math.max(n,i,s),o=Math.min(n,i,s),a=(r+o)/2;if(r===o)e[0]=e[1]=0;else{const t=r-o;switch(e[1]=a<.5?t/(r+o):t/(2-r-o),r){case n:e[0]=60*((i-s)/t+(i<s?6:0));break;case i:e[0]=60*((s-n)/t+2);break;case s:e[0]=60*((n-i)/t+4)}}e[2]=a}function $l(t,e){const n=t[0],i=t[1],s=t[2],r=(1-Math.abs(2*s-1))*i,o=r*(1-Math.abs(n/60%2-1)),a=s-r/2;switch(Math.floor(n/60)){case 0:e[0]=r+a,e[1]=o+a,e[2]=a;break;case 1:e[0]=o+a,e[1]=r+a,e[2]=a;break;case 2:e[0]=a,e[1]=r+a,e[2]=o+a;break;case 3:e[0]=a,e[1]=o+a,e[2]=r+a;break;case 4:e[0]=o+a,e[1]=a,e[2]=r+a;break;case 5:case 6:e[0]=r+a,e[1]=a,e[2]=o+a}}function Ul(t){return t<=.03928?t/12.92:((t+.055)/1.055)**2.4}function Wl(t,e,n){$l(t,n),n.map(Ul);const i=.2126*n[0]+.7152*n[1]+.0722*n[2];$l(e,n),n.map(Ul);const s=.2126*n[0]+.7152*n[1]+.0722*n[2];return i>s?(i+.05)/(s+.05):(s+.05)/(i+.05)}const Gl=new Map;function jl({html:t,dir:e,className:n},i){const s=document.createDocumentFragment();if("string"==typeof t){const n=document.createElement("p");n.dir=e||"auto";const i=t.split(/(?:\r\n?|\n)/);for(let t=0,e=i.length;t<e;++t){const s=i[t];n.append(document.createTextNode(s)),t<e-1&&n.append(document.createElement("br"))}s.append(n)}else Al.render({xfaHtml:t,div:s,intent:"richText"});s.firstElementChild.classList.add("richText",n),i.append(s)}function Kl(t){const e=new Path2D;if(!t)return e;for(let n=0,i=t.length;n<i;)switch(t[n++]){case Wa:e.moveTo(t[n++],t[n++]);break;case Ga:e.lineTo(t[n++],t[n++]);break;case ja:e.bezierCurveTo(t[n++],t[n++],t[n++],t[n++],t[n++],t[n++]);break;case Ka:e.quadraticCurveTo(t[n++],t[n++],t[n++],t[n++]);break;case qa:e.closePath();break;default:Qa(`Unrecognized drawing path operator: ${t[n-1]}`)}return e}class ql{static#i=null;static#s=null;static#r=null;static#o=0;static#a=[];get pagesNumber(){return ql.#o}set pagesNumber(t){ql.#o!==t&&(ql.#o=t,0===t&&(ql.#s=null,ql.#i=null))}addListener(t){ql.#a.push(t)}removeListener(t){const e=ql.#a.indexOf(t);e>=0&&ql.#a.splice(e,1)}#l(){for(const t of ql.#a)t()}#c(t){if(ql.#s)return;const e=ql.#o,n=new Uint32Array(3*e),i=ql.#s=n.subarray(0,e),s=ql.#i=n.subarray(e,2*e);if(t)for(let r=0;r<e;r++)i[r]=s[r]=r+1;ql.#r=n.subarray(2*e)}movePages(t,e,n){this.#c(!0);const i=ql.#s,s=ql.#i;ql.#r.set(s);const r=e.length,o=new Uint32Array(r);let a=0;for(let u=0;u<r;u++){const t=e[u]-1;o[u]=i[t],t<n&&(a+=1)}const l=ql.#o;let c=n-a;const h=l-r;c=wl(c,0,h);for(let u=0,p=0;u<l;u++)t.has(u+1)||(i[p++]=i[u]);i.copyWithin(c+r,c,h),i.set(o,c);let d=!1;for(let u=0,p=l;u<p;u++){const t=i[u];d||=t!==u+1,s[t-1]=u+1}this.#l(),d||(this.pagesNumber=0)}hasBeenAltered(){return null!==ql.#s}getPageMappingForSaving(){return{pageIndices:ql.#i?ql.#i.map(t=>t-1):null}}getPrevPageNumber(t){return ql.#r[ql.#s[t-1]-1]}getPageNumber(t){return ql.#i?.[t-1]??t}getPageId(t){return ql.#s?.[t-1]??t}static get instance(){return il(this,"instance",new ql)}getMapping(){return ql.#s.subarray(0,this.pagesNumber)}}class Yl{#h=null;#d=null;#u;#p=null;#f=null;#m=null;#g=null;#y=null;static#b=null;constructor(t){this.#u=t,Yl.#b||=Object.freeze({freetext:"pdfjs-editor-remove-freetext-button",highlight:"pdfjs-editor-remove-highlight-button",ink:"pdfjs-editor-remove-ink-button",stamp:"pdfjs-editor-remove-stamp-button",signature:"pdfjs-editor-remove-signature-button"})}render(){const t=this.#h=document.createElement("div");t.classList.add("editToolbar","hidden"),t.setAttribute("role","toolbar");const e=this.#u._uiManager._signal;e instanceof AbortSignal&&!e.aborted&&(t.addEventListener("contextmenu",Il,{signal:e}),t.addEventListener("pointerdown",Yl.#w,{signal:e}));const n=this.#p=document.createElement("div");n.className="buttons",t.append(n);const i=this.#u.toolbarPosition;if(i){const{style:e}=t,n="ltr"===this.#u._uiManager.direction?1-i[0]:i[0];e.insetInlineEnd=100*n+"%",e.top=`calc(${100*i[1]}% + var(--editor-toolbar-vert-offset))`}return t}get div(){return this.#h}static#w(t){t.stopPropagation()}#v(t){this.#u._focusEventsAllowed=!1,Nl(t)}#A(t){this.#u._focusEventsAllowed=!0,Nl(t)}#x(t){const e=this.#u._uiManager._signal;return e instanceof AbortSignal&&!e.aborted&&(t.addEventListener("focusin",this.#v.bind(this),{capture:!0,signal:e}),t.addEventListener("focusout",this.#A.bind(this),{capture:!0,signal:e}),t.addEventListener("contextmenu",Il,{signal:e}),!0)}hide(){this.#h.classList.add("hidden"),this.#d?.hideDropdown()}show(){this.#h.classList.remove("hidden"),this.#f?.shown(),this.#m?.shown()}addDeleteButton(){const{editorType:t,_uiManager:e}=this.#u,n=document.createElement("button");n.classList.add("basic","deleteButton"),n.tabIndex=0,n.setAttribute("data-l10n-id",Yl.#b[t]),this.#x(n)&&n.addEventListener("click",t=>{e.delete()},{signal:e._signal}),this.#p.append(n)}get#S(){const t=document.createElement("div");return t.className="divider",t}async addAltText(t){const e=await t.render();this.#x(e),this.#p.append(e,this.#S),this.#f=t}addComment(t,e=null){if(this.#m)return;const n=t.renderForToolbar();if(!n)return;this.#x(n);const i=this.#g=this.#S;e?(this.#p.insertBefore(n,e),this.#p.insertBefore(i,e)):this.#p.append(n,i),this.#m=t,t.toolbar=this}addColorPicker(t){if(this.#d)return;this.#d=t;const e=t.renderButton();this.#x(e),this.#p.append(e,this.#S)}async addEditSignatureButton(t){const e=this.#y=await t.renderEditButton(this.#u);this.#x(e),this.#p.append(e,this.#S)}removeButton(t){if("comment"===t)this.#m?.removeToolbarCommentButton(),this.#m=null,this.#g?.remove(),this.#g=null}async addButton(t,e){switch(t){case"colorPicker":e&&this.addColorPicker(e);break;case"altText":e&&await this.addAltText(e);break;case"editSignature":e&&await this.addEditSignatureButton(e);break;case"delete":this.addDeleteButton();break;case"comment":e&&this.addComment(e)}}async addButtonBefore(t,e,n){if(!e&&"comment"===t)return;const i=this.#p.querySelector(n);i&&"comment"===t&&this.addComment(e,i)}updateEditSignatureButton(t){this.#y&&(this.#y.title=t)}remove(){this.#h.remove(),this.#d?.destroy(),this.#d=null}}class Xl{#p=null;#h=null;#_;constructor(t){this.#_=t}#T(){const t=this.#h=document.createElement("div");t.className="editToolbar",t.setAttribute("role","toolbar");const e=this.#_._signal;e instanceof AbortSignal&&!e.aborted&&t.addEventListener("contextmenu",Il,{signal:e});const n=this.#p=document.createElement("div");return n.className="buttons",t.append(n),this.#_.hasCommentManager()&&this.#E("commentButton","pdfjs-comment-floating-button","pdfjs-comment-floating-button-label",()=>{this.#_.commentSelection("floating_button")}),this.#E("highlightButton","pdfjs-highlight-floating-button1","pdfjs-highlight-floating-button-label",()=>{this.#_.highlightSelection("floating_button")}),t}#C(t,e){let n=0,i=0;for(const s of t){const t=s.y+s.height;if(t<n)continue;const r=s.x+(e?s.width:0);t>n?(i=r,n=t):e?r>i&&(i=r):r<i&&(i=r)}return[e?1-i:i,n]}show(t,e,n){const[i,s]=this.#C(e,n),{style:r}=this.#h||=this.#T();t.append(this.#h),r.insetInlineEnd=100*i+"%",r.top=`calc(${100*s}% + var(--editor-toolbar-vert-offset))`}hide(){this.#h.remove()}#E(t,e,n,i){const s=document.createElement("button");s.classList.add("basic",t),s.tabIndex=0,s.setAttribute("data-l10n-id",e);const r=document.createElement("span");s.append(r),r.className="visuallyHidden",r.setAttribute("data-l10n-id",n);const o=this.#_._signal;o instanceof AbortSignal&&!o.aborted&&(s.addEventListener("contextmenu",Il,{signal:o}),s.addEventListener("click",i,{signal:o})),this.#p.append(s)}}function Jl(t,e,n){for(const i of n)e.addEventListener(i,t[i].bind(t))}class Ql{static#M=NaN;static#k=null;static#D=NaN;static#I=null;static initializeAndAddPointerId(t){(Ql.#k||=new Set).add(t)}static setPointer(t,e){Ql.#M||=e,Ql.#I??=t}static setTimeStamp(t){Ql.#D=t}static isSamePointerId(t){return Ql.#M===t}static isSamePointerIdOrRemove(t){return Ql.#M===t||(Ql.#k?.delete(t),!1)}static isSamePointerType(t){return Ql.#I===t}static isInitializedAndDifferentPointerType(t){return null!==Ql.#I&&!Ql.isSamePointerType(t)}static isSameTimeStamp(t){return Ql.#D===t}static isUsingMultiplePointers(){return Ql.#k?.size>=1}static clearPointerType(){Ql.#I=null}static clearPointerIds(){Ql.#M=NaN,Ql.#k=null}static clearTimeStamp(){Ql.#D=NaN}}class Zl{#N=0;get id(){return`${_a}${this.#N++}`}}class tc{#P=yl();#N=0;#O=null;static get _isSVGFittingCanvas(){const t=new OffscreenCanvas(1,3).getContext("2d",{willReadFrequently:!0}),e=new Image;e.src='data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>';return il(this,"_isSVGFittingCanvas",e.decode().then(()=>(t.drawImage(e,0,0,1,1,0,0,1,3),0===new Uint32Array(t.getImageData(0,0,1,1).data.buffer)[0])))}async#R(t,e){this.#O||=new Map;let n=this.#O.get(t);if(null===n)return null;if(n?.bitmap)return n.refCounter+=1,n;try{let t;if(n||={bitmap:null,id:`image_${this.#P}_${this.#N++}`,refCounter:0,isSvg:!1},"string"==typeof e?(n.url=e,t=await _l(e,"blob")):e instanceof File?t=n.file=e:e instanceof Blob&&(t=e),"image/svg+xml"===t.type){const e=tc._isSVGFittingCanvas,i=new FileReader,s=new Image,r=new Promise((t,r)=>{s.onload=()=>{n.bitmap=s,n.isSvg=!0,t()},i.onload=async()=>{const t=n.svgUrl=i.result;s.src=await e?`${t}#svgView(preserveAspectRatio(none))`:t},s.onerror=i.onerror=r});i.readAsDataURL(t),await r}else n.bitmap=await createImageBitmap(t);n.refCounter=1}catch(ze){Qa(ze),n=null}return this.#O.set(t,n),n&&this.#O.set(n.id,n),n}async getFromFile(t){const{lastModified:e,name:n,size:i,type:s}=t;return this.#R(`${e}_${n}_${i}_${s}`,t)}async getFromUrl(t){return this.#R(t,t)}async getFromBlob(t,e){const n=await e;return this.#R(t,n)}async getFromId(t){this.#O||=new Map;const e=this.#O.get(t);if(!e)return null;if(e.bitmap)return e.refCounter+=1,e;if(e.file)return this.getFromFile(e.file);if(e.blobPromise){const{blobPromise:t}=e;return delete e.blobPromise,this.getFromBlob(e.id,t)}return this.getFromUrl(e.url)}getFromCanvas(t,e){this.#O||=new Map;let n=this.#O.get(t);if(n?.bitmap)return n.refCounter+=1,n;const i=new OffscreenCanvas(e.width,e.height);return i.getContext("2d").drawImage(e,0,0),n={bitmap:i.transferToImageBitmap(),id:`image_${this.#P}_${this.#N++}`,refCounter:1,isSvg:!1},this.#O.set(t,n),this.#O.set(n.id,n),n}getSvgUrl(t){const e=this.#O.get(t);return e?.isSvg?e.svgUrl:null}deleteId(t){this.#O||=new Map;const e=this.#O.get(t);if(!e)return;if(e.refCounter-=1,0!==e.refCounter)return;const{bitmap:n}=e;if(!e.url&&!e.file){const t=new OffscreenCanvas(n.width,n.height);t.getContext("bitmaprenderer").transferFromImageBitmap(n),e.blobPromise=t.convertToBlob()}n.close?.(),e.bitmap=null}isValidId(t){return t.startsWith(`image_${this.#P}_`)}}class ec{#B=[];#F=!1;#L;#z=-1;constructor(t=128){this.#L=t}add({cmd:t,undo:e,post:n,mustExec:i,type:s=NaN,overwriteIfSameType:r=!1,keepUndo:o=!1}){if(i&&t(),this.#F)return;const a={cmd:t,undo:e,post:n,type:s};if(-1===this.#z)return this.#B.length>0&&(this.#B.length=0),this.#z=0,void this.#B.push(a);if(r&&this.#B[this.#z].type===s)return o&&(a.undo=this.#B[this.#z].undo),void(this.#B[this.#z]=a);const l=this.#z+1;l===this.#L?this.#B.splice(0,1):(this.#z=l,l<this.#B.length&&this.#B.splice(l)),this.#B.push(a)}undo(){if(-1===this.#z)return;this.#F=!0;const{undo:t,post:e}=this.#B[this.#z];t(),e?.(),this.#F=!1,this.#z-=1}redo(){if(this.#z<this.#B.length-1){this.#z+=1,this.#F=!0;const{cmd:t,post:e}=this.#B[this.#z];t(),e?.(),this.#F=!1}}hasSomethingToUndo(){return-1!==this.#z}hasSomethingToRedo(){return this.#z<this.#B.length-1}cleanType(t){if(-1!==this.#z){for(let e=this.#z;e>=0;e--)if(this.#B[e].type!==t)return this.#B.splice(e+1,this.#z-e),void(this.#z=e);this.#B.length=0,this.#z=-1}}destroy(){this.#B=null}}class nc{constructor(t){this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;const{isMac:e}=ul.platform;for(const[n,i,s={}]of t)for(const t of n){const n=t.startsWith("mac+");e&&n?(this.callbacks.set(t.slice(4),{callback:i,options:s}),this.allKeys.add(t.split("+").at(-1))):e||n||(this.callbacks.set(t,{callback:i,options:s}),this.allKeys.add(t.split("+").at(-1)))}}#V(t){t.altKey&&this.buffer.push("alt"),t.ctrlKey&&this.buffer.push("ctrl"),t.metaKey&&this.buffer.push("meta"),t.shiftKey&&this.buffer.push("shift"),this.buffer.push(t.key);const e=this.buffer.join("+");return this.buffer.length=0,e}exec(t,e){if(!this.allKeys.has(e.key))return;const n=this.callbacks.get(this.#V(e));if(!n)return;const{callback:i,options:{bubbles:s=!1,args:r=[],checker:o=null}}=n;o&&!o(t,e)||(i.bind(t,...r,e)(),s||Nl(e))}}class ic{static _colorsMapping=new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]);get _colors(){const t=new Map([["CanvasText",null],["Canvas",null]]);return function(t){const e=document.createElement("span");e.style.visibility="hidden",e.style.colorScheme="only light",document.body.append(e);for(const n of t.keys()){e.style.color=n;const i=window.getComputedStyle(e).color;t.set(n,Ol(i))}e.remove()}(t),il(this,"_colors",t)}convert(t){const e=Ol(t);if(!window.matchMedia("(forced-colors: active)").matches)return e;for(const[n,i]of this._colors)if(i.every((t,n)=>t===e[n]))return ic._colorsMapping.get(n);return e}getHexCode(t){const e=this._colors.get(t);return e?fl.makeHexColor(...e):t}}class sc{#H=new AbortController;#$=null;#U=null;#W=new Map;#G=new Map;#j=null;#K=null;#q=null;#Y=new ec;#X=null;#J=null;#Q=null;#Z=0;#tt=new Set;#et=null;#nt=null;#it=new Set;_editorUndoBar=null;#st=!1;#rt=!1;#ot=!1;#at=null;#lt=null;#ct=null;#ht=null;#dt=!1;#ut=null;#pt=new Zl;#ft=!1;#mt=!1;#gt=!1;#yt=null;#bt=null;#wt=null;#vt=null;#At=null;#xt=Ta.NONE;#St=new Set;#_t=null;#Tt=null;#Et=null;#Ct=null;#Mt=null;#kt={isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1,hasSelectedText:!1};#Dt=[0,0];#It=null;#Nt=null;#Pt=null;#Ot=null;#Rt=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){const t=sc.prototype,e=t=>t.#Nt.contains(document.activeElement)&&"BUTTON"!==document.activeElement.tagName&&t.hasSomethingToControl(),n=(t,{target:e})=>{if(e instanceof HTMLInputElement){const{type:t}=e;return"text"!==t&&"number"!==t}return!0},i=this.TRANSLATE_SMALL,s=this.TRANSLATE_BIG;return il(this,"_keyboardManager",new nc([[["ctrl+a","mac+meta+a"],t.selectAll,{checker:n}],[["ctrl+z","mac+meta+z"],t.undo,{checker:n}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],t.redo,{checker:n}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],t.delete,{checker:n}],[["Enter","mac+Enter"],t.addNewEditorFromKeyboard,{checker:(t,{target:e})=>!(e instanceof HTMLButtonElement)&&t.#Nt.contains(e)&&!t.isEnterHandled}],[[" ","mac+ "],t.addNewEditorFromKeyboard,{checker:(t,{target:e})=>!(e instanceof HTMLButtonElement)&&t.#Nt.contains(document.activeElement)}],[["Escape","mac+Escape"],t.unselectAll],[["ArrowLeft","mac+ArrowLeft"],t.translateSelectedEditors,{args:[-i,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t.translateSelectedEditors,{args:[-s,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t.translateSelectedEditors,{args:[i,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t.translateSelectedEditors,{args:[s,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t.translateSelectedEditors,{args:[0,-i],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t.translateSelectedEditors,{args:[0,-s],checker:e}],[["ArrowDown","mac+ArrowDown"],t.translateSelectedEditors,{args:[0,i],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t.translateSelectedEditors,{args:[0,s],checker:e}]]))}constructor(t,e,n,i,s,r,o,a,l,c,h,d,u,p,f,m){const g=this._signal=this.#H.signal;this.#Nt=t,this.#Pt=e,this.#Ot=n,this.#j=i,this.#X=s,this.#Tt=r,this.#Mt=a,this._eventBus=o,o._on("editingaction",this.onEditingAction.bind(this),{signal:g}),o._on("pagechanging",this.onPageChanging.bind(this),{signal:g}),o._on("scalechanging",this.onScaleChanging.bind(this),{signal:g}),o._on("rotationchanging",this.onRotationChanging.bind(this),{signal:g}),o._on("setpreference",this.onSetPreference.bind(this),{signal:g}),o._on("switchannotationeditorparams",t=>this.updateParams(t.type,t.value),{signal:g}),o._on("pagesedited",this.onPagesEdited.bind(this),{signal:g}),window.addEventListener("pointerdown",()=>{this.#mt=!0},{capture:!0,signal:g}),window.addEventListener("pointerup",()=>{this.#mt=!1},{capture:!0,signal:g}),this.#Bt(),this.#Ft(),this.#Lt(),this.#K=a.annotationStorage,this.#at=a.filterFactory,this.#Et=l,this.#ht=c||null,this.#st=h,this.#rt=d,this.#ot=u,this.#At=p||null,this.viewParameters={realScale:Sl.PDF_TO_CSS_UNITS,rotation:0},this.isShiftKeyDown=!1,this._editorUndoBar=f||null,this._supportsPinchToZoom=!1!==m,s?.setSidebarUiManager(this)}destroy(){this.#Rt?.resolve(),this.#Rt=null,this.#H?.abort(),this.#H=null,this._signal=null;for(const t of this.#G.values())t.destroy();this.#G.clear(),this.#W.clear(),this.#it.clear(),this.#vt?.clear(),this.#$=null,this.#St.clear(),this.#Y.destroy(),this.#j?.destroy(),this.#X?.destroy(),this.#Tt?.destroy(),this.#ut?.hide(),this.#ut=null,this.#wt?.destroy(),this.#wt=null,this.#U=null,this.#lt&&(clearTimeout(this.#lt),this.#lt=null),this.#It&&(clearTimeout(this.#It),this.#It=null),this._editorUndoBar?.destroy(),this.#Mt=null}combinedSignal(t){return AbortSignal.any([this._signal,t.signal])}get mlManager(){return this.#At}get useNewAltTextFlow(){return this.#rt}get useNewAltTextWhenAddingImage(){return this.#ot}get hcmFilter(){return il(this,"hcmFilter",this.#Et?this.#at.addHCMFilter(this.#Et.foreground,this.#Et.background):"none")}get direction(){return il(this,"direction",getComputedStyle(this.#Nt).direction)}get _highlightColors(){return il(this,"_highlightColors",this.#ht?new Map(this.#ht.split(",").map(t=>((t=t.split("=").map(t=>t.trim()))[1]=t[1].toUpperCase(),t))):null)}get highlightColors(){const{_highlightColors:t}=this;if(!t)return il(this,"highlightColors",null);const e=new Map,n=!!this.#Et;for(const[i,s]of t){const t=i.endsWith("_HCM");n&&t?e.set(i.replace("_HCM",""),s):n||t||e.set(i,s)}return il(this,"highlightColors",e)}get highlightColorNames(){return il(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,t=>t.reverse())):null)}getNonHCMColor(t){if(!this._highlightColors)return t;const e=this.highlightColorNames.get(t);return this._highlightColors.get(e)||t}getNonHCMColorName(t){return this.highlightColorNames.get(t)||t}setCurrentDrawingSession(t){t?(this.unselectAll(),this.disableUserSelect(!0)):this.disableUserSelect(!1),this.#Q=t}setMainHighlightColorPicker(t){this.#wt=t}editAltText(t,e=!1){this.#j?.editAltText(this,t,e)}hasCommentManager(){return!!this.#X}editComment(t,e,n,i){this.#X?.showDialog(this,t,e,n,i)}selectComment(t,e){const n=this.#G.get(t),i=n?.getEditorByUID(e);i?.toggleComment(!0,!0)}updateComment(t){this.#X?.updateComment(t.getData())}updatePopupColor(t){this.#X?.updatePopupColor(t)}removeComment(t){this.#X?.removeComments([t.uid])}deleteComment(t,e){const n=()=>{t.comment=e};this.addCommands({cmd:()=>{this._editorUndoBar?.show(n,"comment"),this.toggleComment(null),t.comment=null},undo:n,mustExec:!0})}toggleComment(t,e,n=void 0){this.#X?.toggleCommentPopup(t,e,n)}makeCommentColor(t,e){return t&&this.#X?.makeCommentColor(t,e)||null}getCommentDialogElement(){return this.#X?.dialogElement||null}async waitForEditorsRendered(t){if(this.#G.has(t-1))return;const{resolve:e,promise:n}=Promise.withResolvers(),i=n=>{n.pageNumber===t&&(this._eventBus._off("editorsrendered",i),e())};this._eventBus.on("editorsrendered",i),await n}getSignature(t){this.#Tt?.getSignature({uiManager:this,editor:t})}get signatureManager(){return this.#Tt}switchToMode(t,e){this._eventBus.on("annotationeditormodechanged",e,{once:!0,signal:this._signal}),this._eventBus.dispatch("showannotationeditorui",{source:this,mode:t})}setPreference(t,e){this._eventBus.dispatch("setpreference",{source:this,name:t,value:e})}onSetPreference({name:t,value:e}){if("enableNewAltTextWhenAddingImage"===t)this.#ot=e}onPagesEdited({pagesMapper:t}){for(const i of this.#W.values())i.updatePageIndex(t.getPrevPageNumber(i.pageIndex+1)-1);const e=this.#G,n=this.#G=new Map;for(const[i,s]of e){const e=t.getPrevPageNumber(i+1)-1;-1!==e?(n.set(e,s),s.updatePageIndex(e)):s.destroy()}}onPageChanging({pageNumber:t}){this.#Z=t-1}focusMainContainer(){this.#Nt.focus()}findParent(t,e){for(const n of this.#G.values()){const{x:i,y:s,width:r,height:o}=n.div.getBoundingClientRect();if(t>=i&&t<=i+r&&e>=s&&e<=s+o)return n}return null}disableUserSelect(t=!1){this.#Pt.classList.toggle("noUserSelect",t)}addShouldRescale(t){this.#it.add(t)}removeShouldRescale(t){this.#it.delete(t)}onScaleChanging({scale:t}){this.commitOrRemove(),this.viewParameters.realScale=t*Sl.PDF_TO_CSS_UNITS;for(const e of this.#it)e.onScaleChanging();this.#Q?.onScaleChanging()}onRotationChanging({pagesRotation:t}){this.commitOrRemove(),this.viewParameters.rotation=t}#zt({anchorNode:t}){return t.nodeType===Node.TEXT_NODE?t.parentElement:t}#Vt(t){const{currentLayer:e}=this;if(e.hasTextLayer(t))return e;for(const n of this.#G.values())if(n.hasTextLayer(t))return n;return null}highlightSelection(t="",e=!1){const n=document.getSelection();if(!n||n.isCollapsed)return;const{anchorNode:i,anchorOffset:s,focusNode:r,focusOffset:o}=n,a=n.toString(),l=this.#zt(n).closest(".textLayer"),c=this.getSelectionBoxes(l);if(!c)return;n.empty();const h=this.#Vt(l),d=this.#xt===Ta.NONE,u=()=>{const n=h?.createAndAddNewEditor({x:0,y:0},!1,{methodOfCreation:t,boxes:c,anchorNode:i,anchorOffset:s,focusNode:r,focusOffset:o,text:a});d&&this.showAllEditors("highlight",!0,!0),e&&n?.editComment()};d?this.switchToMode(Ta.HIGHLIGHT,u):u()}commentSelection(t=""){this.highlightSelection(t,!0)}#Ht(){const t=document.getSelection();if(!t||t.isCollapsed)return;const e=this.#zt(t).closest(".textLayer"),n=this.getSelectionBoxes(e);n&&(this.#ut||=new Xl(this),this.#ut.show(e,n,"ltr"===this.direction))}getAndRemoveDataFromAnnotationStorage(t){if(!this.#K)return null;const e=`${_a}${t}`,n=this.#K.getRawValue(e);return n&&this.#K.remove(e),n}addToAnnotationStorage(t){t.isEmpty()||!this.#K||this.#K.has(t.id)||this.#K.setValue(t.id,t)}a11yAlert(t,e=null){const n=this.#Ot;n&&(n.setAttribute("data-l10n-id",t),e?n.setAttribute("data-l10n-args",JSON.stringify(e)):n.removeAttribute("data-l10n-args"))}#$t(){const t=document.getSelection();if(!t||t.isCollapsed)return void(this.#_t&&(this.#ut?.hide(),this.#_t=null,this.#Ut({hasSelectedText:!1})));const{anchorNode:e}=t;if(e===this.#_t)return;const n=this.#zt(t).closest(".textLayer");if(n){if(this.#ut?.hide(),this.#_t=e,this.#Ut({hasSelectedText:!0}),(this.#xt===Ta.HIGHLIGHT||this.#xt===Ta.NONE)&&(this.#xt===Ta.HIGHLIGHT&&this.showAllEditors("highlight",!0,!0),this.#dt=this.isShiftKeyDown,!this.isShiftKeyDown)){const t=this.#xt===Ta.HIGHLIGHT?this.#Vt(n):null;if(t?.toggleDrawing(),this.#mt){const e=new AbortController,n=this.combinedSignal(e),i=n=>{"pointerup"===n.type&&0!==n.button||(e.abort(),t?.toggleDrawing(!0),"pointerup"===n.type&&this.#Wt("main_toolbar"))};window.addEventListener("pointerup",i,{signal:n}),window.addEventListener("blur",i,{signal:n})}else t?.toggleDrawing(!0),this.#Wt("main_toolbar")}}else this.#_t&&(this.#ut?.hide(),this.#_t=null,this.#Ut({hasSelectedText:!1}))}#Wt(t=""){this.#xt===Ta.HIGHLIGHT?this.highlightSelection(t):this.#st&&this.#Ht()}#Bt(){document.addEventListener("selectionchange",this.#$t.bind(this),{signal:this._signal})}#Gt(){if(this.#ct)return;this.#ct=new AbortController;const t=this.combinedSignal(this.#ct);window.addEventListener("focus",this.focus.bind(this),{signal:t}),window.addEventListener("blur",this.blur.bind(this),{signal:t})}#jt(){this.#ct?.abort(),this.#ct=null}blur(){if(this.isShiftKeyDown=!1,this.#dt&&(this.#dt=!1,this.#Wt("main_toolbar")),!this.hasSelection)return;const{activeElement:t}=document;for(const e of this.#St)if(e.div.contains(t)){this.#bt=[e,t],e._focusEventsAllowed=!1;break}}focus(){if(!this.#bt)return;const[t,e]=this.#bt;this.#bt=null,e.addEventListener("focusin",()=>{t._focusEventsAllowed=!0},{once:!0,signal:this._signal}),e.focus()}#Lt(){if(this.#yt)return;this.#yt=new AbortController;const t=this.combinedSignal(this.#yt);window.addEventListener("keydown",this.keydown.bind(this),{signal:t}),window.addEventListener("keyup",this.keyup.bind(this),{signal:t})}#Kt(){this.#yt?.abort(),this.#yt=null}#qt(){if(this.#J)return;this.#J=new AbortController;const t=this.combinedSignal(this.#J);document.addEventListener("copy",this.copy.bind(this),{signal:t}),document.addEventListener("cut",this.cut.bind(this),{signal:t}),document.addEventListener("paste",this.paste.bind(this),{signal:t})}#Yt(){this.#J?.abort(),this.#J=null}#Ft(){const t=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal:t}),document.addEventListener("drop",this.drop.bind(this),{signal:t})}addEditListeners(){this.#Lt(),this.setEditingState(!0)}removeEditListeners(){this.#Kt(),this.setEditingState(!1)}dragOver(t){for(const{type:e}of t.dataTransfer.items)for(const n of this.#nt)if(n.isHandlingMimeForPasting(e))return t.dataTransfer.dropEffect="copy",void t.preventDefault()}drop(t){for(const e of t.dataTransfer.items)for(const n of this.#nt)if(n.isHandlingMimeForPasting(e.type))return n.paste(e,this.currentLayer),void t.preventDefault()}copy(t){if(t.preventDefault(),this.#$?.commitOrRemove(),!this.hasSelection)return;const e=[];for(const n of this.#St){const t=n.serialize(!0);t&&e.push(t)}0!==e.length&&t.clipboardData.setData("application/pdfjs",JSON.stringify(e))}cut(t){this.copy(t),this.delete()}async paste(t){t.preventDefault();const{clipboardData:e}=t;for(const r of e.items)for(const t of this.#nt)if(t.isHandlingMimeForPasting(r.type))return void t.paste(r,this.currentLayer);let n=e.getData("application/pdfjs");if(!n)return;try{n=JSON.parse(n)}catch(s){return void Qa(`paste: "${s.message}".`)}if(!Array.isArray(n))return;this.unselectAll();const i=this.currentLayer;try{const t=[];for(const r of n){const e=await i.deserialize(r);if(!e)return;t.push(e)}const e=()=>{for(const e of t)this.#Xt(e);this.#Jt(t)},s=()=>{for(const e of t)e.remove()};this.addCommands({cmd:e,undo:s,mustExec:!0})}catch(s){Qa(`paste: "${s.message}".`)}}keydown(t){this.isShiftKeyDown||"Shift"!==t.key||(this.isShiftKeyDown=!0),this.#xt===Ta.NONE||this.isEditorHandlingKeyboard||sc._keyboardManager.exec(this,t)}keyup(t){this.isShiftKeyDown&&"Shift"===t.key&&(this.isShiftKeyDown=!1,this.#dt&&(this.#dt=!1,this.#Wt("main_toolbar")))}onEditingAction({name:t}){switch(t){case"undo":case"redo":case"delete":case"selectAll":this[t]();break;case"highlightSelection":this.highlightSelection("context_menu");break;case"commentSelection":this.commentSelection("context_menu")}}#Ut(t){Object.entries(t).some(([t,e])=>this.#kt[t]!==e)&&(this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(this.#kt,t)}),this.#xt===Ta.HIGHLIGHT&&!1===t.hasSelectedEditor&&this.#Qt([[Ea.HIGHLIGHT_FREE,!0]]))}#Qt(t){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:t})}setEditingState(t){t?(this.#Gt(),this.#qt(),this.#Ut({isEditing:this.#xt!==Ta.NONE,isEmpty:this.#Zt(),hasSomethingToUndo:this.#Y.hasSomethingToUndo(),hasSomethingToRedo:this.#Y.hasSomethingToRedo(),hasSelectedEditor:!1})):(this.#jt(),this.#Yt(),this.#Ut({isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(t){if(!this.#nt){this.#nt=t;for(const t of this.#nt)this.#Qt(t.defaultPropertiesToUpdate)}}getId(){return this.#pt.id}get currentLayer(){return this.#G.get(this.#Z)}getLayer(t){return this.#G.get(t)}get currentPageIndex(){return this.#Z}addLayer(t){this.#G.set(t.pageIndex,t),this.#ft?t.enable():t.disable()}removeLayer(t){this.#G.delete(t.pageIndex)}async updateMode(t,e=null,n=!1,i=!1,s=!1,r=!1){if(this.#xt!==t&&(!this.#Rt||(await this.#Rt.promise,this.#Rt))){if(this.#Rt=Promise.withResolvers(),this.#Q?.commitOrRemove(),this.#xt===Ta.POPUP&&this.#X?.hideSidebar(),this.#X?.destroyPopup(),this.#xt=t,t===Ta.NONE){this.setEditingState(!1),this.#te();for(const t of this.#W.values())t.hideStandaloneCommentButton();return this._editorUndoBar?.hide(),this.toggleComment(null),void this.#Rt.resolve()}for(const t of this.#W.values())t.addStandaloneCommentButton();t===Ta.SIGNATURE&&await(this.#Tt?.loadSignatures()),n&&Ql.clearPointerType(),this.setEditingState(!0),await this.#ee(),this.unselectAll();for(const e of this.#G.values())e.updateMode(t);if(t===Ta.POPUP){this.#U||=await this.#Mt.getAnnotationsByType(new Set(this.#nt.map(t=>t._editorType)));const t=new Set,e=[];for(const n of this.#W.values()){const{annotationElementId:i,hasComment:s,deleted:r}=n;i&&t.add(i),s&&!r&&e.push(n.getData())}for(const n of this.#U){const{id:i,popupRef:s,contentsObj:r}=n;s&&r?.str&&!t.has(i)&&!this.#tt.has(i)&&e.push(n)}this.#X?.showSidebar(e)}if(!e)return i&&this.addNewEditorFromKeyboard(),void this.#Rt.resolve();for(const t of this.#W.values())t.uid===e?(this.setSelected(t),r?t.editComment():s?t.enterInEditMode():t.focus()):t.unselect();this.#Rt.resolve()}}addNewEditorFromKeyboard(){this.currentLayer.canCreateNewEmptyEditor()&&this.currentLayer.addNewEditor()}updateToolbar(t){t.mode!==this.#xt&&this._eventBus.dispatch("switchannotationeditormode",{source:this,...t})}updateParams(t,e){if(this.#nt){switch(t){case Ea.CREATE:return void this.currentLayer.addNewEditor(e);case Ea.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}}),(this.#Ct||=new Map).set(t,e),this.showAllEditors("highlight",e)}if(this.hasSelection)for(const n of this.#St)n.updateParams(t,e);else for(const n of this.#nt)n.updateDefaultParams(t,e)}}showAllEditors(t,e,n=!1){for(const i of this.#W.values())i.editorType===t&&i.show(e);(this.#Ct?.get(Ea.HIGHLIGHT_SHOW_ALL)??!0)!==e&&this.#Qt([[Ea.HIGHLIGHT_SHOW_ALL,e]])}enableWaiting(t=!1){if(this.#gt!==t){this.#gt=t;for(const e of this.#G.values())t?e.disableClick():e.enableClick(),e.div.classList.toggle("waiting",t)}}async#ee(){if(!this.#ft){this.#ft=!0;const t=[];for(const e of this.#G.values())t.push(e.enable());await Promise.all(t);for(const e of this.#W.values())e.enable()}}#te(){if(this.unselectAll(),this.#ft){this.#ft=!1;for(const t of this.#G.values())t.disable();for(const t of this.#W.values())t.disable()}}*getEditors(t){for(const e of this.#W.values())e.pageIndex===t&&(yield e)}getEditor(t){return this.#W.get(t)}addEditor(t){this.#W.set(t.id,t)}removeEditor(t){t.div.contains(document.activeElement)&&(this.#lt&&clearTimeout(this.#lt),this.#lt=setTimeout(()=>{this.focusMainContainer(),this.#lt=null},0)),this.#W.delete(t.id),t.annotationElementId&&this.#vt?.delete(t.annotationElementId),this.unselect(t),t.annotationElementId&&this.#tt.has(t.annotationElementId)||this.#K?.remove(t.id)}addDeletedAnnotationElement(t){this.#tt.add(t.annotationElementId),this.addChangedExistingAnnotation(t),t.deleted=!0}isDeletedAnnotationElement(t){return this.#tt.has(t)}removeDeletedAnnotationElement(t){this.#tt.delete(t.annotationElementId),this.removeChangedExistingAnnotation(t),t.deleted=!1}#Xt(t){const e=this.#G.get(t.pageIndex);e?e.addOrRebuild(t):(this.addEditor(t),this.addToAnnotationStorage(t))}setActiveEditor(t){this.#$!==t&&(this.#$=t,t&&this.#Qt(t.propertiesToUpdate))}get#ne(){let t=null;for(t of this.#St);return t}updateUI(t){this.#ne===t&&this.#Qt(t.propertiesToUpdate)}updateUIForDefaultProperties(t){this.#Qt(t.defaultPropertiesToUpdate)}toggleSelected(t){if(this.#St.has(t))return this.#St.delete(t),t.unselect(),void this.#Ut({hasSelectedEditor:this.hasSelection});this.#St.add(t),t.select(),this.#Qt(t.propertiesToUpdate),this.#Ut({hasSelectedEditor:!0})}setSelected(t){this.updateToolbar({mode:t.mode,editId:t.uid}),this.#Q?.commitOrRemove();for(const e of this.#St)e!==t&&e.unselect();this.#St.clear(),this.#St.add(t),t.select(),this.#Qt(t.propertiesToUpdate),this.#Ut({hasSelectedEditor:!0})}isSelected(t){return this.#St.has(t)}get firstSelectedEditor(){return this.#St.values().next().value}unselect(t){t.unselect(),this.#St.delete(t),this.#Ut({hasSelectedEditor:this.hasSelection})}get hasSelection(){return 0!==this.#St.size}get isEnterHandled(){return 1===this.#St.size&&this.firstSelectedEditor.isEnterHandled}undo(){this.#Y.undo(),this.#Ut({hasSomethingToUndo:this.#Y.hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:this.#Zt()}),this._editorUndoBar?.hide()}redo(){this.#Y.redo(),this.#Ut({hasSomethingToUndo:!0,hasSomethingToRedo:this.#Y.hasSomethingToRedo(),isEmpty:this.#Zt()})}addCommands(t){this.#Y.add(t),this.#Ut({hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:this.#Zt()})}cleanUndoStack(t){this.#Y.cleanType(t)}#Zt(){if(0===this.#W.size)return!0;if(1===this.#W.size)for(const t of this.#W.values())return t.isEmpty();return!1}delete(){this.commitOrRemove();const t=this.currentLayer?.endDrawingSession(!0);if(!this.hasSelection&&!t)return;const e=t?[t]:[...this.#St],n=()=>{for(const t of e)this.#Xt(t)};this.addCommands({cmd:()=>{this._editorUndoBar?.show(n,1===e.length?e[0].editorType:e.length);for(const t of e)t.remove()},undo:n,mustExec:!0})}commitOrRemove(){this.#$?.commitOrRemove()}hasSomethingToControl(){return this.#$||this.hasSelection}#Jt(t){for(const e of this.#St)e.unselect();this.#St.clear();for(const e of t)e.isEmpty()||(this.#St.add(e),e.select());this.#Ut({hasSelectedEditor:this.hasSelection})}selectAll(){for(const t of this.#St)t.commit();this.#Jt(this.#W.values())}unselectAll(){if((!this.#$||(this.#$.commitOrRemove(),this.#xt===Ta.NONE))&&!this.#Q?.commitOrRemove()&&this.hasSelection){for(const t of this.#St)t.unselect();this.#St.clear(),this.#Ut({hasSelectedEditor:!1})}}translateSelectedEditors(t,e,n=!1){if(n||this.commitOrRemove(),!this.hasSelection)return;this.#Dt[0]+=t,this.#Dt[1]+=e;const[i,s]=this.#Dt,r=[...this.#St];this.#It&&clearTimeout(this.#It),this.#It=setTimeout(()=>{this.#It=null,this.#Dt[0]=this.#Dt[1]=0,this.addCommands({cmd:()=>{for(const t of r)this.#W.has(t.id)&&(t.translateInPage(i,s),t.translationDone())},undo:()=>{for(const t of r)this.#W.has(t.id)&&(t.translateInPage(-i,-s),t.translationDone())},mustExec:!1})},1e3);for(const o of r)o.translateInPage(t,e),o.translationDone()}setUpDragSession(){if(this.hasSelection){this.disableUserSelect(!0),this.#et=new Map;for(const t of this.#St)this.#et.set(t,{savedX:t.x,savedY:t.y,savedPageIndex:t.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!this.#et)return!1;this.disableUserSelect(!1);const t=this.#et;this.#et=null;let e=!1;for(const[{x:i,y:s,pageIndex:r},o]of t)o.newX=i,o.newY=s,o.newPageIndex=r,e||=i!==o.savedX||s!==o.savedY||r!==o.savedPageIndex;if(!e)return!1;const n=(t,e,n,i)=>{if(this.#W.has(t.id)){const s=this.#G.get(i);s?t._setParentAndPosition(s,e,n):(t.pageIndex=i,t.x=e,t.y=n)}};return this.addCommands({cmd:()=>{for(const[e,{newX:i,newY:s,newPageIndex:r}]of t)n(e,i,s,r)},undo:()=>{for(const[e,{savedX:i,savedY:s,savedPageIndex:r}]of t)n(e,i,s,r)},mustExec:!0}),!0}dragSelectedEditors(t,e){if(this.#et)for(const n of this.#et.keys())n.drag(t,e)}rebuild(t){if(null===t.parent){const e=this.getLayer(t.pageIndex);e?(e.changeParent(t),e.addOrRebuild(t)):(this.addEditor(t),this.addToAnnotationStorage(t),t.rebuild())}else t.parent.addOrRebuild(t)}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||1===this.#St.size&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(t){return this.#$===t}getActive(){return this.#$}getMode(){return this.#xt}isEditingMode(){return this.#xt!==Ta.NONE}get imageManager(){return il(this,"imageManager",new tc)}getSelectionBoxes(t){if(!t)return null;const e=document.getSelection();for(let l=0,c=e.rangeCount;l<c;l++)if(!t.contains(e.getRangeAt(l).commonAncestorContainer))return null;const{x:n,y:i,width:s,height:r}=t.getBoundingClientRect();let o;switch(t.getAttribute("data-main-rotation")){case"90":o=(t,e,o,a)=>({x:(e-i)/r,y:1-(t+o-n)/s,width:a/r,height:o/s});break;case"180":o=(t,e,o,a)=>({x:1-(t+o-n)/s,y:1-(e+a-i)/r,width:o/s,height:a/r});break;case"270":o=(t,e,o,a)=>({x:1-(e+a-i)/r,y:(t-n)/s,width:a/r,height:o/s});break;default:o=(t,e,o,a)=>({x:(t-n)/s,y:(e-i)/r,width:o/s,height:a/r})}const a=[];for(let l=0,c=e.rangeCount;l<c;l++){const t=e.getRangeAt(l);if(!t.collapsed)for(const{x:e,y:n,width:i,height:s}of t.getClientRects())0!==i&&0!==s&&a.push(o(e,n,i,s))}return 0===a.length?null:a}addChangedExistingAnnotation({annotationElementId:t,id:e}){(this.#q||=new Map).set(t,e)}removeChangedExistingAnnotation({annotationElementId:t}){this.#q?.delete(t)}renderAnnotationElement(t){const e=this.#q?.get(t.data.id);if(!e)return;const n=this.#K.getRawValue(e);n&&(this.#xt!==Ta.NONE||n.hasBeenModified)&&n.renderAnnotationElement(t)}setMissingCanvas(t,e,n){const i=this.#vt?.get(t);i&&(i.setCanvas(e,n),this.#vt.delete(t))}addMissingCanvas(t,e){(this.#vt||=new Map).set(t,e)}}class rc{#f=null;#ie=!1;#se=null;#re=null;#oe=null;#ae=null;#le=!1;#ce=null;#u=null;#he=null;#de=null;#ue=!1;static#pe=null;static _l10n=null;constructor(t){this.#u=t,this.#ue=t._uiManager.useNewAltTextFlow,rc.#pe||=Object.freeze({added:"pdfjs-editor-new-alt-text-added-button","added-label":"pdfjs-editor-new-alt-text-added-button-label",missing:"pdfjs-editor-new-alt-text-missing-button","missing-label":"pdfjs-editor-new-alt-text-missing-button-label",review:"pdfjs-editor-new-alt-text-to-review-button","review-label":"pdfjs-editor-new-alt-text-to-review-button-label"})}static initialize(t){rc._l10n??=t}async render(){const t=this.#se=document.createElement("button");t.className="altText",t.tabIndex="0";const e=this.#re=document.createElement("span");t.append(e),this.#ue?(t.classList.add("new"),t.setAttribute("data-l10n-id",rc.#pe.missing),e.setAttribute("data-l10n-id",rc.#pe["missing-label"])):(t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button"),e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button-label"));const n=this.#u._uiManager._signal;t.addEventListener("contextmenu",Il,{signal:n}),t.addEventListener("pointerdown",t=>t.stopPropagation(),{signal:n});const i=t=>{t.preventDefault(),this.#u._uiManager.editAltText(this.#u),this.#ue&&this.#u._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_clicked",data:{label:this.#fe}})};return t.addEventListener("click",i,{capture:!0,signal:n}),t.addEventListener("keydown",e=>{e.target===t&&"Enter"===e.key&&(this.#le=!0,i(e))},{signal:n}),await this.#me(),t}get#fe(){return(this.#f?"added":null===this.#f&&this.guessedText&&"review")||"missing"}finish(){this.#se&&(this.#se.focus({focusVisible:this.#le}),this.#le=!1)}isEmpty(){return this.#ue?null===this.#f:!this.#f&&!this.#ie}hasData(){return this.#ue?null!==this.#f||!!this.#he:this.isEmpty()}get guessedText(){return this.#he}async setGuessedText(t){null===this.#f&&(this.#he=t,this.#de=await rc._l10n.get("pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer",{generatedAltText:t}),this.#me())}toggleAltTextBadge(t=!1){if(!this.#ue||this.#f)return this.#ce?.remove(),void(this.#ce=null);if(!this.#ce){const t=this.#ce=document.createElement("div");t.className="noAltTextBadge",this.#u.div.append(t)}this.#ce.classList.toggle("hidden",!t)}serialize(t){let e=this.#f;return t||this.#he!==e||(e=this.#de),{altText:e,decorative:this.#ie,guessedText:this.#he,textWithDisclaimer:this.#de}}get data(){return{altText:this.#f,decorative:this.#ie}}set data({altText:t,decorative:e,guessedText:n,textWithDisclaimer:i,cancel:s=!1}){n&&(this.#he=n,this.#de=i),this.#f===t&&this.#ie===e||(s||(this.#f=t,this.#ie=e),this.#me())}toggle(t=!1){this.#se&&(!t&&this.#ae&&(clearTimeout(this.#ae),this.#ae=null),this.#se.disabled=!t)}shown(){this.#u._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_displayed",data:{label:this.#fe}})}destroy(){this.#se?.remove(),this.#se=null,this.#re=null,this.#oe=null,this.#ce?.remove(),this.#ce=null}async#me(){const t=this.#se;if(!t)return;if(this.#ue){if(t.classList.toggle("done",!!this.#f),t.setAttribute("data-l10n-id",rc.#pe[this.#fe]),this.#re?.setAttribute("data-l10n-id",rc.#pe[`${this.#fe}-label`]),!this.#f)return void this.#oe?.remove()}else{if(!this.#f&&!this.#ie)return t.classList.remove("done"),void this.#oe?.remove();t.classList.add("done"),t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-edit-button")}let e=this.#oe;if(!e){this.#oe=e=document.createElement("span"),e.className="tooltip",e.setAttribute("role","tooltip"),e.id=`alt-text-tooltip-${this.#u.id}`;const n=100,i=this.#u._uiManager._signal;i.addEventListener("abort",()=>{clearTimeout(this.#ae),this.#ae=null},{once:!0}),t.addEventListener("mouseenter",()=>{this.#ae=setTimeout(()=>{this.#ae=null,this.#oe.classList.add("show"),this.#u._reportTelemetry({action:"alt_text_tooltip"})},n)},{signal:i}),t.addEventListener("mouseleave",()=>{this.#ae&&(clearTimeout(this.#ae),this.#ae=null),this.#oe?.classList.remove("show")},{signal:i})}this.#ie?e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-decorative-tooltip"):(e.removeAttribute("data-l10n-id"),e.textContent=this.#f),e.parentNode||t.append(e);const n=this.#u.getElementForAltText();n?.setAttribute("aria-describedby",e.id)}}class oc{#ge=null;#ye=null;#be=!1;#u=null;#we=null;#ve=null;#Ae=null;#xe=null;#Se=!1;#_e=null;constructor(t){this.#u=t}renderForToolbar(){const t=this.#ye=document.createElement("button");return t.className="comment",this.#T(t,!1)}renderForStandalone(){const t=this.#ge=document.createElement("button");t.className="annotationCommentButton";const e=this.#u.commentButtonPosition;if(e){const{style:n}=t;n.insetInlineEnd=`calc(${100*("ltr"===this.#u._uiManager.direction?1-e[0]:e[0])}% - var(--comment-button-dim))`,n.top=`calc(${100*e[1]}% - var(--comment-button-dim))`;const i=this.#u.commentButtonColor;i&&(n.backgroundColor=i)}return this.#T(t,!0)}focusButton(){setTimeout(()=>{(this.#ge??this.#ye)?.focus()},0)}onUpdatedColor(){if(!this.#ge)return;const t=this.#u.commentButtonColor;t&&(this.#ge.style.backgroundColor=t),this.#u._uiManager.updatePopupColor(this.#u)}get commentButtonWidth(){return(this.#ge?.getBoundingClientRect().width??0)/this.#u.parent.boundingClientRect.width}get commentPopupPositionInLayer(){if(this.#_e)return this.#_e;if(!this.#ge)return null;const{x:t,y:e,height:n}=this.#ge.getBoundingClientRect(),{x:i,y:s,width:r,height:o}=this.#u.parent.boundingClientRect;return[(t-i)/r,(e+n-s)/o]}set commentPopupPositionInLayer(t){this.#_e=t}hasDefaultPopupPosition(){return null===this.#_e}removeStandaloneCommentButton(){this.#ge?.remove(),this.#ge=null}removeToolbarCommentButton(){this.#ye?.remove(),this.#ye=null}setCommentButtonStates({selected:t,hasPopup:e}){this.#ge&&(this.#ge.classList.toggle("selected",t),this.#ge.ariaExpanded=e)}#T(t,e){if(!this.#u._uiManager.hasCommentManager())return null;t.tabIndex="0",t.ariaHasPopup="dialog",e?(t.ariaControls="commentPopup",t.setAttribute("data-l10n-id","pdfjs-show-comment-button")):(t.ariaControlsElements=[this.#u._uiManager.getCommentDialogElement()],t.setAttribute("data-l10n-id","pdfjs-editor-add-comment-button"));const n=this.#u._uiManager._signal;if(!(n instanceof AbortSignal)||n.aborted)return t;t.addEventListener("contextmenu",Il,{signal:n}),e&&(t.addEventListener("focusin",t=>{this.#u._focusEventsAllowed=!1,Nl(t)},{capture:!0,signal:n}),t.addEventListener("focusout",t=>{this.#u._focusEventsAllowed=!0,Nl(t)},{capture:!0,signal:n})),t.addEventListener("pointerdown",t=>t.stopPropagation(),{signal:n});const i=e=>{e.preventDefault(),t===this.#ye?this.edit():this.#u.toggleComment(!0)};return t.addEventListener("click",i,{capture:!0,signal:n}),t.addEventListener("keydown",e=>{e.target===t&&"Enter"===e.key&&(this.#be=!0,i(e))},{signal:n}),t.addEventListener("pointerenter",()=>{this.#u.toggleComment(!1,!0)},{signal:n}),t.addEventListener("pointerleave",()=>{this.#u.toggleComment(!1,!1)},{signal:n}),t}edit(t){const e=this.commentPopupPositionInLayer;let n,i;if(e)[n,i]=e;else{[n,i]=this.#u.commentButtonPosition;const{width:t,height:e,x:s,y:r}=this.#u;n=s+n*t,i=r+i*e}const s=this.#u.parent.boundingClientRect,{x:r,y:o,width:a,height:l}=s;this.#u._uiManager.editComment(this.#u,r+n*a,o+i*l,{...t,parentDimensions:s})}finish(){this.#ye&&(this.#ye.focus({focusVisible:this.#be}),this.#be=!1)}isDeleted(){return this.#Se||""===this.#Ae}isEmpty(){return null===this.#Ae}hasBeenEdited(){return this.isDeleted()||this.#Ae!==this.#we}serialize(){return this.data}get data(){return{text:this.#Ae,richText:this.#ve,date:this.#xe,deleted:this.isDeleted()}}set data(t){if(t!==this.#Ae&&(this.#ve=null),null===t)return this.#Ae="",void(this.#Se=!0);this.#Ae=t,this.#xe=new Date,this.#Se=!1}restoreData({text:t,richText:e,date:n}){this.#Ae=t,this.#ve=e,this.#xe=n,this.#Se=!1}setInitialText(t,e=null){this.#we=t,this.data=t,this.#xe=null,this.#ve=e}shown(){}destroy(){this.#ye?.remove(),this.#ye=null,this.#ge?.remove(),this.#ge=null,this.#Ae="",this.#ve=null,this.#xe=null,this.#u=null,this.#be=!1,this.#Se=!1}}class ac{#Nt;#Te=!1;#Ee=null;#Ce;#Me;#ke;#De;#Ie=null;#Ne;#Pe=null;#Oe;#Re=null;constructor({container:t,isPinchingDisabled:e=null,isPinchingStopped:n=null,onPinchStart:i=null,onPinching:s=null,onPinchEnd:r=null,signal:o}){this.#Nt=t,this.#Ee=n,this.#Ce=e,this.#Me=i,this.#ke=s,this.#De=r,this.#Oe=new AbortController,this.#Ne=AbortSignal.any([o,this.#Oe.signal]),t.addEventListener("touchstart",this.#Be.bind(this),{passive:!1,signal:this.#Ne})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return 35/Ll.pixelRatio}#Be(t){if(this.#Ce?.())return;if(1===t.touches.length){if(this.#Ie)return;const t=this.#Ie=new AbortController,e=AbortSignal.any([this.#Ne,t.signal]),n=this.#Nt,i={capture:!0,signal:e,passive:!1},s=t=>{"touch"===t.pointerType&&(this.#Ie?.abort(),this.#Ie=null)};return n.addEventListener("pointerdown",t=>{"touch"===t.pointerType&&(Nl(t),s(t))},i),n.addEventListener("pointerup",s,i),void n.addEventListener("pointercancel",s,i)}if(!this.#Re){this.#Re=new AbortController;const t=AbortSignal.any([this.#Ne,this.#Re.signal]),e=this.#Nt,n={signal:t,capture:!1,passive:!1};e.addEventListener("touchmove",this.#Fe.bind(this),n);const i=this.#Le.bind(this);e.addEventListener("touchend",i,n),e.addEventListener("touchcancel",i,n),n.capture=!0,e.addEventListener("pointerdown",Nl,n),e.addEventListener("pointermove",Nl,n),e.addEventListener("pointercancel",Nl,n),e.addEventListener("pointerup",Nl,n),this.#Me?.()}if(Nl(t),2!==t.touches.length||this.#Ee?.())return void(this.#Pe=null);let[e,n]=t.touches;e.identifier>n.identifier&&([e,n]=[n,e]),this.#Pe={touch0X:e.screenX,touch0Y:e.screenY,touch1X:n.screenX,touch1Y:n.screenY}}#Fe(t){if(!this.#Pe||2!==t.touches.length)return;Nl(t);let[e,n]=t.touches;e.identifier>n.identifier&&([e,n]=[n,e]);const{screenX:i,screenY:s}=e,{screenX:r,screenY:o}=n,a=this.#Pe,{touch0X:l,touch0Y:c,touch1X:h,touch1Y:d}=a,u=h-l,p=d-c,f=r-i,m=o-s,g=Math.hypot(f,m)||1,y=Math.hypot(u,p)||1;if(!this.#Te&&Math.abs(y-g)<=ac.MIN_TOUCH_DISTANCE_TO_PINCH)return;if(a.touch0X=i,a.touch0Y=s,a.touch1X=r,a.touch1Y=o,!this.#Te)return void(this.#Te=!0);const b=[(i+r)/2,(s+o)/2];this.#ke?.(b,y,g)}#Le(t){t.touches.length>=2||(this.#Re&&(this.#Re.abort(),this.#Re=null,this.#De?.()),this.#Pe&&(Nl(t),this.#Pe=null,this.#Te=!1))}destroy(){this.#Oe?.abort(),this.#Oe=null,this.#Ie?.abort(),this.#Ie=null}}class lc{#ze=null;#Ve=null;#f=null;#m=null;#ge=null;#He=!1;#$e=null;#Ue="";#We=null;#Ge=null;#je=null;#Ke=null;#qe=null;#Ye="";#Xe=!1;#Je=null;#Qe=!1;#Ze=!1;#tn=!1;#en=null;#nn=0;#in=0;#sn=null;#rn=null;isSelected=!1;_isCopy=!1;_editToolbar=null;_initialOptions=Object.create(null);_initialData=null;_isVisible=!0;_uiManager=null;_focusEventsAllowed=!0;static _l10n=null;static _l10nResizer=null;#on=!1;#an=lc._zIndex++;static _borderLineWidth=-1;static _colorManager=new ic;static _zIndex=1;static _telemetryTimeout=1e3;static get _resizerKeyboardManager(){const t=lc.prototype._resizeWithKeyboard,e=sc.TRANSLATE_SMALL,n=sc.TRANSLATE_BIG;return il(this,"_resizerKeyboardManager",new nc([[["ArrowLeft","mac+ArrowLeft"],t,{args:[-e,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t,{args:[-n,0]}],[["ArrowRight","mac+ArrowRight"],t,{args:[e,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t,{args:[n,0]}],[["ArrowUp","mac+ArrowUp"],t,{args:[0,-e]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t,{args:[0,-n]}],[["ArrowDown","mac+ArrowDown"],t,{args:[0,e]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t,{args:[0,n]}],[["Escape","mac+Escape"],lc.prototype._stopResizingWithKeyboard]]))}constructor(t){this.parent=t.parent,this.id=t.id,this.width=this.height=null,this.pageIndex=t.parent.pageIndex,this.name=t.name,this.div=null,this._uiManager=t.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=t.isCentered,this._structTreeParentId=null,this.annotationElementId=t.annotationElementId||null,this.creationDate=t.creationDate||new Date,this.modificationDate=t.modificationDate||null,this.canAddComment=!0;const{rotation:e,rawDims:{pageWidth:n,pageHeight:i,pageX:s,pageY:r}}=this.parent.viewport;this.rotation=e,this.pageRotation=(360+e-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[n,i],this.pageTranslation=[s,r];const[o,a]=this.parentDimensions;this.x=t.x/o,this.y=t.y/a,this.isAttachedToDOM=!1,this.deleted=!1}updatePageIndex(t){this.pageIndex=t}get editorType(){return Object.getPrototypeOf(this).constructor._type}get mode(){return Object.getPrototypeOf(this).constructor._editorType}static get isDrawer(){return!1}static get _defaultLineColor(){return il(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(t){const e=new cc({id:t.parent.getNextId(),parent:t.parent,uiManager:t._uiManager});e.annotationElementId=t.annotationElementId,e.deleted=!0,e._uiManager.addToAnnotationStorage(e)}static initialize(t,e){if(lc._l10n??=t,lc._l10nResizer||=Object.freeze({topLeft:"pdfjs-editor-resizer-top-left",topMiddle:"pdfjs-editor-resizer-top-middle",topRight:"pdfjs-editor-resizer-top-right",middleRight:"pdfjs-editor-resizer-middle-right",bottomRight:"pdfjs-editor-resizer-bottom-right",bottomMiddle:"pdfjs-editor-resizer-bottom-middle",bottomLeft:"pdfjs-editor-resizer-bottom-left",middleLeft:"pdfjs-editor-resizer-middle-left"}),-1!==lc._borderLineWidth)return;const n=getComputedStyle(document.documentElement);lc._borderLineWidth=parseFloat(n.getPropertyValue("--outline-width"))||0}static updateDefaultParams(t,e){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(t){return!1}static paste(t,e){Za("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#on}set _isDraggable(t){this.#on=t,this.div?.classList.toggle("draggable",t)}get uid(){return this.annotationElementId||this.id}get isEnterHandled(){return!0}center(){const[t,e]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*e/(2*t),this.y+=this.width*t/(2*e);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*e/(2*t),this.y-=this.width*t/(2*e);break;default:this.x-=this.width/2,this.y-=this.height/2}this.fixAndSetPosition()}addCommands(t){this._uiManager.addCommands(t)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#an}setParent(t){null!==t?(this.pageIndex=t.pageIndex,this.pageDimensions=t.pageDimensions):(this.#ln(),this.#Ke?.remove(),this.#Ke=null),this.parent=t}focusin(t){this._focusEventsAllowed&&(this.#Xe?this.#Xe=!1:this.parent.setSelected(this))}focusout(t){if(!this._focusEventsAllowed)return;if(!this.isAttachedToDOM)return;const e=t.relatedTarget;e?.closest(`#${this.id}`)||(t.preventDefault(),this.parent?.isMultipleSelection||this.commitOrRemove())}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.isInEditMode()&&this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(t,e,n,i){const[s,r]=this.parentDimensions;[n,i]=this.screenToPageTranslation(n,i),this.x=(t+n)/s,this.y=(e+i)/r,this.fixAndSetPosition()}_moveAfterPaste(t,e){const[n,i]=this.parentDimensions;this.setAt(t*n,e*i,this.width*n,this.height*i),this._onTranslated()}#cn([t,e],n,i){[n,i]=this.screenToPageTranslation(n,i),this.x+=n/t,this.y+=i/e,this._onTranslating(this.x,this.y),this.fixAndSetPosition()}translate(t,e){this.#cn(this.parentDimensions,t,e)}translateInPage(t,e){this.#Je||=[this.x,this.y,this.width,this.height],this.#cn(this.pageDimensions,t,e),this.div.scrollIntoView({block:"nearest"})}translationDone(){this._onTranslated(this.x,this.y)}drag(t,e){this.#Je||=[this.x,this.y,this.width,this.height];const{div:n,parentDimensions:[i,s]}=this;if(this.x+=t/i,this.y+=e/s,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:t,y:e}=this.div.getBoundingClientRect();this.parent.findNewParent(this,t,e)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x:r,y:o}=this;const[a,l]=this.getBaseTranslation();r+=a,o+=l;const{style:c}=n;c.left=`${(100*r).toFixed(2)}%`,c.top=`${(100*o).toFixed(2)}%`,this._onTranslating(r,o),n.scrollIntoView({block:"nearest"})}_onTranslating(t,e){}_onTranslated(t,e){}get _hasBeenMoved(){return!!this.#Je&&(this.#Je[0]!==this.x||this.#Je[1]!==this.y)}get _hasBeenResized(){return!!this.#Je&&(this.#Je[2]!==this.width||this.#Je[3]!==this.height)}getBaseTranslation(){const[t,e]=this.parentDimensions,{_borderLineWidth:n}=lc,i=n/t,s=n/e;switch(this.rotation){case 90:return[-i,s];case 180:return[i,s];case 270:return[i,-s];default:return[-i,-s]}}get _mustFixPosition(){return!0}fixAndSetPosition(t=this.rotation){const{div:{style:e},pageDimensions:[n,i]}=this;let{x:s,y:r,width:o,height:a}=this;if(o*=n,a*=i,s*=n,r*=i,this._mustFixPosition)switch(t){case 0:s=wl(s,0,n-o),r=wl(r,0,i-a);break;case 90:s=wl(s,0,n-a),r=wl(r,o,i);break;case 180:s=wl(s,o,n),r=wl(r,a,i);break;case 270:s=wl(s,a,n),r=wl(r,0,i-o)}this.x=s/=n,this.y=r/=i;const[l,c]=this.getBaseTranslation();s+=l,r+=c,e.left=`${(100*s).toFixed(2)}%`,e.top=`${(100*r).toFixed(2)}%`,this.moveInDOM()}static#hn(t,e,n){switch(n){case 90:return[e,-t];case 180:return[-t,-e];case 270:return[-e,t];default:return[t,e]}}screenToPageTranslation(t,e){return lc.#hn(t,e,this.parentRotation)}pageTranslationToScreen(t,e){return lc.#hn(t,e,360-this.parentRotation)}#dn(t){switch(t){case 90:{const[t,e]=this.pageDimensions;return[0,-t/e,e/t,0]}case 180:return[-1,0,0,-1];case 270:{const[t,e]=this.pageDimensions;return[0,t/e,-e/t,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale:t,pageDimensions:[e,n]}=this;return[e*t,n*t]}setDims(){const{div:{style:t},width:e,height:n}=this;t.width=`${(100*e).toFixed(2)}%`,t.height=`${(100*n).toFixed(2)}%`}getInitialTranslation(){return[0,0]}#un(){if(this.#We)return;this.#We=document.createElement("div"),this.#We.classList.add("resizers");const t=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"],e=this._uiManager._signal;for(const n of t){const t=document.createElement("div");this.#We.append(t),t.classList.add("resizer",n),t.setAttribute("data-resizer-name",n),t.addEventListener("pointerdown",this.#pn.bind(this,n),{signal:e}),t.addEventListener("contextmenu",Il,{signal:e}),t.tabIndex=-1}this.div.prepend(this.#We)}#pn(t,e){e.preventDefault();const{isMac:n}=ul.platform;if(0!==e.button||e.ctrlKey&&n)return;this.#f?.toggle(!1);const i=this._isDraggable;this._isDraggable=!1,this.#Ge=[e.screenX,e.screenY];const s=new AbortController,r=this._uiManager.combinedSignal(s);this.parent.togglePointerEvents(!1),window.addEventListener("pointermove",this.#fn.bind(this,t),{passive:!0,capture:!0,signal:r}),window.addEventListener("touchmove",Nl,{passive:!1,signal:r}),window.addEventListener("contextmenu",Il,{signal:r}),this.#je={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const o=this.parent.div.style.cursor,a=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(e.target).cursor;const l=()=>{s.abort(),this.parent.togglePointerEvents(!0),this.#f?.toggle(!0),this._isDraggable=i,this.parent.div.style.cursor=o,this.div.style.cursor=a,this.#mn()};window.addEventListener("pointerup",l,{signal:r}),window.addEventListener("blur",l,{signal:r})}#gn(t,e,n,i){this.width=n,this.height=i,this.x=t,this.y=e,this.setDims(),this.fixAndSetPosition(),this._onResized()}_onResized(){}#mn(){if(!this.#je)return;const{savedX:t,savedY:e,savedWidth:n,savedHeight:i}=this.#je;this.#je=null;const s=this.x,r=this.y,o=this.width,a=this.height;s===t&&r===e&&o===n&&a===i||this.addCommands({cmd:this.#gn.bind(this,s,r,o,a),undo:this.#gn.bind(this,t,e,n,i),mustExec:!0})}static _round(t){return Math.round(1e4*t)/1e4}#fn(t,e){const[n,i]=this.parentDimensions,s=this.x,r=this.y,o=this.width,a=this.height,l=lc.MIN_SIZE/n,c=lc.MIN_SIZE/i,h=this.#dn(this.rotation),d=(t,e)=>[h[0]*t+h[2]*e,h[1]*t+h[3]*e],u=this.#dn(360-this.rotation);let p,f,m=!1,g=!1;switch(t){case"topLeft":m=!0,p=(t,e)=>[0,0],f=(t,e)=>[t,e];break;case"topMiddle":p=(t,e)=>[t/2,0],f=(t,e)=>[t/2,e];break;case"topRight":m=!0,p=(t,e)=>[t,0],f=(t,e)=>[0,e];break;case"middleRight":g=!0,p=(t,e)=>[t,e/2],f=(t,e)=>[0,e/2];break;case"bottomRight":m=!0,p=(t,e)=>[t,e],f=(t,e)=>[0,0];break;case"bottomMiddle":p=(t,e)=>[t/2,e],f=(t,e)=>[t/2,0];break;case"bottomLeft":m=!0,p=(t,e)=>[0,e],f=(t,e)=>[t,0];break;case"middleLeft":g=!0,p=(t,e)=>[0,e/2],f=(t,e)=>[t,e/2]}const y=p(o,a),b=f(o,a);let w=d(...b);const v=lc._round(s+w[0]),A=lc._round(r+w[1]);let x,S,_=1,T=1;if(e.fromKeyboard)({deltaX:x,deltaY:S}=e);else{const{screenX:t,screenY:n}=e,[i,s]=this.#Ge;[x,S]=this.screenToPageTranslation(t-i,n-s),this.#Ge[0]=t,this.#Ge[1]=n}var E,C;if([x,S]=(E=x/n,C=S/i,[u[0]*E+u[2]*C,u[1]*E+u[3]*C]),m){const t=Math.hypot(o,a);_=T=Math.max(Math.min(Math.hypot(b[0]-y[0]-x,b[1]-y[1]-S)/t,1/o,1/a),l/o,c/a)}else g?_=wl(Math.abs(b[0]-y[0]-x),l,1)/o:T=wl(Math.abs(b[1]-y[1]-S),c,1)/a;const M=lc._round(o*_),k=lc._round(a*T);w=d(...f(M,k));const D=v-w[0],I=A-w[1];this.#Je||=[this.x,this.y,this.width,this.height],this.width=M,this.height=k,this.x=D,this.y=I,this.setDims(),this.fixAndSetPosition(),this._onResizing()}_onResizing(){}altTextFinish(){this.#f?.finish()}get toolbarButtons(){return null}async addEditToolbar(){if(this._editToolbar||this.#Ze)return this._editToolbar;this._editToolbar=new Yl(this),this.div.append(this._editToolbar.render());const{toolbarButtons:t}=this;if(t)for(const[e,n]of t)await this._editToolbar.addButton(e,n);return this.hasComment||this._editToolbar.addButton("comment",this.addCommentButton()),this._editToolbar.addButton("delete"),this._editToolbar}addCommentButtonInToolbar(){this._editToolbar?.addButtonBefore("comment",this.addCommentButton(),".deleteButton")}removeCommentButtonFromToolbar(){this._editToolbar?.removeButton("comment")}removeEditToolbar(){this._editToolbar?.remove(),this._editToolbar=null,this.#f?.destroy()}addContainer(t){const e=this._editToolbar?.div;e?e.before(t):this.div.append(t)}getClientDimensions(){return this.div.getBoundingClientRect()}createAltText(){return this.#f||(rc.initialize(lc._l10n),this.#f=new rc(this),this.#ze&&(this.#f.data=this.#ze,this.#ze=null)),this.#f}get altTextData(){return this.#f?.data}set altTextData(t){this.#f&&(this.#f.data=t)}get guessedAltText(){return this.#f?.guessedText}async setGuessedAltText(t){await(this.#f?.setGuessedText(t))}serializeAltText(t){return this.#f?.serialize(t)}hasAltText(){return!!this.#f&&!this.#f.isEmpty()}hasAltTextData(){return this.#f?.hasData()??!1}focusCommentButton(){this.#m?.focusButton()}addCommentButton(){return this.canAddComment?this.#m||=new oc(this):null}addStandaloneCommentButton(){this._uiManager.hasCommentManager()&&(this.#ge?this._uiManager.isEditingMode()&&this.#ge.classList.remove("hidden"):this.hasComment&&(this.#ge=this.#m.renderForStandalone(),this.div.append(this.#ge)))}removeStandaloneCommentButton(){this.#m.removeStandaloneCommentButton(),this.#ge=null}hideStandaloneCommentButton(){this.#ge?.classList.add("hidden")}get comment(){if(!this.#m)return null;const{data:{richText:t,text:e,date:n,deleted:i}}=this.#m;return{text:e,richText:t,date:n,deleted:i,color:this.getNonHCMColor(),opacity:this.opacity??1}}set comment(t){this.#m||=new oc(this),"object"==typeof t&&null!==t?this.#m.restoreData(t):this.#m.data=t,this.hasComment?(this.removeCommentButtonFromToolbar(),this.addStandaloneCommentButton(),this._uiManager.updateComment(this)):(this.addCommentButtonInToolbar(),this.removeStandaloneCommentButton(),this._uiManager.removeComment(this))}setCommentData({comment:t,popupRef:e,richText:n}){if(!e)return;if(this.#m||=new oc(this),this.#m.setInitialText(t,n),!this.annotationElementId)return;const i=this._uiManager.getAndRemoveDataFromAnnotationStorage(this.annotationElementId);i&&this.updateFromAnnotationLayer(i)}get hasEditedComment(){return this.#m?.hasBeenEdited()}get hasDeletedComment(){return this.#m?.isDeleted()}get hasComment(){return!!this.#m&&!this.#m.isEmpty()&&!this.#m.isDeleted()}async editComment(t){this.#m||=new oc(this),this.#m.edit(t)}toggleComment(t,e=void 0){this.hasComment&&this._uiManager.toggleComment(this,t,e)}setSelectedCommentButton(t){this.#m.setSelectedButton(t)}addComment(t){if(this.hasEditedComment){const e=180,n=100,[,,,i]=t.rect,[s]=this.pageDimensions,[r]=this.pageTranslation,o=r+s+1,a=i-n,l=o+e;t.popup={contents:this.comment.text,deleted:this.comment.deleted,rect:[o,a,l,i]}}}updateFromAnnotationLayer({popup:{contents:t,deleted:e}}){this.#m.data=e?null:t}get parentBoundingClientRect(){return this.parent.boundingClientRect}render(){const t=this.div=document.createElement("div");t.setAttribute("data-editor-rotation",(360-this.rotation)%360),t.className=this.name,t.setAttribute("id",this.id),t.tabIndex=this.#He?-1:0,t.setAttribute("role","application"),this.defaultL10nId&&t.setAttribute("data-l10n-id",this.defaultL10nId),this._isVisible||t.classList.add("hidden"),this.setInForeground(),this.#yn();const[e,n]=this.parentDimensions;this.parentRotation%180!=0&&(t.style.maxWidth=`${(100*n/e).toFixed(2)}%`,t.style.maxHeight=`${(100*e/n).toFixed(2)}%`);const[i,s]=this.getInitialTranslation();return this.translate(i,s),Jl(this,t,["keydown","pointerdown","dblclick"]),this.isResizable&&this._uiManager._supportsPinchToZoom&&(this.#rn||=new ac({container:t,isPinchingDisabled:()=>!this.isSelected,onPinchStart:this.#bn.bind(this),onPinching:this.#wn.bind(this),onPinchEnd:this.#vn.bind(this),signal:this._uiManager._signal})),this.addStandaloneCommentButton(),this._uiManager._editorUndoBar?.hide(),t}#bn(){this.#je={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height},this.#f?.toggle(!1),this.parent.togglePointerEvents(!1)}#wn(t,e,n){let i=n/e*.7+1-.7;if(1===i)return;const s=this.#dn(this.rotation),r=(t,e)=>[s[0]*t+s[2]*e,s[1]*t+s[3]*e],[o,a]=this.parentDimensions,l=this.x,c=this.y,h=this.width,d=this.height,u=lc.MIN_SIZE/o,p=lc.MIN_SIZE/a;i=Math.max(Math.min(i,1/h,1/d),u/h,p/d);const f=lc._round(h*i),m=lc._round(d*i);if(f===h&&m===d)return;this.#Je||=[l,c,h,d];const g=r(h/2,d/2),y=lc._round(l+g[0]),b=lc._round(c+g[1]),w=r(f/2,m/2);this.x=y-w[0],this.y=b-w[1],this.width=f,this.height=m,this.setDims(),this.fixAndSetPosition(),this._onResizing()}#vn(){this.#f?.toggle(!0),this.parent.togglePointerEvents(!0),this.#mn()}pointerdown(t){const{isMac:e}=ul.platform;0!==t.button||t.ctrlKey&&e?t.preventDefault():(this.#Xe=!0,this._isDraggable?this.#An(t):this.#xn(t))}#xn(t){const{isMac:e}=ul.platform;t.ctrlKey&&!e||t.shiftKey||t.metaKey&&e?this.parent.toggleSelected(this):this.parent.setSelected(this)}#An(t){const{isSelected:e}=this;this._uiManager.setUpDragSession();let n=!1;const i=new AbortController,s=this._uiManager.combinedSignal(i),r={capture:!0,passive:!1,signal:s},o=t=>{i.abort(),this.#$e=null,this.#Xe=!1,this._uiManager.endDragSession()||this.#xn(t),n&&this._onStopDragging()};e&&(this.#nn=t.clientX,this.#in=t.clientY,this.#$e=t.pointerId,this.#Ue=t.pointerType,window.addEventListener("pointermove",t=>{n||(n=!0,this._uiManager.toggleComment(this,!0,!1),this._onStartDragging());const{clientX:e,clientY:i,pointerId:s}=t;if(s!==this.#$e)return void Nl(t);const[r,o]=this.screenToPageTranslation(e-this.#nn,i-this.#in);this.#nn=e,this.#in=i,this._uiManager.dragSelectedEditors(r,o)},r),window.addEventListener("touchmove",Nl,r),window.addEventListener("pointerdown",t=>{t.pointerType===this.#Ue&&(this.#rn||t.isPrimary)&&o(t),Nl(t)},r));const a=t=>{this.#$e&&this.#$e!==t.pointerId?Nl(t):o(t)};window.addEventListener("pointerup",a,{signal:s}),window.addEventListener("blur",a,{signal:s})}_onStartDragging(){}_onStopDragging(){}moveInDOM(){this.#en&&clearTimeout(this.#en),this.#en=setTimeout(()=>{this.#en=null,this.parent?.moveEditorInDOM(this)},0)}_setParentAndPosition(t,e,n){t.changeParent(this),this.x=e,this.y=n,this.fixAndSetPosition(),this._onTranslated()}getRect(t,e,n=this.rotation){const i=this.parentScale,[s,r]=this.pageDimensions,[o,a]=this.pageTranslation,l=t/i,c=e/i,h=this.x*s,d=this.y*r,u=this.width*s,p=this.height*r;switch(n){case 0:return[h+l+o,r-d-c-p+a,h+l+u+o,r-d-c+a];case 90:return[h+c+o,r-d+l+a,h+c+p+o,r-d+l+u+a];case 180:return[h-l-u+o,r-d+c+a,h-l+o,r-d+c+p+a];case 270:return[h-c-p+o,r-d-l-u+a,h-c+o,r-d-l+a];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(t,e){const[n,i,s,r]=t,o=s-n,a=r-i;switch(this.rotation){case 0:return[n,e-r,o,a];case 90:return[n,e-i,a,o];case 180:return[s,e-i,o,a];case 270:return[s,e-r,a,o];default:throw new Error("Invalid rotation")}}getPDFRect(){return this.getRect(0,0)}getNonHCMColor(){return this.color&&lc._colorManager.convert(this._uiManager.getNonHCMColor(this.color))}onUpdatedColor(){this.#m?.onUpdatedColor()}getData(){const{comment:{text:t,color:e,date:n,opacity:i,deleted:s,richText:r},uid:o,pageIndex:a,creationDate:l,modificationDate:c}=this;return{id:o,pageIndex:a,rect:this.getPDFRect(),richText:r,contentsObj:{str:t},creationDate:l,modificationDate:n||c,popupRef:!s,color:e,opacity:i}}onceAdded(t){}isEmpty(){return!1}enableEditMode(){return!this.isInEditMode()&&(this.parent.setEditingState(!1),this.#Ze=!0,!0)}disableEditMode(){return!!this.isInEditMode()&&(this.parent.setEditingState(!0),this.#Ze=!1,!0)}isInEditMode(){return this.#Ze}shouldGetKeyboardEvents(){return this.#tn}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){const{top:t,left:e,bottom:n,right:i}=this.getClientDimensions(),{innerHeight:s,innerWidth:r}=window;return e<r&&i>0&&t<s&&n>0}#yn(){if(this.#qe||!this.div)return;this.#qe=new AbortController;const t=this._uiManager.combinedSignal(this.#qe);this.div.addEventListener("focusin",this.focusin.bind(this),{signal:t}),this.div.addEventListener("focusout",this.focusout.bind(this),{signal:t})}rebuild(){this.#yn()}rotate(t){}resize(){}serializeDeleted(){return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex,popupRef:this._initialData?.popupRef||""}}serialize(t=!1,e=null){return{annotationType:this.mode,pageIndex:this.pageIndex,rect:this.getPDFRect(),rotation:this.rotation,structTreeParentId:this._structTreeParentId,popupRef:this._initialData?.popupRef||""}}static async deserialize(t,e,n){const i=new this.prototype.constructor({parent:e,id:e.getNextId(),uiManager:n,annotationElementId:t.annotationElementId,creationDate:t.creationDate,modificationDate:t.modificationDate});i.rotation=t.rotation,i.#ze=t.accessibilityData,i._isCopy=t.isCopy||!1;const[s,r]=i.pageDimensions,[o,a,l,c]=i.getRectInCurrentCoords(t.rect,r);return i.x=o/s,i.y=a/r,i.width=l/s,i.height=c/r,i}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||null!==this.serialize())}remove(){if(this.#qe?.abort(),this.#qe=null,this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),this.hideCommentPopup(),this.#en&&(clearTimeout(this.#en),this.#en=null),this.#ln(),this.removeEditToolbar(),this.#sn){for(const t of this.#sn.values())clearTimeout(t);this.#sn=null}this.parent=null,this.#rn?.destroy(),this.#rn=null,this.#Ke?.remove(),this.#Ke=null}get isResizable(){return!1}makeResizable(){this.isResizable&&(this.#un(),this.#We.classList.remove("hidden"))}get toolbarPosition(){return null}get commentButtonPosition(){return"ltr"===this._uiManager.direction?[1,0]:[0,0]}get commentButtonPositionInPage(){const{commentButtonPosition:[t,e]}=this,[n,i,s,r]=this.getPDFRect();return[lc._round(n+(s-n)*t),lc._round(i+(r-i)*(1-e))]}get commentButtonColor(){return this._uiManager.makeCommentColor(this.getNonHCMColor(),this.opacity)}get commentPopupPosition(){return this.#m.commentPopupPositionInLayer}set commentPopupPosition(t){this.#m.commentPopupPositionInLayer=t}hasDefaultPopupPosition(){return this.#m.hasDefaultPopupPosition()}get commentButtonWidth(){return this.#m.commentButtonWidth}get elementBeforePopup(){return this.div}setCommentButtonStates(t){this.#m?.setCommentButtonStates(t)}keydown(t){if(!this.isResizable||t.target!==this.div||"Enter"!==t.key)return;this._uiManager.setSelected(this),this.#je={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const e=this.#We.children;if(!this.#Ve){this.#Ve=Array.from(e);const t=this.#Sn.bind(this),n=this.#_n.bind(this),i=this._uiManager._signal;for(const e of this.#Ve){const s=e.getAttribute("data-resizer-name");e.setAttribute("role","spinbutton"),e.addEventListener("keydown",t,{signal:i}),e.addEventListener("blur",n,{signal:i}),e.addEventListener("focus",this.#Tn.bind(this,s),{signal:i}),e.setAttribute("data-l10n-id",lc._l10nResizer[s])}}const n=this.#Ve[0];let i=0;for(const r of e){if(r===n)break;i++}const s=(360-this.rotation+this.parentRotation)%360/90*(this.#Ve.length/4);if(s!==i){if(s<i)for(let e=0;e<i-s;e++)this.#We.append(this.#We.firstElementChild);else if(s>i)for(let e=0;e<s-i;e++)this.#We.firstElementChild.before(this.#We.lastElementChild);let t=0;for(const n of e){const e=this.#Ve[t++].getAttribute("data-resizer-name");n.setAttribute("data-l10n-id",lc._l10nResizer[e])}}this.#En(0),this.#tn=!0,this.#We.firstElementChild.focus({focusVisible:!0}),t.preventDefault(),t.stopImmediatePropagation()}#Sn(t){lc._resizerKeyboardManager.exec(this,t)}#_n(t){this.#tn&&t.relatedTarget?.parentNode!==this.#We&&this.#ln()}#Tn(t){this.#Ye=this.#tn?t:""}#En(t){if(this.#Ve)for(const e of this.#Ve)e.tabIndex=t}_resizeWithKeyboard(t,e){this.#tn&&this.#fn(this.#Ye,{deltaX:t,deltaY:e,fromKeyboard:!0})}#ln(){this.#tn=!1,this.#En(-1),this.#mn()}_stopResizingWithKeyboard(){this.#ln(),this.div.focus()}select(){this.isSelected&&this._editToolbar?this._editToolbar.show():(this.isSelected=!0,this.makeResizable(),this.div?.classList.add("selectedEditor"),this._editToolbar?(this._editToolbar?.show(),this.#f?.toggleAltTextBadge(!1)):this.addEditToolbar().then(()=>{this.div?.classList.contains("selectedEditor")&&this._editToolbar?.show()}))}focus(){this.div&&!this.div.contains(document.activeElement)&&setTimeout(()=>this.div?.focus({preventScroll:!0}),0)}unselect(){this.isSelected&&(this.isSelected=!1,this.#We?.classList.add("hidden"),this.div?.classList.remove("selectedEditor"),this.div?.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus({preventScroll:!0}),this._editToolbar?.hide(),this.#f?.toggleAltTextBadge(!0),this.hideCommentPopup())}hideCommentPopup(){this.hasComment&&this._uiManager.toggleComment(null)}updateParams(t,e){}disableEditing(){}enableEditing(){}get canChangeContent(){return!1}enterInEditMode(){this.canChangeContent&&(this.enableEditMode(),this.div.focus())}dblclick(t){"BUTTON"!==t.target.nodeName&&(this.enterInEditMode(),this.parent.updateToolbar({mode:this.constructor._editorType,editId:this.uid}))}getElementForAltText(){return this.div}get contentDiv(){return this.div}get isEditing(){return this.#Qe}set isEditing(t){this.#Qe=t,this.parent&&(t?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null))}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return!0}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(t,e=!1){if(e){this.#sn||=new Map;const{action:e}=t;let n=this.#sn.get(e);return n&&clearTimeout(n),n=setTimeout(()=>{this._reportTelemetry(t),this.#sn.delete(e),0===this.#sn.size&&(this.#sn=null)},lc._telemetryTimeout),void this.#sn.set(e,n)}t.type||=this.editorType,this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:t}})}show(t=this._isVisible){this.div.classList.toggle("hidden",!t),this._isVisible=t}enable(){this.div&&(this.div.tabIndex=0),this.#He=!1}disable(){this.div&&(this.div.tabIndex=-1),this.#He=!0}updateFakeAnnotationElement(t){if(this.#Ke||this.deleted)return this.deleted?(this.#Ke.remove(),void(this.#Ke=null)):void((this.hasEditedComment||this._hasBeenMoved||this._hasBeenResized)&&this.#Ke.updateEdited({rect:this.getPDFRect(),popup:this.comment}));this.#Ke=t.addFakeAnnotation(this)}renderAnnotationElement(t){if(this.deleted)return t.hide(),null;let e=t.container.querySelector(".annotationContent");if(e){if("CANVAS"===e.nodeName){const t=e;e=document.createElement("div"),e.classList.add("annotationContent",this.editorType),t.before(e)}}else e=document.createElement("div"),e.classList.add("annotationContent",this.editorType),t.container.prepend(e);return e}resetAnnotationElement(t){const{firstElementChild:e}=t.container;"DIV"===e?.nodeName&&e.classList.contains("annotationContent")&&e.remove()}}class cc extends lc{constructor(t){super(t),this.annotationElementId=t.annotationElementId,this.deleted=!0}serialize(){return this.serializeDeleted()}}const hc=3285377520,dc=4294901760,uc=65535;class pc{constructor(t){this.h1=t?4294967295&t:hc,this.h2=t?4294967295&t:hc}update(t){let e,n;if("string"==typeof t){e=new Uint8Array(2*t.length),n=0;for(let i=0,s=t.length;i<s;i++){const s=t.charCodeAt(i);s<=255?e[n++]=s:(e[n++]=s>>>8,e[n++]=255&s)}}else{if(!ArrayBuffer.isView(t))throw new Error("Invalid data format, must be a string or TypedArray.");e=t.slice(),n=e.byteLength}const i=n>>2,s=n-4*i,r=new Uint32Array(e.buffer,0,i);let o=0,a=0,l=this.h1,c=this.h2;const h=3432918353,d=461845907,u=11601,p=13715;for(let f=0;f<i;f++)1&f?(o=r[f],o=o*h&dc|o*u&uc,o=o<<15|o>>>17,o=o*d&dc|o*p&uc,l^=o,l=l<<13|l>>>19,l=5*l+3864292196):(a=r[f],a=a*h&dc|a*u&uc,a=a<<15|a>>>17,a=a*d&dc|a*p&uc,c^=a,c=c<<13|c>>>19,c=5*c+3864292196);switch(o=0,s){case 3:o^=e[4*i+2]<<16;case 2:o^=e[4*i+1]<<8;case 1:o^=e[4*i],o=o*h&dc|o*u&uc,o=o<<15|o>>>17,o=o*d&dc|o*p&uc,1&i?l^=o:c^=o}this.h1=l,this.h2=c}hexdigest(){let t=this.h1,e=this.h2;return t^=e>>>1,t=3981806797*t&dc|36045*t&uc,e=4283543511*e&dc|(2950163797*(e<<16|t>>>16)&dc)>>>16,t^=e>>>1,t=444984403*t&dc|60499*t&uc,e=3301882366*e&dc|(3120437893*(e<<16|t>>>16)&dc)>>>16,t^=e>>>1,(t>>>0).toString(16).padStart(8,"0")+(e>>>0).toString(16).padStart(8,"0")}}const fc=Object.freeze({map:null,hash:"",transfer:void 0});class mc{#Cn=!1;#Mn=null;#kn=null;#Dn=new Map;constructor(){this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(t,e){const n=this.#Dn.get(t);return void 0===n?e:Object.assign(e,n)}getRawValue(t){return this.#Dn.get(t)}remove(t){const e=this.#Dn.get(t);if(void 0!==e&&(e instanceof lc&&this.#kn.delete(e.annotationElementId),this.#Dn.delete(t),0===this.#Dn.size&&this.resetModified(),"function"==typeof this.onAnnotationEditor)){for(const t of this.#Dn.values())if(t instanceof lc)return;this.onAnnotationEditor(null)}}setValue(t,e){const n=this.#Dn.get(t);let i=!1;if(void 0!==n)for(const[s,r]of Object.entries(e))n[s]!==r&&(i=!0,n[s]=r);else i=!0,this.#Dn.set(t,e);i&&this.#In(),e instanceof lc&&((this.#kn||=new Map).set(e.annotationElementId,e),"function"==typeof this.onAnnotationEditor&&this.onAnnotationEditor(e.constructor._type))}has(t){return this.#Dn.has(t)}get size(){return this.#Dn.size}#In(){this.#Cn||(this.#Cn=!0,"function"==typeof this.onSetModified&&this.onSetModified())}resetModified(){this.#Cn&&(this.#Cn=!1,"function"==typeof this.onResetModified&&this.onResetModified())}get print(){return new gc(this)}get serializable(){if(0===this.#Dn.size)return fc;const t=new Map,e=new pc,n=[],i=Object.create(null);let s=!1;for(const[r,o]of this.#Dn){const n=o instanceof lc?o.serialize(!1,i):o;o.page&&(o.pageIndex=o.page._pageIndex,delete o.page),n&&(t.set(r,n),e.update(`${r}:${JSON.stringify(n)}`),s||=!!n.bitmap)}if(s)for(const r of t.values())r.bitmap&&n.push(r.bitmap);return t.size>0?{map:t,hash:e.hexdigest(),transfer:n}:fc}get editorStats(){let t=null;const e=new Map;let n=0,i=0;for(const s of this.#Dn.values()){if(!(s instanceof lc)){s.popup&&(s.popup.deleted?i+=1:n+=1);continue}s.isCommentDeleted?i+=1:s.hasEditedComment&&(n+=1);const r=s.telemetryFinalData;if(!r)continue;const{type:o}=r;e.has(o)||e.set(o,Object.getPrototypeOf(s).constructor),t||=Object.create(null);const a=t[o]||=new Map;for(const[t,e]of Object.entries(r)){if("type"===t)continue;let n=a.get(t);n||(n=new Map,a.set(t,n));const i=n.get(e)??0;n.set(e,i+1)}}if((i>0||n>0)&&(t||=Object.create(null),t.comments={deleted:i,edited:n}),!t)return null;for(const[s,r]of e)t[s]=r.computeTelemetryFinalData(t[s]);return t}resetModifiedIds(){this.#Mn=null}updateEditor(t,e){const n=this.#kn?.get(t);return!!n&&(n.updateFromAnnotationLayer(e),!0)}getEditor(t){return this.#kn?.get(t)||null}get modifiedIds(){if(this.#Mn)return this.#Mn;const t=[];if(this.#kn)for(const e of this.#kn.values())e.serialize()&&t.push(e.annotationElementId);return this.#Mn={ids:new Set(t),hash:t.join(",")}}[Symbol.iterator](){return this.#Dn.entries()}}class gc extends mc{#Nn;constructor(t){super();const{map:e,hash:n,transfer:i}=t.serializable,s=structuredClone(e,i?{transfer:i}:null);this.#Nn={map:s,hash:n,transfer:i}}get print(){Za("Should not call PrintAnnotationStorage.print")}get serializable(){return this.#Nn}get modifiedIds(){return il(this,"modifiedIds",{ids:new Set,hash:""})}}class yc{#Pn=new Set;constructor({ownerDocument:t=globalThis.document,styleElement:e=null}){this._document=t,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(t){this.nativeFontFaces.add(t),this._document.fonts.add(t)}removeNativeFontFace(t){this.nativeFontFaces.delete(t),this._document.fonts.delete(t)}insertRule(t){this.styleElement||(this.styleElement=this._document.createElement("style"),this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement));const e=this.styleElement.sheet;e.insertRule(t,e.cssRules.length)}clear(){for(const t of this.nativeFontFaces)this._document.fonts.delete(t);this.nativeFontFaces.clear(),this.#Pn.clear(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async loadSystemFont({systemFontInfo:t,disableFontFace:e,_inspectFont:n}){if(t&&!this.#Pn.has(t.loadedName)){if(tl(!e,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){const{loadedName:e,src:i,style:s}=t,r=new FontFace(e,i,s);this.addNativeFontFace(r);try{await r.load(),this.#Pn.add(e),n?.(t)}catch{Qa(`Cannot load system font: ${t.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(r)}return}Za("Not implemented: loadSystemFont without the Font Loading API.")}}async bind(t){if(t.attached||t.missingFile&&!t.systemFontInfo)return;if(t.attached=!0,t.systemFontInfo)return void(await this.loadSystemFont(t));if(this.isFontLoadingAPISupported){const e=t.createNativeFontFace();if(e){this.addNativeFontFace(e);try{await e.loaded}catch(n){throw Qa(`Failed to load font '${e.family}': '${n}'.`),t.disableFontFace=!0,n}}return}const e=t.createFontFaceRule();if(e){if(this.insertRule(e),this.isSyncFontLoadingSupported)return;await new Promise(e=>{const n=this._queueLoadingCallback(e);this._prepareFontLoadEvent(t,n)})}}get isFontLoadingAPISupported(){return il(this,"isFontLoadingAPISupported",!!this._document?.fonts)}get isSyncFontLoadingSupported(){return il(this,"isSyncFontLoadingSupported",ua||ul.platform.isFirefox)}_queueLoadingCallback(t){const{loadingRequests:e}=this,n={done:!1,complete:function(){for(tl(!n.done,"completeRequest() cannot be called twice."),n.done=!0;e.length>0&&e[0].done;){const t=e.shift();setTimeout(t.callback,0)}},callback:t};return e.push(n),n}get _loadTestFont(){return il(this,"_loadTestFont",atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA=="))}_prepareFontLoadEvent(t,e){function n(t,e){return t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|255&t.charCodeAt(e+3)}function i(t,e,n,i){return t.substring(0,e)+i+t.substring(e+n)}let s,r;const o=this._document.createElement("canvas");o.width=1,o.height=1;const a=o.getContext("2d");let l=0;const c=`lt${Date.now()}${this.loadTestFontId++}`;let h=this._loadTestFont;h=i(h,976,c.length,c);const d=1482184792;let u=n(h,16);for(s=0,r=c.length-3;s<r;s+=4)u=u-d+n(c,s)|0;var p;s<c.length&&(u=u-d+n(c+"XXX",s)|0),h=i(h,16,4,(p=u,String.fromCharCode(p>>24&255,p>>16&255,p>>8&255,255&p)));const f=`@font-face {font-family:"${c}";src:${`url(data:font/opentype;base64,${btoa(h)});`}}`;this.insertRule(f);const m=this._document.createElement("div");m.style.visibility="hidden",m.style.width=m.style.height="10px",m.style.position="absolute",m.style.top=m.style.left="0px";for(const g of[t.loadedName,c]){const t=this._document.createElement("span");t.textContent="Hi",t.style.fontFamily=g,m.append(t)}this._document.body.append(m),function t(e,n){if(++l>30)return Qa("Load test font never loaded."),void n();a.font="30px "+e,a.fillText(".",0,20),a.getImageData(0,0,1,1).data[3]>0?n():setTimeout(t.bind(null,e,n))}(c,()=>{m.remove(),e.complete()})}}class bc{#On;constructor(t,e=null,n,i){this.compiledGlyphs=Object.create(null),this.#On=t,this._inspectFont=e,n&&Object.assign(this,n),i&&(this.charProcOperatorList=i)}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let t;if(this.cssFontInfo){const e={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(e.style=`oblique ${this.cssFontInfo.italicAngle}deg`),t=new FontFace(this.cssFontInfo.fontFamily,this.data,e)}else t=new FontFace(this.loadedName,this.data,{});return this._inspectFont?.(this),t}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;const t=`url(data:${this.mimetype};base64,${this.data.toBase64()});`;let e;if(this.cssFontInfo){let n=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(n+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),e=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${n}src:${t}}`}else e=`@font-face {font-family:"${this.loadedName}";src:${t}}`;return this._inspectFont?.(this,t),e}getPathGenerator(t,e){if(void 0!==this.compiledGlyphs[e])return this.compiledGlyphs[e];const n=this.loadedName+"_path_"+e;let i;try{i=t.get(n)}catch(r){Qa(`getPathGenerator - ignoring character: "${r}".`)}const s=Kl(i?.path);return this.fontExtraProperties||t.delete(n),this.compiledGlyphs[e]=s}get black(){return this.#On.black}get bold(){return this.#On.bold}get disableFontFace(){return this.#On.disableFontFace??!1}set disableFontFace(t){il(this,"disableFontFace",!!t)}get fontExtraProperties(){return this.#On.fontExtraProperties??!1}get isInvalidPDFjsFont(){return this.#On.isInvalidPDFjsFont}get isType3Font(){return this.#On.isType3Font}get italic(){return this.#On.italic}get missingFile(){return this.#On.missingFile}get remeasure(){return this.#On.remeasure}get vertical(){return this.#On.vertical}get ascent(){return this.#On.ascent}get defaultWidth(){return this.#On.defaultWidth}get descent(){return this.#On.descent}get bbox(){return this.#On.bbox}set bbox(t){il(this,"bbox",t)}get fontMatrix(){return this.#On.fontMatrix}get fallbackName(){return this.#On.fallbackName}get loadedName(){return this.#On.loadedName}get mimetype(){return this.#On.mimetype}get name(){return this.#On.name}get data(){return this.#On.data}clearData(){this.#On.clearData()}get cssFontInfo(){return this.#On.cssFontInfo}get systemFontInfo(){return this.#On.systemFontInfo}get defaultVMetrics(){return this.#On.defaultVMetrics}}class wc{#Rn;#Bn;#Fn;static strings=["fontFamily","fontWeight","italicAngle"];static write(t){const e=new TextEncoder,n={};let i=0;for(const l of wc.strings){const s=e.encode(t[l]);n[l]=s,i+=4+s.length}const s=new ArrayBuffer(i),r=new Uint8Array(s),o=new DataView(s);let a=0;for(const l of wc.strings){const t=n[l],e=t.length;o.setUint32(a,e),r.set(t,a+4),a+=4+e}return tl(a===s.byteLength,"CssFontInfo.write: Buffer overflow"),s}constructor(t){this.#Rn=t,this.#Bn=new DataView(this.#Rn),this.#Fn=new TextDecoder}#Ln(t){tl(t<wc.strings.length,"Invalid string index");let e=0;for(let i=0;i<t;i++)e+=this.#Bn.getUint32(e)+4;const n=this.#Bn.getUint32(e);return this.#Fn.decode(new Uint8Array(this.#Rn,e+4,n))}get fontFamily(){return this.#Ln(0)}get fontWeight(){return this.#Ln(1)}get italicAngle(){return this.#Ln(2)}}class vc{#Rn;#Bn;#Fn;static strings=["css","loadedName","baseFontName","src"];static write(t){const e=new TextEncoder,n={};let i=0;for(const d of vc.strings){const s=e.encode(t[d]);n[d]=s,i+=4+s.length}i+=4;let s,r,o=1+i;t.style&&(s=e.encode(t.style.style),r=e.encode(t.style.weight),o+=4+s.length+4+r.length);const a=new ArrayBuffer(o),l=new Uint8Array(a),c=new DataView(a);let h=0;c.setUint8(h++,t.guessFallback?1:0),c.setUint32(h,0),h+=4,i=0;for(const d of vc.strings){const t=n[d],e=t.length;i+=4+e,c.setUint32(h,e),l.set(t,h+4),h+=4+e}return c.setUint32(h-i-4,i),t.style&&(c.setUint32(h,s.length),l.set(s,h+4),h+=4+s.length,c.setUint32(h,r.length),l.set(r,h+4),h+=4+r.length),tl(h<=a.byteLength,"SubstitionInfo.write: Buffer overflow"),a.transferToFixedLength(h)}constructor(t){this.#Rn=t,this.#Bn=new DataView(this.#Rn),this.#Fn=new TextDecoder}get guessFallback(){return 0!==this.#Bn.getUint8(0)}#Ln(t){tl(t<vc.strings.length,"Invalid string index");let e=5;for(let i=0;i<t;i++)e+=this.#Bn.getUint32(e)+4;const n=this.#Bn.getUint32(e);return this.#Fn.decode(new Uint8Array(this.#Rn,e+4,n))}get css(){return this.#Ln(0)}get loadedName(){return this.#Ln(1)}get baseFontName(){return this.#Ln(2)}get src(){return this.#Ln(3)}get style(){let t=1;t+=4+this.#Bn.getUint32(t);const e=this.#Bn.getUint32(t),n=this.#Fn.decode(new Uint8Array(this.#Rn,t+4,e));t+=4+e;const i=this.#Bn.getUint32(t);return{style:n,weight:this.#Fn.decode(new Uint8Array(this.#Rn,t+4,i))}}}class Ac{static bools=["black","bold","disableFontFace","fontExtraProperties","isInvalidPDFjsFont","isType3Font","italic","missingFile","remeasure","vertical"];static numbers=["ascent","defaultWidth","descent"];static strings=["fallbackName","loadedName","mimetype","name"];static#zn=Math.ceil(2*this.bools.length/8);static#Vn=this.#zn+8*this.numbers.length;static#Hn=this.#Vn+1+8;static#$n=this.#Hn+1+48;static#Un=this.#$n+1+6;#Rn;#Fn;#Bn;constructor({data:t,extra:e}){this.#Rn=t,this.#Fn=new TextDecoder,this.#Bn=new DataView(this.#Rn),e&&Object.assign(this,e)}#Wn(t){tl(t<Ac.bools.length,"Invalid boolean index");const e=Math.floor(t/4),n=2*t%8,i=this.#Bn.getUint8(e)>>n&3;return 0===i?void 0:2===i}get black(){return this.#Wn(0)}get bold(){return this.#Wn(1)}get disableFontFace(){return this.#Wn(2)}get fontExtraProperties(){return this.#Wn(3)}get isInvalidPDFjsFont(){return this.#Wn(4)}get isType3Font(){return this.#Wn(5)}get italic(){return this.#Wn(6)}get missingFile(){return this.#Wn(7)}get remeasure(){return this.#Wn(8)}get vertical(){return this.#Wn(9)}#Gn(t){return tl(t<Ac.numbers.length,"Invalid number index"),this.#Bn.getFloat64(Ac.#zn+8*t)}get ascent(){return this.#Gn(0)}get defaultWidth(){return this.#Gn(1)}get descent(){return this.#Gn(2)}get bbox(){let t=Ac.#Vn;if(0===this.#Bn.getUint8(t))return;t+=1;const e=[];for(let n=0;n<4;n++)e.push(this.#Bn.getInt16(t,!0)),t+=2;return e}get fontMatrix(){let t=Ac.#Hn;if(0===this.#Bn.getUint8(t))return;t+=1;const e=[];for(let n=0;n<6;n++)e.push(this.#Bn.getFloat64(t,!0)),t+=8;return e}get defaultVMetrics(){let t=Ac.#$n;if(0===this.#Bn.getUint8(t))return;t+=1;const e=[];for(let n=0;n<3;n++)e.push(this.#Bn.getInt16(t,!0)),t+=2;return e}#Ln(t){tl(t<Ac.strings.length,"Invalid string index");let e=Ac.#Un+4;for(let s=0;s<t;s++)e+=this.#Bn.getUint32(e)+4;const n=this.#Bn.getUint32(e),i=new Uint8Array(n);return i.set(new Uint8Array(this.#Rn,e+4,n)),this.#Fn.decode(i)}get fallbackName(){return this.#Ln(0)}get loadedName(){return this.#Ln(1)}get mimetype(){return this.#Ln(2)}get name(){return this.#Ln(3)}get data(){let t=Ac.#Un;t+=4+this.#Bn.getUint32(t);t+=4+this.#Bn.getUint32(t);t+=4+this.#Bn.getUint32(t);const e=this.#Bn.getUint32(t);if(0!==e)return new Uint8Array(this.#Rn,t+4,e)}clearData(){let t=Ac.#Un;t+=4+this.#Bn.getUint32(t);t+=4+this.#Bn.getUint32(t);t+=4+this.#Bn.getUint32(t);const e=this.#Bn.getUint32(t);new Uint8Array(this.#Rn,t+4,e).fill(0),this.#Bn.setUint32(t,0)}get cssFontInfo(){let t=Ac.#Un;t+=4+this.#Bn.getUint32(t);t+=4+this.#Bn.getUint32(t);const e=this.#Bn.getUint32(t);if(0===e)return null;const n=new Uint8Array(e);return n.set(new Uint8Array(this.#Rn,t+4,e)),new wc(n.buffer)}get systemFontInfo(){let t=Ac.#Un;t+=4+this.#Bn.getUint32(t);const e=this.#Bn.getUint32(t);if(0===e)return null;const n=new Uint8Array(e);return n.set(new Uint8Array(this.#Rn,t+4,e)),new vc(n.buffer)}static write(t){const e=t.systemFontInfo?vc.write(t.systemFontInfo):null,n=t.cssFontInfo?wc.write(t.cssFontInfo):null,i=new TextEncoder,s={};let r=0;for(const f of Ac.strings)s[f]=i.encode(t[f]),r+=4+s[f].length;const o=Ac.#Un+4+r+4+(e?e.byteLength:0)+4+(n?n.byteLength:0)+4+(t.data?t.data.length:0),a=new ArrayBuffer(o),l=new Uint8Array(a),c=new DataView(a);let h=0;const d=Ac.bools.length;let u=0,p=0;for(let f=0;f<d;f++){const e=t[Ac.bools[f]];u|=(void 0===e?0:e?2:1)<<p,p+=2,8!==p&&f!==d-1||(c.setUint8(h++,u),u=0,p=0)}tl(h===Ac.#zn,"FontInfo.write: Boolean properties offset mismatch");for(const f of Ac.numbers)c.setFloat64(h,t[f]),h+=8;if(tl(h===Ac.#Vn,"FontInfo.write: Number properties offset mismatch"),t.bbox){c.setUint8(h++,4);for(const e of t.bbox)c.setInt16(h,e,!0),h+=2}else c.setUint8(h++,0),h+=8;if(tl(h===Ac.#Hn,"FontInfo.write: BBox properties offset mismatch"),t.fontMatrix){c.setUint8(h++,6);for(const e of t.fontMatrix)c.setFloat64(h,e,!0),h+=8}else c.setUint8(h++,0),h+=48;if(tl(h===Ac.#$n,"FontInfo.write: FontMatrix properties offset mismatch"),t.defaultVMetrics){c.setUint8(h++,1);for(const e of t.defaultVMetrics)c.setInt16(h,e,!0),h+=2}else c.setUint8(h++,0),h+=6;tl(h===Ac.#Un,"FontInfo.write: DefaultVMetrics properties offset mismatch"),c.setUint32(Ac.#Un,0),h+=4;for(const f of Ac.strings){const t=s[f],e=t.length;c.setUint32(h,e),l.set(t,h+4),h+=4+e}if(c.setUint32(Ac.#Un,h-Ac.#Un-4),e){const t=e.byteLength;c.setUint32(h,t),tl(h+4+t<=a.byteLength,"FontInfo.write: Buffer overflow at systemFontInfo"),l.set(new Uint8Array(e),h+4),h+=4+t}else c.setUint32(h,0),h+=4;if(n){const t=n.byteLength;c.setUint32(h,t),tl(h+4+t<=a.byteLength,"FontInfo.write: Buffer overflow at cssFontInfo"),l.set(new Uint8Array(n),h+4),h+=4+t}else c.setUint32(h,0),h+=4;return void 0===t.data?(c.setUint32(h,0),h+=4):(c.setUint32(h,t.data.length),l.set(t.data,h+4),h+=4+t.data.length),tl(h<=a.byteLength,"FontInfo.write: Buffer overflow"),a.transferToFixedLength(h)}}class xc{static#jn=0;static#Kn=1;static#qn=2;static#Yn=3;static#Xn=4;static#Jn=8;static#Qn=12;static#Zn=16;constructor(t){this.buffer=t,this.view=new DataView(t),this.data=new Uint8Array(t)}static write(t){let e,n=null,i=[],s=[],r=[],o=[],a=null,l=null;switch(t[0]){case"RadialAxial":e="axial"===t[1]?1:2,n=t[2],r=t[3],1===e?i.push(...t[4],...t[5]):i.push(t[4][0],t[4][1],t[6],t[5][0],t[5][1],t[7]);break;case"Mesh":e=3,a=t[1],i=t[2],s=t[3],o=t[4]||[],n=t[6],l=t[7];break;default:throw new Error(`Unsupported pattern type: ${t[0]}`)}const c=Math.floor(i.length/2),h=Math.floor(s.length/3),d=r.length,u=o.length;let p=0;for(const b of o)p+=1,p=4*Math.ceil(p/4),p+=4+4*b.coords.length,p+=4+4*b.colors.length,void 0!==b.verticesPerRow&&(p+=4);const f=new ArrayBuffer(20+8*c+3*h+8*d+(n?16:0)+(l?3:0)+p),m=new DataView(f),g=new Uint8Array(f);m.setUint8(xc.#jn,e),m.setUint8(xc.#Kn,n?1:0),m.setUint8(xc.#qn,l?1:0),m.setUint8(xc.#Yn,a),m.setUint32(xc.#Xn,c,!0),m.setUint32(xc.#Jn,h,!0),m.setUint32(xc.#Qn,d,!0),m.setUint32(xc.#Zn,u,!0);let y=20;new Float32Array(f,y,2*c).set(i),y+=8*c,g.set(s,y),y+=3*h;for(const[b,w]of r)m.setFloat32(y,b,!0),y+=4,m.setUint32(y,parseInt(w.slice(1),16),!0),y+=4;if(n)for(const b of n)m.setFloat32(y,b,!0),y+=4;l&&(g.set(l,y),y+=3);for(let b=0;b<o.length;b++){const t=o[b];m.setUint8(y,t.type),y+=1,y=4*Math.ceil(y/4),m.setUint32(y,t.coords.length,!0),y+=4;new Int32Array(f,y,t.coords.length).set(t.coords),y+=4*t.coords.length,m.setUint32(y,t.colors.length,!0),y+=4;new Int32Array(f,y,t.colors.length).set(t.colors),y+=4*t.colors.length,void 0!==t.verticesPerRow&&(m.setUint32(y,t.verticesPerRow,!0),y+=4)}return f}getIR(){const t=this.view,e=this.data[xc.#jn],n=!!this.data[xc.#Kn],i=!!this.data[xc.#qn],s=t.getUint32(xc.#Xn,!0),r=t.getUint32(xc.#Jn,!0),o=t.getUint32(xc.#Qn,!0),a=t.getUint32(xc.#Zn,!0);let l=20;const c=new Float32Array(this.buffer,l,2*s);l+=8*s;const h=new Uint8Array(this.buffer,l,3*r);l+=3*r;const d=[];for(let m=0;m<o;++m){const e=t.getFloat32(l,!0);l+=4;const n=t.getUint32(l,!0);l+=4,d.push([e,`#${n.toString(16).padStart(6,"0")}`])}let u=null;if(n){u=[];for(let e=0;e<4;++e)u.push(t.getFloat32(l,!0)),l+=4}let p=null;i&&(p=new Uint8Array(this.buffer,l,3),l+=3);const f=[];for(let m=0;m<a;++m){const e=t.getUint8(l);l+=1,l=4*Math.ceil(l/4);const n=t.getUint32(l,!0);l+=4;const i=new Int32Array(this.buffer,l,n);l+=4*n;const s=t.getUint32(l,!0);l+=4;const r=new Int32Array(this.buffer,l,s);l+=4*s;const o={type:e,coords:i,colors:r};e===Ma&&(o.verticesPerRow=t.getUint32(l,!0),l+=4),f.push(o)}if(1===e)return["RadialAxial","axial",u,d,Array.from(c.slice(0,2)),Array.from(c.slice(2,4)),null,null];if(2===e)return["RadialAxial","radial",u,d,[c[0],c[1]],[c[3],c[4]],c[2],c[5]];if(3===e){const t=this.data[xc.#Yn];let e=null;if(c.length>0){let t=c[0],n=c[0],i=c[1],s=c[1];for(let e=0;e<c.length;e+=2){const r=c[e],o=c[e+1];t=t>r?r:t,i=i>o?o:i,n=n<r?r:n,s=s<o?o:s}e=[t,i,n,s]}return["Mesh",t,c,h,f,e,u,p]}throw new Error(`Unsupported pattern kind: ${e}`)}}class Sc{static write(t){let e,n;return ul.isFloat16ArraySupported?(n=new ArrayBuffer(2*t.length),e=new Float16Array(n)):(n=new ArrayBuffer(4*t.length),e=new Float32Array(n)),e.set(t),n}#Rn;constructor(t){this.#Rn=t}get path(){return ul.isFloat16ArraySupported?new Float16Array(this.#Rn):new Float32Array(this.#Rn)}}function _c(t){if("string"!=typeof t)return null;if(t.endsWith("/"))return t;throw new Error(`Invalid factory url: "${t}" must include trailing slash.`)}const Tc=t=>"object"==typeof t&&Number.isInteger(t?.num)&&t.num>=0&&Number.isInteger(t?.gen)&&t.gen>=0,Ec=function(t,e,n){if(!Array.isArray(n)||n.length<2)return!1;const[i,s,...r]=n;if(!t(i)&&!Number.isInteger(i))return!1;if(!e(s))return!1;const o=r.length;let a=!0;switch(s.name){case"XYZ":if(o<2||o>3)return!1;break;case"Fit":case"FitB":return 0===o;case"FitH":case"FitBH":case"FitV":case"FitBV":if(o>1)return!1;break;case"FitR":if(4!==o)return!1;a=!1;break;default:return!1}for(const l of r)if(!("number"==typeof l||a&&null===l))return!1;return!0}.bind(null,Tc,t=>"object"==typeof t&&"string"==typeof t?.name);class Cc{#a=new Map;#ti=Promise.resolve();postMessage(t,e){const n={data:structuredClone(t,e?{transfer:e}:null)};this.#ti.then(()=>{for(const[t]of this.#a)t.call(this,n)})}addEventListener(t,e,n=null){let i=null;if(n?.signal instanceof AbortSignal){const{signal:s}=n;if(s.aborted)return void Qa("LoopbackPort - cannot use an `aborted` signal.");const r=()=>this.removeEventListener(t,e);i=()=>s.removeEventListener("abort",r),s.addEventListener("abort",r)}this.#a.set(e,i)}removeEventListener(t,e){const n=this.#a.get(e);n?.(),this.#a.delete(e)}terminate(){for(const[,t]of this.#a)t?.();this.#a.clear()}}const Mc=1,kc=2,Dc=1,Ic=2,Nc=3,Pc=4,Oc=5,Rc=6,Bc=7,Fc=8;function Lc(){}function zc(t){if(t instanceof hl||t instanceof al||t instanceof rl||t instanceof ll||t instanceof ol)return t;switch(t instanceof Error||"object"==typeof t&&null!==t||Za('wrapReason: Expected "reason" to be a (possibly cloned) Error.'),t.name){case"AbortException":return new hl(t.message);case"InvalidPDFException":return new al(t.message);case"PasswordException":return new rl(t.message,t.code);case"ResponseException":return new ll(t.message,t.status,t.missing);case"UnknownErrorException":return new ol(t.message,t.details)}return new ol(t.message,t.toString())}class Vc{#ei=new AbortController;constructor(t,e,n){this.sourceName=t,this.targetName=e,this.comObj=n,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),n.addEventListener("message",this.#ni.bind(this),{signal:this.#ei.signal})}#ni({data:t}){if(t.targetName!==this.sourceName)return;if(t.stream)return void this.#ii(t);if(t.callback){const e=t.callbackId,n=this.callbackCapabilities[e];if(!n)throw new Error(`Cannot resolve callback ${e}`);if(delete this.callbackCapabilities[e],t.callback===Mc)n.resolve(t.data);else{if(t.callback!==kc)throw new Error("Unexpected callback case");n.reject(zc(t.reason))}return}const e=this.actionHandler[t.action];if(!e)throw new Error(`Unknown action from worker: ${t.action}`);if(t.callbackId){const n=this.sourceName,i=t.sourceName,s=this.comObj;return void Promise.try(e,t.data).then(function(e){s.postMessage({sourceName:n,targetName:i,callback:Mc,callbackId:t.callbackId,data:e})},function(e){s.postMessage({sourceName:n,targetName:i,callback:kc,callbackId:t.callbackId,reason:zc(e)})})}t.streamId?this.#si(t):e(t.data)}on(t,e){const n=this.actionHandler;if(n[t])throw new Error(`There is already an actionName called "${t}"`);n[t]=e}send(t,e,n){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,data:e},n)}sendWithPromise(t,e,n){const i=this.callbackId++,s=Promise.withResolvers();this.callbackCapabilities[i]=s;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,callbackId:i,data:e},n)}catch(r){s.reject(r)}return s.promise}sendWithStream(t,e,n,i){const s=this.streamId++,r=this.sourceName,o=this.targetName,a=this.comObj;return new ReadableStream({start:n=>{const l=Promise.withResolvers();return this.streamControllers[s]={controller:n,startCall:l,pullCall:null,cancelCall:null,isClosed:!1},a.postMessage({sourceName:r,targetName:o,action:t,streamId:s,data:e,desiredSize:n.desiredSize},i),l.promise},pull:t=>{const e=Promise.withResolvers();return this.streamControllers[s].pullCall=e,a.postMessage({sourceName:r,targetName:o,stream:Rc,streamId:s,desiredSize:t.desiredSize}),e.promise},cancel:t=>{tl(t instanceof Error,"cancel must have a valid reason");const e=Promise.withResolvers();return this.streamControllers[s].cancelCall=e,this.streamControllers[s].isClosed=!0,a.postMessage({sourceName:r,targetName:o,stream:Dc,streamId:s,reason:zc(t)}),e.promise}},n)}#si(t){const e=t.streamId,n=this.sourceName,i=t.sourceName,s=this.comObj,r=this,o=this.actionHandler[t.action],a={enqueue(t,r=1,o){if(this.isCancelled)return;const a=this.desiredSize;this.desiredSize-=r,a>0&&this.desiredSize<=0&&(this.sinkCapability=Promise.withResolvers(),this.ready=this.sinkCapability.promise),s.postMessage({sourceName:n,targetName:i,stream:Pc,streamId:e,chunk:t},o)},close(){this.isCancelled||(this.isCancelled=!0,s.postMessage({sourceName:n,targetName:i,stream:Nc,streamId:e}),delete r.streamSinks[e])},error(t){tl(t instanceof Error,"error must have a valid reason"),this.isCancelled||(this.isCancelled=!0,s.postMessage({sourceName:n,targetName:i,stream:Oc,streamId:e,reason:zc(t)}))},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:!1,desiredSize:t.desiredSize,ready:null};a.sinkCapability.resolve(),a.ready=a.sinkCapability.promise,this.streamSinks[e]=a,Promise.try(o,t.data,a).then(function(){s.postMessage({sourceName:n,targetName:i,stream:Fc,streamId:e,success:!0})},function(t){s.postMessage({sourceName:n,targetName:i,stream:Fc,streamId:e,reason:zc(t)})})}#ii(t){const e=t.streamId,n=this.sourceName,i=t.sourceName,s=this.comObj,r=this.streamControllers[e],o=this.streamSinks[e];switch(t.stream){case Fc:t.success?r.startCall.resolve():r.startCall.reject(zc(t.reason));break;case Bc:t.success?r.pullCall.resolve():r.pullCall.reject(zc(t.reason));break;case Rc:if(!o){s.postMessage({sourceName:n,targetName:i,stream:Bc,streamId:e,success:!0});break}o.desiredSize<=0&&t.desiredSize>0&&o.sinkCapability.resolve(),o.desiredSize=t.desiredSize,Promise.try(o.onPull||Lc).then(function(){s.postMessage({sourceName:n,targetName:i,stream:Bc,streamId:e,success:!0})},function(t){s.postMessage({sourceName:n,targetName:i,stream:Bc,streamId:e,reason:zc(t)})});break;case Pc:if(tl(r,"enqueue should have stream controller"),r.isClosed)break;r.controller.enqueue(t.chunk);break;case Nc:if(tl(r,"close should have stream controller"),r.isClosed)break;r.isClosed=!0,r.controller.close(),this.#ri(r,e);break;case Oc:tl(r,"error should have stream controller"),r.controller.error(zc(t.reason)),this.#ri(r,e);break;case Ic:t.success?r.cancelCall.resolve():r.cancelCall.reject(zc(t.reason)),this.#ri(r,e);break;case Dc:if(!o)break;const a=zc(t.reason);Promise.try(o.onCancel||Lc,a).then(function(){s.postMessage({sourceName:n,targetName:i,stream:Ic,streamId:e,success:!0})},function(t){s.postMessage({sourceName:n,targetName:i,stream:Ic,streamId:e,reason:zc(t)})}),o.sinkCapability.reject(a),o.isCancelled=!0,delete this.streamSinks[e];break;default:throw new Error("Unexpected stream case")}}async#ri(t,e){await Promise.allSettled([t.startCall?.promise,t.pullCall?.promise,t.cancelCall?.promise]),delete this.streamControllers[e]}destroy(){this.#ei?.abort(),this.#ei=null}}class Hc{#oi=!1;constructor({enableHWA:t=!1}){this.#oi=t}create(t,e){if(t<=0||e<=0)throw new Error("Invalid canvas size");const n=this._createCanvas(t,e);return{canvas:n,context:n.getContext("2d",{willReadFrequently:!this.#oi})}}reset(t,e,n){if(!t.canvas)throw new Error("Canvas is not specified");if(e<=0||n<=0)throw new Error("Invalid canvas size");t.canvas.width=e,t.canvas.height=n}destroy(t){if(!t.canvas)throw new Error("Canvas is not specified");t.canvas.width=0,t.canvas.height=0,t.canvas=null,t.context=null}_createCanvas(t,e){Za("Abstract method `_createCanvas` called.")}}class $c extends Hc{constructor({ownerDocument:t=globalThis.document,enableHWA:e=!1}){super({enableHWA:e}),this._document=t}_createCanvas(t,e){const n=this._document.createElement("canvas");return n.width=t,n.height=e,n}}class Uc{constructor({baseUrl:t=null,isCompressed:e=!0}){this.baseUrl=t,this.isCompressed=e}async fetch({name:t}){if(!this.baseUrl)throw new Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.");if(!t)throw new Error("CMap name must be specified.");const e=this.baseUrl+t+(this.isCompressed?".bcmap":"");return this._fetch(e).then(t=>({cMapData:t,isCompressed:this.isCompressed})).catch(t=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${e}`)})}async _fetch(t){Za("Abstract method `_fetch` called.")}}class Wc extends Uc{async _fetch(t){const e=await _l(t,this.isCompressed?"arraybuffer":"text");return e instanceof ArrayBuffer?new Uint8Array(e):dl(e)}}class Gc{addFilter(t){return"none"}addHCMFilter(t,e){return"none"}addAlphaFilter(t){return"none"}addLuminosityFilter(t){return"none"}addHighlightHCMFilter(t,e,n,i,s){return"none"}destroy(t=!1){}}class jc extends Gc{#ai;#li;#ci;#hi;#di;#ui;#N=0;constructor({docId:t,ownerDocument:e=globalThis.document}){super(),this.#hi=t,this.#di=e}get#O(){return this.#li||=new Map}get#pi(){return this.#ui||=new Map}get#fi(){if(!this.#ci){const t=this.#di.createElement("div"),{style:e}=t;e.visibility="hidden",e.contain="strict",e.width=e.height=0,e.position="absolute",e.top=e.left=0,e.zIndex=-1;const n=this.#di.createElementNS(xl,"svg");n.setAttribute("width",0),n.setAttribute("height",0),this.#ci=this.#di.createElementNS(xl,"defs"),t.append(n),n.append(this.#ci),this.#di.body.append(t)}return this.#ci}#mi(t){if(1===t.length){const e=t[0],n=new Array(256);for(let t=0;t<256;t++)n[t]=e[t]/255;const i=n.join(",");return[i,i,i]}const[e,n,i]=t,s=new Array(256),r=new Array(256),o=new Array(256);for(let a=0;a<256;a++)s[a]=e[a]/255,r[a]=n[a]/255,o[a]=i[a]/255;return[s.join(","),r.join(","),o.join(",")]}#gi(t){if(void 0===this.#ai){this.#ai="";const t=this.#di.URL;t!==this.#di.baseURI&&(Cl(t)?Qa('#createUrl: ignore "data:"-URL for performance reasons.'):this.#ai=nl(t,""))}return`url(${this.#ai}#${t})`}addFilter(t){if(!t)return"none";let e=this.#O.get(t);if(e)return e;const[n,i,s]=this.#mi(t),r=1===t.length?n:`${n}${i}${s}`;if(e=this.#O.get(r),e)return this.#O.set(t,e),e;const o=`g_${this.#hi}_transfer_map_${this.#N++}`,a=this.#gi(o);this.#O.set(t,a),this.#O.set(r,a);const l=this.#yi(o);return this.#bi(n,i,s,l),a}addHCMFilter(t,e){const n=`${t}-${e}`,i="base";let s=this.#pi.get(i);if(s?.key===n)return s.url;if(s?(s.filter?.remove(),s.key=n,s.url="none",s.filter=null):(s={key:n,url:"none",filter:null},this.#pi.set(i,s)),!t||!e)return s.url;const r=this.#wi(t);t=fl.makeHexColor(...r);const o=this.#wi(e);if(e=fl.makeHexColor(...o),this.#fi.style.color="","#000000"===t&&"#ffffff"===e||t===e)return s.url;const a=new Array(256);for(let u=0;u<=255;u++){const t=u/255;a[u]=t<=.03928?t/12.92:((t+.055)/1.055)**2.4}const l=a.join(","),c=`g_${this.#hi}_hcm_filter`,h=s.filter=this.#yi(c);this.#bi(l,l,l,h),this.#vi(h);const d=(t,e)=>{const n=r[t]/255,i=o[t]/255,s=new Array(e+1);for(let r=0;r<=e;r++)s[r]=n+r/e*(i-n);return s.join(",")};return this.#bi(d(0,5),d(1,5),d(2,5),h),s.url=this.#gi(c),s.url}addAlphaFilter(t){let e=this.#O.get(t);if(e)return e;const[n]=this.#mi([t]),i=`alpha_${n}`;if(e=this.#O.get(i),e)return this.#O.set(t,e),e;const s=`g_${this.#hi}_alpha_map_${this.#N++}`,r=this.#gi(s);this.#O.set(t,r),this.#O.set(i,r);const o=this.#yi(s);return this.#Ai(n,o),r}addLuminosityFilter(t){let e,n,i=this.#O.get(t||"luminosity");if(i)return i;if(t?([e]=this.#mi([t]),n=`luminosity_${e}`):n="luminosity",i=this.#O.get(n),i)return this.#O.set(t,i),i;const s=`g_${this.#hi}_luminosity_map_${this.#N++}`,r=this.#gi(s);this.#O.set(t,r),this.#O.set(n,r);const o=this.#yi(s);return this.#xi(o),t&&this.#Ai(e,o),r}addHighlightHCMFilter(t,e,n,i,s){const r=`${e}-${n}-${i}-${s}`;let o=this.#pi.get(t);if(o?.key===r)return o.url;if(o?(o.filter?.remove(),o.key=r,o.url="none",o.filter=null):(o={key:r,url:"none",filter:null},this.#pi.set(t,o)),!e||!n)return o.url;const[a,l]=[e,n].map(this.#wi.bind(this));let c=Math.round(.2126*a[0]+.7152*a[1]+.0722*a[2]),h=Math.round(.2126*l[0]+.7152*l[1]+.0722*l[2]),[d,u]=[i,s].map(this.#wi.bind(this));h<c&&([c,h,d,u]=[h,c,u,d]),this.#fi.style.color="";const p=(t,e,n)=>{const i=new Array(256),s=(h-c)/n,r=t/255,o=(e-t)/(255*n);let a=0;for(let l=0;l<=n;l++){const t=Math.round(c+l*s),e=r+l*o;for(let n=a;n<=t;n++)i[n]=e;a=t+1}for(let l=a;l<256;l++)i[l]=i[a-1];return i.join(",")},f=`g_${this.#hi}_hcm_${t}_filter`,m=o.filter=this.#yi(f);return this.#vi(m),this.#bi(p(d[0],u[0],5),p(d[1],u[1],5),p(d[2],u[2],5),m),o.url=this.#gi(f),o.url}destroy(t=!1){t&&this.#ui?.size||(this.#ci?.parentNode.parentNode.remove(),this.#ci=null,this.#li?.clear(),this.#li=null,this.#ui?.clear(),this.#ui=null,this.#N=0)}#xi(t){const e=this.#di.createElementNS(xl,"feColorMatrix");e.setAttribute("type","matrix"),e.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0"),t.append(e)}#vi(t){const e=this.#di.createElementNS(xl,"feColorMatrix");e.setAttribute("type","matrix"),e.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"),t.append(e)}#yi(t){const e=this.#di.createElementNS(xl,"filter");return e.setAttribute("color-interpolation-filters","sRGB"),e.setAttribute("id",t),this.#fi.append(e),e}#Si(t,e,n){const i=this.#di.createElementNS(xl,e);i.setAttribute("type","discrete"),i.setAttribute("tableValues",n),t.append(i)}#bi(t,e,n,i){const s=this.#di.createElementNS(xl,"feComponentTransfer");i.append(s),this.#Si(s,"feFuncR",t),this.#Si(s,"feFuncG",e),this.#Si(s,"feFuncB",n)}#Ai(t,e){const n=this.#di.createElementNS(xl,"feComponentTransfer");e.append(n),this.#Si(n,"feFuncA",t)}#wi(t){return this.#fi.style.color=t,Ol(getComputedStyle(this.#fi).getPropertyValue("color"))}}class Kc{constructor({baseUrl:t=null}){this.baseUrl=t}async fetch({filename:t}){if(!this.baseUrl)throw new Error("Ensure that the `standardFontDataUrl` API parameter is provided.");if(!t)throw new Error("Font filename must be specified.");const e=`${this.baseUrl}${t}`;return this._fetch(e).catch(t=>{throw new Error(`Unable to load font data at: ${e}`)})}async _fetch(t){Za("Abstract method `_fetch` called.")}}class qc extends Kc{async _fetch(t){const e=await _l(t,"arraybuffer");return new Uint8Array(e)}}class Yc{constructor({baseUrl:t=null}){this.baseUrl=t}async fetch({filename:t}){if(!this.baseUrl)throw new Error("Ensure that the `wasmUrl` API parameter is provided.");if(!t)throw new Error("Wasm filename must be specified.");const e=`${this.baseUrl}${t}`;return this._fetch(e).catch(t=>{throw new Error(`Unable to load wasm data at: ${e}`)})}async _fetch(t){Za("Abstract method `_fetch` called.")}}class Xc extends Yc{async _fetch(t){const e=await _l(t,"arraybuffer");return new Uint8Array(e)}}async function Jc(t){const e=process.getBuiltinModule("fs"),n=await e.promises.readFile(t);return new Uint8Array(n)}ua&&Qa("Please use the `legacy` build in Node.js environments.");class Qc extends Gc{}class Zc extends Hc{_createCanvas(t,e){return process.getBuiltinModule("module").createRequire(import.meta.url)("@napi-rs/canvas").createCanvas(t,e)}}class th extends Uc{async _fetch(t){return Jc(t)}}class eh extends Kc{async _fetch(t){return Jc(t)}}class nh extends Yc{async _fetch(t){return Jc(t)}}const ih="__forcedDependency",{floor:sh,ceil:rh}=Math;function oh(t,e,n,i,s,r){t[4*e+0]=Math.min(t[4*e+0],n),t[4*e+1]=Math.min(t[4*e+1],i),t[4*e+2]=Math.max(t[4*e+2],s),t[4*e+3]=Math.max(t[4*e+3],r)}const ah=new Uint32Array(new Uint8Array([255,255,0,0]).buffer)[0];class lh{#_i;#Ti;constructor(t,e){this.#_i=t,this.#Ti=e}get length(){return this.#_i.length}isEmpty(t){return this.#_i[t]===ah}minX(t){return this.#Ti[4*t+0]/256}minY(t){return this.#Ti[4*t+1]/256}maxX(t){return(this.#Ti[4*t+2]+1)/256}maxY(t){return(this.#Ti[4*t+3]+1)/256}}const ch=(t,e)=>{if(!t)return;let n=t.get(e);return n||(n={dependencies:new Set,isRenderingOperation:!1},t.set(e,n)),n};class hh{#Ei={__proto__:null};#Ci={__proto__:null,transform:[],moveText:[],sameLineText:[],[ih]:[]};#Mi=new Map;#ki=[];#Di=[];#Ii=[[1,0,0,1,0,0]];#Ni=[-1/0,-1/0,1/0,1/0];#Pi=new Float64Array([1/0,1/0,-1/0,-1/0]);#Oi=-1;#Ri=new Set;#Bi=new Map;#Fi=new Map;#Li;#zi;#Vi;#_i;#Hi;constructor(t,e,n=!1){this.#Li=t.width,this.#zi=t.height,this.#$i(e),n&&(this.#Hi=new Map)}growOperationsCount(t){t>=this.#_i.length&&this.#$i(t,this.#_i)}#$i(t,e){const n=new ArrayBuffer(4*t);this.#Vi=new Uint8ClampedArray(n),this.#_i=new Uint32Array(n),e&&e.length>0?(this.#_i.set(e),this.#_i.fill(ah,e.length)):this.#_i.fill(ah)}save(t){return this.#Ei={__proto__:this.#Ei},this.#Ci={__proto__:this.#Ci,transform:{__proto__:this.#Ci.transform},moveText:{__proto__:this.#Ci.moveText},sameLineText:{__proto__:this.#Ci.sameLineText},[ih]:{__proto__:this.#Ci[ih]}},this.#Ni={__proto__:this.#Ni},this.#ki.push(t),this}restore(t){const e=Object.getPrototypeOf(this.#Ei);if(null===e)return this;this.#Ei=e,this.#Ci=Object.getPrototypeOf(this.#Ci),this.#Ni=Object.getPrototypeOf(this.#Ni);const n=this.#ki.pop();return void 0!==n&&(ch(this.#Hi,t)?.dependencies.add(n),this.#_i[t]=this.#_i[n]),this}recordOpenMarker(t){return this.#ki.push(t),this}getOpenMarker(){return 0===this.#ki.length?null:this.#ki.at(-1)}recordCloseMarker(t){const e=this.#ki.pop();return void 0!==e&&(ch(this.#Hi,t)?.dependencies.add(e),this.#_i[t]=this.#_i[e]),this}beginMarkedContent(t){return this.#Di.push(t),this}endMarkedContent(t){const e=this.#Di.pop();return void 0!==e&&(ch(this.#Hi,t)?.dependencies.add(e),this.#_i[t]=this.#_i[e]),this}pushBaseTransform(t){return this.#Ii.push(fl.multiplyByDOMMatrix(this.#Ii.at(-1),t.getTransform())),this}popBaseTransform(){return this.#Ii.length>1&&this.#Ii.pop(),this}recordSimpleData(t,e){return this.#Ei[t]=e,this}recordIncrementalData(t,e){return this.#Ci[t].push(e),this}resetIncrementalData(t,e){return this.#Ci[t].length=0,this}recordNamedData(t,e){return this.#Mi.set(t,e),this}recordSimpleDataFromNamed(t,e,n){this.#Ei[t]=this.#Mi.get(e)??n}recordFutureForcedDependency(t,e){return this.recordIncrementalData(ih,e),this}inheritSimpleDataAsFutureForcedDependencies(t){for(const e of t)e in this.#Ei&&this.recordFutureForcedDependency(e,this.#Ei[e]);return this}inheritPendingDependenciesAsFutureForcedDependencies(){for(const t of this.#Ri)this.recordFutureForcedDependency(ih,t);return this}resetBBox(t){return this.#Oi!==t&&(this.#Oi=t,this.#Pi[0]=1/0,this.#Pi[1]=1/0,this.#Pi[2]=-1/0,this.#Pi[3]=-1/0),this}recordClipBox(t,e,n,i,s,r){const o=fl.multiplyByDOMMatrix(this.#Ii.at(-1),e.getTransform()),a=[1/0,1/0,-1/0,-1/0];fl.axialAlignedBoundingBox([n,s,i,r],o,a);const l=fl.intersect(this.#Ni,a);return l?(this.#Ni[0]=l[0],this.#Ni[1]=l[1],this.#Ni[2]=l[2],this.#Ni[3]=l[3]):(this.#Ni[0]=this.#Ni[1]=1/0,this.#Ni[2]=this.#Ni[3]=-1/0),this}recordBBox(t,e,n,i,s,r){const o=this.#Ni;if(o[0]===1/0)return this;const a=fl.multiplyByDOMMatrix(this.#Ii.at(-1),e.getTransform());if(o[0]===-1/0)return fl.axialAlignedBoundingBox([n,s,i,r],a,this.#Pi),this;const l=[1/0,1/0,-1/0,-1/0];return fl.axialAlignedBoundingBox([n,s,i,r],a,l),this.#Pi[0]=Math.min(this.#Pi[0],Math.max(l[0],o[0])),this.#Pi[1]=Math.min(this.#Pi[1],Math.max(l[1],o[1])),this.#Pi[2]=Math.max(this.#Pi[2],Math.min(l[2],o[2])),this.#Pi[3]=Math.max(this.#Pi[3],Math.min(l[3],o[3])),this}recordCharacterBBox(t,e,n,i=1,s=0,r=0,o){const a=n.bbox;let l,c;if(a&&(l=a[2]!==a[0]&&a[3]!==a[1]&&this.#Fi.get(n),!1!==l&&(c=[0,0,0,0],fl.axialAlignedBoundingBox(a,n.fontMatrix,c),1===i&&0===s&&0===r||fl.scaleMinMax([i,0,0,-i,s,r],c),l)))return this.recordBBox(t,e,c[0],c[2],c[1],c[3]);if(!o)return this.recordFullPageBBox(t);const h=o();return a&&c&&void 0===l&&(l=c[0]<=s-h.actualBoundingBoxLeft&&c[2]>=s+h.actualBoundingBoxRight&&c[1]<=r-h.actualBoundingBoxAscent&&c[3]>=r+h.actualBoundingBoxDescent,this.#Fi.set(n,l),l)?this.recordBBox(t,e,c[0],c[2],c[1],c[3]):this.recordBBox(t,e,s-h.actualBoundingBoxLeft,s+h.actualBoundingBoxRight,r-h.actualBoundingBoxAscent,r+h.actualBoundingBoxDescent)}recordFullPageBBox(t){return this.#Pi[0]=Math.max(0,this.#Ni[0]),this.#Pi[1]=Math.max(0,this.#Ni[1]),this.#Pi[2]=Math.min(this.#Li,this.#Ni[2]),this.#Pi[3]=Math.min(this.#zi,this.#Ni[3]),this}getSimpleIndex(t){return this.#Ei[t]}recordDependencies(t,e){const n=this.#Ri,i=this.#Ei,s=this.#Ci;for(const r of e)r in this.#Ei?n.add(i[r]):r in s&&s[r].forEach(n.add,n);return this}recordNamedDependency(t,e){return this.#Mi.has(e)&&this.#Ri.add(this.#Mi.get(e)),this}recordOperation(t,e=!1){if(this.recordDependencies(t,[ih]),this.#Hi){const e=ch(this.#Hi,t),{dependencies:n}=e;this.#Ri.forEach(n.add,n),this.#ki.forEach(n.add,n),this.#Di.forEach(n.add,n),n.delete(t),e.isRenderingOperation=!0}if(this.#Oi===t){const n=sh(256*this.#Pi[0]/this.#Li),i=sh(256*this.#Pi[1]/this.#zi),s=rh(256*this.#Pi[2]/this.#Li),r=rh(256*this.#Pi[3]/this.#zi);oh(this.#Vi,t,n,i,s,r);for(const e of this.#Ri)e!==t&&oh(this.#Vi,e,n,i,s,r);for(const e of this.#ki)e!==t&&oh(this.#Vi,e,n,i,s,r);for(const e of this.#Di)e!==t&&oh(this.#Vi,e,n,i,s,r);e||(this.#Ri.clear(),this.#Oi=-1)}return this}recordShowTextOperation(t,e=!1){const n=Array.from(this.#Ri);this.recordOperation(t,e),this.recordIncrementalData("sameLineText",t);for(const i of n)this.recordIncrementalData("sameLineText",i);return this}bboxToClipBoxDropOperation(t,e=!1){return this.#Oi===t&&(this.#Oi=-1,this.#Ni[0]=Math.max(this.#Ni[0],this.#Pi[0]),this.#Ni[1]=Math.max(this.#Ni[1],this.#Pi[1]),this.#Ni[2]=Math.min(this.#Ni[2],this.#Pi[2]),this.#Ni[3]=Math.min(this.#Ni[3],this.#Pi[3]),e||this.#Ri.clear()),this}_takePendingDependencies(){const t=this.#Ri;return this.#Ri=new Set,t}_extractOperation(t){const e=this.#Bi.get(t);return this.#Bi.delete(t),e}_pushPendingDependencies(t){for(const e of t)this.#Ri.add(e)}take(){return this.#Fi.clear(),new lh(this.#_i,this.#Vi)}takeDebugMetadata(){return this.#Hi}}class dh{#Ui;#Wi;#Gi;#ji=0;#Ki=0;constructor(t,e,n){if(t instanceof dh&&t.#Gi===!!n)return t;this.#Ui=t,this.#Wi=e,this.#Gi=!!n}growOperationsCount(){throw new Error("Unreachable")}save(t){return this.#Ki++,this.#Ui.save(this.#Wi),this}restore(t){return this.#Ki>0&&(this.#Ui.restore(this.#Wi),this.#Ki--),this}recordOpenMarker(t){return this.#ji++,this}getOpenMarker(){return this.#ji>0?this.#Wi:this.#Ui.getOpenMarker()}recordCloseMarker(t){return this.#ji--,this}beginMarkedContent(t){return this}endMarkedContent(t){return this}pushBaseTransform(t){return this.#Ui.pushBaseTransform(t),this}popBaseTransform(){return this.#Ui.popBaseTransform(),this}recordSimpleData(t,e){return this.#Ui.recordSimpleData(t,this.#Wi),this}recordIncrementalData(t,e){return this.#Ui.recordIncrementalData(t,this.#Wi),this}resetIncrementalData(t,e){return this.#Ui.resetIncrementalData(t,this.#Wi),this}recordNamedData(t,e){return this}recordSimpleDataFromNamed(t,e,n){return this.#Ui.recordSimpleDataFromNamed(t,e,this.#Wi),this}recordFutureForcedDependency(t,e){return this.#Ui.recordFutureForcedDependency(t,this.#Wi),this}inheritSimpleDataAsFutureForcedDependencies(t){return this.#Ui.inheritSimpleDataAsFutureForcedDependencies(t),this}inheritPendingDependenciesAsFutureForcedDependencies(){return this.#Ui.inheritPendingDependenciesAsFutureForcedDependencies(),this}resetBBox(t){return this.#Gi||this.#Ui.resetBBox(this.#Wi),this}recordClipBox(t,e,n,i,s,r){return this.#Gi||this.#Ui.recordClipBox(this.#Wi,e,n,i,s,r),this}recordBBox(t,e,n,i,s,r){return this.#Gi||this.#Ui.recordBBox(this.#Wi,e,n,i,s,r),this}recordCharacterBBox(t,e,n,i,s,r,o){return this.#Gi||this.#Ui.recordCharacterBBox(this.#Wi,e,n,i,s,r,o),this}recordFullPageBBox(t){return this.#Gi||this.#Ui.recordFullPageBBox(this.#Wi),this}getSimpleIndex(t){return this.#Ui.getSimpleIndex(t)}recordDependencies(t,e){return this.#Ui.recordDependencies(this.#Wi,e),this}recordNamedDependency(t,e){return this.#Ui.recordNamedDependency(this.#Wi,e),this}recordOperation(t){return this.#Ui.recordOperation(this.#Wi,!0),this}recordShowTextOperation(t){return this.#Ui.recordShowTextOperation(this.#Wi,!0),this}bboxToClipBoxDropOperation(t){return this.#Gi||this.#Ui.bboxToClipBoxDropOperation(this.#Wi,!0),this}take(){throw new Error("Unreachable")}takeDebugMetadata(){throw new Error("Unreachable")}}const uh=["path","transform","filter","strokeColor","strokeAlpha","lineWidth","lineCap","lineJoin","miterLimit","dash"],ph=["path","transform","filter","fillColor","fillAlpha","globalCompositeOperation","SMask"],fh=["transform","SMask","filter","fillAlpha","strokeAlpha","globalCompositeOperation"],mh=["filter","fillColor","fillAlpha"],gh=["transform","leading","charSpacing","wordSpacing","hScale","textRise","moveText","textMatrix","font","fontObj","filter","fillColor","textRenderingMode","SMask","fillAlpha","strokeAlpha","globalCompositeOperation","sameLineText"],yh=["transform"],bh=["transform","fillColor"],wh="Fill",vh="Stroke",Ah="Shading";function xh(t,e){if(!e)return;const n=e[2]-e[0],i=e[3]-e[1],s=new Path2D;s.rect(e[0],e[1],n,i),t.clip(s)}class Sh{isModifyingCurrentTransform(){return!1}getPattern(){Za("Abstract method `getPattern` called.")}}class _h extends Sh{constructor(t){super(),this._type=t[1],this._bbox=t[2],this._colorStops=t[3],this._p0=t[4],this._p1=t[5],this._r0=t[6],this._r1=t[7],this.matrix=null}isOriginBased(){return 0===this._p0[0]&&0===this._p0[1]&&(!this.isRadial()||0===this._p1[0]&&0===this._p1[1])}isRadial(){return"radial"===this._type}_createGradient(t,e=null){let n,i=this._p0,s=this._p1;if(e&&(i=i.slice(),s=s.slice(),fl.applyTransform(i,e),fl.applyTransform(s,e)),"axial"===this._type)n=t.createLinearGradient(i[0],i[1],s[0],s[1]);else if("radial"===this._type){let r=this._r0,o=this._r1;if(e){const t=new Float32Array(2);fl.singularValueDecompose2dScale(e,t),r*=t[0],o*=t[0]}n=t.createRadialGradient(i[0],i[1],r,s[0],s[1],o)}for(const r of this._colorStops)n.addColorStop(r[0],r[1]);return n}getPattern(t,e,n,i){let s;if(i===vh||i===wh){if(this.isOriginBased()){let i=fl.transform(n,e.baseTransform);this.matrix&&(i=fl.transform(i,this.matrix));const s=.001,r=Math.hypot(i[0],i[1]),o=Math.hypot(i[2],i[3]),a=(i[0]*i[2]+i[1]*i[3])/(r*o);if(Math.abs(a)<s){if(!this.isRadial())return this._createGradient(t,i);if(Math.abs(r-o)<s)return this._createGradient(t,i)}}const r=e.current.getClippedPathBoundingBox(i,Rl(t))||[0,0,0,0],o=Math.ceil(r[2]-r[0])||1,a=Math.ceil(r[3]-r[1])||1,l=e.cachedCanvases.getCanvas("pattern",o,a),c=l.context;c.clearRect(0,0,c.canvas.width,c.canvas.height),c.beginPath(),c.rect(0,0,c.canvas.width,c.canvas.height),c.translate(-r[0],-r[1]),n=fl.transform(n,[1,0,0,1,r[0],r[1]]),c.transform(...e.baseTransform),this.matrix&&c.transform(...this.matrix),xh(c,this._bbox),c.fillStyle=this._createGradient(c),c.fill(),s=t.createPattern(l.canvas,"no-repeat");const h=new DOMMatrix(n);s.setTransform(h)}else xh(t,this._bbox),s=this._createGradient(t);return s}}function Th(t,e,n,i,s,r,o,a){const l=e.coords,c=e.colors,h=t.data,d=4*t.width;let u;l[n+1]>l[i+1]&&(u=n,n=i,i=u,u=r,r=o,o=u),l[i+1]>l[s+1]&&(u=i,i=s,s=u,u=o,o=a,a=u),l[n+1]>l[i+1]&&(u=n,n=i,i=u,u=r,r=o,o=u);const p=(l[n]+e.offsetX)*e.scaleX,f=(l[n+1]+e.offsetY)*e.scaleY,m=(l[i]+e.offsetX)*e.scaleX,g=(l[i+1]+e.offsetY)*e.scaleY,y=(l[s]+e.offsetX)*e.scaleX,b=(l[s+1]+e.offsetY)*e.scaleY;if(f>=b)return;const w=c[r],v=c[r+1],A=c[r+2],x=c[o],S=c[o+1],_=c[o+2],T=c[a],E=c[a+1],C=c[a+2],M=Math.round(f),k=Math.round(b);let D,I,N,P,O,R,B,F;for(let L=M;L<=k;L++){if(L<g){const t=L<f?0:(f-L)/(f-g);D=p-(p-m)*t,I=w-(w-x)*t,N=v-(v-S)*t,P=A-(A-_)*t}else{let t;t=L>b?1:g===b?0:(g-L)/(g-b),D=m-(m-y)*t,I=x-(x-T)*t,N=S-(S-E)*t,P=_-(_-C)*t}let t;t=L<f?0:L>b?1:(f-L)/(f-b),O=p-(p-y)*t,R=w-(w-T)*t,B=v-(v-E)*t,F=A-(A-C)*t;const e=Math.round(Math.min(D,O)),n=Math.round(Math.max(D,O));let i=d*L+4*e;for(let s=e;s<=n;s++)t=(D-s)/(D-O),t<0?t=0:t>1&&(t=1),h[i++]=I-(I-R)*t|0,h[i++]=N-(N-B)*t|0,h[i++]=P-(P-F)*t|0,h[i++]=255}}function Eh(t,e,n){const i=e.coords,s=e.colors;let r,o;switch(e.type){case Ma:const a=e.verticesPerRow,l=Math.floor(i.length/a)-1,c=a-1;for(r=0;r<l;r++){let e=r*a;for(let r=0;r<c;r++,e++)Th(t,n,i[e],i[e+1],i[e+a],s[e],s[e+1],s[e+a]),Th(t,n,i[e+a+1],i[e+1],i[e+a],s[e+a+1],s[e+1],s[e+a])}break;case Ca:for(r=0,o=i.length;r<o;r+=3)Th(t,n,i[r],i[r+1],i[r+2],s[r],s[r+1],s[r+2]);break;default:throw new Error("illegal figure")}}class Ch extends Sh{constructor(t){super(),this._coords=t[2],this._colors=t[3],this._figures=t[4],this._bounds=t[5],this._bbox=t[6],this._background=t[7],this.matrix=null}_createMeshCanvas(t,e,n){const i=Math.floor(this._bounds[0]),s=Math.floor(this._bounds[1]),r=Math.ceil(this._bounds[2])-i,o=Math.ceil(this._bounds[3])-s,a=Math.min(Math.ceil(Math.abs(r*t[0]*1.1)),3e3),l=Math.min(Math.ceil(Math.abs(o*t[1]*1.1)),3e3),c=r/a,h=o/l,d={coords:this._coords,colors:this._colors,offsetX:-i,offsetY:-s,scaleX:1/c,scaleY:1/h},u=a+4,p=l+4,f=n.getCanvas("mesh",u,p),m=f.context,g=m.createImageData(a,l);if(e){const t=g.data;for(let n=0,i=t.length;n<i;n+=4)t[n]=e[0],t[n+1]=e[1],t[n+2]=e[2],t[n+3]=255}for(const y of this._figures)Eh(g,y,d);m.putImageData(g,2,2);return{canvas:f.canvas,offsetX:i-2*c,offsetY:s-2*h,scaleX:c,scaleY:h}}isModifyingCurrentTransform(){return!0}getPattern(t,e,n,i){xh(t,this._bbox);const s=new Float32Array(2);if(i===Ah)fl.singularValueDecompose2dScale(Rl(t),s);else if(this.matrix){fl.singularValueDecompose2dScale(this.matrix,s);const[t,n]=s;fl.singularValueDecompose2dScale(e.baseTransform,s),s[0]*=t,s[1]*=n}else fl.singularValueDecompose2dScale(e.baseTransform,s);const r=this._createMeshCanvas(s,i===Ah?null:this._background,e.cachedCanvases);return i!==Ah&&(t.setTransform(...e.baseTransform),this.matrix&&t.transform(...this.matrix)),t.translate(r.offsetX,r.offsetY),t.scale(r.scaleX,r.scaleY),t.createPattern(r.canvas,"no-repeat")}}class Mh extends Sh{getPattern(){return"hotpink"}}const kh=1,Dh=2;class Ih{static MAX_PATTERN_SIZE=3e3;constructor(t,e,n,i){this.color=t[1],this.operatorList=t[2],this.matrix=t[3],this.bbox=t[4],this.xstep=t[5],this.ystep=t[6],this.paintType=t[7],this.tilingType=t[8],this.ctx=e,this.canvasGraphicsFactory=n,this.baseTransform=i}createPatternCanvas(t,e){const{bbox:n,operatorList:i,paintType:s,tilingType:r,color:o,canvasGraphicsFactory:a}=this;let{xstep:l,ystep:c}=this;l=Math.abs(l),c=Math.abs(c),Ja("TilingType: "+r);const h=n[0],d=n[1],u=n[2],p=n[3],f=u-h,m=p-d,g=new Float32Array(2);fl.singularValueDecompose2dScale(this.matrix,g);const[y,b]=g;fl.singularValueDecompose2dScale(this.baseTransform,g);const w=y*g[0],v=b*g[1];let A=f,x=m,S=!1,_=!1;const T=Math.ceil(l*w),E=Math.ceil(c*v);T>=Math.ceil(f*w)?A=l:S=!0,E>=Math.ceil(m*v)?x=c:_=!0;const C=this.getSizeAndScale(A,this.ctx.canvas.width,w),M=this.getSizeAndScale(x,this.ctx.canvas.height,v),k=t.cachedCanvases.getCanvas("pattern",C.size,M.size),D=k.context,I=a.createCanvasGraphics(D,e);if(I.groupLevel=t.groupLevel,this.setFillAndStrokeStyleToContext(I,s,o),D.translate(-C.scale*h,-M.scale*d),I.transform(0,C.scale,0,0,M.scale,0,0),D.save(),I.dependencyTracker?.save(),this.clipBbox(I,h,d,u,p),I.baseTransform=Rl(I.ctx),I.executeOperatorList(i),I.endDrawing(),I.dependencyTracker?.restore(),D.restore(),S||_){const e=k.canvas;S&&(A=l),_&&(x=c);const n=this.getSizeAndScale(A,this.ctx.canvas.width,w),i=this.getSizeAndScale(x,this.ctx.canvas.height,v),s=n.size,r=i.size,o=t.cachedCanvases.getCanvas("pattern-workaround",s,r),a=o.context,u=S?Math.floor(f/l):0,p=_?Math.floor(m/c):0;for(let t=0;t<=u;t++)for(let n=0;n<=p;n++)a.drawImage(e,s*t,r*n,s,r,0,0,s,r);return{canvas:o.canvas,scaleX:n.scale,scaleY:i.scale,offsetX:h,offsetY:d}}return{canvas:k.canvas,scaleX:C.scale,scaleY:M.scale,offsetX:h,offsetY:d}}getSizeAndScale(t,e,n){const i=Math.max(Ih.MAX_PATTERN_SIZE,e);let s=Math.ceil(t*n);return s>=i?s=i:n=s/t,{scale:n,size:s}}clipBbox(t,e,n,i,s){const r=i-e,o=s-n;t.ctx.rect(e,n,r,o),fl.axialAlignedBoundingBox([e,n,i,s],Rl(t.ctx),t.current.minMax),t.clip(),t.endPath()}setFillAndStrokeStyleToContext(t,e,n){const i=t.ctx,s=t.current;switch(e){case kh:const{fillStyle:t,strokeStyle:r}=this.ctx;i.fillStyle=s.fillColor=t,i.strokeStyle=s.strokeColor=r;break;case Dh:i.fillStyle=i.strokeStyle=n,s.fillColor=s.strokeColor=n;break;default:throw new cl(`Unsupported paint type: ${e}`)}}isModifyingCurrentTransform(){return!1}getPattern(t,e,n,i,s){let r=n;i!==Ah&&(r=fl.transform(r,e.baseTransform),this.matrix&&(r=fl.transform(r,this.matrix)));const o=this.createPatternCanvas(e,s);let a=new DOMMatrix(r);a=a.translate(o.offsetX,o.offsetY),a=a.scale(1/o.scaleX,1/o.scaleY);const l=t.createPattern(o.canvas,"repeat");return l.setTransform(a),l}}function Nh({src:t,srcPos:e=0,dest:n,width:i,height:s,nonBlackColor:r=4294967295,inverseDecode:o=!1}){const a=ul.isLittleEndian?4278190080:255,[l,c]=o?[r,a]:[a,r],h=i>>3,d=7&i,u=t.length;n=new Uint32Array(n.buffer);let p=0;for(let f=0;f<s;f++){for(const s=e+h;e<s;e++){const i=e<u?t[e]:255;n[p++]=128&i?c:l,n[p++]=64&i?c:l,n[p++]=32&i?c:l,n[p++]=16&i?c:l,n[p++]=8&i?c:l,n[p++]=4&i?c:l,n[p++]=2&i?c:l,n[p++]=1&i?c:l}if(0===d)continue;const i=e<u?t[e++]:255;for(let t=0;t<d;t++)n[p++]=i&1<<7-t?c:l}return{srcPos:e,destPos:p}}const Ph=16,Oh=new DOMMatrix,Rh=new Float32Array(2),Bh=new Float32Array([1/0,1/0,-1/0,-1/0]);class Fh{constructor(t){this.canvasFactory=t,this.cache=Object.create(null)}getCanvas(t,e,n){let i;return void 0!==this.cache[t]?(i=this.cache[t],this.canvasFactory.reset(i,e,n)):(i=this.canvasFactory.create(e,n),this.cache[t]=i),i}delete(t){delete this.cache[t]}clear(){for(const t in this.cache){const e=this.cache[t];this.canvasFactory.destroy(e),delete this.cache[t]}}}function Lh(t,e,n,i,s,r,o,a,l,c){const[h,d,u,p,f,m]=Rl(t);if(0===d&&0===u){const g=o*h+f,y=Math.round(g),b=a*p+m,w=Math.round(b),v=(o+l)*h+f,A=Math.abs(Math.round(v)-y)||1,x=(a+c)*p+m,S=Math.abs(Math.round(x)-w)||1;return t.setTransform(Math.sign(h),0,0,Math.sign(p),y,w),t.drawImage(e,n,i,s,r,0,0,A,S),t.setTransform(h,d,u,p,f,m),[A,S]}if(0===h&&0===p){const g=a*u+f,y=Math.round(g),b=o*d+m,w=Math.round(b),v=(a+c)*u+f,A=Math.abs(Math.round(v)-y)||1,x=(o+l)*d+m,S=Math.abs(Math.round(x)-w)||1;return t.setTransform(0,Math.sign(d),Math.sign(u),0,y,w),t.drawImage(e,n,i,s,r,0,0,S,A),t.setTransform(h,d,u,p,f,m),[S,A]}t.drawImage(e,n,i,s,r,o,a,l,c);return[Math.hypot(h,d)*l,Math.hypot(u,p)*c]}class zh{alphaIsShape=!1;fontSize=0;fontSizeScale=1;textMatrix=null;textMatrixScale=1;fontMatrix=pa;leading=0;x=0;y=0;lineX=0;lineY=0;charSpacing=0;wordSpacing=0;textHScale=1;textRenderingMode=ka;textRise=0;fillColor="#000000";strokeColor="#000000";patternFill=!1;patternStroke=!1;fillAlpha=1;strokeAlpha=1;lineWidth=1;activeSMask=null;transferMaps="none";constructor(t,e,n){n?.(this),this.clipBox=new Float32Array([0,0,t,e]),this.minMax=Bh.slice()}clone(){const t=Object.create(this);return t.clipBox=this.clipBox.slice(),t.minMax=this.minMax.slice(),t}getPathBoundingBox(t=wh,e=null){const n=this.minMax.slice();if(t===vh){e||Za("Stroke bounding box must include transform."),fl.singularValueDecompose2dScale(e,Rh);const t=Rh[0]*this.lineWidth/2,i=Rh[1]*this.lineWidth/2;n[0]-=t,n[1]-=i,n[2]+=t,n[3]+=i}return n}updateClipFromPath(){const t=fl.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(t||[0,0,0,0])}isEmptyClip(){return this.minMax[0]===1/0}startNewPathAndClipBox(t){this.clipBox.set(t,0),this.minMax.set(Bh,0)}getClippedPathBoundingBox(t=wh,e=null){return fl.intersect(this.clipBox,this.getPathBoundingBox(t,e))}}function Vh(t,e){if(e instanceof ImageData)return void t.putImageData(e,0,0);const n=e.height,i=e.width,s=n%Ph,r=(n-s)/Ph,o=0===s?r:r+1,a=t.createImageData(i,Ph);let l,c=0;const h=e.data,d=a.data;let u,p,f,m;if(e.kind===Ra.GRAYSCALE_1BPP){const e=h.byteLength,n=new Uint32Array(d.buffer,0,d.byteLength>>2),m=n.length,g=i+7>>3,y=4294967295,b=ul.isLittleEndian?4278190080:255;for(u=0;u<o;u++){for(f=u<r?Ph:s,l=0,p=0;p<f;p++){const t=e-c;let s=0;const r=t>g?i:8*t-7,o=-8&r;let a=0,d=0;for(;s<o;s+=8)d=h[c++],n[l++]=128&d?y:b,n[l++]=64&d?y:b,n[l++]=32&d?y:b,n[l++]=16&d?y:b,n[l++]=8&d?y:b,n[l++]=4&d?y:b,n[l++]=2&d?y:b,n[l++]=1&d?y:b;for(;s<r;s++)0===a&&(d=h[c++],a=128),n[l++]=d&a?y:b,a>>=1}for(;l<m;)n[l++]=0;t.putImageData(a,0,u*Ph)}}else if(e.kind===Ra.RGBA_32BPP){for(p=0,m=i*Ph*4,u=0;u<r;u++)d.set(h.subarray(c,c+m)),c+=m,t.putImageData(a,0,p),p+=Ph;u<o&&(m=i*s*4,d.set(h.subarray(c,c+m)),t.putImageData(a,0,p))}else{if(e.kind!==Ra.RGB_24BPP)throw new Error(`bad image kind: ${e.kind}`);for(f=Ph,m=i*f,u=0;u<o;u++){for(u>=r&&(f=s,m=i*f),l=0,p=m;p--;)d[l++]=h[c++],d[l++]=h[c++],d[l++]=h[c++],d[l++]=255;t.putImageData(a,0,u*Ph)}}}function Hh(t,e){if(e.bitmap)return void t.drawImage(e.bitmap,0,0);const n=e.height,i=e.width,s=n%Ph,r=(n-s)/Ph,o=0===s?r:r+1,a=t.createImageData(i,Ph);let l=0;const c=e.data,h=a.data;for(let d=0;d<o;d++){const e=d<r?Ph:s;({srcPos:l}=Nh({src:c,srcPos:l,dest:h,width:i,height:e,nonBlackColor:0})),t.putImageData(a,0,d*Ph)}}function $h(t,e){const n=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const i of n)void 0!==t[i]&&(e[i]=t[i]);void 0!==t.setLineDash&&(e.setLineDash(t.getLineDash()),e.lineDashOffset=t.lineDashOffset)}function Uh(t){t.strokeStyle=t.fillStyle="#000000",t.fillRule="nonzero",t.globalAlpha=1,t.lineWidth=1,t.lineCap="butt",t.lineJoin="miter",t.miterLimit=10,t.globalCompositeOperation="source-over",t.font="10px sans-serif",void 0!==t.setLineDash&&(t.setLineDash([]),t.lineDashOffset=0);const{filter:e}=t;"none"!==e&&""!==e&&(t.filter="none")}function Wh(t,e){if(e)return!0;fl.singularValueDecompose2dScale(t,Rh);const n=Math.fround(Ll.pixelRatio*Sl.PDF_TO_CSS_UNITS);return Rh[0]<=n&&Rh[1]<=n}const Gh=["butt","round","square"],jh=["miter","round","bevel"],Kh={},qh={};class Yh{constructor(t,e,n,i,s,{optionalContentConfig:r,markedContentStack:o=null},a,l,c){this.ctx=t,this.current=new zh(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=e,this.objs=n,this.canvasFactory=i,this.filterFactory=s,this.groupStack=[],this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=o||[],this.optionalContentConfig=r,this.cachedCanvases=new Fh(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=a,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=l,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map,this.dependencyTracker=c??null}getObject(t,e,n=null){return"string"==typeof e?(this.dependencyTracker?.recordNamedDependency(t,e),e.startsWith("g_")?this.commonObjs.get(e):this.objs.get(e)):n}beginDrawing({transform:t,viewport:e,transparency:n=!1,background:i=null}){const s=this.ctx.canvas.width,r=this.ctx.canvas.height,o=this.ctx.fillStyle;if(this.ctx.fillStyle=i||"#ffffff",this.ctx.fillRect(0,0,s,r),this.ctx.fillStyle=o,n){const t=this.cachedCanvases.getCanvas("transparent",s,r);this.compositeCtx=this.ctx,this.transparentCanvas=t.canvas,this.ctx=t.context,this.ctx.save(),this.ctx.transform(...Rl(this.compositeCtx))}this.ctx.save(),Uh(this.ctx),t&&(this.ctx.transform(...t),this.outputScaleX=t[0],this.outputScaleY=t[0]),this.ctx.transform(...e.transform),this.viewportScale=e.scale,this.baseTransform=Rl(this.ctx)}executeOperatorList(t,e,n,i,s){const r=t.argsArray,o=t.fnArray;let a=e||0;const l=r.length;if(l===a)return a;const c=l-a>10&&"function"==typeof n,h=c?Date.now()+15:0;let d=0;const u=this.commonObjs,p=this.objs;let f,m;for(;;){if(void 0!==i&&a===i.nextBreakPoint)return i.breakIt(a,n),a;if(!s||s(a))if(f=o[a],m=r[a]??null,f!==Ua.dependency)null===m?this[f](a):this[f](a,...m);else for(const t of m){this.dependencyTracker?.recordNamedData(t,a);const e=t.startsWith("g_")?u:p;if(!e.has(t))return e.get(t,n),a}if(a++,a===l)return a;if(c&&++d>10){if(Date.now()>h)return n(),a;d=0}}}#qi(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.current.activeSMask=null,this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null)}endDrawing(){this.#qi(),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(const t of this._cachedBitmapsMap.values()){for(const e of t.values())"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement&&(e.width=e.height=0);t.clear()}this._cachedBitmapsMap.clear(),this.#Yi()}#Yi(){if(this.pageColors){const t=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if("none"!==t){const e=this.ctx.filter;this.ctx.filter=t,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=e}}}_scaleImage(t,e){const n=t.width??t.displayWidth,i=t.height??t.displayHeight;let s,r,o=Math.max(Math.hypot(e[0],e[1]),1),a=Math.max(Math.hypot(e[2],e[3]),1),l=n,c=i,h="prescale1";for(;o>2&&l>1||a>2&&c>1;){let e=l,n=c;o>2&&l>1&&(e=l>=16384?Math.floor(l/2)-1||1:Math.ceil(l/2),o/=l/e),a>2&&c>1&&(n=c>=16384?Math.floor(c/2)-1||1:Math.ceil(c)/2,a/=c/n),s=this.cachedCanvases.getCanvas(h,e,n),r=s.context,r.clearRect(0,0,e,n),r.drawImage(t,0,0,l,c,0,0,e,n),t=s.canvas,l=e,c=n,h="prescale1"===h?"prescale2":"prescale1"}return{img:t,paintWidth:l,paintHeight:c}}_createMaskCanvas(t,e){const n=this.ctx,{width:i,height:s}=e,r=this.current.fillColor,o=this.current.patternFill,a=Rl(n);let l,c,h,d;if((e.bitmap||e.data)&&e.count>1){const n=e.bitmap||e.data.buffer;c=JSON.stringify(o?a:[a.slice(0,4),r]),l=this._cachedBitmapsMap.get(n),l||(l=new Map,this._cachedBitmapsMap.set(n,l));const i=l.get(c);if(i&&!o){const e=Math.round(Math.min(a[0],a[2])+a[4]),n=Math.round(Math.min(a[1],a[3])+a[5]);return this.dependencyTracker?.recordDependencies(t,bh),{canvas:i,offsetX:e,offsetY:n}}h=i}h||(d=this.cachedCanvases.getCanvas("maskCanvas",i,s),Hh(d.context,e));let u=fl.transform(a,[1/i,0,0,-1/s,0,0]);u=fl.transform(u,[1,0,0,1,0,-s]);const p=Bh.slice();fl.axialAlignedBoundingBox([0,0,i,s],u,p);const[f,m,g,y]=p,b=Math.round(g-f)||1,w=Math.round(y-m)||1,v=this.cachedCanvases.getCanvas("fillCanvas",b,w),A=v.context,x=f,S=m;A.translate(-x,-S),A.transform(...u),h||(h=this._scaleImage(d.canvas,Bl(A)),h=h.img,l&&o&&l.set(c,h)),A.imageSmoothingEnabled=Wh(Rl(A),e.interpolate),Lh(A,h,0,0,h.width,h.height,0,0,i,s),A.globalCompositeOperation="source-in";const _=fl.transform(Bl(A),[1,0,0,1,-x,-S]);return A.fillStyle=o?r.getPattern(n,this,_,wh,t):r,A.fillRect(0,0,i,s),l&&!o&&(this.cachedCanvases.delete("fillCanvas"),l.set(c,v.canvas)),this.dependencyTracker?.recordDependencies(t,bh),{canvas:v.canvas,offsetX:Math.round(x),offsetY:Math.round(S)}}setLineWidth(t,e){this.dependencyTracker?.recordSimpleData("lineWidth",t),e!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=e,this.ctx.lineWidth=e}setLineCap(t,e){this.dependencyTracker?.recordSimpleData("lineCap",t),this.ctx.lineCap=Gh[e]}setLineJoin(t,e){this.dependencyTracker?.recordSimpleData("lineJoin",t),this.ctx.lineJoin=jh[e]}setMiterLimit(t,e){this.dependencyTracker?.recordSimpleData("miterLimit",t),this.ctx.miterLimit=e}setDash(t,e,n){this.dependencyTracker?.recordSimpleData("dash",t);const i=this.ctx;void 0!==i.setLineDash&&(i.setLineDash(e),i.lineDashOffset=n)}setRenderingIntent(t,e){}setFlatness(t,e){}setGState(t,e){for(const[n,i]of e)switch(n){case"LW":this.setLineWidth(t,i);break;case"LC":this.setLineCap(t,i);break;case"LJ":this.setLineJoin(t,i);break;case"ML":this.setMiterLimit(t,i);break;case"D":this.setDash(t,i[0],i[1]);break;case"RI":this.setRenderingIntent(t,i);break;case"FL":this.setFlatness(t,i);break;case"Font":this.setFont(t,i[0],i[1]);break;case"CA":this.dependencyTracker?.recordSimpleData("strokeAlpha",t),this.current.strokeAlpha=i;break;case"ca":this.dependencyTracker?.recordSimpleData("fillAlpha",t),this.ctx.globalAlpha=this.current.fillAlpha=i;break;case"BM":this.dependencyTracker?.recordSimpleData("globalCompositeOperation",t),this.ctx.globalCompositeOperation=i;break;case"SMask":this.dependencyTracker?.recordSimpleData("SMask",t),this.current.activeSMask=i?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case"TR":this.dependencyTracker?.recordSimpleData("filter",t),this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(i)}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const t=this.inSMaskMode;this.current.activeSMask&&!t?this.beginSMaskMode():!this.current.activeSMask&&t&&this.endSMaskMode()}beginSMaskMode(t){if(this.inSMaskMode)throw new Error("beginSMaskMode called while already in smask mode");const e=this.ctx.canvas.width,n=this.ctx.canvas.height,i="smaskGroupAt"+this.groupLevel,s=this.cachedCanvases.getCanvas(i,e,n);this.suspendedCtx=this.ctx;const r=this.ctx=s.context;r.setTransform(this.suspendedCtx.getTransform()),$h(this.suspendedCtx,r),function(t,e){if(t._removeMirroring)throw new Error("Context is already forwarding operations.");t.__originalSave=t.save,t.__originalRestore=t.restore,t.__originalRotate=t.rotate,t.__originalScale=t.scale,t.__originalTranslate=t.translate,t.__originalTransform=t.transform,t.__originalSetTransform=t.setTransform,t.__originalResetTransform=t.resetTransform,t.__originalClip=t.clip,t.__originalMoveTo=t.moveTo,t.__originalLineTo=t.lineTo,t.__originalBezierCurveTo=t.bezierCurveTo,t.__originalRect=t.rect,t.__originalClosePath=t.closePath,t.__originalBeginPath=t.beginPath,t._removeMirroring=()=>{t.save=t.__originalSave,t.restore=t.__originalRestore,t.rotate=t.__originalRotate,t.scale=t.__originalScale,t.translate=t.__originalTranslate,t.transform=t.__originalTransform,t.setTransform=t.__originalSetTransform,t.resetTransform=t.__originalResetTransform,t.clip=t.__originalClip,t.moveTo=t.__originalMoveTo,t.lineTo=t.__originalLineTo,t.bezierCurveTo=t.__originalBezierCurveTo,t.rect=t.__originalRect,t.closePath=t.__originalClosePath,t.beginPath=t.__originalBeginPath,delete t._removeMirroring},t.save=function(){e.save(),this.__originalSave()},t.restore=function(){e.restore(),this.__originalRestore()},t.translate=function(t,n){e.translate(t,n),this.__originalTranslate(t,n)},t.scale=function(t,n){e.scale(t,n),this.__originalScale(t,n)},t.transform=function(t,n,i,s,r,o){e.transform(t,n,i,s,r,o),this.__originalTransform(t,n,i,s,r,o)},t.setTransform=function(t,n,i,s,r,o){e.setTransform(t,n,i,s,r,o),this.__originalSetTransform(t,n,i,s,r,o)},t.resetTransform=function(){e.resetTransform(),this.__originalResetTransform()},t.rotate=function(t){e.rotate(t),this.__originalRotate(t)},t.clip=function(t){e.clip(t),this.__originalClip(t)},t.moveTo=function(t,n){e.moveTo(t,n),this.__originalMoveTo(t,n)},t.lineTo=function(t,n){e.lineTo(t,n),this.__originalLineTo(t,n)},t.bezierCurveTo=function(t,n,i,s,r,o){e.bezierCurveTo(t,n,i,s,r,o),this.__originalBezierCurveTo(t,n,i,s,r,o)},t.rect=function(t,n,i,s){e.rect(t,n,i,s),this.__originalRect(t,n,i,s)},t.closePath=function(){e.closePath(),this.__originalClosePath()},t.beginPath=function(){e.beginPath(),this.__originalBeginPath()}}(r,this.suspendedCtx),this.setGState(t,[["BM","source-over"]])}endSMaskMode(){if(!this.inSMaskMode)throw new Error("endSMaskMode called while not in smask mode");this.ctx._removeMirroring(),$h(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(t){if(!this.current.activeSMask)return;t?(t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.ceil(t[2]),t[3]=Math.ceil(t[3])):t=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];const e=this.current.activeSMask,n=this.suspendedCtx;this.composeSMask(n,e,this.ctx,t),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}composeSMask(t,e,n,i){const s=i[0],r=i[1],o=i[2]-s,a=i[3]-r;0!==o&&0!==a&&(this.genericComposeSMask(e.context,n,o,a,e.subtype,e.backdrop,e.transferMap,s,r,e.offsetX,e.offsetY),t.save(),t.globalAlpha=1,t.globalCompositeOperation="source-over",t.setTransform(1,0,0,1,0,0),t.drawImage(n.canvas,0,0),t.restore())}genericComposeSMask(t,e,n,i,s,r,o,a,l,c,h){let d=t.canvas,u=a-c,p=l-h;if(r)if(u<0||p<0||u+n>d.width||p+i>d.height){const t=this.cachedCanvases.getCanvas("maskExtension",n,i),e=t.context;e.drawImage(d,-u,-p),e.globalCompositeOperation="destination-atop",e.fillStyle=r,e.fillRect(0,0,n,i),e.globalCompositeOperation="source-over",d=t.canvas,u=p=0}else{t.save(),t.globalAlpha=1,t.setTransform(1,0,0,1,0,0);const e=new Path2D;e.rect(u,p,n,i),t.clip(e),t.globalCompositeOperation="destination-atop",t.fillStyle=r,t.fillRect(u,p,n,i),t.restore()}e.save(),e.globalAlpha=1,e.setTransform(1,0,0,1,0,0),"Alpha"===s&&o?e.filter=this.filterFactory.addAlphaFilter(o):"Luminosity"===s&&(e.filter=this.filterFactory.addLuminosityFilter(o));const f=new Path2D;f.rect(a,l,n,i),e.clip(f),e.globalCompositeOperation="destination-in",e.drawImage(d,u,p,n,i,a,l,n,i),e.restore()}save(t){this.inSMaskMode&&$h(this.ctx,this.suspendedCtx),this.ctx.save();const e=this.current;this.stateStack.push(e),this.current=e.clone(),this.dependencyTracker?.save(t)}restore(t){this.dependencyTracker?.restore(t),0!==this.stateStack.length?(this.current=this.stateStack.pop(),this.ctx.restore(),this.inSMaskMode&&$h(this.suspendedCtx,this.ctx),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null):this.inSMaskMode&&this.endSMaskMode()}transform(t,e,n,i,s,r,o){this.dependencyTracker?.recordIncrementalData("transform",t),this.ctx.transform(e,n,i,s,r,o),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(t,e,n,i){let[s]=n;if(!i)return s||=n[0]=new Path2D,void this[e](t,s);if(null!==this.dependencyTracker){const n=e===Ua.stroke?this.current.lineWidth/2:0;this.dependencyTracker.resetBBox(t).recordBBox(t,this.ctx,i[0]-n,i[2]+n,i[1]-n,i[3]+n).recordDependencies(t,["transform"])}s instanceof Path2D||(s=n[0]=Kl(s)),fl.axialAlignedBoundingBox(i,Rl(this.ctx),this.current.minMax),this[e](t,s),this._pathStartIdx=t}closePath(t){this.ctx.closePath()}stroke(t,e,n=!0){const i=this.ctx,s=this.current.strokeColor;if(i.globalAlpha=this.current.strokeAlpha,this.contentVisible)if("object"==typeof s&&s?.getPattern){const n=s.isModifyingCurrentTransform()?i.getTransform():null;if(i.save(),i.strokeStyle=s.getPattern(i,this,Bl(i),vh,t),n){const t=new Path2D;t.addPath(e,i.getTransform().invertSelf().multiplySelf(n)),e=t}this.rescaleAndStroke(e,!1),i.restore()}else this.rescaleAndStroke(e,!0);this.dependencyTracker?.recordDependencies(t,uh),n&&this.consumePath(t,e,this.current.getClippedPathBoundingBox(vh,Rl(this.ctx))),i.globalAlpha=this.current.fillAlpha}closeStroke(t,e){this.stroke(t,e)}fill(t,e,n=!0){const i=this.ctx,s=this.current.fillColor;let r=!1;if(this.current.patternFill){const n=s.isModifyingCurrentTransform()?i.getTransform():null;if(this.dependencyTracker?.save(t),i.save(),i.fillStyle=s.getPattern(i,this,Bl(i),wh,t),n){const t=new Path2D;t.addPath(e,i.getTransform().invertSelf().multiplySelf(n)),e=t}r=!0}const o=this.current.getClippedPathBoundingBox();this.contentVisible&&null!==o&&(this.pendingEOFill?(i.fill(e,"evenodd"),this.pendingEOFill=!1):i.fill(e)),this.dependencyTracker?.recordDependencies(t,ph),r&&(i.restore(),this.dependencyTracker?.restore(t)),n&&this.consumePath(t,e,o)}eoFill(t,e){this.pendingEOFill=!0,this.fill(t,e)}fillStroke(t,e){this.fill(t,e,!1),this.stroke(t,e,!1),this.consumePath(t,e)}eoFillStroke(t,e){this.pendingEOFill=!0,this.fillStroke(t,e)}closeFillStroke(t,e){this.fillStroke(t,e)}closeEOFillStroke(t,e){this.pendingEOFill=!0,this.fillStroke(t,e)}endPath(t,e){this.consumePath(t,e)}rawFillPath(t,e){this.ctx.fill(e),this.dependencyTracker?.recordDependencies(t,mh).recordOperation(t)}clip(t){this.dependencyTracker?.recordFutureForcedDependency("clipMode",t),this.pendingClip=Kh}eoClip(t){this.dependencyTracker?.recordFutureForcedDependency("clipMode",t),this.pendingClip=qh}beginText(t){this.current.textMatrix=null,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0,this.dependencyTracker?.recordOpenMarker(t).resetIncrementalData("sameLineText").resetIncrementalData("moveText",t)}endText(t){const e=this.pendingTextPaths,n=this.ctx;if(this.dependencyTracker){const{dependencyTracker:n}=this;void 0!==e&&n.recordFutureForcedDependency("textClip",n.getOpenMarker()).recordFutureForcedDependency("textClip",t),n.recordCloseMarker(t)}if(void 0!==e){const t=new Path2D,i=n.getTransform().invertSelf();for(const{transform:n,x:s,y:r,fontSize:o,path:a}of e)a&&t.addPath(a,new DOMMatrix(n).preMultiplySelf(i).translate(s,r).scale(o,-o));n.clip(t)}delete this.pendingTextPaths}setCharSpacing(t,e){this.dependencyTracker?.recordSimpleData("charSpacing",t),this.current.charSpacing=e}setWordSpacing(t,e){this.dependencyTracker?.recordSimpleData("wordSpacing",t),this.current.wordSpacing=e}setHScale(t,e){this.dependencyTracker?.recordSimpleData("hScale",t),this.current.textHScale=e/100}setLeading(t,e){this.dependencyTracker?.recordSimpleData("leading",t),this.current.leading=-e}setFont(t,e,n){this.dependencyTracker?.recordSimpleData("font",t).recordSimpleDataFromNamed("fontObj",e,t);const i=this.commonObjs.get(e),s=this.current;if(!i)throw new Error(`Can't find font for ${e}`);if(s.fontMatrix=i.fontMatrix||pa,0!==s.fontMatrix[0]&&0!==s.fontMatrix[3]||Qa("Invalid font matrix for font "+e),n<0?(n=-n,s.fontDirection=-1):s.fontDirection=1,this.current.font=i,this.current.fontSize=n,i.isType3Font)return;const r=i.loadedName||"sans-serif",o=i.systemFontInfo?.css||`"${r}", ${i.fallbackName}`;let a="normal";i.black?a="900":i.bold&&(a="bold");const l=i.italic?"italic":"normal";let c=n;n<16?c=16:n>100&&(c=100),this.current.fontSizeScale=n/c,this.ctx.font=`${l} ${a} ${c}px ${o}`}setTextRenderingMode(t,e){this.dependencyTracker?.recordSimpleData("textRenderingMode",t),this.current.textRenderingMode=e}setTextRise(t,e){this.dependencyTracker?.recordSimpleData("textRise",t),this.current.textRise=e}moveText(t,e,n){this.dependencyTracker?.resetIncrementalData("sameLineText").recordIncrementalData("moveText",t),this.current.x=this.current.lineX+=e,this.current.y=this.current.lineY+=n}setLeadingMoveText(t,e,n){this.setLeading(t,-n),this.moveText(t,e,n)}setTextMatrix(t,e){this.dependencyTracker?.resetIncrementalData("sameLineText").recordSimpleData("textMatrix",t);const{current:n}=this;n.textMatrix=e,n.textMatrixScale=Math.hypot(e[0],e[1]),n.x=n.lineX=0,n.y=n.lineY=0}nextLine(t){this.moveText(t,0,this.current.leading),this.dependencyTracker?.recordIncrementalData("moveText",this.dependencyTracker.getSimpleIndex("leading")??t)}#Xi(t,e,n){const i=new Path2D;return i.addPath(t,new DOMMatrix(n).invertSelf().multiplySelf(e)),i}paintChar(t,e,n,i,s,r){const o=this.ctx,a=this.current,l=a.font,c=a.textRenderingMode,h=a.fontSize/a.fontSizeScale,d=c&Pa,u=!!(c&Oa),p=a.patternFill&&!l.missingFile,f=a.patternStroke&&!l.missingFile;let m;if((l.disableFontFace||u||p||f)&&!l.missingFile&&(m=l.getPathGenerator(this.commonObjs,e)),m&&(l.disableFontFace||p||f)){let e;if(o.save(),o.translate(n,i),o.scale(h,-h),this.dependencyTracker?.recordCharacterBBox(t,o,l),d===ka||d===Ia)if(s){e=o.getTransform(),o.setTransform(...s);const t=this.#Xi(m,e,s);o.fill(t)}else o.fill(m);if(d===Da||d===Ia)if(r){e||=o.getTransform(),o.setTransform(...r);const{a:t,b:n,c:i,d:s}=e,a=fl.inverseTransform(r),l=fl.transform([t,n,i,s,0,0],a);fl.singularValueDecompose2dScale(l,Rh),o.lineWidth*=Math.max(Rh[0],Rh[1])/h,o.stroke(this.#Xi(m,e,r))}else o.lineWidth/=h,o.stroke(m);o.restore()}else d!==ka&&d!==Ia||(o.fillText(e,n,i),this.dependencyTracker?.recordCharacterBBox(t,o,l,h,n,i,()=>o.measureText(e))),d!==Da&&d!==Ia||(this.dependencyTracker&&this.dependencyTracker?.recordCharacterBBox(t,o,l,h,n,i,()=>o.measureText(e)).recordDependencies(t,uh),o.strokeText(e,n,i));if(u){(this.pendingTextPaths||=[]).push({transform:Rl(o),x:n,y:i,fontSize:h,path:m}),this.dependencyTracker?.recordCharacterBBox(t,o,l,h,n,i)}}get isFontSubpixelAAEnabled(){const{context:t}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);t.scale(1.5,1),t.fillText("I",0,10);const e=t.getImageData(0,0,10,10).data;let n=!1;for(let i=3;i<e.length;i+=4)if(e[i]>0&&e[i]<255){n=!0;break}return il(this,"isFontSubpixelAAEnabled",n)}showText(t,e){this.dependencyTracker&&(this.dependencyTracker.recordDependencies(t,gh).resetBBox(t),this.current.textRenderingMode&Oa&&this.dependencyTracker.recordFutureForcedDependency("textClip",t).inheritPendingDependenciesAsFutureForcedDependencies());const n=this.current,i=n.font;if(i.isType3Font)return this.showType3Text(t,e),void this.dependencyTracker?.recordShowTextOperation(t);const s=n.fontSize;if(0===s)return void this.dependencyTracker?.recordOperation(t);const r=this.ctx,o=n.fontSizeScale,a=n.charSpacing,l=n.wordSpacing,c=n.fontDirection,h=n.textHScale*c,d=e.length,u=i.vertical,p=u?1:-1,f=i.defaultVMetrics,m=s*n.fontMatrix[0],g=n.textRenderingMode===ka&&!i.disableFontFace&&!n.patternFill;let y,b;r.save(),n.textMatrix&&r.transform(...n.textMatrix),r.translate(n.x,n.y+n.textRise),c>0?r.scale(h,-1):r.scale(h,1);const w=n.textRenderingMode&Pa,v=w===Da||w===Ia;if((w===ka||w===Ia)&&n.patternFill){r.save();const e=n.fillColor.getPattern(r,this,Bl(r),wh,t);y=Rl(r),r.restore(),r.fillStyle=e}if(v&&n.patternStroke){r.save();const e=n.strokeColor.getPattern(r,this,Bl(r),vh,t);b=Rl(r),r.restore(),r.strokeStyle=e}let A=n.lineWidth;const x=n.textMatrixScale;if(0===x||0===A?v&&(A=this.getSinglePixelWidth()):A/=x,1!==o&&(r.scale(o,o),A/=o),r.lineWidth=A,i.isInvalidPDFjsFont){const i=[];let s=0;for(const t of e)i.push(t.unicode),s+=t.width;const o=i.join("");if(r.fillText(o,0,0),null!==this.dependencyTracker){const e=r.measureText(o);this.dependencyTracker.recordBBox(t,this.ctx,-e.actualBoundingBoxLeft,e.actualBoundingBoxRight,-e.actualBoundingBoxAscent,e.actualBoundingBoxDescent).recordShowTextOperation(t)}return n.x+=s*m*h,r.restore(),void this.compose()}let S,_=0;for(S=0;S<d;++S){const n=e[S];if("number"==typeof n){_+=p*n*s/1e3;continue}let h=!1;const d=(n.isSpace?l:0)+a,w=n.fontChar,v=n.accent;let A,x,T,E=n.width;if(u){const t=n.vmetric||f,e=-(n.vmetric?t[1]:.5*E)*m,i=t[2]*m;E=t?-t[0]:E,A=e/o,x=(_+i)/o}else A=_/o,x=0;if(i.remeasure&&E>0){T=r.measureText(w);const t=1e3*T.width/s*o;if(E<t&&this.isFontSubpixelAAEnabled){const e=E/t;h=!0,r.save(),r.scale(e,1),A/=e}else E!==t&&(A+=(E-t)/2e3*s/o)}if(this.contentVisible&&(n.isInFont||i.missingFile))if(g&&!v)r.fillText(w,A,x),this.dependencyTracker?.recordCharacterBBox(t,r,T?{bbox:null}:i,s/o,A,x,()=>T??r.measureText(w));else if(this.paintChar(t,w,A,x,y,b),v){const e=A+s*v.offset.x/o,n=x-s*v.offset.y/o;this.paintChar(t,v.fontChar,e,n,y,b)}_+=u?E*m-d*c:E*m+d*c,h&&r.restore()}u?n.y-=_:n.x+=_*h,r.restore(),this.compose(),this.dependencyTracker?.recordShowTextOperation(t)}showType3Text(t,e){const n=this.ctx,i=this.current,s=i.font,r=i.fontSize,o=i.fontDirection,a=s.vertical?1:-1,l=i.charSpacing,c=i.wordSpacing,h=i.textHScale*o,d=i.fontMatrix||pa,u=e.length;let p,f,m,g;if(i.textRenderingMode===Na||0===r)return;this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,n.save(),i.textMatrix&&n.transform(...i.textMatrix),n.translate(i.x,i.y+i.textRise),n.scale(h,o);const y=this.dependencyTracker;for(this.dependencyTracker=y?new dh(y,t):null,p=0;p<u;++p){if(f=e[p],"number"==typeof f){g=a*f*r/1e3,this.ctx.translate(g,0),i.x+=g*h;continue}const t=(f.isSpace?c:0)+l,o=s.charProcOperatorList[f.operatorListId];o?this.contentVisible&&(this.save(),n.scale(r,r),n.transform(...d),this.executeOperatorList(o),this.restore()):Qa(`Type3 character "${f.operatorListId}" is not available.`);const u=[f.width,0];fl.applyTransform(u,d),m=u[0]*r+t,n.translate(m,0),i.x+=m*h}n.restore(),y&&(this.dependencyTracker=y)}setCharWidth(t,e,n){}setCharWidthAndBounds(t,e,n,i,s,r,o){const a=new Path2D;a.rect(i,s,r-i,o-s),this.ctx.clip(a),this.dependencyTracker?.recordBBox(t,this.ctx,i,r,s,o).recordClipBox(t,this.ctx,i,r,s,o),this.endPath(t)}getColorN_Pattern(t,e){let n;if("TilingPattern"===e[0]){const t=this.baseTransform||Rl(this.ctx),i={createCanvasGraphics:(t,e)=>new Yh(t,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack},void 0,void 0,this.dependencyTracker?new dh(this.dependencyTracker,e,!0):null)};n=new Ih(e,this.ctx,i,t)}else n=this._getPattern(t,e[1],e[2]);return n}setStrokeColorN(t,...e){this.dependencyTracker?.recordSimpleData("strokeColor",t),this.current.strokeColor=this.getColorN_Pattern(t,e),this.current.patternStroke=!0}setFillColorN(t,...e){this.dependencyTracker?.recordSimpleData("fillColor",t),this.current.fillColor=this.getColorN_Pattern(t,e),this.current.patternFill=!0}setStrokeRGBColor(t,e){this.dependencyTracker?.recordSimpleData("strokeColor",t),this.ctx.strokeStyle=this.current.strokeColor=e,this.current.patternStroke=!1}setStrokeTransparent(t){this.dependencyTracker?.recordSimpleData("strokeColor",t),this.ctx.strokeStyle=this.current.strokeColor="transparent",this.current.patternStroke=!1}setFillRGBColor(t,e){this.dependencyTracker?.recordSimpleData("fillColor",t),this.ctx.fillStyle=this.current.fillColor=e,this.current.patternFill=!1}setFillTransparent(t){this.dependencyTracker?.recordSimpleData("fillColor",t),this.ctx.fillStyle=this.current.fillColor="transparent",this.current.patternFill=!1}_getPattern(t,e,n=null){let i;return this.cachedPatterns.has(e)?i=this.cachedPatterns.get(e):(i=function(t){switch(t[0]){case"RadialAxial":return new _h(t);case"Mesh":return new Ch(t);case"Dummy":return new Mh}throw new Error(`Unknown IR type: ${t[0]}`)}(this.getObject(t,e)),this.cachedPatterns.set(e,i)),n&&(i.matrix=n),i}shadingFill(t,e){if(!this.contentVisible)return;const n=this.ctx;this.save(t);const i=this._getPattern(t,e);n.fillStyle=i.getPattern(n,this,Bl(n),Ah,t);const s=Bl(n);if(s){const{width:t,height:e}=n.canvas,i=Bh.slice();fl.axialAlignedBoundingBox([0,0,t,e],s,i);const[r,o,a,l]=i;this.ctx.fillRect(r,o,a-r,l-o)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.dependencyTracker?.resetBBox(t).recordFullPageBBox(t).recordDependencies(t,yh).recordDependencies(t,ph).recordOperation(t),this.compose(this.current.getClippedPathBoundingBox()),this.restore(t)}beginInlineImage(){Za("Should not call beginInlineImage")}beginImageData(){Za("Should not call beginImageData")}paintFormXObjectBegin(t,e,n){if(this.contentVisible&&(this.save(t),this.baseTransformStack.push(this.baseTransform),e&&this.transform(t,...e),this.baseTransform=Rl(this.ctx),n)){fl.axialAlignedBoundingBox(n,this.baseTransform,this.current.minMax);const[e,i,s,r]=n,o=new Path2D;o.rect(e,i,s-e,r-i),this.ctx.clip(o),this.dependencyTracker?.recordClipBox(t,this.ctx,e,s,i,r),this.endPath(t)}}paintFormXObjectEnd(t){this.contentVisible&&(this.restore(t),this.baseTransform=this.baseTransformStack.pop())}beginGroup(t,e){if(!this.contentVisible)return;this.save(t),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);const n=this.ctx;e.isolated||Ja("TODO: Support non-isolated groups."),e.knockout&&Qa("Knockout groups not supported.");const i=Rl(n);if(e.matrix&&n.transform(...e.matrix),!e.bbox)throw new Error("Bounding box is required.");let s=Bh.slice();fl.axialAlignedBoundingBox(e.bbox,Rl(n),s);const r=[0,0,n.canvas.width,n.canvas.height];s=fl.intersect(s,r)||[0,0,0,0];const o=Math.floor(s[0]),a=Math.floor(s[1]),l=Math.max(Math.ceil(s[2])-o,1),c=Math.max(Math.ceil(s[3])-a,1);this.current.startNewPathAndClipBox([0,0,l,c]);let h="groupAt"+this.groupLevel;e.smask&&(h+="_smask_"+this.smaskCounter++%2);const d=this.cachedCanvases.getCanvas(h,l,c),u=d.context;u.translate(-o,-a),u.transform(...i);let p=new Path2D;const[f,m,g,y]=e.bbox;if(p.rect(f,m,g-f,y-m),e.matrix){const t=new Path2D;t.addPath(p,new DOMMatrix(e.matrix)),p=t}u.clip(p),e.smask&&this.smaskStack.push({canvas:d.canvas,context:u,offsetX:o,offsetY:a,subtype:e.smask.subtype,backdrop:e.smask.backdrop,transferMap:e.smask.transferMap||null,startTransformInverse:null}),e.smask&&!this.dependencyTracker||(n.setTransform(1,0,0,1,0,0),n.translate(o,a),n.save()),$h(n,u),this.ctx=u,this.dependencyTracker?.inheritSimpleDataAsFutureForcedDependencies(["fillAlpha","strokeAlpha","globalCompositeOperation"]).pushBaseTransform(n),this.setGState(t,[["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(n),this.groupLevel++}endGroup(t,e){if(!this.contentVisible)return;this.groupLevel--;const n=this.ctx,i=this.groupStack.pop();if(this.ctx=i,this.ctx.imageSmoothingEnabled=!1,this.dependencyTracker?.popBaseTransform(),e.smask)this.tempSMask=this.smaskStack.pop(),this.restore(t),this.dependencyTracker&&this.ctx.restore();else{this.ctx.restore();const e=Rl(this.ctx);this.restore(t),this.ctx.save(),this.ctx.setTransform(...e);const i=Bh.slice();fl.axialAlignedBoundingBox([0,0,n.canvas.width,n.canvas.height],e,i),this.ctx.drawImage(n.canvas,0,0),this.ctx.restore(),this.compose(i)}}beginAnnotation(t,e,n,i,s,r){if(this.#qi(),Uh(this.ctx),this.ctx.save(),this.save(t),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),n){const s=n[2]-n[0],o=n[3]-n[1];if(r&&this.annotationCanvasMap){(i=i.slice())[4]-=n[0],i[5]-=n[1],(n=n.slice())[0]=n[1]=0,n[2]=s,n[3]=o,fl.singularValueDecompose2dScale(Rl(this.ctx),Rh);const{viewportScale:t}=this,r=Math.ceil(s*this.outputScaleX*t),a=Math.ceil(o*this.outputScaleY*t);this.annotationCanvas=this.canvasFactory.create(r,a);const{canvas:l,context:c}=this.annotationCanvas;this.annotationCanvasMap.set(e,l),this.annotationCanvas.savedCtx=this.ctx,this.ctx=c,this.ctx.save(),this.ctx.setTransform(Rh[0],0,0,-Rh[1],0,o*Rh[1]),Uh(this.ctx)}else{Uh(this.ctx),this.endPath(t);const e=new Path2D;e.rect(n[0],n[1],s,o),this.ctx.clip(e)}}this.current=new zh(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(t,...i),this.transform(t,...s)}endAnnotation(t){this.annotationCanvas&&(this.ctx.restore(),this.#Yi(),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(t,e){if(!this.contentVisible)return;const n=e.count;(e=this.getObject(t,e.data,e)).count=n;const i=this.ctx,s=this._createMaskCanvas(t,e),r=s.canvas;i.save(),i.setTransform(1,0,0,1,0,0),i.drawImage(r,s.offsetX,s.offsetY),this.dependencyTracker?.resetBBox(t).recordBBox(t,this.ctx,s.offsetX,s.offsetX+r.width,s.offsetY,s.offsetY+r.height).recordOperation(t),i.restore(),this.compose()}paintImageMaskXObjectRepeat(t,e,n,i=0,s=0,r,o){if(!this.contentVisible)return;e=this.getObject(t,e.data,e);const a=this.ctx;a.save();const l=Rl(a);a.transform(n,i,s,r,0,0);const c=this._createMaskCanvas(t,e);a.setTransform(1,0,0,1,c.offsetX-l[4],c.offsetY-l[5]),this.dependencyTracker?.resetBBox(t);for(let h=0,d=o.length;h<d;h+=2){const e=fl.transform(l,[n,i,s,r,o[h],o[h+1]]);a.drawImage(c.canvas,e[4],e[5]),this.dependencyTracker?.recordBBox(t,this.ctx,e[4],e[4]+c.canvas.width,e[5],e[5]+c.canvas.height)}a.restore(),this.compose(),this.dependencyTracker?.recordOperation(t)}paintImageMaskXObjectGroup(t,e){if(!this.contentVisible)return;const n=this.ctx,i=this.current.fillColor,s=this.current.patternFill;this.dependencyTracker?.resetBBox(t).recordDependencies(t,bh);for(const r of e){const{data:e,width:o,height:a,transform:l}=r,c=this.cachedCanvases.getCanvas("maskCanvas",o,a),h=c.context;h.save();Hh(h,this.getObject(t,e,r)),h.globalCompositeOperation="source-in",h.fillStyle=s?i.getPattern(h,this,Bl(n),wh,t):i,h.fillRect(0,0,o,a),h.restore(),n.save(),n.transform(...l),n.scale(1,-1),Lh(n,c.canvas,0,0,o,a,0,-1,1,1),this.dependencyTracker?.recordBBox(t,n,0,o,0,a),n.restore()}this.compose(),this.dependencyTracker?.recordOperation(t)}paintImageXObject(t,e){if(!this.contentVisible)return;const n=this.getObject(t,e);n?this.paintInlineImageXObject(t,n):Qa("Dependent image isn't ready yet")}paintImageXObjectRepeat(t,e,n,i,s){if(!this.contentVisible)return;const r=this.getObject(t,e);if(!r)return void Qa("Dependent image isn't ready yet");const o=r.width,a=r.height,l=[];for(let c=0,h=s.length;c<h;c+=2)l.push({transform:[n,0,0,i,s[c],s[c+1]],x:0,y:0,w:o,h:a});this.paintInlineImageXObjectGroup(t,r,l)}applyTransferMapsToCanvas(t){return"none"!==this.current.transferMaps&&(t.filter=this.current.transferMaps,t.drawImage(t.canvas,0,0),t.filter="none"),t.canvas}applyTransferMapsToBitmap(t){if("none"===this.current.transferMaps)return t.bitmap;const{bitmap:e,width:n,height:i}=t,s=this.cachedCanvases.getCanvas("inlineImage",n,i),r=s.context;return r.filter=this.current.transferMaps,r.drawImage(e,0,0),r.filter="none",s.canvas}paintInlineImageXObject(t,e){if(!this.contentVisible)return;const n=e.width,i=e.height,s=this.ctx;this.save(t);const{filter:r}=s;let o;if("none"!==r&&""!==r&&(s.filter="none"),s.scale(1/n,-1/i),e.bitmap)o=this.applyTransferMapsToBitmap(e);else if("function"==typeof HTMLElement&&e instanceof HTMLElement||!e.data)o=e;else{const t=this.cachedCanvases.getCanvas("inlineImage",n,i).context;Vh(t,e),o=this.applyTransferMapsToCanvas(t)}const a=this._scaleImage(o,Bl(s));s.imageSmoothingEnabled=Wh(Rl(s),e.interpolate),this.dependencyTracker?.resetBBox(t).recordBBox(t,s,0,n,-i,0).recordDependencies(t,fh).recordOperation(t),Lh(s,a.img,0,0,a.paintWidth,a.paintHeight,0,-i,n,i),this.compose(),this.restore(t)}paintInlineImageXObjectGroup(t,e,n){if(!this.contentVisible)return;const i=this.ctx;let s;if(e.bitmap)s=e.bitmap;else{const t=e.width,n=e.height,i=this.cachedCanvases.getCanvas("inlineImage",t,n).context;Vh(i,e),s=this.applyTransferMapsToCanvas(i)}this.dependencyTracker?.resetBBox(t);for(const r of n)i.save(),i.transform(...r.transform),i.scale(1,-1),Lh(i,s,r.x,r.y,r.w,r.h,0,-1,1,1),this.dependencyTracker?.recordBBox(t,i,0,1,-1,0),i.restore();this.dependencyTracker?.recordOperation(t),this.compose()}paintSolidColorImageMask(t){this.contentVisible&&(this.dependencyTracker?.resetBBox(t).recordBBox(t,this.ctx,0,1,0,1).recordDependencies(t,ph).recordOperation(t),this.ctx.fillRect(0,0,1,1),this.compose())}markPoint(t,e){}markPointProps(t,e,n){}beginMarkedContent(t,e){this.dependencyTracker?.beginMarkedContent(t),this.markedContentStack.push({visible:!0})}beginMarkedContentProps(t,e,n){this.dependencyTracker?.beginMarkedContent(t),"OC"===e?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(n)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(t){this.dependencyTracker?.endMarkedContent(t),this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(t){}endCompat(t){}consumePath(t,e,n){const i=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(n);const s=this.ctx;this.pendingClip?(i||(this.pendingClip===qh?s.clip(e,"evenodd"):s.clip(e)),this.pendingClip=null,this.dependencyTracker?.bboxToClipBoxDropOperation(t).recordFutureForcedDependency("clipPath",t)):this.dependencyTracker?.recordOperation(t),this.current.startNewPathAndClipBox(this.current.clipBox)}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const t=Rl(this.ctx);if(0===t[1]&&0===t[2])this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(t[0]),Math.abs(t[3]));else{const e=Math.abs(t[0]*t[3]-t[2]*t[1]),n=Math.hypot(t[0],t[2]),i=Math.hypot(t[1],t[3]);this._cachedGetSinglePixelWidth=Math.max(n,i)/e}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(-1===this._cachedScaleForStroking[0]){const{lineWidth:t}=this.current,{a:e,b:n,c:i,d:s}=this.ctx.getTransform();let r,o;if(0===n&&0===i){const n=Math.abs(e),i=Math.abs(s);if(n===i)if(0===t)r=o=1/n;else{const e=n*t;r=o=e<1?1/e:1}else if(0===t)r=1/n,o=1/i;else{const e=n*t,s=i*t;r=e<1?1/e:1,o=s<1?1/s:1}}else{const a=Math.abs(e*s-n*i),l=Math.hypot(e,n),c=Math.hypot(i,s);if(0===t)r=c/a,o=l/a;else{const e=t*a;r=c>e?c/e:1,o=l>e?l/e:1}}this._cachedScaleForStroking[0]=r,this._cachedScaleForStroking[1]=o}return this._cachedScaleForStroking}rescaleAndStroke(t,e){const{ctx:n,current:{lineWidth:i}}=this,[s,r]=this.getScaleForStroking();if(s===r)return n.lineWidth=(i||1)*s,void n.stroke(t);const o=n.getLineDash();e&&n.save(),n.scale(s,r),Oh.a=1/s,Oh.d=1/r;const a=new Path2D;if(a.addPath(t,Oh),o.length>0){const t=Math.max(s,r);n.setLineDash(o.map(e=>e/t)),n.lineDashOffset/=t}n.lineWidth=i||1,n.stroke(a),e&&n.restore()}isContentVisible(){for(let t=this.markedContentStack.length-1;t>=0;t--)if(!this.markedContentStack[t].visible)return!1;return!0}}for(const Zp in Ua)void 0!==Yh.prototype[Zp]&&(Yh.prototype[Ua[Zp]]=Yh.prototype[Zp]);class Xh{static#Ji=null;static#Qi="";static get workerPort(){return this.#Ji}static set workerPort(t){if(!("undefined"!=typeof Worker&&t instanceof Worker)&&null!==t)throw new Error("Invalid `workerPort` type.");this.#Ji=t}static get workerSrc(){return this.#Qi}static set workerSrc(t){if("string"!=typeof t)throw new Error("Invalid `workerSrc` type.");this.#Qi=t}}class Jh{#Zi;#ts;constructor({parsedData:t,rawData:e}){this.#Zi=t,this.#ts=e}getRaw(){return this.#ts}get(t){return this.#Zi.get(t)??null}[Symbol.iterator](){return this.#Zi.entries()}}const Qh=Symbol("INTERNAL");class Zh{#es=!1;#ns=!1;#is=!1;#ss=!0;constructor(t,{name:e,intent:n,usage:i,rbGroups:s}){this.#es=!!(t&ga),this.#ns=!!(t&ya),this.name=e,this.intent=n,this.usage=i,this.rbGroups=s}get visible(){if(this.#is)return this.#ss;if(!this.#ss)return!1;const{print:t,view:e}=this.usage;return this.#es?"OFF"!==e?.viewState:!this.#ns||"OFF"!==t?.printState}_setVisible(t,e,n=!1){t!==Qh&&Za("Internal method `_setVisible` called."),this.#is=n,this.#ss=e}}class td{#rs=null;#os=new Map;#as=null;#ls=null;constructor(t,e=ga){if(this.renderingIntent=e,this.name=null,this.creator=null,null!==t){this.name=t.name,this.creator=t.creator,this.#ls=t.order;for(const n of t.groups)this.#os.set(n.id,new Zh(e,n));if("OFF"===t.baseState)for(const t of this.#os.values())t._setVisible(Qh,!1);for(const e of t.on)this.#os.get(e)._setVisible(Qh,!0);for(const e of t.off)this.#os.get(e)._setVisible(Qh,!1);this.#as=this.getHash()}}#cs(t){const e=t.length;if(e<2)return!0;const n=t[0];for(let i=1;i<e;i++){const e=t[i];let s;if(Array.isArray(e))s=this.#cs(e);else{if(!this.#os.has(e))return Qa(`Optional content group not found: ${e}`),!0;s=this.#os.get(e).visible}switch(n){case"And":if(!s)return!1;break;case"Or":if(s)return!0;break;case"Not":return!s;default:return!0}}return"And"===n}isVisible(t){if(0===this.#os.size)return!0;if(!t)return Ja("Optional content group not defined."),!0;if("OCG"===t.type)return this.#os.has(t.id)?this.#os.get(t.id).visible:(Qa(`Optional content group not found: ${t.id}`),!0);if("OCMD"===t.type){if(t.expression)return this.#cs(t.expression);if(!t.policy||"AnyOn"===t.policy){for(const e of t.ids){if(!this.#os.has(e))return Qa(`Optional content group not found: ${e}`),!0;if(this.#os.get(e).visible)return!0}return!1}if("AllOn"===t.policy){for(const e of t.ids){if(!this.#os.has(e))return Qa(`Optional content group not found: ${e}`),!0;if(!this.#os.get(e).visible)return!1}return!0}if("AnyOff"===t.policy){for(const e of t.ids){if(!this.#os.has(e))return Qa(`Optional content group not found: ${e}`),!0;if(!this.#os.get(e).visible)return!0}return!1}if("AllOff"===t.policy){for(const e of t.ids){if(!this.#os.has(e))return Qa(`Optional content group not found: ${e}`),!0;if(this.#os.get(e).visible)return!1}return!0}return Qa(`Unknown optional content policy ${t.policy}.`),!0}return Qa(`Unknown group type ${t.type}.`),!0}setVisibility(t,e=!0,n=!0){const i=this.#os.get(t);if(i){if(n&&e&&i.rbGroups.length)for(const e of i.rbGroups)for(const n of e)n!==t&&this.#os.get(n)?._setVisible(Qh,!1,!0);i._setVisible(Qh,!!e,!0),this.#rs=null}else Qa(`Optional content group not found: ${t}`)}setOCGState({state:t,preserveRB:e}){let n;for(const i of t){switch(i){case"ON":case"OFF":case"Toggle":n=i;continue}const t=this.#os.get(i);if(t)switch(n){case"ON":this.setVisibility(i,!0,e);break;case"OFF":this.setVisibility(i,!1,e);break;case"Toggle":this.setVisibility(i,!t.visible,e)}}this.#rs=null}get hasInitialVisibility(){return null===this.#as||this.getHash()===this.#as}getOrder(){return this.#os.size?this.#ls?this.#ls.slice():[...this.#os.keys()]:null}getGroup(t){return this.#os.get(t)||null}getHash(){if(null!==this.#rs)return this.#rs;const t=new pc;for(const[e,n]of this.#os)t.update(`${e}:${n.visible}`);return this.#rs=t.hexdigest()}[Symbol.iterator](){return this.#os.entries()}}class ed{#hs=null;#ds=null;_fullReader=null;_rangeReaders=new Set;_source=null;constructor(t,e,n){this._source=t,this.#hs=e,this.#ds=n}get _progressiveDataLength(){return this._fullReader?._loaded??0}getFullReader(){return tl(!this._fullReader,"BasePDFStream.getFullReader can only be called once."),this._fullReader=new this.#hs(this)}getRangeReader(t,e){if(e<=this._progressiveDataLength)return null;const n=new this.#ds(this,t,e);return this._rangeReaders.add(n),n}cancelAllRequests(t){this._fullReader?.cancel(t);for(const e of new Set(this._rangeReaders))e.cancel(t)}}class nd{onProgress=null;_contentLength=0;_filename=null;_headersCapability=Promise.withResolvers();_isRangeSupported=!1;_isStreamingSupported=!1;_loaded=0;_stream=null;constructor(t){this._stream=t}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){Za("Abstract method `read` called")}cancel(t){Za("Abstract method `cancel` called")}}class id{_stream=null;constructor(t,e,n){this._stream=t}async read(){Za("Abstract method `read` called")}cancel(t){Za("Abstract method `cancel` called")}}function sd(t){return t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength?t.buffer:new Uint8Array(t).buffer}class rd extends ed{_progressiveDone=!1;_queuedChunks=[];constructor(t){super(t,od,ad);const{pdfDataRangeTransport:e}=t,{initialData:n,progressiveDone:i}=e;if(n?.length>0){const t=sd(n);this._queuedChunks.push(t)}this._progressiveDone=i,e.addRangeListener((t,e)=>{this.#us(t,e)}),e.addProgressListener((t,e)=>{void 0!==e&&this._fullReader?.onProgress?.({loaded:t,total:e})}),e.addProgressiveReadListener(t=>{this.#us(void 0,t)}),e.addProgressiveDoneListener(()=>{this._fullReader?.progressiveDone(),this._progressiveDone=!0}),e.transportReady()}#us(t,e){const n=sd(e);if(void 0===t)this._fullReader?this._fullReader._enqueue(n):this._queuedChunks.push(n);else{const e=this._rangeReaders.keys().find(e=>e._begin===t);tl(e,"#onReceiveData - no `PDFDataTransportStreamRangeReader` instance found."),e._enqueue(n)}}getFullReader(){const t=super.getFullReader();return this._queuedChunks=null,t}getRangeReader(t,e){const n=super.getRangeReader(t,e);return n&&(n.onDone=()=>this._rangeReaders.delete(n),this._source.pdfDataRangeTransport.requestDataRange(t,e)),n}cancelAllRequests(t){super.cancelAllRequests(t),this._source.pdfDataRangeTransport.abort()}}class od extends nd{_done=!1;_queuedChunks=null;_requests=[];constructor(t){super(t);const{pdfDataRangeTransport:e,disableRange:n,disableStream:i}=t._source,{length:s,contentDispositionFilename:r}=e;this._queuedChunks=t._queuedChunks||[];for(const o of this._queuedChunks)this._loaded+=o.byteLength;this._done=t._progressiveDone,this._contentLength=s,this._isStreamingSupported=!i,this._isRangeSupported=!n,Ml(r)&&(this._filename=r),this._headersCapability.resolve()}_enqueue(t){if(!this._done){if(this._requests.length>0){this._requests.shift().resolve({value:t,done:!1})}else this._queuedChunks.push(t);this._loaded+=t.byteLength}}async read(){if(this._queuedChunks.length>0){return{value:this._queuedChunks.shift(),done:!1}}if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){this._done||=!0}}class ad extends id{onDone=null;_begin=-1;_done=!1;_queuedChunk=null;_requests=[];constructor(t,e,n){super(t,e,n),this._begin=e}_enqueue(t){if(!this._done){if(0===this._requests.length)this._queuedChunk=t;else{this._requests.shift().resolve({value:t,done:!1});for(const t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this.onDone?.()}}async read(){if(this._queuedChunk){const t=this._queuedChunk;return this._queuedChunk=null,{value:t,done:!1}}if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this.onDone?.()}}function ld(t,e){const n=new Headers;if(!t||!e||"object"!=typeof e)return n;for(const i in e){const t=e[i];void 0!==t&&n.append(i,t)}return n}function cd(t){return URL.parse(t)?.origin??null}function hd({responseHeaders:t,isHttp:e,rangeChunkSize:n,disableRange:i}){const s={allowRangeRequests:!1,suggestedLength:void 0},r=parseInt(t.get("Content-Length"),10);if(!Number.isInteger(r))return s;if(s.suggestedLength=r,r<=2*n)return s;if(i||!e)return s;if("bytes"!==t.get("Accept-Ranges"))return s;return"identity"!==(t.get("Content-Encoding")||"identity")||(s.allowRangeRequests=!0),s}function dd(t){const e=t.get("Content-Disposition");if(e){let t=function(t){let e=!0,n=i("filename\\*","i").exec(t);if(n){n=n[1];let t=o(n);return t=unescape(t),t=a(t),t=l(t),r(t)}if(n=function(t){const e=[];let n;const s=i("filename\\*((?!0\\d)\\d+)(\\*?)","ig");for(;null!==(n=s.exec(t));){let[,t,i,s]=n;if(t=parseInt(t,10),t in e){if(0===t)break}else e[t]=[i,s]}const r=[];for(let i=0;i<e.length&&i in e;++i){let[t,n]=e[i];n=o(n),t&&(n=unescape(n),0===i&&(n=a(n))),r.push(n)}return r.join("")}(t),n)return r(l(n));if(n=i("filename","i").exec(t),n){n=n[1];let t=o(n);return t=l(t),r(t)}function i(t,e){return new RegExp("(?:^|;)\\s*"+t+'\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)',e)}function s(t,n){if(t){if(!/^[\x00-\xFF]+$/.test(n))return n;try{const i=new TextDecoder(t,{fatal:!0}),s=dl(n);n=i.decode(s),e=!1}catch{}}return n}function r(t){return e&&/[\x80-\xff]/.test(t)&&(t=s("utf-8",t),e&&(t=s("iso-8859-1",t))),t}function o(t){if(t.startsWith('"')){const e=t.slice(1).split('\\"');for(let t=0;t<e.length;++t){const n=e[t].indexOf('"');-1!==n&&(e[t]=e[t].slice(0,n),e.length=t+1),e[t]=e[t].replaceAll(/\\(.)/g,"$1")}t=e.join('"')}return t}function a(t){const e=t.indexOf("'");return-1===e?t:s(t.slice(0,e),t.slice(e+1).replace(/^[^']*'/,""))}function l(t){return!t.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(t)?t:t.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(t,e,n,i){if("q"===n||"Q"===n)return s(e,i=(i=i.replaceAll("_"," ")).replaceAll(/=([0-9a-fA-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}));try{i=atob(i)}catch{}return s(e,i)})}return""}(e);if(t.includes("%"))try{t=decodeURIComponent(t)}catch{}if(Ml(t))return t}return null}function ud(t,e){return new ll(`Unexpected server response (${t}) while retrieving PDF "${e}".`,t,404===t||0===t&&e.startsWith("file:"))}function pd(t,e){if(t!==e)throw new Error(`Expected range response-origin "${t}" to match "${e}".`)}function fd(t,e,n,i){return fetch(t,{method:"GET",headers:e,signal:i.signal,mode:"cors",credentials:n?"include":"same-origin",redirect:"follow"})}function md(t,e){if(200!==t&&206!==t)throw ud(t,e)}function gd(t){return t instanceof Uint8Array?t.buffer:t instanceof ArrayBuffer?t:(Qa(`getArrayBuffer - unexpected data format: ${t}`),new Uint8Array(t).buffer)}class yd extends ed{_responseOrigin=null;constructor(t){super(t,bd,wd),this.isHttp=/^https?:/i.test(t.url),this.headers=ld(this.isHttp,t.httpHeaders)}}class bd extends nd{_abortController=new AbortController;_reader=null;constructor(t){super(t);const{disableRange:e,disableStream:n,length:i,rangeChunkSize:s,url:r,withCredentials:o}=t._source;this._contentLength=i,this._isStreamingSupported=!n,this._isRangeSupported=!e;const a=new Headers(t.headers);fd(r,a,o,this._abortController).then(n=>{t._responseOrigin=cd(n.url),md(n.status,r),this._reader=n.body.getReader();const i=n.headers,{allowRangeRequests:o,suggestedLength:a}=hd({responseHeaders:i,isHttp:t.isHttp,rangeChunkSize:s,disableRange:e});this._isRangeSupported=o,this._contentLength=a||this._contentLength,this._filename=dd(i),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new hl("Streaming is disabled.")),this._headersCapability.resolve()}).catch(this._headersCapability.reject)}async read(){await this._headersCapability.promise;const{value:t,done:e}=await this._reader.read();return e?{value:t,done:e}:(this._loaded+=t.byteLength,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:gd(t),done:!1})}cancel(t){this._reader?.cancel(t),this._abortController.abort()}}class wd extends id{_abortController=new AbortController;_readCapability=Promise.withResolvers();_reader=null;constructor(t,e,n){super(t,e,n);const{url:i,withCredentials:s}=t._source,r=new Headers(t.headers);r.append("Range",`bytes=${e}-${n-1}`),fd(i,r,s,this._abortController).then(e=>{pd(cd(e.url),t._responseOrigin),md(e.status,i),this._reader=e.body.getReader(),this._readCapability.resolve()}).catch(this._readCapability.reject)}async read(){await this._readCapability.promise;const{value:t,done:e}=await this._reader.read();return e?{value:t,done:e}:{value:gd(t),done:!1}}cancel(t){this._reader?.cancel(t),this._abortController.abort()}}class vd extends ed{#ps=new WeakMap;_responseOrigin=null;constructor(t){super(t,Ad,xd),this.url=t.url,this.isHttp=/^https?:/i.test(this.url),this.headers=ld(this.isHttp,t.httpHeaders)}_request(t){const e=new XMLHttpRequest,n={validateStatus:null,onHeadersReceived:t.onHeadersReceived,onDone:t.onDone,onError:t.onError,onProgress:t.onProgress};this.#ps.set(e,n),e.open("GET",this.url),e.withCredentials=this._source.withCredentials;for(const[i,s]of this.headers)e.setRequestHeader(i,s);return this.isHttp&&"begin"in t&&"end"in t?(e.setRequestHeader("Range",`bytes=${t.begin}-${t.end-1}`),n.validateStatus=t=>206===t||200===t):n.validateStatus=t=>200===t,e.responseType="arraybuffer",tl(t.onError,"Expected `onError` callback to be provided."),e.onerror=()=>t.onError(e.status),e.onreadystatechange=this.#fs.bind(this,e),e.onprogress=this.#ms.bind(this,e),e.send(null),e}#ms(t,e){const n=this.#ps.get(t);n?.onProgress?.(e)}#fs(t,e){const n=this.#ps.get(t);if(!n)return;if(t.readyState>=2&&n.onHeadersReceived&&(n.onHeadersReceived(),delete n.onHeadersReceived),4!==t.readyState)return;if(!this.#ps.has(t))return;if(this.#ps.delete(t),0===t.status&&this.isHttp)return void n.onError(t.status);const i=t.status||200;if(!n.validateStatus(i))return void n.onError(t.status);const s="string"!=typeof(r=t.response)?r:dl(r).buffer;var r;if(206===i){const e=t.getResponseHeader("Content-Range");/bytes (\d+)-(\d+)\/(\d+)/.test(e)?n.onDone(s):(Qa('Missing or invalid "Content-Range" header.'),n.onError(0))}else s?n.onDone(s):n.onError(t.status)}_abortRequest(t){this.#ps.has(t)&&(this.#ps.delete(t),t.abort())}getRangeReader(t,e){const n=super.getRangeReader(t,e);return n&&(n.onClosed=()=>this._rangeReaders.delete(n)),n}}class Ad extends nd{_cachedChunks=[];_done=!1;_requests=[];_storedError=null;constructor(t){super(t);const{length:e}=t._source;this._contentLength=e,this._fullRequestXhr=t._request({onHeadersReceived:this.#gs.bind(this),onDone:this.#ys.bind(this),onError:this.#bs.bind(this),onProgress:this.#ms.bind(this)})}#gs(){const t=this._stream,{disableRange:e,rangeChunkSize:n}=t._source,i=this._fullRequestXhr;t._responseOrigin=cd(i.responseURL);const s=i.getAllResponseHeaders(),r=new Headers(s?s.trimStart().replace(/[^\S ]+$/,"").split(/[\r\n]+/).map(t=>{const[e,...n]=t.split(": ");return[e,n.join(": ")]}):[]),{allowRangeRequests:o,suggestedLength:a}=hd({responseHeaders:r,isHttp:t.isHttp,rangeChunkSize:n,disableRange:e});o&&(this._isRangeSupported=!0),this._contentLength=a||this._contentLength,this._filename=dd(r),this._isRangeSupported&&t._abortRequest(i),this._headersCapability.resolve()}#ys(t){if(this._requests.length>0){this._requests.shift().resolve({value:t,done:!1})}else this._cachedChunks.push(t);if(this._done=!0,!(this._cachedChunks.length>0)){for(const t of this._requests)t.resolve({value:void 0,done:!0});this._requests.length=0}}#bs(t){this._storedError=ud(t,this._stream.url),this._headersCapability.reject(this._storedError);for(const e of this._requests)e.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}#ms(t){this.onProgress?.({loaded:t.loaded,total:t.lengthComputable?t.total:this._contentLength})}async read(){if(await this._headersCapability.promise,this._storedError)throw this._storedError;if(this._cachedChunks.length>0){return{value:this._cachedChunks.shift(),done:!1}}if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0,this._headersCapability.reject(t);for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._abortRequest(this._fullRequestXhr),this._fullRequestXhr=null}}class xd extends id{onClosed=null;_done=!1;_queuedChunk=null;_requests=[];_storedError=null;constructor(t,e,n){super(t,e,n),this._requestXhr=t._request({begin:e,end:n,onHeadersReceived:this.#gs.bind(this),onDone:this.#ys.bind(this),onError:this.#bs.bind(this),onProgress:null})}#gs(){const t=cd(this._requestXhr?.responseURL);try{pd(t,this._stream._responseOrigin)}catch(e){this._storedError=e,this.#bs(0)}}#ys(t){if(this._requests.length>0){this._requests.shift().resolve({value:t,done:!1})}else this._queuedChunk=t;this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this.onClosed?.()}#bs(t){this._storedError??=ud(t,this._stream.url);for(const e of this._requests)e.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}async read(){if(this._storedError)throw this._storedError;if(null!==this._queuedChunk){const t=this._queuedChunk;return this._queuedChunk=null,{value:t,done:!1}}if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._abortRequest(this._requestXhr),this.onClosed?.()}}const Sd=/^[a-z][a-z0-9\-+.]+:/i;function _d(t){const{Readable:e}=process.getBuiltinModule("stream");if("function"==typeof e.toWeb)return e.toWeb(t);return process.getBuiltinModule("module").createRequire(import.meta.url)("node-readable-to-web-readable-stream").makeDefaultReadableStreamFromNodeReadable(t)}function Td(t){return t instanceof Uint8Array?t.buffer:t instanceof ArrayBuffer?t:(Qa(`getArrayBuffer - unexpected data format: ${t}`),new Uint8Array(t).buffer)}class Ed extends ed{constructor(t){super(t,Cd,Md),this.url=function(t){if(Sd.test(t))return new URL(t);const e=process.getBuiltinModule("url");return new URL(e.pathToFileURL(t))}(t.url),tl("file:"===this.url.protocol,"PDFNodeStream only supports file:// URLs.")}}class Cd extends nd{_reader=null;constructor(t){super(t);const{disableRange:e,disableStream:n,length:i,rangeChunkSize:s}=t._source;this._contentLength=i,this._isStreamingSupported=!n,this._isRangeSupported=!e;const r=t.url,o=process.getBuiltinModule("fs");o.promises.lstat(r).then(t=>{const e=_d(o.createReadStream(r));this._reader=e.getReader();const{size:n}=t;n<=2*s&&(this._isRangeSupported=!1),this._contentLength=n,!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new hl("Streaming is disabled.")),this._headersCapability.resolve()}).catch(t=>{"ENOENT"===t.code&&(t=ud(0,r.href)),this._headersCapability.reject(t)})}async read(){await this._headersCapability.promise;const{value:t,done:e}=await this._reader.read();return e?{value:t,done:e}:(this._loaded+=t.length,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:Td(t),done:!1})}cancel(t){this._reader?.cancel(t)}}class Md extends id{_readCapability=Promise.withResolvers();_reader=null;constructor(t,e,n){super(t,e,n);const i=t.url,s=process.getBuiltinModule("fs");try{const t=_d(s.createReadStream(i,{start:e,end:n-1}));this._reader=t.getReader(),this._readCapability.resolve()}catch(r){this._readCapability.reject(r)}}async read(){await this._readCapability.promise;const{value:t,done:e}=await this._reader.read();return e?{value:t,done:e}:{value:Td(t),done:!1}}cancel(t){this._reader?.cancel(t)}}const kd=Symbol("INITIAL_DATA");class Dd{#ws=Object.create(null);#vs(t){return this.#ws[t]||={...Promise.withResolvers(),data:kd}}get(t,e=null){if(e){const n=this.#vs(t);return n.promise.then(()=>e(n.data)),null}const n=this.#ws[t];if(!n||n.data===kd)throw new Error(`Requesting object that isn't resolved yet ${t}.`);return n.data}has(t){const e=this.#ws[t];return!!e&&e.data!==kd}delete(t){const e=this.#ws[t];return!(!e||e.data===kd)&&(delete this.#ws[t],!0)}resolve(t,e=null){const n=this.#vs(t);n.data=e,n.resolve()}clear(){for(const t in this.#ws){const{data:e}=this.#ws[t];e?.bitmap?.close()}this.#ws=Object.create(null)}*[Symbol.iterator](){for(const t in this.#ws){const{data:e}=this.#ws[t];e!==kd&&(yield[t,e])}}}class Id{#As=Promise.withResolvers();#Nt=null;#xs=!1;#Ss=!!globalThis.FontInspector?.enabled;#_s=null;#Ts=null;#Es=0;#Cs=0;#Ms=null;#ks=null;#Ds=0;#Is=0;#Ns=Object.create(null);#Ps=[];#Os=null;#Rs=[];#Bs=new WeakMap;#Fs=null;static#Ls=new Map;static#zs=new Map;static#Vs=new WeakMap;static#Hs=null;static#$s=new Set;constructor({textContentSource:t,container:e,viewport:n}){if(t instanceof ReadableStream)this.#Os=t;else{if("object"!=typeof t)throw new Error('No "textContentSource" parameter specified.');this.#Os=new ReadableStream({start(e){e.enqueue(t),e.close()}})}this.#Nt=this.#ks=e,this.#Is=n.scale*Ll.pixelRatio,this.#Ds=n.rotation,this.#Ts={div:null,properties:null,ctx:null};const{pageWidth:i,pageHeight:s,pageX:r,pageY:o}=n.rawDims;this.#Fs=[1,0,0,-1,-r,o+s],this.#Cs=i,this.#Es=s,Id.#Us(),e.style.setProperty("--min-font-size",Id.#Hs),Fl(e,n),this.#As.promise.finally(()=>{Id.#$s.delete(this),this.#Ts=null,this.#Ns=null}).catch(()=>{})}static get fontFamilyMap(){const{isWindows:t,isFirefox:e}=ul.platform;return il(this,"fontFamilyMap",new Map([["sans-serif",(t&&e?"Calibri, ":"")+"sans-serif"],["monospace",(t&&e?"Lucida Console, ":"")+"monospace"]]))}render(){const t=()=>{this.#Ms.read().then(({value:e,done:n})=>{n?this.#As.resolve():(this.#_s??=e.lang,Object.assign(this.#Ns,e.styles),this.#Ws(e.items),t())},this.#As.reject)};return this.#Ms=this.#Os.getReader(),Id.#$s.add(this),t(),this.#As.promise}update({viewport:t,onBefore:e=null}){const n=t.scale*Ll.pixelRatio,i=t.rotation;if(i!==this.#Ds&&(e?.(),this.#Ds=i,Fl(this.#ks,{rotation:i})),n!==this.#Is){e?.(),this.#Is=n;const t={div:null,properties:null,ctx:Id.#Gs(this.#_s)};for(const e of this.#Rs)t.properties=this.#Bs.get(e),t.div=e,this.#js(t)}}cancel(){const t=new hl("TextLayer task cancelled.");this.#Ms?.cancel(t).catch(()=>{}),this.#Ms=null,this.#As.reject(t)}get textDivs(){return this.#Rs}get textContentItemsStr(){return this.#Ps}#Ws(t){if(this.#xs)return;this.#Ts.ctx??=Id.#Gs(this.#_s);const e=this.#Rs,n=this.#Ps;for(const i of t){if(e.length>1e5)return Qa("Ignoring additional textDivs for performance reasons."),void(this.#xs=!0);if(void 0!==i.str)n.push(i.str),this.#Ks(i);else if("beginMarkedContentProps"===i.type||"beginMarkedContent"===i.type){const t=this.#Nt;this.#Nt=document.createElement("span"),this.#Nt.classList.add("markedContent"),i.id&&this.#Nt.setAttribute("id",`${i.id}`),"Artifact"===i.tag&&(this.#Nt.ariaHidden=!0),t.append(this.#Nt)}else"endMarkedContent"===i.type&&(this.#Nt=this.#Nt.parentNode)}}#Ks(t){const e=document.createElement("span"),n={angle:0,canvasWidth:0,hasText:""!==t.str,hasEOL:t.hasEOL,fontSize:0};this.#Rs.push(e);const i=fl.transform(this.#Fs,t.transform);let s=Math.atan2(i[1],i[0]);const r=this.#Ns[t.fontName];r.vertical&&(s+=Math.PI/2);let o=this.#Ss&&r.fontSubstitution||r.fontFamily;o=Id.fontFamilyMap.get(o)||o;const a=Math.hypot(i[2],i[3]),l=a*Id.#qs(o,r,this.#_s);let c,h;0===s?(c=i[4],h=i[5]-l):(c=i[4]+l*Math.sin(s),h=i[5]-l*Math.cos(s));const d=e.style;d.left=`${(100*c/this.#Cs).toFixed(2)}%`,d.top=`${(100*h/this.#Es).toFixed(2)}%`,d.setProperty("--font-height",`${a.toFixed(2)}px`),d.fontFamily=o,n.fontSize=a,e.setAttribute("role","presentation"),e.textContent=t.str,e.dir=t.dir,this.#Ss&&(e.dataset.fontName=r.fontSubstitutionLoadedName||t.fontName),0!==s&&(n.angle=s*(180/Math.PI));let u=!1;if(t.str.length>1)u=!0;else if(" "!==t.str&&t.transform[0]!==t.transform[3]){const e=Math.abs(t.transform[0]),n=Math.abs(t.transform[3]);e!==n&&Math.max(e,n)/Math.min(e,n)>1.5&&(u=!0)}if(u&&(n.canvasWidth=r.vertical?t.height:t.width),this.#Bs.set(e,n),this.#Ts.div=e,this.#Ts.properties=n,this.#js(this.#Ts),n.hasText&&this.#Nt.append(e),n.hasEOL){const t=document.createElement("br");t.setAttribute("role","presentation"),this.#Nt.append(t)}}#js(t){const{div:e,properties:n,ctx:i}=t,{style:s}=e;if(0!==n.canvasWidth&&n.hasText){const{fontFamily:t}=s,{canvasWidth:r,fontSize:o}=n;Id.#Ys(i,o*this.#Is,t);const{width:a}=i.measureText(e.textContent);a>0&&s.setProperty("--scale-x",r*this.#Is/a)}0!==n.angle&&s.setProperty("--rotate",`${n.angle}deg`)}static cleanup(){if(!(this.#$s.size>0)){this.#Ls.clear();for(const{canvas:t}of this.#zs.values())t.remove();this.#zs.clear()}}static#Gs(t=null){let e=this.#zs.get(t||="");if(!e){const n=document.createElement("canvas");n.className="hiddenCanvasElement",n.lang=t,document.body.append(n),e=n.getContext("2d",{alpha:!1,willReadFrequently:!0}),this.#zs.set(t,e),this.#Vs.set(e,{size:0,family:""})}return e}static#Ys(t,e,n){const i=this.#Vs.get(t);e===i.size&&n===i.family||(t.font=`${e}px ${n}`,i.size=e,i.family=n)}static#Us(){if(null!==this.#Hs)return;const t=document.createElement("div");t.style.opacity=0,t.style.lineHeight=1,t.style.fontSize="1px",t.style.position="absolute",t.textContent="X",document.body.append(t),this.#Hs=t.getBoundingClientRect().height,t.remove()}static#qs(t,e,n){const i=this.#Ls.get(t);if(i)return i;const s=this.#Gs(n);s.canvas.width=s.canvas.height=30,this.#Ys(s,30,t);const r=s.measureText(""),o=r.fontBoundingBoxAscent,a=Math.abs(r.fontBoundingBoxDescent);s.canvas.width=s.canvas.height=0;let l=.8;return o?l=o/(o+a):(ul.platform.isFirefox&&Qa("Enable the `dom.textMetrics.fontBoundingBox.enabled` preference in `about:config` to improve TextLayer rendering."),e.ascent?l=e.ascent:e.descent&&(l=1+e.descent)),this.#Ls.set(t,l),l}}class Nd{static#hi=0;_capability=Promise.withResolvers();_transport=null;_worker=null;docId="d"+Nd.#hi++;destroyed=!1;onPassword=null;onProgress=null;get promise(){return this._capability.promise}async destroy(){this.destroyed=!0;try{this._worker?.port&&(this._worker._pendingDestroy=!0),await(this._transport?.destroy())}catch(t){throw this._worker?.port&&delete this._worker._pendingDestroy,t}this._transport=null,this._worker?.destroy(),this._worker=null}async getData(){return this._transport.getData()}}class Pd{#As=Promise.withResolvers();#Xs=[];#Js=[];#Qs=[];#Zs=[];constructor(t,e,n=!1,i=null){this.length=t,this.initialData=e,this.progressiveDone=n,this.contentDispositionFilename=i}addRangeListener(t){this.#Zs.push(t)}addProgressListener(t){this.#Qs.push(t)}addProgressiveReadListener(t){this.#Js.push(t)}addProgressiveDoneListener(t){this.#Xs.push(t)}onDataRange(t,e){for(const n of this.#Zs)n(t,e)}onDataProgress(t,e){this.#As.promise.then(()=>{for(const n of this.#Qs)n(t,e)})}onDataProgressiveRead(t){this.#As.promise.then(()=>{for(const e of this.#Js)e(t)})}onDataProgressiveDone(){this.#As.promise.then(()=>{for(const t of this.#Xs)t()})}transportReady(){this.#As.resolve()}requestDataRange(t,e){Za("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}class Od{constructor(t,e){this._pdfInfo=t,this._transport=e}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return il(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(t){return this._transport.getPage(t)}getPageIndex(t){return this._transport.getPageIndex(t)}getDestinations(){return this._transport.getDestinations()}getDestination(t){return this._transport.getDestination(t)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getAnnotationsByType(t,e){return this._transport.getAnnotationsByType(t,e)}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getOptionalContentConfig(e)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}extractPages(t){return this._transport.extractPages(t)}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(t=!1){return this._transport.startCleanup(t||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(t){return this._transport.cachedPageNumber(t)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}class Rd{#tr=!1;#er=ql.instance;constructor(t,e,n,i=!1){this._pageIndex=t,this._pageInfo=e,this._transport=n,this._stats=i?new kl:null,this._pdfBug=i,this.commonObjs=n.commonObjs,this.objs=new Dd,this._intentStates=new Map,this.destroyed=!1,this.recordedBBoxes=null}get pageNumber(){return this._pageIndex+1}set pageNumber(t){this._pageIndex=t-1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:t,rotation:e=this.rotate,offsetX:n=0,offsetY:i=0,dontFlip:s=!1}={}){return new Tl({viewBox:this.view,userUnit:this.userUnit,scale:t,rotation:e,offsetX:n,offsetY:i,dontFlip:s})}getAnnotations({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getAnnotations(this._pageIndex,e)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return il(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:t,canvas:e=t.canvas,viewport:n,intent:i="display",annotationMode:s=Sa.ENABLE,transform:r=null,background:o=null,optionalContentConfigPromise:a=null,annotationCanvasMap:l=null,pageColors:c=null,printAnnotationStorage:h=null,isEditing:d=!1,recordOperations:u=!1,operationsFilter:p=null}){this._stats?.time("Overall");const f=this._transport.getRenderingIntent(i,s,h,d),{renderingIntent:m,cacheKey:g}=f;this.#tr=!1,a||=this._transport.getOptionalContentConfig(m);let y=this._intentStates.get(g);y||(y=Object.create(null),this._intentStates.set(g,y)),y.streamReaderCancelTimeout&&(clearTimeout(y.streamReaderCancelTimeout),y.streamReaderCancelTimeout=null);const b=!!(m&ya);y.displayReadyCapability||(y.displayReadyCapability=Promise.withResolvers(),y.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(f));const w=Boolean(this._pdfBug&&globalThis.StepperManager?.enabled),v=!this.recordedBBoxes&&(u||w),A=t=>{if(y.renderTasks.delete(x),v){const t=x.gfx?.dependencyTracker.take();t&&(x.stepper&&x.stepper.setOperatorBBoxes(t,x.gfx.dependencyTracker.takeDebugMetadata()),u&&(this.recordedBBoxes=t))}b&&(this.#tr=!0),this.#nr(),t?(x.capability.reject(t),this._abortOperatorList({intentState:y,reason:t instanceof Error?t:new Error(t)})):x.capability.resolve(),this._stats&&(this._stats.timeEnd("Rendering"),this._stats.timeEnd("Overall"),globalThis.Stats?.enabled&&globalThis.Stats.add(this.pageNumber,this._stats))},x=new Vd({callback:A,params:{canvas:e,canvasContext:t,dependencyTracker:v?new hh(e,y.operatorList.length,w):null,viewport:n,transform:r,background:o},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:l,operatorList:y.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!b,pdfBug:this._pdfBug,pageColors:c,enableHWA:this._transport.enableHWA,operationsFilter:p});(y.renderTasks||=new Set).add(x);const S=x.task;return Promise.all([y.displayReadyCapability.promise,a]).then(([t,e])=>{if(this.destroyed)A();else{if(this._stats?.time("Rendering"),!(e.renderingIntent&m))throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` and `PDFDocumentProxy.getOptionalContentConfig` methods.");x.initializeGraphics({transparency:t,optionalContentConfig:e}),x.operatorListChanged()}}).catch(A),S}getOperatorList({intent:t="display",annotationMode:e=Sa.ENABLE,printAnnotationStorage:n=null,isEditing:i=!1}={}){const s=this._transport.getRenderingIntent(t,e,n,i,!0);let r,o=this._intentStates.get(s.cacheKey);return o||(o=Object.create(null),this._intentStates.set(s.cacheKey,o)),o.opListReadCapability||(r=Object.create(null),r.operatorListChanged=function(){o.operatorList.lastChunk&&(o.opListReadCapability.resolve(o.operatorList),o.renderTasks.delete(r))},o.opListReadCapability=Promise.withResolvers(),(o.renderTasks||=new Set).add(r),o.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(s)),o.opListReadCapability.promise}streamTextContent({includeMarkedContent:t=!1,disableNormalization:e=!1}={}){return this._transport.messageHandler.sendWithStream("GetTextContent",{pageId:this.#er.getPageId(this._pageIndex+1)-1,pageIndex:this._pageIndex,includeMarkedContent:!0===t,disableNormalization:!0===e},{highWaterMark:100,size:t=>t.items.length})}getTextContent(t={}){if(this._transport._htmlForXfa)return this.getXfa().then(t=>vl.textContent(t));const e=this.streamTextContent(t);return new Promise(function(t,n){const i=e.getReader(),s={items:[],styles:Object.create(null),lang:null};!function e(){i.read().then(function({value:n,done:i}){i?t(s):(s.lang??=n.lang,Object.assign(s.styles,n.styles),s.items.push(...n.items),e())},n)}()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;const t=[];for(const e of this._intentStates.values())if(this._abortOperatorList({intentState:e,reason:new Error("Page was destroyed."),force:!0}),!e.opListReadCapability)for(const n of e.renderTasks)t.push(n.completed),n.cancel();return this.objs.clear(),this.#tr=!1,Promise.all(t)}cleanup(t=!1){this.#tr=!0;const e=this.#nr();return t&&e&&(this._stats&&=new kl),e}#nr(){if(!this.#tr||this.destroyed)return!1;for(const{renderTasks:t,operatorList:e}of this._intentStates.values())if(t.size>0||!e.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),this.#tr=!1,!0}_startRenderPage(t,e){const n=this._intentStates.get(e);n&&(this._stats?.timeEnd("Page Request"),n.displayReadyCapability?.resolve(t))}_renderPageChunk(t,e){for(let n=0,i=t.length;n<i;n++)e.operatorList.fnArray.push(t.fnArray[n]),e.operatorList.argsArray.push(t.argsArray[n]);e.operatorList.lastChunk=t.lastChunk,e.operatorList.separateAnnots=t.separateAnnots;for(const n of e.renderTasks)n.operatorListChanged();t.lastChunk&&this.#nr()}_pumpOperatorList({renderingIntent:t,cacheKey:e,annotationStorageSerializable:n,modifiedIds:i}){const{map:s,transfer:r}=n,o=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageId:this.#er.getPageId(this._pageIndex+1)-1,pageIndex:this._pageIndex,intent:t,cacheKey:e,annotationStorage:s,modifiedIds:i},r).getReader(),a=this._intentStates.get(e);a.streamReader=o;const l=()=>{o.read().then(({value:t,done:e})=>{e?a.streamReader=null:this._transport.destroyed||(this._renderPageChunk(t,a),l())},t=>{if(a.streamReader=null,!this._transport.destroyed){if(a.operatorList){a.operatorList.lastChunk=!0;for(const t of a.renderTasks)t.operatorListChanged();this.#nr()}if(a.displayReadyCapability)a.displayReadyCapability.reject(t);else{if(!a.opListReadCapability)throw t;a.opListReadCapability.reject(t)}}})};l()}_abortOperatorList({intentState:t,reason:e,force:n=!1}){if(t.streamReader){if(t.streamReaderCancelTimeout&&(clearTimeout(t.streamReaderCancelTimeout),t.streamReaderCancelTimeout=null),!n){if(t.renderTasks.size>0)return;if(e instanceof El){let n=100;return e.extraDelay>0&&e.extraDelay<1e3&&(n+=e.extraDelay),void(t.streamReaderCancelTimeout=setTimeout(()=>{t.streamReaderCancelTimeout=null,this._abortOperatorList({intentState:t,reason:e,force:!0})},n))}}if(t.streamReader.cancel(new hl(e.message)).catch(()=>{}),t.streamReader=null,!this._transport.destroyed){for(const[e,n]of this._intentStates)if(n===t){this._intentStates.delete(e);break}this.cleanup()}}}get stats(){return this._stats}}const Bd=class s{constructor({name:r=null,port:l=null,verbosity:d=Xa()}={}){if(y(this,a),y(this,t,Promise.withResolvers()),y(this,e,null),y(this,n,null),y(this,i,null),this.name=r,this.destroyed=!1,this.verbosity=d,l){if(g(s,o).has(l))throw new Error("Cannot use more than one PDFWorker per port.");g(s,o).set(l,this),w(this,a,c).call(this,l)}else w(this,a,h).call(this)}get promise(){return g(this,t).promise}get port(){return g(this,n)}get messageHandler(){return g(this,e)}destroy(){this.destroyed=!0,g(this,i)?.terminate(),b(this,i,null),g(s,o).delete(g(this,n)),b(this,n,null),g(this,e)?.destroy(),b(this,e,null)}static create(t){const e=g(this,o).get(t?.port);if(e){if(e._pendingDestroy)throw new Error("PDFWorker.create - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return e}return new s(t)}static get workerSrc(){if(Xh.workerSrc)return Xh.workerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get _setupFakeWorkerGlobal(){return il(this,"_setupFakeWorkerGlobal",(async()=>{if(g(this,u,p))return g(this,u,p);return(await import(this.workerSrc)).WorkerMessageHandler})())}};t=new WeakMap,e=new WeakMap,n=new WeakMap,i=new WeakMap,s=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakSet,l=function(){g(this,t).resolve(),g(this,e).send("configure",{verbosity:this.verbosity})},c=function(t){b(this,n,t),b(this,e,new Vc("main","worker",t)),g(this,e).on("ready",()=>{}),w(this,a,l).call(this)},h=function(){if(g(Bd,r)||g(Bd,u,p))return void w(this,a,d).call(this);let{workerSrc:s}=Bd;try{Bd._isSameOrigin(window.location,s)||(s=Bd._createCDNWrapper(new URL(s,window.location).href));const r=new Worker(s,{type:"module"}),o=new Vc("main","worker",r),c=()=>{h.abort(),o.destroy(),r.terminate(),this.destroyed?g(this,t).reject(new Error("Worker was destroyed")):w(this,a,d).call(this)},h=new AbortController;r.addEventListener("error",()=>{g(this,i)||c()},{signal:h.signal}),o.on("test",t=>{h.abort(),!this.destroyed&&t?(b(this,e,o),b(this,n,r),b(this,i,r),w(this,a,l).call(this)):c()}),o.on("ready",t=>{if(h.abort(),this.destroyed)c();else try{u()}catch{w(this,a,d).call(this)}});const u=()=>{const t=new Uint8Array;o.send("test",t,[t.buffer])};return void u()}catch{Ja("The worker has been disabled.")}w(this,a,d).call(this)},d=function(){g(Bd,r)||(Qa("Setting up fake worker."),b(Bd,r,!0)),Bd._setupFakeWorkerGlobal.then(i=>{if(this.destroyed)return void g(this,t).reject(new Error("Worker was destroyed"));const r=new Cc;b(this,n,r);const o="fake"+(c=Bd,h=s,{set _(t){b(c,h,t,d)},get _(){return g(c,h,u)}})._++;var c,h,d,u;const p=new Vc(o+"_worker",o,r);i.setup(p,r),b(this,e,new Vc(o,o+"_worker",r)),w(this,a,l).call(this)}).catch(e=>{g(this,t).reject(new Error(`Setting up fake worker failed: "${e.message}".`))})},u=new WeakSet,p=function(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}},y(Bd,u),y(Bd,s,0),y(Bd,r,!1),y(Bd,o,new WeakMap),ua&&(b(Bd,r,!0),Xh.workerSrc||="./pdf.worker.mjs"),Bd._isSameOrigin=(t,e)=>{const n=URL.parse(t);if(!n?.origin||"null"===n.origin)return!1;const i=new URL(e,n);return n.origin===i.origin},Bd._createCDNWrapper=t=>{const e=`await import("${t}");`;return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))},Bd.fromPort=t=>{var e;if(e="`PDFWorker.fromPort` - please use `PDFWorker.create` instead.",console.log("Deprecated API usage: "+e),!t?.port)throw new Error("PDFWorker.fromPort - invalid method signature.");return Bd.create(t)};let Fd=Bd;class Ld{downloadInfoCapability=Promise.withResolvers();#ir=null;#sr=new Map;#rr=null;#or=new Map;#ar=new Map;#lr=new Map;#cr=null;#er=ql.instance;constructor(t,e,n,i,s){this.messageHandler=t,this.loadingTask=e,this.#rr=n,this.commonObjs=new Dd,this.fontLoader=new yc({ownerDocument:i.ownerDocument,styleElement:i.styleElement}),this.enableHWA=i.enableHWA,this.loadingParams=i.loadingParams,this._params=i,this.canvasFactory=s.canvasFactory,this.filterFactory=s.filterFactory,this.cMapReaderFactory=s.cMapReaderFactory,this.standardFontDataFactory=s.standardFontDataFactory,this.wasmFactory=s.wasmFactory,this.destroyed=!1,this.destroyCapability=null,this.setupMessageHandler(),this.#er.addListener(this.#hr.bind(this))}#hr(){const t=new Map,e=new Map;for(let n=0,i=this.#er.pagesNumber;n<i;n++){const i=this.#er.getPrevPageNumber(n+1)-1,s=this.#or.get(i);s&&t.set(n,s);const r=this.#ar.get(i);r&&e.set(n,r)}this.#or=t,this.#ar=e}#dr(t,e=null){const n=this.#sr.get(t);if(n)return n;const i=this.messageHandler.sendWithPromise(t,e);return this.#sr.set(t,i),i}#ms({loaded:t,total:e}){this.loadingTask.onProgress?.({loaded:t,total:e,percent:wl(Math.round(t/e*100),0,100)})}get annotationStorage(){return il(this,"annotationStorage",new mc)}getRenderingIntent(t,e=Sa.ENABLE,n=null,i=!1,s=!1){let r=ga,o=fc;switch(t){case"any":r=ma;break;case"display":break;case"print":r=ya;break;default:Qa(`getRenderingIntent - invalid intent: ${t}`)}const a=r&ya&&n instanceof gc?n:this.annotationStorage;switch(e){case Sa.DISABLE:r+=va;break;case Sa.ENABLE:break;case Sa.ENABLE_FORMS:r+=ba;break;case Sa.ENABLE_STORAGE:r+=wa,o=a.serializable;break;default:Qa(`getRenderingIntent - invalid annotationMode: ${e}`)}i&&(r+=Aa),s&&(r+=xa);const{ids:l,hash:c}=a.modifiedIds;return{renderingIntent:r,cacheKey:[r,o.hash,c].join("_"),annotationStorageSerializable:o,modifiedIds:l}}destroy(){if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=Promise.withResolvers(),this.#cr?.reject(new Error("Worker was destroyed during onPassword callback"));const t=[];for(const n of this.#or.values())t.push(n._destroy());this.#or.clear(),this.#ar.clear(),this.#lr.clear(),this.hasOwnProperty("annotationStorage")&&this.annotationStorage.resetModified();const e=this.messageHandler.sendWithPromise("Terminate",null);return t.push(e),Promise.all(t).then(()=>{this.commonObjs.clear(),this.fontLoader.clear(),this.#sr.clear(),this.filterFactory.destroy(),Id.cleanup(),this.#rr?.cancelAllRequests(new hl("Worker was terminated.")),this.messageHandler?.destroy(),this.messageHandler=null,this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){const{messageHandler:t,loadingTask:e}=this;t.on("GetReader",(t,e)=>{tl(this.#rr,"GetReader - no `BasePDFStream` instance available."),this.#ir=this.#rr.getFullReader(),this.#ir.onProgress=t=>this.#ms(t),e.onPull=()=>{this.#ir.read().then(function({value:t,done:n}){n?e.close():(tl(t instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer."),e.enqueue(new Uint8Array(t),1,[t]))}).catch(t=>{e.error(t)})},e.onCancel=t=>{this.#ir.cancel(t),e.ready.catch(t=>{if(!this.destroyed)throw t})}}),t.on("ReaderHeadersReady",async t=>{await this.#ir.headersReady;const{isStreamingSupported:e,isRangeSupported:n,contentLength:i}=this.#ir;return e&&n&&(this.#ir.onProgress=null),{isStreamingSupported:e,isRangeSupported:n,contentLength:i}}),t.on("GetRangeReader",(t,e)=>{tl(this.#rr,"GetRangeReader - no `BasePDFStream` instance available.");const n=this.#rr.getRangeReader(t.begin,t.end);n?(e.onPull=()=>{n.read().then(function({value:t,done:n}){n?e.close():(tl(t instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer."),e.enqueue(new Uint8Array(t),1,[t]))}).catch(t=>{e.error(t)})},e.onCancel=t=>{n.cancel(t),e.ready.catch(t=>{if(!this.destroyed)throw t})}):e.close()}),t.on("GetDoc",({pdfInfo:t})=>{this.#er.pagesNumber=t.numPages,this._numPages=t.numPages,this._htmlForXfa=t.htmlForXfa,delete t.htmlForXfa,e._capability.resolve(new Od(t,this))}),t.on("DocException",t=>{e._capability.reject(zc(t))}),t.on("PasswordRequest",t=>{this.#cr=Promise.withResolvers();try{if(!e.onPassword)throw zc(t);const n=t=>{t instanceof Error?this.#cr.reject(t):this.#cr.resolve({password:t})};e.onPassword(n,t.code)}catch(n){this.#cr.reject(n)}return this.#cr.promise}),t.on("DataLoaded",t=>{this.#ms({loaded:t.length,total:t.length}),this.downloadInfoCapability.resolve(t)}),t.on("StartRenderPage",t=>{if(this.destroyed)return;this.#or.get(t.pageIndex)._startRenderPage(t.transparency,t.cacheKey)}),t.on("commonobj",([e,n,i])=>{if(this.destroyed)return null;if(this.commonObjs.has(e))return null;switch(n){case"Font":if("error"in i){const t=i.error;Qa(`Error during font loading: ${t}`),this.commonObjs.resolve(e,t);break}const s=new Ac(i),r=this._params.pdfBug&&globalThis.FontInspector?.enabled?(t,e)=>globalThis.FontInspector.fontAdded(t,e):null,o=new bc(s,r,i.extra,i.charProcOperatorList);this.fontLoader.bind(o).catch(()=>t.sendWithPromise("FontFallback",{id:e})).finally(()=>{!o.fontExtraProperties&&o.data&&o.clearData(),this.commonObjs.resolve(e,o)});break;case"CopyLocalImage":const{imageRef:a}=i;tl(a,"The imageRef must be defined.");for(const t of this.#or.values())for(const[,n]of t.objs)if(n?.ref===a)return n.dataLen?(this.commonObjs.resolve(e,structuredClone(n)),n.dataLen):null;break;case"FontPath":this.commonObjs.resolve(e,new Sc(i));break;case"Image":this.commonObjs.resolve(e,i);break;case"Pattern":const l=new xc(i);this.commonObjs.resolve(e,l.getIR());break;default:throw new Error(`Got unknown common object type ${n}`)}return null}),t.on("obj",([t,e,n,i])=>{if(this.destroyed)return;const s=this.#or.get(e);if(!s.objs.has(t))if(0!==s._intentStates.size)switch(n){case"Image":case"Pattern":s.objs.resolve(t,i);break;default:throw new Error(`Got unknown object type ${n}`)}else i?.bitmap?.close()}),t.on("DocProgress",t=>{this.destroyed||this.#ms(t)}),t.on("FetchBinaryData",async t=>{if(this.destroyed)throw new Error("Worker was destroyed.");const e=this[t.type];if(!e)throw new Error(`${t.type} not initialized, see the \`useWorkerFetch\` parameter.`);return e.fetch(t)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){this.annotationStorage.size<=0&&Qa("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");const{map:t,transfer:e}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:t,filename:this.#ir?.filename??null},e).finally(()=>{this.annotationStorage.resetModified()})}extractPages(t){return this.messageHandler.sendWithPromise("ExtractPages",{pageInfos:t})}getPage(t){if(!Number.isInteger(t)||t<=0||t>this.#er.pagesNumber)return Promise.reject(new Error("Invalid page request."));const e=t-1,n=this.#er.getPageId(t)-1,i=this.#ar.get(e);if(i)return i;const s=this.messageHandler.sendWithPromise("GetPage",{pageIndex:n}).then(t=>{if(this.destroyed)throw new Error("Transport destroyed");t.refStr&&this.#lr.set(t.refStr,n);const i=new Rd(e,t,this,this._params.pdfBug);return this.#or.set(e,i),i});return this.#ar.set(e,s),s}async getPageIndex(t){if(!Tc(t))throw new Error("Invalid pageIndex request.");const e=await this.messageHandler.sendWithPromise("GetPageIndex",{num:t.num,gen:t.gen});return this.#er.getPageNumber(e+1)-1}getAnnotations(t,e){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:this.#er.getPageId(t+1)-1,intent:e})}getFieldObjects(){return this.#dr("GetFieldObjects")}hasJSActions(){return this.#dr("HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(t){return"string"!=typeof t?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id:t})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getAnnotationsByType(t,e){return this.messageHandler.sendWithPromise("GetAnnotationsByType",{types:t,pageIndexesToSkip:e})}getDocJSActions(){return this.#dr("GetDocJSActions")}getPageJSActions(t){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:this.#er.getPageId(t+1)-1})}getStructTree(t){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:this.#er.getPageId(t+1)-1})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(t){return this.#dr("GetOptionalContentConfig").then(e=>new td(e,t))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const t="GetMetadata",e=this.#sr.get(t);if(e)return e;const n=this.messageHandler.sendWithPromise(t,null).then(t=>({info:t[0],metadata:t[1]?new Jh(t[1]):null,contentDispositionFilename:this.#ir?.filename??null,contentLength:this.#ir?.contentLength??null,hasStructTree:t[2]}));return this.#sr.set(t,n),n}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(t=!1){if(!this.destroyed){await this.messageHandler.sendWithPromise("Cleanup",null);for(const t of this.#or.values()){if(!t.cleanup())throw new Error(`startCleanup: Page ${t.pageNumber} is currently rendering.`)}this.commonObjs.clear(),t||this.fontLoader.clear(),this.#sr.clear(),this.filterFactory.destroy(!0),Id.cleanup()}}cachedPageNumber(t){if(!Tc(t))return null;const e=0===t.gen?`${t.num}R`:`${t.num}R${t.gen}`,n=this.#lr.get(e);return n>=0?this.#er.getPageNumber(n+1):null}}class zd{_internalRenderTask=null;onContinue=null;onError=null;constructor(t){this._internalRenderTask=t}get promise(){return this._internalRenderTask.capability.promise}cancel(t=0){this._internalRenderTask.cancel(null,t)}get separateAnnots(){const{separateAnnots:t}=this._internalRenderTask.operatorList;if(!t)return!1;const{annotationCanvasMap:e}=this._internalRenderTask;return t.form||t.canvas&&e?.size>0}}class Vd{#ur=null;static#pr=new WeakSet;constructor({callback:t,params:e,objs:n,commonObjs:i,annotationCanvasMap:s,operatorList:r,pageIndex:o,canvasFactory:a,filterFactory:l,useRequestAnimationFrame:c=!1,pdfBug:h=!1,pageColors:d=null,enableHWA:u=!1,operationsFilter:p=null}){this.callback=t,this.params=e,this.objs=n,this.commonObjs=i,this.annotationCanvasMap=s,this.operatorListIdx=null,this.operatorList=r,this._pageIndex=o,this.canvasFactory=a,this.filterFactory=l,this._pdfBug=h,this.pageColors=d,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=!0===c&&"undefined"!=typeof window,this.cancelled=!1,this.capability=Promise.withResolvers(),this.task=new zd(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=e.canvas,this._canvasContext=e.canvas?null:e.canvasContext,this._enableHWA=u,this._dependencyTracker=e.dependencyTracker,this._operationsFilter=p}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:t=!1,optionalContentConfig:e}){if(this.cancelled)return;if(this._canvas){if(Vd.#pr.has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");Vd.#pr.add(this._canvas)}this._pdfBug&&globalThis.StepperManager?.enabled&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());const{viewport:n,transform:i,background:s,dependencyTracker:r}=this.params,o=this._canvasContext||this._canvas.getContext("2d",{alpha:!1,willReadFrequently:!this._enableHWA});this.gfx=new Yh(o,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:e},this.annotationCanvasMap,this.pageColors,r),this.gfx.beginDrawing({transform:i,viewport:n,transparency:t,background:s}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback?.()}cancel(t=null,e=0){this.running=!1,this.cancelled=!0,this.gfx?.endDrawing(),this.#ur&&(window.cancelAnimationFrame(this.#ur),this.#ur=null),Vd.#pr.delete(this._canvas),t||=new El(`Rendering cancelled, page ${this._pageIndex+1}`,e),this.callback(t),this.task.onError?.(t)}operatorListChanged(){this.graphicsReady?(this.gfx.dependencyTracker?.growOperationsCount(this.operatorList.fnArray.length),this.stepper?.updateOperatorList(this.operatorList),this.running||this._continue()):this.graphicsReadyCallback||=this._continueBound}_continue(){this.running=!0,this.cancelled||(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())}_scheduleNext(){this._useRequestAnimationFrame?this.#ur=window.requestAnimationFrame(()=>{this.#ur=null,this._nextBound().catch(this._cancelBound)}):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){this.cancelled||(this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper,this._operationsFilter),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),Vd.#pr.delete(this._canvas),this.callback())))}}class Hd{#fr=null;#mr=null;#gr;#yr=null;#br=!1;#wr=!1;#u=null;#vr;#Ar=null;#_=null;static#xr=null;static get _keyboardManager(){return il(this,"_keyboardManager",new nc([[["Escape","mac+Escape"],Hd.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],Hd.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],Hd.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],Hd.prototype._moveToPrevious],[["Home","mac+Home"],Hd.prototype._moveToBeginning],[["End","mac+End"],Hd.prototype._moveToEnd]]))}constructor({editor:t=null,uiManager:e=null}){t?(this.#wr=!1,this.#u=t):this.#wr=!0,this.#_=t?._uiManager||e,this.#vr=this.#_._eventBus,this.#gr=t?.color?.toUpperCase()||this.#_?.highlightColors.values().next().value||"#FFFF98",Hd.#xr||=Object.freeze({blue:"pdfjs-editor-colorpicker-blue",green:"pdfjs-editor-colorpicker-green",pink:"pdfjs-editor-colorpicker-pink",red:"pdfjs-editor-colorpicker-red",yellow:"pdfjs-editor-colorpicker-yellow"})}renderButton(){const t=this.#fr=document.createElement("button");t.className="colorPicker",t.tabIndex="0",t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button"),t.ariaHasPopup="true",this.#u&&(t.ariaControls=`${this.#u.id}_colorpicker_dropdown`);const e=this.#_._signal;t.addEventListener("click",this.#Sr.bind(this),{signal:e}),t.addEventListener("keydown",this.#_r.bind(this),{signal:e});const n=this.#mr=document.createElement("span");return n.className="swatch",n.ariaHidden="true",n.style.backgroundColor=this.#gr,t.append(n),t}renderMainDropdown(){const t=this.#yr=this.#Tr();return t.ariaOrientation="horizontal",t.ariaLabelledBy="highlightColorPickerLabel",t}#Tr(){const t=document.createElement("div"),e=this.#_._signal;t.addEventListener("contextmenu",Il,{signal:e}),t.className="dropdown",t.role="listbox",t.ariaMultiSelectable="false",t.ariaOrientation="vertical",t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown"),this.#u&&(t.id=`${this.#u.id}_colorpicker_dropdown`);for(const[n,i]of this.#_.highlightColors){const s=document.createElement("button");s.tabIndex="0",s.role="option",s.setAttribute("data-color",i),s.title=n,s.setAttribute("data-l10n-id",Hd.#xr[n]);const r=document.createElement("span");s.append(r),r.className="swatch",r.style.backgroundColor=i,s.ariaSelected=i===this.#gr,s.addEventListener("click",this.#Er.bind(this,i),{signal:e}),t.append(s)}return t.addEventListener("keydown",this.#_r.bind(this),{signal:e}),t}#Er(t,e){e.stopPropagation(),this.#vr.dispatch("switchannotationeditorparams",{source:this,type:Ea.HIGHLIGHT_COLOR,value:t}),this.updateColor(t)}_colorSelectFromKeyboard(t){if(t.target===this.#fr)return void this.#Sr(t);const e=t.target.getAttribute("data-color");e&&this.#Er(e,t)}_moveToNext(t){this.#Cr?t.target!==this.#fr?t.target.nextSibling?.focus():this.#yr.firstElementChild?.focus():this.#Sr(t)}_moveToPrevious(t){t.target!==this.#yr?.firstElementChild&&t.target!==this.#fr?(this.#Cr||this.#Sr(t),t.target.previousSibling?.focus()):this.#Cr&&this._hideDropdownFromKeyboard()}_moveToBeginning(t){this.#Cr?this.#yr.firstElementChild?.focus():this.#Sr(t)}_moveToEnd(t){this.#Cr?this.#yr.lastElementChild?.focus():this.#Sr(t)}#_r(t){Hd._keyboardManager.exec(this,t)}#Sr(t){if(this.#Cr)return void this.hideDropdown();if(this.#br=0===t.detail,this.#Ar||(this.#Ar=new AbortController,window.addEventListener("pointerdown",this.#w.bind(this),{signal:this.#_.combinedSignal(this.#Ar)})),this.#fr.ariaExpanded="true",this.#yr)return void this.#yr.classList.remove("hidden");const e=this.#yr=this.#Tr();this.#fr.append(e)}#w(t){this.#yr?.contains(t.target)||this.hideDropdown()}hideDropdown(){this.#yr?.classList.add("hidden"),this.#fr.ariaExpanded="false",this.#Ar?.abort(),this.#Ar=null}get#Cr(){return this.#yr&&!this.#yr.classList.contains("hidden")}_hideDropdownFromKeyboard(){this.#wr||(this.#Cr?(this.hideDropdown(),this.#fr.focus({preventScroll:!0,focusVisible:this.#br})):this.#u?.unselect())}updateColor(t){if(this.#mr&&(this.#mr.style.backgroundColor=t),!this.#yr)return;const e=this.#_.highlightColors.values();for(const n of this.#yr.children)n.ariaSelected=e.next().value===t.toUpperCase()}destroy(){this.#fr?.remove(),this.#fr=null,this.#mr=null,this.#yr?.remove(),this.#yr=null}}class $d{#Mr=null;#u=null;#_=null;static#xr=null;constructor(t){this.#u=t,this.#_=t._uiManager,$d.#xr||=Object.freeze({freetext:"pdfjs-editor-color-picker-free-text-input",ink:"pdfjs-editor-color-picker-ink-input"})}renderButton(){if(this.#Mr)return this.#Mr;const{editorType:t,colorType:e,color:n}=this.#u,i=this.#Mr=document.createElement("input");return i.type="color",i.value=n||"#000000",i.className="basicColorPicker",i.tabIndex=0,i.setAttribute("data-l10n-id",$d.#xr[t]),i.addEventListener("input",()=>{this.#_.updateParams(e,i.value)},{signal:this.#_._signal}),i}update(t){this.#Mr&&(this.#Mr.value=t)}destroy(){this.#Mr?.remove(),this.#Mr=null}hideDropdown(){}}function Ud(t){return Math.floor(255*Math.max(0,Math.min(1,t))).toString(16).padStart(2,"0")}function Wd(t){return Math.max(0,Math.min(255,255*t))}class Gd{static CMYK_G([t,e,n,i]){return["G",1-Math.min(1,.3*t+.59*n+.11*e+i)]}static G_CMYK([t]){return["CMYK",0,0,0,1-t]}static G_RGB([t]){return["RGB",t,t,t]}static G_rgb([t]){return[t=Wd(t),t,t]}static G_HTML([t]){const e=Ud(t);return`#${e}${e}${e}`}static RGB_G([t,e,n]){return["G",.3*t+.59*e+.11*n]}static RGB_rgb(t){return t.map(Wd)}static RGB_HTML(t){return`#${t.map(Ud).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([t,e,n,i]){return["RGB",1-Math.min(1,t+i),1-Math.min(1,n+i),1-Math.min(1,e+i)]}static CMYK_rgb([t,e,n,i]){return[Wd(1-Math.min(1,t+i)),Wd(1-Math.min(1,n+i)),Wd(1-Math.min(1,e+i))]}static CMYK_HTML(t){const e=this.CMYK_RGB(t).slice(1);return this.RGB_HTML(e)}static RGB_CMYK([t,e,n]){const i=1-t,s=1-e,r=1-n;return["CMYK",i,s,r,Math.min(i,s,r)]}}class jd{create(t,e,n=!1){if(t<=0||e<=0)throw new Error("Invalid SVG dimensions");const i=this._createSVG("svg:svg");return i.setAttribute("version","1.1"),n||(i.setAttribute("width",`${t}px`),i.setAttribute("height",`${e}px`)),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("viewBox",`0 0 ${t} ${e}`),i}createElement(t){if("string"!=typeof t)throw new Error("Invalid SVG element type");return this._createSVG(t)}_createSVG(t){Za("Abstract method `_createSVG` called.")}}class Kd extends jd{_createSVG(t){return document.createElementNS(xl,t)}}const qd=new WeakSet,Yd=60*(new Date).getTimezoneOffset()*1e3;class Xd{static create(t){switch(t.data.annotationType){case Ba.LINK:return new Zd(t);case Ba.TEXT:return new tu(t);case Ba.WIDGET:switch(t.data.fieldType){case"Tx":return new nu(t);case"Btn":return t.data.radioButton?new ru(t):t.data.checkBox?new su(t):new ou(t);case"Ch":return new au(t);case"Sig":return new iu(t)}return new eu(t);case Ba.POPUP:return new lu(t);case Ba.FREETEXT:return new hu(t);case Ba.LINE:return new du(t);case Ba.SQUARE:return new uu(t);case Ba.CIRCLE:return new pu(t);case Ba.POLYLINE:return new fu(t);case Ba.CARET:return new gu(t);case Ba.INK:return new yu(t);case Ba.POLYGON:return new mu(t);case Ba.HIGHLIGHT:return new bu(t);case Ba.UNDERLINE:return new wu(t);case Ba.SQUIGGLY:return new vu(t);case Ba.STRIKEOUT:return new Au(t);case Ba.STAMP:return new xu(t);case Ba.FILEATTACHMENT:return new Su(t);default:return new Jd(t)}}}class Jd{#kr=null;#Dr=!1;#Ir=null;constructor(t,{isRenderable:e=!1,ignoreBorder:n=!1,createQuadrilaterals:i=!1}={}){this.isRenderable=e,this.data=t.data,this.layer=t.layer,this.linkService=t.linkService,this.downloadManager=t.downloadManager,this.imageResourcesPath=t.imageResourcesPath,this.renderForms=t.renderForms,this.svgFactory=t.svgFactory,this.annotationStorage=t.annotationStorage,this.enableComment=t.enableComment,this.enableScripting=t.enableScripting,this.hasJSActions=t.hasJSActions,this._fieldObjects=t.fieldObjects,this.parent=t.parent,this.hasOwnCommentButton=!1,e&&(this.contentElement=this.container=this._createContainer(n)),i&&this._createQuadrilaterals()}static _hasPopupData({contentsObj:t,richText:e}){return!(!t?.str&&!e?.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return Jd._hasPopupData(this.data)||this.enableComment&&!!this.commentText}get commentData(){const{data:t}=this,e=this.annotationStorage?.getEditor(t.id);return e?e.getData():t}get hasCommentButton(){return this.enableComment&&this.hasPopupElement}get commentButtonPosition(){const t=this.annotationStorage?.getEditor(this.data.id);if(t)return t.commentButtonPositionInPage;const{quadPoints:e,inkLists:n,rect:i}=this.data;let s=-1/0,r=-1/0;if(e?.length>=8){for(let t=0;t<e.length;t+=8)e[t+1]>r?(r=e[t+1],s=e[t+2]):e[t+1]===r&&(s=Math.max(s,e[t+2]));return[s,r]}if(n?.length>=1){for(const t of n)for(let e=0,n=t.length;e<n;e+=2)t[e+1]>r?(r=t[e+1],s=t[e]):t[e+1]===r&&(s=Math.max(s,t[e]));if(s!==1/0)return[s,r]}return i?[i[2],i[3]]:null}_normalizePoint(t){const{page:{view:e},viewport:{rawDims:{pageWidth:n,pageHeight:i,pageX:s,pageY:r}}}=this.parent;return t[1]=e[3]-t[1]+e[1],t[0]=100*(t[0]-s)/n,t[1]=100*(t[1]-r)/i,t}get commentText(){const{data:t}=this;return this.annotationStorage.getRawValue(`${_a}${t.id}`)?.popup?.contents||t.contentsObj?.str||""}set commentText(t){const{data:e}=this,n={deleted:!t,contents:t||""};this.annotationStorage.updateEditor(e.id,{popup:n})||this.annotationStorage.setValue(`${_a}${e.id}`,{id:e.id,annotationType:e.annotationType,page:this.parent.page,popup:n,popupRef:e.popupRef,modificationDate:new Date}),t||this.removePopup()}removePopup(){(this.#Ir?.popup||this.popup)?.remove(),this.#Ir=this.popup=null}updateEdited(t){if(!this.container)return;t.rect&&(this.#kr||={rect:this.data.rect.slice(0)});const{rect:e,popup:n}=t;e&&this.#Nr(e);let i=this.#Ir?.popup||this.popup;!i&&n?.text&&(this._createPopup(n),i=this.#Ir.popup),i&&(i.updateEdited(t),n?.deleted&&(i.remove(),this.#Ir=null,this.popup=null))}resetEdited(){this.#kr&&(this.#Nr(this.#kr.rect),this.#Ir?.popup.resetEdited(),this.#kr=null)}#Nr(t){const{container:{style:e},data:{rect:n,rotation:i},parent:{viewport:{rawDims:{pageWidth:s,pageHeight:r,pageX:o,pageY:a}}}}=this;n?.splice(0,4,...t),e.left=100*(t[0]-o)/s+"%",e.top=100*(r-t[3]+a)/r+"%",0===i?(e.width=100*(t[2]-t[0])/s+"%",e.height=100*(t[3]-t[1])/r+"%"):this.setRotation(i)}_createContainer(t){const{data:e,parent:{page:n,viewport:i}}=this,s=document.createElement("section");s.setAttribute("data-annotation-id",e.id),this instanceof eu||this instanceof Zd||(s.tabIndex=0);const{style:r}=s;if(r.zIndex=this.parent.zIndex,this.parent.zIndex+=2,e.alternativeText&&(s.title=e.alternativeText),e.noRotate&&s.classList.add("norotate"),!e.rect||this instanceof lu){const{rotation:t}=e;return e.hasOwnCanvas||0===t||this.setRotation(t,s),s}const{width:o,height:a}=this;if(!t&&e.borderStyle.width>0){r.borderWidth=`${e.borderStyle.width}px`;const t=e.borderStyle.horizontalCornerRadius,n=e.borderStyle.verticalCornerRadius;if(t>0||n>0){const e=`calc(${t}px * var(--total-scale-factor)) / calc(${n}px * var(--total-scale-factor))`;r.borderRadius=e}else if(this instanceof ru){const t=`calc(${o}px * var(--total-scale-factor)) / calc(${a}px * var(--total-scale-factor))`;r.borderRadius=t}switch(e.borderStyle.style){case Fa:r.borderStyle="solid";break;case La:r.borderStyle="dashed";break;case za:Qa("Unimplemented border style: beveled");break;case Va:Qa("Unimplemented border style: inset");break;case Ha:r.borderBottomStyle="solid"}const i=e.borderColor||null;i?(this.#Dr=!0,r.borderColor=fl.makeHexColor(0|i[0],0|i[1],0|i[2])):r.borderWidth=0}const l=fl.normalizeRect([e.rect[0],n.view[3]-e.rect[1]+n.view[1],e.rect[2],n.view[3]-e.rect[3]+n.view[1]]),{pageWidth:c,pageHeight:h,pageX:d,pageY:u}=i.rawDims;r.left=100*(l[0]-d)/c+"%",r.top=100*(l[1]-u)/h+"%";const{rotation:p}=e;return e.hasOwnCanvas||0===p?(r.width=100*o/c+"%",r.height=100*a/h+"%"):this.setRotation(p,s),s}setRotation(t,e=this.container){if(!this.data.rect)return;const{pageWidth:n,pageHeight:i}=this.parent.viewport.rawDims;let{width:s,height:r}=this;t%180!=0&&([s,r]=[r,s]),e.style.width=100*s/n+"%",e.style.height=100*r/i+"%",e.setAttribute("data-main-rotation",(360-t)%360)}get _commonActions(){const t=(t,e,n)=>{const i=n.detail[t],s=i[0],r=i.slice(1);n.target.style[e]=Gd[`${s}_HTML`](r),this.annotationStorage.setValue(this.data.id,{[e]:Gd[`${s}_rgb`](r)})};return il(this,"_commonActions",{display:t=>{const{display:e}=t.detail,n=e%2==1;this.container.style.visibility=n?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noView:n,noPrint:1===e||2===e})},print:t=>{this.annotationStorage.setValue(this.data.id,{noPrint:!t.detail.print})},hidden:t=>{const{hidden:e}=t.detail;this.container.style.visibility=e?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noPrint:e,noView:e})},focus:t=>{setTimeout(()=>t.target.focus({preventScroll:!1}),0)},userName:t=>{t.target.title=t.detail.userName},readonly:t=>{t.target.disabled=t.detail.readonly},required:t=>{this._setRequired(t.target,t.detail.required)},bgColor:e=>{t("bgColor","backgroundColor",e)},fillColor:e=>{t("fillColor","backgroundColor",e)},fgColor:e=>{t("fgColor","color",e)},textColor:e=>{t("textColor","color",e)},borderColor:e=>{t("borderColor","borderColor",e)},strokeColor:e=>{t("strokeColor","borderColor",e)},rotation:t=>{const e=t.detail.rotation;this.setRotation(e),this.annotationStorage.setValue(this.data.id,{rotation:e})}})}_dispatchEventFromSandbox(t,e){const n=this._commonActions;for(const i of Object.keys(e.detail)){const s=t[i]||n[i];s?.(e)}}_setDefaultPropertiesFromJS(t){if(!this.enableScripting)return;const e=this.annotationStorage.getRawValue(this.data.id);if(!e)return;const n=this._commonActions;for(const[i,s]of Object.entries(e)){const r=n[i];if(r){r({detail:{[i]:s},target:t}),delete e[i]}}}_createQuadrilaterals(){if(!this.container)return;const{quadPoints:t}=this.data;if(!t)return;const[e,n,i,s]=this.data.rect.map(t=>Math.fround(t));if(8===t.length){const[r,o,a,l]=t.subarray(2,6);if(i===r&&s===o&&e===a&&n===l)return}const{style:r}=this.container;let o;if(this.#Dr){const{borderColor:t,borderWidth:e}=r;r.borderWidth=0,o=["url('data:image/svg+xml;utf8,",'<svg xmlns="http://www.w3.org/2000/svg"',' preserveAspectRatio="none" viewBox="0 0 1 1">',`<g fill="transparent" stroke="${t}" stroke-width="${e}">`],this.container.classList.add("hasBorder")}const a=i-e,l=s-n,{svgFactory:c}=this,h=c.createElement("svg");h.classList.add("quadrilateralsContainer"),h.setAttribute("width",0),h.setAttribute("height",0),h.role="none";const d=c.createElement("defs");h.append(d);const u=c.createElement("clipPath"),p=`clippath_${this.data.id}`;u.setAttribute("id",p),u.setAttribute("clipPathUnits","objectBoundingBox"),d.append(u);for(let f=2,m=t.length;f<m;f+=8){const n=t[f],i=t[f+1],r=t[f+2],h=t[f+3],d=c.createElement("rect"),p=(r-e)/a,m=(s-i)/l,g=(n-r)/a,y=(i-h)/l;d.setAttribute("x",p),d.setAttribute("y",m),d.setAttribute("width",g),d.setAttribute("height",y),u.append(d),o?.push(`<rect vector-effect="non-scaling-stroke" x="${p}" y="${m}" width="${g}" height="${y}"/>`)}this.#Dr&&(o.push("</g></svg>')"),r.backgroundImage=o.join("")),this.container.append(h),this.container.style.clipPath=`url(#${p})`}_createPopup(t=null){const{data:e}=this;let n,i;t?(n={str:t.text},i=t.date):(n=e.contentsObj,i=e.modificationDate),this.#Ir=new lu({data:{color:e.color,titleObj:e.titleObj,modificationDate:i,contentsObj:n,richText:e.richText,parentRect:e.rect,borderStyle:0,id:`popup_${e.id}`,rotation:e.rotation,noRotate:!0},linkService:this.linkService,parent:this.parent,elements:[this]})}get hasPopupElement(){return!!(this.#Ir||this.popup||this.data.popupRef)}get extraPopupElement(){return this.#Ir}render(){Za("Abstract method `AnnotationElement.render` called")}_getElementsByName(t,e=null){const n=[];if(this._fieldObjects){const i=this._fieldObjects[t];if(i)for(const{page:t,id:s,exportValues:r}of i){if(-1===t)continue;if(s===e)continue;const i="string"==typeof r?r:null,o=document.querySelector(`[data-element-id="${s}"]`);!o||qd.has(o)?n.push({id:s,exportValue:i,domElement:o}):Qa(`_getElementsByName - element not allowed: ${s}`)}return n}for(const i of document.getElementsByName(t)){const{exportValue:t}=i,s=i.getAttribute("data-element-id");s!==e&&(qd.has(i)&&n.push({id:s,exportValue:t,domElement:i}))}return n}show(){this.container&&(this.container.hidden=!1),this.popup?.maybeShow()}hide(){this.container&&(this.container.hidden=!0),this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const t=this.getElementsToTriggerPopup();if(Array.isArray(t))for(const e of t)e.classList.add("highlightArea");else t.classList.add("highlightArea")}_editOnDoubleClick(){if(!this._isEditable)return;const{annotationEditorType:t,data:{id:e}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode:t,editId:e,mustEnterInEditMode:!0})})}get width(){return this.data.rect[2]-this.data.rect[0]}get height(){return this.data.rect[3]-this.data.rect[1]}}class Qd extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.editor=t.editor}render(){return this.container.className="editorAnnotation",this.container}createOrUpdatePopup(){const{editor:t}=this;t.hasComment&&this._createPopup(t.comment)}get hasCommentButton(){return this.enableComment&&this.editor.hasComment}get commentButtonPosition(){return this.editor.commentButtonPositionInPage}get commentText(){return this.editor.comment.text}set commentText(t){this.editor.comment=t,t||this.removePopup()}get commentData(){return this.editor.getData()}remove(){this.parent.removeAnnotation(this.data.id),this.container.remove(),this.container=null,this.removePopup()}}class Zd extends Jd{constructor(t,e=null){super(t,{isRenderable:!0,ignoreBorder:!!e?.ignoreBorder,createQuadrilaterals:!0}),this.isTooltipOnly=t.data.isTooltipOnly}render(){const{data:t,linkService:e}=this,n=document.createElement("a");n.setAttribute("data-element-id",t.id);let i=!1;return t.url?(e.addLinkAttributes(n,t.url,t.newWindow),i=!0):t.action?(this._bindNamedAction(n,t.action,t.overlaidText),i=!0):t.attachment?(this.#Pr(n,t.attachment,t.overlaidText,t.attachmentDest),i=!0):t.setOCGState?(this.#Or(n,t.setOCGState,t.overlaidText),i=!0):t.dest?(this._bindLink(n,t.dest,t.overlaidText),i=!0):(t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(n,t),i=!0),t.resetForm?(this._bindResetFormAction(n,t.resetForm),i=!0):this.isTooltipOnly&&!i&&(this._bindLink(n,""),i=!0)),this.container.classList.add("linkAnnotation"),i&&(this.contentElement=n,this.container.append(n)),this.container}#Rr(){this.container.setAttribute("data-internal-link","")}_bindLink(t,e,n=""){t.href=this.linkService.getDestinationHash(e),t.onclick=()=>(e&&this.linkService.goToDestination(e),!1),(e||""===e)&&this.#Rr(),n&&(t.title=n)}_bindNamedAction(t,e,n=""){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeNamedAction(e),!1),n&&(t.title=n),this.#Rr()}#Pr(t,e,n="",i=null){t.href=this.linkService.getAnchorUrl(""),e.description?t.title=e.description:n&&(t.title=n),t.onclick=()=>(this.downloadManager?.openOrDownloadData(e.content,e.filename,i),!1),this.#Rr()}#Or(t,e,n=""){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeSetOCGState(e),!1),n&&(t.title=n),this.#Rr()}_bindJSAction(t,e){t.href=this.linkService.getAnchorUrl("");const n=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const i of Object.keys(e.actions)){const s=n.get(i);s&&(t[s]=()=>(this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e.id,name:i}}),!1))}e.overlaidText&&(t.title=e.overlaidText),t.onclick||(t.onclick=()=>!1),this.#Rr()}_bindResetFormAction(t,e){const n=t.onclick;if(n||(t.href=this.linkService.getAnchorUrl("")),this.#Rr(),!this._fieldObjects)return Qa('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),void(n||(t.onclick=()=>!1));t.onclick=()=>{n?.();const{fields:t,refs:i,include:s}=e,r=[];if(0!==t.length||0!==i.length){const e=new Set(i);for(const n of t){const t=this._fieldObjects[n]||[];for(const{id:n}of t)e.add(n)}for(const t of Object.values(this._fieldObjects))for(const n of t)e.has(n.id)===s&&r.push(n)}else for(const e of Object.values(this._fieldObjects))r.push(...e);const o=this.annotationStorage,a=[];for(const e of r){const{id:t}=e;switch(a.push(t),e.type){case"text":{const n=e.defaultValue||"";o.setValue(t,{value:n});break}case"checkbox":case"radiobutton":{const n=e.defaultValue===e.exportValues;o.setValue(t,{value:n});break}case"combobox":case"listbox":{const n=e.defaultValue||"";o.setValue(t,{value:n});break}default:continue}const n=document.querySelector(`[data-element-id="${t}"]`);n&&(qd.has(n)?n.dispatchEvent(new Event("resetform")):Qa(`_bindResetFormAction - element not allowed: ${t}`))}return this.enableScripting&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:a,name:"ResetForm"}}),!1}}}class tu extends Jd{constructor(t){super(t,{isRenderable:!0})}render(){this.container.classList.add("textAnnotation");const t=document.createElement("img");return t.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",t.setAttribute("data-l10n-id","pdfjs-text-annotation-type"),t.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name})),!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.append(t),this.container}}class eu extends Jd{render(){return this.container}showElementAndHideCanvas(t){this.data.hasOwnCanvas&&("CANVAS"===t.previousSibling?.nodeName&&(t.previousSibling.hidden=!0),t.hidden=!1)}_getKeyModifier(t){return ul.platform.isMac?t.metaKey:t.ctrlKey}_setEventListener(t,e,n,i,s){n.includes("mouse")?t.addEventListener(n,t=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:s(t),shift:t.shiftKey,modifier:this._getKeyModifier(t)}})}):t.addEventListener(n,t=>{if("blur"===n){if(!e.focused||!t.relatedTarget)return;e.focused=!1}else if("focus"===n){if(e.focused)return;e.focused=!0}s&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:s(t)}})})}_setEventListeners(t,e,n,i){for(const[s,r]of n)("Action"===r||this.data.actions?.[r])&&("Focus"!==r&&"Blur"!==r||(e||={focused:!1}),this._setEventListener(t,e,s,r,i),"Focus"!==r||this.data.actions?.Blur?"Blur"!==r||this.data.actions?.Focus||this._setEventListener(t,e,"focus","Focus",null):this._setEventListener(t,e,"blur","Blur",null))}_setBackgroundColor(t){const e=this.data.backgroundColor||null;t.style.backgroundColor=null===e?"transparent":fl.makeHexColor(e[0],e[1],e[2])}_setTextStyle(t){const e=["left","center","right"],{fontColor:n}=this.data.defaultAppearanceData,i=this.data.defaultAppearanceData.fontSize||9,s=t.style;let r;const o=t=>Math.round(10*t)/10;if(this.data.multiLine){const t=Math.abs(this.data.rect[3]-this.data.rect[1]-2),e=t/(Math.round(t/(fa*i))||1);r=Math.min(i,o(e/fa))}else{const t=Math.abs(this.data.rect[3]-this.data.rect[1]-2);r=Math.min(i,o(t/fa))}s.fontSize=`calc(${r}px * var(--total-scale-factor))`,s.color=fl.makeHexColor(n[0],n[1],n[2]),null!==this.data.textAlignment&&(s.textAlign=e[this.data.textAlignment])}_setRequired(t,e){e?t.setAttribute("required",!0):t.removeAttribute("required"),t.setAttribute("aria-required",e)}}class nu extends eu{constructor(t){super(t,{isRenderable:t.renderForms||t.data.hasOwnCanvas||!t.data.hasAppearance&&!!t.data.fieldValue})}setPropertyOnSiblings(t,e,n,i){const s=this.annotationStorage;for(const r of this._getElementsByName(t.name,t.id))r.domElement&&(r.domElement[e]=n),s.setValue(r.id,{[i]:n})}render(){const t=this.annotationStorage,e=this.data.id;this.container.classList.add("textWidgetAnnotation");let n=null;if(this.renderForms){const i=t.getValue(e,{value:this.data.fieldValue});let s=i.value||"";const r=t.getValue(e,{charLimit:this.data.maxLen}).charLimit;r&&s.length>r&&(s=s.slice(0,r));let o=i.formattedValue||this.data.textContent?.join("\n")||null;o&&this.data.comb&&(o=o.replaceAll(/\s+/g,""));const a={userValue:s,formattedValue:o,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(n=document.createElement("textarea"),n.textContent=o??s,this.data.doNotScroll&&(n.style.overflowY="hidden")):(n=document.createElement("input"),n.type=this.data.password?"password":"text",n.setAttribute("value",o??s),this.data.doNotScroll&&(n.style.overflowX="hidden")),this.data.hasOwnCanvas&&(n.hidden=!0),qd.add(n),this.contentElement=n,n.setAttribute("data-element-id",e),n.disabled=this.data.readOnly,n.name=this.data.fieldName,n.tabIndex=0;const{datetimeFormat:l,datetimeType:c,timeStep:h}=this.data,d=!!c&&this.enableScripting;l&&(n.title=l),this._setRequired(n,this.data.required),r&&(n.maxLength=r),n.addEventListener("input",i=>{t.setValue(e,{value:i.target.value}),this.setPropertyOnSiblings(n,"value",i.target.value,"value"),a.formattedValue=null}),n.addEventListener("resetform",t=>{const e=this.data.defaultFieldValue??"";n.value=a.userValue=e,a.formattedValue=null});let u=t=>{const{formattedValue:e}=a;null!=e&&(t.target.value=e),t.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){n.addEventListener("focus",t=>{if(a.focused)return;const{target:e}=t;if(d&&(e.type=c,h&&(e.step=h)),a.userValue){const t=a.userValue;if(d)if("time"===c){const n=new Date(t),i=[n.getHours(),n.getMinutes(),n.getSeconds()];e.value=i.map(t=>t.toString().padStart(2,"0")).join(":")}else e.value=new Date(t-Yd).toISOString().split("date"===c?"T":".",1)[0];else e.value=t}a.lastCommittedValue=e.value,a.commitKey=1,this.data.actions?.Focus||(a.focused=!0)}),n.addEventListener("updatefromsandbox",n=>{this.showElementAndHideCanvas(n.target);const i={value(n){a.userValue=n.detail.value??"",d||t.setValue(e,{value:a.userValue.toString()}),n.target.value=a.userValue},formattedValue(n){const{formattedValue:i}=n.detail;a.formattedValue=i,null!=i&&n.target!==document.activeElement&&(n.target.value=i);const s={formattedValue:i};d&&(s.value=i),t.setValue(e,s)},selRange(t){t.target.setSelectionRange(...t.detail.selRange)},charLimit:n=>{const{charLimit:i}=n.detail,{target:s}=n;if(0===i)return void s.removeAttribute("maxLength");s.setAttribute("maxLength",i);let r=a.userValue;!r||r.length<=i||(r=r.slice(0,i),s.value=a.userValue=r,t.setValue(e,{value:r}),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:r,willCommit:!0,commitKey:1,selStart:s.selectionStart,selEnd:s.selectionEnd}}))}};this._dispatchEventFromSandbox(i,n)}),n.addEventListener("keydown",t=>{a.commitKey=1;let n=-1;if("Escape"===t.key?n=0:"Enter"!==t.key||this.data.multiLine?"Tab"===t.key&&(a.commitKey=3):n=2,-1===n)return;const{value:i}=t.target;a.lastCommittedValue!==i&&(a.lastCommittedValue=i,a.userValue=i,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:i,willCommit:!0,commitKey:n,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}}))});const i=u;u=null,n.addEventListener("blur",t=>{if(!a.focused||!t.relatedTarget)return;this.data.actions?.Blur||(a.focused=!1);const{target:n}=t;let{value:s}=n;if(d){if(s&&"time"===c){const t=s.split(":").map(t=>parseInt(t,10));s=new Date(2e3,0,1,t[0],t[1],t[2]||0).valueOf(),n.step=""}else s.includes("T")||(s=`${s}T00:00`),s=new Date(s).valueOf();n.type="text"}a.userValue=s,a.lastCommittedValue!==s&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:s,willCommit:!0,commitKey:a.commitKey,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}}),i(t)}),this.data.actions?.Keystroke&&n.addEventListener("beforeinput",t=>{a.lastCommittedValue=null;const{data:n,target:i}=t,{value:s,selectionStart:r,selectionEnd:o}=i;let l=r,c=o;switch(t.inputType){case"deleteWordBackward":{const t=s.substring(0,r).match(/\w*[^\w]*$/);t&&(l-=t[0].length);break}case"deleteWordForward":{const t=s.substring(r).match(/^[^\w]*\w*/);t&&(c+=t[0].length);break}case"deleteContentBackward":r===o&&(l-=1);break;case"deleteContentForward":r===o&&(c+=1)}t.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:s,change:n||"",willCommit:!1,selStart:l,selEnd:c}})}),this._setEventListeners(n,a,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.value)}if(u&&n.addEventListener("blur",u),this.data.comb){const t=(this.data.rect[2]-this.data.rect[0])/r;n.classList.add("comb"),n.style.letterSpacing=`calc(${t}px * var(--total-scale-factor) - 1ch)`}}else n=document.createElement("div"),n.textContent=this.data.fieldValue,n.style.verticalAlign="middle",n.style.display="table-cell",this.data.hasOwnCanvas&&(n.hidden=!0);return this._setTextStyle(n),this._setBackgroundColor(n),this._setDefaultPropertiesFromJS(n),this.container.append(n),this.container}}class iu extends eu{constructor(t){super(t,{isRenderable:!!t.data.hasOwnCanvas})}}class su extends eu{constructor(t){super(t,{isRenderable:t.renderForms})}render(){const t=this.annotationStorage,e=this.data,n=e.id;let i=t.getValue(n,{value:e.exportValue===e.fieldValue}).value;"string"==typeof i&&(i="Off"!==i,t.setValue(n,{value:i})),this.container.classList.add("buttonWidgetAnnotation","checkBox");const s=document.createElement("input");return qd.add(s),s.setAttribute("data-element-id",n),s.disabled=e.readOnly,this._setRequired(s,this.data.required),s.type="checkbox",s.name=e.fieldName,i&&s.setAttribute("checked",!0),s.setAttribute("exportValue",e.exportValue),s.tabIndex=0,s.addEventListener("change",i=>{const{name:s,checked:r}=i.target;for(const o of this._getElementsByName(s,n)){const n=r&&o.exportValue===e.exportValue;o.domElement&&(o.domElement.checked=n),t.setValue(o.id,{value:n})}t.setValue(n,{value:r})}),s.addEventListener("resetform",t=>{const n=e.defaultFieldValue||"Off";t.target.checked=n===e.exportValue}),this.enableScripting&&this.hasJSActions&&(s.addEventListener("updatefromsandbox",e=>{const i={value(e){e.target.checked="Off"!==e.detail.value,t.setValue(n,{value:e.target.checked})}};this._dispatchEventFromSandbox(i,e)}),this._setEventListeners(s,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.checked)),this._setBackgroundColor(s),this._setDefaultPropertiesFromJS(s),this.container.append(s),this.container}}class ru extends eu{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const t=this.annotationStorage,e=this.data,n=e.id;let i=t.getValue(n,{value:e.fieldValue===e.buttonValue}).value;if("string"==typeof i&&(i=i!==e.buttonValue,t.setValue(n,{value:i})),i)for(const r of this._getElementsByName(e.fieldName,n))t.setValue(r.id,{value:!1});const s=document.createElement("input");if(qd.add(s),s.setAttribute("data-element-id",n),s.disabled=e.readOnly,this._setRequired(s,this.data.required),s.type="radio",s.name=e.fieldName,i&&s.setAttribute("checked",!0),s.tabIndex=0,s.addEventListener("change",e=>{const{name:i,checked:s}=e.target;for(const r of this._getElementsByName(i,n))t.setValue(r.id,{value:!1});t.setValue(n,{value:s})}),s.addEventListener("resetform",t=>{const n=e.defaultFieldValue;t.target.checked=null!=n&&n===e.buttonValue}),this.enableScripting&&this.hasJSActions){const i=e.buttonValue;s.addEventListener("updatefromsandbox",e=>{const s={value:e=>{const s=i===e.detail.value;for(const i of this._getElementsByName(e.target.name)){const e=s&&i.id===n;i.domElement&&(i.domElement.checked=e),t.setValue(i.id,{value:e})}}};this._dispatchEventFromSandbox(s,e)}),this._setEventListeners(s,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.checked)}return this._setBackgroundColor(s),this._setDefaultPropertiesFromJS(s),this.container.append(s),this.container}}class ou extends Zd{constructor(t){super(t,{ignoreBorder:t.data.hasAppearance})}render(){const t=super.render();t.classList.add("buttonWidgetAnnotation","pushButton");const e=t.lastChild;return this.enableScripting&&this.hasJSActions&&e&&(this._setDefaultPropertiesFromJS(e),e.addEventListener("updatefromsandbox",t=>{this._dispatchEventFromSandbox({},t)})),t}}class au extends eu{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const t=this.annotationStorage,e=this.data.id,n=t.getValue(e,{value:this.data.fieldValue}),i=document.createElement("select");qd.add(i),i.setAttribute("data-element-id",e),i.disabled=this.data.readOnly,this._setRequired(i,this.data.required),i.name=this.data.fieldName,i.tabIndex=0;let s=this.data.combo&&this.data.options.length>0;this.data.combo||(i.size=this.data.options.length,this.data.multiSelect&&(i.multiple=!0)),i.addEventListener("resetform",t=>{const e=this.data.defaultFieldValue;for(const n of i.options)n.selected=n.value===e});for(const c of this.data.options){const t=document.createElement("option");t.textContent=c.displayValue,t.value=c.exportValue,n.value.includes(c.exportValue)&&(t.setAttribute("selected",!0),s=!1),i.append(t)}let r=null;if(s){const t=document.createElement("option");t.value=" ",t.setAttribute("hidden",!0),t.setAttribute("selected",!0),i.prepend(t),r=()=>{t.remove(),i.removeEventListener("input",r),r=null},i.addEventListener("input",r)}const o=t=>{const e=t?"value":"textContent",{options:n,multiple:s}=i;return s?Array.prototype.filter.call(n,t=>t.selected).map(t=>t[e]):-1===n.selectedIndex?null:n[n.selectedIndex][e]};let a=o(!1);const l=t=>{const e=t.target.options;return Array.prototype.map.call(e,t=>({displayValue:t.textContent,exportValue:t.value}))};return this.enableScripting&&this.hasJSActions?(i.addEventListener("updatefromsandbox",n=>{const s={value(n){r?.();const s=n.detail.value,l=new Set(Array.isArray(s)?s:[s]);for(const t of i.options)t.selected=l.has(t.value);t.setValue(e,{value:o(!0)}),a=o(!1)},multipleSelection(t){i.multiple=!0},remove(n){const s=i.options,r=n.detail.remove;if(s[r].selected=!1,i.remove(r),s.length>0){-1===Array.prototype.findIndex.call(s,t=>t.selected)&&(s[0].selected=!0)}t.setValue(e,{value:o(!0),items:l(n)}),a=o(!1)},clear(n){for(;0!==i.length;)i.remove(0);t.setValue(e,{value:null,items:[]}),a=o(!1)},insert(n){const{index:s,displayValue:r,exportValue:c}=n.detail.insert,h=i.children[s],d=document.createElement("option");d.textContent=r,d.value=c,h?h.before(d):i.append(d),t.setValue(e,{value:o(!0),items:l(n)}),a=o(!1)},items(n){const{items:s}=n.detail;for(;0!==i.length;)i.remove(0);for(const t of s){const{displayValue:e,exportValue:n}=t,s=document.createElement("option");s.textContent=e,s.value=n,i.append(s)}i.options.length>0&&(i.options[0].selected=!0),t.setValue(e,{value:o(!0),items:l(n)}),a=o(!1)},indices(n){const i=new Set(n.detail.indices);for(const t of n.target.options)t.selected=i.has(t.index);t.setValue(e,{value:o(!0)}),a=o(!1)},editable(t){t.target.disabled=!t.detail.editable}};this._dispatchEventFromSandbox(s,n)}),i.addEventListener("input",n=>{const i=o(!0),s=o(!1);t.setValue(e,{value:i}),n.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:a,change:s,changeEx:i,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(i,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],t=>t.target.value)):i.addEventListener("input",function(n){t.setValue(e,{value:o(!0)})}),this.data.combo&&this._setTextStyle(i),this._setBackgroundColor(i),this._setDefaultPropertiesFromJS(i),this.container.append(i),this.container}}class lu extends Jd{constructor(t){const{data:e,elements:n,parent:i}=t,s=!!i._commentManager;if(super(t,{isRenderable:!s&&Jd._hasPopupData(e)}),this.elements=n,s&&Jd._hasPopupData(e)){const t=this.popup=this.#Br();for(const e of n)e.popup=t}else this.popup=null}#Br(){return new cu({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate||this.data.creationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open,commentManager:this.parent._commentManager})}render(){const{container:t}=this;t.classList.add("popupAnnotation"),t.role="comment";const e=this.popup=this.#Br(),n=[];for(const i of this.elements)i.popup=e,i.container.ariaHasPopup="dialog",n.push(i.data.id),i.addHighlightArea();return this.container.setAttribute("aria-controls",n.map(t=>`${bl}${t}`).join(",")),this.container}}class cu{#X=null;#Fr=this.#_r.bind(this);#Lr=this.#zr.bind(this);#Vr=this.#Hr.bind(this);#$r=this.#Ur.bind(this);#Wr=null;#Nt=null;#Gr=null;#jr=null;#Kr=null;#qr=null;#Yr=null;#Xr=!1;#Jr=null;#Qr=null;#z=null;#Zr=null;#to=null;#_e=null;#eo=null;#ve=null;#no=null;#kr=null;#io=!1;#so=null;#ro=null;constructor({container:t,color:e,elements:n,titleObj:i,modificationDate:s,contentsObj:r,richText:o,parent:a,rect:l,parentRect:c,open:h,commentManager:d=null}){this.#Nt=t,this.#no=i,this.#Gr=r,this.#ve=o,this.#qr=a,this.#Wr=e,this.#eo=l,this.#Yr=c,this.#Kr=n,this.#X=d,this.#so=n[0],this.#jr=Pl.toDateObject(s),this.trigger=n.flatMap(t=>t.getElementsToTriggerPopup()),d||(this.#oo(),this.#Nt.hidden=!0,h&&this.#Ur())}#oo(){if(this.#Qr)return;this.#Qr=new AbortController;const{signal:t}=this.#Qr;for(const e of this.trigger)e.addEventListener("click",this.#$r,{signal:t}),e.addEventListener("pointerenter",this.#Vr,{signal:t}),e.addEventListener("pointerleave",this.#Lr,{signal:t}),e.classList.add("popupTriggerArea");for(const e of this.#Kr)e.container?.addEventListener("keydown",this.#Fr,{signal:t})}#ao(){const t=this.#Kr.find(t=>t.hasCommentButton);t&&(this.#to=t._normalizePoint(t.commentButtonPosition))}renderCommentButton(){if(this.#Zr)return void(this.#Zr.parentNode||this.#so.container.after(this.#Zr));if(this.#to||this.#ao(),!this.#to)return;const{signal:t}=this.#Qr=new AbortController,e=this.#so.hasOwnCommentButton,n=()=>{this.#X.toggleCommentPopup(this,!0,void 0,!e)},i=()=>{this.#X.toggleCommentPopup(this,!1,!0,!e)},s=()=>{this.#X.toggleCommentPopup(this,!1,!1)};if(e){this.#Zr=this.#so.container;for(const e of this.trigger)e.ariaHasPopup="dialog",e.ariaControls="commentPopup",e.addEventListener("keydown",this.#Fr,{signal:t}),e.addEventListener("click",n,{signal:t}),e.addEventListener("pointerenter",i,{signal:t}),e.addEventListener("pointerleave",s,{signal:t}),e.classList.add("popupTriggerArea")}else{const e=this.#Zr=document.createElement("button");e.className="annotationCommentButton";const r=this.#so.container;e.style.zIndex=r.style.zIndex+1,e.tabIndex=0,e.ariaHasPopup="dialog",e.ariaControls="commentPopup",e.setAttribute("data-l10n-id","pdfjs-show-comment-button"),this.#lo(),this.#co(),e.addEventListener("keydown",this.#Fr,{signal:t}),e.addEventListener("click",n,{signal:t}),e.addEventListener("pointerenter",i,{signal:t}),e.addEventListener("pointerleave",s,{signal:t}),r.after(e)}}#co(){if(this.#so.extraPopupElement&&!this.#so.editor)return;this.#Zr||this.renderCommentButton();const[t,e]=this.#to,{style:n}=this.#Zr;n.left=`calc(${t}%)`,n.top=`calc(${e}% - var(--comment-button-dim))`}#lo(){this.#so.extraPopupElement||(this.#Zr||this.renderCommentButton(),this.#Zr.style.backgroundColor=this.commentButtonColor||"")}get commentButtonColor(){const{color:t,opacity:e}=this.#so.commentData;return t?this.#qr._commentManager.makeCommentColor(t,e):null}focusCommentButton(){setTimeout(()=>{this.#Zr?.focus()},0)}getData(){const{richText:t,color:e,opacity:n,creationDate:i,modificationDate:s}=this.#so.commentData;return{contentsObj:{str:this.comment},richText:t,color:e,opacity:n,creationDate:i,modificationDate:s}}get elementBeforePopup(){return this.#Zr}get comment(){return this.#ro||=this.#so.commentText,this.#ro}set comment(t){t!==this.comment&&(this.#so.commentText=this.#ro=t)}focus(){this.#so.container?.focus()}get parentBoundingClientRect(){return this.#so.layer.getBoundingClientRect()}setCommentButtonStates({selected:t,hasPopup:e}){this.#Zr&&(this.#Zr.classList.toggle("selected",t),this.#Zr.ariaExpanded=e)}setSelectedCommentButton(t){this.#Zr.classList.toggle("selected",t)}get commentPopupPosition(){if(this.#_e)return this.#_e;const{x:t,y:e,height:n}=this.#Zr.getBoundingClientRect(),{x:i,y:s,width:r,height:o}=this.#so.layer.getBoundingClientRect();return[(t-i)/r,(e+n-s)/o]}set commentPopupPosition(t){this.#_e=t}hasDefaultPopupPosition(){return null===this.#_e}get commentButtonPosition(){return this.#to}get commentButtonWidth(){return this.#Zr.getBoundingClientRect().width/this.parentBoundingClientRect.width}editComment(t){const[e,n]=this.#_e||this.commentButtonPosition.map(t=>t/100),i=this.parentBoundingClientRect,{x:s,y:r,width:o,height:a}=i;this.#X.showDialog(null,this,s+e*o,r+n*a,{...t,parentDimensions:i})}render(){if(this.#Jr)return;const t=this.#Jr=document.createElement("div");if(t.className="popup",this.#Wr){const e=t.style.outlineColor=fl.makeHexColor(...this.#Wr);t.style.backgroundColor=`color-mix(in srgb, ${e} 30%, white)`}const e=document.createElement("span");if(e.className="header",this.#no?.str){const t=document.createElement("span");t.className="title",e.append(t),({dir:t.dir,str:t.textContent}=this.#no)}if(t.append(e),this.#jr){const t=document.createElement("time");t.className="popupDate",t.setAttribute("data-l10n-id","pdfjs-annotation-date-time-string"),t.setAttribute("data-l10n-args",JSON.stringify({dateObj:this.#jr.valueOf()})),t.dateTime=this.#jr.toISOString(),e.append(t)}jl({html:this.#ho||this.#Gr.str,dir:this.#Gr?.dir,className:"popupContent"},t),this.#Nt.append(t)}get#ho(){const t=this.#ve,e=this.#Gr;return!t?.str||e?.str&&e.str!==t.str?null:this.#ve.html||null}get#do(){return this.#ho?.attributes?.style?.fontSize||0}get#uo(){return this.#ho?.attributes?.style?.color||null}#po(t){const e=[],n={str:t,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:e}]}},i={style:{color:this.#uo,fontSize:this.#do?`calc(${this.#do}px * var(--total-scale-factor))`:""}};for(const s of t.split("\n"))e.push({name:"span",value:s,attributes:i});return n}#_r(t){t.altKey||t.shiftKey||t.ctrlKey||t.metaKey||("Enter"===t.key||"Escape"===t.key&&this.#Xr)&&this.#Ur()}updateEdited({rect:t,popup:e,deleted:n}){if(this.#X)return n?(this.remove(),this.#ro=null):e&&(e.deleted?this.remove():(this.#lo(),this.#ro=e.text)),void(t&&(this.#to=null,this.#ao(),this.#co()));n||e?.deleted?this.remove():(this.#oo(),this.#kr||={contentsObj:this.#Gr,richText:this.#ve},t&&(this.#z=null),e&&e.text&&(this.#ve=this.#po(e.text),this.#jr=Pl.toDateObject(e.date),this.#Gr=null),this.#Jr?.remove(),this.#Jr=null)}resetEdited(){this.#kr&&(({contentsObj:this.#Gr,richText:this.#ve}=this.#kr),this.#kr=null,this.#Jr?.remove(),this.#Jr=null,this.#z=null)}remove(){if(this.#Qr?.abort(),this.#Qr=null,this.#Jr?.remove(),this.#Jr=null,this.#io=!1,this.#Xr=!1,this.#Zr?.remove(),this.#Zr=null,this.trigger)for(const t of this.trigger)t.classList.remove("popupTriggerArea")}#fo(){if(null!==this.#z)return;const{page:{view:t},viewport:{rawDims:{pageWidth:e,pageHeight:n,pageX:i,pageY:s}}}=this.#qr;let r=!!this.#Yr,o=r?this.#Yr:this.#eo;for(const u of this.#Kr)if(!o||null!==fl.intersect(u.data.rect,o)){o=u.data.rect,r=!0;break}const a=fl.normalizeRect([o[0],t[3]-o[1]+t[1],o[2],t[3]-o[3]+t[1]]),l=r?o[2]-o[0]+5:0,c=a[0]+l,h=a[1];this.#z=[100*(c-i)/e,100*(h-s)/n];const{style:d}=this.#Nt;d.left=`${this.#z[0]}%`,d.top=`${this.#z[1]}%`}#Ur(){this.#X?this.#X.toggleCommentPopup(this,!1):(this.#Xr=!this.#Xr,this.#Xr?(this.#Hr(),this.#Nt.addEventListener("click",this.#$r),this.#Nt.addEventListener("keydown",this.#Fr)):(this.#zr(),this.#Nt.removeEventListener("click",this.#$r),this.#Nt.removeEventListener("keydown",this.#Fr)))}#Hr(){this.#Jr||this.render(),this.isVisible?this.#Xr&&this.#Nt.classList.add("focused"):(this.#fo(),this.#Nt.hidden=!1,this.#Nt.style.zIndex=parseInt(this.#Nt.style.zIndex)+1e3)}#zr(){this.#Nt.classList.remove("focused"),!this.#Xr&&this.isVisible&&(this.#Nt.hidden=!0,this.#Nt.style.zIndex=parseInt(this.#Nt.style.zIndex)-1e3)}forceHide(){this.#io=this.isVisible,this.#io&&(this.#Nt.hidden=!0)}maybeShow(){this.#X||(this.#oo(),this.#io&&(this.#Jr||this.#Hr(),this.#io=!1,this.#Nt.hidden=!1))}get isVisible(){return!this.#X&&!1===this.#Nt.hidden}}class hu extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.textContent=t.data.textContent,this.textPosition=t.data.textPosition,this.annotationEditorType=Ta.FREETEXT}render(){if(this.container.classList.add("freeTextAnnotation"),this.textContent){const t=this.contentElement=document.createElement("div");t.classList.add("annotationTextContent"),t.setAttribute("role","comment");for(const e of this.textContent){const n=document.createElement("span");n.textContent=e,t.append(n)}this.container.append(t)}return!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this._editOnDoubleClick(),this.container}}class du extends Jd{#mo=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("lineAnnotation");const{data:t,width:e,height:n}=this,i=this.svgFactory.create(e,n,!0),s=this.#mo=this.svgFactory.createElement("svg:line");return s.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]),s.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]),s.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]),s.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]),s.setAttribute("stroke-width",t.borderStyle.width||1),s.setAttribute("stroke","transparent"),s.setAttribute("fill","transparent"),i.append(s),this.container.append(i),!t.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#mo}addHighlightArea(){this.container.classList.add("highlightArea")}}class uu extends Jd{#go=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("squareAnnotation");const{data:t,width:e,height:n}=this,i=this.svgFactory.create(e,n,!0),s=t.borderStyle.width,r=this.#go=this.svgFactory.createElement("svg:rect");return r.setAttribute("x",s/2),r.setAttribute("y",s/2),r.setAttribute("width",e-s),r.setAttribute("height",n-s),r.setAttribute("stroke-width",s||1),r.setAttribute("stroke","transparent"),r.setAttribute("fill","transparent"),i.append(r),this.container.append(i),!t.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#go}addHighlightArea(){this.container.classList.add("highlightArea")}}class pu extends Jd{#yo=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("circleAnnotation");const{data:t,width:e,height:n}=this,i=this.svgFactory.create(e,n,!0),s=t.borderStyle.width,r=this.#yo=this.svgFactory.createElement("svg:ellipse");return r.setAttribute("cx",e/2),r.setAttribute("cy",n/2),r.setAttribute("rx",e/2-s/2),r.setAttribute("ry",n/2-s/2),r.setAttribute("stroke-width",s||1),r.setAttribute("stroke","transparent"),r.setAttribute("fill","transparent"),i.append(r),this.container.append(i),!t.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#yo}addHighlightArea(){this.container.classList.add("highlightArea")}}class fu extends Jd{#bo=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,vertices:e,borderStyle:n,popupRef:i},width:s,height:r}=this;if(!e)return this.container;const o=this.svgFactory.create(s,r,!0);let a=[];for(let c=0,h=e.length;c<h;c+=2){const n=e[c]-t[0],i=t[3]-e[c+1];a.push(`${n},${i}`)}a=a.join(" ");const l=this.#bo=this.svgFactory.createElement(this.svgElementName);return l.setAttribute("points",a),l.setAttribute("stroke-width",n.width||1),l.setAttribute("stroke","transparent"),l.setAttribute("fill","transparent"),o.append(l),this.container.append(o),!i&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}getElementsToTriggerPopup(){return this.#bo}addHighlightArea(){this.container.classList.add("highlightArea")}}class mu extends fu{constructor(t){super(t),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}}class gu extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("caretAnnotation"),!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container}}class yu extends Jd{#wo=null;#vo=[];constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline",this.annotationEditorType="InkHighlight"===this.data.it?Ta.HIGHLIGHT:Ta.INK}#Ao(t,e){switch(t){case 90:return{transform:`rotate(90) translate(${-e[0]},${e[1]}) scale(1,-1)`,width:e[3]-e[1],height:e[2]-e[0]};case 180:return{transform:`rotate(180) translate(${-e[2]},${e[1]}) scale(1,-1)`,width:e[2]-e[0],height:e[3]-e[1]};case 270:return{transform:`rotate(270) translate(${-e[2]},${e[3]}) scale(1,-1)`,width:e[3]-e[1],height:e[2]-e[0]};default:return{transform:`translate(${-e[0]},${e[3]}) scale(1,-1)`,width:e[2]-e[0],height:e[3]-e[1]}}}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,rotation:e,inkLists:n,borderStyle:i,popupRef:s}}=this,{transform:r,width:o,height:a}=this.#Ao(e,t),l=this.svgFactory.create(o,a,!0),c=this.#wo=this.svgFactory.createElement("svg:g");l.append(c),c.setAttribute("stroke-width",i.width||1),c.setAttribute("stroke-linecap","round"),c.setAttribute("stroke-linejoin","round"),c.setAttribute("stroke-miterlimit",10),c.setAttribute("stroke","transparent"),c.setAttribute("fill","transparent"),c.setAttribute("transform",r);for(let h=0,d=n.length;h<d;h++){const t=this.svgFactory.createElement(this.svgElementName);this.#vo.push(t),t.setAttribute("points",n[h].join(",")),c.append(t)}return!s&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.append(l),this._editOnDoubleClick(),this.container}updateEdited(t){super.updateEdited(t);const{thickness:e,points:n,rect:i}=t,s=this.#wo;if(e>=0&&s.setAttribute("stroke-width",e||1),n)for(let r=0,o=this.#vo.length;r<o;r++)this.#vo[r].setAttribute("points",n[r].join(","));if(i){const{transform:t,width:e,height:n}=this.#Ao(this.data.rotation,i);s.parentElement.setAttribute("viewBox",`0 0 ${e} ${n}`),s.setAttribute("transform",t)}}getElementsToTriggerPopup(){return this.#vo}addHighlightArea(){this.container.classList.add("highlightArea")}}class bu extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0}),this.annotationEditorType=Ta.HIGHLIGHT}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add("highlightAnnotation"),this._editOnDoubleClick(),t){const e=document.createElement("mark");e.classList.add("overlaidText"),e.textContent=t,this.container.append(e)}return this.container}}class wu extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add("underlineAnnotation"),t){const e=document.createElement("u");e.classList.add("overlaidText"),e.textContent=t,this.container.append(e)}return this.container}}class vu extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add("squigglyAnnotation"),t){const e=document.createElement("u");e.classList.add("overlaidText"),e.textContent=t,this.container.append(e)}return this.container}}class Au extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this.container.classList.add("strikeoutAnnotation"),t){const e=document.createElement("s");e.classList.add("overlaidText"),e.textContent=t,this.container.append(e)}return this.container}}class xu extends Jd{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.annotationEditorType=Ta.STAMP}render(){return this.container.classList.add("stampAnnotation"),this.container.setAttribute("role","img"),!this.data.popupRef&&this.hasPopupData&&(this.hasOwnCommentButton=!0,this._createPopup()),this._editOnDoubleClick(),this.container}}class Su extends Jd{#xo=null;constructor(t){super(t,{isRenderable:!0});const{file:e}=this.data;this.filename=e.filename,this.content=e.content,this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,...e})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container:t,data:e}=this;let n;e.hasAppearance||0===e.fillAlpha?n=document.createElement("div"):(n=document.createElement("img"),n.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(e.name)?"paperclip":"pushpin"}.svg`,e.fillAlpha&&e.fillAlpha<1&&(n.style=`filter: opacity(${Math.round(100*e.fillAlpha)}%);`)),n.addEventListener("dblclick",this.#So.bind(this)),this.#xo=n;const{isMac:i}=ul.platform;return t.addEventListener("keydown",t=>{"Enter"===t.key&&(i?t.metaKey:t.ctrlKey)&&this.#So()}),!e.popupRef&&this.hasPopupData?(this.hasOwnCommentButton=!0,this._createPopup()):n.classList.add("popupTriggerArea"),t.append(n),t}getElementsToTriggerPopup(){return this.#xo}addHighlightArea(){this.container.classList.add("highlightArea")}#So(){this.downloadManager?.openOrDownloadData(this.content,this.filename)}}class _u{#_o=null;#To=null;#K=null;#Eo=new Map;#Co=null;#Mo=null;#Kr=[];#ko=!1;constructor({div:t,accessibilityManager:e,annotationCanvasMap:n,annotationEditorUIManager:i,page:s,viewport:r,structTreeLayer:o,commentManager:a,linkService:l,annotationStorage:c}){this.div=t,this.#_o=e,this.#To=n,this.#Co=o||null,this.#Mo=l||null,this.#K=c||new mc,this.page=s,this.viewport=r,this.zIndex=0,this._annotationEditorUIManager=i,this._commentManager=a||null}hasEditableAnnotations(){return this.#Eo.size>0}async render(t){const{annotations:e}=t,n=this.div;Fl(n,this.viewport);const i=new Map,s=[],r={data:null,layer:n,linkService:this.#Mo,downloadManager:t.downloadManager,imageResourcesPath:t.imageResourcesPath||"",renderForms:!1!==t.renderForms,svgFactory:new Kd,annotationStorage:this.#K,enableComment:!0===t.enableComment,enableScripting:!0===t.enableScripting,hasJSActions:t.hasJSActions,fieldObjects:t.fieldObjects,parent:this,elements:null};for(const o of e){if(o.noHTML)continue;const t=o.annotationType===Ba.POPUP;if(t){const t=i.get(o.id);if(!t)continue;if(!this._commentManager){s.push(o);continue}r.elements=t}else if(o.rect[2]===o.rect[0]||o.rect[3]===o.rect[1])continue;r.data=o;const e=Xd.create(r);if(!e.isRenderable)continue;if(!t&&(this.#Kr.push(e),o.popupRef)){const t=i.get(o.popupRef);t?t.push(e):i.set(o.popupRef,[e])}const n=e.render();o.hidden&&(n.style.visibility="hidden"),e._isEditable&&(this.#Eo.set(e.data.id,e),this._annotationEditorUIManager?.renderAnnotationElement(e))}await this.#Do();for(const o of s){const t=r.elements=i.get(o.id);r.data=o;const e=Xd.create(r);if(!e.isRenderable)continue;const n=e.render();e.contentElement.id=`${bl}${o.id}`,o.hidden&&(n.style.visibility="hidden"),t.at(-1).container.after(n)}this.#Io()}async#Do(){if(0===this.#Kr.length)return;this.div.replaceChildren();const t=[];if(!this.#ko){this.#ko=!0;for(const{contentElement:e,data:{id:n}}of this.#Kr){const i=e.id=`${bl}${n}`;t.push(this.#Co?.getAriaAttributes(i).then(t=>{if(t)for(const[n,i]of t)e.setAttribute(n,i)}))}}this.#Kr.sort(({data:{rect:[t,e,n,i]}},{data:{rect:[s,r,o,a]}})=>{if(t===n&&e===i)return 1;if(s===o&&r===a)return-1;const l=(e+i)/2,c=(r+a)/2;if(l>=a&&c<=e)return-1;if(c>=i&&l<=r)return 1;return(t+n)/2-(s+o)/2});const e=document.createDocumentFragment();for(const n of this.#Kr)e.append(n.container),this._commentManager?(n.extraPopupElement?.popup||n.popup)?.renderCommentButton():n.extraPopupElement&&e.append(n.extraPopupElement.render());if(this.div.append(e),await Promise.all(t),this.#_o)for(const n of this.#Kr)this.#_o.addPointerInTextLayer(n.contentElement,!1)}async addLinkAnnotations(t){const e={data:null,layer:this.div,linkService:this.#Mo,svgFactory:new Kd,parent:this};for(const n of t){n.borderStyle||=_u._defaultBorderStyle,e.data=n;const t=Xd.create(e);t.isRenderable&&(t.render(),t.contentElement.id=`${bl}${n.id}`,this.#Kr.push(t))}await this.#Do()}update({viewport:t}){const e=this.div;this.viewport=t,Fl(e,{rotation:t.rotation}),this.#Io(),e.hidden=!1}#Io(){if(!this.#To)return;const t=this.div;for(const[e,n]of this.#To){const i=t.querySelector(`[data-annotation-id="${e}"]`);if(!i)continue;n.className="annotationContent";const{firstChild:s}=i;s?"CANVAS"===s.nodeName?s.replaceWith(n):s.classList.contains("annotationContent")?s.after(n):s.before(n):i.append(n);const r=this.#Eo.get(e);r&&(r._hasNoCanvas?(this._annotationEditorUIManager?.setMissingCanvas(e,i.id,n),r._hasNoCanvas=!1):r.canvas=n)}this.#To.clear()}getEditableAnnotations(){return Array.from(this.#Eo.values())}getEditableAnnotation(t){return this.#Eo.get(t)}addFakeAnnotation(t){const{div:e}=this,{id:n,rotation:i}=t,s=new Qd({data:{id:n,rect:t.getPDFRect(),rotation:i},editor:t,layer:e,parent:this,enableComment:!!this._commentManager,linkService:this.#Mo,annotationStorage:this.#K});return s.render(),s.contentElement.id=`${bl}${n}`,s.createOrUpdatePopup(),this.#Kr.push(s),s}removeAnnotation(t){const e=this.#Kr.findIndex(e=>e.data.id===t);if(e<0)return;const[n]=this.#Kr.splice(e,1);this.#_o?.removePointerInTextLayer(n.contentElement)}updateFakeAnnotations(t){if(0!==t.length){for(const e of t)e.updateFakeAnnotationElement(this);this.#Do()}}togglePointerEvents(t=!1){this.div.classList.toggle("disabled",!t)}static get _defaultBorderStyle(){return il(this,"_defaultBorderStyle",Object.freeze({width:1,rawWidth:1,style:Fa,dashArray:[3],horizontalCornerRadius:0,verticalCornerRadius:0}))}}const Tu=/\r\n?|\n/g;class Eu extends lc{#No="";#Po=`${this.id}-editor`;#Oo=null;#do;_colorPicker=null;static _freeTextDefaultContent="";static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){const t=Eu.prototype,e=t=>t.isEmpty(),n=sc.TRANSLATE_SMALL,i=sc.TRANSLATE_BIG;return il(this,"_keyboardManager",new nc([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],t.commitOrRemove,{bubbles:!0}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],t.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],t._translateEmpty,{args:[-n,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t._translateEmpty,{args:[-i,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t._translateEmpty,{args:[n,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t._translateEmpty,{args:[i,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t._translateEmpty,{args:[0,-n],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t._translateEmpty,{args:[0,-i],checker:e}],[["ArrowDown","mac+ArrowDown"],t._translateEmpty,{args:[0,n],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t._translateEmpty,{args:[0,i],checker:e}]]))}static _type="freetext";static _editorType=Ta.FREETEXT;constructor(t){super({...t,name:"freeTextEditor"}),this.color=t.color||Eu._defaultColor||lc._defaultLineColor,this.#do=t.fontSize||Eu._defaultFontSize,this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-freetext-added-alert"),this.canAddComment=!1}static initialize(t,e){lc.initialize(t,e);const n=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(n.getPropertyValue("--freetext-padding"))}static updateDefaultParams(t,e){switch(t){case Ea.FREETEXT_SIZE:Eu._defaultFontSize=e;break;case Ea.FREETEXT_COLOR:Eu._defaultColor=e}}updateParams(t,e){switch(t){case Ea.FREETEXT_SIZE:this.#Ro(e);break;case Ea.FREETEXT_COLOR:this.#lo(e)}}static get defaultPropertiesToUpdate(){return[[Ea.FREETEXT_SIZE,Eu._defaultFontSize],[Ea.FREETEXT_COLOR,Eu._defaultColor||lc._defaultLineColor]]}get propertiesToUpdate(){return[[Ea.FREETEXT_SIZE,this.#do],[Ea.FREETEXT_COLOR,this.color]]}get toolbarButtons(){return this._colorPicker||=new $d(this),[["colorPicker",this._colorPicker]]}get colorType(){return Ea.FREETEXT_COLOR}#Ro(t){const e=t=>{this.editorDiv.style.fontSize=`calc(${t}px * var(--total-scale-factor))`,this.translate(0,-(t-this.#do)*this.parentScale),this.#do=t,this.#Bo()},n=this.#do;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:Ea.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})}onUpdatedColor(){this.editorDiv.style.color=this.color,this._colorPicker?.update(this.color),super.onUpdatedColor()}#lo(t){const e=t=>{this.color=t,this.onUpdatedColor()},n=this.color;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:Ea.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})}_translateEmpty(t,e){this._uiManager.translateSelectedEditors(t,e,!0)}getInitialTranslation(){const t=this.parentScale;return[-Eu._internalPadding*t,-(Eu._internalPadding+this.#do)*t]}rebuild(){this.parent&&(super.rebuild(),null!==this.div&&(this.isAttachedToDOM||this.parent.add(this)))}enableEditMode(){if(!super.enableEditMode())return!1;this.overlayDiv.classList.remove("enabled"),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute("aria-activedescendant"),this.#Oo=new AbortController;const t=this._uiManager.combinedSignal(this.#Oo);return this.editorDiv.addEventListener("keydown",this.editorDivKeydown.bind(this),{signal:t}),this.editorDiv.addEventListener("focus",this.editorDivFocus.bind(this),{signal:t}),this.editorDiv.addEventListener("blur",this.editorDivBlur.bind(this),{signal:t}),this.editorDiv.addEventListener("input",this.editorDivInput.bind(this),{signal:t}),this.editorDiv.addEventListener("paste",this.editorDivPaste.bind(this),{signal:t}),!0}disableEditMode(){return!!super.disableEditMode()&&(this.overlayDiv.classList.add("enabled"),this.editorDiv.contentEditable=!1,this.div.setAttribute("aria-activedescendant",this.#Po),this._isDraggable=!0,this.#Oo?.abort(),this.#Oo=null,this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add("freetextEditing"),!0)}focusin(t){this._focusEventsAllowed&&(super.focusin(t),t.target!==this.editorDiv&&this.editorDiv.focus())}onceAdded(t){this.width||(this.enableEditMode(),t&&this.editorDiv.focus(),this._initialOptions?.isCentered&&this.center(),this._initialOptions=null)}isEmpty(){return!this.editorDiv||""===this.editorDiv.innerText.trim()}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add("freetextEditing")),super.remove()}#Fo(){const t=[];this.editorDiv.normalize();let e=null;for(const n of this.editorDiv.childNodes)e?.nodeType===Node.TEXT_NODE&&"BR"===n.nodeName||(t.push(Eu.#Lo(n)),e=n);return t.join("\n")}#Bo(){const[t,e]=this.parentDimensions;let n;if(this.isAttachedToDOM)n=this.div.getBoundingClientRect();else{const{currentLayer:t,div:e}=this,i=e.style.display,s=e.classList.contains("hidden");e.classList.remove("hidden"),e.style.display="hidden",t.div.append(this.div),n=e.getBoundingClientRect(),e.remove(),e.style.display=i,e.classList.toggle("hidden",s)}this.rotation%180==this.parentRotation%180?(this.width=n.width/t,this.height=n.height/e):(this.width=n.height/t,this.height=n.width/e),this.fixAndSetPosition()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();const t=this.#No,e=this.#No=this.#Fo().trimEnd();if(t===e)return;const n=t=>{this.#No=t,t?(this.#zo(),this._uiManager.rebuild(this),this.#Bo()):this.remove()};this.addCommands({cmd:()=>{n(e)},undo:()=>{n(t)},mustExec:!1}),this.#Bo()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}keydown(t){t.target===this.div&&"Enter"===t.key&&(this.enterInEditMode(),t.preventDefault())}editorDivKeydown(t){Eu._keyboardManager.exec(this,t)}editorDivFocus(t){this.isEditing=!0}editorDivBlur(t){this.isEditing=!1}editorDivInput(t){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment"),this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox"),this.editorDiv.setAttribute("aria-multiline",!0)}get canChangeContent(){return!0}render(){if(this.div)return this.div;let t,e;(this._isCopy||this.annotationElementId)&&(t=this.x,e=this.y),super.render(),this.editorDiv=document.createElement("div"),this.editorDiv.className="internal",this.editorDiv.setAttribute("id",this.#Po),this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text2"),this.editorDiv.setAttribute("data-l10n-attrs","default-content"),this.enableEditing(),this.editorDiv.contentEditable=!0;const{style:n}=this.editorDiv;if(n.fontSize=`calc(${this.#do}px * var(--total-scale-factor))`,n.color=this.color,this.div.append(this.editorDiv),this.overlayDiv=document.createElement("div"),this.overlayDiv.classList.add("overlay","enabled"),this.div.append(this.overlayDiv),this._isCopy||this.annotationElementId){const[n,i]=this.parentDimensions;if(this.annotationElementId){const{position:s}=this._initialData;let[r,o]=this.getInitialTranslation();[r,o]=this.pageTranslationToScreen(r,o);const[a,l]=this.pageDimensions,[c,h]=this.pageTranslation;let d,u;switch(this.rotation){case 0:d=t+(s[0]-c)/a,u=e+this.height-(s[1]-h)/l;break;case 90:d=t+(s[0]-c)/a,u=e-(s[1]-h)/l,[r,o]=[o,-r];break;case 180:d=t-this.width+(s[0]-c)/a,u=e-(s[1]-h)/l,[r,o]=[-r,-o];break;case 270:d=t+(s[0]-c-this.height*l)/a,u=e+(s[1]-h-this.width*a)/l,[r,o]=[-o,r]}this.setAt(d*n,u*i,r,o)}else this._moveAfterPaste(t,e);this.#zo(),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}static#Lo(t){return(t.nodeType===Node.TEXT_NODE?t.nodeValue:t.innerText).replaceAll(Tu,"")}editorDivPaste(t){const e=t.clipboardData||window.clipboardData,{types:n}=e;if(1===n.length&&"text/plain"===n[0])return;t.preventDefault();const i=Eu.#Vo(e.getData("text")||"").replaceAll(Tu,"\n");if(!i)return;const s=window.getSelection();if(!s.rangeCount)return;this.editorDiv.normalize(),s.deleteFromDocument();const r=s.getRangeAt(0);if(!i.includes("\n"))return r.insertNode(document.createTextNode(i)),this.editorDiv.normalize(),void s.collapseToStart();const{startContainer:o,startOffset:a}=r,l=[],c=[];if(o.nodeType===Node.TEXT_NODE){const t=o.parentElement;if(c.push(o.nodeValue.slice(a).replaceAll(Tu,"")),t!==this.editorDiv){let e=l;for(const n of this.editorDiv.childNodes)n!==t?e.push(Eu.#Lo(n)):e=c}l.push(o.nodeValue.slice(0,a).replaceAll(Tu,""))}else if(o===this.editorDiv){let t=l,e=0;for(const n of this.editorDiv.childNodes)e++===a&&(t=c),t.push(Eu.#Lo(n))}this.#No=`${l.join("\n")}${i}${c.join("\n")}`,this.#zo();const h=new Range;let d=Math.sumPrecise(l.map(t=>t.length));for(const{firstChild:u}of this.editorDiv.childNodes)if(u.nodeType===Node.TEXT_NODE){const t=u.nodeValue.length;if(d<=t){h.setStart(u,d),h.setEnd(u,d);break}d-=t}s.removeAllRanges(),s.addRange(h)}#zo(){if(this.editorDiv.replaceChildren(),this.#No)for(const t of this.#No.split("\n")){const e=document.createElement("div");e.append(t?document.createTextNode(t):document.createElement("br")),this.editorDiv.append(e)}}#Ho(){return this.#No.replaceAll(""," ")}static#Vo(t){return t.replaceAll(" ","")}get contentDiv(){return this.editorDiv}getPDFRect(){const t=Eu._internalPadding*this.parentScale;return this.getRect(t,t)}static async deserialize(t,e,n){let i=null;if(t instanceof hu){const{data:{defaultAppearanceData:{fontSize:e,fontColor:n},rect:s,rotation:r,id:o,popupRef:a,richText:l,contentsObj:c,creationDate:h,modificationDate:d},textContent:u,textPosition:p,parent:{page:{pageNumber:f}}}=t;if(!u||0===u.length)return null;i=t={annotationType:Ta.FREETEXT,color:Array.from(n),fontSize:e,value:u.join("\n"),position:p,pageIndex:f-1,rect:s.slice(0),rotation:r,annotationElementId:o,id:o,deleted:!1,popupRef:a,comment:c?.str||null,richText:l,creationDate:h,modificationDate:d}}const s=await super.deserialize(t,e,n);return s.#do=t.fontSize,s.color=fl.makeHexColor(...t.color),s.#No=Eu.#Vo(t.value),s._initialData=i,t.comment&&s.setCommentData(t),s}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const e=lc._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.color),n=Object.assign(super.serialize(t),{color:e,fontSize:this.#do,value:this.#Ho()});return this.addComment(n),t?(n.isCopy=!0,n):this.annotationElementId&&!this.#$o(n)?null:(n.id=this.annotationElementId,n)}#$o(t){const{value:e,fontSize:n,color:i,pageIndex:s}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||t.value!==e||t.fontSize!==n||t.color.some((t,e)=>t!==i[e])||t.pageIndex!==s}renderAnnotationElement(t){const e=super.renderAnnotationElement(t);if(!e)return null;const{style:n}=e;n.fontSize=`calc(${this.#do}px * var(--total-scale-factor))`,n.color=this.color,e.replaceChildren();for(const i of this.#No.split("\n")){const t=document.createElement("div");t.append(i?document.createTextNode(i):document.createElement("br")),e.append(t)}return t.updateEdited({rect:this.getPDFRect(),popup:this._uiManager.hasCommentManager()||this.hasEditedComment?this.comment:{text:this.#No}}),e}resetAnnotationElement(t){super.resetAnnotationElement(t),t.resetEdited()}}class Cu{static PRECISION=1e-4;toSVGPath(){Za("Abstract method `toSVGPath` must be implemented.")}get box(){Za("Abstract getter `box` must be implemented.")}serialize(t,e){Za("Abstract method `serialize` must be implemented.")}static _rescale(t,e,n,i,s,r){r||=new Float32Array(t.length);for(let o=0,a=t.length;o<a;o+=2)r[o]=e+t[o]*i,r[o+1]=n+t[o+1]*s;return r}static _rescaleAndSwap(t,e,n,i,s,r){r||=new Float32Array(t.length);for(let o=0,a=t.length;o<a;o+=2)r[o]=e+t[o+1]*i,r[o+1]=n+t[o]*s;return r}static _translate(t,e,n,i){i||=new Float32Array(t.length);for(let s=0,r=t.length;s<r;s+=2)i[s]=e+t[s],i[s+1]=n+t[s+1];return i}static svgRound(t){return Math.round(1e4*t)}static _normalizePoint(t,e,n,i,s){switch(s){case 90:return[1-e/n,t/i];case 180:return[1-t/n,1-e/i];case 270:return[e/n,1-t/i];default:return[t/n,e/i]}}static _normalizePagePoint(t,e,n){switch(n){case 90:return[1-e,t];case 180:return[1-t,1-e];case 270:return[e,1-t];default:return[t,e]}}static createBezierPoints(t,e,n,i,s,r){return[(t+5*n)/6,(e+5*i)/6,(5*n+s)/6,(5*i+r)/6,(n+s)/2,(i+r)/2]}}class Mu{#Uo;#Wo=[];#Go;#jo;#Ko=[];#qo=new Float32Array(18);#Yo;#Xo;#Jo;#Qo;#Zo;#ta;#ea=[];static#na=8;static#ia=2;static#sa=Mu.#na+Mu.#ia;constructor({x:t,y:e},n,i,s,r,o=0){this.#Uo=n,this.#ta=s*i,this.#jo=r,this.#qo.set([NaN,NaN,NaN,NaN,t,e],6),this.#Go=o,this.#Qo=Mu.#na*i,this.#Jo=Mu.#sa*i,this.#Zo=i,this.#ea.push(t,e)}isEmpty(){return isNaN(this.#qo[8])}#ra(){const t=this.#qo.subarray(4,6),e=this.#qo.subarray(16,18),[n,i,s,r]=this.#Uo;return[(this.#Yo+(t[0]-e[0])/2-n)/s,(this.#Xo+(t[1]-e[1])/2-i)/r,(this.#Yo+(e[0]-t[0])/2-n)/s,(this.#Xo+(e[1]-t[1])/2-i)/r]}add({x:t,y:e}){this.#Yo=t,this.#Xo=e;const[n,i,s,r]=this.#Uo;let[o,a,l,c]=this.#qo.subarray(8,12);const h=t-l,d=e-c,u=Math.hypot(h,d);if(u<this.#Jo)return!1;const p=u-this.#Qo,f=p/u,m=f*h,g=f*d;let y=o,b=a;o=l,a=c,l+=m,c+=g,this.#ea?.push(t,e);const w=m/p,v=-g/p*this.#ta,A=w*this.#ta;if(this.#qo.set(this.#qo.subarray(2,8),0),this.#qo.set([l+v,c+A],4),this.#qo.set(this.#qo.subarray(14,18),12),this.#qo.set([l-v,c-A],16),isNaN(this.#qo[6]))return 0===this.#Ko.length&&(this.#qo.set([o+v,a+A],2),this.#Ko.push(NaN,NaN,NaN,NaN,(o+v-n)/s,(a+A-i)/r),this.#qo.set([o-v,a-A],14),this.#Wo.push(NaN,NaN,NaN,NaN,(o-v-n)/s,(a-A-i)/r)),this.#qo.set([y,b,o,a,l,c],6),!this.isEmpty();this.#qo.set([y,b,o,a,l,c],6);return Math.abs(Math.atan2(b-a,y-o)-Math.atan2(g,m))<Math.PI/2?([o,a,l,c]=this.#qo.subarray(2,6),this.#Ko.push(NaN,NaN,NaN,NaN,((o+l)/2-n)/s,((a+c)/2-i)/r),[o,a,y,b]=this.#qo.subarray(14,18),this.#Wo.push(NaN,NaN,NaN,NaN,((y+o)/2-n)/s,((b+a)/2-i)/r),!0):([y,b,o,a,l,c]=this.#qo.subarray(0,6),this.#Ko.push(((y+5*o)/6-n)/s,((b+5*a)/6-i)/r,((5*o+l)/6-n)/s,((5*a+c)/6-i)/r,((o+l)/2-n)/s,((a+c)/2-i)/r),[l,c,o,a,y,b]=this.#qo.subarray(12,18),this.#Wo.push(((y+5*o)/6-n)/s,((b+5*a)/6-i)/r,((5*o+l)/6-n)/s,((5*a+c)/6-i)/r,((o+l)/2-n)/s,((a+c)/2-i)/r),!0)}toSVGPath(){if(this.isEmpty())return"";const t=this.#Ko,e=this.#Wo;if(isNaN(this.#qo[6])&&!this.isEmpty())return this.#oa();const n=[];n.push(`M${t[4]} ${t[5]}`);for(let i=6;i<t.length;i+=6)isNaN(t[i])?n.push(`L${t[i+4]} ${t[i+5]}`):n.push(`C${t[i]} ${t[i+1]} ${t[i+2]} ${t[i+3]} ${t[i+4]} ${t[i+5]}`);this.#aa(n);for(let i=e.length-6;i>=6;i-=6)isNaN(e[i])?n.push(`L${e[i+4]} ${e[i+5]}`):n.push(`C${e[i]} ${e[i+1]} ${e[i+2]} ${e[i+3]} ${e[i+4]} ${e[i+5]}`);return this.#la(n),n.join(" ")}#oa(){const[t,e,n,i]=this.#Uo,[s,r,o,a]=this.#ra();return`M${(this.#qo[2]-t)/n} ${(this.#qo[3]-e)/i} L${(this.#qo[4]-t)/n} ${(this.#qo[5]-e)/i} L${s} ${r} L${o} ${a} L${(this.#qo[16]-t)/n} ${(this.#qo[17]-e)/i} L${(this.#qo[14]-t)/n} ${(this.#qo[15]-e)/i} Z`}#la(t){const e=this.#Wo;t.push(`L${e[4]} ${e[5]} Z`)}#aa(t){const[e,n,i,s]=this.#Uo,r=this.#qo.subarray(4,6),o=this.#qo.subarray(16,18),[a,l,c,h]=this.#ra();t.push(`L${(r[0]-e)/i} ${(r[1]-n)/s} L${a} ${l} L${c} ${h} L${(o[0]-e)/i} ${(o[1]-n)/s}`)}newFreeDrawOutline(t,e,n,i,s,r){return new ku(t,e,n,i,s,r)}getOutlines(){const t=this.#Ko,e=this.#Wo,n=this.#qo,[i,s,r,o]=this.#Uo,a=new Float32Array((this.#ea?.length??0)+2);for(let h=0,d=a.length-2;h<d;h+=2)a[h]=(this.#ea[h]-i)/r,a[h+1]=(this.#ea[h+1]-s)/o;if(a[a.length-2]=(this.#Yo-i)/r,a[a.length-1]=(this.#Xo-s)/o,isNaN(n[6])&&!this.isEmpty())return this.#ca(a);const l=new Float32Array(this.#Ko.length+24+this.#Wo.length);let c=t.length;for(let h=0;h<c;h+=2)isNaN(t[h])?l[h]=l[h+1]=NaN:(l[h]=t[h],l[h+1]=t[h+1]);c=this.#ha(l,c);for(let h=e.length-6;h>=6;h-=6)for(let t=0;t<6;t+=2)isNaN(e[h+t])?(l[c]=l[c+1]=NaN,c+=2):(l[c]=e[h+t],l[c+1]=e[h+t+1],c+=2);return this.#da(l,c),this.newFreeDrawOutline(l,a,this.#Uo,this.#Zo,this.#Go,this.#jo)}#ca(t){const e=this.#qo,[n,i,s,r]=this.#Uo,[o,a,l,c]=this.#ra(),h=new Float32Array(36);return h.set([NaN,NaN,NaN,NaN,(e[2]-n)/s,(e[3]-i)/r,NaN,NaN,NaN,NaN,(e[4]-n)/s,(e[5]-i)/r,NaN,NaN,NaN,NaN,o,a,NaN,NaN,NaN,NaN,l,c,NaN,NaN,NaN,NaN,(e[16]-n)/s,(e[17]-i)/r,NaN,NaN,NaN,NaN,(e[14]-n)/s,(e[15]-i)/r],0),this.newFreeDrawOutline(h,t,this.#Uo,this.#Zo,this.#Go,this.#jo)}#da(t,e){const n=this.#Wo;return t.set([NaN,NaN,NaN,NaN,n[4],n[5]],e),e+6}#ha(t,e){const n=this.#qo.subarray(4,6),i=this.#qo.subarray(16,18),[s,r,o,a]=this.#Uo,[l,c,h,d]=this.#ra();return t.set([NaN,NaN,NaN,NaN,(n[0]-s)/o,(n[1]-r)/a,NaN,NaN,NaN,NaN,l,c,NaN,NaN,NaN,NaN,h,d,NaN,NaN,NaN,NaN,(i[0]-s)/o,(i[1]-r)/a],e),e+24}}class ku extends Cu{#Uo;#ua=new Float32Array(4);#Go;#jo;#ea;#Zo;#pa;constructor(t,e,n,i,s,r){super(),this.#pa=t,this.#ea=e,this.#Uo=n,this.#Zo=i,this.#Go=s,this.#jo=r,this.firstPoint=[NaN,NaN],this.lastPoint=[NaN,NaN],this.#fa(r);const[o,a,l,c]=this.#ua;for(let h=0,d=t.length;h<d;h+=2)t[h]=(t[h]-o)/l,t[h+1]=(t[h+1]-a)/c;for(let h=0,d=e.length;h<d;h+=2)e[h]=(e[h]-o)/l,e[h+1]=(e[h+1]-a)/c}toSVGPath(){const t=[`M${this.#pa[4]} ${this.#pa[5]}`];for(let e=6,n=this.#pa.length;e<n;e+=6)isNaN(this.#pa[e])?t.push(`L${this.#pa[e+4]} ${this.#pa[e+5]}`):t.push(`C${this.#pa[e]} ${this.#pa[e+1]} ${this.#pa[e+2]} ${this.#pa[e+3]} ${this.#pa[e+4]} ${this.#pa[e+5]}`);return t.push("Z"),t.join(" ")}serialize([t,e,n,i],s){const r=n-t,o=i-e;let a,l;switch(s){case 0:a=Cu._rescale(this.#pa,t,i,r,-o),l=Cu._rescale(this.#ea,t,i,r,-o);break;case 90:a=Cu._rescaleAndSwap(this.#pa,t,e,r,o),l=Cu._rescaleAndSwap(this.#ea,t,e,r,o);break;case 180:a=Cu._rescale(this.#pa,n,e,-r,o),l=Cu._rescale(this.#ea,n,e,-r,o);break;case 270:a=Cu._rescaleAndSwap(this.#pa,n,i,-r,-o),l=Cu._rescaleAndSwap(this.#ea,n,i,-r,-o)}return{outline:Array.from(a),points:[Array.from(l)]}}#fa(t){const e=this.#pa;let n=e[4],i=e[5];const s=[n,i,n,i];let r=n,o=i,a=n,l=i;const c=t?Math.max:Math.min,h=new Float32Array(4);for(let u=6,p=e.length;u<p;u+=6){const t=e[u+4],d=e[u+5];isNaN(e[u])?(fl.pointBoundingBox(t,d,s),o>d?(r=t,o=d):o===d&&(r=c(r,t)),l<d?(a=t,l=d):l===d&&(a=c(a,t))):(h[0]=h[1]=1/0,h[2]=h[3]=-1/0,fl.bezierBoundingBox(n,i,...e.slice(u,u+6),h),fl.rectBoundingBox(h[0],h[1],h[2],h[3],s),o>h[1]?(r=h[0],o=h[1]):o===h[1]&&(r=c(r,h[0])),l<h[3]?(a=h[2],l=h[3]):l===h[3]&&(a=c(a,h[2]))),n=t,i=d}const d=this.#ua;d[0]=s[0]-this.#Go,d[1]=s[1]-this.#Go,d[2]=s[2]-s[0]+2*this.#Go,d[3]=s[3]-s[1]+2*this.#Go,this.firstPoint=[r,o],this.lastPoint=[a,l]}get box(){return this.#ua}newOutliner(t,e,n,i,s,r=0){return new Mu(t,e,n,i,s,r)}getNewOutline(t,e){const[n,i,s,r]=this.#ua,[o,a,l,c]=this.#Uo,h=s*l,d=r*c,u=n*l+o,p=i*c+a,f=this.newOutliner({x:this.#ea[0]*h+u,y:this.#ea[1]*d+p},this.#Uo,this.#Zo,t,this.#jo,e??this.#Go);for(let m=2;m<this.#ea.length;m+=2)f.add({x:this.#ea[m]*h+u,y:this.#ea[m+1]*d+p});return f.getOutlines()}}class Du{#Uo;#ma;#ga;#ya=[];#ba=[];constructor(t,e=0,n=0,i=!0){const s=[1/0,1/0,-1/0,-1/0],r=10**-4;for(const{x:f,y:m,width:g,height:y}of t){const t=Math.floor((f-e)/r)*r,n=Math.ceil((f+g+e)/r)*r,i=Math.floor((m-e)/r)*r,o=Math.ceil((m+y+e)/r)*r,a=[t,i,o,!0],l=[n,i,o,!1];this.#ya.push(a,l),fl.rectBoundingBox(t,i,n,o,s)}const o=s[2]-s[0]+2*n,a=s[3]-s[1]+2*n,l=s[0]-n,c=s[1]-n;let h=i?-1/0:1/0,d=1/0;const u=this.#ya.at(i?-1:-2),p=[u[0],u[2]];for(const f of this.#ya){const[t,e,n,s]=f;!s&&i?e<d?(d=e,h=t):e===d&&(h=Math.max(h,t)):s&&!i&&(e<d?(d=e,h=t):e===d&&(h=Math.min(h,t))),f[0]=(t-l)/o,f[1]=(e-c)/a,f[2]=(n-c)/a}this.#Uo=new Float32Array([l,c,o,a]),this.#ma=[h,d],this.#ga=p}getOutlines(){this.#ya.sort((t,e)=>t[0]-e[0]||t[1]-e[1]||t[2]-e[2]);const t=[];for(const e of this.#ya)e[3]?(t.push(...this.#wa(e)),this.#va(e)):(this.#Aa(e),t.push(...this.#wa(e)));return this.#xa(t)}#xa(t){const e=[],n=new Set;for(const r of t){const[t,n,i]=r;e.push([t,n,r],[t,i,r])}e.sort((t,e)=>t[1]-e[1]||t[0]-e[0]);for(let r=0,o=e.length;r<o;r+=2){const t=e[r][2],i=e[r+1][2];t.push(i),i.push(t),n.add(t),n.add(i)}const i=[];let s;for(;n.size>0;){const t=n.values().next().value;let[e,r,o,a,l]=t;n.delete(t);let c=e,h=r;for(s=[e,o],i.push(s);;){let t;if(n.has(a))t=a;else{if(!n.has(l))break;t=l}n.delete(t),[e,r,o,a,l]=t,c!==e&&(s.push(c,h,e,h===r?r:o),c=e),h=h===r?o:r}s.push(c,h)}return new Iu(i,this.#Uo,this.#ma,this.#ga)}#Sa(t){const e=this.#ba;let n=0,i=e.length-1;for(;n<=i;){const s=n+i>>1,r=e[s][0];if(r===t)return s;r<t?n=s+1:i=s-1}return i+1}#va([,t,e]){const n=this.#Sa(t);this.#ba.splice(n,0,[t,e])}#Aa([,t,e]){const n=this.#Sa(t);for(let i=n;i<this.#ba.length;i++){const[n,s]=this.#ba[i];if(n!==t)break;if(n===t&&s===e)return void this.#ba.splice(i,1)}for(let i=n-1;i>=0;i--){const[n,s]=this.#ba[i];if(n!==t)break;if(n===t&&s===e)return void this.#ba.splice(i,1)}}#wa(t){const[e,n,i]=t,s=[[e,n,i]],r=this.#Sa(i);for(let o=0;o<r;o++){const[t,n]=this.#ba[o];for(let i=0,r=s.length;i<r;i++){const[,o,a]=s[i];if(!(n<=o||a<=t))if(o>=t)if(a>n)s[i][1]=n;else{if(1===r)return[];s.splice(i,1),i--,r--}else s[i][2]=t,a>n&&s.push([e,n,a])}}return s}}class Iu extends Cu{#Uo;#_a;constructor(t,e,n,i){super(),this.#_a=t,this.#Uo=e,this.firstPoint=n,this.lastPoint=i}toSVGPath(){const t=[];for(const e of this.#_a){let[n,i]=e;t.push(`M${n} ${i}`);for(let s=2;s<e.length;s+=2){const r=e[s],o=e[s+1];r===n?(t.push(`V${o}`),i=o):o===i&&(t.push(`H${r}`),n=r)}t.push("Z")}return t.join(" ")}serialize([t,e,n,i],s){const r=[],o=n-t,a=i-e;for(const l of this.#_a){const e=new Array(l.length);for(let n=0;n<l.length;n+=2)e[n]=t+l[n]*o,e[n+1]=i-l[n+1]*a;r.push(e)}return r}get box(){return this.#Uo}get classNamesForOutlining(){return["highlightOutline"]}}class Nu extends Mu{newFreeDrawOutline(t,e,n,i,s,r){return new Pu(t,e,n,i,s,r)}}class Pu extends ku{newOutliner(t,e,n,i,s,r=0){return new Nu(t,e,n,i,s,r)}}class Ou extends lc{#Ta=null;#Ea=0;#Ca;#Ma=null;#d=null;#ka=null;#Da=null;#Ia=0;#Na=null;#Pa=null;#N=null;#Oa=!1;#ma=null;#ga=null;#Ra=null;#Ae="";#ta;#Ba="";static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=12;static _type="highlight";static _editorType=Ta.HIGHLIGHT;static _freeHighlightId=-1;static _freeHighlight=null;static _freeHighlightClipId="";static get _keyboardManager(){const t=Ou.prototype;return il(this,"_keyboardManager",new nc([[["ArrowLeft","mac+ArrowLeft"],t._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],t._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],t._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],t._moveCaret,{args:[3]}]]))}constructor(t){super({...t,name:"highlightEditor"}),this.color=t.color||Ou._defaultColor,this.#ta=t.thickness||Ou._defaultThickness,this.opacity=t.opacity||Ou._defaultOpacity,this.#Ca=t.boxes||null,this.#Ba=t.methodOfCreation||"",this.#Ae=t.text||"",this._isDraggable=!1,this.defaultL10nId="pdfjs-editor-highlight-editor",t.highlightId>-1?(this.#Oa=!0,this.#Fa(t),this.#La()):this.#Ca&&(this.#Ta=t.anchorNode,this.#Ea=t.anchorOffset,this.#Da=t.focusNode,this.#Ia=t.focusOffset,this.#za(),this.#La(),this.rotate(this.rotation)),this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-highlight-added-alert")}get telemetryInitialData(){return{action:"added",type:this.#Oa?"free_highlight":"highlight",color:this._uiManager.getNonHCMColorName(this.color),thickness:this.#ta,methodOfCreation:this.#Ba}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.getNonHCMColorName(this.color)}}static computeTelemetryFinalData(t){return{numberOfColors:t.get("color").size}}#za(){const t=new Du(this.#Ca,.001);this.#Pa=t.getOutlines(),[this.x,this.y,this.width,this.height]=this.#Pa.box;const e=new Du(this.#Ca,.0025,.001,"ltr"===this._uiManager.direction);this.#ka=e.getOutlines();const{firstPoint:n}=this.#Pa;this.#ma=[(n[0]-this.x)/this.width,(n[1]-this.y)/this.height];const{lastPoint:i}=this.#ka;this.#ga=[(i[0]-this.x)/this.width,(i[1]-this.y)/this.height]}#Fa({highlightOutlines:t,highlightId:e,clipPathId:n}){this.#Pa=t;if(this.#ka=t.getNewOutline(this.#ta/2+1.5,.0025),e>=0)this.#N=e,this.#Ma=n,this.parent.drawLayer.finalizeDraw(e,{bbox:t.box,path:{d:t.toSVGPath()}}),this.#Ra=this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:!0},bbox:this.#ka.box,path:{d:this.#ka.toSVGPath()}},!0);else if(this.parent){const e=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(this.#N,{bbox:Ou.#Va(this.#Pa.box,(e-this.rotation+360)%360),path:{d:t.toSVGPath()}}),this.parent.drawLayer.updateProperties(this.#Ra,{bbox:Ou.#Va(this.#ka.box,e),path:{d:this.#ka.toSVGPath()}})}const[i,s,r,o]=t.box;switch(this.rotation){case 0:this.x=i,this.y=s,this.width=r,this.height=o;break;case 90:{const[t,e]=this.parentDimensions;this.x=s,this.y=1-i,this.width=r*e/t,this.height=o*t/e;break}case 180:this.x=1-i,this.y=1-s,this.width=r,this.height=o;break;case 270:{const[t,e]=this.parentDimensions;this.x=1-s,this.y=i,this.width=r*e/t,this.height=o*t/e;break}}const{firstPoint:a}=t;this.#ma=[(a[0]-i)/r,(a[1]-s)/o];const{lastPoint:l}=this.#ka;this.#ga=[(l[0]-i)/r,(l[1]-s)/o]}static initialize(t,e){lc.initialize(t,e),Ou._defaultColor||=e.highlightColors?.values().next().value||"#fff066"}static updateDefaultParams(t,e){switch(t){case Ea.HIGHLIGHT_COLOR:Ou._defaultColor=e;break;case Ea.HIGHLIGHT_THICKNESS:Ou._defaultThickness=e}}translateInPage(t,e){}get toolbarPosition(){return this.#ga}get commentButtonPosition(){return this.#ma}updateParams(t,e){switch(t){case Ea.HIGHLIGHT_COLOR:this.#lo(e);break;case Ea.HIGHLIGHT_THICKNESS:this.#Ha(e)}}static get defaultPropertiesToUpdate(){return[[Ea.HIGHLIGHT_COLOR,Ou._defaultColor],[Ea.HIGHLIGHT_THICKNESS,Ou._defaultThickness]]}get propertiesToUpdate(){return[[Ea.HIGHLIGHT_COLOR,this.color||Ou._defaultColor],[Ea.HIGHLIGHT_THICKNESS,this.#ta||Ou._defaultThickness],[Ea.HIGHLIGHT_FREE,this.#Oa]]}onUpdatedColor(){this.parent?.drawLayer.updateProperties(this.#N,{root:{fill:this.color,"fill-opacity":this.opacity}}),this.#d?.updateColor(this.color),super.onUpdatedColor()}#lo(t){const e=(t,e)=>{this.color=t,this.opacity=e,this.onUpdatedColor()},n=this.color,i=this.opacity;this.addCommands({cmd:e.bind(this,t,Ou._defaultOpacity),undo:e.bind(this,n,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:Ea.HIGHLIGHT_COLOR,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"color_changed",color:this._uiManager.getNonHCMColorName(t)},!0)}#Ha(t){const e=this.#ta,n=t=>{this.#ta=t,this.#$a(t)};this.addCommands({cmd:n.bind(this,t),undo:n.bind(this,e),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:Ea.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"thickness_changed",thickness:t},!0)}get toolbarButtons(){if(this._uiManager.highlightColors){return[["colorPicker",this.#d=new Hd({editor:this})]]}return super.toolbarButtons}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}fixAndSetPosition(){return super.fixAndSetPosition(this.#Ua())}getBaseTranslation(){return[0,0]}getRect(t,e){return super.getRect(t,e,this.#Ua())}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),t&&this.div.focus()}remove(){this.#Wa(),this._reportTelemetry({action:"deleted"}),super.remove()}rebuild(){this.parent&&(super.rebuild(),null!==this.div&&(this.#La(),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){let e=!1;this.parent&&!t?this.#Wa():t&&(this.#La(t),e=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(t),this.show(this._isVisible),e&&this.select()}#$a(t){this.#Oa&&(this.#Fa({highlightOutlines:this.#Pa.getNewOutline(t/2)}),this.fixAndSetPosition(),this.setDims())}#Wa(){null!==this.#N&&this.parent&&(this.parent.drawLayer.remove(this.#N),this.#N=null,this.parent.drawLayer.remove(this.#Ra),this.#Ra=null)}#La(t=this.parent){null===this.#N&&(({id:this.#N,clipPathId:this.#Ma}=t.drawLayer.draw({bbox:this.#Pa.box,root:{viewBox:"0 0 1 1",fill:this.color,"fill-opacity":this.opacity},rootClass:{highlight:!0,free:this.#Oa},path:{d:this.#Pa.toSVGPath()}},!1,!0)),this.#Ra=t.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:this.#Oa},bbox:this.#ka.box,path:{d:this.#ka.toSVGPath()}},this.#Oa),this.#Na&&(this.#Na.style.clipPath=this.#Ma))}static#Va([t,e,n,i],s){switch(s){case 90:return[1-e-i,t,i,n];case 180:return[1-t-n,1-e-i,n,i];case 270:return[e,1-t-n,i,n]}return[t,e,n,i]}rotate(t){const{drawLayer:e}=this.parent;let n;this.#Oa?(t=(t-this.rotation+360)%360,n=Ou.#Va(this.#Pa.box,t)):n=Ou.#Va([this.x,this.y,this.width,this.height],t),e.updateProperties(this.#N,{bbox:n,root:{"data-main-rotation":t}}),e.updateProperties(this.#Ra,{bbox:Ou.#Va(this.#ka.box,t),root:{"data-main-rotation":t}})}render(){if(this.div)return this.div;const t=super.render();this.#Ae&&(t.setAttribute("aria-label",this.#Ae),t.setAttribute("role","mark")),this.#Oa?t.classList.add("free"):this.div.addEventListener("keydown",this.#Ga.bind(this),{signal:this._uiManager._signal});const e=this.#Na=document.createElement("div");return t.append(e),e.setAttribute("aria-hidden","true"),e.className="internal",e.style.clipPath=this.#Ma,this.setDims(),Jl(this,this.#Na,["pointerover","pointerleave"]),this.enableEditing(),t}pointerover(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#Ra,{rootClass:{hovered:!0}})}pointerleave(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#Ra,{rootClass:{hovered:!1}})}#Ga(t){Ou._keyboardManager.exec(this,t)}_moveCaret(t){switch(this.parent.unselect(this),t){case 0:case 2:this.#ja(!0);break;case 1:case 3:this.#ja(!1)}}#ja(t){if(!this.#Ta)return;const e=window.getSelection();t?e.setPosition(this.#Ta,this.#Ea):e.setPosition(this.#Da,this.#Ia)}select(){super.select(),this.#Ra&&this.parent?.drawLayer.updateProperties(this.#Ra,{rootClass:{hovered:!1,selected:!0}})}unselect(){super.unselect(),this.#Ra&&(this.parent?.drawLayer.updateProperties(this.#Ra,{rootClass:{selected:!1}}),this.#Oa||this.#ja(!1))}get _mustFixPosition(){return!this.#Oa}show(t=this._isVisible){super.show(t),this.parent&&(this.parent.drawLayer.updateProperties(this.#N,{rootClass:{hidden:!t}}),this.parent.drawLayer.updateProperties(this.#Ra,{rootClass:{hidden:!t}}))}#Ua(){return this.#Oa?this.rotation:0}#Ka(){if(this.#Oa)return null;const[t,e]=this.pageDimensions,[n,i]=this.pageTranslation,s=this.#Ca,r=new Float32Array(8*s.length);let o=0;for(const{x:a,y:l,width:c,height:h}of s){const s=a*t+n,d=(1-l)*e+i;r[o]=r[o+4]=s,r[o+1]=r[o+3]=d,r[o+2]=r[o+6]=s+c*t,r[o+5]=r[o+7]=d-h*e,o+=8}return r}#qa(t){return this.#Pa.serialize(t,this.#Ua())}static startHighlighting(t,e,{target:n,x:i,y:s}){const{x:r,y:o,width:a,height:l}=n.getBoundingClientRect(),c=new AbortController,h=t.combinedSignal(c),d=e=>{c.abort(),this.#Ya(t,e)};window.addEventListener("blur",d,{signal:h}),window.addEventListener("pointerup",d,{signal:h}),window.addEventListener("pointerdown",Nl,{capture:!0,passive:!1,signal:h}),window.addEventListener("contextmenu",Il,{signal:h}),n.addEventListener("pointermove",this.#Xa.bind(this,t),{signal:h}),this._freeHighlight=new Nu({x:i,y:s},[r,o,a,l],t.scale,this._defaultThickness/2,e,.001),({id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=t.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:this._freeHighlight.toSVGPath()}},!0,!0))}static#Xa(t,e){this._freeHighlight.add(e)&&t.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})}static#Ya(t,e){this._freeHighlight.isEmpty()?t.drawLayer.remove(this._freeHighlightId):t.createAndAddNewEditor(e,!1,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"}),this._freeHighlightId=-1,this._freeHighlight=null,this._freeHighlightClipId=""}static async deserialize(t,e,n){let i=null;if(t instanceof bu){const{data:{quadPoints:e,rect:n,rotation:s,id:r,color:o,opacity:a,popupRef:l,richText:c,contentsObj:h,creationDate:d,modificationDate:u},parent:{page:{pageNumber:p}}}=t;i=t={annotationType:Ta.HIGHLIGHT,color:Array.from(o),opacity:a,quadPoints:e,boxes:null,pageIndex:p-1,rect:n.slice(0),rotation:s,annotationElementId:r,id:r,deleted:!1,popupRef:l,richText:c,comment:h?.str||null,creationDate:d,modificationDate:u}}else if(t instanceof yu){const{data:{inkLists:e,rect:n,rotation:s,id:r,color:o,borderStyle:{rawWidth:a},popupRef:l,richText:c,contentsObj:h,creationDate:d,modificationDate:u},parent:{page:{pageNumber:p}}}=t;i=t={annotationType:Ta.HIGHLIGHT,color:Array.from(o),thickness:a,inkLists:e,boxes:null,pageIndex:p-1,rect:n.slice(0),rotation:s,annotationElementId:r,id:r,deleted:!1,popupRef:l,richText:c,comment:h?.str||null,creationDate:d,modificationDate:u}}const{color:s,quadPoints:r,inkLists:o,opacity:a}=t,l=await super.deserialize(t,e,n);l.color=fl.makeHexColor(...s),l.opacity=a||1,o&&(l.#ta=t.thickness),l._initialData=i,t.comment&&l.setCommentData(t);const[c,h]=l.pageDimensions,[d,u]=l.pageTranslation;if(r){const t=l.#Ca=[];for(let e=0;e<r.length;e+=8)t.push({x:(r[e]-d)/c,y:1-(r[e+1]-u)/h,width:(r[e+2]-r[e])/c,height:(r[e+1]-r[e+5])/h});l.#za(),l.#La(),l.rotate(l.rotation)}else if(o){l.#Oa=!0;const t=o[0],n={x:t[0]-d,y:h-(t[1]-u)},i=new Nu(n,[0,0,c,h],1,l.#ta/2,!0,.001);for(let e=0,o=t.length;e<o;e+=2)n.x=t[e]-d,n.y=h-(t[e+1]-u),i.add(n);const{id:s,clipPathId:r}=e.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:l.color,"fill-opacity":l._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:i.toSVGPath()}},!0,!0);l.#Fa({highlightOutlines:i.getOutlines(),highlightId:s,clipPathId:r}),l.#La(),l.rotate(l.parentRotation)}return l}serialize(t=!1){if(this.isEmpty()||t)return null;if(this.deleted)return this.serializeDeleted();const e=lc._colorManager.convert(this._uiManager.getNonHCMColor(this.color)),n=super.serialize(t);return Object.assign(n,{color:e,opacity:this.opacity,thickness:this.#ta,quadPoints:this.#Ka(),outlines:this.#qa(n.rect)}),this.addComment(n),this.annotationElementId&&!this.#$o(n)?null:(n.id=this.annotationElementId,n)}#$o(t){const{color:e}=this._initialData;return this.hasEditedComment||t.color.some((t,n)=>t!==e[n])}renderAnnotationElement(t){return this.deleted?(t.hide(),null):(t.updateEdited({rect:this.getPDFRect(),popup:this.comment}),null)}static canCreateNewEmptyEditor(){return!1}}class Ru{#Ja=Object.create(null);updateProperty(t,e){this[t]=e,this.updateSVGProperty(t,e)}updateProperties(t){if(t)for(const[e,n]of Object.entries(t))e.startsWith("_")||this.updateProperty(e,n)}updateSVGProperty(t,e){this.#Ja[t]=e}toSVGProperties(){const t=this.#Ja;return this.#Ja=Object.create(null),{root:t}}reset(){this.#Ja=Object.create(null)}updateAll(t=this){this.updateProperties(t)}clone(){Za("Not implemented")}}class Bu extends lc{#Qa=null;#Za;_colorPicker=null;_drawId=null;static _currentDrawId=-1;static _currentParent=null;static#tl=null;static#el=null;static#nl=null;static _INNER_MARGIN=3;constructor(t){super(t),this.#Za=t.mustBeCommitted||!1,this._addOutlines(t)}onUpdatedColor(){this._colorPicker?.update(this.color),super.onUpdatedColor()}_addOutlines(t){t.drawOutlines&&(this.#il(t),this.#La())}#il({drawOutlines:t,drawId:e,drawingOptions:n}){this.#Qa=t,this._drawingOptions||=n,this.annotationElementId||this._uiManager.a11yAlert(`pdfjs-editor-${this.editorType}-added-alert`),e>=0?(this._drawId=e,this.parent.drawLayer.finalizeDraw(e,t.defaultProperties)):this._drawId=this.#sl(t,this.parent),this.#rl(t.box)}#sl(t,e){const{id:n}=e.drawLayer.draw(Bu._mergeSVGProperties(this._drawingOptions.toSVGProperties(),t.defaultSVGProperties),!1,!1);return n}static _mergeSVGProperties(t,e){const n=new Set(Object.keys(t));for(const[i,s]of Object.entries(e))n.has(i)?Object.assign(t[i],s):t[i]=s;return t}static getDefaultDrawingOptions(t){Za("Not implemented")}static get typesMap(){Za("Not implemented")}static get isDrawer(){return!0}static get supportMultipleDrawings(){return!1}static updateDefaultParams(t,e){const n=this.typesMap.get(t);n&&this._defaultDrawingOptions.updateProperty(n,e),this._currentParent&&(Bu.#tl.updateProperty(n,e),this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}updateParams(t,e){const n=this.constructor.typesMap.get(t);n&&this._updateProperty(t,n,e)}static get defaultPropertiesToUpdate(){const t=[],e=this._defaultDrawingOptions;for(const[n,i]of this.typesMap)t.push([n,e[i]]);return t}get propertiesToUpdate(){const t=[],{_drawingOptions:e}=this;for(const[n,i]of this.constructor.typesMap)t.push([n,e[i]]);return t}_updateProperty(t,e,n){const i=this._drawingOptions,s=i[e],r=n=>{i.updateProperty(e,n);const s=this.#Qa.updateProperty(e,n);s&&this.#rl(s),this.parent?.drawLayer.updateProperties(this._drawId,i.toSVGProperties()),t===this.colorType&&this.onUpdatedColor()};this.addCommands({cmd:r.bind(this,n),undo:r.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:t,overwriteIfSameType:!0,keepUndo:!0})}_onResizing(){this.parent?.drawLayer.updateProperties(this._drawId,Bu._mergeSVGProperties(this.#Qa.getPathResizingSVGProperties(this.#ol()),{bbox:this.#al()}))}_onResized(){this.parent?.drawLayer.updateProperties(this._drawId,Bu._mergeSVGProperties(this.#Qa.getPathResizedSVGProperties(this.#ol()),{bbox:this.#al()}))}_onTranslating(t,e){this.parent?.drawLayer.updateProperties(this._drawId,{bbox:this.#al()})}_onTranslated(){this.parent?.drawLayer.updateProperties(this._drawId,Bu._mergeSVGProperties(this.#Qa.getPathTranslatedSVGProperties(this.#ol(),this.parentDimensions),{bbox:this.#al()}))}_onStartDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!0}})}_onStopDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!1}})}commit(){super.commit(),this.disableEditMode(),this.disableEditing()}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}getBaseTranslation(){return[0,0]}get isResizable(){return!0}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),this._isDraggable=!0,this.#Za&&(this.#Za=!1,this.commit(),this.parent.setSelected(this),t&&this.isOnScreen&&this.div.focus())}remove(){this.#Wa(),super.remove()}rebuild(){this.parent&&(super.rebuild(),null!==this.div&&(this.#La(),this.#rl(this.#Qa.box),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){let e=!1;this.parent&&!t?(this._uiManager.removeShouldRescale(this),this.#Wa()):t&&(this._uiManager.addShouldRescale(this),this.#La(t),e=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(t),e&&this.select()}#Wa(){null!==this._drawId&&this.parent&&(this.parent.drawLayer.remove(this._drawId),this._drawId=null,this._drawingOptions.reset())}#La(t=this.parent){null!==this._drawId&&this.parent===t||(null===this._drawId?(this._drawingOptions.updateAll(),this._drawId=this.#sl(this.#Qa,t)):this.parent.drawLayer.updateParent(this._drawId,t.drawLayer))}#ll([t,e,n,i]){const{parentDimensions:[s,r],rotation:o}=this;switch(o){case 90:return[e,1-t,n*(r/s),i*(s/r)];case 180:return[1-t,1-e,n,i];case 270:return[1-e,t,n*(r/s),i*(s/r)];default:return[t,e,n,i]}}#ol(){const{x:t,y:e,width:n,height:i,parentDimensions:[s,r],rotation:o}=this;switch(o){case 90:return[1-e,t,n*(s/r),i*(r/s)];case 180:return[1-t,1-e,n,i];case 270:return[e,1-t,n*(s/r),i*(r/s)];default:return[t,e,n,i]}}#rl(t){[this.x,this.y,this.width,this.height]=this.#ll(t),this.div&&(this.fixAndSetPosition(),this.setDims()),this._onResized()}#al(){const{x:t,y:e,width:n,height:i,rotation:s,parentRotation:r,parentDimensions:[o,a]}=this;switch((4*s+r)/90){case 1:return[1-e-i,t,i,n];case 2:return[1-t-n,1-e-i,n,i];case 3:return[e,1-t-n,i,n];case 4:return[t,e-n*(o/a),i*(a/o),n*(o/a)];case 5:return[1-e,t,n*(o/a),i*(a/o)];case 6:return[1-t-i*(a/o),1-e,i*(a/o),n*(o/a)];case 7:return[e-n*(o/a),1-t-i*(a/o),n*(o/a),i*(a/o)];case 8:return[t-n,e-i,n,i];case 9:return[1-e,t-n,i,n];case 10:return[1-t,1-e,n,i];case 11:return[e-i,1-t,i,n];case 12:return[t-i*(a/o),e,i*(a/o),n*(o/a)];case 13:return[1-e-n*(o/a),t-i*(a/o),n*(o/a),i*(a/o)];case 14:return[1-t,1-e-n*(o/a),i*(a/o),n*(o/a)];case 15:return[e,1-t,n*(o/a),i*(a/o)];default:return[t,e,n,i]}}rotate(){this.parent&&this.parent.drawLayer.updateProperties(this._drawId,Bu._mergeSVGProperties({bbox:this.#al()},this.#Qa.updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){this.parent&&this.#rl(this.#Qa.updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div)return this.div;let t,e;this._isCopy&&(t=this.x,e=this.y);const n=super.render();n.classList.add("draw");const i=document.createElement("div");return n.append(i),i.setAttribute("aria-hidden","true"),i.className="internal",this.setDims(),this._uiManager.addShouldRescale(this),this.disableEditing(),this._isCopy&&this._moveAfterPaste(t,e),n}static createDrawerInstance(t,e,n,i,s){Za("Not implemented")}static startDrawing(t,e,n,i){const{target:s,offsetX:r,offsetY:o,pointerId:a,pointerType:l}=i;if(Ql.isInitializedAndDifferentPointerType(l))return;const{viewport:{rotation:c}}=t,{width:h,height:d}=s.getBoundingClientRect(),u=Bu.#el=new AbortController,p=t.combinedSignal(u);Ql.setPointer(l,a),window.addEventListener("pointerup",t=>{Ql.isSamePointerIdOrRemove(t.pointerId)&&this._endDraw(t)},{signal:p}),window.addEventListener("pointercancel",t=>{Ql.isSamePointerIdOrRemove(t.pointerId)&&this._currentParent.endDrawingSession()},{signal:p}),window.addEventListener("pointerdown",t=>{Ql.isSamePointerType(t.pointerType)&&(Ql.initializeAndAddPointerId(t.pointerId),Bu.#tl.isCancellable()&&(Bu.#tl.removeLastElement(),Bu.#tl.isEmpty()?this._currentParent.endDrawingSession(!0):this._endDraw(null)))},{capture:!0,passive:!1,signal:p}),window.addEventListener("contextmenu",Il,{signal:p}),s.addEventListener("pointermove",this._drawMove.bind(this),{signal:p}),s.addEventListener("touchmove",t=>{Ql.isSameTimeStamp(t.timeStamp)&&Nl(t)},{signal:p}),t.toggleDrawing(),e._editorUndoBar?.hide(),Bu.#tl?t.drawLayer.updateProperties(this._currentDrawId,Bu.#tl.startNew(r,o,h,d,c)):(e.updateUIForDefaultProperties(this),Bu.#tl=this.createDrawerInstance(r,o,h,d,c),Bu.#nl=this.getDefaultDrawingOptions(),this._currentParent=t,({id:this._currentDrawId}=t.drawLayer.draw(this._mergeSVGProperties(Bu.#nl.toSVGProperties(),Bu.#tl.defaultSVGProperties),!0,!1)))}static _drawMove(t){if(Ql.isSameTimeStamp(t.timeStamp),!Bu.#tl)return;const{offsetX:e,offsetY:n,pointerId:i}=t;Ql.isSamePointerId(i)&&(Ql.isUsingMultiplePointers()?this._endDraw(t):(this._currentParent.drawLayer.updateProperties(this._currentDrawId,Bu.#tl.add(e,n)),Ql.setTimeStamp(t.timeStamp),Nl(t)))}static _cleanup(t){t&&(this._currentDrawId=-1,this._currentParent=null,Bu.#tl=null,Bu.#nl=null,Ql.clearTimeStamp()),Bu.#el&&(Bu.#el.abort(),Bu.#el=null,Ql.clearPointerIds())}static _endDraw(t){const e=this._currentParent;if(e){if(e.toggleDrawing(!0),this._cleanup(!1),t?.target===e.div&&e.drawLayer.updateProperties(this._currentDrawId,Bu.#tl.end(t.offsetX,t.offsetY)),this.supportMultipleDrawings){const t=Bu.#tl,n=this._currentDrawId,i=t.getLastElement();return void e.addCommands({cmd:()=>{e.drawLayer.updateProperties(n,t.setLastElement(i))},undo:()=>{e.drawLayer.updateProperties(n,t.removeLastElement())},mustExec:!1,type:Ea.DRAW_STEP})}this.endDrawing(!1)}}static endDrawing(t){const e=this._currentParent;if(!e)return null;if(e.toggleDrawing(!0),e.cleanUndoStack(Ea.DRAW_STEP),!Bu.#tl.isEmpty()){const{pageDimensions:[n,i],scale:s}=e,r=e.createAndAddNewEditor({offsetX:0,offsetY:0},!1,{drawId:this._currentDrawId,drawOutlines:Bu.#tl.getOutlines(n*s,i*s,s,this._INNER_MARGIN),drawingOptions:Bu.#nl,mustBeCommitted:!t});return this._cleanup(!0),r}return e.drawLayer.remove(this._currentDrawId),this._cleanup(!0),null}createDrawingOptions(t){}static deserializeDraw(t,e,n,i,s,r){Za("Not implemented")}static async deserialize(t,e,n){const{rawDims:{pageWidth:i,pageHeight:s,pageX:r,pageY:o}}=e.viewport,a=this.deserializeDraw(r,o,i,s,this._INNER_MARGIN,t),l=await super.deserialize(t,e,n);return l.createDrawingOptions(t),l.#il({drawOutlines:a}),l.#La(),l.onScaleChanging(),l.rotate(),l}serializeDraw(t){const[e,n]=this.pageTranslation,[i,s]=this.pageDimensions;return this.#Qa.serialize([e,n,i,s],t)}renderAnnotationElement(t){return t.updateEdited({rect:this.getPDFRect()}),null}static canCreateNewEmptyEditor(){return!1}}class Fu{#qo=new Float64Array(6);#mo;#cl;#Ds;#ta;#ea;#hl="";#dl=0;#_a=new Lu;#ul;#pl;constructor(t,e,n,i,s,r){this.#ul=n,this.#pl=i,this.#Ds=s,this.#ta=r,[t,e]=this.#fl(t,e);const o=this.#mo=[NaN,NaN,NaN,NaN,t,e];this.#ea=[t,e],this.#cl=[{line:o,points:this.#ea}],this.#qo.set(o,0)}updateProperty(t,e){"stroke-width"===t&&(this.#ta=e)}#fl(t,e){return Cu._normalizePoint(t,e,this.#ul,this.#pl,this.#Ds)}isEmpty(){return!this.#cl||0===this.#cl.length}isCancellable(){return this.#ea.length<=10}add(t,e){[t,e]=this.#fl(t,e);const[n,i,s,r]=this.#qo.subarray(2,6),o=t-s,a=e-r;return Math.hypot(this.#ul*o,this.#pl*a)<=2?null:(this.#ea.push(t,e),isNaN(n)?(this.#qo.set([s,r,t,e],2),this.#mo.push(NaN,NaN,NaN,NaN,t,e),{path:{d:this.toSVGPath()}}):(isNaN(this.#qo[0])&&this.#mo.splice(6,6),this.#qo.set([n,i,s,r,t,e],0),this.#mo.push(...Cu.createBezierPoints(n,i,s,r,t,e)),{path:{d:this.toSVGPath()}}))}end(t,e){const n=this.add(t,e);return n||(2===this.#ea.length?{path:{d:this.toSVGPath()}}:null)}startNew(t,e,n,i,s){this.#ul=n,this.#pl=i,this.#Ds=s,[t,e]=this.#fl(t,e);const r=this.#mo=[NaN,NaN,NaN,NaN,t,e];this.#ea=[t,e];const o=this.#cl.at(-1);return o&&(o.line=new Float32Array(o.line),o.points=new Float32Array(o.points)),this.#cl.push({line:r,points:this.#ea}),this.#qo.set(r,0),this.#dl=0,this.toSVGPath(),null}getLastElement(){return this.#cl.at(-1)}setLastElement(t){return this.#cl?(this.#cl.push(t),this.#mo=t.line,this.#ea=t.points,this.#dl=0,{path:{d:this.toSVGPath()}}):this.#_a.setLastElement(t)}removeLastElement(){if(!this.#cl)return this.#_a.removeLastElement();this.#cl.pop(),this.#hl="";for(let t=0,e=this.#cl.length;t<e;t++){const{line:e,points:n}=this.#cl[t];this.#mo=e,this.#ea=n,this.#dl=0,this.toSVGPath()}return{path:{d:this.#hl}}}toSVGPath(){const t=Cu.svgRound(this.#mo[4]),e=Cu.svgRound(this.#mo[5]);if(2===this.#ea.length)return this.#hl=`${this.#hl} M ${t} ${e} Z`,this.#hl;if(this.#ea.length<=6){const n=this.#hl.lastIndexOf("M");this.#hl=`${this.#hl.slice(0,n)} M ${t} ${e}`,this.#dl=6}if(4===this.#ea.length){const t=Cu.svgRound(this.#mo[10]),e=Cu.svgRound(this.#mo[11]);return this.#hl=`${this.#hl} L ${t} ${e}`,this.#dl=12,this.#hl}const n=[];0===this.#dl&&(n.push(`M ${t} ${e}`),this.#dl=6);for(let i=this.#dl,s=this.#mo.length;i<s;i+=6){const[t,e,s,r,o,a]=this.#mo.slice(i,i+6).map(Cu.svgRound);n.push(`C${t} ${e} ${s} ${r} ${o} ${a}`)}return this.#hl+=n.join(" "),this.#dl=this.#mo.length,this.#hl}getOutlines(t,e,n,i){const s=this.#cl.at(-1);return s.line=new Float32Array(s.line),s.points=new Float32Array(s.points),this.#_a.build(this.#cl,t,e,n,this.#Ds,this.#ta,i),this.#qo=null,this.#mo=null,this.#cl=null,this.#hl=null,this.#_a}get defaultSVGProperties(){return{root:{viewBox:"0 0 10000 10000"},rootClass:{draw:!0},bbox:[0,0,1,1]}}}class Lu extends Cu{#ua;#ml=0;#Go;#cl;#ul;#pl;#gl;#Ds;#ta;build(t,e,n,i,s,r,o){this.#ul=e,this.#pl=n,this.#gl=i,this.#Ds=s,this.#ta=r,this.#Go=o??0,this.#cl=t,this.#yl()}get thickness(){return this.#ta}setLastElement(t){return this.#cl.push(t),{path:{d:this.toSVGPath()}}}removeLastElement(){return this.#cl.pop(),{path:{d:this.toSVGPath()}}}toSVGPath(){const t=[];for(const{line:e}of this.#cl)if(t.push(`M${Cu.svgRound(e[4])} ${Cu.svgRound(e[5])}`),6!==e.length)if(12===e.length&&isNaN(e[6]))t.push(`L${Cu.svgRound(e[10])} ${Cu.svgRound(e[11])}`);else for(let n=6,i=e.length;n<i;n+=6){const[i,s,r,o,a,l]=e.subarray(n,n+6).map(Cu.svgRound);t.push(`C${i} ${s} ${r} ${o} ${a} ${l}`)}else t.push("Z");return t.join("")}serialize([t,e,n,i],s){const r=[],o=[],[a,l,c,h]=this.#bl();let d,u,p,f,m,g,y,b,w;switch(this.#Ds){case 0:w=Cu._rescale,d=t,u=e+i,p=n,f=-i,m=t+a*n,g=e+(1-l-h)*i,y=t+(a+c)*n,b=e+(1-l)*i;break;case 90:w=Cu._rescaleAndSwap,d=t,u=e,p=n,f=i,m=t+l*n,g=e+a*i,y=t+(l+h)*n,b=e+(a+c)*i;break;case 180:w=Cu._rescale,d=t+n,u=e,p=-n,f=i,m=t+(1-a-c)*n,g=e+l*i,y=t+(1-a)*n,b=e+(l+h)*i;break;case 270:w=Cu._rescaleAndSwap,d=t+n,u=e+i,p=-n,f=-i,m=t+(1-l-h)*n,g=e+(1-a-c)*i,y=t+(1-l)*n,b=e+(1-a)*i}for(const{line:v,points:A}of this.#cl)r.push(w(v,d,u,p,f,s?new Array(v.length):null)),o.push(w(A,d,u,p,f,s?new Array(A.length):null));return{lines:r,points:o,rect:[m,g,y,b]}}static deserialize(t,e,n,i,s,{paths:{lines:r,points:o},rotation:a,thickness:l}){const c=[];let h,d,u,p,f;switch(a){case 0:f=Cu._rescale,h=-t/n,d=e/i+1,u=1/n,p=-1/i;break;case 90:f=Cu._rescaleAndSwap,h=-e/i,d=-t/n,u=1/i,p=1/n;break;case 180:f=Cu._rescale,h=t/n+1,d=-e/i,u=-1/n,p=1/i;break;case 270:f=Cu._rescaleAndSwap,h=e/i+1,d=t/n+1,u=-1/i,p=-1/n}if(!r){r=[];for(const t of o){const e=t.length;if(2===e){r.push(new Float32Array([NaN,NaN,NaN,NaN,t[0],t[1]]));continue}if(4===e){r.push(new Float32Array([NaN,NaN,NaN,NaN,t[0],t[1],NaN,NaN,NaN,NaN,t[2],t[3]]));continue}const n=new Float32Array(3*(e-2));r.push(n);let[i,s,o,a]=t.subarray(0,4);n.set([NaN,NaN,NaN,NaN,i,s],0);for(let r=4;r<e;r+=2){const e=t[r],l=t[r+1];n.set(Cu.createBezierPoints(i,s,o,a,e,l),3*(r-2)),[i,s,o,a]=[o,a,e,l]}}}for(let g=0,y=r.length;g<y;g++)c.push({line:f(r[g].map(t=>t??NaN),h,d,u,p),points:f(o[g].map(t=>t??NaN),h,d,u,p)});const m=new this.prototype.constructor;return m.build(c,n,i,1,a,l,s),m}#wl(t=this.#ta){const e=this.#Go+t/2*this.#gl;return this.#Ds%180==0?[e/this.#ul,e/this.#pl]:[e/this.#pl,e/this.#ul]}#bl(){const[t,e,n,i]=this.#ua,[s,r]=this.#wl(0);return[t+s,e+r,n-2*s,i-2*r]}#yl(){const t=this.#ua=new Float32Array([1/0,1/0,-1/0,-1/0]);for(const{line:i}of this.#cl){if(i.length<=12){for(let e=4,n=i.length;e<n;e+=6)fl.pointBoundingBox(i[e],i[e+1],t);continue}let e=i[4],n=i[5];for(let s=6,r=i.length;s<r;s+=6){const[r,o,a,l,c,h]=i.subarray(s,s+6);fl.bezierBoundingBox(e,n,r,o,a,l,c,h,t),e=c,n=h}}const[e,n]=this.#wl();t[0]=wl(t[0]-e,0,1),t[1]=wl(t[1]-n,0,1),t[2]=wl(t[2]+e,0,1),t[3]=wl(t[3]+n,0,1),t[2]-=t[0],t[3]-=t[1]}get box(){return this.#ua}updateProperty(t,e){return"stroke-width"===t?this.#Ha(e):null}#Ha(t){const[e,n]=this.#wl();this.#ta=t;const[i,s]=this.#wl(),[r,o]=[i-e,s-n],a=this.#ua;return a[0]-=r,a[1]-=o,a[2]+=2*r,a[3]+=2*o,a}updateParentDimensions([t,e],n){const[i,s]=this.#wl();this.#ul=t,this.#pl=e,this.#gl=n;const[r,o]=this.#wl(),a=r-i,l=o-s,c=this.#ua;return c[0]-=a,c[1]-=l,c[2]+=2*a,c[3]+=2*l,c}updateRotation(t){return this.#ml=t,{path:{transform:this.rotationTransform}}}get viewBox(){return this.#ua.map(Cu.svgRound).join(" ")}get defaultProperties(){const[t,e]=this.#ua;return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Cu.svgRound(t)} ${Cu.svgRound(e)}`}}}get rotationTransform(){const[,,t,e]=this.#ua;let n=0,i=0,s=0,r=0,o=0,a=0;switch(this.#ml){case 90:i=e/t,s=-t/e,o=t;break;case 180:n=-1,r=-1,o=t,a=e;break;case 270:i=-e/t,s=t/e,a=e;break;default:return""}return`matrix(${n} ${i} ${s} ${r} ${Cu.svgRound(o)} ${Cu.svgRound(a)})`}getPathResizingSVGProperties([t,e,n,i]){const[s,r]=this.#wl(),[o,a,l,c]=this.#ua;if(Math.abs(l-s)<=Cu.PRECISION||Math.abs(c-r)<=Cu.PRECISION){const s=t+n/2-(o+l/2),r=e+i/2-(a+c/2);return{path:{"transform-origin":`${Cu.svgRound(t)} ${Cu.svgRound(e)}`,transform:`${this.rotationTransform} translate(${s} ${r})`}}}const h=(n-2*s)/(l-2*s),d=(i-2*r)/(c-2*r),u=l/n,p=c/i;return{path:{"transform-origin":`${Cu.svgRound(o)} ${Cu.svgRound(a)}`,transform:`${this.rotationTransform} scale(${u} ${p}) translate(${Cu.svgRound(s)} ${Cu.svgRound(r)}) scale(${h} ${d}) translate(${Cu.svgRound(-s)} ${Cu.svgRound(-r)})`}}}getPathResizedSVGProperties([t,e,n,i]){const[s,r]=this.#wl(),o=this.#ua,[a,l,c,h]=o;if(o[0]=t,o[1]=e,o[2]=n,o[3]=i,Math.abs(c-s)<=Cu.PRECISION||Math.abs(h-r)<=Cu.PRECISION){const s=t+n/2-(a+c/2),r=e+i/2-(l+h/2);for(const{line:t,points:e}of this.#cl)Cu._translate(t,s,r,t),Cu._translate(e,s,r,e);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Cu.svgRound(t)} ${Cu.svgRound(e)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}const d=(n-2*s)/(c-2*s),u=(i-2*r)/(h-2*r),p=-d*(a+s)+t+s,f=-u*(l+r)+e+r;if(1!==d||1!==u||0!==p||0!==f)for(const{line:m,points:g}of this.#cl)Cu._rescale(m,p,f,d,u,m),Cu._rescale(g,p,f,d,u,g);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${Cu.svgRound(t)} ${Cu.svgRound(e)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([t,e],n){const[i,s]=n,r=this.#ua,o=t-r[0],a=e-r[1];if(this.#ul===i&&this.#pl===s)for(const{line:l,points:c}of this.#cl)Cu._translate(l,o,a,l),Cu._translate(c,o,a,c);else{const t=this.#ul/i,e=this.#pl/s;this.#ul=i,this.#pl=s;for(const{line:n,points:i}of this.#cl)Cu._rescale(n,o,a,t,e,n),Cu._rescale(i,o,a,t,e,i);r[2]*=t,r[3]*=e}return r[0]=t,r[1]=e,{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${Cu.svgRound(t)} ${Cu.svgRound(e)}`}}}get defaultSVGProperties(){const t=this.#ua;return{root:{viewBox:this.viewBox},rootClass:{draw:!0},path:{d:this.toSVGPath(),"transform-origin":`${Cu.svgRound(t[0])} ${Cu.svgRound(t[1])}`,transform:this.rotationTransform||null},bbox:t}}}class zu extends Ru{constructor(t){super(),this._viewParameters=t,super.updateProperties({fill:"none",stroke:lc._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-miterlimit":10})}updateSVGProperty(t,e){"stroke-width"===t&&(e??=this["stroke-width"],e*=this._viewParameters.realScale),super.updateSVGProperty(t,e)}clone(){const t=new zu(this._viewParameters);return t.updateAll(this),t}}class Vu extends Bu{static _type="ink";static _editorType=Ta.INK;static _defaultDrawingOptions=null;constructor(t){super({...t,name:"inkEditor"}),this._willKeepAspectRatio=!0,this.defaultL10nId="pdfjs-editor-ink-editor"}static initialize(t,e){lc.initialize(t,e),this._defaultDrawingOptions=new zu(e.viewParameters)}static getDefaultDrawingOptions(t){const e=this._defaultDrawingOptions.clone();return e.updateProperties(t),e}static get supportMultipleDrawings(){return!0}static get typesMap(){return il(this,"typesMap",new Map([[Ea.INK_THICKNESS,"stroke-width"],[Ea.INK_COLOR,"stroke"],[Ea.INK_OPACITY,"stroke-opacity"]]))}static createDrawerInstance(t,e,n,i,s){return new Fu(t,e,n,i,s,this._defaultDrawingOptions["stroke-width"])}static deserializeDraw(t,e,n,i,s,r){return Lu.deserialize(t,e,n,i,s,r)}static async deserialize(t,e,n){let i=null;if(t instanceof yu){const{data:{inkLists:e,rect:n,rotation:s,id:r,color:o,opacity:a,borderStyle:{rawWidth:l},popupRef:c,richText:h,contentsObj:d,creationDate:u,modificationDate:p},parent:{page:{pageNumber:f}}}=t;i=t={annotationType:Ta.INK,color:Array.from(o),thickness:l,opacity:a,paths:{points:e},boxes:null,pageIndex:f-1,rect:n.slice(0),rotation:s,annotationElementId:r,id:r,deleted:!1,popupRef:c,richText:h,comment:d?.str||null,creationDate:u,modificationDate:p}}const s=await super.deserialize(t,e,n);return s._initialData=i,t.comment&&s.setCommentData(t),s}get toolbarButtons(){return this._colorPicker||=new $d(this),[["colorPicker",this._colorPicker]]}get colorType(){return Ea.INK_COLOR}get color(){return this._drawingOptions.stroke}get opacity(){return this._drawingOptions["stroke-opacity"]}onScaleChanging(){if(!this.parent)return;super.onScaleChanging();const{_drawId:t,_drawingOptions:e,parent:n}=this;e.updateSVGProperty("stroke-width"),n.drawLayer.updateProperties(t,e.toSVGProperties())}static onScaleChangingWhenDrawing(){const t=this._currentParent;t&&(super.onScaleChangingWhenDrawing(),this._defaultDrawingOptions.updateSVGProperty("stroke-width"),t.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}createDrawingOptions({color:t,thickness:e,opacity:n}){this._drawingOptions=Vu.getDefaultDrawingOptions({stroke:fl.makeHexColor(...t),"stroke-width":e,"stroke-opacity":n})}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const{lines:e,points:n}=this.serializeDraw(t),{_drawingOptions:{stroke:i,"stroke-opacity":s,"stroke-width":r}}=this,o=Object.assign(super.serialize(t),{color:lc._colorManager.convert(i),opacity:s,thickness:r,paths:{lines:e,points:n}});return this.addComment(o),t?(o.isCopy=!0,o):this.annotationElementId&&!this.#$o(o)?null:(o.id=this.annotationElementId,o)}#$o(t){const{color:e,thickness:n,opacity:i,pageIndex:s}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||this._hasBeenResized||t.color.some((t,n)=>t!==e[n])||t.thickness!==n||t.opacity!==i||t.pageIndex!==s}renderAnnotationElement(t){if(this.deleted)return t.hide(),null;const{points:e,rect:n}=this.serializeDraw(!1);return t.updateEdited({rect:n,thickness:this._drawingOptions["stroke-width"],points:e,popup:this.comment}),null}}class Hu extends Lu{toSVGPath(){let t=super.toSVGPath();return t.endsWith("Z")||(t+="Z"),t}}class $u{static#vl={maxDim:512,sigmaSFactor:.02,sigmaR:25,kernelSize:16};static#Al(t,e,n,i){return i-=e,0===(n-=t)?i>0?0:4:1===n?i+6:2-i}static#xl=new Int32Array([0,1,-1,1,-1,0,-1,-1,0,-1,1,-1,1,0,1,1]);static#Sl(t,e,n,i,s,r,o){const a=this.#Al(n,i,s,r);for(let l=0;l<8;l++){const s=(-l+a-o+16)%8;if(0!==t[(n+this.#xl[2*s])*e+(i+this.#xl[2*s+1])])return s}return-1}static#_l(t,e,n,i,s,r,o){const a=this.#Al(n,i,s,r);for(let l=0;l<8;l++){const s=(l+a+o+16)%8;if(0!==t[(n+this.#xl[2*s])*e+(i+this.#xl[2*s+1])])return s}return-1}static#Tl(t,e,n,i){const s=t.length,r=new Int32Array(s);for(let c=0;c<s;c++)r[c]=t[c]<=i?1:0;for(let c=1;c<n-1;c++)r[c*e]=r[c*e+e-1]=0;for(let c=0;c<e;c++)r[c]=r[e*n-1-c]=0;let o,a=1;const l=[];for(let c=1;c<n-1;c++){o=1;for(let t=1;t<e-1;t++){const n=c*e+t,i=r[n];if(0===i)continue;let s=c,h=t;if(1===i&&0===r[n-1])a+=1,h-=1;else{if(!(i>=1&&0===r[n+1])){1!==i&&(o=Math.abs(i));continue}a+=1,h+=1,i>1&&(o=i)}const d=[t,c],u=h===t+1,p={isHole:u,points:d,id:a,parent:0};let f;l.push(p);for(const t of l)if(t.id===o){f=t;break}f?f.isHole?p.parent=u?f.parent:o:p.parent=u?o:f.parent:p.parent=u?o:0;const m=this.#Sl(r,e,c,t,s,h,0);if(-1===m){r[n]=-a,1!==r[n]&&(o=Math.abs(r[n]));continue}let g=this.#xl[2*m],y=this.#xl[2*m+1];const b=c+g,w=t+y;s=b,h=w;let v=c,A=t;for(;;){const i=this.#_l(r,e,v,A,s,h,1);g=this.#xl[2*i],y=this.#xl[2*i+1];const l=v+g,u=A+y;d.push(u,l);const p=v*e+A;if(0===r[p+1]?r[p]=-a:1===r[p]&&(r[p]=a),l===c&&u===t&&v===b&&A===w){1!==r[n]&&(o=Math.abs(r[n]));break}s=v,h=A,v=l,A=u}}}return l}static#El(t,e,n,i){if(n-e<=4){for(let s=e;s<n-2;s+=2)i.push(t[s],t[s+1]);return}const s=t[e],r=t[e+1],o=t[n-4]-s,a=t[n-3]-r,l=Math.hypot(o,a),c=o/l,h=a/l,d=c*r-h*s,u=a/o,p=1/l,f=Math.atan(u),m=Math.cos(f),g=Math.sin(f),y=p*(Math.abs(m)+Math.abs(g)),b=p*(1-y+y**2),w=Math.max(Math.atan(Math.abs(g+m)*b),Math.atan(Math.abs(g-m)*b));let v=0,A=e;for(let x=e+2;x<n-2;x+=2){const e=Math.abs(d-c*t[x+1]+h*t[x]);e>v&&(A=x,v=e)}v>(l*w)**2?(this.#El(t,e,A+2,i),this.#El(t,A,n,i)):i.push(s,r)}static#Cl(t){const e=[],n=t.length;return this.#El(t,0,n,e),e.push(t[n-2],t[n-1]),e.length<=4?null:e}static#Ml(t,e,n,i,s,r){const o=new Float32Array(r**2),a=-2*i**2,l=r>>1;for(let f=0;f<r;f++){const t=(f-l)**2;for(let e=0;e<r;e++)o[f*r+e]=Math.exp((t+(e-l)**2)/a)}const c=new Float32Array(256),h=-2*s**2;for(let f=0;f<256;f++)c[f]=Math.exp(f**2/h);const d=t.length,u=new Uint8Array(d),p=new Uint32Array(256);for(let f=0;f<n;f++)for(let i=0;i<e;i++){const s=f*e+i,a=t[s];let h=0,d=0;for(let u=0;u<r;u++){const s=f+u-l;if(!(s<0||s>=n))for(let n=0;n<r;n++){const p=i+n-l;if(p<0||p>=e)continue;const f=t[s*e+p],m=o[u*r+n]*c[Math.abs(f-a)];h+=f*m,d+=m}}p[u[s]=Math.round(h/d)]++}return[u,p]}static#kl(t){const e=new Uint32Array(256);for(const n of t)e[n]++;return e}static#Dl(t){const e=t.length,n=new Uint8ClampedArray(e>>2);let i=-1/0,s=1/0;for(let o=0,a=n.length;o<a;o++){const e=n[o]=t[o<<2];i=Math.max(i,e),s=Math.min(s,e)}const r=255/(i-s);for(let o=0,a=n.length;o<a;o++)n[o]=(n[o]-s)*r;return n}static#Il(t){let e,n=-1/0,i=-1/0;const s=t.findIndex(t=>0!==t);let r=s,o=s;for(e=s;e<256;e++){const s=t[e];s>n&&(e-r>i&&(i=e-r,o=e-1),n=s,r=e)}for(e=o-1;e>=0&&!(t[e]>t[e+1]);e--);return e}static#Nl(t){const e=t,{width:n,height:i}=t,{maxDim:s}=this.#vl;let r=n,o=i;if(n>s||i>s){let a=n,l=i,c=Math.log2(Math.max(n,i)/s);const h=Math.floor(c);c=c===h?h-1:h;for(let n=0;n<c;n++){r=Math.ceil(a/2),o=Math.ceil(l/2);const n=new OffscreenCanvas(r,o);n.getContext("2d").drawImage(t,0,0,a,l,0,0,r,o),a=r,l=o,t!==e&&t.close(),t=n.transferToImageBitmap()}const d=Math.min(s/r,s/o);r=Math.round(r*d),o=Math.round(o*d)}const a=new OffscreenCanvas(r,o).getContext("2d",{willReadFrequently:!0});a.fillStyle="white",a.fillRect(0,0,r,o),a.filter="grayscale(1)",a.drawImage(t,0,0,t.width,t.height,0,0,r,o);const l=a.getImageData(0,0,r,o).data;return[this.#Dl(l),r,o]}static extractContoursFromText(t,{fontFamily:e,fontStyle:n,fontWeight:i},s,r,o,a){let l=new OffscreenCanvas(1,1),c=l.getContext("2d",{alpha:!1});const h=c.font=`${n} ${i} 200px ${e}`,{actualBoundingBoxLeft:d,actualBoundingBoxRight:u,actualBoundingBoxAscent:p,actualBoundingBoxDescent:f,fontBoundingBoxAscent:m,fontBoundingBoxDescent:g,width:y}=c.measureText(t),b=1.5,w=Math.ceil(Math.max(Math.abs(d)+Math.abs(u)||0,y)*b),v=Math.ceil(Math.max(Math.abs(p)+Math.abs(f)||200,Math.abs(m)+Math.abs(g)||200)*b);l=new OffscreenCanvas(w,v),c=l.getContext("2d",{alpha:!0,willReadFrequently:!0}),c.font=h,c.filter="grayscale(1)",c.fillStyle="white",c.fillRect(0,0,w,v),c.fillStyle="black",c.fillText(t,.5*w/2,1.5*v/2);const A=this.#Dl(c.getImageData(0,0,w,v).data),x=this.#kl(A),S=this.#Il(x),_=this.#Tl(A,w,v,S);return this.processDrawnLines({lines:{curves:_,width:w,height:v},pageWidth:s,pageHeight:r,rotation:o,innerMargin:a,mustSmooth:!0,areContours:!0})}static process(t,e,n,i,s){const[r,o,a]=this.#Nl(t),[l,c]=this.#Ml(r,o,a,Math.hypot(o,a)*this.#vl.sigmaSFactor,this.#vl.sigmaR,this.#vl.kernelSize),h=this.#Il(c),d=this.#Tl(l,o,a,h);return this.processDrawnLines({lines:{curves:d,width:o,height:a},pageWidth:e,pageHeight:n,rotation:i,innerMargin:s,mustSmooth:!0,areContours:!0})}static processDrawnLines({lines:t,pageWidth:e,pageHeight:n,rotation:i,innerMargin:s,mustSmooth:r,areContours:o}){i%180!=0&&([e,n]=[n,e]);const{curves:a,width:l,height:c}=t,h=t.thickness??0,d=[],u=Math.min(e/l,n/c),p=u/e,f=u/n,m=[];for(const{points:y}of a){const t=r?this.#Cl(y):y;if(!t)continue;m.push(t);const e=t.length,n=new Float32Array(e),i=new Float32Array(3*(2===e?2:e-2));if(d.push({line:i,points:n}),2===e){n[0]=t[0]*p,n[1]=t[1]*f,i.set([NaN,NaN,NaN,NaN,n[0],n[1]],0);continue}let[s,o,a,l]=t;s*=p,o*=f,a*=p,l*=f,n.set([s,o,a,l],0),i.set([NaN,NaN,NaN,NaN,s,o],0);for(let r=4;r<e;r+=2){const e=n[r]=t[r]*p,c=n[r+1]=t[r+1]*f;i.set(Cu.createBezierPoints(s,o,a,l,e,c),3*(r-2)),[s,o,a,l]=[a,l,e,c]}}if(0===d.length)return null;const g=o?new Hu:new Lu;return g.build(d,e,n,1,i,o?0:h,s),{outline:g,newCurves:m,areContours:o,thickness:h,width:l,height:c}}static async compressSignature({outlines:t,areContours:e,thickness:n,width:i,height:s}){let r,o=1/0,a=-1/0,l=0;for(const y of t){l+=y.length;for(let t=2,e=y.length;t<e;t++){const e=y[t]-y[t-2];o=Math.min(o,e),a=Math.max(a,e)}}r=o>=-128&&a<=127?Int8Array:o>=-32768&&a<=32767?Int16Array:Int32Array;const c=t.length,h=8+3*c,d=new Uint32Array(h);let u=0;d[u++]=h*Uint32Array.BYTES_PER_ELEMENT+(l-2*c)*r.BYTES_PER_ELEMENT,d[u++]=0,d[u++]=i,d[u++]=s,d[u++]=e?0:1,d[u++]=Math.max(0,Math.floor(n??0)),d[u++]=c,d[u++]=r.BYTES_PER_ELEMENT;for(const y of t)d[u++]=y.length-2,d[u++]=y[0],d[u++]=y[1];const p=new CompressionStream("deflate-raw"),f=p.writable.getWriter();await f.ready,f.write(d);const m=r.prototype.constructor;for(const y of t){const t=new m(y.length-2);for(let e=2,n=y.length;e<n;e++)t[e-2]=y[e]-y[e-2];f.write(t)}f.close();const g=await new Response(p.readable).arrayBuffer();return new Uint8Array(g).toBase64()}static async decompressSignature(t){try{const e=Uint8Array.fromBase64(t),{readable:n,writable:i}=new DecompressionStream("deflate-raw"),s=i.getWriter();await s.ready,s.write(e).then(async()=>{await s.ready,await s.close()}).catch(()=>{});let r=null,o=0;for await(const t of n)r||=new Uint8Array(new Uint32Array(t.buffer,0,4)[0]),r.set(t,o),o+=t.length;const a=new Uint32Array(r.buffer,0,r.length>>2),l=a[1];if(0!==l)throw new Error(`Invalid version: ${l}`);const c=a[2],h=a[3],d=0===a[4],u=a[5],p=a[6],f=a[7],m=[],g=(8+3*p)*Uint32Array.BYTES_PER_ELEMENT;let y;switch(f){case Int8Array.BYTES_PER_ELEMENT:y=new Int8Array(r.buffer,g);break;case Int16Array.BYTES_PER_ELEMENT:y=new Int16Array(r.buffer,g);break;case Int32Array.BYTES_PER_ELEMENT:y=new Int32Array(r.buffer,g)}o=0;for(let t=0;t<p;t++){const e=a[3*t+8],n=new Float32Array(e+2);m.push(n);for(let i=0;i<2;i++)n[i]=a[3*t+8+i+1];for(let t=0;t<e;t++)n[t+2]=n[t]+y[o++]}return{areContours:d,thickness:u,outlines:m,width:c,height:h}}catch(ze){return Qa(`decompressSignature: ${ze}`),null}}}class Uu extends Ru{constructor(){super(),super.updateProperties({fill:lc._defaultLineColor,"stroke-width":0})}clone(){const t=new Uu;return t.updateAll(this),t}}class Wu extends zu{constructor(t){super(t),super.updateProperties({stroke:lc._defaultLineColor,"stroke-width":1})}clone(){const t=new Wu(this._viewParameters);return t.updateAll(this),t}}class Gu extends Bu{#Pl=!1;#Ol=null;#Rl=null;#Bl=null;static _type="signature";static _editorType=Ta.SIGNATURE;static _defaultDrawingOptions=null;constructor(t){super({...t,mustBeCommitted:!0,name:"signatureEditor"}),this._willKeepAspectRatio=!0,this.#Rl=t.signatureData||null,this.#Ol=null,this.defaultL10nId="pdfjs-editor-signature-editor1"}static initialize(t,e){lc.initialize(t,e),this._defaultDrawingOptions=new Uu,this._defaultDrawnSignatureOptions=new Wu(e.viewParameters)}static getDefaultDrawingOptions(t){const e=this._defaultDrawingOptions.clone();return e.updateProperties(t),e}static get supportMultipleDrawings(){return!1}static get typesMap(){return il(this,"typesMap",new Map)}static get isDrawer(){return!1}get telemetryFinalData(){return{type:"signature",hasDescription:!!this.#Ol}}static computeTelemetryFinalData(t){const e=t.get("hasDescription");return{hasAltText:e.get(!0)??0,hasNoAltText:e.get(!1)??0}}get isResizable(){return!0}onScaleChanging(){null!==this._drawId&&super.onScaleChanging()}render(){if(this.div)return this.div;let t,e;const{_isCopy:n}=this;if(n&&(this._isCopy=!1,t=this.x,e=this.y),super.render(),null===this._drawId)if(this.#Rl){const{lines:t,mustSmooth:e,areContours:n,description:i,uuid:s,heightInPage:r}=this.#Rl,{rawDims:{pageWidth:o,pageHeight:a},rotation:l}=this.parent.viewport,c=$u.processDrawnLines({lines:t,pageWidth:o,pageHeight:a,rotation:l,innerMargin:Gu._INNER_MARGIN,mustSmooth:e,areContours:n});this.addSignature(c,r,i,s)}else this.div.setAttribute("data-l10n-args",JSON.stringify({description:""})),this.div.hidden=!0,this._uiManager.getSignature(this);else this.div.setAttribute("data-l10n-args",JSON.stringify({description:this.#Ol||""}));return n&&(this._isCopy=!0,this._moveAfterPaste(t,e)),this.div}setUuid(t){this.#Bl=t,this.addEditToolbar()}getUuid(){return this.#Bl}get description(){return this.#Ol}set description(t){this.#Ol=t,this.div&&(this.div.setAttribute("data-l10n-args",JSON.stringify({description:t})),super.addEditToolbar().then(e=>{e?.updateEditSignatureButton(t)}))}getSignaturePreview(){const{newCurves:t,areContours:e,thickness:n,width:i,height:s}=this.#Rl,r=Math.max(i,s);return{areContours:e,outline:$u.processDrawnLines({lines:{curves:t.map(t=>({points:t})),thickness:n,width:i,height:s},pageWidth:r,pageHeight:r,rotation:0,innerMargin:0,mustSmooth:!1,areContours:e}).outline}}get toolbarButtons(){return this._uiManager.signatureManager?[["editSignature",this._uiManager.signatureManager]]:super.toolbarButtons}addSignature(t,e,n,i){const{x:s,y:r}=this,{outline:o}=this.#Rl=t;let a;this.#Pl=o instanceof Hu,this.description=n,this.#Pl?a=Gu.getDefaultDrawingOptions():(a=Gu._defaultDrawnSignatureOptions.clone(),a.updateProperties({"stroke-width":o.thickness})),this._addOutlines({drawOutlines:o,drawingOptions:a});const[,l]=this.pageDimensions;let c=e/l;c=c>=1?.5:c,this.width*=c/this.height,this.width>=1&&(c*=.9/this.width,this.width=.9),this.height=c,this.setDims(),this.x=s,this.y=r,this.center(),this._onResized(),this.onScaleChanging(),this.rotate(),this._uiManager.addToAnnotationStorage(this),this.setUuid(i),this._reportTelemetry({action:"pdfjs.signature.inserted",data:{hasBeenSaved:!!i,hasDescription:!!n}}),this.div.hidden=!1}getFromImage(t){const{rawDims:{pageWidth:e,pageHeight:n},rotation:i}=this.parent.viewport;return $u.process(t,e,n,i,Gu._INNER_MARGIN)}getFromText(t,e){const{rawDims:{pageWidth:n,pageHeight:i},rotation:s}=this.parent.viewport;return $u.extractContoursFromText(t,e,n,i,s,Gu._INNER_MARGIN)}getDrawnSignature(t){const{rawDims:{pageWidth:e,pageHeight:n},rotation:i}=this.parent.viewport;return $u.processDrawnLines({lines:t,pageWidth:e,pageHeight:n,rotation:i,innerMargin:Gu._INNER_MARGIN,mustSmooth:!1,areContours:!1})}createDrawingOptions({areContours:t,thickness:e}){t?this._drawingOptions=Gu.getDefaultDrawingOptions():(this._drawingOptions=Gu._defaultDrawnSignatureOptions.clone(),this._drawingOptions.updateProperties({"stroke-width":e}))}serialize(t=!1){if(this.isEmpty())return null;const{lines:e,points:n}=this.serializeDraw(t),{_drawingOptions:{"stroke-width":i}}=this,s=Object.assign(super.serialize(t),{isSignature:!0,areContours:this.#Pl,color:[0,0,0],thickness:this.#Pl?0:i});return this.addComment(s),t?(s.paths={lines:e,points:n},s.uuid=this.#Bl,s.isCopy=!0):s.lines=e,this.#Ol&&(s.accessibilityData={type:"Figure",alt:this.#Ol}),s}static deserializeDraw(t,e,n,i,s,r){return r.areContours?Hu.deserialize(t,e,n,i,s,r):Lu.deserialize(t,e,n,i,s,r)}static async deserialize(t,e,n){const i=await super.deserialize(t,e,n);return i.#Pl=t.areContours,i.description=t.accessibilityData?.alt||"",i.#Bl=t.uuid,i}}class ju extends lc{#Fl=null;#Ll=null;#zl=null;#Vl=null;#Hl=null;#$l="";#Ul=null;#Wl=!1;#Gl=null;#jl=!1;#Kl=!1;static _type="stamp";static _editorType=Ta.STAMP;constructor(t){super({...t,name:"stampEditor"}),this.#Vl=t.bitmapUrl,this.#Hl=t.bitmapFile,this.defaultL10nId="pdfjs-editor-stamp-editor"}static initialize(t,e){lc.initialize(t,e)}static isHandlingMimeForPasting(t){return zl.includes(t)}static paste(t,e){e.pasteEditor({mode:Ta.STAMP},{bitmapFile:t.getAsFile()})}altTextFinish(){this._uiManager.useNewAltTextFlow&&(this.div.hidden=!1),super.altTextFinish()}get telemetryFinalData(){return{type:"stamp",hasAltText:!!this.altTextData?.altText}}static computeTelemetryFinalData(t){const e=t.get("hasAltText");return{hasAltText:e.get(!0)??0,hasNoAltText:e.get(!1)??0}}#ql(t,e=!1){t?(this.#Fl=t.bitmap,e||(this.#Ll=t.id,this.#jl=t.isSvg),t.file&&(this.#$l=t.file.name),this.#Yl()):this.remove()}#Xl(){if(this.#zl=null,this._uiManager.enableWaiting(!1),this.#Ul)if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#Fl)this.addEditToolbar().then(()=>{this._editToolbar.hide(),this._uiManager.editAltText(this,!0)});else{if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#Fl){this._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!1,alt_text_type:"empty"}});try{this.mlGuessAltText()}catch{}}this.div.focus()}}async mlGuessAltText(t=null,e=!0){if(this.hasAltTextData())return null;const{mlManager:n}=this._uiManager;if(!n)throw new Error("No ML.");if(!(await n.isEnabledFor("altText")))throw new Error("ML isn't enabled for alt text.");const{data:i,width:s,height:r}=t||this.copyCanvas(null,null,!0).imageData,o=await n.guess({name:"altText",request:{data:i,width:s,height:r,channels:i.length/(s*r)}});if(!o)throw new Error("No response from the AI service.");if(o.error)throw new Error("Error from the AI service.");if(o.cancel)return null;if(!o.output)throw new Error("No valid response from the AI service.");const a=o.output;return await this.setGuessedAltText(a),e&&!this.hasAltTextData()&&(this.altTextData={alt:a,decorative:!1}),a}#Jl(){if(this.#Ll)return this._uiManager.enableWaiting(!0),void this._uiManager.imageManager.getFromId(this.#Ll).then(t=>this.#ql(t,!0)).finally(()=>this.#Xl());if(this.#Vl){const t=this.#Vl;return this.#Vl=null,this._uiManager.enableWaiting(!0),void(this.#zl=this._uiManager.imageManager.getFromUrl(t).then(t=>this.#ql(t)).finally(()=>this.#Xl()))}if(this.#Hl){const t=this.#Hl;return this.#Hl=null,this._uiManager.enableWaiting(!0),void(this.#zl=this._uiManager.imageManager.getFromFile(t).then(t=>this.#ql(t)).finally(()=>this.#Xl()))}const t=document.createElement("input");t.type="file",t.accept=zl.join(",");const e=this._uiManager._signal;this.#zl=new Promise(n=>{t.addEventListener("change",async()=>{if(t.files&&0!==t.files.length){this._uiManager.enableWaiting(!0);const e=await this._uiManager.imageManager.getFromFile(t.files[0]);this._reportTelemetry({action:"pdfjs.image.image_selected",data:{alt_text_modal:this._uiManager.useNewAltTextFlow}}),this.#ql(e)}else this.remove();n()},{signal:e}),t.addEventListener("cancel",()=>{this.remove(),n()},{signal:e})}).finally(()=>this.#Xl()),t.click()}remove(){this.#Ll&&(this.#Fl=null,this._uiManager.imageManager.deleteId(this.#Ll),this.#Ul?.remove(),this.#Ul=null,this.#Gl&&(clearTimeout(this.#Gl),this.#Gl=null)),super.remove()}rebuild(){this.parent?(super.rebuild(),null!==this.div&&(this.#Ll&&null===this.#Ul&&this.#Jl(),this.isAttachedToDOM||this.parent.add(this))):this.#Ll&&this.#Jl()}onceAdded(t){this._isDraggable=!0,t&&this.div.focus()}isEmpty(){return!(this.#zl||this.#Fl||this.#Vl||this.#Hl||this.#Ll||this.#Wl)}get toolbarButtons(){return[["altText",this.createAltText()]]}get isResizable(){return!0}render(){if(this.div)return this.div;let t,e;return this._isCopy&&(t=this.x,e=this.y),super.render(),this.div.hidden=!0,this.createAltText(),this.#Wl||(this.#Fl?this.#Yl():this.#Jl()),this._isCopy&&this._moveAfterPaste(t,e),this._uiManager.addShouldRescale(this),this.div}setCanvas(t,e){const{id:n,bitmap:i}=this._uiManager.imageManager.getFromCanvas(t,e);e.remove(),n&&this._uiManager.imageManager.isValidId(n)&&(this.#Ll=n,i&&(this.#Fl=i),this.#Wl=!1,this.#Yl())}_onResized(){this.onScaleChanging()}onScaleChanging(){if(!this.parent)return;null!==this.#Gl&&clearTimeout(this.#Gl);this.#Gl=setTimeout(()=>{this.#Gl=null,this.#Ql()},200)}#Yl(){const{div:t}=this;let{width:e,height:n}=this.#Fl;const[i,s]=this.pageDimensions,r=.75;if(this.width)e=this.width*i,n=this.height*s;else if(e>r*i||n>r*s){const t=Math.min(r*i/e,r*s/n);e*=t,n*=t}this._uiManager.enableWaiting(!1);const o=this.#Ul=document.createElement("canvas");o.setAttribute("role","img"),this.addContainer(o),this.width=e/i,this.height=n/s,this.setDims(),this._initialOptions?.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&!this.annotationElementId||(t.hidden=!1),this.#Ql(),this.#Kl||(this.parent.addUndoableEditor(this),this.#Kl=!0),this._reportTelemetry({action:"inserted_image"}),this.#$l&&this.div.setAttribute("aria-description",this.#$l),this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-stamp-added-alert")}copyCanvas(t,e,n=!1){t||(t=224);const{width:i,height:s}=this.#Fl,r=new Ll;let o=this.#Fl,a=i,l=s,c=null;if(e){if(i>e||s>e){const t=Math.min(e/i,e/s);a=Math.floor(i*t),l=Math.floor(s*t)}c=document.createElement("canvas");const t=c.width=Math.ceil(a*r.sx),n=c.height=Math.ceil(l*r.sy);this.#jl||(o=this.#Zl(t,n));const h=c.getContext("2d");h.filter=this._uiManager.hcmFilter;let d="white",u="#cfcfd8";"none"!==this._uiManager.hcmFilter?u="black":Vl.isDarkMode&&(d="#8f8f9d",u="#42414d");const p=15,f=p*r.sx,m=p*r.sy,g=new OffscreenCanvas(2*f,2*m),y=g.getContext("2d");y.fillStyle=d,y.fillRect(0,0,2*f,2*m),y.fillStyle=u,y.fillRect(0,0,f,m),y.fillRect(f,m,f,m),h.fillStyle=h.createPattern(g,"repeat"),h.fillRect(0,0,t,n),h.drawImage(o,0,0,o.width,o.height,0,0,t,n)}let h=null;if(n){let e,n;if(r.symmetric&&o.width<t&&o.height<t)e=o.width,n=o.height;else if(o=this.#Fl,i>t||s>t){const r=Math.min(t/i,t/s);e=Math.floor(i*r),n=Math.floor(s*r),this.#jl||(o=this.#Zl(e,n))}const a=new OffscreenCanvas(e,n).getContext("2d",{willReadFrequently:!0});a.drawImage(o,0,0,o.width,o.height,0,0,e,n),h={width:e,height:n,data:a.getImageData(0,0,e,n).data}}return{canvas:c,width:a,height:l,imageData:h}}#Zl(t,e){const{width:n,height:i}=this.#Fl;let s=n,r=i,o=this.#Fl;for(;s>2*t||r>2*e;){const n=s,i=r;s>2*t&&(s=s>=16384?Math.floor(s/2)-1:Math.ceil(s/2)),r>2*e&&(r=r>=16384?Math.floor(r/2)-1:Math.ceil(r/2));const a=new OffscreenCanvas(s,r);a.getContext("2d").drawImage(o,0,0,n,i,0,0,s,r),o=a.transferToImageBitmap()}return o}#Ql(){const[t,e]=this.parentDimensions,{width:n,height:i}=this,s=new Ll,r=Math.ceil(n*t*s.sx),o=Math.ceil(i*e*s.sy),a=this.#Ul;if(!a||a.width===r&&a.height===o)return;a.width=r,a.height=o;const l=this.#jl?this.#Fl:this.#Zl(r,o),c=a.getContext("2d");c.filter=this._uiManager.hcmFilter,c.drawImage(l,0,0,l.width,l.height,0,0,r,o)}#tc(t){if(t){if(this.#jl){const t=this._uiManager.imageManager.getSvgUrl(this.#Ll);if(t)return t}const t=document.createElement("canvas");({width:t.width,height:t.height}=this.#Fl);return t.getContext("2d").drawImage(this.#Fl,0,0),t.toDataURL()}if(this.#jl){const[t,e]=this.pageDimensions,n=Math.round(this.width*t*Sl.PDF_TO_CSS_UNITS),i=Math.round(this.height*e*Sl.PDF_TO_CSS_UNITS),s=new OffscreenCanvas(n,i);return s.getContext("2d").drawImage(this.#Fl,0,0,this.#Fl.width,this.#Fl.height,0,0,n,i),s.transferToImageBitmap()}return structuredClone(this.#Fl)}static async deserialize(t,e,n){let i=null,s=!1;if(t instanceof xu){const{data:{rect:r,rotation:o,id:a,structParent:l,popupRef:c,richText:h,contentsObj:d,creationDate:u,modificationDate:p},container:f,parent:{page:{pageNumber:m}},canvas:g}=t;let y,b;g?(delete t.canvas,({id:y,bitmap:b}=n.imageManager.getFromCanvas(f.id,g)),g.remove()):(s=!0,t._hasNoCanvas=!0);const w=(await e._structTree.getAriaAttributes(`${bl}${a}`))?.get("aria-label")||"";i=t={annotationType:Ta.STAMP,bitmapId:y,bitmap:b,pageIndex:m-1,rect:r.slice(0),rotation:o,annotationElementId:a,id:a,deleted:!1,accessibilityData:{decorative:!1,altText:w},isSvg:!1,structParent:l,popupRef:c,richText:h,comment:d?.str||null,creationDate:u,modificationDate:p}}const r=await super.deserialize(t,e,n),{rect:o,bitmap:a,bitmapUrl:l,bitmapId:c,isSvg:h,accessibilityData:d}=t;s?(n.addMissingCanvas(t.id,r),r.#Wl=!0):c&&n.imageManager.isValidId(c)?(r.#Ll=c,a&&(r.#Fl=a)):r.#Vl=l,r.#jl=h;const[u,p]=r.pageDimensions;return r.width=(o[2]-o[0])/u,r.height=(o[3]-o[1])/p,d&&(r.altTextData=d),r._initialData=i,t.comment&&r.setCommentData(t),r.#Kl=!!i,r}serialize(t=!1,e=null){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const n=Object.assign(super.serialize(t),{bitmapId:this.#Ll,isSvg:this.#jl});if(this.addComment(n),t)return n.bitmapUrl=this.#tc(!0),n.accessibilityData=this.serializeAltText(!0),n.isCopy=!0,n;const{decorative:i,altText:s}=this.serializeAltText(!1);if(!i&&s&&(n.accessibilityData={type:"Figure",alt:s}),this.annotationElementId){const t=this.#$o(n);return t.isSame?null:(t.isSameAltText?delete n.accessibilityData:n.accessibilityData.structParent=this._initialData.structParent??-1,n.id=this.annotationElementId,delete n.bitmapId,n)}if(null===e)return n;e.stamps||=new Map;const r=this.#jl?(n.rect[2]-n.rect[0])*(n.rect[3]-n.rect[1]):null;if(e.stamps.has(this.#Ll)){if(this.#jl){const t=e.stamps.get(this.#Ll);r>t.area&&(t.area=r,t.serialized.bitmap.close(),t.serialized.bitmap=this.#tc(!1))}}else e.stamps.set(this.#Ll,{area:r,serialized:n}),n.bitmap=this.#tc(!1);return n}#$o(t){const{pageIndex:e,accessibilityData:{altText:n}}=this._initialData,i=t.pageIndex===e,s=(t.accessibilityData?.alt||"")===n;return{isSame:!this.hasEditedComment&&!this._hasBeenMoved&&!this._hasBeenResized&&i&&s,isSameAltText:s}}renderAnnotationElement(t){return this.deleted?(t.hide(),null):(t.updateEdited({rect:this.getPDFRect(),popup:this.comment}),null)}}class Ku{#_o;#ec=!1;#nc=null;#ic=null;#sc=null;#rc=new Map;#oc=!1;#ac=!1;#lc=!1;#cc=null;#hc=null;#dc=null;#uc=null;#pc=null;#fc=-1;#_;static _initialized=!1;static#nt=new Map([Eu,Vu,ju,Ou,Gu].map(t=>[t._editorType,t]));constructor({uiManager:t,pageIndex:e,div:n,structTreeLayer:i,accessibilityManager:s,annotationLayer:r,drawLayer:o,textLayer:a,viewport:l,l10n:c}){const h=[...Ku.#nt.values()];if(!Ku._initialized){Ku._initialized=!0;for(const e of h)e.initialize(c,t)}t.registerEditorTypes(h),this.#_=t,this.pageIndex=e,this.div=n,this.#_o=s,this.#nc=r,this.viewport=l,this.#dc=a,this.drawLayer=o,this._structTree=i,this.#_.addLayer(this)}updatePageIndex(t){this.pageIndex=t}get isEmpty(){return 0===this.#rc.size}get isInvisible(){return this.isEmpty&&this.#_.getMode()===Ta.NONE}updateToolbar(t){this.#_.updateToolbar(t)}updateMode(t=this.#_.getMode()){switch(this.#mc(),t){case Ta.NONE:return this.div.classList.toggle("nonEditing",!0),this.disableTextSelection(),this.togglePointerEvents(!1),this.toggleAnnotationLayerPointerEvents(!0),void this.disableClick();case Ta.INK:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick();break;case Ta.HIGHLIGHT:this.enableTextSelection(),this.togglePointerEvents(!1),this.disableClick();break;default:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick()}this.toggleAnnotationLayerPointerEvents(!1);const{classList:e}=this.div;if(e.toggle("nonEditing",!1),t===Ta.POPUP)e.toggle("commentEditing",!0);else{e.toggle("commentEditing",!1);for(const n of Ku.#nt.values())e.toggle(`${n._type}Editing`,t===n._editorType)}this.div.hidden=!1}hasTextLayer(t){return t===this.#dc?.div}setEditingState(t){this.#_.setEditingState(t)}addCommands(t){this.#_.addCommands(t)}cleanUndoStack(t){this.#_.cleanUndoStack(t)}toggleDrawing(t=!1){this.div.classList.toggle("drawing",!t)}togglePointerEvents(t=!1){this.div.classList.toggle("disabled",!t)}toggleAnnotationLayerPointerEvents(t=!1){this.#nc?.togglePointerEvents(t)}get#gc(){return 0!==this.#rc.size?this.#rc.values():this.#_.getEditors(this.pageIndex)}async enable(){this.#lc=!0,this.div.tabIndex=0,this.togglePointerEvents(!0),this.div.classList.toggle("nonEditing",!1),this.#pc?.abort(),this.#pc=null;const t=new Set;for(const n of this.#gc)n.enableEditing(),n.show(!0),n.annotationElementId&&(this.#_.removeChangedExistingAnnotation(n),t.add(n.annotationElementId));const e=this.#nc;if(e)for(const n of e.getEditableAnnotations()){if(n.hide(),this.#_.isDeletedAnnotationElement(n.data.id))continue;if(t.has(n.data.id))continue;const e=await this.deserialize(n);e&&(this.addOrRebuild(e),e.enableEditing())}this.#lc=!1,this.#_._eventBus.dispatch("editorsrendered",{source:this,pageNumber:this.pageIndex+1})}disable(){if(this.#ac=!0,this.div.tabIndex=-1,this.togglePointerEvents(!1),this.div.classList.toggle("nonEditing",!0),this.#dc&&!this.#pc){this.#pc=new AbortController;const t=this.#_.combinedSignal(this.#pc);this.#dc.div.addEventListener("pointerdown",t=>{const{clientX:e,clientY:n,timeStamp:i}=t;if(i-this.#fc>500)return void(this.#fc=i);this.#fc=-1;const{classList:s}=this.div;s.toggle("getElements",!0);const r=document.elementsFromPoint(e,n);if(s.toggle("getElements",!1),!this.div.contains(r[0]))return;let o;const a=new RegExp(`^${_a}[0-9]+$`);for(const c of r)if(a.test(c.id)){o=c.id;break}if(!o)return;const l=this.#rc.get(o);null===l?.annotationElementId&&(t.stopPropagation(),t.preventDefault(),l.dblclick(t))},{signal:t,capture:!0})}const t=this.#nc,e=[];if(t){const n=new Map,i=new Map;for(const t of this.#gc)t.disableEditing(),t.annotationElementId?null===t.serialize()?(i.set(t.annotationElementId,t),this.getEditableAnnotation(t.annotationElementId)?.show(),t.remove()):n.set(t.annotationElementId,t):e.push(t);const s=t.getEditableAnnotations();for(const t of s){const{id:e}=t.data;if(this.#_.isDeletedAnnotationElement(e)){t.updateEdited({deleted:!0});continue}let s=i.get(e);s?(s.resetAnnotationElement(t),s.show(!1),t.show()):(s=n.get(e),s&&(this.#_.addChangedExistingAnnotation(s),s.renderAnnotationElement(t)&&s.show(!1)),t.show())}}this.#mc(),this.isEmpty&&(this.div.hidden=!0);const{classList:n}=this.div;for(const i of Ku.#nt.values())n.remove(`${i._type}Editing`);this.disableTextSelection(),this.toggleAnnotationLayerPointerEvents(!0),t?.updateFakeAnnotations(e),this.#ac=!1}getEditableAnnotation(t){return this.#nc?.getEditableAnnotation(t)||null}setActiveEditor(t){this.#_.getActive()!==t&&this.#_.setActiveEditor(t)}enableTextSelection(){if(this.div.tabIndex=-1,this.#dc?.div&&!this.#uc){this.#uc=new AbortController;const t=this.#_.combinedSignal(this.#uc);this.#dc.div.addEventListener("pointerdown",this.#yc.bind(this),{signal:t}),this.#dc.div.classList.add("highlighting")}}disableTextSelection(){this.div.tabIndex=0,this.#dc?.div&&this.#uc&&(this.#uc.abort(),this.#uc=null,this.#dc.div.classList.remove("highlighting"))}#yc(t){this.#_.unselectAll();const{target:e}=t;if(e===this.#dc.div||("img"===e.getAttribute("role")||e.classList.contains("endOfContent"))&&this.#dc.div.contains(e)){const{isMac:e}=ul.platform;if(0!==t.button||t.ctrlKey&&e)return;this.#_.showAllEditors("highlight",!0,!0),this.#dc.div.classList.add("free"),this.toggleDrawing(),Ou.startHighlighting(this,"ltr"===this.#_.direction,{target:this.#dc.div,x:t.x,y:t.y}),this.#dc.div.addEventListener("pointerup",()=>{this.#dc.div.classList.remove("free"),this.toggleDrawing(!0)},{once:!0,signal:this.#_._signal}),t.preventDefault()}}enableClick(){if(this.#ic)return;this.#ic=new AbortController;const t=this.#_.combinedSignal(this.#ic);this.div.addEventListener("pointerdown",this.pointerdown.bind(this),{signal:t});const e=this.pointerup.bind(this);this.div.addEventListener("pointerup",e,{signal:t}),this.div.addEventListener("pointercancel",e,{signal:t})}disableClick(){this.#ic?.abort(),this.#ic=null}attach(t){this.#rc.set(t.id,t);const{annotationElementId:e}=t;e&&this.#_.isDeletedAnnotationElement(e)&&this.#_.removeDeletedAnnotationElement(t)}detach(t){this.#rc.delete(t.id),this.#_o?.removePointerInTextLayer(t.contentDiv),!this.#ac&&t.annotationElementId&&this.#_.addDeletedAnnotationElement(t)}remove(t){this.detach(t),this.#_.removeEditor(t),t.div.remove(),t.isAttachedToDOM=!1}changeParent(t){t.parent!==this&&(t.parent&&t.annotationElementId&&(this.#_.addDeletedAnnotationElement(t),lc.deleteAnnotationElement(t),t.annotationElementId=null),this.attach(t),t.parent?.detach(t),t.setParent(this),t.div&&t.isAttachedToDOM&&(t.div.remove(),this.div.append(t.div)))}add(t){if(t.parent!==this||!t.isAttachedToDOM){if(this.changeParent(t),this.#_.addEditor(t),this.attach(t),!t.isAttachedToDOM){const e=t.render();this.div.append(e),t.isAttachedToDOM=!0}t.fixAndSetPosition(),t.onceAdded(!this.#lc),this.#_.addToAnnotationStorage(t),t._reportTelemetry(t.telemetryInitialData)}}moveEditorInDOM(t){if(!t.isAttachedToDOM)return;const{activeElement:e}=document;t.div.contains(e)&&!this.#sc&&(t._focusEventsAllowed=!1,this.#sc=setTimeout(()=>{this.#sc=null,t.div.contains(document.activeElement)?t._focusEventsAllowed=!0:(t.div.addEventListener("focusin",()=>{t._focusEventsAllowed=!0},{once:!0,signal:this.#_._signal}),e.focus())},0)),t._structTreeParentId=this.#_o?.moveElementInDOM(this.div,t.div,t.contentDiv,!0)}addOrRebuild(t){t.needsToBeRebuilt()?(t.parent||=this,t.rebuild(),t.show()):this.add(t)}addUndoableEditor(t){this.addCommands({cmd:()=>t._uiManager.rebuild(t),undo:()=>{t.remove()},mustExec:!1})}getEditorByUID(t){for(const e of this.#rc.values())if(e.uid===t)return e;return null}getNextId(){return this.#_.getId()}get#bc(){return Ku.#nt.get(this.#_.getMode())}combinedSignal(t){return this.#_.combinedSignal(t)}#wc(t){const e=this.#bc;return e?new e.prototype.constructor(t):null}canCreateNewEmptyEditor(){return this.#bc?.canCreateNewEmptyEditor()}async pasteEditor(t,e){this.updateToolbar(t),await this.#_.updateMode(t.mode);const{offsetX:n,offsetY:i}=this.#vc(),s=this.getNextId(),r=this.#wc({parent:this,id:s,x:n,y:i,uiManager:this.#_,isCentered:!0,...e});r&&this.add(r)}async deserialize(t){return await(Ku.#nt.get(t.annotationType??t.annotationEditorType)?.deserialize(t,this,this.#_))||null}createAndAddNewEditor(t,e,n={}){const i=this.getNextId(),s=this.#wc({parent:this,id:i,x:t.offsetX,y:t.offsetY,uiManager:this.#_,isCentered:e,...n});return s&&this.add(s),s}get boundingClientRect(){return this.div.getBoundingClientRect()}#vc(){const{x:t,y:e,width:n,height:i}=this.boundingClientRect,s=Math.max(0,t),r=Math.max(0,e),o=(s+Math.min(window.innerWidth,t+n))/2-t,a=(r+Math.min(window.innerHeight,e+i))/2-e,[l,c]=this.viewport.rotation%180==0?[o,a]:[a,o];return{offsetX:l,offsetY:c}}addNewEditor(t={}){this.createAndAddNewEditor(this.#vc(),!0,t)}setSelected(t){this.#_.setSelected(t)}toggleSelected(t){this.#_.toggleSelected(t)}unselect(t){this.#_.unselect(t)}pointerup(t){const{isMac:e}=ul.platform;if(0!==t.button||t.ctrlKey&&e)return;if(t.target!==this.div)return;if(!this.#oc)return;if(this.#oc=!1,this.#bc?.isDrawer&&this.#bc.supportMultipleDrawings)return;if(!this.#ec)return void(this.#ec=!0);const n=this.#_.getMode();n!==Ta.STAMP&&n!==Ta.SIGNATURE?this.createAndAddNewEditor(t,!1):this.#_.unselectAll()}pointerdown(t){if(this.#_.getMode()===Ta.HIGHLIGHT&&this.enableTextSelection(),this.#oc)return void(this.#oc=!1);const{isMac:e}=ul.platform;if(0!==t.button||t.ctrlKey&&e)return;if(t.target!==this.div)return;if(this.#oc=!0,this.#bc?.isDrawer)return void this.startDrawingSession(t);const n=this.#_.getActive();this.#ec=!n||n.isEmpty()}startDrawingSession(t){if(this.div.focus({preventScroll:!0}),this.#cc)return void this.#bc.startDrawing(this,this.#_,!1,t);this.#_.setCurrentDrawingSession(this),this.#cc=new AbortController;const e=this.#_.combinedSignal(this.#cc);this.div.addEventListener("blur",({relatedTarget:t})=>{t&&!this.div.contains(t)&&(this.#hc=null,this.commitOrRemove())},{signal:e}),this.#bc.startDrawing(this,this.#_,!1,t)}pause(t){if(t){const{activeElement:t}=document;return void(this.div.contains(t)&&(this.#hc=t))}this.#hc&&setTimeout(()=>{this.#hc?.focus(),this.#hc=null},0)}endDrawingSession(t=!1){return this.#cc?(this.#_.setCurrentDrawingSession(null),this.#cc.abort(),this.#cc=null,this.#hc=null,this.#bc.endDrawing(t)):null}findNewParent(t,e,n){const i=this.#_.findParent(e,n);return null!==i&&i!==this&&(i.changeParent(t),!0)}commitOrRemove(){return!!this.#cc&&(this.endDrawingSession(),!0)}onScaleChanging(){this.#cc&&this.#bc.onScaleChangingWhenDrawing(this)}destroy(){this.commitOrRemove(),this.#_.getActive()?.parent===this&&(this.#_.commitOrRemove(),this.#_.setActiveEditor(null)),this.#sc&&(clearTimeout(this.#sc),this.#sc=null);for(const t of this.#rc.values())this.#_o?.removePointerInTextLayer(t.contentDiv),t.setParent(null),t.isAttachedToDOM=!1,t.div.remove();this.div=null,this.#rc.clear(),this.#_.removeLayer(this)}#mc(){for(const t of this.#rc.values())t.isEmpty()&&t.remove()}render({viewport:t}){this.viewport=t,Fl(this.div,t);for(const e of this.#_.getEditors(this.pageIndex))this.add(e),e.rebuild();this.updateMode()}update({viewport:t}){this.#_.commitOrRemove(),this.#mc();const e=this.viewport.rotation,n=t.rotation;if(this.viewport=t,Fl(this.div,{rotation:n}),e!==n)for(const i of this.#rc.values())i.rotate(n)}get pageDimensions(){const{pageWidth:t,pageHeight:e}=this.viewport.rawDims;return[t,e]}get scale(){return this.#_.viewParameters.realScale}}class qu{#qr=null;#Ac=new Map;#xc=new Map;static#N=0;setParent(t){if(this.#qr){if(this.#qr!==t){if(this.#Ac.size>0)for(const e of this.#Ac.values())e.remove(),t.append(e);this.#qr=t}}else this.#qr=t}static get _svgFactory(){return il(this,"_svgFactory",new Kd)}static#Sc(t,[e,n,i,s]){const{style:r}=t;r.top=100*n+"%",r.left=100*e+"%",r.width=100*i+"%",r.height=100*s+"%"}#_c(){const t=qu._svgFactory.create(1,1,!0);return this.#qr.append(t),t.setAttribute("aria-hidden",!0),t}#Tc(t,e){const n=qu._svgFactory.createElement("clipPath");t.append(n);const i=`clip_${e}`;n.setAttribute("id",i),n.setAttribute("clipPathUnits","objectBoundingBox");const s=qu._svgFactory.createElement("use");return n.append(s),s.setAttribute("href",`#${e}`),s.classList.add("clip"),i}#Ec(t,e){for(const[n,i]of Object.entries(e))null===i?t.removeAttribute(n):t.setAttribute(n,i)}draw(t,e=!1,n=!1){const i=qu.#N++,s=this.#_c(),r=qu._svgFactory.createElement("defs");s.append(r);const o=qu._svgFactory.createElement("path");r.append(o);const a=`path_${i}`;o.setAttribute("id",a),o.setAttribute("vector-effect","non-scaling-stroke"),e&&this.#xc.set(i,o);const l=n?this.#Tc(r,a):null,c=qu._svgFactory.createElement("use");return s.append(c),c.setAttribute("href",`#${a}`),this.updateProperties(s,t),this.#Ac.set(i,s),{id:i,clipPathId:`url(#${l})`}}drawOutline(t,e){const n=qu.#N++,i=this.#_c(),s=qu._svgFactory.createElement("defs");i.append(s);const r=qu._svgFactory.createElement("path");s.append(r);const o=`path_${n}`;let a;if(r.setAttribute("id",o),r.setAttribute("vector-effect","non-scaling-stroke"),e){const t=qu._svgFactory.createElement("mask");s.append(t),a=`mask_${n}`,t.setAttribute("id",a),t.setAttribute("maskUnits","objectBoundingBox");const e=qu._svgFactory.createElement("rect");t.append(e),e.setAttribute("width","1"),e.setAttribute("height","1"),e.setAttribute("fill","white");const i=qu._svgFactory.createElement("use");t.append(i),i.setAttribute("href",`#${o}`),i.setAttribute("stroke","none"),i.setAttribute("fill","black"),i.setAttribute("fill-rule","nonzero"),i.classList.add("mask")}const l=qu._svgFactory.createElement("use");i.append(l),l.setAttribute("href",`#${o}`),a&&l.setAttribute("mask",`url(#${a})`);const c=l.cloneNode();return i.append(c),l.classList.add("mainOutline"),c.classList.add("secondaryOutline"),this.updateProperties(i,t),this.#Ac.set(n,i),n}finalizeDraw(t,e){this.#xc.delete(t),this.updateProperties(t,e)}updateProperties(t,e){if(!e)return;const{root:n,bbox:i,rootClass:s,path:r}=e,o="number"==typeof t?this.#Ac.get(t):t;if(o){if(n&&this.#Ec(o,n),i&&qu.#Sc(o,i),s){const{classList:t}=o;for(const[e,n]of Object.entries(s))t.toggle(e,n)}if(r){const t=o.firstElementChild.firstElementChild;this.#Ec(t,r)}}}updateParent(t,e){if(e===this)return;const n=this.#Ac.get(t);n&&(e.#qr.append(n),this.#Ac.delete(t),e.#Ac.set(t,n))}remove(t){this.#xc.delete(t),null!==this.#qr&&(this.#Ac.get(t).remove(),this.#Ac.delete(t))}destroy(){this.#qr=null;for(const t of this.#Ac.values())t.remove();this.#Ac.clear(),this.#xc.clear()}}globalThis._pdfjsTestingUtils={HighlightOutliner:Du},globalThis.pdfjsLib={AbortException:hl,AnnotationEditorLayer:Ku,AnnotationEditorParamsType:Ea,AnnotationEditorType:Ta,AnnotationEditorUIManager:sc,AnnotationLayer:_u,AnnotationMode:Sa,AnnotationType:Ba,applyOpacity:function(t,e,n,i){const s=255*(1-(i=Math.min(Math.max(i??1,0),1)));return[t=Math.round(t*i+s),e=Math.round(e*i+s),n=Math.round(n*i+s)]},build:"384c6208b",ColorPicker:Hd,createValidAbsoluteUrl:el,CSSConstants:class{static get commentForegroundColor(){const t=document.createElement("span");t.classList.add("comment","sidebar");const{style:e}=t;e.width=e.height="0",e.display="none",e.color="var(--comment-fg-color)",document.body.append(t);const{color:n}=window.getComputedStyle(t);return t.remove(),il(this,"commentForegroundColor",Ol(n))}},DOMSVGFactory:Kd,DrawLayer:qu,FeatureTest:ul,fetchData:_l,findContrastColor:function(t,e){const n=t[0]+256*t[1]+65536*t[2]+16777216*e[0]+4294967296*e[1]+1099511627776*e[2];let i=Gl.get(n);if(i)return i;const s=new Float32Array(9),r=s.subarray(0,3),o=s.subarray(3,6);Hl(t,o);const a=s.subarray(6,9);Hl(e,a);const l=a[2]<.5,c=l?12:4.5;if(o[2]=l?Math.sqrt(o[2]):1-Math.sqrt(1-o[2]),Wl(o,a,r)<c){let t,e;l?(t=o[2],e=1):(t=0,e=o[2]);const n=.005;for(;e-t>n;){const n=o[2]=(t+e)/2;l===Wl(o,a,r)<c?t=n:e=n}o[2]=l?e:t}return $l(o,r),i=fl.makeHexColor(Math.round(255*r[0]),Math.round(255*r[1]),Math.round(255*r[2])),Gl.set(n,i),i},getDocument:function(t={}){"string"==typeof t||t instanceof URL?t={url:t}:(t instanceof ArrayBuffer||ArrayBuffer.isView(t))&&(t={data:t});const e=new Nd,{docId:n}=e,i=t.url?function(t){if(t instanceof URL)return t.href;if("string"==typeof t){if(ua)return t;const e=URL.parse(t,window.location);if(e)return e.href}throw new Error("Invalid PDF url data: either string or URL-object is expected in the url property.")}(t.url):null,s=t.data?function(t){if(ua&&"undefined"!=typeof Buffer&&t instanceof Buffer)throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength)return t;if("string"==typeof t)return dl(t);if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)||"object"==typeof t&&!isNaN(t?.length))return new Uint8Array(t);throw new Error("Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.")}(t.data):null,r=t.httpHeaders||null,o=!0===t.withCredentials,a=t.password??null,l=t.range instanceof Pd?t.range:null,c=Number.isInteger(t.rangeChunkSize)&&t.rangeChunkSize>0?t.rangeChunkSize:65536;let h=t.worker instanceof Fd?t.worker:null;const d=t.verbosity,u="string"!=typeof t.docBaseUrl||Cl(t.docBaseUrl)?null:t.docBaseUrl,p=_c(t.cMapUrl),f=!1!==t.cMapPacked,m=t.CMapReaderFactory||(ua?th:Wc),g=_c(t.iccUrl),y=_c(t.standardFontDataUrl),b=t.StandardFontDataFactory||(ua?eh:qc),w=_c(t.wasmUrl),v=t.WasmFactory||(ua?nh:Xc),A=!0!==t.stopAtErrors,x=Number.isInteger(t.maxImageSize)&&t.maxImageSize>-1?t.maxImageSize:-1,S=!1!==t.isEvalSupported,_="boolean"==typeof t.isOffscreenCanvasSupported?t.isOffscreenCanvasSupported:!ua,T="boolean"==typeof t.isImageDecoderSupported?t.isImageDecoderSupported:!ua&&(ul.platform.isFirefox||!globalThis.chrome),E=Number.isInteger(t.canvasMaxAreaInBytes)?t.canvasMaxAreaInBytes:-1,C="boolean"==typeof t.disableFontFace?t.disableFontFace:ua,M=!0===t.fontExtraProperties,k=!0===t.enableXfa,D=t.ownerDocument||globalThis.document,I=!0===t.disableRange,N=!0===t.disableStream,P=!0===t.disableAutoFetch,O=!0===t.pdfBug,R=t.CanvasFactory||(ua?Zc:$c),B=t.FilterFactory||(ua?Qc:jc),F=!0===t.enableHWA,L=!1!==t.useWasm,z=l?l.length:t.length??NaN,V="boolean"==typeof t.useSystemFonts?t.useSystemFonts:!ua&&!C,H="boolean"==typeof t.useWorkerFetch?t.useWorkerFetch:!!(m===Wc&&b===qc&&v===Xc&&p&&y&&w&&Dl(p,document.baseURI)&&Dl(y,document.baseURI)&&Dl(w,document.baseURI));var $;$=d,Number.isInteger($)&&(Ya=$);const U={canvasFactory:new R({ownerDocument:D,enableHWA:F}),filterFactory:new B({docId:n,ownerDocument:D}),cMapReaderFactory:H?null:new m({baseUrl:p,isCompressed:f}),standardFontDataFactory:H?null:new b({baseUrl:y}),wasmFactory:H?null:new v({baseUrl:w})};h||(h=Fd.create({verbosity:d,port:Xh.workerPort}),e._worker=h);const W={docId:n,apiVersion:"5.4.624",data:s,password:a,disableAutoFetch:P,rangeChunkSize:c,length:z,docBaseUrl:u,enableXfa:k,evaluatorOptions:{maxImageSize:x,disableFontFace:C,ignoreErrors:A,isEvalSupported:S,isOffscreenCanvasSupported:_,isImageDecoderSupported:T,canvasMaxAreaInBytes:E,fontExtraProperties:M,useSystemFonts:V,useWasm:L,useWorkerFetch:H,cMapUrl:p,iccUrl:g,standardFontDataUrl:y,wasmUrl:w}},G={ownerDocument:D,pdfBug:O,styleElement:null,enableHWA:F,loadingParams:{disableAutoFetch:P,enableXfa:k}};return h.promise.then(function(){if(e.destroyed)throw new Error("Loading aborted");if(h.destroyed)throw new Error("Worker was destroyed");const t=h.messageHandler.sendWithPromise("GetDocRequest",W,s?[s.buffer]:null);let a;if(l)a=new rd({pdfDataRangeTransport:l,disableRange:I,disableStream:N});else if(!s){if(!i)throw new Error("getDocument - no `url` parameter provided.");const t=Dl(i)?yd:ua?Ed:vd;a=new t({url:i,length:z,httpHeaders:r,withCredentials:o,rangeChunkSize:c,disableRange:I,disableStream:N})}return t.then(t=>{if(e.destroyed)throw new Error("Loading aborted");if(h.destroyed)throw new Error("Worker was destroyed");const i=new Vc(n,t,h.port),s=new Ld(i,e,a,G,U);e._transport=s,i.send("Ready",null)})}).catch(e._capability.reject),e},getFilenameFromUrl:function(t){return[t]=t.split(/[#?]/,1),t.substring(t.lastIndexOf("/")+1)},getPdfFilenameFromUrl:function(t,e="document.pdf"){if("string"!=typeof t)return e;if(Cl(t))return Qa('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),e;const n=(t=>{try{return new URL(t)}catch{try{return new URL(decodeURIComponent(t))}catch{try{return new URL(t,"https://foo.bar")}catch{try{return new URL(decodeURIComponent(t),"https://foo.bar")}catch{return null}}}}})(t);if(!n)return e;const i=t=>{try{let e=decodeURIComponent(t);return e.includes("/")?(e=e.split("/").at(-1),e.test(/^\.pdf$/i)?e:t):e}catch{return t}},s=/\.pdf$/i,r=n.pathname.split("/").at(-1);if(s.test(r))return i(r);if(n.searchParams.size>0){const t=Array.from(n.searchParams.values()).reverse();for(const n of t)if(s.test(n))return i(n);const e=Array.from(n.searchParams.keys()).reverse();for(const n of e)if(s.test(n))return i(n)}if(n.hash){const t=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i.exec(n.hash);if(t)return i(t[0])}return e},getRGB:Ol,getUuid:yl,getXfaPageViewport:function(t,{scale:e=1,rotation:n=0}){const{width:i,height:s}=t.attributes.style,r=[0,0,parseInt(i),parseInt(s)];return new Tl({viewBox:r,userUnit:1,scale:e,rotation:n})},GlobalWorkerOptions:Xh,ImageKind:Ra,InvalidPDFException:al,isDataScheme:Cl,isPdfFile:Ml,isValidExplicitDest:Ec,MathClamp:wl,noContextMenu:Il,normalizeUnicode:function(t){return ml||(ml=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,gl=new Map([["","t"]])),t.replaceAll(ml,(t,e,n)=>e?e.normalize("NFKC"):gl.get(n))},OPS:Ua,OutputScale:Ll,PagesMapper:ql,PasswordResponses:{NEED_PASSWORD:1,INCORRECT_PASSWORD:2},PDFDataRangeTransport:Pd,PDFDateString:Pl,PDFWorker:Fd,PermissionFlag:{PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048},PixelsPerInch:Sl,RenderingCancelledException:El,renderRichText:jl,ResponseException:ll,setLayerDimensions:Fl,shadow:il,SignatureExtractor:$u,stopEvent:Nl,SupportedImageMimeTypes:zl,TextLayer:Id,TouchManager:ac,updateUrlHash:nl,Util:fl,VerbosityLevel:$a,version:"5.4.624",XfaLayer:Al};const Yu="ProseMirror-menu",Xu="ProseMirror-menubar";function Ju(t,e){return"translate"in t.props&&"function"==typeof t.props.translate?t.props.translate(e):e}function Qu(t,e){return n=>{let i=!1;for(let s=0;s<t.length;s++){const r=t[s](n);e[s]&&(e[s].style.display=r?"":"none",r&&(i=!0))}return i}}function Zu(t,e,...n){let i;if(i="string"==typeof t?document.createElement(t):t,e&&"object"==typeof e&&!("nodeType"in e)&&!Array.isArray(e))for(const s in e)if(K(e,s)){const t=e[s];"string"==typeof t?i.setAttribute(s,t):"number"==typeof t?i.setAttribute(s,t.toString()):null!=t&&(i[s]=t)}for(const s of n)tp(i,s);return i}function tp(t,e){if(!U(e))if("string"!=typeof e)if(Array.isArray(e))for(const n of e)tp(t,n);else{if(!("nodeType"in e)||"number"!=typeof e.nodeType)throw new RangeError(`Unsupported child node: ${JSON.stringify(e)}`);t.appendChild(e)}else t.appendChild(document.createTextNode(e))}class ep{static SYNTHETIC_EVENT_BUTTON_NUMBER=42;menu;menuItems;activeIndex=0;nextKey;prevKey;menuKeydownListener=null;menuFocusListener=null;itemEventListeners=new WeakMap;constructor(t,e,n=!0){this.menu=t,this.menuItems=e,this.nextKey=n?"ArrowRight":"ArrowDown",this.prevKey=n?"ArrowLeft":"ArrowUp"}addArrowKeyNavigation(){this.menuKeydownListener=t=>{t.key!==this.nextKey&&t.key!==this.prevKey||(t.preventDefault(),t.stopPropagation(),(this.activeIndex<0||this.activeIndex>=this.menuItems.length)&&(this.activeIndex=0),this.menuItems[this.activeIndex]&&(this.menuItems[this.activeIndex].tabIndex=-1),t.key===this.nextKey?(this.activeIndex=this.getNextActiveIndex(this.activeIndex,"right",this.menuItems),this.menuItems[this.activeIndex]&&(this.menuItems[this.activeIndex].tabIndex=0,this.menuItems[this.activeIndex].focus())):t.key===this.prevKey&&(this.activeIndex=this.getNextActiveIndex(this.activeIndex,"left",this.menuItems),this.menuItems[this.activeIndex]&&(this.menuItems[this.activeIndex].tabIndex=0,this.menuItems[this.activeIndex].focus())))},this.menu.addEventListener("keydown",this.menuKeydownListener),this.menuItems.forEach((t,e)=>{const n=()=>{this.activeIndex=e,t.tabIndex=0},i=()=>{t.tabIndex=-1},s=e=>{" "!==e.key&&"Enter"!==e.key||(e.preventDefault(),e.stopPropagation(),t.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,buttons:ep.SYNTHETIC_EVENT_BUTTON_NUMBER})))},r=()=>{const t=this.menuItems;for(const e of t)e.blur()};this.itemEventListeners.set(t,{focus:n,blur:i,keydown:s,click:r}),t.addEventListener("focus",n),t.addEventListener("blur",i),t.addEventListener("keydown",s),t.addEventListener("click",r)}),this.menuFocusListener=()=>{this.activeIndex>=0&&this.activeIndex<this.menuItems.length&&this.menuItems[this.activeIndex]&&(this.menuItems[this.activeIndex].tabIndex=0,this.menuItems[this.activeIndex].focus())},this.menu.addEventListener("focus",this.menuFocusListener)}activateFirstItem(){this.activeIndex=0}destroy(){this.menuKeydownListener&&(this.menu.removeEventListener("keydown",this.menuKeydownListener),this.menuKeydownListener=null),this.menuFocusListener&&(this.menu.removeEventListener("focus",this.menuFocusListener),this.menuFocusListener=null),this.menuItems.forEach(t=>{const e=this.itemEventListeners.get(t);e&&(t.removeEventListener("focus",e.focus),t.removeEventListener("blur",e.blur),t.removeEventListener("keydown",e.keydown),t.removeEventListener("click",e.click))}),this.itemEventListeners=new WeakMap}getNextActiveIndex(t,e,n){const i=n.length;if(0===i)return t;const s=t=>"none"!==window.getComputedStyle(t).display&&!t.classList.contains("ProseMirror-menu-disabled");let r=t,o=0;for(;o<i;){if("right"===e?r=(r+1)%i:(r-=1,r<0&&(r=i-1)),s(n[r]))return r;o++}return t}}class np{items;_options;dropDownButton=null;subMenu=null;subMenuItems=[];isSubMenuInitialized=!1;editorView=null;label="";winCloseFunc=null;clickListener=null;subMenuKeyDownListener=null;wcagKeyNavUtil=null;cachedWindow=null;constructor(t,e={}){this.items=Array.isArray(t)?t:[t],this._options=e}get content(){return this.items}get options(){return this._options}render(t){this.destroy(),this.cachedWindow=t.dom.ownerDocument.defaultView??window;const e=this.renderDropdownItems(t,this._options);return e?(this.subMenu=e.dom,this.subMenuItems=e.domList,this.wcagKeyNavUtil=new ep(this.subMenu,this.subMenuItems,!1),this.dropDownButton=this.createDropdownButton(t),this.clickListener=t=>{this.openDropDown(t)},this.dropDownButton.addEventListener("click",this.clickListener),this.subMenuKeyDownListener=t=>{t.preventDefault(),t.stopPropagation(),"Escape"===t.key&&(this.subMenu&&(this.subMenu.style.display="none"),this.dropDownButton?.focus(),this.removeWindowCloseListener())},this.subMenu.addEventListener("keydown",this.subMenuKeyDownListener),{dom:this.dropDownButton,update:n=>{this.isSubMenuInitialized||this.appendSubMenu(t),this.dropDownButton.innerText=this.label;const i=e.update(n);return this.dropDownButton&&(this.dropDownButton.style.display=i?"":"none"),i}}):null}notifySubElementIsActive(t){this.options.static||(t.label&&this.editorView?this.dropDownButton.innerText=Ju(this.editorView,t.label):t.label?this.dropDownButton.innerText=t.label:this.dropDownButton.innerText=this.label)}destroy(){this.dropDownButton&&this.clickListener&&(this.dropDownButton.removeEventListener("click",this.clickListener),this.clickListener=null),this.subMenu&&this.subMenuKeyDownListener&&(this.subMenu.removeEventListener("keydown",this.subMenuKeyDownListener),this.subMenuKeyDownListener=null),this.removeWindowCloseListener(),this.wcagKeyNavUtil&&(this.wcagKeyNavUtil.destroy(),this.wcagKeyNavUtil=null),this.dropDownButton=null,this.subMenu=null,this.subMenuItems=[],this.cachedWindow=null,this.isSubMenuInitialized=!1}renderDropdownItems(t,e={}){const n=[],i=[],s=[],r=Zu("ul",{role:"menu",tabindex:-1,style:"display: none;",class:Yu+"-dropdown-menu "+(e.class||"")});for(const o of this.items){const{dom:a,update:l}=o.render(t,e.showLabel,!1,this);if(!a)continue;i.push(a);const c=Zu("li",{class:Yu+"-dropdown-item",tabindex:-1,role:"menuitem"},a);r.appendChild(c),n.push(c),s.push(l)}return i.length?{dom:r,update:Qu(s,n),domList:i}:null}createDropdownButton(t){return this.label=Ju(t,this._options.title),Zu("button",{class:Yu+"-dropdown-wrap",tabindex:"-1"},this.label)}appendSubMenu(t){const e=this.dropDownButton.parentElement;e&&this.subMenu&&(e.appendChild(this.subMenu),this.isSubMenuInitialized=!0,this.adjustDropdownButtonWidth(t),this.wcagKeyNavUtil?.addArrowKeyNavigation())}adjustDropdownButtonWidth(t){if(!this.dropDownButton||0===this.subMenuItems.length)return;if(this.options.static)return;const e=this.createDropdownButton(t);this.dropDownButton.parentElement?.appendChild(e),e.style.position="absolute",e.style.visibility="hidden",e.style.left="-10000px";let n=e.offsetWidth;for(const i of this.subMenuItems){e.innerText=i.innerText;const t=e.offsetWidth;t>n&&(n=t)}this.dropDownButton.style.minWidth=`${n}px`,e.parentElement&&e.parentElement.removeChild(e)}openDropDown(t){if(t.stopPropagation(),t.preventDefault(),this.subMenu&&this.dropDownButton)if("none"===this.subMenu.style.display){const e=this.dropDownButton.offsetLeft,n=this.dropDownButton.offsetTop+this.dropDownButton.offsetHeight;this.subMenu.style.left=`${e}px`,this.subMenu.style.top=`${n}px`,this.subMenu.style.display="",this.wcagKeyNavUtil?.activateFirstItem(),t.buttons===ep.SYNTHETIC_EVENT_BUTTON_NUMBER&&this.subMenu.focus(),this.winCloseFunc=()=>(this.subMenu&&(this.subMenu.style.display="none"),this.removeWindowCloseListener(),!0),this.cachedWindow?.addEventListener("click",this.winCloseFunc)}else this.subMenu.style.display="none",this.removeWindowCloseListener()}removeWindowCloseListener(){this.winCloseFunc&&this.cachedWindow&&(this.cachedWindow.removeEventListener("click",this.winCloseFunc),this.winCloseFunc=null)}}class ip{static MENU_EVENT_WINDOW_MS=100;static LAST_MENU_EVENT={time:0,node:null};items;constructor(t){this.items=t}renderDropdownItems(t,e={},n=!1){const i=[],s=[],r=Zu("ul",{role:"menu",tabindex:-1,class:Yu+"-dropdown-menu "+(e.class||"")}),o=[];for(const a of this.items){const{dom:l,update:c}=a.render(t,e.showLabel,n);if(s.push(l),n)i.push(Zu("div",{class:Yu+"-dropdown-item"},l));else{const t=Zu("li",{class:Yu+"-dropdown-item",tabindex:-1,role:"menuitem"},l);r.appendChild(t),i.push(t)}o.push(c)}return{dom:n?i:r,update:Qu(o,i),domList:s}}isMenuEvent(t){return Date.now()-ip.LAST_MENU_EVENT.time<ip.MENU_EVENT_WINDOW_MS&&null!==ip.LAST_MENU_EVENT.node&&t.contains(ip.LAST_MENU_EVENT.node)}markMenuEvent(t){ip.LAST_MENU_EVENT.time=Date.now(),ip.LAST_MENU_EVENT.node=t.target}}class sp extends ip{_options;constructor(t,e={}){super(Array.isArray(t)?t:[t]),this._options=e}get content(){return this.items}get options(){return this._options}render(t){const e=this.renderDropdownItems(t),n=t.dom.ownerDocument.defaultView||window,i=Zu("div",{class:Yu+"-dropdown "+(this._options.class||""),style:this._options.css},Ju(t,this._options.label||""));this._options.title&&i.setAttribute("title",Ju(t,this._options.title));const s=Zu("div",{class:Yu+"-dropdown-wrap"},i);let r=null,o=null;const a=()=>{r?.close()&&(r=null),o&&(n.removeEventListener("click",o),o=null)};return i.addEventListener("click",t=>{t.preventDefault(),this.markMenuEvent(t),r?a():(r=this.expand(s,e.dom),o=()=>{this.isMenuEvent(s)||a()},n.addEventListener("click",o))}),{dom:s,update:t=>{const n=e.update(t);return s.style.display=n?"":"none",n}}}expand(t,e){const n=Zu("div",{class:Yu+"-dropdown-menu "+(this._options.class||"")},e);let i=!1;return t.appendChild(n),{close:function(){if(i)return!1;if(i=!0,n.parentNode===t)try{t.removeChild(n)}catch(e){console.warn("Menu DOM element already removed",e)}return!0},node:n}}}const rp={join:{width:800,height:900,path:"M0 75h800v125h-800z M0 825h800v-125h-800z M250 400h100v-100h100v100h100v100h-100v100h-100v-100h-100z"},lift:{width:1024,height:1024,path:"M219 310v329q0 7-5 12t-12 5q-8 0-13-5l-164-164q-5-5-5-13t5-13l164-164q5-5 13-5 7 0 12 5t5 12zM1024 749v109q0 7-5 12t-12 5h-987q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h987q7 0 12 5t5 12zM1024 530v109q0 7-5 12t-12 5h-621q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h621q7 0 12 5t5 12zM1024 310v109q0 7-5 12t-12 5h-621q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h621q7 0 12 5t5 12zM1024 91v109q0 7-5 12t-12 5h-987q-7 0-12-5t-5-12v-109q0-7 5-12t12-5h987q7 0 12 5t5 12z"},selectParentNode:{width:24,height:24,path:"m12 13.914 4.793 4.793 1.414-1.414L12 11.086l-6.207 6.207 1.414 1.414zM6 7h12v2H6z"},undo:{width:24,height:24,path:"m5.828 7 2.536 2.535L6.95 10.95 2 6l4.95-4.95 1.414 1.415L5.828 5H13a8 8 0 1 1 0 16H4v-2h9a6 6 0 0 0 0-12z"},redo:{width:24,height:24,path:"M18.172 7H11a6 6 0 0 0 0 12h9v2h-9a8 8 0 0 1 0-16h7.172l-2.536-2.536L17.05 1.05 22 6l-4.95 4.95-1.414-1.415z"},headings:{width:24,height:24,path:"M17 11V4h2v17h-2v-8H7v8H5V4h2v7z"},h1:{width:24,height:24,path:"M13 20h-2v-7H4v7H2V4h2v7h7V4h2zm8-12v12h-2v-9.796l-2 .536V8.67L19.5 8z"},h2:{width:24,height:24,path:"M4 4v7h7V4h2v16h-2v-7H4v7H2V4zm14.5 4a3.75 3.75 0 0 1 2.978 6.03l-.148.18L18.034 18H22v2h-7v-1.556l4.82-5.546a1.75 1.75 0 1 0-3.065-1.292l-.005.144h-2A3.75 3.75 0 0 1 18.5 8"},h3:{width:24,height:24,path:"m22 8-.002 2-2.505 2.883a3.752 3.752 0 0 1-.993 7.367 3.75 3.75 0 0 1-3.682-3.033l1.964-.382a1.75 1.75 0 1 0 .924-1.895l-1.307-1.547L19.35 10H15V8zM4 4v7h7V4h2v16h-2v-7H4v7H2V4z"},h4:{width:24,height:24,path:"M13 20h-2v-7H4v7H2V4h2v7h7V4h2zm9-12v8h1.5v2H22v2h-2v-2h-5.5v-1.34l5-8.66zm-2 3.133L17.19 16H20z"},h5:{width:24,height:24,path:"M22 8v2h-4.323l-.464 2.636A4.006 4.006 0 0 1 22.25 16.5a4 4 0 0 1-7.846 1.103l1.923-.551a2 2 0 1 0 .363-1.804l-1.81-.904L16 8zM4 4v7h7V4h2v16h-2v-7H4v7H2V4z"},h6:{width:24,height:24,path:"M21.097 8L18.499 12.5C20.7091 12.5 22.5 14.2909 22.5 16.5C22.5 18.7091 20.7091 20.5 18.5 20.5C16.2909 20.5 14.5 18.7091 14.5 16.5C14.5 15.7636 14.699 15.0737 15.0461 14.4811L18.788 8H21.097ZM4 4V11H11V4H13V20H11V13H4V20H2V4H4ZM18.5 14.5C17.3954 14.5 16.5 15.3954 16.5 16.5C16.5 17.6046 17.3954 18.5 18.5 18.5C19.6046 18.5 20.5 17.6046 20.5 16.5C20.5 15.3954 19.6046 14.5 18.5 14.5Z"},strong:{width:24,height:24,path:"M8 11h4.5a2.5 2.5 0 0 0 0-5H8zm10 4.5a4.5 4.5 0 0 1-4.5 4.5H6V4h6.5a4.5 4.5 0 0 1 3.256 7.606A4.5 4.5 0 0 1 18 15.5M8 13v5h5.5a2.5 2.5 0 0 0 0-5z"},em:{width:24,height:24,path:"M15 20H7v-2h2.927l2.116-12H9V4h8v2h-2.927l-2.116 12H15z"},strikethrough:{width:24,height:24,path:"M17.154 14q.346.774.346 1.72 0 2.014-1.571 3.147Q14.357 20 11.586 20q-2.46 0-4.87-1.145v-2.254q2.28 1.316 4.666 1.316 3.826 0 3.839-2.197a2.2 2.2 0 0 0-.648-1.603l-.12-.117H3v-2h18v2zm-4.078-3H7.629a4 4 0 0 1-.481-.522Q6.5 9.643 6.5 8.452q0-1.854 1.397-3.153T12.222 4q2.207 0 4.222.984v2.152q-1.8-1.03-3.946-1.03-3.72 0-3.719 2.346 0 .63.654 1.099.654.47 1.613.75.93.27 2.03.699"},code:{width:24,height:24,path:"m23 12-7.071 7.071-1.414-1.414L20.172 12l-5.657-5.657 1.414-1.414zM3.828 12l5.657 5.657-1.414 1.414L1 12l7.071-7.071 1.414 1.414z"},link:{width:24,height:24,path:"M18.364 15.536 16.95 14.12l1.414-1.414a5 5 0 0 0-7.071-7.071L9.878 7.05 8.464 5.636l1.414-1.414a7 7 0 0 1 9.9 9.9zm-2.829 2.828-1.414 1.414a7 7 0 0 1-9.9-9.9l1.415-1.414L7.05 9.88l-1.414 1.414a5 5 0 0 0 7.07 7.071l1.415-1.414zm-.707-10.607 1.415 1.415-7.072 7.07-1.414-1.414z"},bulletList:{width:24,height:24,path:"M8 4h13v2H8zM4.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m0 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m0 6.9a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3M8 11h13v2H8zm0 7h13v2H8z"},orderedList:{width:24,height:24,path:"M5.75 3.5H4.717l-1.467.393v1.553l1-.268V8.5H3V10h4V8.5H5.75zM10 4h11v2H10zm0 7h11v2H10zm0 7h11v2H10zm-7.125-2.375a2.125 2.125 0 1 1 3.812 1.292l-.004.006L5.316 18.5H7V20H3v-1.121l2.472-2.844a.625.625 0 1 0-1.094-.466l-.013.306h-1.49z"},blockquote:{width:24,height:24,path:"M19.417 6.679C20.447 7.773 21 9 21 10.989c0 3.5-2.456 6.637-6.03 8.188l-.893-1.378c3.335-1.804 3.987-4.145 4.248-5.621-.537.278-1.24.375-1.93.311-1.804-.167-3.226-1.648-3.226-3.489a3.5 3.5 0 0 1 3.5-3.5c1.073 0 2.1.49 2.748 1.179m-10 0C10.447 7.773 11 9 11 10.989c0 3.5-2.456 6.637-6.03 8.188l-.893-1.378c3.335-1.804 3.987-4.145 4.247-5.621-.537.278-1.24.375-1.929.311C4.591 12.323 3.17 10.842 3.17 9a3.5 3.5 0 0 1 3.5-3.5c1.073 0 2.1.49 2.748 1.179"},image:{width:24,height:24,path:"m5 11.1 2-2 5.5 5.5 3.5-3.5 3 3V5H5zm0 2.829V19h3.1l2.986-2.985L7 11.929zM10.929 19H19v-2.071l-3-3zM4 3h16a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m11.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"},file:{width:24,height:24,path:"M9 2.003V2h10.998C20.55 2 21 2.455 21 2.992v18.016a.993.993 0 0 1-.993.992H3.993A1 1 0 0 1 3 20.993V8zM5.83 8H9V4.83zM11 4v5a1 1 0 0 1-1 1H5v10h14V4z"},horizontalRule:{width:24,height:24,path:"M2 11h2v2H2zm4 0h12v2H6zm14 0h2v2h-2z"},textBlock:{width:24,height:24,path:"M1 2v3h2V4h2v5H3.5v2h5V9H7V4h2v1h2V2zm20 1h-7v2h6v14H4v-5H2v6a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1"},codeBlock:{width:24,height:24,path:"M3 3h18a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1m1 2v14h16V5zm16 7-3.535 3.536-1.415-1.415L17.172 12 15.05 9.879l1.415-1.415zM6.828 12l2.122 2.121-1.414 1.415L4 12l3.536-3.536L8.95 9.88zm4.416 5H9.116l3.64-10h2.128z"},paragraph:{width:24,height:24,path:"M12 6v15h-2v-5a6 6 0 0 1 0-12h10v2h-3v15h-2V6zm-2 0a4 4 0 1 0 0 8z"},alignLeft:{width:24,height:24,path:"M3 4h18v2H3zm0 15h14v2H3zm0-5h18v2H3zm0-5h14v2H3z"},alignCenter:{width:24,height:24,path:"M3 4h18v2H3zm2 15h14v2H5zm-2-5h18v2H3zm2-5h14v2H5z"},alignRight:{width:24,height:24,path:"M3 4h18v2H3zm4 15h14v2H7zm-4-5h18v2H3zm4-5h14v2H7z"},alignJustify:{width:24,height:24,path:"M3 4h18v2H3zm0 15h18v2H3zm0-5h18v2H3zm0-5h18v2H3z"},subscript:{width:24,height:24,path:"M5.596 4 10.5 9.928 15.404 4H18l-6.202 7.497L18 18.994V19h-2.59l-4.91-5.934L5.59 19H3v-.006l6.202-7.497L3 4zM21.8 16a.8.8 0 1 0-1.57.22l-1.154.33A2.001 2.001 0 1 1 23 16c0 .573-.24 1.09-.626 1.454L20.744 19H23v1h-4v-1l2.55-2.42a.8.8 0 0 0 .25-.58"},superscript:{width:24,height:24,path:"m5.596 5 4.904 5.928L15.404 5H18l-6.202 7.497L18 19.994V20h-2.59l-4.91-5.934L5.59 20H3v-.006l6.202-7.497L3 5zM21.55 6.58a.8.8 0 1 0-1.32-.36l-1.155.33A2.001 2.001 0 1 1 23 6c0 .573-.24 1.09-.626 1.454L20.744 9H23v1h-4V9z"},testIcon:{text:"",css:"font-weight: bold"}};function op(t,e,n=!1,i=!1){const s=document.createDocumentFragment(),r=[],o=[],a=[];let l=0;for(let c=0;c<e.length;c++){let h=0;const d=e[c],u=[],p=[];let f;i||(f=Zu("div",{class:`${Yu}group ${Yu}item`,role:"group"}));for(const e of d){const{dom:r,update:a}=e.render(t,n,i);if(r){if(l++,h++,o.push(r),i){const t=Zu("span",{class:Yu+"item",tabindex:-1},r);s.appendChild(t),u.push(t)}else f.appendChild(r),u.push(r);p.push(a)}}!i&&h&&s.appendChild(f),p.length&&(r.push(Qu(p,u)),i&&c<e.length-1&&a.push(s.appendChild(ap())))}return l?{dom:s,update:t=>(Promise.resolve().then(()=>{let e=!1;for(let n=0;n<r.length;n++){const s=r[n](t);i&&n&&(a[n-1].style.display=e&&s?"":"none"),e=s}}),!0),menuItems:o}:null}function ap(){return Zu("span",{class:Yu+"separator"})}class lp{static MIN_VERTICAL_CLEARANCE=10;wrapper;menu;scrollHandler=null;editorView;options;spacer=null;maxHeight=0;widthForMaxHeight=0;floating=!1;contentUpdate;root;scrollListeners=[];cachedMenuHeight=0;previousDoc=null;previousSelection=null;timer=null;constructor(t,e){this.editorView=t,this.options=e,this.root=t.root,this.wrapper=Zu("div",{class:Xu+"-wrapper"}),this.menu=this.wrapper.appendChild(Zu("div",{class:Xu})),this.menu.className=Xu,this.menu.role="toolbar",this.menu.ariaLabel="Text formatting options",this.menu.ariaControlsElements=[this.editorView.dom],this.menu.tabIndex=0,t.dom.parentNode&&t.dom.parentNode.replaceChild(this.wrapper,t.dom),this.wrapper.appendChild(t.dom);const n=op(this.editorView,this.options.content,this.options.showLabel,this.options.isLegacy);if(n){const{dom:t,update:i,menuItems:s}=n;if(this.contentUpdate=i,this.menu.appendChild(t),this.update(),new ep(this.menu,s).addArrowKeyNavigation(),e.floating&&!L.ios){this.updateFloat();const t=this.getAllWrapping(this.wrapper);this.scrollListeners=t,this.scrollHandler=t=>{const e=this.editorView.root;if((e.body||e).contains(this.wrapper)){const e=t.target;this.updateFloat(e&&"function"==typeof e.getBoundingClientRect?e:void 0)}else this.removeScrollListeners()},t.forEach(t=>{t.addEventListener("scroll",this.scrollHandler)})}}}update(){if(this.editorView.root!==this.root){const t=op(this.editorView,this.options.content,this.options.showLabel);if(t){const{dom:e,update:n}=t;this.contentUpdate=n,this.menu.firstChild&&this.menu.replaceChild(e,this.menu.firstChild),this.root=this.editorView.root}}this.setKeyInputWaitState(),this.ignoreUpdate()||(window.setTimeout(()=>this.contentUpdate(this.editorView.state),10),this.floating?this.updateScrollCursor():(this.menu.offsetWidth!==this.widthForMaxHeight&&(this.widthForMaxHeight=this.menu.offsetWidth,this.maxHeight=0),this.menu.offsetHeight>this.maxHeight&&(this.maxHeight=this.menu.offsetHeight,this.menu.style.minHeight=`${this.maxHeight}px`)))}setKeyInputWaitState(){"beforeinput"===this.editorView.input.lastEventType&&(this.timer&&(window.clearTimeout(this.timer),this.timer=null),this.timer=window.setTimeout(()=>{this.timer=null,this.contentUpdate(this.editorView.state)},800))}ignoreUpdate(){const t=this.editorView.state.doc,e=this.editorView.state.selection,n=this.previousDoc!==t&&!this.previousDoc?.eq(t),i=this.previousSelection!==e&&!this.previousSelection?.eq(e);return!n&&!i||(this.previousDoc=t,this.previousSelection=e,"keyup"===this.editorView.input.lastEventType||"keypress"===this.editorView.input.lastEventType||"beforeinput"===this.editorView.input.lastEventType||(this.timer&&(window.clearTimeout(this.timer),this.timer=null),!1))}updateScrollCursor(){const t=this.editorView.root.getSelection();if(!t?.focusNode||0===t.rangeCount)return;const e=t.getRangeAt(0).getClientRects();if(0===e.length)return;const n=e[this.selectionIsInverted(t)?0:e.length-1];if(!n)return;const i=this.menu.getBoundingClientRect();if(n.top<i.bottom&&n.bottom>i.top){const t=this.findWrappingScrollable(this.wrapper);t&&(t.scrollTop-=i.bottom-n.top)}}updateFloat(t){const e=this.wrapper,n=e.getBoundingClientRect(),i=t?Math.max(0,t.getBoundingClientRect().top):0;this.floating?this.handleFloatingMode(n,i,e):this.handleNormalMode(n,i,e)}handleFloatingMode(t,e,n){const i=this.cachedMenuHeight||this.menu.offsetHeight;t.top>=e||t.bottom<i+lp.MIN_VERTICAL_CLEARANCE?this.disableFloating():this.updateFloatingPosition(t,e,n)}handleNormalMode(t,e,n){t.top<e&&t.bottom>=this.menu.offsetHeight+lp.MIN_VERTICAL_CLEARANCE&&this.enableFloating(n,e)}disableFloating(){this.floating=!1,this.cachedMenuHeight=0,this.menu.style.position="",this.menu.style.left="",this.menu.style.top="",this.menu.style.width="",this.menu.style.display="",this.spacer?.parentNode&&(this.spacer.parentNode.removeChild(this.spacer),this.spacer=null)}enableFloating(t,e){this.floating=!0;const n=this.menu.getBoundingClientRect();this.cachedMenuHeight=n.height,this.menu.style.position="fixed",this.menu.style.left=`${n.left}px`,this.menu.style.width=`${n.width}px`,this.menu.style.top=`${e}px`,this.spacer=Zu("div",{class:`${Xu}-spacer`,style:`height: ${n.height}px`}),t.insertBefore(this.spacer,this.menu)}updateFloatingPosition(t,e,n){const i=(n.offsetWidth-n.clientWidth)/2;this.menu.style.left=`${t.left+i}px`;const s=this.editorView.dom.ownerDocument.defaultView||window,r=t.top>s.innerHeight;this.menu.style.display=r?"none":"",this.menu.style.top=`${e}px`}removeScrollListeners(){if(this.scrollHandler){const t=this.scrollHandler;this.scrollListeners.forEach(e=>{e.removeEventListener("scroll",t)}),this.scrollListeners=[]}}destroy(){this.removeScrollListeners(),this.wrapper.parentNode&&this.wrapper.parentNode.replaceChild(this.editorView.dom,this.wrapper)}selectionIsInverted(t){return!(!t.anchorNode||!t.focusNode)&&(t.anchorNode===t.focusNode?t.anchorOffset>t.focusOffset:t.anchorNode.compareDocumentPosition(t.focusNode)===Node.DOCUMENT_POSITION_FOLLOWING)}findWrappingScrollable(t){for(let e=t.parentNode;e;e=e.parentNode)if(e instanceof HTMLElement&&e.scrollHeight>e.clientHeight)return e}getAllWrapping(t){const e=[t.ownerDocument.defaultView||window];for(let n=t.parentNode;n;n=n.parentNode)e.push(n);return e}}function cp(t,e,n){n?t.classList.add(e):t.classList.remove(e)}const hp="http://www.w3.org/2000/svg",dp="ProseMirror-icon",up=`${dp}-collection`,pp=new Map,fp=/([^#]*)/;class mp{_spec;constructor(t){this._spec=t}get spec(){return this._spec}render(t,e=!1,n=!1,i){if(!this._spec)return null;const s=this.createDomElement(t,e,n);return this.applyTitleAttribute(s,t),this.applyClassAndStyles(s),this.updateEnabledState(s,t.state),this.attachClickHandler(s,t),{dom:s,update:this.createUpdateFunction(s,i)}}createDomElement(t,e=!1,n=!1){const i=this._spec;if(i.render){const e=i.render(t);if(e)return e}const s=Ju(t,i.label||("function"==typeof i.title?i.title(t.state):i.title)||"");if(i.icon)return function(t,e,n,i=!1,s=!1){const r=9===(a=t).nodeType?a:a.ownerDocument||document,o=r.createElement(s?"div":"button");var a;o.className=dp,o.tabIndex=-1,o.addEventListener("focus",()=>{o.tabIndex=0}),o.addEventListener("blur",()=>{o.tabIndex=-1});const l=n&&!s?function(t,e,n=!1){const i=t.createElement("span");return i.className=n?"label":"wcag-label",i.textContent=e,i}(r,n,i):void 0;return function(t){return"path"in t&&"string"==typeof t.path}(e)?function(t,e,n,i,s){const{path:r,width:o,height:a}=i,l=`pm-icon-${function(t){const e=pp.get(t);if(void 0!==e)return e;let n=0;for(let i=0;i<t.length;i++)n=(n<<5)-n+t.charCodeAt(i)|0;return pp.set(t,n),n}(r).toString(16)}`;e.getElementById(l)||function(t,e,n){const[i,s]=function(t){if(9===t.nodeType){const e=t;if(!e.body)throw new Error("Document body is not available. Ensure icons are created after DOM is ready.");return[e,e.body]}return[t.ownerDocument||document,t]}(t),r=function(t,e){const n=t.getElementById(up);if(n)return n;const i=t.createElementNS(hp,"svg");return i.id=up,i.style.display="none",e.insertBefore(i,e.firstChild),i}(i,s),o=function(t,e,n){const i=t.createElementNS(hp,"symbol");i.id=e,i.setAttribute("viewBox",`0 0 ${n.width} ${n.height}`);const s=t.createElementNS(hp,"path");return s.setAttribute("d",n.path),i.appendChild(s),i}(i,e,n);r.appendChild(o)}(t,l,i);const c=e.createElementNS(hp,"svg"),h=Number(o),d=Number(a);if(d>0&&h>0&&isFinite(h)&&isFinite(d)){if(!s){const t=h/d;c.style.width=`${t}em`}}else s||(c.style.width="1em");n.appendChild(c),c.ariaHidden="true",s&&n.appendChild(s);const u=e.createElementNS(hp,"use"),p=`${function(t){const e=fp.exec(t.location.toString());return e?e[1]:""}(e)}#${l}`;u.setAttributeNS("http://www.w3.org/1999/xlink","href",p),c.appendChild(u)}(t,r,o,e,l):function(t){return"dom"in t&&!("path"in t)&&!("text"in t)}(e)?function(t,e,n){const i=e.dom.cloneNode(!0);i.ariaHidden="true",t.appendChild(i),n&&t.appendChild(n)}(o,e,l):function(t){return"text"in t&&!("path"in t)&&!("dom"in t)}(e)&&function(t,e,n){const i=t.createElement("span");i.textContent=n.text||"",n.css&&(i.style.cssText=n.css),e.appendChild(i)}(r,o,e),o}(t.root,i.icon,s,e,n);if(i.label)return Zu(n?"div":"button",{tabindex:"-1"},s);throw new RangeError("MenuItem without icon or label property")}applyTitleAttribute(t,e){const{title:n}=this._spec;if(!n)return;const i="function"==typeof n?n(e.state):n;t.setAttribute("title",Ju(e,i)),t.ariaLabel=i}applyClassAndStyles(t){const{class:e,css:n}=this._spec;e&&t.classList.add(e),n&&(t.style.cssText+=n)}attachClickHandler(t,e){t.addEventListener("click",n=>{if(n.preventDefault(),t.classList.contains(Yu+"-disabled"))return;const i=t=>{e.dispatch(t)};e.focus(),setTimeout(()=>{this._spec.run(e.state,i,e,n)},10)})}createUpdateFunction(t,e){return n=>{if(!this.updateVisibility(t,n))return!1;const i=this.updateEnabledState(t,n);return this.updateActiveState(t,n,i,e),!0}}updateVisibility(t,e){const{select:n}=this._spec;if(!n)return!0;const i=n(e);return t.style.display=i?"":"none",i}updateEnabledState(t,e){const{enable:n}=this._spec,i=!n||n(e)||!1;return cp(t,`${Yu}-disabled`,!i),t.ariaDisabled=i?null:"true",i}updateActiveState(t,e,n,i){const{active:s}=this._spec;if(!s)return;const r=n&&s(e);cp(t,`${Yu}-active`,r),t.ariaPressed=r?"true":"false",r&&i&&i.notifySubElementIsActive(this._spec)}}const gp="pm-close-drop-zone",yp="pm-dialogpage",bp="pm-dialogpagetab";class wp{dialog=null;isDialogSupported=!0;listeners=[];pages=[];tabs=[];activePageIndex=0;addListener(t,e,n){const i=this.resolveElement(t);if(!i){const n="string"==typeof t?t:t.tagName||"HTMLElement";return void console.warn(`EditDialog: Unable to resolve element "${n}" for event "${e}"`)}i.addEventListener(e,n),this.listeners.push({element:i,eventType:e,listener:n})}open(t,e,n){this.dialog&&this.close(t),this.createDialog(e,n),this.buildDialogContent(),this.attachTabButtonHandlers(),this.attachCloseHandler(t),this.showDialog(),this.positionDialog(t)}close(t){this.dialog&&(this.hideDialog(),t.focus(),window.setTimeout(()=>{this.cleanup()},100))}add(t){return this.ensurePageExists(),this.pages[this.activePageIndex-1]+=t,this}addRow(t){this.ensurePageExists();const e=this.activePageIndex-1;return this.pages[e]+=`<div class="pm-menu-row">${t}</div>`,this.pages[e]+='<div class="pm-menu-row-end"></div>',this}addPage(t){this.activePageIndex+=1,this.pages.push("");const e=1===this.activePageIndex?" active":"",n=`<button id="${bp}${this.activePageIndex}" title="${t}" class="pm-tab-btn${e}">${t}</button>`;return this.tabs.push(n),this}ensurePageExists(){0===this.pages.length&&(this.pages.push(""),this.activePageIndex=1)}resolveElement(t){return"string"==typeof t?"window"===t?window:document.getElementById(t):t}createDialog(t,e){this.isDialogSupported="function"==typeof HTMLDialogElement;const n=this.isDialogSupported?"dialog":"div",i=document.createElement(n);this.dialog=document.body.appendChild(i),this.dialog.classList.add("pm-dialog"),this.dialog.style.width=`${t}px`,this.dialog.style.height=`${e}px`,this.dialog.style.visibility="hidden"}buildDialogContent(){if(!this.dialog)return;const t=this.buildPagesContent(),e=this.buildTabBar();this.dialog.innerHTML=t+e}buildPagesContent(){let t="";for(let e=0;e<this.pages.length;e++)t+=`<div id="${yp}${e+1}"${0===e?"":' style="display:none;"'}>${this.pages[e]}</div>`;return t+=`<button id="${gp}" class="pm-close-btn" title="Close">Close</button>`,t}buildTabBar(){return this.pages.length<=1?"":`<div id="pm-tab-bar" class="pm-tab-bar">${this.tabs.join("")}</div>`}attachCloseHandler(t){this.addListener(gp,"click",()=>{this.close(t)})}attachTabButtonHandlers(){if(this.pages.length<=1)return;let t=1;for(let e=0;e<this.tabs.length;e++){const n=e+1;this.addListener(`${bp}${n}`,"click",()=>{this.switchToPage(t,n),t=n})}}switchToPage(t,e){const n=document.getElementById(`${yp}${t}`),i=document.getElementById(`${bp}${t}`),s=document.getElementById(`${yp}${e}`),r=document.getElementById(`${bp}${e}`);n&&i&&s&&r&&(n.style.display="none",i.classList.remove("active"),s.style.display="",r.classList.add("active"))}positionTabBar(){if(this.pages.length<=1)return;const t=document.getElementById("pm-tab-bar");t&&(t.style.left=-t.offsetWidth+"px")}showDialog(){this.dialog&&(this.isDialogSupported&&this.dialog.showModal(),this.positionTabBar())}positionDialog(t){if(!this.dialog)return;const e=t.dom.offsetTop+10,n=t.dom.offsetLeft+t.dom.offsetWidth/2,i=Math.max(0,n-this.dialog.offsetWidth/2);this.dialog.style.top=`${e}px`,this.dialog.style.left=`${i}px`,this.dialog.style.visibility="visible"}hideDialog(){this.dialog&&(this.isDialogSupported?this.dialog.close():this.dialog.style.display="none")}removeAllListeners(){for(const{element:t,eventType:e,listener:n}of this.listeners)t.removeEventListener(e,n);this.listeners=[]}cleanup(){this.removeAllListeners(),this.dialog&&(this.dialog.remove(),this.dialog=null)}}function vp(t,e){if(!e)return!1;for(const n of Object.keys(e))if(String(t[n])!==String(e[n]))return!1;return!0}function Ap(t,e){for(const n of Object.keys(e)){const e=t[n];if(null!=e&&""!==e)return!0}return!1}function xp(t){const e=t.doc;return!(1===e.childCount&&e.firstChild?.isTextblock&&0===e.firstChild.content.size)}function Sp(t="left",e=t,n=Tn.nodes.code_block,i=Tn.nodes.paragraph,s=Tn.nodes.figure,r=Tn.nodes.bullet_list,o=Tn.nodes.ordered_list){return new mp({title:_p(e),label:_p(e),run:Ls("align",t,r,o),enable:t=>xp(t)&&!ds(t,n),active:e=>function(t,e,n,i=!1,...s){const{$from:r,to:o,node:a}=t.selection;if(s&&s.length>0&&n){const t=[];for(let n=0;n<=r.depth;n++){const e=r.node(n);s.includes(e.type)&&t.push(e)}if(0===t.length){const t=a||r.parent;return t&&Ap(t.attrs,n)?vp(t.attrs,n):i}let e=!1;for(const i of t)if(Ap(i.attrs,n)&&(e=!0,vp(i.attrs,n)))return!0;return!e&&i}if((!s||0===s.length)&&n&&i){const t=a||r.parent;if(t&&!Ap(t.attrs,n))return i}if(a)return e=e||a.type,a.hasMarkup(e,n)||a.type===e&&vp(a.attrs,n);const l=r.parent;return!!l&&(e=e||l.type,o<=r.end()&&(l.hasMarkup(e,n)||l.type===e&&vp(l.attrs,n)))}(e,null,{align:t},"left"===t,i,s,r,o),icon:rp[`align${_p(t)}`]})}function _p(t){return t.charAt(0).toUpperCase()+t.slice(1)}function Tp(t,e=1e3,n=0){const i=t.selection.to-t.selection.from;return i>=n&&i<=e}function Ep(t,e,n){return!U(nn(t.selection,t=>t.type===e||t.type===n))}function Cp(t,e){return t.selection.empty?!!e.isInSet(t.storedMarks||t.selection.$from.marks()):t.doc.rangeHasMark(t.selection.from,t.selection.to,e)}new Image(30,31).src="data:image/jpeg;base64,/9j/4QDKRXhpZgAATU0AKgAAAAgABgESAAMAAAABAAEAAAEaAAUAAAABAAAAVgEbAAUAAAABAAAAXgEoAAMAAAABAAIAAAITAAMAAAABAAEAAIdpAAQAAAABAAAAZgAAAAAAAABIAAAAAQAAAEgAAAABAAeQAAAHAAAABDAyMjGRAQAHAAAABAECAwCgAAAHAAAABDAxMDCgAQADAAAAAQABAACgAgAEAAAAAQAAADygAwAEAAAAAQAAADCkBgADAAAAAQAAAAAAAAAAAAD/2wCEAAEBAQEBAQIBAQIDAgICAwQDAwMDBAUEBAQEBAUGBQUFBQUFBgYGBgYGBgYHBwcHBwcICAgICAkJCQkJCQkJCQkBAQEBAgICBAICBAkGBQYJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCf/dAAQABP/AABEIADAAPAMBIgACEQEDEQH/xAGiAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgsQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+gEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoLEQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AP6y9A8OLr8lzulMXkkdBnrn6elbX/CEab/0EV/8c/8AiqseA1JTUvoP/Zq8xih81lijXLNhQPc8CgD0b/hCNO/6CK/+Of8AxVL/AMIRpv8A0Ek/8d/+KrQg+Glv9lxc3BE2OdqjaD6Y6n9K801LTZNLvpNPuQN8RxkdCOxH4UAd1/whGnf9BFf/ABz/AOKo/wCEI03/AKCK/wDjn/xVecbE9BRsT0FAHpcfgK0lz5N9v2/3Qp/ka4qxB8tsf3v6Cuz+HC/6RehR/wAs1/ma5HT/APVN/vf0FAH/0P68fAXTU/oP/Zq8yt5nt5Y7iP70ZDD8Oa9N8BdNT+g/9mry0dBQB7pB4+0CS18+d2jfHMe0k59scGvIdb1M6xqkuoldgcjavooGBWVVyy0++1F/LsIXlP8Asjj8+lAGnomg3GtQXckHW3j3KPVv7v5A1z9e/wDhDRptF0nyrpQs0jF3A5x2A/AV5N4u04aZr00SDCSfvE9MN2/A0AdL8Nv+Pi9/65p/M1x2n/6pv97+grsfht/x8Xv/AFzT+ZrjtP8A9U3+9/QUAf/R/rt8BsQmpfQf+zV5eGXA5FddoHiJdAkud0Jl80jocYxn2962h4305SCNOUY/3P8A4mgC54T8HrtXUtYjzn7kTfzYfyFenx7YkEcahVHQAYH5CvMP+Fjp/wA+h/77H+FH/Cx0/wCfQ/8AfY/woA9S3mvP/Hujz6hax6hapue3yGA67D/hWb/wsdP+fQ/99j/Cj/hY6f8APof++x/hQBV+HDYuL3b/AM81/ma5HT/9U3+9/QV2CePbSLPlWOzd12lR/Ja4qxJ8tsf3v6CgD//Z";function Mp(t){return[...t.dataTransfer.items].filter(t=>"file"===t.kind)}function kp(t){return t.some(t=>t.type.startsWith("image/"))}function Dp(t="1",e=`Heading ${t}`,n=Tn.nodes.heading,i=Tn.nodes.code_block){return new mp({title:e,label:e,run:Hs(n,{level:t}),enable:e=>xp(e)&&(sn(e,n)||Tp(e)&&!ds(e,i)&&Hs(n,{level:t})(e)),active:e=>sn(e,n,{level:t}),icon:rp[`h${t}`]})}Xh.workerSrc="/worker/pdf.worker.min.mjs";const Ip={DROP_ZONE:"pm-drop-zone",FILE_INPUT:"pm-file-input",FORM:"pm-form",CAPTION_INPUT:"pm-caption-input",TITLE_INPUT:"pm-title-input",IMG_SIZE_INPUT:"pm-img-size",FLOAT_SETTING:"pm-setting-float-btn",RESIZE_BUTTON_PREFIX:"pm-resize-img-",FORM:"pm-image-form",EXTERNAL_FILE_INPUT:"pm-external-file-input"},Np=[25,50,75,100],Pp="Small",Op="Medium",Rp="Large",Bp="Original",Fp="100";function Lp(t="Image",e=Tn.nodes.image,n=Tn.nodes.figure,i=Tn.nodes.code_block){return new mp({title:t,label:t,run:(t,i,s)=>{const r=new wp,o=Vp(t,e);return function(t,e,n){if(n?function(t,e){const n=e.title||"",i=e.caption||"",s=e.textaround?"checked":"",r=e.size||Fp;var o;t.add(`<form id="${Ip.FORM}">`).addRow(`\n            <label for="${Ip.CAPTION_INPUT}" class="hidden">URL:</label>\n            <input id="image-url" type="text" value="${e.src}" readonly disabled />\n        `).addRow(`\n            <label for="${Ip.TITLE_INPUT}" class="hidden">Title / Alt:</label>\n            <input id="${Ip.TITLE_INPUT}" type="text" value="${n}" placeholder="Title / Alt" />\n            <button title="Update Image" class="pm-menu-btn">OK</button>\n        `).addRow(`\n            <label for="${Ip.CAPTION_INPUT}" class="hidden">Image caption:</label>\n            <input id="${Ip.CAPTION_INPUT}" type="text" value="${i}" placeholder="Image caption (below image)" />\n        `).addRow((o=r,`\n        <label>Image size:</label>\n        <button id="${Ip.RESIZE_BUTTON_PREFIX}25" class="pm-menu-btn ${"25"===o?"active":""}" title="${Pp}">${Pp}</button>\n        <button id="${Ip.RESIZE_BUTTON_PREFIX}50" class="pm-menu-btn ${"50"===o?"active":""}" title="${Op}">${Op}</button>\n        <button id="${Ip.RESIZE_BUTTON_PREFIX}75" class="pm-menu-btn ${"75"===o?"active":""}" title="${Rp}">${Rp}</button>\n        <button id="${Ip.RESIZE_BUTTON_PREFIX}100" class="pm-menu-btn ${"100"===o?"active":""}" title="${Bp}">${Bp}</button>\n        <input type="hidden" id="${Ip.IMG_SIZE_INPUT}" value="${o}" />\n    `)).addRow(`\n            <label for="${Ip.FLOAT_SETTING}">Text flow around image</label>\n            <input id="${Ip.FLOAT_SETTING}" type="checkbox" ${s} title="Text flow around image"/>\n        `).add("</form>")}(t,n):t.addPage("Internal").add(function(t,e,n,i,s=!1){return`\n        <label id="${t}">${n}\n            <input type="file" id="${e}" ${s?"multiple":""} accept="${i}" title="${n}" />\n        </label>\n    `}(Ip.DROP_ZONE,Ip.FILE_INPUT,"Drop images here, or click to upload.","image/*",!0)).addPage("External").addRow(`\n            <form id="${Ip.FORM}">\n                <label for="${Ip.EXTERNAL_FILE_INPUT}" class="hidden">External image URL</label>\n                <input id="${Ip.EXTERNAL_FILE_INPUT}" type="text" placeholder="External image URL" style="width: 300px;" />\n                <button title="Insert image" class="pm-menu-btn">OK</button>\n            </form>\n        `),t.open(e,500,350),n){const t=document.getElementById(`${Ip.RESIZE_BUTTON_PREFIX}${n.size||Fp}`);t?.classList.add("active")}}(r,s,o),o?function(t,e,n,i,s){const r=Np.map(t=>document.getElementById(`${Ip.RESIZE_BUTTON_PREFIX}${t}`)).filter(Boolean);for(const[o,a]of Np.entries()){const t=r[o];t&&e.addListener(t,"click",Hp(a,r))}e.addListener(Ip.FORM,"submit",r=>{r.preventDefault();const o=document.getElementById(Ip.IMG_SIZE_INPUT),a=document.getElementById(Ip.TITLE_INPUT),l=document.getElementById(Ip.CAPTION_INPUT),c=document.getElementById(Ip.FLOAT_SETTING);if(!(o&&a&&l&&c))return;const h=o.value,d=a.value,u=l.value,p=c.checked;!function(t,e,n,i,s){const{state:r}=n,{selection:o}=r,{$from:a}=o;let l=r.transaction;const c=a.parent,h="paragraph"===c.type.name,d=e.caption&&!t.caption;!e.caption&&t.caption?l=function(t,e,n,i,s){const{imageCount:r,figcaptionCount:o}=function(t,e){let n=0,i=0;return t.forEach(t=>{t.type===e&&(n++,t.attrs.caption&&i++)}),{imageCount:n,figcaptionCount:i}}(e,n);if(1===r||1===o){const n=t.before(t.depth),r=t.after(t.depth),o=s.schema.nodes.paragraph,a=e.attrs;i.setBlockType(n,r,o,a)}return i}(a,c,i,l,r):d&&h&&(l=function(t,e,n,i){const s=t.before(t.depth),r=t.after(t.depth),o=e.attrs;return i.setBlockType(s,r,n,o),i}(a,c,s,l));const u=i.createAndFill(e,null,t.marks);u&&(l=l.replaceSelectionWith(u,!1)),n.dispatch(l)}(t,{...t,title:d,alt:d,caption:u,size:h===Fp?null:h,textaround:p},n,i,s),e.close(n)})}(o,r,s,e,n):function(t,e,n){t.addListener(Ip.FILE_INPUT,"change",i=>{const s=i.target.files;s&&(zp(s,e,n),t.close(e))}),t.addListener(Ip.FORM,"submit",i=>{i.preventDefault(),function(t,e,n){if(!t)return;const i={src:t,title:"",alt:""},s=n.createAndFill(i);s&&e.dispatch(e.state.transaction.replaceSelectionWith(s)),e.focus()}(document.getElementById(Ip.EXTERNAL_FILE_INPUT).value,e,n),t.close(e)});const i=document.getElementById(Ip.DROP_ZONE);i&&function(t){const{dialog:e,dropZone:n,onDrop:i,validateDrop:s}=t;e.addListener("window","drop",t=>{Mp(t).length>0&&t.preventDefault()}),e.addListener(n,"drop",t=>{t.preventDefault();const e=[...t.dataTransfer.items].map(t=>t.getAsFile()).filter(t=>null!==t);i(e)}),e.addListener("window","dragover",t=>{Mp(t).length>0&&(t.preventDefault(),n.contains(t.target)||(t.dataTransfer.dropEffect="none"))}),e.addListener(n,"dragover",t=>{const e=Mp(t);e.length>0&&(t.preventDefault(),t.dataTransfer.dropEffect=s?s(e)?"copy":"none":"copy")})}({dialog:t,dropZone:i,onDrop:i=>{zp(i,e,n),t.close(e)},validateDrop:kp})}(r,s,e),!0},enable:t=>Tp(t,1,0)&&!ds(t,i),active:t=>null!==Vp(t,e),render:t=>(t.addPlugin(new Fe({key:new Ge("handleImagePaste"),props:{handlePaste:(t,e,n)=>{if(n===tt.empty||!n.content.firstChild)return!1;const i=n.content.firstChild;return 1===n.content.childCount&&i.type===Tn.nodes.image&&i.attrs.textaround&&(i.attrs.textaround=!1),!1}}})),t.addPlugin(function(t){return new Fe({key:new Ge("handleImageDropStart"),props:{handleDrop:(e,n,i,s,r)=>{if(!s||!i.content.firstChild)return!1;const o=i.content.firstChild,a=1===i.content.childCount&&o.type===Tn.nodes.image;if(!a)return!1;const l=Boolean(o.attrs.caption);if(r.set("isImage",a),l){r.set("isImageWithCaption",l);const e=function(t){for(let e=t.depth;e>0;e--)if(t.node(e).type===Tn.nodes.figure)return t.before(e);return null}(t.state.doc.resolve(t.state.selection.from));r.set("sourceFigureStart",e)}return!1}}})}(t)),t.addPlugin(new Fe({key:new Ge("handleImageDropFinished"),props:{handleDropFinished:(t,e,n,i,s,r,o)=>{if(!i||!0!==o.get("isImage")||!n.content.firstChild)return!1;const a=n.content.firstChild;a.attrs.textaround&&(a.attrs.textaround=!1);const l=o.get("sourceFigureStart");return o.get("isImageWithCaption")&&null!=l&&function(t,e){const n=t.mapping.map(e),i=t.doc.resolve(n).nodeAfter;if(i?.type===Tn.nodes.figure&&!function(t){let e=!1;return t.descendants(t=>t.type!==Tn.nodes.image||!t.attrs.caption||(e=!0,!1)),e}(i)){const e=n+i.nodeSize,s=i.attrs;t.setBlockType(n,e,Tn.nodes.paragraph,s)}}(r,l),o.get("isImageWithCaption")&&function(t,e){const n=t.doc.resolve(e),i=n.depth;if(i>0){const e=n.node(i);if(e.type===Tn.nodes.paragraph){const s=n.before(i),r=n.after(i),o=e.attrs;t.setBlockType(s,r,Tn.nodes.figure,o)}}}(r,s),!1}}})),null),icon:rp.image})}function zp(t,e,n){for(const i of t)if(i.type.startsWith("image/")){const t={src:URL.createObjectURL(i),title:"",alt:""},s=n.createAndFill(t);s&&e.dispatch(e.state.transaction.replaceSelectionWith(s)),e.focus()}}function Vp(t,e){const{$from:n}=t.selection,i=n.node();let s,r=[];return i?.type===e?(s=i.attrs,r=i.marks):t.selection.node?.type===e&&(s=t.selection.node.attrs,r=t.selection.node.marks),s?{src:s.src,title:s.title,alt:s.title,caption:s.caption,size:s.size,id:s.id,textaround:Boolean(s.textaround),marks:r,cssClass:s.cssClass,width:s.width,height:s.height}:null}function Hp(t,e){return n=>{for(const t of e)t.classList.remove("active");n.target.classList.add("active");const i=document.getElementById(Ip.IMG_SIZE_INPUT);i&&(i.value=t.toString())}}const $p="pm-link-form",Up="pm-insert-link-input",Wp="pm-setting-newwindow-btn",Gp="pm-remove-link-btn",jp="pm-open-link-btn";function Kp(t,e){const{$from:n,$to:i,empty:s}=t.selection;if(s)return e.isInSet(t.storedMarks||n.marks());if(t.doc.rangeHasMark(n.pos,i.pos,e)){let s;return t.doc.nodesBetween(n.pos,i.pos,t=>(!s&&t.isInline&&(s=e.isInSet(t.marks)),!s)),s}}const qp=new mp({title:"Redo",label:"Redo",run:Vo,enable:t=>Vo(t),icon:rp.redo});const Yp=new mp({title:"Undo",label:"Undo",run:Ho,enable:t=>Ho(t),icon:rp.undo});class Xp{menu=[];isFloating;isLegacy;constructor(t=!1,e=!1){this.isLegacy=t,this.isFloating=e}static createMenuItem(t,e=!1){return t?(Xp.normalizeLabelAndTitle(t),e&&t.run&&!t.select?t.select=e=>t.run(e,null,null,null):(t.run&&!t.enable&&(t.enable=e=>t.run(e,null,null,null)),t.run&&!t.active&&(t.active=e=>t.run(e,null,null,null))),new mp(t)):null}static normalizeLabelAndTitle(t){t.label&&!t.title?t.title=t.label:"string"!=typeof t.title||t.label||(t.label=t.title)}build(){return function(t){return new Fe({view:e=>new lp(e,t)})}({floating:this.isFloating,content:this.menu,isLegacy:this.isLegacy})}addDropDown(t,...e){return this.createDropDown(!1,t,...e)}addStaticDropDown(t,...e){return this.createDropDown(!0,t,...e)}createDropDown(t,e,...n){if(1===n.length&&n[0]instanceof np)return this.addMenuGroup(n[0]);const i=this.flattenMenuElements(n),s=this.isLegacy?new sp(i,{...e,static:t}):new np(i,{...e,static:t});return this.addMenuGroup(s)}addMenuGroup(...t){const e=this.flattenMenuElements(t);return e.length>0&&this.menu.push(e),this}flattenMenuElements(t){const e=[];for(const n of t)if(Array.isArray(n))for(const t of n)null!=t&&e.push(t);else null!=n&&e.push(n);return e}}const Jp=[function(){const t=(new Xp).addDropDown({title:"Format",label:"Format",showLabel:!0},function(t="Paragraph",e=Tn.nodes.paragraph,n=Tn.nodes.bullet_list,i=Tn.nodes.ordered_list){return new mp({title:t,label:t,run:(t,s)=>{return r=t,o=s,a=n,l=i,!!Hs(e)(r,o)||!!Es(r,o)||!!dn(a,null,!0)(r,o)||dn(l,null,!0)(r,o)||!1;var r,o,a,l},enable:t=>xp(t)&&(t.selection.$from.parent.isBlock||Hs(e)(t)),active:t=>sn(t,e),icon:rp.paragraph})}(),Dp("1"),Dp("2"),Dp("3"),Dp("4"),Dp("5"),Dp("6"),function(t="Blockquote",e=Tn.nodes.blockquote){return new mp({title:t,label:t,run:fr(e),enable:t=>xp(t)&&(sn(t,e)||Tp(t,1e4)&&fr(e)(t)),active:t=>sn(t,e),icon:rp.blockquote})}(),function(t="Code Block",e=Tn.nodes.code_block,n=Tn.nodes.paragraph){return new mp({title:t,label:t,run:nr(e,n),enable:t=>xp(t)&&(sn(t,e)||Tp(t,1e4)&&nr(e,n)(t)),active:t=>sn(t,e),icon:rp.codeBlock})}()).addMenuGroup(function(t="Bold",e=Tn.marks.strong){return new mp({title:t,label:t,run:ir(e),active:t=>Cp(t,e),enable:t=>xp(t)&&t.selection.isTextSelection()&&ir(e)(t),icon:rp.strong})}(),function(t="Italic",e=Tn.marks.em){return new mp({title:t,label:t,run:ir(e),active:t=>Cp(t,e),enable:t=>xp(t)&&t.selection.isTextSelection()&&ir(e)(t),icon:rp.em})}(),function(t="Strikethrough",e=Tn.marks.strikethrough){return new mp({title:t,label:t,run:ir(e),active:t=>Cp(t,e),enable:t=>xp(t)&&t.selection.isTextSelection()&&ir(e)(t),icon:rp.strikethrough})}(),function(t="Code",e=Tn.marks.code){return new mp({title:t,label:t,run:ir(e),active:t=>Cp(t,e),enable:t=>xp(t)&&t.selection.isTextSelection()&&ir(e)(t),icon:rp.code})}()).addMenuGroup(function(t="Bullet List",e=Tn.nodes.bullet_list,n=Tn.nodes.ordered_list){return new mp({title:t,label:t,run:dn(e),enable:t=>xp(t)&&(Ep(t,e,n)||dn(e)(t)),active:t=>sn(t,e),icon:rp.bulletList})}(),function(t="Numbered List",e=Tn.nodes.ordered_list,n=Tn.nodes.bullet_list){return new mp({title:t,label:t,run:dn(e),enable:t=>xp(t)&&(Ep(t,n,e)||dn(n)(t)),active:t=>sn(t,e),icon:rp.orderedList})}()).addMenuGroup(Sp("left"),Sp("center"),Sp("right"),Sp("justify")).addMenuGroup(function(t="Horizontal Rule",e=Tn.nodes.horizontal_rule,n=Tn.nodes.code_block){return new mp({title:t,label:t,run:(t,n)=>(n(t.transaction.replaceSelectionWith(e.create())),!0),enable:t=>function(t,e,n){const i=t.selection.$from;if(!i.parent.type.spec.content.includes("inline"))return!1;if(ds(t,n))return!1;for(let s=i.depth;s>=0;s--){const t=i.index(s);if(i.node(s).canReplaceWith(t,t,e))return!0}return!1}(t,e,n),icon:rp.horizontalRule})}(),function(t="Subscript",e=Tn.marks.subscript){return new mp({title:t,label:t,run:ir(e,null,ur),active:t=>Cp(t,e),enable:t=>xp(t)&&t.selection.isTextSelection()&&Tp(t,20,0)&&ir(e)(t),icon:rp.subscript})}(),function(t="Superscript",e=Tn.marks.superscript){return new mp({title:t,label:t,run:ir(e,null,ur),active:t=>Cp(t,e),enable:t=>xp(t)&&t.selection.isTextSelection()&&Tp(t,20,0)&&ir(e)(t),icon:rp.superscript})}(),Lp(),function(t="Link",e=Tn.marks.link,n=Tn.nodes.code_block){return new mp({title:t,label:t,run:(t,n,i)=>{const s=new wp,r=function(t,e){const n=Kp(t,e);return n?.attrs?.href?{href:String(n.attrs.href),target:n.attrs.target?String(n.attrs.target):void 0,title:n.attrs.title?String(n.attrs.title):void 0,id:n.attrs.id?String(n.attrs.id):void 0}:null}(t,e);return function(t,e,n){const i=n?.href??"",s="_blank"===n?.target?"checked":"";t.add(`<form id="${$p}">`),t.addRow(`\n        <label for="${Up}" class="hidden">Paste or type link url here:</label>\n        <input \n            id="${Up}" \n            type="text" \n            name="pm-link" \n            value="${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(i)}" \n            placeholder="Paste or type link url here." \n            style="width: 300px;" \n        />\n        <button id="pm-insert-link-btn" title="Insert Link" class="pm-menu-btn">OK</button>\n    `),n?t.addRow(`\n            <label for="${Wp}">\n                Open in new window\n                <input \n                    id="${Wp}" \n                    type="checkbox" \n                    ${s} \n                    title="Set open Link in new window" \n                    class="spacer"\n                />\n            </label>\n            <button \n                id="${Gp}" \n                title="Remove Link" \n                class="pm-menu-btn btn-spacer"\n            >Remove</button>\n            <button \n                id="${jp}" \n                title="Open Link" \n                class="pm-menu-btn"\n            >Open</button>\n        `):t.addRow(`\n            <label for="${Wp}">\n                Open in new window\n                <input \n                    id="${Wp}" \n                    type="checkbox" \n                    ${s} \n                    title="Set open Link in new window"\n                />\n            </label>\n        `),t.add("</form>"),t.open(e,500,200);const r=document.getElementById(Up);r?.focus()}(s,i,r),a=r,l=e,c=t,h=n,d=i,(o=s).addListener($p,"submit",t=>{t.preventDefault();const e=document.getElementById(Up),n=document.getElementById(Wp);if(!e)return;const i=e.value,s=n?.checked?"_blank":null;if(!function(t,e,n){if(!t)return!0;const i=t.href!==e,s=(t.target||null)!==n;return i||s}(a,i,s))return void o.close(d);const r=function(t,e,n){const{from:i,to:s}=t.selection;return{href:e,title:t.doc.textBetween(i,s," "),target:n}}(c,i,s);!function(t,e,n,i,s){const r=t.transaction;let{from:o,to:a}=t.selection;if(t.selection.empty&&s){const e=rs(t.doc,t.selection.$cursor,n,!1);e.found&&(o=e.from,a=e.to)}s&&r.removeMark(o,a,n),r.addMark(o,a,n.create(i)),e(r)}(c,h,l,r,a),o.close(d)}),r&&(function(t,e){t.addListener(jp,"click",t=>{t.preventDefault(),window.open(e.href,"_blank")})}(s,r),function(t,e,n,i,s){t.addListener(Gp,"click",r=>{r.preventDefault(),ir(e)(n,i),t.close(s)})}(s,e,t,n,i)),!0;var o,a,l,c,h,d},enable:t=>xp(t)&&Tp(t,500,0)&&!ds(t,n)&&(!!Kp(t,e)||!t.selection.empty),active:t=>!!Kp(t,e),icon:rp.link})}()).addMenuGroup(Yp,qp).addMenuGroup(new mp({title:"Fullscreen",label:"Fullscreen",run:()=>(document.body.classList.contains("fullscreen")?document.body.classList.remove("fullscreen"):document.body.classList.add("fullscreen"),!0),icon:{width:24,height:24,path:"M21 3a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm-1 2H4v14h16zm-7 12v-2h3v-3h2v5zM11 7v2H8v3H6V7z"}}));return t.build()}(),function(t){return new Fe({props:{handleKeyDown:Zo(t)}})}(Qo),function(t={}){const e={depth:t.depth??100,newGroupDelay:t.newGroupDelay??500};return new Fe({key:Do,state:{init:()=>Lo.createEmpty(),apply:(t,n,i)=>function(t,e,n,i){const s=n.getMeta(Do);if(s)return s.historyState;n.getMeta(Io)&&(t=Lo.createClosed(t.done,t.undone));const r=n.getMeta("appendedTransaction");if(0===n.steps.length)return t;const o=ko(e);if(r?.getMeta(Do))return function(t,e,n,i,s){const r=n.getMeta(Do);if(r?.redo){const n=t.done.addTransform(e,void 0,i,s);return new Lo(n,t.undone,Uo(e.mapping.maps),t.prevTime,t.prevComposition)}{const n=t.undone.addTransform(e,void 0,i,s);return new Lo(t.done,n,null,t.prevTime,t.prevComposition)}}(t,n,r,i,o);if(function(t,e){if(!1===t.getMeta("addToHistory"))return!1;const n=e?.getMeta("addToHistory");return!j(n)}(n,r))return function(t,e,n,i,s,r){const o=n.getMeta("composition"),a=function(t,e,n,i){if(0===t.prevTime)return!0;if(n)return!1;const s=e.getMeta("composition");if(t.prevComposition!==s){const n=(e.time||0)-t.prevTime>=i.newGroupDelay,s=!function(t,e){if(!e)return!1;if(!t.docChanged)return!0;if(!t.mapping.maps[0])return!1;let n=!1;return t.mapping.maps[0].forEach((t,i)=>{if(!n)for(let s=0;s<e.length;s+=2){const r=e[s];if(t<=e[s+1]&&i>=r){n=!0;break}}}),n}(e,t.prevRanges);if(n||s)return!0}return!1}(t,n,i,s),l=i?$o(t.prevRanges,n.mapping):Uo(n.mapping.maps),c=a?e.selection.getBookmark():void 0,h=t.done.addTransform(n,c,s,r),d=U(o)?t.prevComposition:o;return new Lo(h,Fo.empty,l,n.time,d)}(t,e,n,r,i,o);const a=n.getMeta("rebased");return"number"==typeof a&&a>0?function(t,e,n){const i=t.done.rebased(e,n),s=t.undone.rebased(e,n);return new Lo(i,s,$o(t.prevRanges,e.mapping),t.prevTime,t.prevComposition)}(t,n,a):function(t,e){const n=t.done.addMaps(e.mapping.maps),i=t.undone.addMaps(e.mapping.maps);return new Lo(n,i,$o(t.prevRanges,e.mapping),t.prevTime,t.prevComposition)}(t,n)}(n,i,t,e)},config:e,props:{handleDOMEvents:{beforeinput:(t,e)=>function(t,e){const n=e.inputType;if("historyUndo"!==n&&"historyRedo"!==n)return!1;if(!t.editable)return!1;const i="historyUndo"===n?Ho:Vo;return e.preventDefault(),i(t.state,e=>{t.dispatch(e)})}(t,e)}}})}(),function(t={}){return new Fe({view:e=>new Eo(e,t)})}({class:"pm-dropcursor",color:!1}),new Fe({props:{decorations:da,createSelectionBetween:(t,e,n)=>e.pos===n.pos&&sa.valid(n)?new sa(n):null,handleClick:la,handleKeyDown:oa,handleDOMEvents:{beforeinput:ca}}})],Qp='\n<main data-pmid="U0PgYFJcZ20EW2ltd3ZTb8" data-pmroot="true">\n    <h3 data-pmid="X0PgYFJcZ20EW2ltd3ZTZ">Type - Another ProseMirror clone</h3>\n    <p data-pmid="IyH_bOeHN2FwkpCM-K2i2" style="text-align: right;">\n        <img\n            src="https://d7hftxdivxxvm.cloudfront.net/?height=1440&amp;quality=60&amp;resize_to=fit&amp;src=https%3A%2F%2Fartsy-media-uploads.s3.amazonaws.com%2FkoWCsEKhB2S-KVlVOSEMsQ%252FBanksy_Girl%2Bwith%2BBalloon.jpeg&amp;width=1440"\n            alt="Banksy - Girl with Balloon" title="Banksy - Girl with Balloon"\n            class=" img50Float" data-pmsize="50" data-pmid="9d8BvJZPiFlpag4Bya_9j" data-pmtextaround="true"\n            data-pmcaption="" contenteditable="false" draggable="true"></p>\n    <p data-pmid="IyH_bOeHN2FwkpCM-K2i2">This is the demo page of the type editor. It is primarily a refactored version\n        of\n        the outstanding <a href="https://prosemirror.net/" title="ProseMirror" target="_blank" rel="noopener noreferrer"\n                           data-pmid="1ZLlD9vMIUd1vubKupNnV">ProseMirror</a> editor.</p>\n    <p data-pmid="CDtDLFYiXCR7lbyi7v0sB">Click the Edit button to make the text editable. Click the Save button to see\n        the\n        result (in this demo, nothing will actually be saved).</p>\n    <p data-pmid="rDBvkIpV5bIZoMzpqJZ-v">This editor can also be used with React, Vue, and Svelte. For this purpose the\n        <a\n            href="https://github.com/prosekit/prosemirror-adapter" title="prosemirror-adapter" target="_blank"\n            rel="noopener noreferrer" data-pmid="jvHHaquWZX_r8Nchk4Aom">prosemirror-adapter</a> is used.</p>\n    <p data-pmid="XgJQHdqCVwa27n_qO2Zi9">Please note that using it with React, Vue, or Svelte requires some compromises.\n        The\n        ProseMirror editor code handles content updates synchronously, whereas React, Vue, and Svelte usually handle\n        content\n        updates asynchronously. Therefore, it does not fully align with the way React, Vue, and Svelte handle updates.\n        Perhaps <a href="https://tiptap.dev/" title="TipTap" rel="noopener noreferrer"\n                   data-pmid="7sQQV-lE8RqmyT-j0FAF3">TipTap</a>\n        or <a href="https://prosekit.dev/" title="ProseKit" rel="noopener noreferrer" data-pmid="aDh83ibIKgz8tZw3Pfpml">ProseKit</a>\n        offers a better approach.</p>\n    <p data-pmid="rDBvkIpV5bIZoMzpqJZ-v">You can find separate demo pages for these frameworks and the source code here:&nbsp;<a\n        href="../react/index.html" title="React" rel="noopener noreferrer" data-pmid="8G7ZPCVhxYV6p_H1w9euA">React</a>&nbsp;&nbsp;<a\n        href="../vue/index.html" title="Vue" rel="noopener noreferrer" data-pmid="yJkE00hVvb2uK-iZxcEGX">Vue</a>&nbsp;&nbsp;<a\n        href="../svelte/index.html" title="Svelte" rel="noopener noreferrer"\n        data-pmid="xSE_gRlq09_eYdzJCcD5h">Svelte</a>&nbsp;&nbsp;<a\n        href="https://github.com/type-editor/type" title="GitHub" rel="noopener noreferrer"\n        data-pmid="BSE_0Jlq09_ePdzJCcDr9">GitHub</a>\n    </p>\n    <p data-pmid="1yErMZKQiV87vKXPk4Upt"><strong>Note</strong>: This is an early version of the Type Editor, and it may\n        still have some issues.</p>\n</main>\n';export{Tn as B,So as H,bi as a,U as b,Jp as d,Qp as i,q as n};
